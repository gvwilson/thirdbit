<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Distributed Tracing</title>
<link href="../static/favicon.ico" rel="icon" type="image/x-icon"/>
<link href="../static/pygments.css" rel="stylesheet" type="text/css"/>
<link href="../static/page.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<nav>
<a href="../">Home</a>
      ·
      <span class="dropdown">
<a href="#">Lessons</a>
<span class="dropdown-content" id="nav-lessons">
<a href="../intro/">Introduction</a>
<a href="../msgque/">A Publish-Subscribe Message Queue</a>
<a href="../worksteal/">A Work-Stealing Scheduler</a>
<a href="../tracing/">Distributed Tracing</a>
<a href="../crdt/">Conflict-Free Replicated Data Types</a>
<a href="../finale/">Conclusion</a>
</span>
</span>
      ·
      <span class="dropdown">
<a href="#">Appendices</a>
<span class="dropdown-content" id="nav-appendices">
<a href="../license/">License</a>
<a href="../conduct/">Code of Conduct</a>
<a href="../contributing/">Contributing</a>
<a href="../bibliography/">Bibliography</a>
<a href="../glossary/">Glossary</a>
<a href="../asimpy/">Discrete Event Simulation with asimpy</a>
</span>
</span>
</nav>
<main>
<h1>Distributed Tracing</h1>
<p>If a monolithic application is slow,
we can profile a single process to find out why.
In a <a href="../glossary/#microservice">microservices</a> architecture,
however,
a single request may touch many services,
each of which may cause multiple database queries and external API calls.
This makes it a lot harder to figure out exactly what's going on.</p>
<p>Distributed tracing solves this by tracking requests as they flow through the system.
A tracing systems assigns each request a unique ID,
which that request carries through every service it touches.
Each service operation records the work it does
along with timing information and other metadata.
Collecting and combining these records allows the tracing framework
to understand dependencies between services
and identify bottlenecks.</p>
<p>Distributed tracing has two key elements:</p>
<ul>
<li>
<p>A <a href="../glossary/#span">span</a> represents a single unit of work.
    Spans form a tree with its origin in a <a href="../glossary/#root-span">root span</a>;
    this tree represents the (distributed) call graph.</p>
</li>
<li>
<p>A <a href="../glossary/#trace">trace</a> is complete journey of a request through the system,
    and is identified by a unique trace ID.
    A single trace may contain many spans.</p>
</li>
</ul>
<p><a href="../glossary/#context-propagation">Context propagation</a> means
passing trace and span IDs between services so that they can be correlated.
Trace and span IDs are often propagated using <a href="../glossary/#http-header">HTTP headers</a>:</p>
<div class="codehilite"><pre class=""><span></span><code>X-Trace-Id: abc123
X-Span-Id: def456
X-Parent-Span-Id: ghi789
</code></pre></div>
<p>Tracing systems often use <a href="../glossary/#sampling">sampling</a>
to record only a fraction of traces.
Doing this means that some questions cannot be answered after the fact,
but sampling reduces storage costs and,
more importantly,
prevents the tracing system from overwhelming the network.</p>
<p>Finally, tags and logs are metadata attached to spans for debugging.
Tags are values used for filtering and searching,
such as the <a href="../glossary/#http-status-code">HTTP status code</a>,
while logs are timestamped events such as a <a href="../glossary/#cache-miss">cache miss</a>
or retry attempt.</p>
<h2 id="tracing-decorator">A Minimum Viable Decorator</h2>
<p>Suppose we want to write a method <code>handle_request()</code>
that performs some work in <code>do_work()</code>
in a traceable way.
If we add the tracing code directly in <code>handle_request()</code>
we wind up with something like this:</p>
<div data-filter="inc=service" data-inc="long_winded.py"><div class="codehilite"><pre class=""><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Service</span><span class="p">(</span><span class="n">GenericService</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># Create span manually</span>
        <span class="n">span</span> <span class="o">=</span> <span class="n">Span</span><span class="p">(</span>
            <span class="n">trace_id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">trace_id</span><span class="p">,</span>
            <span class="n">span_id</span><span class="o">=</span><span class="n">generate_id</span><span class="p">(</span><span class="s2">"span_"</span><span class="p">),</span>
            <span class="n">parent_span_id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">span_id</span><span class="p">,</span>
            <span class="n">operation_name</span><span class="o">=</span><span class="s2">"handle_request"</span><span class="p">,</span>
            <span class="n">service_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">service_name</span><span class="p">,</span>
            <span class="n">start_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Do work</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_work</span><span class="p">()</span>
            <span class="n">span</span><span class="o">.</span><span class="n">add_tag</span><span class="p">(</span><span class="s2">"success"</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Handle error</span>
            <span class="n">span</span><span class="o">.</span><span class="n">add_tag</span><span class="p">(</span><span class="s2">"error"</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Finish and send span</span>
            <span class="n">span</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">collector</span><span class="o">.</span><span class="n">span_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">span</span><span class="p">)</span>
</code></pre></div>
</div>
<p>That is 15 lines of tracing code for a simple function,
and those lines would have to be copied into every function we want to trace.
A better approach is to define a <a href="../glossary/#decorator">decorator</a>
that adds tracing for us so that we can write:</p>
<div data-filter="inc=service" data-inc="short_winded.py"><div class="codehilite"><pre class=""><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Service</span><span class="p">(</span><span class="n">GenericService</span><span class="p">):</span>
    <span class="nd">@traced</span><span class="p">(</span><span class="s2">"handle_request"</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_work</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</div>
<p>A minimum viable version of that decorator needs to do the following:</p>
<ol>
<li>Check for active traces.
    If no trace context exists or sampling is disabled,
    it just calls the function normally.</li>
<li>Create a child span whose parent is the current span (if there is one).</li>
<li>Propagate trace context for nested calls.</li>
<li>Handle errors, i.e., catch exceptions and tag spans with error information.</li>
<li>Clean up by finishing the current span and restoring the previous context.</li>
</ol>
<p>None of this is particularly hard,
but it does require a fair bit of code.
First,
we create a <a href="../glossary/#singleton">singleton</a> to hold the active trace context
and the <a href="../glossary/#trace-collector">collector</a> where completed spans are to be sent.
(In production,
we would use <a href="../glossary/#thread-local-storage">thread-local storage</a>
or <a href="../glossary/#async-context-vars">async context variables</a> to storage this data.)</p>
<div data-filter="inc=storage" data-inc="tracing_decorators.py"><div class="codehilite"><pre class=""><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">_StorageClass</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Record trace information."""</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Construct instance."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_context</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_collector</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_context</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">TraceContext</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Storage</span><span class="o">.</span><span class="n">_current_context</span> <span class="o">=</span> <span class="n">context</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_context</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TraceContext</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Storage</span><span class="o">.</span><span class="n">_current_context</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_collector</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">collector</span><span class="p">:</span> <span class="n">BaseCollector</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Storage</span><span class="o">.</span><span class="n">_current_collector</span> <span class="o">=</span> <span class="n">collector</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_collector</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseCollector</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Storage</span><span class="o">.</span><span class="n">_current_collector</span>

<span class="n">Storage</span> <span class="o">=</span> <span class="n">_StorageClass</span><span class="p">()</span>
</code></pre></div>
</div>
<p>We can now define the tracing decorator itself.
It's long,
but all of the steps are fairly straightforward:</p>
<div data-filter="inc=traced" data-inc="tracing_decorators.py"><div class="codehilite"><pre class=""><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">traced</span><span class="p">(</span><span class="n">operation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Decorator that automatically creates spans for functions."""</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">:</span>
        <span class="c1"># Get operation name</span>
        <span class="n">op_name</span> <span class="o">=</span> <span class="n">operation_name</span>

        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">async_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># Get current context</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">Storage</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>

            <span class="c1"># No tracing, just call function</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">context</span><span class="p">:</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># Get service name from class</span>
            <span class="n">service_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"service_name"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

            <span class="c1"># Create span</span>
            <span class="n">span</span> <span class="o">=</span> <span class="n">Span</span><span class="p">(</span>
                <span class="n">trace_id</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">trace_id</span><span class="p">,</span>
                <span class="n">span_id</span><span class="o">=</span><span class="n">generate_id</span><span class="p">(</span><span class="s2">"span_"</span><span class="p">),</span>
                <span class="n">parent_span_id</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">span_id</span><span class="p">,</span>
                <span class="n">operation_name</span><span class="o">=</span><span class="n">op_name</span><span class="p">,</span>
                <span class="n">service_name</span><span class="o">=</span><span class="n">service_name</span><span class="p">,</span>
                <span class="n">start_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Save old context and set new one</span>
            <span class="n">old_context</span> <span class="o">=</span> <span class="n">Storage</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>
            <span class="n">new_context</span> <span class="o">=</span> <span class="n">TraceContext</span><span class="p">(</span>
                <span class="n">trace_id</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">trace_id</span><span class="p">,</span>
                <span class="n">span_id</span><span class="o">=</span><span class="n">span</span><span class="o">.</span><span class="n">span_id</span><span class="p">,</span>
                <span class="n">parent_span_id</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">span_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">Storage</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">new_context</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Call function</span>
                <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">span</span><span class="o">.</span><span class="n">add_tag</span><span class="p">(</span><span class="s2">"success"</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Record error</span>
                <span class="n">span</span><span class="o">.</span><span class="n">add_tag</span><span class="p">(</span><span class="s2">"error"</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="n">span</span><span class="o">.</span><span class="n">add_tag</span><span class="p">(</span><span class="s2">"error.message"</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="n">span</span><span class="o">.</span><span class="n">add_log</span><span class="p">(</span><span class="s2">"exception"</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">raise</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># Finish span and send to collector</span>
                <span class="n">span</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
                <span class="n">collector</span> <span class="o">=</span> <span class="n">Storage</span><span class="o">.</span><span class="n">get_collector</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">collector</span><span class="p">:</span>
                    <span class="n">collector</span><span class="o">.</span><span class="n">span_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">span</span><span class="p">)</span>

                <span class="c1"># Restore old context</span>
                <span class="n">Storage</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">old_context</span><span class="p">)</span>

        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">sync_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># For sync functions, just add tags but don't trace</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Return appropriate wrapper</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>

        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">async_wrapper</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sync_wrapper</span>

    <span class="k">return</span> <span class="n">decorator</span>
</code></pre></div>
</div>
<h2 id="tracing-types">Data Types</h2>
<p>We now need to double back and define the core types for distributed tracing.
<code>TraceContext</code> propagates between services:</p>
<div data-filter="inc=context" data-inc="tracing_types.py"><div class="codehilite"><pre class=""><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TraceContext</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Context propagated between services."""</span>

    <span class="n">trace_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">span_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parent_span_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">baggage</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</code></pre></div>
</div>
<p><code>Span</code> tracks individual operations,
and has methods for adding tags and log entries
and to mark the span as completed:</p>
<div data-filter="inc=span" data-inc="tracing_types.py"><div class="codehilite"><pre class=""><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Span</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Represents a unit of work in a trace."""</span>

    <span class="n">trace_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">span_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parent_span_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span>
    <span class="n">operation_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">service_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">duration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">tags</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">logs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Add metadata tag to span."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">fields</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Add log entry to span."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">"message"</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span> <span class="s2">"timestamp"</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="o">**</span><span class="n">fields</span><span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Mark span as complete."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="n">end_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>
</code></pre></div>
</div>
<p>Finally, <code>Trace</code> aggregates spans,
and has methods for adding spans and getting the overall duration of the trace:</p>
<div data-filter="inc=trace" data-inc="tracing_types.py"><div class="codehilite"><pre class=""><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Trace</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""Complete trace containing all spans."""</span>

    <span class="n">trace_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">spans</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Span</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">end_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_span</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">:</span> <span class="n">Span</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Add span to trace."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">span</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">span</span><span class="o">.</span><span class="n">start_time</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">start_time</span>

        <span class="k">if</span> <span class="n">span</span><span class="o">.</span><span class="n">end_time</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">span</span><span class="o">.</span><span class="n">end_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="n">span</span><span class="o">.</span><span class="n">end_time</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_root_span</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Span</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Get root span (no parent)."""</span>
        <span class="k">for</span> <span class="n">span</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">span</span><span class="o">.</span><span class="n">parent_span_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">span</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Get total trace duration."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
</div>
<h2>Trace Collector</h2>
<p>The collector is an active process
that receives spans from services and assembles them into traces.
When it runs,
it repeatedly gets a span from its incoming queue and processes it:</p>
<div data-filter="inc=collector" data-inc="trace_collector.py"><div class="codehilite"><pre class=""><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TraceCollector</span><span class="p">(</span><span class="n">BaseCollector</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Collects and aggregates spans into traces."""</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">span_queue</span><span class="p">:</span> <span class="n">Queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_traces</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Trace</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completed_traces</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Trace</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Statistics</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spans_received</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traces_completed</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Main collector loop."""</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] TraceCollector started"</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">span</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">span_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_span</span><span class="p">(</span><span class="n">span</span><span class="p">)</span>
</code></pre></div>
</div>
<p>To process a new span,
the collector either adds it to an existing trace
or creates a new one.
If the trace is now complete,
the collector moves it from the active set into the completed set:</p>
<div data-filter="inc=process" data-inc="trace_collector.py"><div class="codehilite"><pre class=""><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">process_span</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">span</span><span class="p">:</span> <span class="n">Span</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Process incoming span."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spans_received</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Get or create trace</span>
        <span class="k">if</span> <span class="n">span</span><span class="o">.</span><span class="n">trace_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_traces</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_traces</span><span class="p">[</span><span class="n">span</span><span class="o">.</span><span class="n">trace_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">Trace</span><span class="p">(</span><span class="n">trace_id</span><span class="o">=</span><span class="n">span</span><span class="o">.</span><span class="n">trace_id</span><span class="p">)</span>

        <span class="n">trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_traces</span><span class="p">[</span><span class="n">span</span><span class="o">.</span><span class="n">trace_id</span><span class="p">]</span>
        <span class="n">trace</span><span class="o">.</span><span class="n">add_span</span><span class="p">(</span><span class="n">span</span><span class="p">)</span>

        <span class="c1"># Check if trace is complete</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_trace_complete</span><span class="p">(</span><span class="n">trace</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">complete_trace</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report_trace</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_span_tree</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_trace_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">:</span> <span class="n">Trace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Check if all spans in trace are finished."""</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trace</span><span class="o">.</span><span class="n">spans</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">span</span><span class="o">.</span><span class="n">end_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">span</span> <span class="ow">in</span> <span class="n">trace</span><span class="o">.</span><span class="n">spans</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">complete_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trace</span><span class="p">:</span> <span class="n">Trace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Mark trace as complete and move to storage."""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completed_traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traces_completed</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_traces</span><span class="p">[</span><span class="n">trace</span><span class="o">.</span><span class="n">trace_id</span><span class="p">]</span>
</code></pre></div>
</div>
<h2 id="tracing-service">A Simple Service</h2>
<p>With all this machinery in place,
tracing a microservice is relatively straightforward:</p>
<div data-filter="inc=simple" data-inc="simple_service.py"><div class="codehilite"><pre class=""><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SimpleService</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Service instrumented with decorators."""</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">collector</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service_name</span> <span class="o">=</span> <span class="n">service_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collector</span> <span class="o">=</span> <span class="n">collector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">)</span>

        <span class="c1"># Set collector for decorators</span>
        <span class="n">Storage</span><span class="o">.</span><span class="n">set_collector</span><span class="p">(</span><span class="n">collector</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">service_name</span><span class="si">}</span><span class="s2"> started"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Handle incoming requests."""</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="nd">@traced</span><span class="p">(</span><span class="s2">"handle_request"</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">handle_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">ServiceRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Handle request - automatically traced."""</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">service_name</span><span class="si">}</span><span class="s2">: Processing </span><span class="si">{</span><span class="n">request</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Set context for nested calls</span>
        <span class="n">Storage</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="c1"># Simulate processing</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">))</span>

        <span class="c1"># Do some work</span>
        <span class="n">data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_data</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">payload</span><span class="p">)</span>

        <span class="c1"># Send response</span>
        <span class="n">request</span><span class="o">.</span><span class="n">response_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
            <span class="n">ServiceResponse</span><span class="p">(</span><span class="n">request_id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">request_id</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@traced</span><span class="p">(</span><span class="s2">"process_data"</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">process_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Process data - automatically traced as child span."""</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">"processed"</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">"input"</span><span class="p">:</span> <span class="n">payload</span><span class="p">}</span>
</code></pre></div>
</div>
<p><code>handle_request</code> is automatically traced;
<code>process_data</code> is also traced and becomes a child span.
No spans are created manually,
and error handling is automatic.</p>
<p>The client creates the root span manually (since it initiates the trace):</p>
<div data-filter="inc=client" data-inc="ex_decorators.py"><div class="codehilite"><pre class=""><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SimpleClient</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Client that initiates traced requests."""</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">service</span><span class="p">:</span> <span class="n">SimpleService</span><span class="p">,</span> <span class="n">collector</span><span class="p">:</span> <span class="n">TraceCollector</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span> <span class="o">=</span> <span class="n">service</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collector</span> <span class="o">=</span> <span class="n">collector</span>
        <span class="n">Storage</span><span class="o">.</span><span class="n">set_collector</span><span class="p">(</span><span class="n">collector</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Generate requests."""</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_request</span><span class="p">(</span><span class="sa">f</span><span class="s2">"req_</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Make a traced request."""</span>
        <span class="c1"># Create trace</span>
        <span class="n">trace_id</span> <span class="o">=</span> <span class="n">generate_id</span><span class="p">(</span><span class="s2">"trace_"</span><span class="p">)</span>
        <span class="n">root_span_id</span> <span class="o">=</span> <span class="n">generate_id</span><span class="p">(</span><span class="s2">"span_"</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: Starting request </span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># Create root span</span>
        <span class="n">root_span</span> <span class="o">=</span> <span class="n">Span</span><span class="p">(</span>
            <span class="n">trace_id</span><span class="o">=</span><span class="n">trace_id</span><span class="p">,</span>
            <span class="n">span_id</span><span class="o">=</span><span class="n">root_span_id</span><span class="p">,</span>
            <span class="n">parent_span_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">operation_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.make_request"</span><span class="p">,</span>
            <span class="n">service_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">start_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Create context</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">TraceContext</span><span class="p">(</span>
            <span class="n">trace_id</span><span class="o">=</span><span class="n">trace_id</span><span class="p">,</span>
            <span class="n">span_id</span><span class="o">=</span><span class="n">root_span_id</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Set context</span>
        <span class="n">Storage</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="c1"># Call service</span>
        <span class="n">response_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">ServiceRequest</span><span class="p">(</span>
            <span class="n">request_id</span><span class="o">=</span><span class="n">req_id</span><span class="p">,</span>
            <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
            <span class="n">payload</span><span class="o">=</span><span class="p">{</span><span class="s2">"data"</span><span class="p">:</span> <span class="sa">f</span><span class="s2">"request_</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2">"</span><span class="p">},</span>
            <span class="n">response_queue</span><span class="o">=</span><span class="n">response_queue</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">request_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="c1"># Finish root span</span>
        <span class="n">root_span</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
        <span class="n">root_span</span><span class="o">.</span><span class="n">add_tag</span><span class="p">(</span><span class="s2">"success"</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">success</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collector</span><span class="o">.</span><span class="n">span_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">root_span</span><span class="p">)</span>
</code></pre></div>
</div>
<p>The output shows that we are capturing what we wanted to:</p>
<div data-inc="ex_decorators.txt"><div class="codehilite"><pre class=""><span></span><code>[0.0] OrderService started
[0.0] TraceCollector started

[1.5] Client: Starting request req_1
[1.5] OrderService: Processing Request(req_1)

[3.3] Client: Starting request req_2
[3.3] OrderService: Processing Request(req_2)

[5.1] Client: Starting request req_3
[5.1] OrderService: Processing Request(req_3)

============================================================
Decorator-Based Tracing Results:
============================================================
Traces completed: 9
Spans received: 9

Trace(trace_15..., 1 spans, 0.076s)
  Duration: 0.076s
  Spans: 1
  Operations:
    - process_data (0.076s)

Trace(trace_15..., 1 spans, 0.335s)
  Duration: 0.335s
  Spans: 1
  Operations:
    - handle_request (0.335s)

Trace(trace_15..., 1 spans, 0.335s)
  Duration: 0.335s
  Spans: 1
  Operations:
  - Client.make_request (0.335s)

Trace(trace_85..., 1 spans, 0.067s)
  Duration: 0.067s
  Spans: 1
  Operations:
    - process_data (0.067s)

Trace(trace_85..., 1 spans, 0.249s)
  Duration: 0.249s
  Spans: 1
  Operations:
    - handle_request (0.249s)

Trace(trace_85..., 1 spans, 0.249s)
  Duration: 0.249s
  Spans: 1
  Operations:
  - Client.make_request (0.249s)

Trace(trace_11..., 1 spans, 0.147s)
  Duration: 0.147s
  Spans: 1
  Operations:
    - process_data (0.147s)

Trace(trace_11..., 1 spans, 0.342s)
  Duration: 0.342s
  Spans: 1
  Operations:
    - handle_request (0.342s)

Trace(trace_11..., 1 spans, 0.342s)
  Duration: 0.342s
  Spans: 1
  Operations:
  - Client.make_request (0.342s)
</code></pre></div>
</div>
<h2 id="tracing-useful">Useful Data</h2>
<p>The code we just built commits a cardinal sin:
it generates data in an undocumented, hard-to-parse ASCII format.
In most cases trace data will be consumed by other programs,
which will summarize and reorganize it
to make it comprehensible to human beings.
To support that,
we should always generate data in a structured format such as JSON,
and use a standard <a href="../glossary/#schema">schema</a> instead of creating one of our own.</p>
<p>The <a href="https://opentelemetry.io/">OpenTelemetry</a> standard defines such a schema,
but it is notoriously complex.
The simplified subset generated by <code>json_collector.py</code> has:</p>
<ul>
<li>a single resource per trace (OpenTelemetry supports multiple);</li>
<li>a single scope per resource (again, OpenTelemetry supports multiple);</li>
<li>one kind of span instead of the six that OpenTelemetry offers;</li>
<li>no links between spans; and</li>
<li>simplified status codes.</li>
</ul>
<p>Even with these simplifications,
a simple example like the one below produces over 300 lines of pretty-printed output:</p>
<div data-filter="inc=client" data-inc="ex_json.py"><div class="codehilite"><pre class=""><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SimpleClient</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""Client that initiates traced requests."""</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">service</span><span class="p">:</span> <span class="n">SimpleService</span><span class="p">,</span> <span class="n">collector</span><span class="p">:</span> <span class="n">BaseCollector</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span> <span class="o">=</span> <span class="n">service</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collector</span> <span class="o">=</span> <span class="n">collector</span>
        <span class="n">Storage</span><span class="o">.</span><span class="n">set_collector</span><span class="p">(</span><span class="n">collector</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Generate requests."""</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="mf">1.5</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_request</span><span class="p">(</span><span class="sa">f</span><span class="s2">"req_</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="nd">@trace_root</span><span class="p">(</span><span class="s2">"make_request"</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">make_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">"""Make a traced request - decorator handles trace creation."""</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">Storage</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>

        <span class="n">response_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">ServiceRequest</span><span class="p">(</span>
            <span class="n">request_id</span><span class="o">=</span><span class="n">req_id</span><span class="p">,</span>
            <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
            <span class="n">payload</span><span class="o">=</span><span class="p">{</span><span class="s2">"data"</span><span class="p">:</span> <span class="sa">f</span><span class="s2">"request_</span><span class="si">{</span><span class="n">req_id</span><span class="si">}</span><span class="s2">"</span><span class="p">},</span>
            <span class="n">response_queue</span><span class="o">=</span><span class="n">response_queue</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">request_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">response</span>
</code></pre></div>
</div>
<p>A sample clause of this JSON looks like this:</p>
<div data-filter="head=52" data-inc="ex_json.txt"><div class="codehilite"><pre class=""><span></span><code>{
  "resourceSpans": [
    {
      "resource": {
        "attributes": [
          {
            "key": "service.name",
            "value": {
              "stringValue": "tutorial-service"
            }
          }
        ]
      },
      "scopeSpans": [
        {
          "scope": {
            "name": "distributed-tracing-tutorial",
            "version": "1.0.0"
          },
          "spans": [
            {
              "traceId": "trace_7952713",
              "spanId": "span_8629030",
              "name": "process_data",
              "kind": 1,
              "startTimeUnixNano": 1659043996,
              "endTimeUnixNano": 1715460553,
              "attributes": [
                {
                  "key": "service.name",
                  "value": {
                    "stringValue": "OrderService"
                  }
                },
                {
                  "key": "success",
                  "value": {
                    "boolValue": true
                  }
                }
              ],
              "status": {
                "code": 1
              },
              "parentSpanId": "span_2664154"
            }
          ]
        }
      ]
    }
  ]
}
</code></pre></div>
</div>
<p>It isn't something anyone would browse for fun,
but (hopefully) everything needed to track down problems is there.</p>
<h2 id="tracing-exercises">Exercises</h2>
<p>FIXME: add exercises.</p>
</main>
<footer>
<div class="row">
<div class="col-3 left">
	  ⇐ <a href="../worksteal/">A Work-Stealing Scheduler</a>
</div>
<div class="col-6 center">
<a href="../"></a>
	  © 2025
	  <a href="../#acknowledgments">the authors</a>
</div>
<div class="col-3 right">
<a href="../crdt/">Conflict-Free Replicated Data Types</a> ⇒
	</div>
</div>
</footer>
</body>
</html>
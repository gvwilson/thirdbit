<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link rel="me" href="https://mastodon.social/@gvwilson">
<link rel="shortcut icon" type="image/x-icon" href="../favicon.ico">
<link rel="alternate" type="application/atom+xml" title="The Third Bit" href="../atom.xml">
<!-- <script defer data-domain="third-bit.com" src="https://plausible.io/js/plausible.js"></script> -->
    <script src="https://kit.fontawesome.com/4eee35f757.js"></script>
    <link rel="stylesheet" href="../assets/thirdbit.css">
    <link rel="stylesheet" href="../assets/page.css">
    
<title>The Third Bit Blog</title>

    
  </head>
  <body>
    <nav>
  <div class="row underline">
    <div class="col-2 left">
      <a class="navlink" href="../">Home</a>
    </div>
    <div class="col-10 right">
      <a class="navlink" href="../about/">about</a>
      <a class="navlink" href="../blog/">blog</a>
      <a class="navlink" href="../selected/">selected</a>
      <a class="navlink" href="../talks/">talks</a>
      <a class="navlink" href="../bib/">bibliography</a>
      <a class="navlink" href="../fiction/">fiction</a>
    </div>
  </div>
</nav>
    <main>
      
<h1>Blog</h1>


<table class="centered">
  <tbody>
    <tr>
      <td><a href="../archive/2020">2020</a></td>
      <td><a href="../archive/2021">2021</a></td>
      <td><a href="../archive/2022">2022</a></td>
      <td><a href="../archive/2023">2023</a></td>
      <td><a href="../archive/2024">2024</a></td>
      <td><a href="../archive/2025">2025</a></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td><a href="../archive/2010">2010</a></td>
      <td><a href="../archive/2011">2011</a></td>
      <td><a href="../archive/2012">2012</a></td>
      <td><a href="../archive/2013">2013</a></td>
      <td><a href="../archive/2014">2014</a></td>
      <td><a href="../archive/2015">2015</a></td>
      <td><a href="../archive/2016">2016</a></td>
      <td><a href="../archive/2017">2017</a></td>
      <td><a href="../archive/2018">2018</a></td>
      <td><a href="../archive/2019">2019</a></td>
    </tr>
    <tr>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td><a href="../archive/2004">2004</a></td>
      <td><a href="../archive/2005">2005</a></td>
      <td><a href="../archive/2006">2006</a></td>
      <td><a href="../archive/2007">2007</a></td>
      <td><a href="../archive/2008">2008</a></td>
      <td><a href="../archive/2009">2009</a></td>
    </tr>
  </tbody>
</table>


<article class="post">
  <h2 class="post-title">
    <a href="../2025/11/28/what-changed/">
      What Changed?
    </a>
  </h2>
  <p><time datetime="2025-11-28" class="post-date">2025-11-28</time></p>
  <p>Your company brought in a new CEO,
and she believes that you can&rsquo;t manage what you don&rsquo;t measure.
One of the first things she does is dig up historical data
on how long developers and testers have spent fixing bugs over the past year.
When she plots the data quarter by quarter,
she gets the following plots:</p>
<div class="row">
  <div class="col-6 center">
    <img src="../files/2025/11/28/times-0.0.svg" alt="no rework" width="90%">
    <br>
    First Quarter
  </div>
  <div class="col-6 center">
    <img src="../files/2025/11/28/times-0.1.svg" alt="10% rework" width="90%">
    <br>
    Second Quarter
  </div>
</div>
<div class="row">
  <div class="col-6 center">
    <img src="../files/2025/11/28/times-0.3.svg" alt="30% rework" width="90%">
    <br>
    Third Quarter
  </div>
  <div class="col-6 center">
    <img src="../files/2025/11/28/times-0.5.svg" alt="50% rework" width="90%">
    <br>
    Fourth Quarter
  </div>
</div>

<p>The number of bugs taking more than 20 hours to close is clearly going up over time,
but why?
There hasn&rsquo;t been any turnover in the team,
or a major rewrite of the product.
What has changed?</p>
<p>After a bit of digging,
she discovers that developers were reporting time in 10-hour blocks in Q1,
so that sharp cutoff is an accounting artifact.
However,
that doesn&rsquo;t explain why the number of issues taking more than 10 hours
has slowly but steadily been creeping up from Q2 to the end of the year.
I&rsquo;ll post the reason tomorrow;
for today,
see what theories you can come up with
and what data you would need to confirm or refute them.</p>
</article>

<article class="post">
  <h2 class="post-title">
    <a href="../2025/11/27/not-created-equal/">
      Not Created Equal
    </a>
  </h2>
  <p><time datetime="2025-11-27" class="post-date">2025-11-27</time></p>
  <p><a href="../2025/11/26/malice-and-randomness/">Yesterday&rsquo;s post</a> pointed out that
it can be hard to distinguish cause and effect from random variation.
One way to tell them apart is to vary the simulation parameters systematically
to see when various phenomena appear and disappear.
For example,
suppose we modify the simulation to account for the fact that
not all tasks are created equal.
Some bugs and features have higher priority than others,
and our team will generally work on more important items before they work on less important ones.</p>
<p>Alongside the <code>Store</code> we have been using to model our work queue,
<a href="https://simpy.readthedocs.io/">SimPy</a> offers a <code>PriorityStore</code> that keeps items sorted in priority order.
(The lower the item&rsquo;s score, the higher its priority.)
Let&rsquo;s modify the <code>Simulation</code> class to make the development and testing queues priority stores:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Simulation</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Environment</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev_queue</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">PriorityStore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_queue</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">PriorityStore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_log</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>
<p>and then add a new parameter <code>task_priorities</code>
whose value is a list of probabilities:</p>
<div class="highlight"><pre><span></span><code><span class="n">PARAMS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="err">…</span><span class="n">previous</span> <span class="n">code</span><span class="err">…</span>
    <span class="s2">&quot;task_priorities&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">],</span>
<span class="p">}</span>
</code></pre></div>
<p>The list shown above tells us that there&rsquo;s a 10% chance of a new task having priority 0,
a 30% chance of it having priority 1,
and a 60% chance of it having priority 2.
When we create a task,
we assign it a priority at random with these weights:</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">task_priority</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;task_priorities&quot;</span><span class="p">]))),</span>
            <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;task_priorities&quot;</span><span class="p">],</span>
            <span class="n">k</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>
<p>(We need the <code>[0]</code> at the end because <code>random.choices</code> always returns a list of choices,
even when we tell it we only want one value.)
Finally,
when we&rsquo;re adding a new task to the development queue
we wrap it in a <code>PriorityItem</code>
to pair the task with its priority:</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">sim</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">task_arrival</span><span class="p">())</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">sim</span><span class="o">.</span><span class="n">dev_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">simpy</span><span class="o">.</span><span class="n">PriorityItem</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="s2">&quot;priority&quot;</span><span class="p">],</span> <span class="n">task</span><span class="p">))</span>
</code></pre></div>
<div class="row">
  <div class="col-6 center">
    <img src="../files/2025/11/27/queues-136.svg" alt="10/30/60" width="90%">
    <br>
    Queue lengths: 10/30/60
  </div>
  <div class="col-6 center">
    <img src="../files/2025/11/27/queues-334.svg" alt="30/30/40" width="90%">
    <br>
    Queue lengths: 30/30/40
  </div>
</div>
<div class="row">
  <div class="col-6 center">
    <img src="../files/2025/11/27/queues-433.svg" alt="40/30/30" width="90%">
    <br>
    Queue lengths: 40/30/30
  </div>
  <div class="col-6 center">
    <img src="../files/2025/11/27/queues-442.svg" alt="40/40/20" width="90%">
    <br>
    Queue lengths: 40/40/20
  </div>
</div>

<p>The top (green) line in these four charts is the number of priority-2 tasks
waiting in the development queue.
It grows steadily because developers are basically busy at all times with higher-priority tasks;
it&rsquo;s only when 80% or more of tasks are higher priority that
we start to see a backlog of priority-1 tasks build up.
I don&rsquo;t know if I expected this or not,
but I certainly <em>didn&rsquo;t</em> expect that the testers would always be able to keep up
with tasks of all priorities.</p>
<p>These curves look familiar to me.
In my previous role at <a href="https://plot.ly/">Plotly</a>,
I was responsible for managing the backlog of bug reports and feature requests
for the open source libraries.
When I started in April 2025,
nobody had gone through them for several years;
over that summer,
I cleared out enough stale and duplicated items
to get the three main repositories from about 7000 issues down to about 1700.
I then watched as the number grew slowly but steadily over the next twelve months.
Everyone on the team was working hard,
but if your library, tool, or application is useful,
there will <em>always</em> be more work to do than people to do it.
The only &ldquo;solution&rdquo; is to be ruthless about labeling
so that you don&rsquo;t get demoralized.</p>
</article>

<article class="post">
  <h2 class="post-title">
    <a href="../2025/11/26/malice-and-randomness/">
      Malice and Randomness
    </a>
  </h2>
  <p><time datetime="2025-11-26" class="post-date">2025-11-26</time></p>
  <p>The main point of <a href="../2025/11/25/you-cant-tell/">yesterday&rsquo;s post</a> was that
any simple view of a complex system can be interpreted in several ways.
Is work piling up?
That&rsquo;s good to know
(quick, do you have a plot of how much your backlog has grown over the last year?),
but figuring out <em>why</em> requires usually close investigation.</p>
<p>Here&rsquo;s another example.
Suppose you&rsquo;re keeping track of the development and testing backlog over time,
and you get a graph like this:</p>
<div class="center">
  <img src="../files/2025/11/26/queue-1k.svg" alt="queue lengths over time">
</div>

<p>Your first question is going to be,
&ldquo;What changed around t=3000 that made the development backlog get five times larger?&rdquo;
Your second will be,
&ldquo;And what changed around t=5000 to bring it back down again?&rdquo;
You might even ask what happened between t=1000 and t=3000 to cause a smaller spike;
was that an early warning that you missed?
Or did the same thing go wrong at t=1000 and t=3000,
but for some reason it was caught and fixed earlier the first time?</p>
<p><a href="https://en.wikipedia.org/wiki/Hanlon%27s_razor">Hanlon&rsquo;s Razor</a> states,
&ldquo;Never attribute to malice that which is adequately explained by stupidity.&rdquo;
The statistical equivalent is,
&ldquo;Never attribute to human action that which is adequately explained by random variation.&rdquo;
The truth is that <em>nothing remarkable happened</em> to cause the two humps shown in the plot above.
They are just random variations in a random system.
We can see more of this if we run the simulation for 10,000 timesteps instead of 1000:</p>
<div class="center">
  <img src="../files/2025/11/26/queue-10k.svg" alt="queue lengths over time">
</div>

<p>It <em>looks</em> like the development backlog is slowly increasing,
and that the testing backlog is following that increase with a bit of a lag,
but how confident are you of this?
If we run the simulation even longer,
would you be surprised if the backlogs decreased again?</p>
<p>The data we collect and the dashboards we build
can help us identify things that might need to be explained,
but we have to interpret them in order to create those explanations.
As Elisabeth Hendrickson and Joel Tosi point out in their upcoming book
<em><a href="https://signalsandlevers.com/book/">Signals &amp; Levers</a></em>,
something as simple as a <a href="https://en.wikipedia.org/wiki/Shewhart_individuals_control_chart">Shewhart chart</a>
can help you distinguish normal variation from things you might need to worry about.</p>
</article>

<article class="post">
  <h2 class="post-title">
    <a href="../2025/11/25/you-cant-tell/">
      You Can't Tell
    </a>
  </h2>
  <p><time datetime="2025-11-25" class="post-date">2025-11-25</time></p>
  <p><a href="../2025/11/24/analyzing-simulation/">Yesterday&rsquo;s post</a> checked our prediction
about where work would pile up.
As a reminder,
here are plots showing the lengths of the development and testing queues
and how much time developers and testers spend working and waiting:</p>
<div class="row">
  <div class="col-6 center">
    <img src="../files/2025/11/24/queues.svg" alt="time-series chart of queue lengths" width="90%">
  </div>
  <div class="col-6 center">
    <img src="../files/2025/11/24/times.svg" alt="time-series chart of developer and tester time" width="90%">
  </div>
</div>

<p>Let&rsquo;s change a single parameter and re-run the simulation.
We see a few jobs waiting in the testing queue more often,
and more importantly,
that testers are spending most of their time working instead of waiting:</p>
<div class="row">
  <div class="col-6 center">
    <img src="../files/2025/11/25/two-testers-queues.svg" alt="time-series chart of queue lengths" width="90%">
  </div>
  <div class="col-6 center">
    <img src="../files/2025/11/25/two-testers-times.svg" alt="time-series chart of developer and tester time" width="90%">
  </div>
</div>

<p>Here&rsquo;s the key question,
and the main point of this series of posts:</p>
<div class="center">
<p><em>Can you tell from these graphs alone which parameter changed?</em></p>
</div>
<p>The answer is &ldquo;no&rdquo;.
It&rsquo;s clear that <em>something</em> has changed,
but our two-plot dashboard doesn&rsquo;t give us enough insight for us to know what.
In this case the answer is that we cut the number of testers on the team from 3 to 2
while leaving both developers in place.
Testing still takes an average of 4.5 timesteps,
while development takes an average of 5.5 timesteps,
so the developers still can&rsquo;t keep the testers busy all the time,
but <em>you can&rsquo;t tell this from these plots</em>.</p>
<p>Let&rsquo;s stick to two developers and two testers and make one more change.
The testers are now busy almost all the time,
and the testing queue always seems to have a backlog,
but that backlog doesn&rsquo;t appear to grow over time:</p>
<div class="row">
  <div class="col-6 center">
    <img src="../files/2025/11/25/queues.svg" alt="time-series chart of queue lengths" width="90%">
  </div>
  <div class="col-6 center">
    <img src="../files/2025/11/25/times.svg" alt="time-series chart of developer and tester time" width="90%">
  </div>
</div>

<p>Again,
you can&rsquo;t tell from these plots alone what changed.
In this case it isn&rsquo;t just a parameter:
instead of the testing time being completely independent of the development time,
we&rsquo;re multiplying the development time by a random number between 0.5 and 1.5
to determine the testing time,
on the theory that things that take longer to develop
usually take longer to test as well.
This is a fundamental change to the model,
but if we didn&rsquo;t have access to the simulation and its parameters
(which we wouldn&rsquo;t in the real world),
we would need to look collect different data and look at it more closely
to figure out what the hell was going on.</p>
</article>

<article class="post">
  <h2 class="post-title">
    <a href="../2025/11/24/analyzing-simulation/">
      Analyzing the Simulation
    </a>
  </h2>
  <p><time datetime="2025-11-24" class="post-date">2025-11-24</time></p>
  <p><a href="../2025/11/23/simulating-multiple-stages/">Yesterday&rsquo;s post</a> added a second stage to the simulation,
and made a prediction about where work would pile up.
Today,
we&rsquo;re going to check whether that prediction is correct.
As a reminder,
our system is:</p>
<div class="highlight"><pre><span></span><code>+----------------+    +-----------+    +------------+    +------------+    +---------+
| task generator | -&gt; | dev queue | -&gt; | developers | -&gt; | test queue | -&gt; | testers |
+----------------+    +-----------+    +------------+    +------------+    +---------+
</code></pre></div>
<p>Tasks arrive every 2.0 timesteps.
It takes each of our two developers an average of 5.5 timesteps to complete a task,
while each of our three testers needs an average of 4.5 timesteps to test the result.
This means that developers should complete one task every 2.75 timesteps,
and testers should be able to complete one every 1.5 timesteps.
We should therefore see work piling up in the development queue,
while the test queue should be more or less empty most of the time.</p>
<h2>Yup</h2>
<p>It only takes a few lines of code
to produce time-series line chart using <a href="https://pola.rs/">Polars</a> and <a href="https://plotly.com/python/plotly-express/">Plotly Express</a>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px</span>


<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;usage: analyze.py csvfile plotfile&quot;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> \
       <span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;kind&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;dev_queue&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;kind&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;test_queue&quot;</span><span class="p">))</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;kind&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</code></pre></div>
<p>Sure enough,
the queue of tasks waiting for a developer&rsquo;s attention grows and grows,
while tasks only wait occasionally (and briefly) for testing:</p>
<div class="center">
  <img src="../files/2025/11/24/queues.svg" alt="time-series chart of queue lengths">
</div>

<p>A little bit more analysis confirms that yes,
our testers are spending a lot of their time waiting for work
while our developers are busy nearly 100% of the time:</p>
<div class="center">
  <img src="../files/2025/11/24/times.svg" alt="time-series chart of developer and tester time">
</div>

<h2>Little&rsquo;s Law</h2>
<p>One of the most useful results from queueing theory is
a generalization of the quick-and-dirty math we did at the start of this post
that predicted where jobs would pile up.
<a href="https://en.wikipedia.org/wiki/Little%27s_law">Little&rsquo;s Law</a> states that L = λW, where:</p>
<ul>
<li>L is the average number of tasks in the system,</li>
<li>λ is the average arrival rate, and</li>
<li>W is the average time each task spends in the system.</li>
</ul>
<p>For example,
if tasks arrive at a rate of λ = 2 per day
and each spends W = 5 days being worked on,
then on average L = 10 tasks are being worked on at any time.
If each worker does one task at a time, we can infer there are 10 workers.
Most software development teams don&rsquo;t track <em>any</em> of these three numbers;
I hope this series of posts is convincing you that it&rsquo;s worth doing.</p>
</article>

<article class="post">
  <h2 class="post-title">
    <a href="../2025/11/23/simulating-multiple-stages/">
      Simulating Multiple Stages
    </a>
  </h2>
  <p><time datetime="2025-11-23" class="post-date">2025-11-23</time></p>
  <p>After <a href="../2025/11/22/refactoring-the-simulation/">yesterday&rsquo;s refactoring</a>,
we&rsquo;re ready to make the simulation a bit more realistic
by adding a second stage: testing.
Our updated default parameters will be:</p>
<div class="highlight"><pre><span></span><code><span class="n">PARAMS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;max_dev_time&quot;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="s2">&quot;max_test_time&quot;</span><span class="p">:</span> <span class="mf">8.0</span><span class="p">,</span>        <span class="c1"># new</span>
    <span class="s2">&quot;num_developers&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;num_testers&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>            <span class="c1"># new</span>
    <span class="s2">&quot;random_seed&quot;</span><span class="p">:</span> <span class="mi">12345</span><span class="p">,</span>
    <span class="s2">&quot;simulation_time&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
    <span class="s2">&quot;task_arrival_rate&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>which will control simulation of this system:</p>
<div class="highlight"><pre><span></span><code>+----------------+    +-----------+    +------------+    +------------+    +---------+
| task generator | -&gt; | dev queue | -&gt; | developers | -&gt; | test queue | -&gt; | testers |
+----------------+    +-----------+    +------------+    +------------+    +---------+
</code></pre></div>
<p>Before we start, let&rsquo;s make a prediction.
Development times and testing times are uniformly distributed,
so the mean for each are 5.5 and 4.5 respectively (i.e., (1+10)/2 and (1+8)/2).
With two developers,
we should be able to process one task every 2.75 timesteps;
with three testers,
we should be able to process one task every 1.5 timesteps.
We should therefore see tasks piling up in the test queue
because the testers can take them out
faster than the developers can put them in.</p>
<h2>The <code>Simulation</code> Class</h2>
<p>The first step is to modify the <code>Simulation</code> class that holds all our assets
to create two queues instead of one:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Simulation</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Environment</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev_queue</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_queue</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
</code></pre></div>
<h2>The <code>Task</code> Class</h2>
<p>As described <a href="../2025/11/22/refactoring-the-simulation/">yesterday</a>,
<code>Task</code> is basically a bag full of properties.
For convenience,
we have made the task generator a static method of this class
rather than a free-standing function.
In order to test our hypothesis about where tasks are going to pile up,
we will record the length of the waiting-for-development queue in each task
when it is created:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Task</span><span class="p">(</span><span class="n">Labeled</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A single (passive) task.&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate tasks and add to the development queue.&quot;&quot;&quot;</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">sim</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">task_arrival</span><span class="p">())</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>
            <span class="n">task</span><span class="p">[</span><span class="s2">&quot;dev_queue_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dev_queue</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">sim</span><span class="o">.</span><span class="n">dev_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct.&quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;arrived&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">now</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;dev_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dev_time</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;test_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">test_time</span><span class="p">()</span>
</code></pre></div>
<h2>The <code>Developer</code> Class</h2>
<p>The only changes to the <code>Developer</code> are
(a) putting the task in the testing queue once development is finished
and (b) recording more information,
such as the total time this developer has spent working:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Developer</span><span class="p">(</span><span class="n">Labeled</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A single developer.&quot;&quot;&quot;</span>

    <span class="err">…</span><span class="n">constructor</span><span class="err">…</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">work</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulate work.&quot;&quot;&quot;</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span>
            <span class="n">task</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">dev_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;waiting&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">now</span>

            <span class="n">now</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;dev_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="s2">&quot;dev_time&quot;</span><span class="p">])</span>
            <span class="n">task</span><span class="p">[</span><span class="s2">&quot;dev_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;working&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">now</span>

            <span class="n">task</span><span class="p">[</span><span class="s2">&quot;test_queue_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">dev_queue</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">test_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</code></pre></div>
<p>Deciding what information to record was
the hardest part of writing this version of the simulation.
Should each developer keep a list of the time spent per task
rather than just summing it up?
That felt redundant,
given that we&rsquo;re recording development time in each task.
But what about recording which developers do which tasks?
Or keeping track of how much time each developer spent waiting for a task to appear?
In the end we decided to record the latter but not the former.</p>
<p>Each of these decisions constrains what questions we can ask about our development process.
One of the reasons to use a tool like <a href="https://www.swarmia.com/">Swarmia</a> is that
they have thought through these questions
and figured out what to collect in order to get useful answers.</p>
<h2>The <code>Tester</code> Class</h2>
<p>Each tester takes jobs from the testing queue,
spends some time working on them,
and records a few statistics.
The code is almost the same as that for a developer,
but after reorganizing it a couple of times
we decided that two separate classes would be easier to understand
than one class with a couple of <code>if</code> statements to control behavior:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Tester</span><span class="p">(</span><span class="n">Labeled</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A single (active) tester.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct.&quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span> <span class="o">=</span> <span class="n">sim</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">work</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulate work.&quot;&quot;&quot;</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span>
            <span class="n">task</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">test_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;waiting&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">now</span>

            <span class="n">now</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;test_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="s2">&quot;test_time&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;working&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">now</span>
            <span class="n">task</span><span class="p">[</span><span class="s2">&quot;test_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span>
</code></pre></div>
<h2>The Main Driver</h2>
<p>We haven&rsquo;t shown <code>main</code> in a while,
so here is what it has become:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main driver.&quot;&quot;&quot;</span>

    <span class="c1"># Handle command-line arguments and parameters.</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="n">update_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;random_seed&quot;</span><span class="p">])</span>

    <span class="c1"># Create and run the simulation and its processes.</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">Task</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">sim</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;num_developers&quot;</span><span class="p">]):</span>
        <span class="n">dev</span> <span class="o">=</span> <span class="n">Developer</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">work</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;num_testers&quot;</span><span class="p">]):</span>
        <span class="n">tester</span> <span class="o">=</span> <span class="n">Tester</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">tester</span><span class="o">.</span><span class="n">work</span><span class="p">())</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># Report results.</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">make_log</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">PrettyTable</span><span class="p">()</span>
        <span class="n">table</span><span class="o">.</span><span class="n">field_names</span> <span class="o">=</span> <span class="n">log</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">table</span><span class="o">.</span><span class="n">add_rows</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">table</span><span class="o">.</span><span class="n">align</span> <span class="o">=</span> <span class="n">TABLE_ALIGNMENT</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">lineterminator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
</code></pre></div>
<h2>The Output, and Why</h2>
<p>Running the simulation with the default parameters shown earlier
produces this output:</p>
<div class="highlight"><pre><span></span><code>kind,id,key,value
parameter,,max_dev_time,10.0
parameter,,max_test_time,8.0
parameter,,num_developers,2
parameter,,num_testers,3
parameter,,random_seed,12345
parameter,,simulation_time,20
parameter,,task_arrival_rate,2.0
task,0,arrived,1.08
task,0,dev_queue_length,0
task,0,dev_time,1.09
task,0,dev_start,1.08
task,0,dev_end,2.17
task,0,test_queue_length,0
task,0,test_time,6.78
task,0,test_start,2.17
task,0,test_end,8.95
task,1,arrived,1.79
task,1,dev_queue_length,0
task,1,dev_time,4.32
…
…many more lines here…
…
task,13,test_time,6.77
task,13,test_start,0.0
task,13,test_end,0.0
developer,0,working,16.01
developer,0,waiting,2.37
developer,1,working,8.51
developer,1,waiting,1.89
tester,0,working,6.78
tester,0,waiting,7.53
tester,1,working,9.58
tester,1,waiting,8.53
tester,2,working,5.74
tester,2,waiting,13.8
</code></pre></div>
<p>which is much easier to read as a table:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">kind</th>
<th style="text-align: right;">id</th>
<th style="text-align: left;">key</th>
<th style="text-align: right;">value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">parameter</td>
<td style="text-align: right;">None</td>
<td style="text-align: left;">max_dev_time</td>
<td style="text-align: right;">10.0</td>
</tr>
<tr>
<td style="text-align: left;">parameter</td>
<td style="text-align: right;">None</td>
<td style="text-align: left;">max_test_time</td>
<td style="text-align: right;">8.0</td>
</tr>
<tr>
<td style="text-align: left;">parameter</td>
<td style="text-align: right;">None</td>
<td style="text-align: left;">num_developers</td>
<td style="text-align: right;">2</td>
</tr>
<tr>
<td style="text-align: left;">parameter</td>
<td style="text-align: right;">None</td>
<td style="text-align: left;">num_testers</td>
<td style="text-align: right;">3</td>
</tr>
<tr>
<td style="text-align: left;">parameter</td>
<td style="text-align: right;">None</td>
<td style="text-align: left;">random_seed</td>
<td style="text-align: right;">12345</td>
</tr>
<tr>
<td style="text-align: left;">parameter</td>
<td style="text-align: right;">None</td>
<td style="text-align: left;">simulation_time</td>
<td style="text-align: right;">20</td>
</tr>
<tr>
<td style="text-align: left;">parameter</td>
<td style="text-align: right;">None</td>
<td style="text-align: left;">task_arrival_rate</td>
<td style="text-align: right;">2.0</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">arrived</td>
<td style="text-align: right;">1.08</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">dev_queue_length</td>
<td style="text-align: right;">0</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">dev_time</td>
<td style="text-align: right;">1.09</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">dev_start</td>
<td style="text-align: right;">1.08</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">dev_end</td>
<td style="text-align: right;">2.17</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">test_queue_length</td>
<td style="text-align: right;">0</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">test_time</td>
<td style="text-align: right;">6.78</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">test_start</td>
<td style="text-align: right;">2.17</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">test_end</td>
<td style="text-align: right;">8.95</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">arrived</td>
<td style="text-align: right;">1.79</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">dev_queue_length</td>
<td style="text-align: right;">0</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">dev_time</td>
<td style="text-align: right;">4.32</td>
</tr>
<tr>
<td style="text-align: left;">…</td>
<td style="text-align: right;">…</td>
<td style="text-align: left;">…</td>
<td style="text-align: right;">…</td>
</tr>
<tr>
<td style="text-align: left;">…</td>
<td style="text-align: right;">…</td>
<td style="text-align: left;">…</td>
<td style="text-align: right;">…</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">13</td>
<td style="text-align: left;">test_time</td>
<td style="text-align: right;">6.77</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">13</td>
<td style="text-align: left;">test_start</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">13</td>
<td style="text-align: left;">test_end</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr>
<td style="text-align: left;">developer</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">working</td>
<td style="text-align: right;">16.01</td>
</tr>
<tr>
<td style="text-align: left;">developer</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">waiting</td>
<td style="text-align: right;">2.37</td>
</tr>
<tr>
<td style="text-align: left;">developer</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">working</td>
<td style="text-align: right;">8.51</td>
</tr>
<tr>
<td style="text-align: left;">developer</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">waiting</td>
<td style="text-align: right;">1.89</td>
</tr>
<tr>
<td style="text-align: left;">tester</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">working</td>
<td style="text-align: right;">6.78</td>
</tr>
<tr>
<td style="text-align: left;">tester</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">waiting</td>
<td style="text-align: right;">7.53</td>
</tr>
<tr>
<td style="text-align: left;">tester</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">working</td>
<td style="text-align: right;">9.58</td>
</tr>
<tr>
<td style="text-align: left;">tester</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">waiting</td>
<td style="text-align: right;">8.53</td>
</tr>
<tr>
<td style="text-align: left;">tester</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">working</td>
<td style="text-align: right;">5.74</td>
</tr>
<tr>
<td style="text-align: left;">tester</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">waiting</td>
<td style="text-align: right;">13.8</td>
</tr>
</tbody>
</table>
<p>This is not the most readable way to format the output for human consumption:
it would be more natural to store the simulation parameters in a two-column table,
then use another table with ten columns for tasks
(one for the ID, the others for arrival time, queue lengths, development time, and so on).
However,
there isn&rsquo;t a standard format for storing multiple tables in a single text file.
Our options are therefore:</p>
<ol>
<li>Create multiple output files for each simulation,
    which would be a pain to manage.</li>
<li>Use JSON or YAML,
    which would be even less readable than the four-column output shown above.</li>
<li>Create a multi-sheet spreadsheet or use a binary format like SQLite or HDF5,
    none of which play nicely with version control.</li>
</ol>
<p>Having all the output in a single file will make it relatively easy to build analysis tools:
we can load all the data from a single simulation into a single dataframe,
then filter to pull out data for tasks, developers, and testers,
and finally pivot it to create a wide table for each.
We&rsquo;ll tackle that tomorrow,
and then see if our hypothesis about developers being a bottleneck is true.</p>
</article>

<article class="post">
  <h2 class="post-title">
    <a href="../2025/11/22/refactoring-the-simulation/">
      Refactoring the Simulation
    </a>
  </h2>
  <p><time datetime="2025-11-22" class="post-date">2025-11-22</time></p>
  <p>After <a href="../2025/11/21/simulating-rework/">yesterday&rsquo;s experiments with rework</a>
I was going to spend a post or two building some charts,
but apparently people find a task-centric simulation less natural than a worker-centric one,
so instead I&rsquo;m going to do some rearchitecting.</p>
<h2>Parameters</h2>
<p>Let&rsquo;s start by going back to a pool of developers doing tasks one at a time without rework.
As before,
we&rsquo;ll define some default parameters,
including a random number seed to ensure reproducibility:</p>
<div class="highlight"><pre><span></span><code><span class="n">PARAMS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;max_task_duration&quot;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="s2">&quot;num_developers&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;random_seed&quot;</span><span class="p">:</span> <span class="mi">12345</span><span class="p">,</span>
    <span class="s2">&quot;simulation_duration&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s2">&quot;task_arrival_rate&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>To allow ad hoc experiments,
we can add a helper function <code>update_params</code> to parse a command line like:</p>
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>sim.py<span class="w"> </span><span class="nv">simulation_duration</span><span class="o">=</span><span class="m">50</span><span class="w"> </span><span class="nv">random_seed</span><span class="o">=</span><span class="m">67890</span>
</code></pre></div>
<p>and override the default parameters.
(You can see the function in <a href="https://github.com/gvwilson/thirdbit/blob/main/src/2025/11/22/sim.py">the source code</a>.)</p>
<h2>Bundling Simulation Elements</h2>
<p>As our simulation becomes more complex,
we&rsquo;re going to have more assets to manage:
pools of developers,
a work queue,
and eventually some testers and maybe even a manager or two.
Rather than passing a dozen objects around,
let&rsquo;s define a <code>Simulation</code> class to store them all:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Simulation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store simulation artifacts.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Environment</span><span class="p">()</span>
        <span class="err">…</span><span class="n">more</span> <span class="n">stuff</span> <span class="n">will</span> <span class="n">go</span> <span class="n">here</span><span class="err">…</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">until</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;simulation_duration&quot;</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">now</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">task_arrival</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">expovariate</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;task_arrival_rate&quot;</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">task_duration</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;max_task_duration&quot;</span><span class="p">])</span>
</code></pre></div>
<p>To save ourselves from repeatedly needing to type <code>sim.env</code>,
this class provides pass-through methods for the simulation environment&rsquo;s key methods and properties.
And since it is storing the simulation parameters,
it seems like the logical place to put the code
that uses those parameters to generate task arrival times and durations.</p>
<h2>Tasks</h2>
<p>This version of the simulator has active workers and passive tasks,
i.e.,
the workers are going to be processes that act on tasks.
A task is therefore just a sack full of properties like
when it arrived,
how long it takes to complete,
when work on it started,
and when work was completed:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Task</span><span class="p">(</span><span class="n">Labeled</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A single (passive) task.&quot;&quot;&quot;</span>

    <span class="err">…</span><span class="n">more</span> <span class="n">stuff</span> <span class="n">will</span> <span class="n">go</span> <span class="n">here</span><span class="err">…</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct.&quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arrived</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">now</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">task_duration</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">completed</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="err">…</span><span class="n">more</span> <span class="n">stuff</span> <span class="n">will</span> <span class="n">go</span> <span class="n">here</span><span class="err">…</span>
</code></pre></div>
<p>Note that <code>Task</code> is derived from a generic class called <code>Labeled</code>.
This class automatically gives each instance of <code>Task</code> a unique integer ID
and keeps a list of all the tasks created so far;
if you&rsquo;re interested,
you can see the magic in <a href="https://github.com/gvwilson/thirdbit/blob/main/src/2025/11/22/sim.py">the source code</a>.</p>
<h2>Where Do Tasks Go?</h2>
<p>Before we move on to modeling developers,
let&rsquo;s define a generator to create new tasks
and give the simulation a place to store them.
For the latter,
we will use a SimPy <code>Store</code>,
which provides a queue with <code>put</code> and <code>get</code> methods:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Simulation</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="err">…</span><span class="n">previous</span> <span class="n">code</span><span class="err">…</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
</code></pre></div>
<p>We then define a generator to add new tasks to this queue at random intervals.
This generator could be a free-standing function,
but we&rsquo;re likely to want to add other generators to the simulation in the future,
so let&rsquo;s make it a static method of the <code>Task</code> class instead:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Task</span><span class="p">(</span><span class="n">Labeled</span><span class="p">):</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">sim</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">task_arrival</span><span class="p">())</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">sim</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</code></pre></div>
<p>As we explained in <a href="../2025/11/18/starting-to-simulate/">the first post in this series</a>,
<code>generate</code>&rsquo;s use of <code>yield</code> means that it isn&rsquo;t a regular function.
Instead,
it creates a generator that SimPy can suspend and restart as often as it wants.
Each time around the <code>while</code> loop,
<code>generate</code> calls <code>sim.task_arrival()</code> to generate a random delay,
then calls <code>sim.timeout()</code> to create an object that means,
&ldquo;Please suspend this generator for this length of time.&rdquo;
The first <code>yield</code> inside the loop passes that object to SimPy,
which parks the generator until that much simulated time has passed.
When the generator resumes,
it creates a new task object and adds it to the queue of pending work.</p>
<blockquote>
<p>My first implementation of this function had a bug:
it called <code>sim.queue.put(task)</code> but didn&rsquo;t <code>yield</code> the result.
It took me a couple of minutes to remember that
a SimPy <code>Store</code> can have a limited capacity,
and that an attempt to add a new item to a <code>Store</code> will block
until there&rsquo;s room for it.
<code>sim.queue.put(task)</code> therefore doesn&rsquo;t actually add the object to the store;
instead,
it creates a temporary object that means,
&ldquo;Please add this to the store when there&rsquo;s space.&rdquo;
The generator has to give that temporary object to SimPy with <code>yield</code>
so that the framework can suspend the generator if necessary.
Our work queue has infinite capacity,
so the generator will never block waiting for space,
but we still need to use <code>yield</code>.</p>
</blockquote>
<h2>Modeling Developers</h2>
<p>With all that in place,
modeling each developer as an active process is fairly straightforward:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Developer</span><span class="p">(</span><span class="n">Labeled</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A single (active) developer.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct.&quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span> <span class="o">=</span> <span class="n">sim</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">work</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulate work.&quot;&quot;&quot;</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">task</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
            <span class="n">task</span><span class="o">.</span><span class="n">completed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span>
</code></pre></div>
<p>As with <code>Task</code>,
we derive <code>Developer</code> from <code>Labeled</code> so that
each developer will automatically have a unique integer ID.
<code>Developer.work</code> repeatedly gets a task from the work queue
(blocking if necessary until one is available),
records the task&rsquo;s start time,
suspends itself for some simulated length of time,
and then records the task&rsquo;s completion time.</p>
<h2>Logging</h2>
<p>Once the simulation is done,
we&rsquo;re going to want to look at how many tasks were completed
and how long tasks spent waiting for a developer:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">write_log</span><span class="p">(</span><span class="n">stream</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write task details as CSV.&quot;&quot;&quot;</span>

    <span class="n">log</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;kind&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="s2">&quot;arrived&quot;</span><span class="p">,</span> <span class="s2">&quot;started&quot;</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">)]</span>
    <span class="n">log</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">log</span><span class="p">()</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">Labeled</span><span class="o">.</span><span class="n">_all</span><span class="p">[</span><span class="s2">&quot;Task&quot;</span><span class="p">])</span>
    <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">lineterminator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
</code></pre></div>
<p><code>Labeled._all["Task"]</code> is a list of all the task objects created so far
(again, see <a href="https://github.com/gvwilson/thirdbit/blob/main/src/2025/11/22/sim.py">the source code</a> if you want details),
while <code>task.log()</code> is just:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Task</span><span class="p">(</span><span class="n">Labeled</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert to loggable entry.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="s2">&quot;task&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">log_fmt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">duration</span><span class="p">),</span>
            <span class="n">log_fmt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arrived</span><span class="p">),</span>
            <span class="n">log_fmt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">),</span>
            <span class="n">log_fmt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">completed</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div>
<p>with a bit of helper code:</p>
<div class="highlight"><pre><span></span><code><span class="n">PRECISION</span> <span class="o">=</span> <span class="mi">2</span>

<span class="k">def</span><span class="w"> </span><span class="nf">log_fmt</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">round</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">PRECISION</span><span class="p">)</span>
</code></pre></div>
<h2>The Output</h2>
<p>If we run the simulation with the default parameter values,
we get this output:</p>
<div class="highlight"><pre><span></span><code>kind,id,duration,arrived,started,completed
task,0,1.09,1.08,1.08,2.17
task,1,3.69,4.57,4.57,8.25
task,2,2.74,5.49,5.49,8.23
task,3,2.46,7.15,8.23,
task,4,4.9,7.42,8.25,
task,5,2.57,9.07,,
</code></pre></div>
<p>If we reformat this as a table:</p>
<table>
<thead>
<tr>
<th>kind</th>
<th style="text-align: right;">id</th>
<th style="text-align: right;">duration</th>
<th style="text-align: right;">arrived</th>
<th style="text-align: right;">started</th>
<th style="text-align: right;">completed</th>
</tr>
</thead>
<tbody>
<tr>
<td>task</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.09</td>
<td style="text-align: right;">1.08</td>
<td style="text-align: right;">1.08</td>
<td style="text-align: right;">2.17</td>
</tr>
<tr>
<td>task</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">3.69</td>
<td style="text-align: right;">4.57</td>
<td style="text-align: right;">4.57</td>
<td style="text-align: right;">8.25</td>
</tr>
<tr>
<td>task</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2.74</td>
<td style="text-align: right;">5.49</td>
<td style="text-align: right;">5.49</td>
<td style="text-align: right;">8.23</td>
</tr>
<tr>
<td>task</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">2.46</td>
<td style="text-align: right;">7.15</td>
<td style="text-align: right;">8.23</td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>task</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">4.9</td>
<td style="text-align: right;">7.42</td>
<td style="text-align: right;">8.25</td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td>task</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">2.57</td>
<td style="text-align: right;">9.07</td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
</tr>
</tbody>
</table>
<p>we can see that work started on the first three tasks as soon as they arrived,
that work started on the next two after a delay but didn&rsquo;t finish by the time the simulation ended,
and that the last task wasn&rsquo;t even started.</p>
<h2>Some Introspection</h2>
<p>Is this worker-centric design better that the previous task-centric design?
It was certainly easier to write,
but that&rsquo;s probably because I learned more about SimPy
and thought through design questions
while working on the earlier versions.
The real test is whether <em>you</em>, the reader, find it easier or harder to follow.
If you have an opinion,
please <a href="mailto:gvwilson@third-bit.com">reach out</a>.</p>
</article>

<article class="post">
  <h2 class="post-title">
    <a href="../2025/11/21/simulating-rework/">
      Simulating Rework
    </a>
  </h2>
  <p><time datetime="2025-11-21" class="post-date">2025-11-21</time></p>
  <p>In <a href="../2025/11/20/making-sense-of-simulation/">yesterday&rsquo;s post</a> we started collecting data from our simulation,
and discovered that our metrics will always give us numbers,
but those numbers might be garbage if we&rsquo;re measuring the wrong things or the wrong way.
In this post we&rsquo;ll make the simulation more realistic
by taking into account the fact that most first attempts to fix a bug
either don&rsquo;t fix it or introduce new bugs.</p>
<h2>Rework</h2>
<p>Let&rsquo;s introduce a new parameter to specify
the probability that a task needs to be re-done.
For the moment,
we&rsquo;ll assume this probability doesn&rsquo;t depend on
how many attempts have been made to finish the task so far.
While we&rsquo;re at it,
we&rsquo;ll introduce another parameter to specify
how many times we want to run the simulation:</p>
<div class="highlight"><pre><span></span><code><span class="n">PARAMS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="err">…</span><span class="n">previous</span> <span class="n">parameters</span><span class="err">…</span>
    <span class="s2">&quot;rework_probability&quot;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">,</span>
    <span class="s2">&quot;num_simulations&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>Next, we introduce a loop in <code>simulate_task</code>.
Each time around the loop,
we get a developer,
spend some time on the task,
and then check if we&rsquo;re done.
If we are,
we mark the task as completed and break out of the loop;
if not,
we go around the loop again.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">simulate_task</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">developers</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulate a task flowing through the system.&quot;&quot;&quot;</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">developers</span><span class="o">.</span><span class="n">request</span><span class="p">()</span> <span class="k">as</span> <span class="n">req</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">req</span>
            <span class="n">task</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">_duration</span><span class="p">)</span>
            <span class="n">task</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rework_probability&quot;</span><span class="p">]:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">completed</span><span class="p">()</span>
                <span class="k">break</span>
</code></pre></div>
<p>If we run our simulation a few times for 100,000 timesteps with two developers,
we complete an average of 14,550 tasks,
which works out to about 13.7 timesteps per task.
That&rsquo;s about 40% of the 36,000 tasks we complete in the same time without rework,
and gives us a baseline against which to compare
a more interesting variation on this model.</p>
<h2>Keeping the Same Developer</h2>
<p>When a task needs to be redone,
the code shown above always grabs the next available developer.
In most development teams,
though,
the same developer would keep working on the task.</p>
<p>We need to make two changes to the simulation to capture this.
First,
we create a <code>FilterStore</code> instead of a <code>Resource</code> to represent
our pool of developers:</p>
<div class="highlight"><pre><span></span><code>    <span class="n">developers</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">FilterStore</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">capacity</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;num_developers&quot;</span><span class="p">])</span>
</code></pre></div>
<p>The difference between the two is that <code>FilterStore</code> allows us to specify
a test or check that a resource has to satisfy when we claim it.
Here&rsquo;s the modified <code>simulate_task</code> that makes use of that:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">simulate_task</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">developers</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulate a task being re-worked by the same developer.&quot;&quot;&quot;</span>

    <span class="n">dev</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dev</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dev</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">developers</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dev</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">developers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">_id</span> <span class="o">==</span> <span class="n">dev</span><span class="o">.</span><span class="n">_id</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">_duration</span><span class="p">)</span>
        <span class="n">developers</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;rework_probability&quot;</span><span class="p">]:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">completed</span><span class="p">()</span>
            <span class="k">break</span>
</code></pre></div>
<p>Initially,
the task isn&rsquo;t associated with a developer
so <code>dev</code> is set to <code>None</code>.
The first time around the loop,
we use <code>developers.get()</code> without a test to claim a developer.
After that,
we always re-claim the same developer
by passing a function to <code>developers.get()</code> that says,
&ldquo;The only developer we want is the one with the same ID.&rdquo;
We then do some work,
put the developer back in the pool,
and check to see if we&rsquo;re done with this task or not.</p>
<h2>Does It Make a Difference?</h2>
<p>So here&rsquo;s our question:
does this policy change the total number of tasks completed or not?
On the one hand we could argue that it would
because we wouldn&rsquo;t be taking full advantage of idle developers.
On the other hand,
our developers are currently working almost 100% of the time,
so there aren&rsquo;t actually idle cycles going to waste.</p>
<p>The answer is that <em>under the assumptions baked into our simulation</em>
this change in policy doesn&rsquo;t have an impact on the total number of tasks that are completed.
If we increase the number of developers
and lower the rate at which new tasks arrive,
though,
that answer changes:
if developers <em>do</em> have idle cycles,
having developers &ldquo;own&rdquo; tasks is less efficient
than allowing whoever&rsquo;s free to work on whatever needs done.</p>
<p>Of course,
that model doesn&rsquo;t take into account the ramp-up time
that real developers need to familiarize themselves with new problems.
(Putting it another way,
it doesn&rsquo;t account for the time saved by having someone who understands the problem
go back to it.)
We could add another parameter to our model and another few lines of code to capture this,
but before we do that,
we need to put some better analysis machinery in place.</p>
</article>


    </main>
    <footer>
  &copy; 2004-2025 <a href="../about/">Greg Wilson</a>
  <a href="mailto:gvwilson@third-bit.com"><img src="../assets/icons/envelope.svg" alt="email" class="footer-icon"></a>
  <a href="https://www.linkedin.com/in/gvwilson/"><img src="../assets/icons/linkedin.svg" alt="LinkedIn" class="footer-icon"></a>
  <a href="https://mastodon.social/@gvwilson"><img src="../assets/icons/mastodon.svg" alt="Mastodon" class="footer-icon"></a>
  <a href="https://calendly.com/gvwilson/30min"><img src="../assets/icons/calendar.svg" alt="Calendly" class="footer-icon"></a>
  <a href="https://github.com/gvwilson"><img src="../assets/icons/github.svg" alt="GitHub" class="footer-icon"></a>
  <a href="https://www.youtube.com/channel/UCbDQ7FIeYB3FHRADAjUjfrg"><img src="../assets/icons/youtube.svg" alt="YouTube" class="footer-icon"></a>
  <a href="../bib/"><img src="../assets/icons/orcid.svg" alt="ORCID" class="footer-icon"></a>
  <a href="../atom.xml"><img src="../assets/icons/rss.svg" alt="RSS feed" class="footer-icon"></a>
  <a href="../license/"><img src="../assets/icons/cc-by.svg" alt="license" class="footer-icon"></a>
  <a href="../colophon/"><img src="../assets/icons/pencil.svg" alt="colophon" class="footer-icon"></a>
  <a href="../cv/"><img src="../assets/icons/file.svg" alt="CV" class="footer-icon"></a>
  <br>
  None of the material on this site may be used to train AI models without the express prior permission of the author.
</footer>
  </body>
</html>
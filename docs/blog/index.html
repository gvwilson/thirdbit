<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link rel="me" href="https://mastodon.social/@gvwilson">
<link rel="shortcut icon" type="image/x-icon" href="../favicon.ico">
<link rel="alternate" type="application/atom+xml" title="The Third Bit" href="../atom.xml">
<script defer data-domain="third-bit.com" src="https://plausible.io/js/plausible.js"></script>
    <script src="https://kit.fontawesome.com/4eee35f757.js"></script>
    <link rel="stylesheet" href="../assets/thirdbit.css">
    <link rel="stylesheet" href="../assets/page.css">
    
<title>The Third Bit Blog</title>

    
  </head>
  <body>
    <nav>
  <div class="row underline">
    <div class="col-2 left">
      <a class="navlink" href="../">Home</a>
    </div>
    <div class="col-10 right">
      <a class="navlink" href="../about/">about</a>
      <a class="navlink" href="../blog/">blog</a>
      <a class="navlink" href="../selected/">selected</a>
      <a class="navlink" href="../talks/">talks</a>
      <a class="navlink" href="../projects/">projects</a>
      <a class="navlink" href="../ideas/">ideas</a>
      <a class="navlink" href="../bib/">bibliography</a>
      <a class="navlink" href="../fiction/">fiction</a>
    </div>
  </div>
</nav>
    <main>
      
<h1>Blog</h1>


<table class="centered">
  <tbody>
    <tr>
      <td><a href="../archive/2020">2020</a></td>
      <td><a href="../archive/2021">2021</a></td>
      <td><a href="../archive/2022">2022</a></td>
      <td><a href="../archive/2023">2023</a></td>
      <td><a href="../archive/2024">2024</a></td>
      <td><a href="../archive/2025">2025</a></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td><a href="../archive/2010">2010</a></td>
      <td><a href="../archive/2011">2011</a></td>
      <td><a href="../archive/2012">2012</a></td>
      <td><a href="../archive/2013">2013</a></td>
      <td><a href="../archive/2014">2014</a></td>
      <td><a href="../archive/2015">2015</a></td>
      <td><a href="../archive/2016">2016</a></td>
      <td><a href="../archive/2017">2017</a></td>
      <td><a href="../archive/2018">2018</a></td>
      <td><a href="../archive/2019">2019</a></td>
    </tr>
    <tr>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td><a href="../archive/2004">2004</a></td>
      <td><a href="../archive/2005">2005</a></td>
      <td><a href="../archive/2006">2006</a></td>
      <td><a href="../archive/2007">2007</a></td>
      <td><a href="../archive/2008">2008</a></td>
      <td><a href="../archive/2009">2009</a></td>
    </tr>
  </tbody>
</table>


<article class="post">
  <h2 class="post-title">
    <a href="../2025/04/21/lazy-loading-data-package/">
      Lazy Loading a Data Package
    </a>
  </h2>
  <p><time datetime="2025-04-21" class="post-date">2025-04-21</time></p>
  <p><em>Later: see the bottom of this post for a much less frightening solution.</em></p>
<p>R has the notion of a &ldquo;data package&rdquo;,
which looks and feels like a code package
except its primary purpose is to provide a dataset.
One of the key features of such packages is that the data isn&rsquo;t loaded into memory
unless and until it&rsquo;s needed,
which is known as <em>lazy loading</em>.
The code below shows my attempt to do this in Python;
I&rsquo;d <a href="mailto:gvwilson@third-bit.com">be grateful</a> for pointers to prior art
and advice on how to simplify it.</p>
<h2>Desired Outcome</h2>
<p>Importing the package does <em>not</em> load the data.
Instead,
each dataset in the package is loaded into memory the first time it is referenced.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">example</span>                <span class="c1"># data not loaded</span>
<span class="nb">print</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">machines</span><span class="p">)</span>       <span class="c1"># &#39;machines&#39; data loaded here</span>
<span class="nb">print</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">persons</span><span class="p">)</span>        <span class="c1"># &#39;persons&#39; data loaded here</span>
</code></pre></div>
<h2>What the Package Author Writes</h2>
<p>The programmer who wants to provide the data package must:</p>
<ol>
<li>
<p>define a class derived from <code>BaseDatasetLoader</code>
    with a zero-argument method for each dataset;</p>
</li>
<li>
<p>mark those methods as <a href="https://docs.python.org/3/library/functools.html#functools.cached_property">cached properties</a>;</p>
</li>
<li>
<p>call their classes&rsquo; <code>install</code> method with their module&rsquo;s name as an argument;
    and</p>
</li>
<li>
<p>put their data files in a directory called <code>data</code> in the top level of their project.</p>
</li>
</ol>
<p>For example,
the package <code>example</code> that provides persons and machines would be structured like this:</p>
<div class="highlight"><pre><span></span><code>.
├── data
│   ├── machines.csv
│   └── persons.csv
├── example
│   └── __init__.py
└── pyproject.toml
</code></pre></div>
<p>Here&rsquo;s the code in <code>__init__.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">cached_property</span>
<span class="kn">from</span> <span class="nn">datapkg.package</span> <span class="kn">import</span> <span class="n">BaseDatasetLoader</span>

<span class="k">class</span> <span class="nc">_Loader</span><span class="p">(</span><span class="n">BaseDatasetLoader</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Example dataset loader.&quot;&quot;&quot;</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">machines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_csv</span><span class="p">(</span><span class="s2">&quot;machines.csv&quot;</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">persons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_csv</span><span class="p">(</span><span class="s2">&quot;persons.csv&quot;</span><span class="p">)</span>

<span class="c1"># Set up lazy loading - automatically discovers cached properties</span>
<span class="n">_Loader</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</code></pre></div>
<p>I&rsquo;d like to find a way to automate the installation step
so that programmers only have to define the class,
but I haven&rsquo;t figured out a way yet.</p>
<h2>Behind the Curtain</h2>
<p>The <code>datapkg</code> library defines three things,
two of which programmers (hopefully) won&rsquo;t need to know about.
The thing they <em>do</em> need to be aware of is
the base class from which their data loader classes are derived.
For demo purposes,
<code>BaseDatasetLoader</code> assumes (i.e., requires) that data lives in a <code>data</code> directory
beside the package source code directory
and that there is a cached property in the user-defined class derived from <code>BaseDatasetLoader</code>
corresponding to each of the datasets:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">BaseDatasetLoader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for dataset loaders.&quot;&quot;&quot;</span>

    <span class="c1"># Where datasets are located.</span>
    <span class="n">DATA_DIR</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">discover_cached_properties</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Discover all cached_property attributes in this class (i.e., datasets).&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">cached_property</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">install</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">package_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up lazy loading for a data package.&quot;&quot;&quot;</span>

        <span class="n">loader_instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">exported_names</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">discover_cached_properties</span><span class="p">()</span>
        <span class="n">create_lazy_package</span><span class="p">(</span><span class="n">package_name</span><span class="p">,</span> <span class="n">loader_instance</span><span class="p">,</span> <span class="n">exported_names</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load data from a CSV file.&quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="n">BaseDatasetLoader</span><span class="o">.</span><span class="n">DATA_DIR</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">stream</span><span class="p">)]</span>
</code></pre></div>
<p><code>BaseDatasetLoader</code> relies on <code>create_lazy_package</code>,
which looks up a module and replaces it with a lazy-loading module,
copying over the attributes of the original model along the way
and then exporting all the module&rsquo;s names:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_lazy_package</span><span class="p">(</span><span class="n">package_name</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set up lazy loading for a data package.&quot;&quot;&quot;</span>

    <span class="n">original_module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">package_name</span><span class="p">]</span>
    <span class="n">lazy_module</span> <span class="o">=</span> <span class="n">LazyModule</span><span class="p">(</span><span class="n">package_name</span><span class="p">,</span> <span class="n">loader</span><span class="p">)</span>
    <span class="n">lazy_module</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">original_module</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">package_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">lazy_module</span>
    <span class="n">lazy_module</span><span class="o">.</span><span class="n">__all__</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">names</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">names</span>
</code></pre></div>
<p>Finally,
<code>LazyModule</code> intercepts attempts to get the module&rsquo;s attributes
and defers them to the user-defined class derived from <code>BaseDatasetLoader</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">LazyModule</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A module that lazily loads datasets when attributes are accessed.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">loader</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a lazy module.&quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loader</span> <span class="o">=</span> <span class="n">loader</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get an attribute from the loader when not found in the module.&quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_loader</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Module &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39; has no attribute &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
</code></pre></div>
<h2>Building the Package</h2>
<p>Life&rsquo;s not complete these days without a <code>pyproject.toml</code> file:</p>
<div class="highlight"><pre><span></span><code><span class="p">[</span><span class="n">project</span><span class="p">]</span>
<span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;example&quot;</span>
<span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;0.1.0&quot;</span>
<span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;An example data package&quot;</span>
<span class="n">dependencies</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">requires</span><span class="o">-</span><span class="n">python</span> <span class="o">=</span> <span class="s2">&quot;&gt;=3.11&quot;</span>

<span class="p">[</span><span class="n">build</span><span class="o">-</span><span class="n">system</span><span class="p">]</span>
<span class="n">requires</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;hatchling&quot;</span><span class="p">]</span>
<span class="n">build</span><span class="o">-</span><span class="n">backend</span> <span class="o">=</span> <span class="s2">&quot;hatchling.build&quot;</span>

<span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">hatch</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">wheel</span><span class="p">]</span>
<span class="n">packages</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;datapkg&quot;</span><span class="p">]</span>

<span class="p">[</span><span class="n">tool</span><span class="o">.</span><span class="n">hatch</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">force</span><span class="o">-</span><span class="n">include</span><span class="p">]</span>
<span class="s2">&quot;data&quot;</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span>
</code></pre></div>
<p>The trick is that last line,
which forces the build system to include the contents of the <code>data</code> directory in the package.
(And yes, both uses of the word <code>data</code> in that line must be quoted:
it&rsquo;s TOML&rsquo;s way of defining a key-value table.
I miss my <code>package.json</code> files every day…)</p>
<h2>The Simpler Version</h2>
<p>The solution described above is very complex,
and it would be unreasonable to expect most data scientists to debug subtle mistakes.
If we are willing to use:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">datapkg</span> <span class="kn">import</span> <span class="n">datapkg</span>
<span class="nb">print</span><span class="p">(</span><span class="n">datapkg</span><span class="o">.</span><span class="n">machines</span><span class="p">)</span>
</code></pre></div>
<p>then the <code>pyproject.toml</code> file stays as it is and the Python becomes:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">cached_property</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">resources</span>

<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span>

<span class="k">class</span> <span class="nc">_loader</span><span class="p">:</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">machines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_load_csv</span><span class="p">(</span><span class="s2">&quot;machines.csv&quot;</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">persons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_load_csv</span><span class="p">(</span><span class="s2">&quot;persons.csv&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_load_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load data from a CSV file.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;loading </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">stream</span><span class="p">)]</span>

<span class="n">datapkg</span> <span class="o">=</span> <span class="n">_loader</span><span class="p">()</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;datapkg&quot;</span><span class="p">]</span>
</code></pre></div>
<h2>The Even Simpler Version</h2>
<p>Nat Knight suggested an even simpler approach:
use <a href="https://peps.python.org/pep-0562/">a module-level <code>__getattr__</code> function</a>.
I didn&rsquo;t even know these existed,
but they make the code <em>much</em> easier to understand:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">resources</span>

<span class="n">DATA_DIR</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span>
<span class="n">AVAILABLE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;machines&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;machines.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;cached&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
    <span class="s2">&quot;persons&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="s2">&quot;persons.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;cached&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">},</span>
<span class="p">}</span>


<span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AVAILABLE</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> does not have </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">entry</span> <span class="o">=</span> <span class="n">AVAILABLE</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;cached&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;cached&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_load_csv</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;cached&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_load_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="n">DATA_DIR</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">stream</span><span class="p">)]</span>
</code></pre></div>
<p>Thanks, Nat—this is what I&rsquo;m going with.
But also:
damn,
I remember when Python was a small enough language that I actually understood it…</p>
</article>

<article class="post">
  <h2 class="post-title">
    <a href="../2025/04/20/a-testing-question/">
      A Testing Question
    </a>
  </h2>
  <p><time datetime="2025-04-20" class="post-date">2025-04-20</time></p>
  <p>I have been thinking some more about how to teach testing to scientists who are learning how to program,
and I&rsquo;m hoping one of my readers will have suggestions.
The bit of Python below creates a square NxN grid and then fills it using a random orthogonal walk.
Each time the walker visits a cell, the cell&rsquo;s count is incremented;
filling stops when the walker reaches the boundary (i.e., absorbing boundary conditions).</p>
<p>How can I test this?
The easy bits are:</p>
<ol>
<li>
<p>Generate a few hundred grids and make sure the boundary cells are all zero.</p>
</li>
<li>
<p>Compare the sum of the grid values with the number of moves made by the walker (they should be equal).</p>
</li>
<li>
<p>Patch the random choice function to force a series of moves (e.g., always up) and then check the resulting grid.</p>
</li>
</ol>
<p>However, these tests are necessary but not sufficient.
If my choice of moves was biased in some direction,
for example,
none of these tests would reveal that.
If I generate enough grids and look at the distribution of values,
it should approximate a 2D Gaussian,
but I&rsquo;d have to generate a <em>lot</em> of grids to get close,
and it&rsquo;s difficult to specify what &ldquo;close&rdquo; actually means.
Is 20% relative error after 1000 grids good enough?
That test will pass for some random number generation seeds and fail for others;
I could tweak the seed until the test passes,
but that feels as grubby as <a href="https://en.wikipedia.org/wiki/Data_dredging">p-hacking</a>.
If you have suggestions,
please <a href="mailto:gvwilson@third-bit.com">get in touch</a>.</p>
<h2>The Code</h2>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">random</span>


<span class="k">class</span> <span class="nc">Grid</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store a grid of numbers.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct empty grid.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Grid size must be positive not </span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">)]</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get grid element.&quot;&quot;&quot;</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">key</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set grid element.&quot;&quot;&quot;</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert to string.&quot;&quot;&quot;</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
        <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">cmdline_args</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse command-line arguments.&quot;&quot;&quot;</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--seed&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;RNG seed&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--size&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;grid size&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">fill_grid</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fill in a grid.&quot;&quot;&quot;</span>

    <span class="n">moves</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">size_1</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">center</span><span class="p">,</span> <span class="n">center</span>
    <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="n">size_1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">y</span> <span class="o">!=</span> <span class="n">size_1</span><span class="p">):</span>
        <span class="n">grid</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">num</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">moves</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="n">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y</span> <span class="o">+=</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">num</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">cmdline_args</span><span class="p">()</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">Grid</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">fill_grid</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
</code></pre></div>
<h2>The Reveal</h2>
<p>Did you notice the bug?
<code>[0, -1]</code> is repeated in the list of available moves;
the last entry should be <code>[0, 1]</code>.
This was an actual typo in an early draft of this function,
and none of my tests spotted it:</p>
<ol>
<li>
<p>The boundary cells of all grids are still zero.</p>
</li>
<li>
<p>The sum of the grid&rsquo;s values is still the number of moves.</p>
</li>
<li>
<p>Patching the random choice function to force a series of moves
    <em>fixes the underlying bug</em>.</p>
</li>
</ol>
<p>If I had used <code>random.choice(list(range(len(moves))))</code> to choose an index into <code>moves</code>
and then used that move,
the final test might have revealed the problem,
but none of my statistical tests detected it,
and that scares me.</p>
<h2>Another Example</h2>
<p>Another way to fill a grid is called <a href="https://en.wikipedia.org/wiki/Invasion_percolation">invasion percolation</a>.
In pseudo-Python, it works like this—or rather,
this code <em>almost</em> does the right thing:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">invasion_percolation</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
    <span class="c1"># Create grid of random numbers</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="n">Grid</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
            <span class="n">grid</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

    <span class="c1"># Mark the central cell</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="n">grid</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">MARKED</span>

    <span class="c1"># Repeat until the marked region hits the boundary</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">y</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">find_next_cell</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        <span class="n">grid</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">MARKED</span>

<span class="c1"># Find the next cell to fill</span>
<span class="k">def</span> <span class="nf">find_next_cell</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>
    <span class="c1"># Set min_val to Infinity to ensure first cell qualifies</span>
    <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">min_val</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Infinity</span>

    <span class="c1"># Check all cells</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="c1"># Already filled</span>
            <span class="k">if</span> <span class="n">grid</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">==</span> <span class="n">MARKED</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Not adjacent to a marked cell</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">adjacent</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="c1"># We have seen a lower value</span>
            <span class="k">if</span> <span class="n">grid</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_val</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># A new winner</span>
            <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">min_val</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">grid</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>

    <span class="c1"># Report results</span>
    <span class="k">return</span> <span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span>
</code></pre></div>
<p>Did you spot the problem?
I didn&rsquo;t:
I used a variation of this code for more than a year before realizing that
it is biased toward the (0, 0) corner of the grid.
To see why,
imagine that the entire &ldquo;random&rdquo; grid is filled with the value 1.
The first cell that the double loop finds
that&rsquo;s adjacent to the already-filled region
will always be to the lower left of the filled region,
because that will always be the first time the double loop encounters the value 1.
Replacing the 1&rsquo;s with random number in the range 0…depth doesn&rsquo;t fix this flaw;
it just makes it harder to spot.</p>
<p>The solution in this case is to find all the cells
that are adjacent to the already-filled region
<em>and</em> which are tied for lowest value,
then choose one of those at random.
My question is,
what test(s) could I plausibly have written before I realized my mistake
that would have told me my implementation had introduced an unwanted bias?</p>
</article>

<article class="post">
  <h2 class="post-title">
    <a href="../2025/04/18/a-dollar-a-minute/">
      A Dollar a Minute
    </a>
  </h2>
  <p><time datetime="2025-04-18" class="post-date">2025-04-18</time></p>
  <p>Yesterday I wrote about <a href="../2025/04/17/when-the-fire-comes/">making contingency plans for research projects</a>
in case the Trump administration&rsquo;s attack on science reaches you.
Today&rsquo;s topic is an even scarier scenario:
taxes on online services.
As far as I can tell,
there is no legal or technical obstacle to the American government mandating a dollar-a-minute tax
on video conferencing
for people outside the United States.
The machinery needed to charge people is already in place—Zoom,
Google Meet, and Microsoft Teams all offer paid plans—and
a quick check of IP addresses would correctly geolocate 99% of users.
(Yes,
you fool this using a VPN,
but only a handful of individuals would,
and companies aren&rsquo;t going to flout the law that way.)</p>
<p>If you want to hit businesses and middle-class voters in Canada, the EU, and elsewhere,
and raise a few billion dollars at the same time,
why <em>wouldn&rsquo;t</em> you do this?
Why wouldn&rsquo;t you tell Google that it has to start charging foreigners a penny for each email
or ten cents a week for each kilobyte&rsquo;s worth of docs?
Because people would just migrate to other services?
Please:
most of those other services are also US-based,
and if you&rsquo;ve ever done a large service migration,
you&rsquo;ll realize how much pain the word &ldquo;just&rdquo; is painting over.</p>
<p>So here&rsquo;s the scenario that actually keeps me up at night.
It&rsquo;s July 2025.
The US economy is in a nosedive because of tariffs,
so Trump needs money <em>now</em>.
Musk feels exposed:
the savings he promised DOGE would deliver haven&rsquo;t materialized,
so he needs something to fend off the MAGA sharks who now smell blood in the water.
&ldquo;Why should American companies be allowed to help foreigners compete with us <em>for free</em>?&rdquo;
he asks.
Slack, GitHub, Airtable:
everything business has gotten hooked on because it was free suddenly isn&rsquo;t.
Move your data to another provider?
Sure,
here are the federally-mandated rates for exporting your data in bulk.
Go ahead,
sit down for a moment if you need too…</p>
<p>The odds of this actually happening are low.
The odds of someone breaking into my house are also low,
but I still have insurance because that&rsquo;s what sensible grownups do.
We can all now see the river rising;
it will be our own fault if we drown when the flood comes.</p>
</article>

<article class="post">
  <h2 class="post-title">
    <a href="../2025/04/17/when-the-fire-comes/">
      When the Fire Comes
    </a>
  </h2>
  <p><time datetime="2025-04-17" class="post-date">2025-04-17</time></p>
  <p>I grew up in a logging town in British Columbia.
There weren&rsquo;t as many forest fires as there are now,
and they weren&rsquo;t as severe,
but as July turned to August people would make sure they always had a full tank of gas
and a change of clothes packed for the kids.
They&rsquo;d stop on the street to talk to their neighbors about who was going to look in on Mrs. Kerr
to make sure she was OK,
or ask the pharmacy for an extra order of tyheir prescription because,
well,
you never know,
do you?</p>
<p>Forty-five years later
it&rsquo;s time to start making plans like these for our research projects.
The Trump administration has launched an unprecedented assault on science;
thousands of people have been fired,
thousands of others have had their funding cut,
and things are going to get a lot worse before they (hopefully) get better.
What should you do if you&rsquo;re a PI
and you get the email saying that some coked-up tech bro in Washington has cut your funding
because you used the word &ldquo;diverse&rdquo; in a grant application eight years ago?</p>
<p><a href="https://www.burntfen.com/">Richard Littauer</a> and others are putting together a paper
tentatively titled &ldquo;10 quick tips for making your code last beyond your current job&rdquo;,
and I&rsquo;ll share a link to it when it&rsquo;s ready to read,
but its recommendations are for the medium and long term.
What do you do <em>now</em>
if you have until the end of the week to clean up and clear out?</p>
<p>Let&rsquo;s assume your team includes one post-doc, three grad students, and half an RSE,
and that you are collaborating closely with people at two other institutions.
Your data, code, papers, and collective memory are scattered across Google Drive, Slack, GMail, GitHub,
and the departmental server.
Here&rsquo;s what I think you should do:</p>
<ol>
<li>
<p>Remember that <em>the only plan that works is one you&rsquo;ve practiced</em>
    (or as my dad once said, a full tank of gas is no use if you can&rsquo;t find the car keys).
    Once you and your team have made a plan,
    try it out:
    you will immediately discover two things that don&rsquo;t actually work
    and three others you have overlooked.</p>
</li>
<li>
<p><em>Make sure you can communicate with each other.</em>
    My family didn&rsquo;t own a walkie-talkie,
    but a lot of others did.
    Your team will need a way to coordinate without Slack or departmental email;
    a <a href="https://signal.org/">Signal</a> group is one option,
    but a mailing list that includes everyone&rsquo;s work and personal addresses
    is probably a better option.
    (Think attachments, search, etc.)</p>
</li>
<li>
<p><em>Check your licenses.</em>
    I hope you put open licenses on everything so that you&rsquo;re legally allowed to do this;
    if not,
    bookmark this post and come back once you&rsquo;ve done that.</p>
</li>
<li>
<p><em>Copy everything.</em>
    Sure, your code is in GitHub<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>, but what about your papers?
    Your grant applications?
    Your Slack conversations?
    It will take five minutes to make a (partial) list of everything you&rsquo;ve looked at in the past six months;
    do that,
    then figure out how to dump it somewhere that <em>you</em> control
    and that isn&rsquo;t (as) likely to be impacted by random acts of government<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup>.
    (For example, I now rely on a Canadian company called <a href="https://www.sync.com/">Sync</a> to store my data.)
    In an ideal world you would use this as an opportunity to tidy everything up,
    but in an ideal world we wouldn&rsquo;t be having this conversation.</p>
</li>
<li>
<p><em>Write things down as they happen.</em>
    You&rsquo;re going to be making important decisions under pressure,
    with partial information,
    and with other people;
    point-form notes of everything your institution told you to do,
    everything you actually did,
    and everything you&rsquo;ve learned along the way
    are going to be as important to getting through this
    as the logs that paramedics, nurses, and doctors keep in medical emergencies.</p>
</li>
<li>
<p><em>Tell people what&rsquo;s happening.</em>
    Some of your colleagues will already have gone through this
    and will be able to offer advice;
    others who haven&rsquo;t might still be able to help in unexpected ways.
    (&ldquo;Why don&rsquo;t you and your students come and spend a few days with my team?&rdquo;
    wouldn&rsquo;t normally bring tears to my eyes,
    but neither would someone offering to take the kids for ice cream while you&rsquo;re setting up a tent.)</p>
</li>
<li>
<p><em>Help others.</em>
    Grassroots efforts like the <a href="https://www.datarescueproject.org/">Data Rescue Project</a>
    are trying to coordinate work like this;
    if you aren&rsquo;t immediately impacted,
    please help them out.
    And please ask your professional or scientific association to grow a spine
    and do something more than issue a press release.</p>
</li>
</ol>
<p>Later: see also <a href="../2025/04/18/a-dollar-a-minute/">A Dollar a Minute</a> and this partial list of places to run to:</p>
<ul>
<li>Communication<ul>
<li><a href="https://github.com/element-hq">https://github.com/element-hq</a> + <a href="https://matrix.org/">https://matrix.org/</a></li>
<li><a href="https://mattermost.com/solutions/use-cases/self-sovereign-collaboration/">https://mattermost.com/solutions/use-cases/self-sovereign-collaboration/</a></li>
<li><a href="https://www.rocket.chat/ ">https://www.rocket.chat/ </a></li>
<li><a href="https://p2p.mirotalk.com/">https://p2p.mirotalk.com/</a></li>
</ul>
</li>
<li>Wiki<ul>
<li><a href="https://www.bookstackapp.com/">https://www.bookstackapp.com/</a></li>
<li><a href="https://js.wiki/">https://js.wiki/</a></li>
</ul>
</li>
<li>Project management<ul>
<li><a href="https://www.openproject.org/">https://www.openproject.org/</a></li>
<li><a href="https://community.taiga.io/t/taiga-30min-setup/170">https://community.taiga.io/t/taiga-30min-setup/170</a></li>
<li><a href="https://github.com/wekan/wekan">https://github.com/wekan/wekan</a></li>
<li><a href="https://leantime.io/all-about-open-source-project-management/">https://leantime.io/all-about-open-source-project-management/</a></li>
</ul>
</li>
<li>Git<ul>
<li><a href="https://github.com/go-gitea/gitea">https://github.com/go-gitea/gitea</a></li>
<li><a href="https://codeberg.org/forgejo/forgejo/">https://codeberg.org/forgejo/forgejo/</a></li>
<li><a href="https://code.onedev.io/onedev/server">https://code.onedev.io/onedev/server</a></li>
</ul>
</li>
<li>Password manager<ul>
<li><a href="https://github.com/dani-garcia/vaultwarden">https://github.com/dani-garcia/vaultwarden</a></li>
</ul>
</li>
<li>Docs<ul>
<li><a href="https://www.onlyoffice.com/">https://www.onlyoffice.com/</a></li>
<li><a href="https://www.collaboraonline.com/collabora-online/">https://www.collaboraonline.com/collabora-online/</a></li>
<li><a href="https://www.zoho.com/pt-br/workplace/?src=zGlobalRelatedProducts">https://www.zoho.com/pt-br/workplace/?src=zGlobalRelatedProducts</a></li>
<li><a href="https://github.com/nextcloud/server">https://github.com/nextcloud/server</a></li>
<li><a href="https://github.com/owncloud/core">https://github.com/owncloud/core</a></li>
<li><a href="https://hedgedoc.org/">https://hedgedoc.org/</a></li>
</ul>
</li>
</ul>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>There is no legal or technical reason why the US government couldn&rsquo;t turn off access to GitHub (or Zoom, or Google Cloud) for people outside the US, or (more plausibly) put tariffs on their use. I&rsquo;ll be doing another post about that scenario soon.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>I really wish <a href="https://doi.org/10.1371/journal.pone.0010071">BioTorrents</a> had caught on. I bet a lot of other people do now too.&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
</article>

<article class="post">
  <h2 class="post-title">
    <a href="../2025/04/14/no-more-encyclopedias/">
      No More Encyclopedias
    </a>
  </h2>
  <p><time datetime="2025-04-14" class="post-date">2025-04-14</time></p>
  <p>There were three encyclopedias in our house when I was growing up:
one full of bright photographs and illustrations for children,
one with dense, dark text for grownups
(and teenagers who had outgrown the first one and would never admit they missed it),
and a third one in a box in the basement
that I discovered after <a href="../2015/09/22/dad/">my dad died</a>.
There isn&rsquo;t one in this house,
though,
because we have the internet at our fingertips.
<a href="https://www.wikipedia.org/">Wikipedia</a> gives us short summaries when we need them,
and we can turn to various search engines and Q&amp;A sites when we need to go further.</p>
<p>What brought this to mind was reading Janssens and Nieuwdorp&rsquo;s
<a href="https://www.oreilly.com/library/view/python-polars-the/9781098156077/"><em>Python Polars: The Definitive Guide</em></a> over the weekend.
It&rsquo;s well written,
but I don&rsquo;t think I will ever look at it again.
Tables with one-line summaries of operators and aggregation functions
feel redundant when the documentation they&rsquo;re taken from is a click away.
More importantly,
five-line examples showing how to use them are now also redundant thanks to AI tools.
&ldquo;How do I find the three largest annual drops in overdose fatalities in this dataset?&rdquo;
is now a question my computer can answer <em>and explain</em>.
I never copied code directly from <a href="https://claude.ai/">Claude</a> while rewriting <a href="https://gvwilson.github.io/snailz/">snailz</a>,
but over and over I found myself asking a question,
looking at its answer,
nodding my way through its explanation,
and then modifying what it offered to solve my problem.</p>
<p>Since technical books can&rsquo;t address the specific in-the-moment need of the reader,
what role do they have (if any)?
I think the answer is now,
&ldquo;To give readers the mental model they need to write a good prompt and then recognize and adapt a useful<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> answer.&rdquo;
If you don&rsquo;t know what a cache is,
how hashing works,
or that HTML and source code are both represented in memory as trees,
you won&rsquo;t be able to go as far as an LLM might take you.</p>
<p>I didn&rsquo;t have this in mind when I wrote <a href="../sdxpy/"><em>Software Design by Example</em></a>,
but in retrospect I think (or hope) that it meets this need.
Unfortunately,
I also think that LLMs (and <a href="https://stackoverflow.com/">Stack Overflow</a> before it, and search before that)
are making people less patient with long-form technical prose.
I now struggle to read more than a few pages at a time,
even when the subject matter is as engrossing as <a href="https://browser.engineering/">this</a>.
If I ever complete either of <a href="https://gvwilson.github.io/rsdx/">these</a> <a href="https://gvwilson.github.io/webonomicon/">projects</a>,
it will be because I think I have an answer to this riddle that&rsquo;s worth trying out.
If you have one,
I&rsquo;d <a href="mailto:gvwilson@third-bit.com">like to hear it</a>.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>The word &ldquo;useful&rdquo; is important: it sometimes took several tries to get <a href="https://claude.ai/">Claude</a> to solve the problem I actually had, and occasionally it simply couldn&rsquo;t.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>
</article>

<article class="post">
  <h2 class="post-title">
    <a href="../2025/04/12/research-threat-models/">
      Research Threat Models
    </a>
  </h2>
  <p><time datetime="2025-04-12" class="post-date">2025-04-12</time></p>
  <p><a href="https://www.burntfen.com/">Richard Littauer</a> and others are writing some guidance
for researchers who want their code to outlast their present job.
Their motivation is at least partly the unprecedented attacks on science by the Trump administration;
to help,
I&rsquo;ve written the threat models shown below.
I&rsquo;d be very grateful for <a href="mailto:gvwilson@third-bit.com">feedback</a>.</p>
<p>When making plans, it&rsquo;s useful to know what you&rsquo;re planning <em>for</em>.
Being explicit about <strong>threat models</strong> helps you prioritize,
build consensus with colleagues,
and check whether you&rsquo;ve forgotten something important.</p>
<ol>
<li>
<p><strong>Individual threats</strong> are those that affect one or a few members of your team,
    such as a foreign student having their visa revoked without notice
    or needing to take extended medical leave.
    The most common way to prepare for this is to require everyone to document their work thoroughly,
    but that rarely works in practice:</p>
<ol>
<li>The hours spent writing those descriptions are hours <em>not</em> spent doing research,
    so people will always short the former to focus on the latter.</li>
<li>People invariably fail to write down the &ldquo;obvious&rdquo; parts of their work
    that are anything but obvious to the next person.
In practice,
&ldquo;automate what you can and create checklists for what you can&rsquo;t&rdquo; seems to be a better approach,
particularly if you check those checklists by having someone else try to use them
while their authors are still available to take notes and update them.</li>
</ol>
</li>
<li>
<p><strong>Leadership threats</strong> are individual threats that affect the project&rsquo;s leader,
    such as being targeted by elected officials for pointing out the holes in
    the pseudoscientific conspiracy theories they are parroting.
    One way to prepare is to have a designated successor
    (who can also stand in for you if you ever want to take a holiday);
    another is to talk with peers about who will inherit what if your project is shut down.</p>
</li>
<li>
<p><strong>Institutional threats</strong> are those that affect large groups at once,
    such as your university or professional association being blacklisted by government funding agencies.
    These scenarios are equivalents of major storms or forest fires
    in which so many people are affected at the same time that the rest of the community can&rsquo;t absorb them.
    Regional and national governments handle disasters like these
    by having evacuation plans to get victims to safe(r) places,
    and corollary plans for putting beds in high school gyms and flying in food and emergency medical personnel
    to help people when they arrive.
    The equivalents in research are
    to lobby governments to change visa rules for scientific refugees
    and to set aside contingency funding to attract and support them.</p>
</li>
</ol>
<p>One important thing about these threat models is their timescales:</p>
<ul>
<li>
<p>If you start making a checklist for publishing your team&rsquo;s datasets today,
    you will be able to test it out (and see its benefits) in a week or two.</p>
</li>
<li>
<p>If you want universities and regional or national governments to be ready to absorb and support
    an influx of smart, hard-working people
    despite the nationalist jingoism of populist politicians,
    you need to think in terms of many months.</p>
</li>
<li>
<p>Finally,
    if you want professional societies to take something vaguely resembling principled positions,
    look at how long it is taking them to adopt open access
    (which is much, much less contentious)
    and settle in for a years-long fight.</p>
</li>
</ul>
<p>Thinking about this stuff is scary,
in part because most researchers have no personal experience with community organizing or disaster preparedness.
Tessera Strategies are running a <a href="https://tesserastrategies.org/projects/">book club</a> to help people learn about the former;
the application deadline for participation in the first round has passed,
but please keep an eye on <a href="https://tesserastrategies.org/blog/">their blog</a> for future offerings.</p>
<p>As for disaster preparedness,
almost everything you&rsquo;ll find online starts from a place of individualized Hobbesian despair,
i.e.,
assumes that there&rsquo;s nothing you can do to <em>prevent</em> disaster
and that it will be you against the world if and when one strikes.
Professionals know that both assumptions are wrong:
there are <a href="https://www.royalroads.ca/programs/master-arts-disaster-and-emergency-management">entire graduate programs</a> devoted to creating, analyzing, and executing plans for disasters,
and a great deal of research proving that most people work together for the greater good
when the worst finally happens.
Most of what I&rsquo;m familiar with deals with natural disasters and their physical or economic aftermath;
again,
I&rsquo;d <a href="mailto:gvwilson@third-bit.com">be grateful for pointers</a> to prior art that focuses on recovery for research.</p>
</article>

<article class="post">
  <h2 class="post-title">
    <a href="../2025/04/09/congratulations-to-this-terms-students/">
      Congratulations to This Term's Students
    </a>
  </h2>
  <p><time datetime="2025-04-09" class="post-date">2025-04-09</time></p>
  <p>I had the pleasure of working with two teams of undergraduates at the University of Toronto this semester.
They have now wrapped up their projects
and I think what they did was very cool.</p>
<p><a href="https://www.linkedin.com/in/amy-kim8/">Amy Kim</a> and <a href="https://www.linkedin.com/in/daelenia-susanto-69067b255/">Daelenia Susanto</a> built a tool called <a href="https://github.com/gvwilson/browsercast">Browsercast</a>
that plays an HTML slideshow in sync with a voiceover.
They spent a lot of time wrestling with JavaScript APIs and browser idiosyncracies,
and a lot more thinking about who would use it and how;
their <a href="https://www.youtube.com/watch?v=fvqkXGvw9bU">demo video</a> shows what it can do,
and we&rsquo;re grateful to <a href="https://www.linkedin.com/in/tony-burbage/">Tony Burbage</a> for guidance.</p>
<p><a href="https://www.linkedin.com/in/david-barsamyan-213a75265/">David Barsamyan</a>,
<a href="https://www.linkedin.com/in/lorena-buciu/">Lorena Buciu</a>,
<a href="https://www.linkedin.com/in/eunchae-seong/">Rachel Seong</a>,
<a href="https://www.linkedin.com/in/yifan-wang-01/">Evence Wang</a>,
and <a href="https://www.linkedin.com/in/cassandra-tin-kwon-yuen-4a0011267/">Cassandra Tin Kwon Yuen</a>
built <a href="https://github.com/gvwilson/mossball">a set of plugins</a> for <a href="https://marimo.io/">Marimo</a>
that implement common types of classroom exercises
like find-the-word puzzles and multiple choice questions.
<a href="https://www.youtube.com/watch?v=oeYEotXOvgA">Their video</a> shows each one in operation and explains their architecture;
we hope to have them available as a Python package just as soon as exams are over.</p>
<p>This marks the first time I&rsquo;ve supervised senior computer science projects in 15 years.
I think I had at least as much fun as they did,
and very proud of what they accomplished.
If you&rsquo;re looking for talented junior programmers,
please reach out,
and if you&rsquo;d like to contribute to the projects,
they&rsquo;d be very happy to talk to you.</p>
</article>

<article class="post">
  <h2 class="post-title">
    <a href="../2025/03/29/tooling-for-snailz/">
      Tooling for Snailz
    </a>
  </h2>
  <p><time datetime="2025-03-29" class="post-date">2025-03-29</time></p>
  <p>I built <a href="https://github.com/gvwilson/snailz">a synthetic data generator</a> last year to use in a &ldquo;software design for data scientists&rdquo; tutorial
that I never finished writing.
Over the last week I rewrote it as a way of exploring some new tools:</p>
<ul>
<li>
<p>The command-line interface to <a href="https://docs.anthropic.com/en/docs/agents-and-tools/claude-code/overview">Claude</a>.
    I&rsquo;m disgusted by the amorality of the AI industry,
    but am now convinced that the coding tools are here to stay:
    writing tests and refactoring code with Claude&rsquo;s help was <em>much</em> faster than doing it by hand.</p>
</li>
<li>
<p><a href="https://docs.astral.sh/uv/"><code>uv</code></a> for managing the packages and virtual environment and for running commands.
    It&rsquo;s the first time I&rsquo;ve used it as itself rather than running <code>uv pip whatever</code>;
    never going back.</p>
</li>
<li>
<p><a href="https://docs.astral.sh/ruff/"><code>ruff</code></a> and <a href="https://pypi.org/project/pyright/"><code>pyright</code></a> for checking the code.
    <code>ruff</code> is a joy,
    but checking type annotations with <code>pyright</code> cost me a couple of hours.
    It&rsquo;s not the tool&rsquo;s fault, though:
    figuring out how to annotate the last 5% of the code led to me writing my first <a href="https://peps.python.org/pep-0544/">protocol</a>
    and then throwing up my hands and replacing it with <code>Any</code>.</p>
</li>
<li>
<p><a href="https://docs.pydantic.dev/"><code>pydantic</code></a> for storing and validating records,
    including the data that <code>snailz</code> generates and the parameters used in generation.
    I started with <a href="https://docs.python.org/3/library/dataclasses.html"><code>dataclasses</code></a>,
    but switched as soon as I found myself<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> adding methods that <code>pydantic</code> already had.</p>
</li>
<li>
<p><a href="https://pydoit.org/"><code>doit</code></a> to run commands instead of <a href="https://www.gnu.org/software/make/">Make</a>.
    I&rsquo;m more comfortable with the latter,
    but I recognize that writing Makefiles is a dying art.</p>
</li>
<li>
<p><a href="https://www.mkdocs.org/"><code>mkdocs</code></a> for documentation instead of <a href="https://www.sphinx-doc.org/">Sphinx</a> or <a href="https://pdoc.dev/"><code>pdoc</code></a><sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup>.
    I find <code>mkdocs</code> easier to work with than Sphinx,
    and <code>pdoc</code> doesn&rsquo;t support &ldquo;extra&rdquo; Markdown pages as well as <code>mkdocs</code>.
    (If the folks at <a href="https://astral.sh/">Astral</a> are looking for new product ideas,
    a better documentation generator would have at least one paying customer the day it launched…)</p>
</li>
<li>
<p><a href="https://docs.pytest.org/"><code>pytest</code></a>, <a href="https://pypi.org/project/pyfakefs/"><code>pyfakefs</code></a>, and <a href="https://faker.readthedocs.io/"><code>faker</code></a> for testing
    and <a href="https://click.palletsprojects.com/"><code>click</code></a> for building the command-line interface instead of <a href="https://docs.python.org/3/library/argparse.html"><code>argparse</code></a>.</p>
</li>
</ul>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Well, myself and Claude…&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Please don&rsquo;t ever use <code>pdoc3</code>: someone who picks a swastika as a project logo and then argues that it&rsquo;s just a cultural symbol doesn&rsquo;t deserve your downloads.&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
</ol>
</div>
</article>


    </main>
    <footer>
  &copy; 2004-2025 <a href="../about/">Greg Wilson</a>
  <a href="mailto:gvwilson@third-bit.com"><img src="../assets/icons/envelope.svg" alt="email" class="footer-icon"></a>
  <a href="https://www.linkedin.com/in/greg-wilson-a26510b6/"><img src="../assets/icons/linkedin.svg" alt="LinkedIn" class="footer-icon"></a>
  <a href="https://mastodon.social/@gvwilson"><img src="../assets/icons/mastodon.svg" alt="Mastodon" class="footer-icon"></a>
  <a href="https://github.com/gvwilson"><img src="../assets/icons/github.svg" alt="GitHub" class="footer-icon"></a>
  <a href="https://www.youtube.com/channel/UCbDQ7FIeYB3FHRADAjUjfrg"><img src="../assets/icons/youtube.svg" alt="YouTube" class="footer-icon"></a>
  <a href="../bib/"><img src="../assets/icons/orcid.svg" alt="ORCID" class="footer-icon"></a>
  <a href="../atom.xml"><img src="../assets/icons/rss.svg" alt="RSS feed" class="footer-icon"></a>
  <a href="../license/"><img src="../assets/icons/cc-by.svg" alt="license" class="footer-icon"></a>
  <a href="../colophon/"><img src="../assets/icons/pencil.svg" alt="colophon" class="footer-icon"></a>
  <a href="../cv/"><img src="../assets/icons/file.svg" alt="CV" class="footer-icon"></a>

  <p class="disclaimer">
    By reading this page you agree,
    on behalf of your employer,
    to release me from all obligations and waivers arising from any and all non-negotiated agreements,
    licenses, terms-of-service, shrinkwrap, clickwrap, browsewrap, confidentiality, non-disclosure,
    non-compete and acceptable use policies that I have entered into with your employer,
    its partners, licensors, agents, and assigns,
    in perpetuity,
    and without prejudice to my ongoing rights and privileges.
  </p>
</footer>
  </body>
</html>
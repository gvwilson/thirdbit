<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<link rel="me" href="https://mastodon.social/@gvwilson">
<link rel="shortcut icon" type="image/x-icon" href="../favicon.ico">
<link rel="alternate" type="application/atom+xml" title="The Third Bit" href="../atom.xml">
<!-- <script defer data-domain="third-bit.com" src="https://plausible.io/js/plausible.js"></script> -->
    <script src="https://kit.fontawesome.com/4eee35f757.js"></script>
    <link rel="stylesheet" href="../assets/thirdbit.css">
    <link rel="stylesheet" href="../assets/page.css">
    
<title>The Third Bit Blog</title>

    
  </head>
  <body>
    <nav>
  <div class="row underline">
    <div class="col-2 left">
      <a class="navlink" href="../">Home</a>
    </div>
    <div class="col-10 right">
      <a class="navlink" href="../about/">about</a>
      <a class="navlink" href="../blog/">blog</a>
      <a class="navlink" href="../selected/">selected</a>
      <a class="navlink" href="../talks/">talks</a>
      <a class="navlink" href="../bib/">bibliography</a>
      <a class="navlink" href="../fiction/">fiction</a>
    </div>
  </div>
</nav>
    <main>
      
<h1>Blog</h1>


<table class="centered">
  <tbody>
    <tr>
      <td><a href="../archive/2020">2020</a></td>
      <td><a href="../archive/2021">2021</a></td>
      <td><a href="../archive/2022">2022</a></td>
      <td><a href="../archive/2023">2023</a></td>
      <td><a href="../archive/2024">2024</a></td>
      <td><a href="../archive/2025">2025</a></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
    </tr>
    <tr>
      <td><a href="../archive/2010">2010</a></td>
      <td><a href="../archive/2011">2011</a></td>
      <td><a href="../archive/2012">2012</a></td>
      <td><a href="../archive/2013">2013</a></td>
      <td><a href="../archive/2014">2014</a></td>
      <td><a href="../archive/2015">2015</a></td>
      <td><a href="../archive/2016">2016</a></td>
      <td><a href="../archive/2017">2017</a></td>
      <td><a href="../archive/2018">2018</a></td>
      <td><a href="../archive/2019">2019</a></td>
    </tr>
    <tr>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td><a href="../archive/2004">2004</a></td>
      <td><a href="../archive/2005">2005</a></td>
      <td><a href="../archive/2006">2006</a></td>
      <td><a href="../archive/2007">2007</a></td>
      <td><a href="../archive/2008">2008</a></td>
      <td><a href="../archive/2009">2009</a></td>
    </tr>
  </tbody>
</table>


<article class="post">
  <h2 class="post-title">
    <a href="../2025/11/30/observability/">
      Observability
    </a>
  </h2>
  <p><time datetime="2025-11-30" class="post-date">2025-11-30</time></p>
  <p>So far we&rsquo;ve been collecting whatever data we want
whenever something significant happens in the simulation,
but we can&rsquo;t do that in the real world.
Since we need to tidy up the simulation a bit,
let&rsquo;s  data collection a little more realistic as well.</p>
<h2>The Overall Simulation</h2>
<p>As before,
we&rsquo;re going to store the major pieces of the simulation in a <code>Simulation</code> object
so that we don&rsquo;t have to pass lots of bits and pieces to every function and method.
This class holds:</p>
<ul>
<li>the simulation parameters;</li>
<li>the <a href="https://simpy.readthedocs.io/">SimPy</a> <code>Environment</code>;</li>
<li>the developers (represented as <code>Developer</code> objects);</li>
<li>the queue of tasks waiting for a developer;</li>
<li>the testers (represeented as <code>Tester</code> objects) and the queue of tasks waiting for them;
    and</li>
<li>an instance of a new <code>Log</code> class that will collect data about the state of the simulation.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Simulation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Overall simulation.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Environment</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">developers</span> <span class="o">=</span> <span class="p">[</span><span class="n">Developer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;num_dev&quot;</span><span class="p">])]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev_queue</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">PriorityStore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">testers</span> <span class="o">=</span> <span class="p">[</span><span class="n">Tester</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;num_tester&quot;</span><span class="p">])]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_queue</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">PriorityStore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">Log</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div>
<p>As before,
we provide some convenience methods to get at useful properties
of the underlying <code>Environment</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Simulation</span><span class="p">:</span>
    <span class="err">…</span><span class="n">previous</span> <span class="n">code</span><span class="err">…</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">now</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shortcut for current time.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">now</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shortcut for running a process.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Shortcut for delaying a fixed time.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
</code></pre></div>
<p>and put all the randomization here as well:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Simulation</span><span class="p">:</span>
    <span class="err">…</span><span class="n">previous</span> <span class="n">code</span><span class="err">…</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rand_task_arrival</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Task arrival time.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">expovariate</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;task_arrival&quot;</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rand_test_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Testing time.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">lognormvariate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;median_test_time&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rand_rework</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Does this task need to be reworked?&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;prob_rework&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rand_dev_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Development time.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">lognormvariate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;median_dev_time&quot;</span><span class="p">]</span>
</code></pre></div>
<p>Finally,
we provide one method to generate new tasks
and one to launch all the active processes in the simulation:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Simulation</span><span class="p">:</span>
    <span class="err">…</span><span class="n">previous</span> <span class="n">code</span><span class="err">…</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate tasks at random intervals starting at t=0.&quot;&quot;&quot;</span>

        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">Task</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rand_task_arrival</span><span class="p">())</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">dev_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">Task</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the whole simulation.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">generate</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">work</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">workers</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">developers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">testers</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">workers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">work</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">until</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;sim_time&quot;</span><span class="p">])</span>
</code></pre></div>
<p>Two things to note in the code above:</p>
<ol>
<li>
<p>We always generate the first task at time 0.
    We don&rsquo;t have to do this,
    but it always felt weird looking at the statistics
    to have a small delay at the start before anything happened.</p>
</li>
<li>
<p>The logger is an active process,
    just like the developers, testers, and task generator.
    We&rsquo;ll look at it in more detail in a bit.</p>
</li>
</ol>
<h2>Developers</h2>
<p>Earlier posts in this series showed
how we give each developer (and tester) a unique ID
and how we automatically create lists of them.
We won&rsquo;t repeat that code here,
since the most interesting thing about a developer is the work she does:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Developer</span><span class="p">(</span><span class="n">Worker</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">work</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">dev_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

            <span class="k">with</span> <span class="n">WorkLog</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="p">(</span><span class="n">Worker</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">BUSY</span><span class="p">,</span> <span class="n">Worker</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">IDLE</span><span class="p">),</span>
                <span class="n">task</span><span class="p">,</span>
                <span class="p">(</span><span class="n">Task</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">DEV</span><span class="p">,</span> <span class="n">Task</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">WAIT_TEST</span><span class="p">),</span>
                <span class="s2">&quot;n_dev&quot;</span><span class="p">,</span>
                <span class="s2">&quot;t_dev&quot;</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">required_dev</span><span class="p">)</span>

            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">test_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</code></pre></div>
<p>If we ignore <code>WorkLog</code> for a moment,
we can see that <code>Developer.work</code> is:</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">work</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">dev_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">required_dev</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">test_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</code></pre></div>
<p>i.e.,
wait to a get a take from the development queue,
pause for a while to do the work,
and then put the task in the testing queue.</p>
<h2>Recording Work</h2>
<p>So what is <code>WorkLog</code>?
It&rsquo;s a <em>context manager</em>,
i.e.,
a class that does something at the start of a block
and then automatically does some cleanup at the end of the block.
In our case,
what it does at the start is record the start time of the work
and change the state flags of the worker and task:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">WorkLog</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Context manager to keep track of elapsed time.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="n">worker_states</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">task_states</span><span class="p">,</span> <span class="n">key_num</span><span class="p">,</span> <span class="n">key_time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span> <span class="o">=</span> <span class="n">worker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_states</span> <span class="o">=</span> <span class="n">worker_states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_states</span> <span class="o">=</span> <span class="n">task_states</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_num</span> <span class="o">=</span> <span class="n">key_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key_time</span> <span class="o">=</span> <span class="n">key_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start the clock.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>
<p>At the end of the block—i.e.,
after the simulated work is done—the context manager
records how long the worker spent and how many tasks it has processed,
then changes the states of the task and worker again:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">WorkLog</span><span class="p">:</span>
    <span class="err">…</span><span class="n">previous</span> <span class="n">code</span><span class="err">…</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop the clock.&quot;&quot;&quot;</span>

        <span class="n">elapsed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_states</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="p">[</span><span class="s2">&quot;busy&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">elapsed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker</span><span class="p">[</span><span class="s2">&quot;n_task&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_states</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_states</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key_num</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key_time</span><span class="p">]</span> <span class="o">+=</span> <span class="n">elapsed</span>

        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
<p>Using <code>WorkLog</code> adds eight lines to what was a three-line simulation loop,
but we&rsquo;ve learned the hard way as this code evolves
that keeping the record keeping for developers and testers in sync is error-prone.
Putting that code in a class,
and ensuring that the end-of-work record keeping is always done,
speeds up development.</p>
<h2>Testers</h2>
<p>The <code>Tester</code> class is similar to the <code>Developer</code> class:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Tester</span><span class="p">(</span><span class="n">Worker</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">work</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">test_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

            <span class="k">with</span> <span class="n">WorkLog</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="p">(</span><span class="n">Worker</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">BUSY</span><span class="p">,</span> <span class="n">Worker</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">IDLE</span><span class="p">),</span>
                <span class="n">task</span><span class="p">,</span>
                <span class="p">(</span><span class="n">Task</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">TEST</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                <span class="s2">&quot;n_test&quot;</span><span class="p">,</span>
                <span class="s2">&quot;t_test&quot;</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">required_test</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">rand_rework</span><span class="p">():</span>
                <span class="n">task</span><span class="o">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">PRI_HIGH</span>
                <span class="n">task</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">WAIT_DEV</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">dev_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">COMPLETE</span>
</code></pre></div>
<p>This class gets work from the ready-to-test queue,
and then decides once the work is done
whether the task needs to be re-developed or not.
If it does,
it goes back into the ready-to-develop queue with high priority
to ensure that tasks needing rework are done before tasks that haven&rsquo;t been touched yet.
Without this rule,
far fewer tasks are completed,
and far more tasks are half-done at the simulation&rsquo;s end.</p>
<h2>Logging</h2>
<p>It&rsquo;s finally time to look at the <code>Log</code> class that records data.
Its constructor makes space to record snapshots of
the states of all the tasks in the system,
the lengths of all the queues,
and what the developers and testers are doing:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Log</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Keep a log of interesting things.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span> <span class="o">=</span> <span class="n">sim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">snapshot</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;tasks&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;queues&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;workers&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
</code></pre></div>
<p>The generator that does the active work is simplicity itself:
record the state of the simulation,
then wait a fixed interval
(which we will initially set to one clock tick):</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">work</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_record</span><span class="p">()</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;log_interval&quot;</span><span class="p">])</span>
</code></pre></div>
<p>The code to record the simulation state is a bit messy,
because it depends on the implementations of various classes,
but in brief it creates records for:</p>
<ol>
<li>
<p>the state of every task in the system;</p>
</li>
<li>
<p>the lengths of the two queues; and</p>
</li>
<li>
<p>the state of each developer and tester.</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">_record</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Record a log entry at a particular moment.&quot;&quot;&quot;</span>

        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">Labeled</span><span class="o">.</span><span class="n">_all</span><span class="p">[</span><span class="n">Task</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;tasks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">state</span><span class="p">)}</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">queue</span> <span class="ow">in</span> <span class="p">((</span><span class="s2">&quot;dev&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">dev_queue</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">test_queue</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;queues&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">items</span><span class="p">)}</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">kind</span><span class="p">,</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="p">((</span><span class="s2">&quot;dev&quot;</span><span class="p">,</span> <span class="n">Developer</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="n">Tester</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">Labeled</span><span class="o">.</span><span class="n">_all</span><span class="p">[</span><span class="bp">cls</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">snapshot</span><span class="p">[</span><span class="s2">&quot;workers&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span> <span class="s2">&quot;kind&quot;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">w</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">state</span><span class="p">)}</span>
                <span class="p">)</span>
</code></pre></div>
<h2>What Have We Learned?</h2>
<p>The first thing we learned from this refactoring is that
roughly half the code is devoted to collecting data.
This won&rsquo;t come as a surprise to anyone who has ever built a monitoring tool:
figuring out what&rsquo;s going on is often as hard as making things happen,
and sometimes harder.</p>
<p>The second thing we&rsquo;ve learned is that our simulation can still surprise us.
The graph on the left shows the lengths of the develpment and testing queues over time,
while the one on the right shows how many tasks are in each of the possible states:</p>
<div class="row">
  <div class="col-6 center">
    <img src="../files/2025/11/30/sample_queues.svg" alt="queue lengths" width="90%">
    <br>
    Queue Lengths
  </div>
  <div class="col-6 center">
    <img src="../files/2025/11/30/sample_tasks.svg" alt="task states" width="90%">
    <br>
    Task States
  </div>
</div>

<p>The steady growth in the number of tasks waiting for a developer makes sense:
we&rsquo;re generating new ones faster than they can be completed.
But why does the length of the testing queue rise and then fall?
Is it just random variation?
Or is it revealing some unexpected property of our development process?
That question will have to wait for tomorrow.</p>
</article>

<article class="post">
  <h2 class="post-title">
    <a href="../2025/11/29/what-changed-revisited/">
      What Changed Revisited
    </a>
  </h2>
  <p><time datetime="2025-11-29" class="post-date">2025-11-29</time></p>
  <p>Let&rsquo;s take another look at the log-scaled version of [yesterday&rsquo;s chart][what-changed]:</p>
<div class="center">
  <img src="../files/2025/11/28/times-log.svg" alt="log-scale time plot" width="90%">
</div>

<p>There hasn&rsquo;t been any turnover in the team or a major rewrite of the product,
so why has the number of bugs that take more than 100 hours to close
been creeping up slowly but steadily?
Luckily,
we have access to the source code of the simulation,
so we can get a definitive answer.
(Yes, this is cheating…)</p>
<p>The first difference is that
the development and testing queues are priority queues:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Simulation</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Environment</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev_queue</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">PriorityStore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_queue</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">PriorityStore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
</code></pre></div>
<p>We have also added constants to define two priority levels—remember,
a lower number is a higher priority:</p>
<div class="highlight"><pre><span></span><code><span class="n">PRI_REWORK</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">PRI_NEW</span> <span class="o">=</span> <span class="mi">1</span>
</code></pre></div>
<p>We have also made a small but crucial change to
the class that simulates a tester:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Tester</span><span class="p">(</span><span class="n">Labeled</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">work</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">test_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">priority</span><span class="p">,</span> <span class="n">task</span> <span class="o">=</span> <span class="n">item</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="s2">&quot;test_time&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">task_rework</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">dev_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">simpy</span><span class="o">.</span><span class="n">PriorityItem</span><span class="p">(</span><span class="n">PRI_REWORK</span><span class="p">,</span> <span class="n">task</span><span class="p">))</span>
</code></pre></div>
<p>The last two lines of <code>work</code> say,
&ldquo;If testing reveals that this task needs to be re-done,
put it back in the development queue with high priority.&rdquo;
If you&rsquo;ll excuse a bit more ASCII art,
this change means that our simulation is now:</p>
<div class="highlight"><pre><span></span><code>+----------------+    +-----------+    +------------+    +------------+    +---------+
| task generator | -&gt; | dev queue | -&gt; | developers | -&gt; | test queue | -&gt; | testers |
+----------------+    +-----------+    +------------+    +------------+    +---------+
                            ^                                                   |
                            |                                                   |
                            +---------------------------------------------------+
</code></pre></div>
<p>From quarter to quarter,
the probability of QA revealing that a task needs to be re-done
has gone from 0% to 50%.
As noted yesterday,
we see a corresponding decrease in the total number of tasks completed each quarter:</p>
<table>
<thead>
<tr>
<th style="text-align: right;">quarter</th>
<th style="text-align: right;">number</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2222</td>
</tr>
<tr>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1912</td>
</tr>
<tr>
<td style="text-align: right;">3</td>
<td style="text-align: right;">1525</td>
</tr>
<tr>
<td style="text-align: right;">4</td>
<td style="text-align: right;">993</td>
</tr>
</tbody>
</table>
<p>What these numbers don&rsquo;t tell us is <em>why</em>.
Are our testers getting better at finding bugs?
Are our developers making more mistakes because they&rsquo;re burning out?
Or has there been some sort of change in how work is being tracked?
(0% rework in the first quarter seems suspicious…)
Once again,
data can draw our attention to things that need to be explained,
but we still have to find the explanation.</p>
</article>

<article class="post">
  <h2 class="post-title">
    <a href="../2025/11/28/what-changed/">
      What Changed?
    </a>
  </h2>
  <p><time datetime="2025-11-28" class="post-date">2025-11-28</time></p>
  <p>Your company brought in a new CEO,
and she believes that you can&rsquo;t manage what you don&rsquo;t measure.
One of the first things she does is look at historical data
on how long developers have spent fixing bugs over the past year.
When she plots the data quarter by quarter,
she gets the following:</p>
<div class="center">
  <img src="../files/2025/11/28/times-linear.svg" alt="linear-scale time plot" width="90%">
</div>

<p>The change over time is easier to see when we scale the Y axis logarithmically:</p>
<div class="center">
  <img src="../files/2025/11/28/times-log.svg" alt="log-scale time plot" width="90%">
</div>

<p>The number of bugs taking more than 100 hours to close is clearly going up over time,
but why?
And why has the number of bugs closed per quarter been dropping:</p>
<table>
<thead>
<tr>
<th style="text-align: right;">quarter</th>
<th style="text-align: right;">number</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2222</td>
</tr>
<tr>
<td style="text-align: right;">2</td>
<td style="text-align: right;">1912</td>
</tr>
<tr>
<td style="text-align: right;">3</td>
<td style="text-align: right;">1525</td>
</tr>
<tr>
<td style="text-align: right;">4</td>
<td style="text-align: right;">993</td>
</tr>
</tbody>
</table>
<p>There hasn&rsquo;t been any turnover in the team,
or a major rewrite of the product.
What has changed?
I&rsquo;ll post the reason tomorrow;
for today,
see what theories you can come up with
and what data you would need to confirm or refute them.</p>
</article>

<article class="post">
  <h2 class="post-title">
    <a href="../2025/11/27/not-created-equal/">
      Not Created Equal
    </a>
  </h2>
  <p><time datetime="2025-11-27" class="post-date">2025-11-27</time></p>
  <p><a href="../2025/11/26/malice-and-randomness/">Yesterday&rsquo;s post</a> pointed out that
it can be hard to distinguish cause and effect from random variation.
One way to tell them apart is to vary the simulation parameters systematically
to see when various phenomena appear and disappear.
For example,
suppose we modify the simulation to account for the fact that
not all tasks are created equal.
Some bugs and features have higher priority than others,
and our team will generally work on more important items before they work on less important ones.</p>
<p>Alongside the <code>Store</code> we have been using to model our work queue,
<a href="https://simpy.readthedocs.io/">SimPy</a> offers a <code>PriorityStore</code> that keeps items sorted in priority order.
(The lower the item&rsquo;s score, the higher its priority.)
Let&rsquo;s modify the <code>Simulation</code> class to make the development and testing queues priority stores:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Simulation</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Environment</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev_queue</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">PriorityStore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_queue</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">PriorityStore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue_log</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div>
<p>and then add a new parameter <code>task_priorities</code>
whose value is a list of probabilities:</p>
<div class="highlight"><pre><span></span><code><span class="n">PARAMS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="err">…</span><span class="n">previous</span> <span class="n">code</span><span class="err">…</span>
    <span class="s2">&quot;task_priorities&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">],</span>
<span class="p">}</span>
</code></pre></div>
<p>The list shown above tells us that there&rsquo;s a 10% chance of a new task having priority 0,
a 30% chance of it having priority 1,
and a 60% chance of it having priority 2.
When we create a task,
we assign it a priority at random with these weights:</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">task_priority</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;task_priorities&quot;</span><span class="p">]))),</span>
            <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;task_priorities&quot;</span><span class="p">],</span>
            <span class="n">k</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>
<p>(We need the <code>[0]</code> at the end because <code>random.choices</code> always returns a list of choices,
even when we tell it we only want one value.)
Finally,
when we&rsquo;re adding a new task to the development queue
we wrap it in a <code>PriorityItem</code>
to pair the task with its priority:</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">sim</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">task_arrival</span><span class="p">())</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">sim</span><span class="o">.</span><span class="n">dev_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">simpy</span><span class="o">.</span><span class="n">PriorityItem</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="s2">&quot;priority&quot;</span><span class="p">],</span> <span class="n">task</span><span class="p">))</span>
</code></pre></div>
<div class="row">
  <div class="col-6 center">
    <img src="../files/2025/11/27/queues-136.svg" alt="10/30/60" width="90%">
    <br>
    Queue lengths: 10/30/60
  </div>
  <div class="col-6 center">
    <img src="../files/2025/11/27/queues-334.svg" alt="30/30/40" width="90%">
    <br>
    Queue lengths: 30/30/40
  </div>
</div>
<div class="row">
  <div class="col-6 center">
    <img src="../files/2025/11/27/queues-433.svg" alt="40/30/30" width="90%">
    <br>
    Queue lengths: 40/30/30
  </div>
  <div class="col-6 center">
    <img src="../files/2025/11/27/queues-442.svg" alt="40/40/20" width="90%">
    <br>
    Queue lengths: 40/40/20
  </div>
</div>

<p>The top (green) line in these four charts is the number of priority-2 tasks
waiting in the development queue.
It grows steadily because developers are basically busy at all times with higher-priority tasks;
it&rsquo;s only when 80% or more of tasks are higher priority that
we start to see a backlog of priority-1 tasks build up.
I don&rsquo;t know if I expected this or not,
but I certainly <em>didn&rsquo;t</em> expect that the testers would always be able to keep up
with tasks of all priorities.</p>
<p>These curves look familiar to me.
In my previous role at <a href="https://plot.ly/">Plotly</a>,
I was responsible for managing the backlog of bug reports and feature requests
for the open source libraries.
When I started in April 2025,
nobody had gone through them for several years;
over that summer,
I cleared out enough stale and duplicated items
to get the three main repositories from about 7000 issues down to about 1700.
I then watched as the number grew slowly but steadily over the next twelve months.
Everyone on the team was working hard,
but if your library, tool, or application is useful,
there will <em>always</em> be more work to do than people to do it.
The only &ldquo;solution&rdquo; is to be ruthless about labeling
so that you don&rsquo;t get demoralized.</p>
</article>

<article class="post">
  <h2 class="post-title">
    <a href="../2025/11/26/malice-and-randomness/">
      Malice and Randomness
    </a>
  </h2>
  <p><time datetime="2025-11-26" class="post-date">2025-11-26</time></p>
  <p>The main point of <a href="../2025/11/25/you-cant-tell/">yesterday&rsquo;s post</a> was that
any simple view of a complex system can be interpreted in several ways.
Is work piling up?
That&rsquo;s good to know
(quick, do you have a plot of how much your backlog has grown over the last year?),
but figuring out <em>why</em> requires usually close investigation.</p>
<p>Here&rsquo;s another example.
Suppose you&rsquo;re keeping track of the development and testing backlog over time,
and you get a graph like this:</p>
<div class="center">
  <img src="../files/2025/11/26/queue-1k.svg" alt="queue lengths over time">
</div>

<p>Your first question is going to be,
&ldquo;What changed around t=3000 that made the development backlog get five times larger?&rdquo;
Your second will be,
&ldquo;And what changed around t=5000 to bring it back down again?&rdquo;
You might even ask what happened between t=1000 and t=3000 to cause a smaller spike;
was that an early warning that you missed?
Or did the same thing go wrong at t=1000 and t=3000,
but for some reason it was caught and fixed earlier the first time?</p>
<p><a href="https://en.wikipedia.org/wiki/Hanlon%27s_razor">Hanlon&rsquo;s Razor</a> states,
&ldquo;Never attribute to malice that which is adequately explained by stupidity.&rdquo;
The statistical equivalent is,
&ldquo;Never attribute to human action that which is adequately explained by random variation.&rdquo;
The truth is that <em>nothing remarkable happened</em> to cause the two humps shown in the plot above.
They are just random variations in a random system.
We can see more of this if we run the simulation for 10,000 timesteps instead of 1000:</p>
<div class="center">
  <img src="../files/2025/11/26/queue-10k.svg" alt="queue lengths over time">
</div>

<p>It <em>looks</em> like the development backlog is slowly increasing,
and that the testing backlog is following that increase with a bit of a lag,
but how confident are you of this?
If we run the simulation even longer,
would you be surprised if the backlogs decreased again?</p>
<p>The data we collect and the dashboards we build
can help us identify things that might need to be explained,
but we have to interpret them in order to create those explanations.
As Elisabeth Hendrickson and Joel Tosi point out in their upcoming book
<em><a href="https://signalsandlevers.com/book/">Signals &amp; Levers</a></em>,
something as simple as a <a href="https://en.wikipedia.org/wiki/Shewhart_individuals_control_chart">Shewhart chart</a>
can help you distinguish normal variation from things you might need to worry about.</p>
</article>

<article class="post">
  <h2 class="post-title">
    <a href="../2025/11/25/you-cant-tell/">
      You Can't Tell
    </a>
  </h2>
  <p><time datetime="2025-11-25" class="post-date">2025-11-25</time></p>
  <p><a href="../2025/11/24/analyzing-simulation/">Yesterday&rsquo;s post</a> checked our prediction
about where work would pile up.
As a reminder,
here are plots showing the lengths of the development and testing queues
and how much time developers and testers spend working and waiting:</p>
<div class="row">
  <div class="col-6 center">
    <img src="../files/2025/11/24/queues.svg" alt="time-series chart of queue lengths" width="90%">
  </div>
  <div class="col-6 center">
    <img src="../files/2025/11/24/times.svg" alt="time-series chart of developer and tester time" width="90%">
  </div>
</div>

<p>Let&rsquo;s change a single parameter and re-run the simulation.
We see a few jobs waiting in the testing queue more often,
and more importantly,
that testers are spending most of their time working instead of waiting:</p>
<div class="row">
  <div class="col-6 center">
    <img src="../files/2025/11/25/two-testers-queues.svg" alt="time-series chart of queue lengths" width="90%">
  </div>
  <div class="col-6 center">
    <img src="../files/2025/11/25/two-testers-times.svg" alt="time-series chart of developer and tester time" width="90%">
  </div>
</div>

<p>Here&rsquo;s the key question,
and the main point of this series of posts:</p>
<div class="center">
<p><em>Can you tell from these graphs alone which parameter changed?</em></p>
</div>
<p>The answer is &ldquo;no&rdquo;.
It&rsquo;s clear that <em>something</em> has changed,
but our two-plot dashboard doesn&rsquo;t give us enough insight for us to know what.
In this case the answer is that we cut the number of testers on the team from 3 to 2
while leaving both developers in place.
Testing still takes an average of 4.5 timesteps,
while development takes an average of 5.5 timesteps,
so the developers still can&rsquo;t keep the testers busy all the time,
but <em>you can&rsquo;t tell this from these plots</em>.</p>
<p>Let&rsquo;s stick to two developers and two testers and make one more change.
The testers are now busy almost all the time,
and the testing queue always seems to have a backlog,
but that backlog doesn&rsquo;t appear to grow over time:</p>
<div class="row">
  <div class="col-6 center">
    <img src="../files/2025/11/25/queues.svg" alt="time-series chart of queue lengths" width="90%">
  </div>
  <div class="col-6 center">
    <img src="../files/2025/11/25/times.svg" alt="time-series chart of developer and tester time" width="90%">
  </div>
</div>

<p>Again,
you can&rsquo;t tell from these plots alone what changed.
In this case it isn&rsquo;t just a parameter:
instead of the testing time being completely independent of the development time,
we&rsquo;re multiplying the development time by a random number between 0.5 and 1.5
to determine the testing time,
on the theory that things that take longer to develop
usually take longer to test as well.
This is a fundamental change to the model,
but if we didn&rsquo;t have access to the simulation and its parameters
(which we wouldn&rsquo;t in the real world),
we would need to look collect different data and look at it more closely
to figure out what the hell was going on.</p>
</article>

<article class="post">
  <h2 class="post-title">
    <a href="../2025/11/24/analyzing-simulation/">
      Analyzing the Simulation
    </a>
  </h2>
  <p><time datetime="2025-11-24" class="post-date">2025-11-24</time></p>
  <p><a href="../2025/11/23/simulating-multiple-stages/">Yesterday&rsquo;s post</a> added a second stage to the simulation,
and made a prediction about where work would pile up.
Today,
we&rsquo;re going to check whether that prediction is correct.
As a reminder,
our system is:</p>
<div class="highlight"><pre><span></span><code>+----------------+    +-----------+    +------------+    +------------+    +---------+
| task generator | -&gt; | dev queue | -&gt; | developers | -&gt; | test queue | -&gt; | testers |
+----------------+    +-----------+    +------------+    +------------+    +---------+
</code></pre></div>
<p>Tasks arrive every 2.0 timesteps.
It takes each of our two developers an average of 5.5 timesteps to complete a task,
while each of our three testers needs an average of 4.5 timesteps to test the result.
This means that developers should complete one task every 2.75 timesteps,
and testers should be able to complete one every 1.5 timesteps.
We should therefore see work piling up in the development queue,
while the test queue should be more or less empty most of the time.</p>
<h2>Yup</h2>
<p>It only takes a few lines of code
to produce time-series line chart using <a href="https://pola.rs/">Polars</a> and <a href="https://plotly.com/python/plotly-express/">Plotly Express</a>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px</span>


<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;usage: analyze.py csvfile plotfile&quot;</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> \
       <span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;kind&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;dev_queue&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;kind&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;test_queue&quot;</span><span class="p">))</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;kind&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">write_image</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</code></pre></div>
<p>Sure enough,
the queue of tasks waiting for a developer&rsquo;s attention grows and grows,
while tasks only wait occasionally (and briefly) for testing:</p>
<div class="center">
  <img src="../files/2025/11/24/queues.svg" alt="time-series chart of queue lengths">
</div>

<p>A little bit more analysis confirms that yes,
our testers are spending a lot of their time waiting for work
while our developers are busy nearly 100% of the time:</p>
<div class="center">
  <img src="../files/2025/11/24/times.svg" alt="time-series chart of developer and tester time">
</div>

<h2>Little&rsquo;s Law</h2>
<p>One of the most useful results from queueing theory is
a generalization of the quick-and-dirty math we did at the start of this post
that predicted where jobs would pile up.
<a href="https://en.wikipedia.org/wiki/Little%27s_law">Little&rsquo;s Law</a> states that L = λW, where:</p>
<ul>
<li>L is the average number of tasks in the system,</li>
<li>λ is the average arrival rate, and</li>
<li>W is the average time each task spends in the system.</li>
</ul>
<p>For example,
if tasks arrive at a rate of λ = 2 per day
and each spends W = 5 days being worked on,
then on average L = 10 tasks are being worked on at any time.
If each worker does one task at a time, we can infer there are 10 workers.
Most software development teams don&rsquo;t track <em>any</em> of these three numbers;
I hope this series of posts is convincing you that it&rsquo;s worth doing.</p>
</article>

<article class="post">
  <h2 class="post-title">
    <a href="../2025/11/23/simulating-multiple-stages/">
      Simulating Multiple Stages
    </a>
  </h2>
  <p><time datetime="2025-11-23" class="post-date">2025-11-23</time></p>
  <p>After <a href="../2025/11/22/refactoring-the-simulation/">yesterday&rsquo;s refactoring</a>,
we&rsquo;re ready to make the simulation a bit more realistic
by adding a second stage: testing.
Our updated default parameters will be:</p>
<div class="highlight"><pre><span></span><code><span class="n">PARAMS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;max_dev_time&quot;</span><span class="p">:</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="s2">&quot;max_test_time&quot;</span><span class="p">:</span> <span class="mf">8.0</span><span class="p">,</span>        <span class="c1"># new</span>
    <span class="s2">&quot;num_developers&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;num_testers&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>            <span class="c1"># new</span>
    <span class="s2">&quot;random_seed&quot;</span><span class="p">:</span> <span class="mi">12345</span><span class="p">,</span>
    <span class="s2">&quot;simulation_time&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
    <span class="s2">&quot;task_arrival_rate&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>which will control simulation of this system:</p>
<div class="highlight"><pre><span></span><code>+----------------+    +-----------+    +------------+    +------------+    +---------+
| task generator | -&gt; | dev queue | -&gt; | developers | -&gt; | test queue | -&gt; | testers |
+----------------+    +-----------+    +------------+    +------------+    +---------+
</code></pre></div>
<p>Before we start, let&rsquo;s make a prediction.
Development times and testing times are uniformly distributed,
so the mean for each are 5.5 and 4.5 respectively (i.e., (1+10)/2 and (1+8)/2).
With two developers,
we should be able to process one task every 2.75 timesteps;
with three testers,
we should be able to process one task every 1.5 timesteps.
We should therefore see tasks piling up in the test queue
because the testers can take them out
faster than the developers can put them in.</p>
<h2>The <code>Simulation</code> Class</h2>
<p>The first step is to modify the <code>Simulation</code> class that holds all our assets
to create two queues instead of one:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Simulation</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Environment</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dev_queue</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_queue</span> <span class="o">=</span> <span class="n">simpy</span><span class="o">.</span><span class="n">Store</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">)</span>
</code></pre></div>
<h2>The <code>Task</code> Class</h2>
<p>As described <a href="../2025/11/22/refactoring-the-simulation/">yesterday</a>,
<code>Task</code> is basically a bag full of properties.
For convenience,
we have made the task generator a static method of this class
rather than a free-standing function.
In order to test our hypothesis about where tasks are going to pile up,
we will record the length of the waiting-for-development queue in each task
when it is created:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Task</span><span class="p">(</span><span class="n">Labeled</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A single (passive) task.&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate</span><span class="p">(</span><span class="n">sim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate tasks and add to the development queue.&quot;&quot;&quot;</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">sim</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">task_arrival</span><span class="p">())</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>
            <span class="n">task</span><span class="p">[</span><span class="s2">&quot;dev_queue_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sim</span><span class="o">.</span><span class="n">dev_queue</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">sim</span><span class="o">.</span><span class="n">dev_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct.&quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;arrived&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">now</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;dev_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">dev_time</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;test_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">test_time</span><span class="p">()</span>
</code></pre></div>
<h2>The <code>Developer</code> Class</h2>
<p>The only changes to the <code>Developer</code> are
(a) putting the task in the testing queue once development is finished
and (b) recording more information,
such as the total time this developer has spent working:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Developer</span><span class="p">(</span><span class="n">Labeled</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A single developer.&quot;&quot;&quot;</span>

    <span class="err">…</span><span class="n">constructor</span><span class="err">…</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">work</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulate work.&quot;&quot;&quot;</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span>
            <span class="n">task</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">dev_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;waiting&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">now</span>

            <span class="n">now</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;dev_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="s2">&quot;dev_time&quot;</span><span class="p">])</span>
            <span class="n">task</span><span class="p">[</span><span class="s2">&quot;dev_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;working&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">now</span>

            <span class="n">task</span><span class="p">[</span><span class="s2">&quot;test_queue_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">dev_queue</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">test_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</code></pre></div>
<p>Deciding what information to record was
the hardest part of writing this version of the simulation.
Should each developer keep a list of the time spent per task
rather than just summing it up?
That felt redundant,
given that we&rsquo;re recording development time in each task.
But what about recording which developers do which tasks?
Or keeping track of how much time each developer spent waiting for a task to appear?
In the end we decided to record the latter but not the former.</p>
<p>Each of these decisions constrains what questions we can ask about our development process.
One of the reasons to use a tool like <a href="https://www.swarmia.com/">Swarmia</a> is that
they have thought through these questions
and figured out what to collect in order to get useful answers.</p>
<h2>The <code>Tester</code> Class</h2>
<p>Each tester takes jobs from the testing queue,
spends some time working on them,
and records a few statistics.
The code is almost the same as that for a developer,
but after reorganizing it a couple of times
we decided that two separate classes would be easier to understand
than one class with a couple of <code>if</code> statements to control behavior:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Tester</span><span class="p">(</span><span class="n">Labeled</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A single (active) tester.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct.&quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span> <span class="o">=</span> <span class="n">sim</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">work</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simulate work.&quot;&quot;&quot;</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span>
            <span class="n">task</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">test_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;waiting&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">now</span>

            <span class="n">now</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;test_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="s2">&quot;test_time&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;working&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="n">now</span>
            <span class="n">task</span><span class="p">[</span><span class="s2">&quot;test_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">now</span>
</code></pre></div>
<h2>The Main Driver</h2>
<p>We haven&rsquo;t shown <code>main</code> in a while,
so here is what it has become:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main driver.&quot;&quot;&quot;</span>

    <span class="c1"># Handle command-line arguments and parameters.</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>
    <span class="n">update_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;random_seed&quot;</span><span class="p">])</span>

    <span class="c1"># Create and run the simulation and its processes.</span>
    <span class="n">sim</span> <span class="o">=</span> <span class="n">Simulation</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">Task</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">sim</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;num_developers&quot;</span><span class="p">]):</span>
        <span class="n">dev</span> <span class="o">=</span> <span class="n">Developer</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">dev</span><span class="o">.</span><span class="n">work</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;num_testers&quot;</span><span class="p">]):</span>
        <span class="n">tester</span> <span class="o">=</span> <span class="n">Tester</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>
        <span class="n">sim</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">tester</span><span class="o">.</span><span class="n">work</span><span class="p">())</span>
    <span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># Report results.</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">make_log</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">PrettyTable</span><span class="p">()</span>
        <span class="n">table</span><span class="o">.</span><span class="n">field_names</span> <span class="o">=</span> <span class="n">log</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">table</span><span class="o">.</span><span class="n">add_rows</span><span class="p">(</span><span class="n">log</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">table</span><span class="o">.</span><span class="n">align</span> <span class="o">=</span> <span class="n">TABLE_ALIGNMENT</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">lineterminator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
</code></pre></div>
<h2>The Output, and Why</h2>
<p>Running the simulation with the default parameters shown earlier
produces this output:</p>
<div class="highlight"><pre><span></span><code>kind,id,key,value
parameter,,max_dev_time,10.0
parameter,,max_test_time,8.0
parameter,,num_developers,2
parameter,,num_testers,3
parameter,,random_seed,12345
parameter,,simulation_time,20
parameter,,task_arrival_rate,2.0
task,0,arrived,1.08
task,0,dev_queue_length,0
task,0,dev_time,1.09
task,0,dev_start,1.08
task,0,dev_end,2.17
task,0,test_queue_length,0
task,0,test_time,6.78
task,0,test_start,2.17
task,0,test_end,8.95
task,1,arrived,1.79
task,1,dev_queue_length,0
task,1,dev_time,4.32
…
…many more lines here…
…
task,13,test_time,6.77
task,13,test_start,0.0
task,13,test_end,0.0
developer,0,working,16.01
developer,0,waiting,2.37
developer,1,working,8.51
developer,1,waiting,1.89
tester,0,working,6.78
tester,0,waiting,7.53
tester,1,working,9.58
tester,1,waiting,8.53
tester,2,working,5.74
tester,2,waiting,13.8
</code></pre></div>
<p>which is much easier to read as a table:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">kind</th>
<th style="text-align: right;">id</th>
<th style="text-align: left;">key</th>
<th style="text-align: right;">value</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">parameter</td>
<td style="text-align: right;">None</td>
<td style="text-align: left;">max_dev_time</td>
<td style="text-align: right;">10.0</td>
</tr>
<tr>
<td style="text-align: left;">parameter</td>
<td style="text-align: right;">None</td>
<td style="text-align: left;">max_test_time</td>
<td style="text-align: right;">8.0</td>
</tr>
<tr>
<td style="text-align: left;">parameter</td>
<td style="text-align: right;">None</td>
<td style="text-align: left;">num_developers</td>
<td style="text-align: right;">2</td>
</tr>
<tr>
<td style="text-align: left;">parameter</td>
<td style="text-align: right;">None</td>
<td style="text-align: left;">num_testers</td>
<td style="text-align: right;">3</td>
</tr>
<tr>
<td style="text-align: left;">parameter</td>
<td style="text-align: right;">None</td>
<td style="text-align: left;">random_seed</td>
<td style="text-align: right;">12345</td>
</tr>
<tr>
<td style="text-align: left;">parameter</td>
<td style="text-align: right;">None</td>
<td style="text-align: left;">simulation_time</td>
<td style="text-align: right;">20</td>
</tr>
<tr>
<td style="text-align: left;">parameter</td>
<td style="text-align: right;">None</td>
<td style="text-align: left;">task_arrival_rate</td>
<td style="text-align: right;">2.0</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">arrived</td>
<td style="text-align: right;">1.08</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">dev_queue_length</td>
<td style="text-align: right;">0</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">dev_time</td>
<td style="text-align: right;">1.09</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">dev_start</td>
<td style="text-align: right;">1.08</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">dev_end</td>
<td style="text-align: right;">2.17</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">test_queue_length</td>
<td style="text-align: right;">0</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">test_time</td>
<td style="text-align: right;">6.78</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">test_start</td>
<td style="text-align: right;">2.17</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">test_end</td>
<td style="text-align: right;">8.95</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">arrived</td>
<td style="text-align: right;">1.79</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">dev_queue_length</td>
<td style="text-align: right;">0</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">dev_time</td>
<td style="text-align: right;">4.32</td>
</tr>
<tr>
<td style="text-align: left;">…</td>
<td style="text-align: right;">…</td>
<td style="text-align: left;">…</td>
<td style="text-align: right;">…</td>
</tr>
<tr>
<td style="text-align: left;">…</td>
<td style="text-align: right;">…</td>
<td style="text-align: left;">…</td>
<td style="text-align: right;">…</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">13</td>
<td style="text-align: left;">test_time</td>
<td style="text-align: right;">6.77</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">13</td>
<td style="text-align: left;">test_start</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr>
<td style="text-align: left;">task</td>
<td style="text-align: right;">13</td>
<td style="text-align: left;">test_end</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr>
<td style="text-align: left;">developer</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">working</td>
<td style="text-align: right;">16.01</td>
</tr>
<tr>
<td style="text-align: left;">developer</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">waiting</td>
<td style="text-align: right;">2.37</td>
</tr>
<tr>
<td style="text-align: left;">developer</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">working</td>
<td style="text-align: right;">8.51</td>
</tr>
<tr>
<td style="text-align: left;">developer</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">waiting</td>
<td style="text-align: right;">1.89</td>
</tr>
<tr>
<td style="text-align: left;">tester</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">working</td>
<td style="text-align: right;">6.78</td>
</tr>
<tr>
<td style="text-align: left;">tester</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">waiting</td>
<td style="text-align: right;">7.53</td>
</tr>
<tr>
<td style="text-align: left;">tester</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">working</td>
<td style="text-align: right;">9.58</td>
</tr>
<tr>
<td style="text-align: left;">tester</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">waiting</td>
<td style="text-align: right;">8.53</td>
</tr>
<tr>
<td style="text-align: left;">tester</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">working</td>
<td style="text-align: right;">5.74</td>
</tr>
<tr>
<td style="text-align: left;">tester</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">waiting</td>
<td style="text-align: right;">13.8</td>
</tr>
</tbody>
</table>
<p>This is not the most readable way to format the output for human consumption:
it would be more natural to store the simulation parameters in a two-column table,
then use another table with ten columns for tasks
(one for the ID, the others for arrival time, queue lengths, development time, and so on).
However,
there isn&rsquo;t a standard format for storing multiple tables in a single text file.
Our options are therefore:</p>
<ol>
<li>Create multiple output files for each simulation,
    which would be a pain to manage.</li>
<li>Use JSON or YAML,
    which would be even less readable than the four-column output shown above.</li>
<li>Create a multi-sheet spreadsheet or use a binary format like SQLite or HDF5,
    none of which play nicely with version control.</li>
</ol>
<p>Having all the output in a single file will make it relatively easy to build analysis tools:
we can load all the data from a single simulation into a single dataframe,
then filter to pull out data for tasks, developers, and testers,
and finally pivot it to create a wide table for each.
We&rsquo;ll tackle that tomorrow,
and then see if our hypothesis about developers being a bottleneck is true.</p>
</article>


    </main>
    <footer>
  &copy; 2004-2025 <a href="../about/">Greg Wilson</a>
  <a href="mailto:gvwilson@third-bit.com"><img src="../assets/icons/envelope.svg" alt="email" class="footer-icon"></a>
  <a href="https://www.linkedin.com/in/gvwilson/"><img src="../assets/icons/linkedin.svg" alt="LinkedIn" class="footer-icon"></a>
  <a href="https://mastodon.social/@gvwilson"><img src="../assets/icons/mastodon.svg" alt="Mastodon" class="footer-icon"></a>
  <a href="https://calendly.com/gvwilson/30min"><img src="../assets/icons/calendar.svg" alt="Calendly" class="footer-icon"></a>
  <a href="https://github.com/gvwilson"><img src="../assets/icons/github.svg" alt="GitHub" class="footer-icon"></a>
  <a href="https://www.youtube.com/channel/UCbDQ7FIeYB3FHRADAjUjfrg"><img src="../assets/icons/youtube.svg" alt="YouTube" class="footer-icon"></a>
  <a href="../bib/"><img src="../assets/icons/orcid.svg" alt="ORCID" class="footer-icon"></a>
  <a href="../atom.xml"><img src="../assets/icons/rss.svg" alt="RSS feed" class="footer-icon"></a>
  <a href="../license/"><img src="../assets/icons/cc-by.svg" alt="license" class="footer-icon"></a>
  <a href="../colophon/"><img src="../assets/icons/pencil.svg" alt="colophon" class="footer-icon"></a>
  <a href="../cv/"><img src="../assets/icons/file.svg" alt="CV" class="footer-icon"></a>
  <br>
  None of the material on this site may be used to train AI models without the express prior permission of the author.
</footer>
  </body>
</html>
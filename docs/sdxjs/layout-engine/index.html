<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="../favicon.ico">
  <link rel="stylesheet" href="../mccole.css">
  <link rel="stylesheet" href="../tango.css">
  <script defer data-domain="third-bit.com" src="https://plausible.io/js/plausible.js"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']]
      }
    };
  </script>
  <script
    type="text/javascript"
    id="MathJax-script"
    async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <script defer src="../mccole.js"></script>
  <title>Software Design by Example: Layout Engine</title>
</head>

  <body>
    <div class="row">
      <div class="sidebar">
        <p>
  
  <a href="https://www.taylorfrancis.com/books/mono/10.1201/9781003317807/software-design-example-greg-wilson"><img src="../sdxjs-cover.png" alt="Book cover" width="80%" /></a>
  
</p>
<ol class="toc-chapter">
  
  <li>
    <a href="../introduction/">
      Introduction
    </a>
  </li>
  
  <li>
    <a href="../systems-programming/">
      Systems Programming
    </a>
  </li>
  
  <li>
    <a href="../async-programming/">
      Asynchronous Programming
    </a>
  </li>
  
  <li>
    <a href="../unit-test/">
      Unit Testing
    </a>
  </li>
  
  <li>
    <a href="../file-backup/">
      File Backup
    </a>
  </li>
  
  <li>
    <a href="../data-table/">
      Data Tables
    </a>
  </li>
  
  <li>
    <a href="../pattern-matching/">
      Pattern Matching
    </a>
  </li>
  
  <li>
    <a href="../regex-parser/">
      Parsing Expressions
    </a>
  </li>
  
  <li>
    <a href="../page-templates/">
      Page Templates
    </a>
  </li>
  
  <li>
    <a href="../build-manager/">
      Build Manager
    </a>
  </li>
  
  <li>
    <a href="../layout-engine/">
      <strong>Layout Engine</strong>
    </a>
  </li>
  
  <li>
    <a href="../file-interpolator/">
      File Interpolator
    </a>
  </li>
  
  <li>
    <a href="../module-loader/">
      Module Loader
    </a>
  </li>
  
  <li>
    <a href="../style-checker/">
      Style Checker
    </a>
  </li>
  
  <li>
    <a href="../code-generator/">
      Code Generator
    </a>
  </li>
  
  <li>
    <a href="../doc-generator/">
      Documentation Generator
    </a>
  </li>
  
  <li>
    <a href="../module-bundler/">
      Module Bundler
    </a>
  </li>
  
  <li>
    <a href="../package-manager/">
      Package Manager
    </a>
  </li>
  
  <li>
    <a href="../virtual-machine/">
      Virtual Machine
    </a>
  </li>
  
  <li>
    <a href="../debugger/">
      Debugger
    </a>
  </li>
  
  <li>
    <a href="../conclusion/">
      Conclusion
    </a>
  </li>
  
</ol>
<ol class="toc-appendix">
  
  <li>
    <a href="../license/">
      License
    </a>
  </li>
  
  <li>
    <a href="../conduct/">
      Code of Conduct
    </a>
  </li>
  
  <li>
    <a href="../contributing/">
      Contributing
    </a>
  </li>
  
  <li>
    <a href="../bibliography/">
      Bibliography
    </a>
  </li>
  
  <li>
    <a href="../glossary/">
      Glossary
    </a>
  </li>
  
  <li>
    <a href="../contents/">
      Index
    </a>
  </li>
  
</ol>

<p><a href="../sdxjs-examples.zip" type="application/zip" alt="examples">download examples</a></p>


      </div>
      <div id="printable" class="contents bordered">
        <main>
          
  <h1>Chapter 11: Layout Engine</h1>


          
            

            

            
<p class="definitions">
  Terms defined: <a class="gl-ref" href="../glossary/#attribute" markdown="1">attribute</a>, <a class="gl-ref" href="../glossary/#cache" markdown="1">cache</a>, <a class="gl-ref" href="../glossary/#confirmation_bias" markdown="1">confirmation bias</a>, <a class="gl-ref" href="../glossary/#design_by_contract" markdown="1">design by contract</a>, <a class="gl-ref" href="../glossary/#easy_mode" markdown="1">easy mode</a>, <a class="gl-ref" href="../glossary/#layout_engine" markdown="1">layout engine</a>, <a class="gl-ref" href="../glossary/#liskov_substitution_principle" markdown="1">Liskov Substitution Principle</a>, <a class="gl-ref" href="../glossary/#query_selector" markdown="1">query selector</a>, <a class="gl-ref" href="../glossary/#signature" markdown="1">signature</a>, <a class="gl-ref" href="../glossary/#z_buffering" markdown="1">z-buffering</a>
</p>


            <div class="page-toc"></div>
            <p>You might be reading this as an HTML page,
an e-book (which is basically the same thing),
or on the printed page.
In all three cases,
a <span class="ix-entry" ix-key="layout engine" markdown="1"><a class="gl-ref" href="../glossary/#layout_engine" markdown="1">layout engine</a></span> took some text and some layout instructions
and decided where to put each character and image.
We will build a small layout engine in this chapter
based on <span class="ix-entry" ix-key="Brubeck, Matt" markdown="1"><a href="https://limpet.net/mbrubeck/">Matt Brubeck&rsquo;s</a></span> <a href="https://limpet.net/mbrubeck/2014/08/08/toy-layout-engine-1.html">tutorial</a>
to explore how browsers decide what to put where.</p>
<p>Our inputs will be a very small subset of HTML and an equally small subset of CSS.
We will create our own classes to represent these
instead of using those provided by various <a href="https://nodejs.org/en/">Node</a> libraries;
to translate the combination of HTML and CSS into text on the screen,
we will label each node in the DOM tree with the appropriate styles,
walk that tree to figure out where each visible element belongs,
and then draw the result as text on the screen.</p>
<div class="callout">
<h3>Upside down</h3>
<p>The <span class="ix-entry" ix-key="coordinate system" markdown="1">coordinate systems</span> for screens
puts (0, 0) in the upper left corner instead of the lower left.
X increases to the right as usual,
but Y increases as we go down, rather than up
(<a class="fig-ref" href="../layout-engine/#layout-engine-coordinate-system">Figure 11.1</a>).
This convention is a holdover from the days of teletype terminals
that printed lines on rolls of paper;
as <span class="ix-entry" ix-key="Hoye, Mike" markdown="1"><a href="http://exple.tive.org/blarg/">Mike Hoye</a></span> has <a href="http://exple.tive.org/blarg/2020/11/26/punching-holes/">repeatedly observed</a>,
the past is all around us.</p>
</div>
<figure id="layout-engine-coordinate-system">
  <img src="./coordinate-system.svg" alt="Coordinate system"/>
  <figcaption markdown="1">Figure 11.1: Coordinate system with (0, 0) in the upper left corner.</figcaption>
</figure>

<h2 id="layout-engine-size">Section 11.2: How can we size rows and columns?</h2>
<p>Let&rsquo;s start on <a class="gl-ref" href="../glossary/#easy_mode" markdown="1">easy mode</a>
without margins, padding, line-wrapping, or other complications.
Everything we can put on the screen is represented as a rectangular cell,
and every cell is either a row, a column, or a block.
A block has a fixed width and height:</p>
<div class="code-sample lang-js" title="easy-mode.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Block</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">width</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">height</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getWidth</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">width</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getHeight</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">height</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<p>A row arranges one or more cells horizontally;
its width is the sum of the widths of its children,
while its height is the height of its tallest child
(<a class="fig-ref" href="../layout-engine/#layout-engine-sizing">Figure 11.2</a>):</p>
<div class="code-sample lang-js" title="easy-mode.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Row</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(...</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">children</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getWidth</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">child</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">result</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getHeight</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">child</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">())</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<figure id="layout-engine-sizing">
  <img src="./sizing.svg" alt="Calculating sizes of fixed blocks"/>
  <figcaption markdown="1">Figure 11.2: Calculating sizes of blocks with fixed width and height.</figcaption>
</figure>

<p>Finally,
a column arranges one or more cells vertically;
its width is the width of its widest child
and its height is the sum of the heights of its children.
(Here and elsewhere we use the abbreviation <code>col</code> when referring to columns.)</p>
<div class="code-sample lang-js" title="easy-mode.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Col</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(...</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">children</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getWidth</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">child</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">())</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getHeight</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">child</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">result</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<p>Rows and columns nest inside one another:
a row cannot span two or more columns,
and a column cannot cross the boundary between two rows.
Any time we have a structure with that property
we can represent it as a tree of nested objects.
Given such a tree,
we can calculate the width and height of each cell every time we need to.
This is simple but inefficient:
we could calculate both width and height at the same time
and <span class="ix-entry" ix-key="cache!calculated values" markdown="1"><a class="gl-ref" href="../glossary/#cache" markdown="1">cache</a></span> those values to avoid recalculation,
but we called this &ldquo;easy mode&rdquo; for a reason.</p>
<p>As simple as it is,
this code could still contain errors (and did during development),
so we write some <span class="ix-entry" ix-key="Mocha" markdown="1"><a href="https://mochajs.org/">Mocha</a></span> tests to check that it works as desired
before trying to build anything more complicated:</p>
<div class="code-sample lang-js" title="test-easy-mode.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;assert&#39;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">Block</span><span class="p">,</span>
<span class="w">  </span><span class="nx">Row</span><span class="p">,</span>
<span class="w">  </span><span class="nx">Col</span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../easy-mode.js&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;lays out in easy mode&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;lays out a single unit block&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">fixture</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">(),</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">fixture</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">(),</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;lays out a large block&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">fixture</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">(),</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">fixture</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">(),</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;lays out a row of two blocks&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Row</span><span class="p">(</span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">),</span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">fixture</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">(),</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">fixture</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">(),</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;lays out a column of two blocks&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Col</span><span class="p">(</span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">),</span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">fixture</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">(),</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">fixture</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">(),</span><span class="w"> </span><span class="mf">5</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;lays out a grid of rows of columns&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Col</span><span class="p">(</span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Row</span><span class="p">(</span>
<span class="w">        </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">),</span>
<span class="w">        </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span>
<span class="w">      </span><span class="p">),</span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Row</span><span class="p">(</span>
<span class="w">        </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">5</span><span class="p">,</span><span class="w"> </span><span class="mf">6</span><span class="p">),</span>
<span class="w">        </span><span class="ow">new</span><span class="w"> </span><span class="nx">Col</span><span class="p">(</span>
<span class="w">          </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">7</span><span class="p">,</span><span class="w"> </span><span class="mf">8</span><span class="p">),</span>
<span class="w">          </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">9</span><span class="p">,</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">fixture</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">(),</span><span class="w"> </span><span class="mf">14</span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">strictEqual</span><span class="p">(</span><span class="nx">fixture</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">(),</span><span class="w"> </span><span class="mf">22</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test-easy-mode.out">
<div class="highlight"><pre><span></span><code>&gt; stjs@1.0.0 test /u/stjs
&gt; mocha */test/test-*.js &quot;-g&quot; &quot;easy mode&quot;



  lays out in easy mode
    ✓ lays out a single unit block
    ✓ lays out a large block
    ✓ lays out a row of two blocks
    ✓ lays out a column of two blocks
    ✓ lays out a grid of rows of columns


  5 passing (7ms)
</code></pre></div>
</div>
<h2 id="layout-engine-position">Section 11.3: How can we position rows and columns?</h2>
<p>Now that we know how big each cell is
we can figure out where to put it.
Suppose we start with the upper left corner of the browser:
upper because we lay out the page top-to-bottom
and left because we are doing left-to-right layout.
If the cell is a block, we place it there.
If the cell is a row, on the other hand,
we get its height
and then calculate its lower edge as y1 = y0 + height.
We then place the first child&rsquo;s lower-left corner at (x0, y1),
the second child&rsquo;s at (x0 + width0, y1), and so on
(<a class="fig-ref" href="../layout-engine/#layout-engine-layout">Figure 11.3</a>).
Similarly,
if the cell is a column
we place the first child at (x0, y0),
the next at (x0, y0 + height0),
and so on.</p>
<figure id="layout-engine-layout">
  <img src="./layout.svg" alt="Laying out rows and columns"/>
  <figcaption markdown="1">Figure 11.3: Laying out rows and columns of fixed-size blocks.</figcaption>
</figure>

<p>To save ourselves some testing we will derive the classes that know how to do layout
from the classes we wrote before.
Our blocks are:</p>
<div class="code-sample lang-js" title="placed.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">PlacedBlock</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">Block</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">place</span><span class="w"> </span><span class="p">(</span><span class="nx">x0</span><span class="p">,</span><span class="w"> </span><span class="nx">y0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x0</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">y0</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">report</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s1">&#39;block&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="p">,</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">height</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<p class="continue">while our columns are:</p>
<div class="code-sample lang-js" title="placed.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">PlacedCol</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">Col</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(...</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">(...</span><span class="nx">children</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">y1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">place</span><span class="w"> </span><span class="p">(</span><span class="nx">x0</span><span class="p">,</span><span class="w"> </span><span class="nx">y0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x0</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">y0</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">yCurrent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">child</span><span class="p">.</span><span class="nx">place</span><span class="p">(</span><span class="nx">x0</span><span class="p">,</span><span class="w"> </span><span class="nx">yCurrent</span><span class="p">)</span>
<span class="w">      </span><span class="nx">yCurrent</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">()</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">report</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s1">&#39;col&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="p">,</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">(),</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">(),</span>
<span class="w">      </span><span class="p">...</span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">report</span><span class="p">())</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<p class="continue">and our rows are:</p>
<div class="code-sample lang-js" title="placed.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">PlacedRow</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">Row</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(...</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">(...</span><span class="nx">children</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">place</span><span class="w"> </span><span class="p">(</span><span class="nx">x0</span><span class="p">,</span><span class="w"> </span><span class="nx">y0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x0</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">y0</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">y1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">()</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">xCurrent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x0</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">childY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">y1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">()</span>
<span class="w">      </span><span class="nx">child</span><span class="p">.</span><span class="nx">place</span><span class="p">(</span><span class="nx">xCurrent</span><span class="p">,</span><span class="w"> </span><span class="nx">childY</span><span class="p">)</span>
<span class="w">      </span><span class="nx">xCurrent</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">()</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">report</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="p">,</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">x0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">(),</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">y0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">(),</span>
<span class="w">      </span><span class="p">...</span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">report</span><span class="p">())</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<p>Once again,
we write and run some tests to check that everything is doing what it&rsquo;s supposed to:</p>
<div class="code-sample lang-js" title="test-placed.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;assert&#39;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">PlacedBlock</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Block</span><span class="p">,</span>
<span class="w">  </span><span class="nx">PlacedCol</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Col</span><span class="p">,</span>
<span class="w">  </span><span class="nx">PlacedRow</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">Row</span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;../placed.js&#39;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;places blocks&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;places a single unit block&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="nx">fixture</span><span class="p">.</span><span class="nx">place</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span>
<span class="w">      </span><span class="nx">fixture</span><span class="p">.</span><span class="nx">report</span><span class="p">(),</span>
<span class="w">      </span><span class="p">[</span><span class="s1">&#39;block&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;places a large block&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span>
<span class="w">    </span><span class="nx">fixture</span><span class="p">.</span><span class="nx">place</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span>
<span class="w">      </span><span class="nx">fixture</span><span class="p">.</span><span class="nx">report</span><span class="p">(),</span>
<span class="w">      </span><span class="p">[</span><span class="s1">&#39;block&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;places a row of two blocks&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Row</span><span class="p">(</span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">),</span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="nx">fixture</span><span class="p">.</span><span class="nx">place</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span>
<span class="w">      </span><span class="nx">fixture</span><span class="p">.</span><span class="nx">report</span><span class="p">(),</span>
<span class="w">      </span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="s1">&#39;block&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">],</span>
<span class="w">        </span><span class="p">[</span><span class="s1">&#39;block&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">]</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>

<span class="p">})</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test-placed.out">
<div class="highlight"><pre><span></span><code>&gt; stjs@1.0.0 test /u/stjs
&gt; mocha */test/test-*.js &quot;-g&quot; &quot;places blocks&quot;

  places blocks
    ✓ places a single unit block
    ✓ places a large block
    ✓ places a row of two blocks
    ✓ places a column of two blocks
    ✓ places a grid of rows of columns


  5 passing (8ms)
</code></pre></div>
</div>
<h2 id="layout-engine-render">Section 11.4: How can we render elements?</h2>
<p>We drew the blocks on a piece of graph paper
in order to figure out the expected answers for the tests shown above.
We can do something similar in software by creating a &ldquo;screen&rdquo; of space characters
and then having each block draw itself in the right place.
If we do this starting at the root of the tree,
child blocks will overwrite the markings made by their parents,
which will automatically produce the right appearance
(<a class="fig-ref" href="../layout-engine/#layout-engine-draw-over">Figure 11.4</a>).
(A more sophisticated version of this called <a class="gl-ref" href="../glossary/#z_buffering" markdown="1">z-buffering</a>
keeps track of the visual depth of each pixel
in order to draw things in three dimensions.)</p>
<figure id="layout-engine-draw-over">
  <img src="./draw-over.svg" alt="Children drawing over their parents"/>
  <figcaption markdown="1">Figure 11.4: Render blocks by drawing child nodes on top of parent nodes.</figcaption>
</figure>

<p>Our pretended screen is just an array of arrays of characters:</p>
<div class="code-sample lang-js" title="render.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">makeScreen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">screen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">height</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">screen</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="ow">new</span><span class="w"> </span><span class="nb">Array</span><span class="p">(</span><span class="nx">width</span><span class="p">).</span><span class="nx">fill</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">screen</span>
<span class="p">}</span>
</code></pre></div>
</div>
<p>We will use successive lower-case characters to show each block,
i.e.,
the root block will draw itself using the letter a,
while its children will use b, c, and so on.</p>
<div class="code-sample lang-js" title="render.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">draw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">nextFill</span><span class="p">(</span><span class="nx">fill</span><span class="p">)</span>
<span class="w">  </span><span class="nx">node</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">fill</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;children&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">draw</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">child</span><span class="p">,</span><span class="w"> </span><span class="nx">fill</span><span class="p">)</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">fill</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">nextFill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">fill</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nx">fill</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span>
<span class="w">    </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;a&#39;</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">fill</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
</div>
<p>To teach each kind of cell how to render itself,
we have to derive a new class from each of the ones we have
and give the new class a <code>render</code> method with the same <span class="ix-entry" ix-key="signature!of function;function signature" markdown="1"><a class="gl-ref" href="../glossary/#signature" markdown="1">signature</a></span>:</p>
<div class="code-sample lang-js" title="rendered.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">RenderedBlock</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">PlacedBlock</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">render</span><span class="w"> </span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">fill</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">drawBlock</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">fill</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">RenderedCol</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">PlacedCol</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">render</span><span class="w"> </span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">fill</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">drawBlock</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">fill</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">RenderedRow</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">PlacedRow</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">render</span><span class="w"> </span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">fill</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">drawBlock</span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">fill</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">drawBlock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">screen</span><span class="p">,</span><span class="w"> </span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">fill</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">ix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">ix</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">();</span><span class="w"> </span><span class="nx">ix</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">iy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">iy</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">getHeight</span><span class="p">();</span><span class="w"> </span><span class="nx">iy</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">screen</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">y0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">iy</span><span class="p">][</span><span class="nx">node</span><span class="p">.</span><span class="nx">x0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">ix</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fill</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<p class="continue">These <code>render</code> methods do exactly the same thing,
so we have each one call a shared function that does the actual work.
If we were building a real layout engine,
a cleaner solution would be to go back and create a class called <code>Cell</code> with this <code>render</code> method,
then derive our <code>Block</code>, <code>Row</code>, and <code>Col</code> classes from that.
In general,
if two or more classes need to be able to do something,
we should add a method to do that to their lowest common ancestor.</p>
<p>Our simpler tests are a little easier to read once we have rendering in place,
though we still had to draw things on paper to figure out our complex ones:</p>
<div class="code-sample lang-js" title="test-rendered.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;renders a grid of rows of columns&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Col</span><span class="p">(</span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Row</span><span class="p">(</span>
<span class="w">        </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">),</span>
<span class="w">        </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">)</span>
<span class="w">      </span><span class="p">),</span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Row</span><span class="p">(</span>
<span class="w">        </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">),</span>
<span class="w">        </span><span class="ow">new</span><span class="w"> </span><span class="nx">Col</span><span class="p">(</span>
<span class="w">          </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">3</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="p">),</span>
<span class="w">          </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="p">)</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="nx">fixture</span><span class="p">.</span><span class="nx">place</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span>
<span class="w">      </span><span class="nx">render</span><span class="p">(</span><span class="nx">fixture</span><span class="p">),</span>
<span class="w">      </span><span class="p">[</span>
<span class="w">        </span><span class="s1">&#39;bddd&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;bddd&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;cddd&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;cddd&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;ehhh&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;ehhh&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;ehhh&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;ehhh&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;eiig&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;fiig&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="s1">&#39;fiig&#39;</span>
<span class="w">      </span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
</code></pre></div>
</div>
<p class="continue">The fact that we find our own tests difficult to understand
is a sign that we should do more testing.
It would be very easy for us to get a wrong result
and convince ourselves that it was actually correct;
<span class="ix-entry" ix-key="confirmation bias" markdown="1"><a class="gl-ref" href="../glossary/#confirmation_bias" markdown="1">confirmation bias</a></span> of this kind
is very common in software development.</p>
<h2 id="layout-engine-fit">Section 11.5: How can we wrap elements to fit?</h2>
<p>One of the biggest differences between a browser and a printed page
is that the text in the browser wraps itself automatically as the window is resized.
(The other, these days, is that the printed page doesn&rsquo;t spy on us,
though someone is undoubtedly working on that.)</p>
<p>To add wrapping to our layout engine,
suppose we fix the width of a row.
If the total width of the children is greater than the row&rsquo;s width,
the layout engine needs to wrap the children around.
This assumes that columns can be made as big as they need to be,
i.e.,
that we can grow vertically to make up for limited space horizontally.
It also assumes that all of the row&rsquo;s children are no wider than the width of the row;
we will look at what happens when they&rsquo;re not in the exercises.</p>
<p>Our layout engine manages wrapping by transforming the tree.
The height and width of blocks are fixed,
so they become themselves.
Columns become themselves as well,
but since they have children that might need to wrap,
the class representing columns needs a new method:</p>
<div class="code-sample lang-js" title="wrapped.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">WrappedBlock</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">PlacedBlock</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">wrap</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">WrappedCol</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">PlacedCol</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">wrap</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">wrap</span><span class="p">())</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PlacedCol</span><span class="p">(...</span><span class="nx">children</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<p>Rows do all the hard work.
Each original row is replaced with a new row that contains a single column with one or more rows,
each of which is one &ldquo;line&rdquo; of wrapped cells
(<a class="fig-ref" href="../layout-engine/#layout-engine-wrap">Figure 11.5</a>).
This replacement is unnecessary when everything will fit on a single row,
but it&rsquo;s easiest to write the code that does it every time;
we will look at making this more efficient in the exercises.</p>
<figure id="layout-engine-wrap">
  <img src="./wrap.svg" alt="Wrapping rows"/>
  <figcaption markdown="1">Figure 11.5: Wrapping rows by introducing a new row and column.</figcaption>
</figure>

<p>Our new wrappable row&rsquo;s constructor takes a fixed width followed by the children
and returns that fixed width when asked for its size:</p>
<div class="code-sample lang-js" title="wrapped.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">WrappedRow</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">PlacedRow</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">(...</span><span class="nx">children</span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">width</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;Need non-negative width&#39;</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">width</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getWidth</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">width</span>
<span class="w">  </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
</div>
<p class="continue">Wrapping puts the row&rsquo;s children into buckets,
then converts the buckets to a row of a column of rows:</p>
<div class="code-sample lang-js" title="wrapped.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">wrap</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">wrap</span><span class="p">())</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">rows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">currentRow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">currentX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>

<span class="w">    </span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">childWidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">getWidth</span><span class="p">()</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="nx">currentX</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">childWidth</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">currentRow</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span>
<span class="w">        </span><span class="nx">currentX</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">childWidth</span>
<span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">rows</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">currentRow</span><span class="p">)</span>
<span class="w">        </span><span class="nx">currentRow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nx">child</span><span class="p">]</span>
<span class="w">        </span><span class="nx">currentX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">childWidth</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="nx">rows</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">currentRow</span><span class="p">)</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newRows</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rows</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">row</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PlacedRow</span><span class="p">(...</span><span class="nx">row</span><span class="p">))</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">newCol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PlacedCol</span><span class="p">(...</span><span class="nx">newRows</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PlacedRow</span><span class="p">(</span><span class="nx">newCol</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
</code></pre></div>
</div>
<p>Once again we bring forward all the previous tests
and write some new ones to test the functionality we&rsquo;ve added:</p>
<div class="code-sample lang-js" title="test-wrapped.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;wrap a row of two blocks that do not fit on one row&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Row</span><span class="p">(</span>
<span class="w">      </span><span class="mf">3</span><span class="p">,</span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">),</span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">Block</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">wrapped</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fixture</span><span class="p">.</span><span class="nx">wrap</span><span class="p">()</span>
<span class="w">    </span><span class="nx">wrapped</span><span class="p">.</span><span class="nx">place</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span>
<span class="w">      </span><span class="nx">wrapped</span><span class="p">.</span><span class="nx">report</span><span class="p">(),</span>
<span class="w">      </span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span>
<span class="w">        </span><span class="p">[</span><span class="s1">&#39;col&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span>
<span class="w">          </span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">            </span><span class="p">[</span><span class="s1">&#39;block&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">]</span>
<span class="w">          </span><span class="p">],</span>
<span class="w">          </span><span class="p">[</span><span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span>
<span class="w">            </span><span class="p">[</span><span class="s1">&#39;block&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">]</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
</code></pre></div>
</div>
<div class="code-sample lang-out" title="test-wrapped.out">
<div class="highlight"><pre><span></span><code>&gt; stjs@1.0.0 test /u/stjs
&gt; mocha */test/test-*.js &quot;-g&quot; &quot;wraps blocks&quot;



  wraps blocks
    ✓ wraps a single unit block
    ✓ wraps a large block
    ✓ wrap a row of two blocks that fit on one row
    ✓ wraps a column of two blocks
    ✓ wraps a grid of rows of columns that all fit on their row
    ✓ wrap a row of two blocks that do not fit on one row
    ✓ wrap multiple blocks that do not fit on one row


  7 passing (10ms)
</code></pre></div>
</div>
<div class="callout">
<h3>The Liskov Substitution Principle</h3>
<p>We are able to re-use tests like this because of
the <span class="ix-entry" ix-key="Liskov Substitution Principle;software design!Liskov Substitution Principle" markdown="1"><a class="gl-ref" href="../glossary/#liskov_substitution_principle" markdown="1">Liskov Substitution Principle</a></span>,
which states that
it should be possible to replace objects in a program
with objects of derived classes
without breaking anything.
In order to satisfy this principle,
new code must handle the same set of inputs as the old code,
though it may be able to process more inputs as well.
Conversely,
its output must be a subset of what the old code produced
so that whatever is downstream from it won&rsquo;t be surprised.
Thinking in these terms leads to a methodology called
<span class="ix-entry" ix-key="design by contract;software design!design by contract" markdown="1"><a class="gl-ref" href="../glossary/#design_by_contract" markdown="1">design by contract</a></span>.</p>
</div>
<h2 id="layout-engine-css">Section 11.6: What subset of CSS will we support?</h2>
<p>It&rsquo;s finally time to style pages that contain text.
Our final subset of HTML has rows, columns, and text blocks as before.
Each text block has one or more lines of text;
the number of lines determines the block&rsquo;s height
and the length of the longest line determines its width.</p>
<div class="pagebreak"></div>

<p>Rows and columns can have <a class="gl-ref" href="../glossary/#attribute" markdown="1">attributes</a> just as they can in real HTML,
and each attribute must have a single value in quotes.
Rows no longer take a fixed width:
instead,
we will specify that with our little subset of <span class="ix-entry" ix-key="CSS" markdown="1">CSS</span>.
Together,
these three classes are just over 40 lines of code:</p>
<div class="code-sample lang-js" title="micro-dom.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">DomBlock</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">WrappedBlock</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">lines</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span>
<span class="w">      </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(...</span><span class="nx">lines</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">line</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">line</span><span class="p">.</span><span class="nx">length</span><span class="p">)),</span>
<span class="w">      </span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">lines</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;text&#39;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">findRules</span><span class="w"> </span><span class="p">(</span><span class="nx">css</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">css</span><span class="p">.</span><span class="nx">findRules</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">DomCol</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">WrappedCol</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">(...</span><span class="nx">children</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">attributes</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;col&#39;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">findRules</span><span class="w"> </span><span class="p">(</span><span class="nx">css</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">css</span><span class="p">.</span><span class="nx">findRules</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">findRules</span><span class="p">(</span><span class="nx">css</span><span class="p">))</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">DomRow</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">WrappedRow</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">children</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">children</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">attributes</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;row&#39;</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">findRules</span><span class="w"> </span><span class="p">(</span><span class="nx">css</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">css</span><span class="p">.</span><span class="nx">findRules</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">child</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">child</span><span class="p">.</span><span class="nx">findRules</span><span class="p">(</span><span class="nx">css</span><span class="p">))</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<p>We will use regular expressions to parse HTML
(though as we explained in <a class="x-ref" href="../regex-parser/">Chapter 8</a>,
<a href="https://stackoverflow.com/questions/1732348/regex-match-open-tags-except-xhtml-self-contained-tags/1732454#1732454">this is a sin</a>).
The main body of our parser is:</p>
<div class="code-sample lang-js" title="parse.js">
<div class="highlight"><pre><span></span><code><span class="k">import</span><span class="w"> </span><span class="nx">assert</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;assert&#39;</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">DomBlock</span><span class="p">,</span>
<span class="w">  </span><span class="nx">DomCol</span><span class="p">,</span>
<span class="w">  </span><span class="nx">DomRow</span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./micro-dom.js&#39;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">TEXT_AND_TAG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/^([^&lt;]*)(&lt;[^]+?&gt;)(.*)$/ms</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">TAG_AND_ATTR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/&lt;(\w+)([^&gt;]*)&gt;/</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">KEY_AND_VALUE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/\s*(\w+)=&quot;([^&quot;]*)&quot;\s*/g</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">parseHTML</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">chunks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chunkify</span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">trim</span><span class="p">())</span>
<span class="w">  </span><span class="nx">assert</span><span class="p">(</span><span class="nx">isElement</span><span class="p">(</span><span class="nx">chunks</span><span class="p">[</span><span class="mf">0</span><span class="p">]),</span>
<span class="w">    </span><span class="s1">&#39;Must have enclosing outer node&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">remainder</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makeNode</span><span class="p">(</span><span class="nx">chunks</span><span class="p">)</span>
<span class="w">  </span><span class="nx">assert</span><span class="p">(</span><span class="nx">remainder</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;Cannot have dangling content&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">node</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">chunkify</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">raw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">matches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">text</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">TEXT_AND_TAG</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">matches</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">break</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">raw</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">matches</span><span class="p">[</span><span class="mf">1</span><span class="p">])</span>
<span class="w">    </span><span class="nx">raw</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">matches</span><span class="p">[</span><span class="mf">2</span><span class="p">])</span>
<span class="w">    </span><span class="nx">text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">matches</span><span class="p">[</span><span class="mf">3</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">raw</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">nonEmpty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">raw</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">chunk</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nx">chunk</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">))</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">nonEmpty</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">isElement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">chunk</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">chunk</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;&lt;&#39;</span><span class="p">)</span>
<span class="p">}</span>


<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">parseHTML</span>
</code></pre></div>
</div>
<p class="continue">while the two functions that do most of the work are:</p>
<div class="code-sample lang-js" title="parse.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">makeNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">chunks</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">assert</span><span class="p">(</span><span class="nx">chunks</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;Cannot make nodes without chunks&#39;</span><span class="p">)</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">isElement</span><span class="p">(</span><span class="nx">chunks</span><span class="p">[</span><span class="mf">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="ow">new</span><span class="w"> </span><span class="nx">DomBlock</span><span class="p">(</span><span class="nx">chunks</span><span class="p">[</span><span class="mf">0</span><span class="p">]),</span><span class="w"> </span><span class="nx">chunks</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">)]</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makeOpening</span><span class="p">(</span><span class="nx">chunks</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">closing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`&lt;/</span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">tag</span><span class="si">}</span><span class="sb">&gt;`</span>

<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">remainder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chunks</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nx">remainder</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">remainder</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">closing</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">[</span><span class="nx">child</span><span class="p">,</span><span class="w"> </span><span class="nx">remainder</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">makeNode</span><span class="p">(</span><span class="nx">remainder</span><span class="p">)</span>
<span class="w">    </span><span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">assert</span><span class="p">(</span><span class="nx">remainder</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">remainder</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">closing</span><span class="p">),</span>
<span class="w">    </span><span class="sb">`Node with tag </span><span class="si">${</span><span class="nx">node</span><span class="p">.</span><span class="nx">tag</span><span class="si">}</span><span class="sb"> not closed`</span><span class="p">)</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="nx">node</span><span class="p">,</span><span class="w"> </span><span class="nx">remainder</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">)]</span>
<span class="p">}</span>
</code></pre></div>
</div>
<p class="continue">and:</p>
<div class="code-sample lang-js" title="parse.js">
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">makeOpening</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">outer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">chunk</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">TAG_AND_ATTR</span><span class="p">)</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">outer</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">attributes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[...</span><span class="nx">outer</span><span class="p">[</span><span class="mf">2</span><span class="p">].</span><span class="nx">trim</span><span class="p">().</span><span class="nx">matchAll</span><span class="p">(</span><span class="nx">KEY_AND_VALUE</span><span class="p">)]</span>
<span class="w">    </span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">all</span><span class="p">,</span><span class="w"> </span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">])</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">value</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">obj</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="p">{})</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">Cls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tag</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;col&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Cls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">DomCol</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">tag</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;row&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Cls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">DomRow</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">assert</span><span class="p">(</span><span class="nx">Cls</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">    </span><span class="sb">`Unrecognized tag name </span><span class="si">${</span><span class="nx">tag</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Cls</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
</div>
<p>The next step is to define a generic class for CSS rules
with a subclass for each type of rule.
From highest precedence to lowest,
the three types of rules we support identify specific nodes via their ID,
classes of nodes via their <code>class</code> attribute,
and types of nodes via their element name.
We keep track of which rules take precedence over which through the simple expedient of numbering the classes:</p>
<div class="code-sample lang-js" title="micro-css.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">CssRule</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">order</span><span class="p">,</span><span class="w"> </span><span class="nx">selector</span><span class="p">,</span><span class="w"> </span><span class="nx">styles</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">order</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">selector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">selector</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">styles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">styles</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<p>An ID rule&rsquo;s <span class="ix-entry" ix-key="query selector" markdown="1"><a class="gl-ref" href="../glossary/#query_selector" markdown="1">query selector</a></span> is written as <code>#name</code>
and matches HTML like <code>&lt;tag id="name"&gt;...&lt;/tag&gt;</code> (where <code>tag</code> is <code>row</code> or <code>col</code>):</p>
<div class="code-sample lang-js" title="micro-css.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">IdRule</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">CssRule</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span><span class="w"> </span><span class="nx">styles</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">selector</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">selector</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1</span><span class="p">),</span>
<span class="w">      </span><span class="sb">`ID rule </span><span class="si">${</span><span class="nx">selector</span><span class="si">}</span><span class="sb"> must start with # and have a selector`</span><span class="p">)</span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span><span class="nx">IdRule</span><span class="p">.</span><span class="nx">ORDER</span><span class="p">,</span><span class="w"> </span><span class="nx">selector</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">),</span><span class="w"> </span><span class="nx">styles</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">match</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;attributes&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">selector</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
<span class="nx">IdRule</span><span class="p">.</span><span class="nx">ORDER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span>
</code></pre></div>
</div>
<p>A class rule&rsquo;s query selector is written as <code>.kind</code> and matches HTML like <code>&lt;tag class="kind"&gt;...&lt;/tag&gt;</code>.
Unlike real CSS,
we only allow one class per node:</p>
<div class="code-sample lang-js" title="micro-css.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">ClassRule</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">CssRule</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span><span class="w"> </span><span class="nx">styles</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">(</span><span class="nx">selector</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">selector</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1</span><span class="p">),</span>
<span class="w">      </span><span class="sb">`Class rule </span><span class="si">${</span><span class="nx">selector</span><span class="si">}</span><span class="sb"> must start with . and have a selector`</span><span class="p">)</span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span><span class="nx">ClassRule</span><span class="p">.</span><span class="nx">ORDER</span><span class="p">,</span><span class="w"> </span><span class="nx">selector</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">),</span><span class="w"> </span><span class="nx">styles</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">match</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;attributes&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="p">(</span><span class="s1">&#39;class&#39;</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">      </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">attributes</span><span class="p">.</span><span class="kd">class</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">selector</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
<span class="nx">ClassRule</span><span class="p">.</span><span class="nx">ORDER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1</span>
</code></pre></div>
</div>
<p>Finally,
tag rules just have the name of the type of node they apply to without any punctuation:</p>
<div class="code-sample lang-js" title="micro-css.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">TagRule</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">CssRule</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span><span class="w"> </span><span class="nx">styles</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">(</span><span class="nx">TagRule</span><span class="p">.</span><span class="nx">ORDER</span><span class="p">,</span><span class="w"> </span><span class="nx">selector</span><span class="p">,</span><span class="w"> </span><span class="nx">styles</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">match</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">selector</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">node</span><span class="p">.</span><span class="nx">tag</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
<span class="nx">TagRule</span><span class="p">.</span><span class="nx">ORDER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2</span>
</code></pre></div>
</div>
<p>We could build yet another parser to read a subset of CSS and convert it to objects,
but this chapter is long enough,
so we will write our rules as JSON:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="s1">&#39;row&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="mf">20</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="s1">&#39;.kind&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="w"> </span><span class="p">},</span>
<span class="w">  </span><span class="s1">&#39;#name&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p class="continue">and build a class that converts this representation to a set of objects:</p>
<div class="code-sample lang-js" title="micro-css.js">
<div class="highlight"><pre><span></span><code><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">CssRuleSet</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="p">,</span><span class="w"> </span><span class="nx">mergeDefaults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">jsonToRules</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">jsonToRules</span><span class="w"> </span><span class="p">(</span><span class="nx">json</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">json</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">selector</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">assert</span><span class="p">((</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">selector</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="nx">selector</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0</span><span class="p">),</span>
<span class="w">        </span><span class="s1">&#39;Require non-empty string as selector&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">selector</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">IdRule</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span><span class="w"> </span><span class="nx">json</span><span class="p">[</span><span class="nx">selector</span><span class="p">])</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">selector</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ClassRule</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span><span class="w"> </span><span class="nx">json</span><span class="p">[</span><span class="nx">selector</span><span class="p">])</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">TagRule</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span><span class="w"> </span><span class="nx">json</span><span class="p">[</span><span class="nx">selector</span><span class="p">])</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">findRules</span><span class="w"> </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">matches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">rules</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">rule</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">rule</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">node</span><span class="p">))</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">sorted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">matches</span><span class="p">.</span><span class="nx">sort</span><span class="p">((</span><span class="nx">left</span><span class="p">,</span><span class="w"> </span><span class="nx">right</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">left</span><span class="p">.</span><span class="nx">order</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">right</span><span class="p">.</span><span class="nx">order</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sorted</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</div>
<p>Our CSS ruleset class also has a method for finding the rules for a given DOM node.
This method relies on the precedence values we defined for our classes
in order to sort them
so that we can find the most specific.</p>
<p>Here&rsquo;s our final set of tests:</p>
<div class="code-sample lang-js" title="test-styled.js">
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">it</span><span class="p">(</span><span class="s1">&#39;styles a tree of nodes with multiple rules&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">html</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s1">&#39;&lt;col id=&quot;name&quot;&gt;&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;&lt;row class=&quot;kind&quot;&gt;first\nsecond&lt;/row&gt;&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;&lt;row&gt;third\nfourth&lt;/row&gt;&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;&lt;/col&gt;&#39;</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">dom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parseHTML</span><span class="p">(</span><span class="nx">html</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">CssRuleSet</span><span class="p">({</span>
<span class="w">      </span><span class="s1">&#39;.kind&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="s1">&#39;#name&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="w"> </span><span class="p">},</span>
<span class="w">      </span><span class="nx">row</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">    </span><span class="nx">dom</span><span class="p">.</span><span class="nx">findRules</span><span class="p">(</span><span class="nx">rules</span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">dom</span><span class="p">.</span><span class="nx">rules</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">IdRule</span><span class="p">(</span><span class="s1">&#39;#name&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">])</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">dom</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">rules</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">ClassRule</span><span class="p">(</span><span class="s1">&#39;.kind&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">height</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="p">}),</span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">TagRule</span><span class="p">(</span><span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">])</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">deepStrictEqual</span><span class="p">(</span><span class="nx">dom</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mf">1</span><span class="p">].</span><span class="nx">rules</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="ow">new</span><span class="w"> </span><span class="nx">TagRule</span><span class="p">(</span><span class="s1">&#39;row&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">width</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="p">])</span>
<span class="w">  </span><span class="p">})</span>
</code></pre></div>
</div>
<p>If we were going on,
we would override the cells&rsquo; <code>getWidth</code> and <code>getHeight</code> methods to pay attention to styles.
We would also decide what to do with cells that don&rsquo;t have any styles defined:
use a default,
flag it as an error,
or make a choice based on the contents of the child nodes.
We will explore these possibilities in the exercises.</p>
<div class="callout">
<h3>Where it all started</h3>
<p>This chapter&rsquo;s topic was one of the seeds from which this entire book grew
(the other being debuggers discussed in <a class="x-ref" href="../debugger/">Chapter 20</a>).
After struggling with <span class="ix-entry" ix-key="CSS!struggles with" markdown="1">CSS</span> for several years,
I began wondering whether it really had to be so complicated.
That question led to others,
which eventually led to all of this.
The moral is,
be careful what you ask.</p>
</div>
<h2 id="layout-engine-exercises">Section 11.7: Exercises</h2>
<h3 class="exercise">Refactoring the node classes</h3>
<p>Refactor the classes used to represent blocks, rows, and columns so that:</p>
<ol>
<li>
<p>They all derive from a common parent.</p>
</li>
<li>
<p>All common behavior is defined in that parent (if only with placeholder methods).</p>
</li>
</ol>
<h3 class="exercise">Handling rule conflicts</h3>
<p>Modify the rule lookup mechanism so that if two conflicting rules are defined,
the one that is defined second takes precedence.
For example,
if there are two definitions for <code>row.bold</code>,
whichever comes last in the JSON representation of the CSS wins.</p>
<h3 class="exercise">Handling arbitrary tags</h3>
<p>Modify the existing code to handle arbitrary HTML elements.</p>
<ol>
<li>
<p>The parser should recognize <code>&lt;anyTag&gt;...&lt;/anyTag&gt;</code>.</p>
</li>
<li>
<p>Instead of separate classes for rows and columns,
    there should be one class <code>Node</code> whose <code>tag</code> attribute identifies its type.</p>
</li>
</ol>
<h3 class="exercise">Recycling nodes</h3>
<p>Modify the wrapping code so that new rows and columns are only created if needed.
For example,
if a row of width 10 contains a text node with the string &ldquo;fits&rdquo;,
a new row and column are <em>not</em> inserted.</p>
<h3 class="exercise">Rendering a clear background</h3>
<p>Modify the rendering code so that only the text in block nodes is shown,
i.e.,
so that the empty space in rows and columns is rendered as spaces.</p>
<h3 class="exercise">Clipping text</h3>
<ol>
<li>
<p>Modify the wrapping and rendering so that
    if a block of text is too wide for the available space
    the extra characters are clipped.
    For example,
    if a column of width 5 contains a line &ldquo;unfittable&rdquo;,
    only &ldquo;unfit&rdquo; appears.</p>
</li>
<li>
<p>Extend your solution to break lines on spaces as needed
    in order to avoid clipping.</p>
</li>
</ol>
<h3 class="exercise">Bidirectional rendering</h3>
<p>Modify the existing software to do either left-to-right or right-to-left rendering
upon request.</p>
<h3 class="exercise">Equal sizing</h3>
<p>Modify the existing code to support elastic columns,
i.e.,
so that all of the columns in a row are automatically sized to have the same width.
If the number of columns does not divide evenly into the width of the row,
allocate the extra space as equally as possible from left to right.</p>
<h3 class="exercise">Padding elements</h3>
<p>Modify the existing code so that:</p>
<ol>
<li>
<p>Authors can define a <code>padding</code> attribute for row and column elements.</p>
</li>
<li>
<p>When the node is rendered, that many blank spaces are added on all four sides of the contents.</p>
</li>
</ol>
<p class="continue">For example, the HTML <code>&lt;row&gt;text&lt;/row&gt;</code> would render as:</p>
<div class="highlight"><pre><span></span><code>+------+
|      |
| text |
|      |
+------+
</code></pre></div>
<p class="continue">where the lines show the outer border of the rendering.</p>
<h3 class="exercise">Drawing borders</h3>
<ol>
<li>
<p>Modify the existing code so that elements may specify <code>border: true</code> or <code>border: false</code>
    (with the latter being the default).
    If an element&rsquo;s <code>border</code> property is <code>true</code>,
    it is drawn with a dashed border.
    For example,
    if the <code>border</code> property of <code>row</code> is <code>true</code>,
    then <code>&lt;row&gt;text&lt;/row&gt;</code> is rendered as:</p>
<div class="highlight"><pre><span></span><code>+----+
|text|
+----+
</code></pre></div>
</li>
<li>
<p>Extend your solution so that if two adjacent cells both have borders,
    only a single border is drawn.
    For example,
    if the <code>border</code> property of <code>col</code> is <code>true</code>,
    then:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">row</span><span class="p">&gt;&lt;</span><span class="nt">col</span><span class="p">&gt;</span>left<span class="p">&lt;/</span><span class="nt">col</span><span class="p">&gt;&lt;</span><span class="nt">col</span><span class="p">&gt;</span>right<span class="p">&lt;/</span><span class="nt">col</span><span class="p">&gt;&lt;/</span><span class="nt">row</span><span class="p">&gt;</span>
</code></pre></div>
<p class="continue">is rendered as:</p>
<div class="highlight"><pre><span></span><code>+----+-----+
|left|right|
+----+-----+
</code></pre></div>
</li>
</ol>
          
        </main>
      </div>
    </div>
  </body>
</html>

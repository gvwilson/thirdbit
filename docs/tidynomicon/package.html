<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Creating Packages | The Tidynomicon</title>
  <meta name="description" content="Chapter 5 Creating Packages | The Tidynomicon" />
  <meta name="generator" content="bookdown 0.19 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Creating Packages | The Tidynomicon" />
  <meta property="og:type" content="book" />
  
  <meta name="github-repo" content="gvwilson/tidynomicon" />

  
  

<meta name="author" content="Greg Wilson" />


<meta name="date" content="2021-01-11" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="rmarkdown.html"/>
<link rel="next" href="nse.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/kePrint-0.0.1/kePrint.js"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { background-color: #f8f8f8; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
<!-- <script defer data-domain="third-bit.com" src="https://plausible.io/js/plausible.js"></script> -->
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">The Tidynomicon</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#s:index-personas"><i class="fa fa-check"></i><b>1.1</b> Who are these lessons for?</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#s:index-install"><i class="fa fa-check"></i><b>1.2</b> How do I get started?</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="basics.html"><a href="basics.html"><i class="fa fa-check"></i><b>2</b> Simple Beginnings</a><ul>
<li class="chapter" data-level="2.1" data-path="basics.html"><a href="basics.html#learning-objectives"><i class="fa fa-check"></i><b>2.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="2.2" data-path="basics.html"><a href="basics.html#how-do-i-say-hello"><i class="fa fa-check"></i><b>2.2</b> How do I say hello?</a></li>
<li class="chapter" data-level="2.3" data-path="basics.html"><a href="basics.html#how-do-i-add-numbers"><i class="fa fa-check"></i><b>2.3</b> How do I add numbers?</a></li>
<li class="chapter" data-level="2.4" data-path="basics.html"><a href="basics.html#how-do-i-store-many-numbers-together"><i class="fa fa-check"></i><b>2.4</b> How do I store many numbers together?</a></li>
<li class="chapter" data-level="2.5" data-path="basics.html"><a href="basics.html#how-do-i-index-a-vector"><i class="fa fa-check"></i><b>2.5</b> How do I index a vector?</a></li>
<li class="chapter" data-level="2.6" data-path="basics.html"><a href="basics.html#how-do-i-create-new-vectors-from-old"><i class="fa fa-check"></i><b>2.6</b> How do I create new vectors from old?</a></li>
<li class="chapter" data-level="2.7" data-path="basics.html"><a href="basics.html#how-else-does-r-represent-the-absence-of-data"><i class="fa fa-check"></i><b>2.7</b> How else does R represent the absence of data?</a></li>
<li class="chapter" data-level="2.8" data-path="basics.html"><a href="basics.html#how-can-i-store-a-mix-of-different-types-of-objects"><i class="fa fa-check"></i><b>2.8</b> How can I store a mix of different types of objects?</a></li>
<li class="chapter" data-level="2.9" data-path="basics.html"><a href="basics.html#what-is-the-difference-between-and"><i class="fa fa-check"></i><b>2.9</b> What is the difference between <code>[</code> and <code>[[</code>?</a></li>
<li class="chapter" data-level="2.10" data-path="basics.html"><a href="basics.html#how-can-i-access-elements-by-name"><i class="fa fa-check"></i><b>2.10</b> How can I access elements by name?</a></li>
<li class="chapter" data-level="2.11" data-path="basics.html"><a href="basics.html#how-can-i-create-and-index-a-matrix"><i class="fa fa-check"></i><b>2.11</b> How can I create and index a matrix?</a></li>
<li class="chapter" data-level="2.12" data-path="basics.html"><a href="basics.html#how-do-i-choose-and-repeat-things"><i class="fa fa-check"></i><b>2.12</b> How do I choose and repeat things?</a></li>
<li class="chapter" data-level="2.13" data-path="basics.html"><a href="basics.html#how-can-i-vectorize-loops-and-conditionals"><i class="fa fa-check"></i><b>2.13</b> How can I vectorize loops and conditionals?</a></li>
<li class="chapter" data-level="2.14" data-path="basics.html"><a href="basics.html#how-can-i-express-a-range-of-values"><i class="fa fa-check"></i><b>2.14</b> How can I express a range of values?</a></li>
<li class="chapter" data-level="2.15" data-path="basics.html"><a href="basics.html#how-can-i-use-a-vector-in-a-conditional-statement"><i class="fa fa-check"></i><b>2.15</b> How can I use a vector in a conditional statement?</a></li>
<li class="chapter" data-level="2.16" data-path="basics.html"><a href="basics.html#how-do-i-create-and-call-functions"><i class="fa fa-check"></i><b>2.16</b> How do I create and call functions?</a></li>
<li class="chapter" data-level="2.17" data-path="basics.html"><a href="basics.html#how-can-i-write-a-function-that-takes-variable-arguments"><i class="fa fa-check"></i><b>2.17</b> How can I write a function that takes variable arguments?</a></li>
<li class="chapter" data-level="2.18" data-path="basics.html"><a href="basics.html#how-can-i-provide-default-values-for-arguments"><i class="fa fa-check"></i><b>2.18</b> How can I provide default values for arguments?</a></li>
<li class="chapter" data-level="2.19" data-path="basics.html"><a href="basics.html#how-can-i-hide-the-value-that-r-returns"><i class="fa fa-check"></i><b>2.19</b> How can I hide the value that R returns?</a></li>
<li class="chapter" data-level="2.20" data-path="basics.html"><a href="basics.html#how-can-i-assign-to-a-global-variable-from-inside-a-function"><i class="fa fa-check"></i><b>2.20</b> How can I assign to a global variable from inside a function?</a></li>
<li class="chapter" data-level="2.21" data-path="basics.html"><a href="basics.html#key-points"><i class="fa fa-check"></i><b>2.21</b> Key Points</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="tidyverse.html"><a href="tidyverse.html"><i class="fa fa-check"></i><b>3</b> The Tidyverse</a><ul>
<li class="chapter" data-level="3.1" data-path="tidyverse.html"><a href="tidyverse.html#learning-objectives-1"><i class="fa fa-check"></i><b>3.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="3.2" data-path="tidyverse.html"><a href="tidyverse.html#how-do-i-read-data"><i class="fa fa-check"></i><b>3.2</b> How do I read data?</a></li>
<li class="chapter" data-level="3.3" data-path="tidyverse.html"><a href="tidyverse.html#how-do-i-inspect-data"><i class="fa fa-check"></i><b>3.3</b> How do I inspect data?</a></li>
<li class="chapter" data-level="3.4" data-path="tidyverse.html"><a href="tidyverse.html#how-do-i-index-rows-and-columns"><i class="fa fa-check"></i><b>3.4</b> How do I index rows and columns?</a></li>
<li class="chapter" data-level="3.5" data-path="tidyverse.html"><a href="tidyverse.html#how-do-i-calculate-basic-statistics"><i class="fa fa-check"></i><b>3.5</b> How do I calculate basic statistics?</a></li>
<li class="chapter" data-level="3.6" data-path="tidyverse.html"><a href="tidyverse.html#how-do-i-filter-data"><i class="fa fa-check"></i><b>3.6</b> How do I filter data?</a></li>
<li class="chapter" data-level="3.7" data-path="tidyverse.html"><a href="tidyverse.html#how-do-i-write-tidy-code"><i class="fa fa-check"></i><b>3.7</b> How do I write tidy code?</a></li>
<li class="chapter" data-level="3.8" data-path="tidyverse.html"><a href="tidyverse.html#how-do-i-model-my-data"><i class="fa fa-check"></i><b>3.8</b> How do I model my data?</a></li>
<li class="chapter" data-level="3.9" data-path="tidyverse.html"><a href="tidyverse.html#how-do-i-create-a-plot"><i class="fa fa-check"></i><b>3.9</b> How do I create a plot?</a></li>
<li class="chapter" data-level="3.10" data-path="tidyverse.html"><a href="tidyverse.html#do-i-need-more-practice-with-the-tidyverse"><i class="fa fa-check"></i><b>3.10</b> Do I need more practice with the tidyverse?</a></li>
<li class="chapter" data-level="3.11" data-path="tidyverse.html"><a href="tidyverse.html#key-points-1"><i class="fa fa-check"></i><b>3.11</b> Key Points</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="rmarkdown.html"><a href="rmarkdown.html"><i class="fa fa-check"></i><b>4</b> Creating Reports</a><ul>
<li class="chapter" data-level="4.1" data-path="rmarkdown.html"><a href="rmarkdown.html#learning-objectives-2"><i class="fa fa-check"></i><b>4.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="4.2" data-path="rmarkdown.html"><a href="rmarkdown.html#how-can-i-create-and-preview-a-simple-page"><i class="fa fa-check"></i><b>4.2</b> How can I create and preview a simple page?</a></li>
<li class="chapter" data-level="4.3" data-path="rmarkdown.html"><a href="rmarkdown.html#how-can-i-run-code-and-include-its-output-in-a-page"><i class="fa fa-check"></i><b>4.3</b> How can I run code and include its output in a page?</a></li>
<li class="chapter" data-level="4.4" data-path="rmarkdown.html"><a href="rmarkdown.html#how-can-i-format-tables-in-a-page"><i class="fa fa-check"></i><b>4.4</b> How can I format tables in a page?</a></li>
<li class="chapter" data-level="4.5" data-path="rmarkdown.html"><a href="rmarkdown.html#how-can-i-share-code-between-pages"><i class="fa fa-check"></i><b>4.5</b> How can I share code between pages?</a></li>
<li class="chapter" data-level="4.6" data-path="rmarkdown.html"><a href="rmarkdown.html#how-can-i-parameterize-documents"><i class="fa fa-check"></i><b>4.6</b> How can I parameterize documents?</a></li>
<li class="chapter" data-level="4.7" data-path="rmarkdown.html"><a href="rmarkdown.html#how-can-i-publish-pages-on-github"><i class="fa fa-check"></i><b>4.7</b> How can I publish pages on GitHub?</a></li>
<li class="chapter" data-level="4.8" data-path="rmarkdown.html"><a href="rmarkdown.html#key-points-2"><i class="fa fa-check"></i><b>4.8</b> Key Points</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="package.html"><a href="package.html"><i class="fa fa-check"></i><b>5</b> Creating Packages</a><ul>
<li class="chapter" data-level="5.1" data-path="package.html"><a href="package.html#learning-objectives-3"><i class="fa fa-check"></i><b>5.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="5.2" data-path="package.html"><a href="package.html#what-is-our-starting-point"><i class="fa fa-check"></i><b>5.2</b> What is our starting point?</a></li>
<li class="chapter" data-level="5.3" data-path="package.html"><a href="package.html#how-do-i-convert-values-to-numbers"><i class="fa fa-check"></i><b>5.3</b> How do I convert values to numbers?</a></li>
<li class="chapter" data-level="5.4" data-path="package.html"><a href="package.html#how-do-i-reorganize-the-columns"><i class="fa fa-check"></i><b>5.4</b> How do I reorganize the columns?</a></li>
<li class="chapter" data-level="5.5" data-path="package.html"><a href="package.html#how-do-i-create-a-package"><i class="fa fa-check"></i><b>5.5</b> How do I create a package?</a></li>
<li class="chapter" data-level="5.6" data-path="package.html"><a href="package.html#how-can-i-document-the-contents-of-a-package"><i class="fa fa-check"></i><b>5.6</b> How can I document the contents of a package?</a></li>
<li class="chapter" data-level="5.7" data-path="package.html"><a href="package.html#how-can-my-package-import-what-it-needs"><i class="fa fa-check"></i><b>5.7</b> How can my package import what it needs?</a></li>
<li class="chapter" data-level="5.8" data-path="package.html"><a href="package.html#how-can-i-add-data-to-a-package"><i class="fa fa-check"></i><b>5.8</b> How can I add data to a package?</a></li>
<li class="chapter" data-level="5.9" data-path="package.html"><a href="package.html#key-points-3"><i class="fa fa-check"></i><b>5.9</b> Key Points</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="nse.html"><a href="nse.html"><i class="fa fa-check"></i><b>6</b> Non-Standard Evaluation</a><ul>
<li class="chapter" data-level="6.1" data-path="nse.html"><a href="nse.html#learning-objectives-4"><i class="fa fa-check"></i><b>6.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="6.2" data-path="nse.html"><a href="nse.html#how-does-python-evaluate-function-calls"><i class="fa fa-check"></i><b>6.2</b> How does Python evaluate function calls?</a></li>
<li class="chapter" data-level="6.3" data-path="nse.html"><a href="nse.html#how-does-r-evaluate-function-calls"><i class="fa fa-check"></i><b>6.3</b> How does R evaluate function calls?</a></li>
<li class="chapter" data-level="6.4" data-path="nse.html"><a href="nse.html#why-is-lazy-evaluation-useful"><i class="fa fa-check"></i><b>6.4</b> Why is lazy evaluation useful?</a></li>
<li class="chapter" data-level="6.5" data-path="nse.html"><a href="nse.html#what-is-tidy-evaluation"><i class="fa fa-check"></i><b>6.5</b> What is tidy evaluation?</a></li>
<li class="chapter" data-level="6.6" data-path="nse.html"><a href="nse.html#what-if-i-truly-desire-to-venture-into-the-depths"><i class="fa fa-check"></i><b>6.6</b> What if I truly desire to venture into the depths?</a></li>
<li class="chapter" data-level="6.7" data-path="nse.html"><a href="nse.html#is-it-worth-it"><i class="fa fa-check"></i><b>6.7</b> Is it worth it?</a></li>
<li class="chapter" data-level="6.8" data-path="nse.html"><a href="nse.html#key-points-4"><i class="fa fa-check"></i><b>6.8</b> Key Points</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="debt.html"><a href="debt.html"><i class="fa fa-check"></i><b>7</b> Intellectual Debt</a><ul>
<li class="chapter" data-level="7.1" data-path="debt.html"><a href="debt.html#learning-objectives-5"><i class="fa fa-check"></i><b>7.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="7.2" data-path="debt.html"><a href="debt.html#why-shouldnt-i-use-setwd"><i class="fa fa-check"></i><b>7.2</b> Why shouldn’t I use <code>setwd</code>?</a></li>
<li class="chapter" data-level="7.3" data-path="debt.html"><a href="debt.html#what-the-hell-are-factors"><i class="fa fa-check"></i><b>7.3</b> What the hell are factors?</a></li>
<li class="chapter" data-level="7.4" data-path="debt.html"><a href="debt.html#how-do-i-refer-to-various-arguments-in-a-pipeline"><i class="fa fa-check"></i><b>7.4</b> How do I refer to various arguments in a pipeline?</a></li>
<li class="chapter" data-level="7.5" data-path="debt.html"><a href="debt.html#i-thought-you-said-that-r-encouraged-functional-programming"><i class="fa fa-check"></i><b>7.5</b> I thought you said that R encouraged functional programming?</a></li>
<li class="chapter" data-level="7.6" data-path="debt.html"><a href="debt.html#how-does-r-give-the-appearance-of-immutable-data"><i class="fa fa-check"></i><b>7.6</b> How does R give the appearance of immutable data?</a></li>
<li class="chapter" data-level="7.7" data-path="debt.html"><a href="debt.html#what-else-should-i-worry-about"><i class="fa fa-check"></i><b>7.7</b> What else should I worry about?</a></li>
<li class="chapter" data-level="7.8" data-path="debt.html"><a href="debt.html#key-points-5"><i class="fa fa-check"></i><b>7.8</b> Key Points</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="testerror.html"><a href="testerror.html"><i class="fa fa-check"></i><b>8</b> Testing and Error Handling</a><ul>
<li class="chapter" data-level="8.1" data-path="testerror.html"><a href="testerror.html#learning-objectives-6"><i class="fa fa-check"></i><b>8.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="8.2" data-path="testerror.html"><a href="testerror.html#how-does-r-handle-errors"><i class="fa fa-check"></i><b>8.2</b> How does R handle errors?</a></li>
<li class="chapter" data-level="8.3" data-path="testerror.html"><a href="testerror.html#what-should-i-know-about-testing-in-general"><i class="fa fa-check"></i><b>8.3</b> What should I know about testing in general?</a></li>
<li class="chapter" data-level="8.4" data-path="testerror.html"><a href="testerror.html#how-should-i-organize-my-tests"><i class="fa fa-check"></i><b>8.4</b> How should I organize my tests?</a></li>
<li class="chapter" data-level="8.5" data-path="testerror.html"><a href="testerror.html#how-can-i-write-a-few-simple-tests"><i class="fa fa-check"></i><b>8.5</b> How can I write a few simple tests?</a></li>
<li class="chapter" data-level="8.6" data-path="testerror.html"><a href="testerror.html#how-can-i-check-data-transformation"><i class="fa fa-check"></i><b>8.6</b> How can I check data transformation?</a></li>
<li class="chapter" data-level="8.7" data-path="testerror.html"><a href="testerror.html#key-points-6"><i class="fa fa-check"></i><b>8.7</b> Key Points</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="advanced.html"><a href="advanced.html"><i class="fa fa-check"></i><b>9</b> Advanced Topics</a><ul>
<li class="chapter" data-level="9.1" data-path="advanced.html"><a href="advanced.html#learning-objectives-7"><i class="fa fa-check"></i><b>9.1</b> Learning Objectives</a></li>
<li class="chapter" data-level="9.2" data-path="advanced.html"><a href="advanced.html#how-can-i-use-python-with-r"><i class="fa fa-check"></i><b>9.2</b> How can I use Python with R?</a></li>
<li class="chapter" data-level="9.3" data-path="advanced.html"><a href="advanced.html#how-does-object-oriented-programming-work-in-r"><i class="fa fa-check"></i><b>9.3</b> How does object-oriented programming work in R?</a></li>
<li class="chapter" data-level="9.4" data-path="advanced.html"><a href="advanced.html#how-can-i-write-web-applications-in-r"><i class="fa fa-check"></i><b>9.4</b> How can I write web applications in R?</a></li>
<li class="chapter" data-level="9.5" data-path="advanced.html"><a href="advanced.html#how-can-i-work-with-relational-databases-in-r"><i class="fa fa-check"></i><b>9.5</b> How can I work with relational databases in R?</a></li>
<li class="chapter" data-level="9.6" data-path="advanced.html"><a href="advanced.html#key-points-7"><i class="fa fa-check"></i><b>9.6</b> Key Points</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="license.html"><a href="license.html"><i class="fa fa-check"></i><b>A</b> License</a></li>
<li class="chapter" data-level="B" data-path="code-of-conduct.html"><a href="code-of-conduct.html"><i class="fa fa-check"></i><b>B</b> Code of Conduct</a><ul>
<li class="chapter" data-level="B.1" data-path="code-of-conduct.html"><a href="code-of-conduct.html#our-standards"><i class="fa fa-check"></i><b>B.1</b> Our Standards</a></li>
<li class="chapter" data-level="B.2" data-path="code-of-conduct.html"><a href="code-of-conduct.html#our-responsibilities"><i class="fa fa-check"></i><b>B.2</b> Our Responsibilities</a></li>
<li class="chapter" data-level="B.3" data-path="code-of-conduct.html"><a href="code-of-conduct.html#scope"><i class="fa fa-check"></i><b>B.3</b> Scope</a></li>
<li class="chapter" data-level="B.4" data-path="code-of-conduct.html"><a href="code-of-conduct.html#enforcement"><i class="fa fa-check"></i><b>B.4</b> Enforcement</a></li>
<li class="chapter" data-level="B.5" data-path="code-of-conduct.html"><a href="code-of-conduct.html#attribution"><i class="fa fa-check"></i><b>B.5</b> Attribution</a></li>
</ul></li>
<li class="chapter" data-level="C" data-path="citation.html"><a href="citation.html"><i class="fa fa-check"></i><b>C</b> Citation</a></li>
<li class="chapter" data-level="D" data-path="contributing.html"><a href="contributing.html"><i class="fa fa-check"></i><b>D</b> Contributing</a></li>
<li class="chapter" data-level="E" data-path="practice.html"><a href="practice.html"><i class="fa fa-check"></i><b>E</b> Practice Problems</a><ul>
<li class="chapter" data-level="E.1" data-path="practice.html"><a href="practice.html#do-i-need-even-more-practice"><i class="fa fa-check"></i><b>E.1</b> Do I need even more practice?</a></li>
<li class="chapter" data-level="E.2" data-path="practice.html"><a href="practice.html#please-may-i-create-some-charts"><i class="fa fa-check"></i><b>E.2</b> Please may I create some charts?</a></li>
</ul></li>
<li class="chapter" data-level="F" data-path="glossary.html"><a href="glossary.html"><i class="fa fa-check"></i><b>F</b> Glossary</a></li>
<li class="chapter" data-level="G" data-path="keypoints.html"><a href="keypoints.html"><i class="fa fa-check"></i><b>G</b> Key Points</a><ul>
<li class="chapter" data-level="G.1" data-path="keypoints.html"><a href="keypoints.html#simple-beginnings"><i class="fa fa-check"></i><b>G.1</b> Simple Beginnings</a></li>
<li class="chapter" data-level="G.2" data-path="keypoints.html"><a href="keypoints.html#the-tidyverse"><i class="fa fa-check"></i><b>G.2</b> The Tidyverse</a></li>
<li class="chapter" data-level="G.3" data-path="keypoints.html"><a href="keypoints.html#creating-packages"><i class="fa fa-check"></i><b>G.3</b> Creating Packages</a></li>
<li class="chapter" data-level="G.4" data-path="keypoints.html"><a href="keypoints.html#non-standard-evaluation"><i class="fa fa-check"></i><b>G.4</b> Non-Standard Evaluation</a></li>
<li class="chapter" data-level="G.5" data-path="keypoints.html"><a href="keypoints.html#intellectual-debt"><i class="fa fa-check"></i><b>G.5</b> Intellectual Debt</a></li>
<li class="chapter" data-level="G.6" data-path="keypoints.html"><a href="keypoints.html#testing-and-error-handling"><i class="fa fa-check"></i><b>G.6</b> Testing and Error Handling</a></li>
<li class="chapter" data-level="G.7" data-path="keypoints.html"><a href="keypoints.html#advanced-topics"><i class="fa fa-check"></i><b>G.7</b> Advanced Topics</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">The Tidynomicon</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="package" class="section level1">
<h1><span class="header-section-number">Chapter 5</span> Creating Packages</h1>
<p>Data is not born tidy.
We must cleanse it to make it serve our needs.
The previous chapter gave us the tools;
here,
we will see how to apply them
and how to make our work usable by others.</p>
<div id="learning-objectives-3" class="section level2">
<h2><span class="header-section-number">5.1</span> Learning Objectives</h2>
<ul>
<li>Describe and use the <code>read_csv</code> function.</li>
<li>Describe and use the <code>str_replace</code> function.</li>
<li>Describe and use the <code>is.numeric</code> and <code>as.numeric</code> functions.</li>
<li>Describe and use the <code>map</code> function and its kin.</li>
<li>Describe and use pre-allocation to capture the results of loops.</li>
<li>Describe the three things an R package can contain.</li>
<li>Explain how R code in a package is distributed and one implication of this.</li>
<li>Explain the purpose of the <code>DESCRIPTION</code>, <code>NAMESPACE</code> and <code>.Rbuildignore</code> files in an R project.</li>
<li>Explain what should be put in the <code>R</code>, <code>data</code>, <code>man</code>, and <code>tests</code> directories of an R project.</li>
<li>Describe and use specially-formatted comments with roxygen2 to document a package.</li>
<li>Use <code>@export</code> and <code>@import</code> directives correctly in roxygen2 documentation.</li>
<li>Add a dataset to an R package.</li>
<li>Use functions from external libraries inside a package in a hygienic way.</li>
<li>Rewrite references to bare column names to satisfy R’s packaging checks.</li>
<li>Correctly document the package as a whole and the datasets it contains.</li>
</ul>
</div>
<div id="what-is-our-starting-point" class="section level2">
<h2><span class="header-section-number">5.2</span> What is our starting point?</h2>
<p>Here is a sample of data from the original data set <code>data/infant_hiv.csv</code>,
where <code>...</code> shows values elided to make the segment readable:</p>
<pre><code>&quot;Early Infant Diagnosis: Percentage of infants born to women living with HIV...&quot;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
,,2009,,,2010,,,2011,,,2012,,,2013,,,2014,,,2015,,,2016,,,2017,,,
ISO3,Countries,Estimate,hi,lo,Estimate,hi,lo,Estimate,hi,lo,Estimate,hi,lo,...
AFG,Afghanistan,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,
ALB,Albania,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,
DZA,Algeria,-,-,-,-,-,-,38%,42%,35%,23%,25%,21%,55%,60%,50%,27%,30%,25%,23%,25%,21%,33%,37%,31%,61%,68%,57%,
AGO,Angola,-,-,-,3%,4%,2%,5%,7%,4%,6%,8%,5%,15%,20%,12%,10%,14%,8%,6%,8%,5%,1%,2%,1%,1%,2%,1%,
... many more rows ...
YEM,Yemen,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,
ZMB,Zambia,59%,70%,53%,27%,32%,24%,70%,84%,63%,74%,88%,67%,64%,76%,57%,91%,&gt;95%,81%,43%,52%,39%,43%,51%,39%,46%,54%,41%,
ZWE,Zimbabwe,-,-,-,12%,15%,10%,23%,28%,20%,38%,47%,33%,57%,70%,49%,54%,67%,47%,59%,73%,51%,71%,88%,62%,65%,81%,57%,
,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
,,2009,,,2010,,,2011,,,2012,,,2013,,,2014,,,2015,,,2016,,,2017,,,
,,Estimate,hi,lo,Estimate,hi,lo,Estimate,hi,lo,Estimate,hi,lo,...
Region,East Asia and the Pacific,25%,30%,22%,35%,42%,29%,30%,37%,26%,32%,38%,27%,28%,34%,24%,26%,31%,22%,31%,37%,27%,30%,35%,25%,28%,33%,24%,
,Eastern and Southern Africa,23%,29%,20%,44%,57%,37%,48%,62%,40%,54%,69%,46%,51%,65%,43%,62%,80%,53%,62%,79%,52%,54%,68%,45%,62%,80%,53%,
,Eastern Europe and Central Asia,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,-,
... several more rows ...
,Sub-Saharan Africa,16%,22%,13%,34%,46%,28%,37%,50%,30%,43%,57%,35%,41%,54%,33%,50%,66%,41%,50%,66%,41%,45%,60%,37%,52%,69%,42%,
,Global,17%,23%,13%,33%,45%,27%,36%,49%,29%,41%,55%,34%,40%,53%,32%,48%,64%,39%,49%,64%,40%,44%,59%,36%,51%,67%,41%,
,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Indicator definition: Percentage of infants born to women living with HIV... ,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Note: Data are not available if country did not submit data...,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Data source: Global AIDS Monitoring 2018 and UNAIDS 2018 estimates,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
&quot;For more information on this indicator, please visit the guidance:...&quot;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
&quot;For more information on the data, visit data.unicef.org&quot;,,,,,,,,,,,,,,,,,,,,,,,,,,,,,</code></pre>
<p>This is a mess—no, more than that, it is an affront to decency.
There are comments mixed with data,
values’ actual indices have to be synthesized by combining column headings from two rows
(two thirds of which have to be carried forward from previous columns),
and so on.
We want to create the tidy data found in <code>results/infant_hiv.csv</code>:</p>
<pre><code>country,year,estimate,hi,lo
AFG,2009,NA,NA,NA
AFG,2010,NA,NA,NA
AFG,2011,NA,NA,NA
AFG,2012,NA,NA,NA
...
ZWE,2016,0.71,0.88,0.62
ZWE,2017,0.65,0.81,0.57</code></pre>
</div>
<div id="how-do-i-convert-values-to-numbers" class="section level2">
<h2><span class="header-section-number">5.3</span> How do I convert values to numbers?</h2>
<p>We begin by reading the data into a tibble:</p>
<div class="sourceCode" id="cb391"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb391-1" data-line-number="1">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/infant_hiv.csv&quot;</span>)</a></code></pre></div>
<pre><code>Warning: Missing column names filled in: &#39;X2&#39; [2], &#39;X3&#39; [3], &#39;X4&#39; [4], &#39;X5&#39; [5],
&#39;X6&#39; [6], &#39;X7&#39; [7], &#39;X8&#39; [8], &#39;X9&#39; [9], &#39;X10&#39; [10], &#39;X11&#39; [11], &#39;X12&#39; [12],
&#39;X13&#39; [13], &#39;X14&#39; [14], &#39;X15&#39; [15], &#39;X16&#39; [16], &#39;X17&#39; [17], &#39;X18&#39; [18],
&#39;X19&#39; [19], &#39;X20&#39; [20], &#39;X21&#39; [21], &#39;X22&#39; [22], &#39;X23&#39; [23], &#39;X24&#39; [24],
&#39;X25&#39; [25], &#39;X26&#39; [26], &#39;X27&#39; [27], &#39;X28&#39; [28], &#39;X29&#39; [29], &#39;X30&#39; [30]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character(),
  X30 = col_logical()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<div class="sourceCode" id="cb395"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb395-1" data-line-number="1"><span class="kw">head</span>(raw)</a></code></pre></div>
<pre><code># A tibble: 6 x 30
  `Early Infant D… X2    X3    X4    X5    X6    X7    X8    X9    X10   X11  
  &lt;chr&gt;            &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;
1 &lt;NA&gt;             &lt;NA&gt;  2009  &lt;NA&gt;  &lt;NA&gt;  2010  &lt;NA&gt;  &lt;NA&gt;  2011  &lt;NA&gt;  &lt;NA&gt; 
2 ISO3             Coun… Esti… hi    lo    Esti… hi    lo    Esti… hi    lo   
3 AFG              Afgh… -     -     -     -     -     -     -     -     -    
4 ALB              Alba… -     -     -     -     -     -     -     -     -    
5 DZA              Alge… -     -     -     -     -     -     38%   42%   35%  
6 AGO              Ango… -     -     -     3%    4%    2%    5%    7%    4%   
# … with 19 more variables: X12 &lt;chr&gt;, X13 &lt;chr&gt;, X14 &lt;chr&gt;, X15 &lt;chr&gt;,
#   X16 &lt;chr&gt;, X17 &lt;chr&gt;, X18 &lt;chr&gt;, X19 &lt;chr&gt;, X20 &lt;chr&gt;, X21 &lt;chr&gt;,
#   X22 &lt;chr&gt;, X23 &lt;chr&gt;, X24 &lt;chr&gt;, X25 &lt;chr&gt;, X26 &lt;chr&gt;, X27 &lt;chr&gt;,
#   X28 &lt;chr&gt;, X29 &lt;chr&gt;, X30 &lt;lgl&gt;</code></pre>
<p>All right:
R isn’t able to infer column names,
so it uses the entire first comment string as a very long column name
and then makes up names for the other columns.
Looking at the file,
the second row has years (spaced at three-column intervals)
and the column after that has the <a href="glossary.html#iso3-country-code">ISO3 country code</a>,
the country’s name,
and then “Estimate”, “hi”, and “lo” repeated for every year.
We are going to have to combine what’s in the second and third rows,
so we’re going to have to do some work no matter which we skip or keep.
Since we want the ISO3 code and the country name,
let’s skip the first two rows.</p>
<div class="sourceCode" id="cb397"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb397-1" data-line-number="1">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>)</a></code></pre></div>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt; &#39;Estimate_1&#39; [6],
&#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt; &#39;Estimate_2&#39; [9], &#39;hi&#39;
=&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt; &#39;Estimate_3&#39; [12], &#39;hi&#39;
=&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt; &#39;Estimate_4&#39; [15], &#39;hi&#39;
=&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt; &#39;Estimate_5&#39; [18], &#39;hi&#39;
=&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt; &#39;Estimate_6&#39; [21], &#39;hi&#39;
=&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt; &#39;Estimate_7&#39; [24], &#39;hi&#39;
=&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt; &#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt;
&#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character(),
  X30 = col_logical()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<div class="sourceCode" id="cb402"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb402-1" data-line-number="1"><span class="kw">head</span>(raw)</a></code></pre></div>
<pre><code># A tibble: 6 x 30
  ISO3  Countries Estimate hi    lo    Estimate_1 hi_1  lo_1  Estimate_2 hi_2 
  &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;
1 AFG   Afghanis… -        -     -     -          -     -     -          -    
2 ALB   Albania   -        -     -     -          -     -     -          -    
3 DZA   Algeria   -        -     -     -          -     -     38%        42%  
4 AGO   Angola    -        -     -     3%         4%    2%    5%         7%   
5 AIA   Anguilla  -        -     -     -          -     -     -          -    
6 ATG   Antigua … -        -     -     -          -     -     -          -    
# … with 20 more variables: lo_2 &lt;chr&gt;, Estimate_3 &lt;chr&gt;, hi_3 &lt;chr&gt;,
#   lo_3 &lt;chr&gt;, Estimate_4 &lt;chr&gt;, hi_4 &lt;chr&gt;, lo_4 &lt;chr&gt;, Estimate_5 &lt;chr&gt;,
#   hi_5 &lt;chr&gt;, lo_5 &lt;chr&gt;, Estimate_6 &lt;chr&gt;, hi_6 &lt;chr&gt;, lo_6 &lt;chr&gt;,
#   Estimate_7 &lt;chr&gt;, hi_7 &lt;chr&gt;, lo_7 &lt;chr&gt;, Estimate_8 &lt;chr&gt;, hi_8 &lt;chr&gt;,
#   lo_8 &lt;chr&gt;, X30 &lt;lgl&gt;</code></pre>
<p>That’s a bit of an improvement,
but why are all the columns <code>character</code> instead of numbers?
This happens because:</p>
<ol style="list-style-type: decimal">
<li>our CSV file uses <code>-</code> (a single dash) to show missing data, and</li>
<li>all of our numbers end with <code>%</code>, which means those values actually <em>are</em> character strings.</li>
</ol>
<p>We will tackle the first problem by setting <code>na = c(&quot;-&quot;)</code> in our <code>read_csv</code> call
(since we should never do ourselves what a library function will do for us):</p>
<div class="sourceCode" id="cb404"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb404-1" data-line-number="1">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>))</a></code></pre></div>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt; &#39;Estimate_1&#39; [6],
&#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt; &#39;Estimate_2&#39; [9], &#39;hi&#39;
=&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt; &#39;Estimate_3&#39; [12], &#39;hi&#39;
=&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt; &#39;Estimate_4&#39; [15], &#39;hi&#39;
=&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt; &#39;Estimate_5&#39; [18], &#39;hi&#39;
=&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt; &#39;Estimate_6&#39; [21], &#39;hi&#39;
=&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt; &#39;Estimate_7&#39; [24], &#39;hi&#39;
=&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt; &#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt;
&#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character(),
  X30 = col_logical()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<div class="sourceCode" id="cb409"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb409-1" data-line-number="1"><span class="kw">head</span>(raw)</a></code></pre></div>
<pre><code># A tibble: 6 x 30
  ISO3  Countries Estimate hi    lo    Estimate_1 hi_1  lo_1  Estimate_2 hi_2 
  &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt;
1 AFG   Afghanis… &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt; 
2 ALB   Albania   &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt; 
3 DZA   Algeria   &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  38%        42%  
4 AGO   Angola    &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  3%         4%    2%    5%         7%   
5 AIA   Anguilla  &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt; 
6 ATG   Antigua … &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt; 
# … with 20 more variables: lo_2 &lt;chr&gt;, Estimate_3 &lt;chr&gt;, hi_3 &lt;chr&gt;,
#   lo_3 &lt;chr&gt;, Estimate_4 &lt;chr&gt;, hi_4 &lt;chr&gt;, lo_4 &lt;chr&gt;, Estimate_5 &lt;chr&gt;,
#   hi_5 &lt;chr&gt;, lo_5 &lt;chr&gt;, Estimate_6 &lt;chr&gt;, hi_6 &lt;chr&gt;, lo_6 &lt;chr&gt;,
#   Estimate_7 &lt;chr&gt;, hi_7 &lt;chr&gt;, lo_7 &lt;chr&gt;, Estimate_8 &lt;chr&gt;, hi_8 &lt;chr&gt;,
#   lo_8 &lt;chr&gt;, X30 &lt;lgl&gt;</code></pre>
<p>That’s progress.
We now need to strip the percentage signs and convert what’s left to numeric values.
To simplify our lives,
let’s get the <code>ISO3</code> and <code>Countries</code> columns out of the way.
We will save the ISO3 values for later use
(and because it will illustrate a point about data hygiene that we want to make later,
but which we don’t want to reveal just yet).
Rather than typing out the names of all the columns we want to keep in the call to <code>filter</code>,
we subtract the ones we want to discard:</p>
<div class="sourceCode" id="cb411"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb411-1" data-line-number="1">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>))</a></code></pre></div>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt; &#39;Estimate_1&#39; [6],
&#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt; &#39;Estimate_2&#39; [9], &#39;hi&#39;
=&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt; &#39;Estimate_3&#39; [12], &#39;hi&#39;
=&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt; &#39;Estimate_4&#39; [15], &#39;hi&#39;
=&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt; &#39;Estimate_5&#39; [18], &#39;hi&#39;
=&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt; &#39;Estimate_6&#39; [21], &#39;hi&#39;
=&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt; &#39;Estimate_7&#39; [24], &#39;hi&#39;
=&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt; &#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt;
&#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character(),
  X30 = col_logical()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<div class="sourceCode" id="cb416"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb416-1" data-line-number="1">countries &lt;-<span class="st"> </span>raw<span class="op">$</span>ISO3</a>
<a class="sourceLine" id="cb416-2" data-line-number="2">body &lt;-<span class="st"> </span>raw <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb416-3" data-line-number="3"><span class="st">  </span><span class="kw">filter</span>(<span class="op">-</span>ISO3, <span class="op">-</span>Countries)</a></code></pre></div>
<pre><code>Error: Problem with `filter()` input `..1`.
✖ invalid argument to unary operator
ℹ Input `..1` is `-ISO3`.</code></pre>
<p>In the Hollywood version of this lesson,
we would sigh heavily at this point as we realize that we should have called <code>select</code>, not <code>filter</code>.
Once we make that change,
we can move forward once again:</p>
<div class="sourceCode" id="cb418"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb418-1" data-line-number="1">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>))</a></code></pre></div>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt; &#39;Estimate_1&#39; [6],
&#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt; &#39;Estimate_2&#39; [9], &#39;hi&#39;
=&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt; &#39;Estimate_3&#39; [12], &#39;hi&#39;
=&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt; &#39;Estimate_4&#39; [15], &#39;hi&#39;
=&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt; &#39;Estimate_5&#39; [18], &#39;hi&#39;
=&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt; &#39;Estimate_6&#39; [21], &#39;hi&#39;
=&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt; &#39;Estimate_7&#39; [24], &#39;hi&#39;
=&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt; &#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt;
&#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character(),
  X30 = col_logical()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<div class="sourceCode" id="cb423"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb423-1" data-line-number="1">countries &lt;-<span class="st"> </span>raw<span class="op">$</span>ISO3</a>
<a class="sourceLine" id="cb423-2" data-line-number="2">body &lt;-<span class="st"> </span>raw <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb423-3" data-line-number="3"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>ISO3, <span class="op">-</span>Countries)</a>
<a class="sourceLine" id="cb423-4" data-line-number="4"><span class="kw">head</span>(body)</a></code></pre></div>
<pre><code># A tibble: 6 x 28
  Estimate hi    lo    Estimate_1 hi_1  lo_1  Estimate_2 hi_2  lo_2  Estimate_3
  &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;     
1 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;      
2 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;      
3 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  38%        42%   35%   23%       
4 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  3%         4%    2%    5%         7%    4%    6%        
5 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;      
6 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;      
# … with 18 more variables: hi_3 &lt;chr&gt;, lo_3 &lt;chr&gt;, Estimate_4 &lt;chr&gt;,
#   hi_4 &lt;chr&gt;, lo_4 &lt;chr&gt;, Estimate_5 &lt;chr&gt;, hi_5 &lt;chr&gt;, lo_5 &lt;chr&gt;,
#   Estimate_6 &lt;chr&gt;, hi_6 &lt;chr&gt;, lo_6 &lt;chr&gt;, Estimate_7 &lt;chr&gt;, hi_7 &lt;chr&gt;,
#   lo_7 &lt;chr&gt;, Estimate_8 &lt;chr&gt;, hi_8 &lt;chr&gt;, lo_8 &lt;chr&gt;, X30 &lt;lgl&gt;</code></pre>
<p>But wait.
Weren’t there some aggregate lines of data at the end of our input?
What happened to them?</p>
<div class="sourceCode" id="cb425"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb425-1" data-line-number="1"><span class="kw">tail</span>(countries, <span class="dt">n =</span> <span class="dv">25</span>)</a></code></pre></div>
<pre><code> [1] &quot;YEM&quot;                                                                                                                                                       
 [2] &quot;ZMB&quot;                                                                                                                                                       
 [3] &quot;ZWE&quot;                                                                                                                                                       
 [4] &quot;&quot;                                                                                                                                                          
 [5] &quot;&quot;                                                                                                                                                          
 [6] &quot;&quot;                                                                                                                                                          
 [7] &quot;Region&quot;                                                                                                                                                    
 [8] &quot;&quot;                                                                                                                                                          
 [9] &quot;&quot;                                                                                                                                                          
[10] &quot;&quot;                                                                                                                                                          
[11] &quot;&quot;                                                                                                                                                          
[12] &quot;&quot;                                                                                                                                                          
[13] &quot;&quot;                                                                                                                                                          
[14] &quot;&quot;                                                                                                                                                          
[15] &quot;&quot;                                                                                                                                                          
[16] &quot;Super-region&quot;                                                                                                                                              
[17] &quot;&quot;                                                                                                                                                          
[18] &quot;&quot;                                                                                                                                                          
[19] &quot;&quot;                                                                                                                                                          
[20] &quot;&quot;                                                                                                                                                          
[21] &quot;Indicator definition: Percentage of infants born to women living with HIV receiving a virological test for HIV within two months of birth&quot;                 
[22] &quot;Note: Data are not available if country did not submit data to Global AIDS Monitoring or if estimates of pregnant women living with HIV are not published.&quot;
[23] &quot;Data source: Global AIDS Monitoring 2018 and UNAIDS 2018 estimates&quot;                                                                                        
[24] &quot;For more information on this indicator, please visit the guidance: http://www.unaids.org/sites/default/files/media_asset/global-aids-monitoring_en.pdf&quot;    
[25] &quot;For more information on the data, visit data.unicef.org&quot;                                                                                                   </code></pre>
<p>Once again the actor playing our part on screen sighs heavily.
How are we to trim this?
Since there is only one file,
we can open the file with an editor or spreadsheet program,
scroll down,
check the line number,
and slice there.
This is a very bad idea if we’re planning to use this script on other files—we should
instead look for the first blank line or the entry for Zimbabwe or something like that—but
let’s revisit the problem once we have our data in place.</p>
<div class="sourceCode" id="cb427"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb427-1" data-line-number="1">num_rows &lt;-<span class="st"> </span><span class="dv">192</span></a>
<a class="sourceLine" id="cb427-2" data-line-number="2">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>))</a></code></pre></div>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt; &#39;Estimate_1&#39; [6],
&#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt; &#39;Estimate_2&#39; [9], &#39;hi&#39;
=&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt; &#39;Estimate_3&#39; [12], &#39;hi&#39;
=&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt; &#39;Estimate_4&#39; [15], &#39;hi&#39;
=&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt; &#39;Estimate_5&#39; [18], &#39;hi&#39;
=&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt; &#39;Estimate_6&#39; [21], &#39;hi&#39;
=&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt; &#39;Estimate_7&#39; [24], &#39;hi&#39;
=&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt; &#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt;
&#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character(),
  X30 = col_logical()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<div class="sourceCode" id="cb432"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb432-1" data-line-number="1">sliced &lt;-<span class="st"> </span><span class="kw">slice</span>(raw, <span class="dv">1</span><span class="op">:</span>num_rows)</a>
<a class="sourceLine" id="cb432-2" data-line-number="2">countries &lt;-<span class="st"> </span>sliced<span class="op">$</span>ISO3</a>
<a class="sourceLine" id="cb432-3" data-line-number="3"><span class="kw">tail</span>(countries, <span class="dt">n =</span> <span class="dv">5</span>)</a></code></pre></div>
<pre><code>[1] &quot;VEN&quot; &quot;VNM&quot; &quot;YEM&quot; &quot;ZMB&quot; &quot;ZWE&quot;</code></pre>
<p>Notice that we’re counting rows <em>not including</em> the two we’re skipping,
which means that the 192 in the call to <code>slice</code> above corresponds to row 195 of our original data:
195, not 194, because we’re using the first row of unskipped data as headers and yes,
you are in fact making that faint whimpering sound you now hear.
You will hear it often when dealing with real-world data…</p>
<p>Notice also that we are slicing, <em>then</em> extracting the column containing the countries.
In an earlier version of this lesson we peeled off the ISO3 country codes,
sliced that vector,
and then wondered why our main table still had unwanted data at the end.
Vigilance, my friends—vigilance shall be our watchword,
and in light of that,
we shall first test our plan for converting our strings to numbers:</p>
<div class="sourceCode" id="cb434"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb434-1" data-line-number="1">fixture &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="ot">NA</span>, <span class="st">&quot;1%&quot;</span>, <span class="st">&quot;10%&quot;</span>, <span class="st">&quot;100%&quot;</span>)</a>
<a class="sourceLine" id="cb434-2" data-line-number="2">result &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">str_replace</span>(fixture, <span class="st">&quot;%&quot;</span>, <span class="st">&quot;&quot;</span>)) <span class="op">/</span><span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb434-3" data-line-number="3">result</a></code></pre></div>
<pre><code>[1]   NA 0.01 0.10 1.00</code></pre>
<p>And as a further check:</p>
<div class="sourceCode" id="cb436"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb436-1" data-line-number="1"><span class="kw">is.numeric</span>(result)</a></code></pre></div>
<pre><code>[1] TRUE</code></pre>
<p>The function <code>is.numeric</code> is <code>TRUE</code> for both <code>NA</code> and actual numbers,
so it is doing the right thing here,
and so are we.
Our updated conversion script is now:</p>
<div class="sourceCode" id="cb438"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb438-1" data-line-number="1">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>))</a></code></pre></div>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt; &#39;Estimate_1&#39; [6],
&#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt; &#39;Estimate_2&#39; [9], &#39;hi&#39;
=&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt; &#39;Estimate_3&#39; [12], &#39;hi&#39;
=&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt; &#39;Estimate_4&#39; [15], &#39;hi&#39;
=&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt; &#39;Estimate_5&#39; [18], &#39;hi&#39;
=&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt; &#39;Estimate_6&#39; [21], &#39;hi&#39;
=&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt; &#39;Estimate_7&#39; [24], &#39;hi&#39;
=&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt; &#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt;
&#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character(),
  X30 = col_logical()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<div class="sourceCode" id="cb443"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb443-1" data-line-number="1">sliced &lt;-<span class="st"> </span><span class="kw">slice</span>(raw, <span class="dv">1</span><span class="op">:</span><span class="dv">192</span>)</a>
<a class="sourceLine" id="cb443-2" data-line-number="2">countries &lt;-<span class="st"> </span>sliced<span class="op">$</span>ISO3</a>
<a class="sourceLine" id="cb443-3" data-line-number="3">body &lt;-<span class="st"> </span>raw <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb443-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>ISO3, <span class="op">-</span>Countries)</a>
<a class="sourceLine" id="cb443-5" data-line-number="5">numbers &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">str_replace</span>(body, <span class="st">&quot;%&quot;</span>, <span class="st">&quot;&quot;</span>)) <span class="op">/</span><span class="st"> </span><span class="dv">100</span></a></code></pre></div>
<pre><code>Warning in stri_replace_first_regex(string, pattern,
fix_replacement(replacement), : argument is not an atomic vector; coercing</code></pre>
<pre><code>Warning: NAs introduced by coercion</code></pre>
<div class="sourceCode" id="cb446"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb446-1" data-line-number="1"><span class="kw">is.numeric</span>(numbers)</a></code></pre></div>
<pre><code>[1] TRUE</code></pre>
<p>Bother.
It appears that <code>str_replace</code> expects an atomic vector rather than a tibble.
It worked for our test case because that was a character vector,
but tibbles have more structure than that.</p>
<p>The second complaint is that <code>NA</code>s were introduced,
which is troubling because we didn’t get a complaint when we had actual <code>NA</code>s in our data.
However,
<code>is.numeric</code> tells us that all of our results are numbers.
Let’s take a closer look:</p>
<div class="sourceCode" id="cb448"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb448-1" data-line-number="1"><span class="kw">is_tibble</span>(body)</a></code></pre></div>
<pre><code>[1] TRUE</code></pre>
<div class="sourceCode" id="cb450"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb450-1" data-line-number="1"><span class="kw">is_tibble</span>(numbers)</a></code></pre></div>
<pre><code>[1] FALSE</code></pre>
<p>Perdition.
After browsing the data,
we realize that some entries are <code>&quot;&gt;95%&quot;</code>,
i.e.,
there is a greater-than sign as well as a percentage in the text.
We will need to regularize those before we do any conversions.</p>
<p>Before that,
however,
let’s see if we can get rid of the percent signs.
The obvious way is is to use <code>str_replace(body, &quot;%&quot;, &quot;&quot;)</code>,
but that doesn’t work:
<code>str_replace</code> works on vectors,
but a tibble is a list of vectors.
Instead,
we can use a <a href="glossary.html#higher-order-function">higher-order function</a> called <code>map</code>
to apply the function <code>str_replace</code> to each column in turn to get rid of the percent signs:</p>
<div class="sourceCode" id="cb452"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb452-1" data-line-number="1">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>))</a></code></pre></div>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt; &#39;Estimate_1&#39; [6],
&#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt; &#39;Estimate_2&#39; [9], &#39;hi&#39;
=&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt; &#39;Estimate_3&#39; [12], &#39;hi&#39;
=&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt; &#39;Estimate_4&#39; [15], &#39;hi&#39;
=&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt; &#39;Estimate_5&#39; [18], &#39;hi&#39;
=&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt; &#39;Estimate_6&#39; [21], &#39;hi&#39;
=&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt; &#39;Estimate_7&#39; [24], &#39;hi&#39;
=&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt; &#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt;
&#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character(),
  X30 = col_logical()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<div class="sourceCode" id="cb457"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb457-1" data-line-number="1">sliced &lt;-<span class="st"> </span><span class="kw">slice</span>(raw, <span class="dv">1</span><span class="op">:</span><span class="dv">192</span>)</a>
<a class="sourceLine" id="cb457-2" data-line-number="2">countries &lt;-<span class="st"> </span>sliced<span class="op">$</span>ISO3</a>
<a class="sourceLine" id="cb457-3" data-line-number="3">body &lt;-<span class="st"> </span>raw <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb457-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>ISO3, <span class="op">-</span>Countries)</a>
<a class="sourceLine" id="cb457-5" data-line-number="5">trimmed &lt;-<span class="st"> </span><span class="kw">map</span>(body, str_replace, <span class="dt">pattern =</span> <span class="st">&quot;%&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb457-6" data-line-number="6"><span class="kw">head</span>(trimmed)</a></code></pre></div>
<pre><code>$Estimate
  [1] NA         NA         NA         NA         NA         NA        
  [7] NA         NA         NA         NA         &quot;26&quot;       NA        
 [13] NA         NA         NA         &quot;&gt;95&quot;      NA         &quot;77&quot;      
 [19] NA         NA         &quot;7&quot;        NA         NA         &quot;25&quot;      
 [25] NA         NA         &quot;3&quot;        NA         &quot;&gt;95&quot;      NA        
 [31] &quot;27&quot;       NA         &quot;1&quot;        NA         NA         NA        
 [37] &quot;5&quot;        NA         &quot;8&quot;        NA         &quot;92&quot;       NA        
 [43] NA         &quot;83&quot;       NA         NA         NA         NA        
 [49] NA         NA         NA         &quot;28&quot;       &quot;1&quot;        &quot;4&quot;       
 [55] NA         NA         NA         NA         &quot;4&quot;        NA        
 [61] NA         NA         NA         NA         &quot;61&quot;       NA        
 [67] NA         NA         NA         NA         NA         NA        
 [73] NA         NA         &quot;61&quot;       NA         NA         NA        
 [79] NA         &quot;2&quot;        NA         NA         NA         NA        
 [85] NA         NA         NA         &quot;&gt;95&quot;      NA         NA        
 [91] NA         NA         NA         NA         NA         &quot;43&quot;      
 [97] &quot;5&quot;        NA         NA         NA         NA         NA        
[103] &quot;37&quot;       NA         &quot;8&quot;        NA         NA         NA        
[109] NA         NA         NA         NA         NA         &quot;2&quot;       
[115] NA         NA         NA         NA         &quot;2&quot;        NA        
[121] NA         &quot;50&quot;       NA         &quot;4&quot;        NA         NA        
[127] NA         &quot;1&quot;        NA         NA         NA         NA        
[133] NA         NA         &quot;1&quot;        NA         NA         NA        
[139] &quot;&gt;95&quot;      NA         NA         &quot;58&quot;       NA         NA        
[145] NA         NA         NA         NA         &quot;11&quot;       NA        
[151] NA         NA         NA         NA         NA         NA        
[157] NA         NA         NA         NA         NA         NA        
[163] &quot;9&quot;        NA         NA         NA         NA         &quot;1&quot;       
[169] NA         NA         NA         &quot;7&quot;        NA         NA        
[175] NA         NA         NA         NA         &quot;8&quot;        &quot;78&quot;      
[181] NA         NA         &quot;13&quot;       NA         NA         &quot;0&quot;       
[187] NA         NA         NA         NA         &quot;59&quot;       NA        
[193] &quot;&quot;         &quot;2009&quot;     &quot;Estimate&quot; &quot;25&quot;       &quot;23&quot;       NA        
[199] &quot;24&quot;       &quot;2&quot;        NA         &quot;1&quot;        &quot;8&quot;        NA        
[205] &quot;7&quot;        &quot;72&quot;       &quot;16&quot;       &quot;17&quot;       &quot;&quot;         &quot;&quot;        
[211] &quot;&quot;         &quot;&quot;         &quot;&quot;         &quot;&quot;        

$hi
  [1] NA    NA    NA    NA    NA    NA    NA    NA    NA    NA    &quot;35&quot;  NA   
...</code></pre>
<p>Perdition once again.
The problem now is that <code>map</code> produces a raw list as output.
The function we want is <code>map_dfr</code>,
which maps a function across the rows of a tibble and returns a tibble as a result.
(There is a corresponding function <code>map_dfc</code> that maps a function across columns.)</p>
<div class="sourceCode" id="cb459"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb459-1" data-line-number="1">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>))</a></code></pre></div>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt; &#39;Estimate_1&#39; [6],
&#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt; &#39;Estimate_2&#39; [9], &#39;hi&#39;
=&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt; &#39;Estimate_3&#39; [12], &#39;hi&#39;
=&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt; &#39;Estimate_4&#39; [15], &#39;hi&#39;
=&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt; &#39;Estimate_5&#39; [18], &#39;hi&#39;
=&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt; &#39;Estimate_6&#39; [21], &#39;hi&#39;
=&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt; &#39;Estimate_7&#39; [24], &#39;hi&#39;
=&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt; &#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt;
&#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character(),
  X30 = col_logical()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<div class="sourceCode" id="cb464"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb464-1" data-line-number="1">sliced &lt;-<span class="st"> </span><span class="kw">slice</span>(raw, <span class="dv">1</span><span class="op">:</span><span class="dv">192</span>)</a>
<a class="sourceLine" id="cb464-2" data-line-number="2">countries &lt;-<span class="st"> </span>sliced<span class="op">$</span>ISO3</a>
<a class="sourceLine" id="cb464-3" data-line-number="3">body &lt;-<span class="st"> </span>raw <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb464-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>ISO3, <span class="op">-</span>Countries)</a>
<a class="sourceLine" id="cb464-5" data-line-number="5">trimmed &lt;-<span class="st"> </span><span class="kw">map_dfr</span>(body, str_replace, <span class="dt">pattern =</span> <span class="st">&quot;%&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;&quot;</span>)</a>
<a class="sourceLine" id="cb464-6" data-line-number="6"><span class="kw">head</span>(trimmed)</a></code></pre></div>
<pre><code># A tibble: 6 x 28
  Estimate hi    lo    Estimate_1 hi_1  lo_1  Estimate_2 hi_2  lo_2  Estimate_3
  &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;      &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;     
1 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;      
2 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;      
3 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  38         42    35    23        
4 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  3          4     2     5          7     4     6         
5 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;      
6 &lt;NA&gt;     &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;       &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;      
# … with 18 more variables: hi_3 &lt;chr&gt;, lo_3 &lt;chr&gt;, Estimate_4 &lt;chr&gt;,
#   hi_4 &lt;chr&gt;, lo_4 &lt;chr&gt;, Estimate_5 &lt;chr&gt;, hi_5 &lt;chr&gt;, lo_5 &lt;chr&gt;,
#   Estimate_6 &lt;chr&gt;, hi_6 &lt;chr&gt;, lo_6 &lt;chr&gt;, Estimate_7 &lt;chr&gt;, hi_7 &lt;chr&gt;,
#   lo_7 &lt;chr&gt;, Estimate_8 &lt;chr&gt;, hi_8 &lt;chr&gt;, lo_8 &lt;chr&gt;, X30 &lt;chr&gt;</code></pre>
<p>Now to tackle those <code>&quot;&gt;95%&quot;</code> values.
It turns out that <code>str_replace</code> uses <a href="glossary.html#regular-expression">regular expressions</a>,
not just direct string matches,
so we can get rid of the <code>&gt;</code> at the same time as we get rid of the <code>%</code>.
We will check by looking at the first <code>Estimate</code> column,
which earlier inspection informed us had at least one <code>&quot;&gt;95%&quot;</code> in it:</p>
<div class="sourceCode" id="cb466"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb466-1" data-line-number="1">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>))</a></code></pre></div>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt; &#39;Estimate_1&#39; [6],
&#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt; &#39;Estimate_2&#39; [9], &#39;hi&#39;
=&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt; &#39;Estimate_3&#39; [12], &#39;hi&#39;
=&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt; &#39;Estimate_4&#39; [15], &#39;hi&#39;
=&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt; &#39;Estimate_5&#39; [18], &#39;hi&#39;
=&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt; &#39;Estimate_6&#39; [21], &#39;hi&#39;
=&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt; &#39;Estimate_7&#39; [24], &#39;hi&#39;
=&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt; &#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt;
&#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character(),
  X30 = col_logical()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<div class="sourceCode" id="cb471"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb471-1" data-line-number="1">sliced &lt;-<span class="st"> </span><span class="kw">slice</span>(raw, <span class="dv">1</span><span class="op">:</span><span class="dv">192</span>)</a>
<a class="sourceLine" id="cb471-2" data-line-number="2">countries &lt;-<span class="st"> </span>sliced<span class="op">$</span>ISO3</a>
<a class="sourceLine" id="cb471-3" data-line-number="3">body &lt;-<span class="st"> </span>raw <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb471-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>ISO3, <span class="op">-</span>Countries)</a>
<a class="sourceLine" id="cb471-5" data-line-number="5">trimmed &lt;-<span class="st"> </span><span class="kw">map_dfr</span>(body, str_replace, <span class="dt">pattern =</span> <span class="st">&quot;&gt;?(</span><span class="ch">\\</span><span class="st">d+)%&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>)</a>
<a class="sourceLine" id="cb471-6" data-line-number="6">trimmed<span class="op">$</span>Estimate</a></code></pre></div>
<pre><code>  [1] NA         NA         NA         NA         NA         NA        
  [7] NA         NA         NA         NA         &quot;26&quot;       NA        
 [13] NA         NA         NA         &quot;95&quot;       NA         &quot;77&quot;      
 [19] NA         NA         &quot;7&quot;        NA         NA         &quot;25&quot;      
 [25] NA         NA         &quot;3&quot;        NA         &quot;95&quot;       NA        
 [31] &quot;27&quot;       NA         &quot;1&quot;        NA         NA         NA        
 [37] &quot;5&quot;        NA         &quot;8&quot;        NA         &quot;92&quot;       NA        
 [43] NA         &quot;83&quot;       NA         NA         NA         NA        
 [49] NA         NA         NA         &quot;28&quot;       &quot;1&quot;        &quot;4&quot;       
 [55] NA         NA         NA         NA         &quot;4&quot;        NA        
 [61] NA         NA         NA         NA         &quot;61&quot;       NA        
 [67] NA         NA         NA         NA         NA         NA        
 [73] NA         NA         &quot;61&quot;       NA         NA         NA        
 [79] NA         &quot;2&quot;        NA         NA         NA         NA        
 [85] NA         NA         NA         &quot;95&quot;       NA         NA        
 [91] NA         NA         NA         NA         NA         &quot;43&quot;      
 [97] &quot;5&quot;        NA         NA         NA         NA         NA        
[103] &quot;37&quot;       NA         &quot;8&quot;        NA         NA         NA        
[109] NA         NA         NA         NA         NA         &quot;2&quot;       
[115] NA         NA         NA         NA         &quot;2&quot;        NA        
...</code></pre>
<p>Excellent.
We can now use <code>map_dfr</code> to convert the columns to numeric percentages
using an <a href="glossary.html#anonymous-function">anonymous function</a> that we define inside the <code>map_dfr</code> call itself:</p>
<div class="sourceCode" id="cb473"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb473-1" data-line-number="1">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>))</a></code></pre></div>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt; &#39;Estimate_1&#39; [6],
&#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt; &#39;Estimate_2&#39; [9], &#39;hi&#39;
=&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt; &#39;Estimate_3&#39; [12], &#39;hi&#39;
=&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt; &#39;Estimate_4&#39; [15], &#39;hi&#39;
=&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt; &#39;Estimate_5&#39; [18], &#39;hi&#39;
=&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt; &#39;Estimate_6&#39; [21], &#39;hi&#39;
=&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt; &#39;Estimate_7&#39; [24], &#39;hi&#39;
=&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt; &#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt;
&#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character(),
  X30 = col_logical()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<div class="sourceCode" id="cb478"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb478-1" data-line-number="1">sliced &lt;-<span class="st"> </span><span class="kw">slice</span>(raw, <span class="dv">1</span><span class="op">:</span><span class="dv">192</span>)</a>
<a class="sourceLine" id="cb478-2" data-line-number="2">countries &lt;-<span class="st"> </span>sliced<span class="op">$</span>ISO3</a>
<a class="sourceLine" id="cb478-3" data-line-number="3">body &lt;-<span class="st"> </span>raw <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb478-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>ISO3, <span class="op">-</span>Countries)</a>
<a class="sourceLine" id="cb478-5" data-line-number="5">trimmed &lt;-<span class="st"> </span><span class="kw">map_dfr</span>(body, str_replace, <span class="dt">pattern =</span> <span class="st">&quot;&gt;?(</span><span class="ch">\\</span><span class="st">d+)%&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>)</a>
<a class="sourceLine" id="cb478-6" data-line-number="6">percents &lt;-<span class="st"> </span><span class="kw">map_dfr</span>(trimmed, <span class="cf">function</span>(col) <span class="kw">as.numeric</span>(col) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>)</a></code></pre></div>
<pre><code>Warning in .f(.x[[i]], ...): NAs introduced by coercion</code></pre>
<pre><code>Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion</code></pre>
<div class="sourceCode" id="cb481"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb481-1" data-line-number="1"><span class="kw">head</span>(percents)</a></code></pre></div>
<pre><code># A tibble: 6 x 28
  Estimate    hi    lo Estimate_1  hi_1  lo_1 Estimate_2  hi_2  lo_2 Estimate_3
     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;
1       NA    NA    NA      NA    NA    NA         NA    NA    NA         NA   
2       NA    NA    NA      NA    NA    NA         NA    NA    NA         NA   
3       NA    NA    NA      NA    NA    NA          0.38  0.42  0.35       0.23
4       NA    NA    NA       0.03  0.04  0.02       0.05  0.07  0.04       0.06
5       NA    NA    NA      NA    NA    NA         NA    NA    NA         NA   
6       NA    NA    NA      NA    NA    NA         NA    NA    NA         NA   
# … with 18 more variables: hi_3 &lt;dbl&gt;, lo_3 &lt;dbl&gt;, Estimate_4 &lt;dbl&gt;,
#   hi_4 &lt;dbl&gt;, lo_4 &lt;dbl&gt;, Estimate_5 &lt;dbl&gt;, hi_5 &lt;dbl&gt;, lo_5 &lt;dbl&gt;,
#   Estimate_6 &lt;dbl&gt;, hi_6 &lt;dbl&gt;, lo_6 &lt;dbl&gt;, Estimate_7 &lt;dbl&gt;, hi_7 &lt;dbl&gt;,
#   lo_7 &lt;dbl&gt;, Estimate_8 &lt;dbl&gt;, hi_8 &lt;dbl&gt;, lo_8 &lt;dbl&gt;, X30 &lt;dbl&gt;</code></pre>
<p>27 warnings is rather a lot,
so let’s see what running <code>warnings()</code> produces right after the <code>as.numeric</code> call:</p>
<div class="sourceCode" id="cb483"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb483-1" data-line-number="1">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>))</a></code></pre></div>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt; &#39;Estimate_1&#39; [6],
&#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt; &#39;Estimate_2&#39; [9], &#39;hi&#39;
=&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt; &#39;Estimate_3&#39; [12], &#39;hi&#39;
=&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt; &#39;Estimate_4&#39; [15], &#39;hi&#39;
=&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt; &#39;Estimate_5&#39; [18], &#39;hi&#39;
=&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt; &#39;Estimate_6&#39; [21], &#39;hi&#39;
=&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt; &#39;Estimate_7&#39; [24], &#39;hi&#39;
=&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt; &#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt;
&#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character(),
  X30 = col_logical()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<div class="sourceCode" id="cb488"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb488-1" data-line-number="1">sliced &lt;-<span class="st"> </span><span class="kw">slice</span>(raw, <span class="dv">1</span><span class="op">:</span><span class="dv">192</span>)</a>
<a class="sourceLine" id="cb488-2" data-line-number="2">countries &lt;-<span class="st"> </span>sliced<span class="op">$</span>ISO3</a>
<a class="sourceLine" id="cb488-3" data-line-number="3">body &lt;-<span class="st"> </span>raw <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb488-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>ISO3, <span class="op">-</span>Countries)</a>
<a class="sourceLine" id="cb488-5" data-line-number="5">trimmed &lt;-<span class="st"> </span><span class="kw">map_dfr</span>(body, str_replace, <span class="dt">pattern =</span> <span class="st">&quot;&gt;?(</span><span class="ch">\\</span><span class="st">d+)%&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>)</a>
<a class="sourceLine" id="cb488-6" data-line-number="6">percents &lt;-<span class="st"> </span><span class="kw">map_dfr</span>(trimmed, <span class="cf">function</span>(col) <span class="kw">as.numeric</span>(col) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>)</a></code></pre></div>
<pre><code>Warning in .f(.x[[i]], ...): NAs introduced by coercion</code></pre>
<pre><code>Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion

Warning in .f(.x[[i]], ...): NAs introduced by coercion</code></pre>
<div class="sourceCode" id="cb491"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb491-1" data-line-number="1"><span class="kw">warnings</span>()</a></code></pre></div>
<p>Something is still not right.
The first <code>Estimates</code> column looks all right,
so let’s have a look at the second column:</p>
<div class="sourceCode" id="cb492"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb492-1" data-line-number="1">trimmed<span class="op">$</span>hi</a></code></pre></div>
<pre><code>  [1] NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   &quot;35&quot; NA   NA   NA   NA  
 [16] &quot;95&quot; NA   &quot;89&quot; NA   NA   &quot;10&quot; NA   NA   &quot;35&quot; NA   NA   &quot;5&quot;  NA   &quot;95&quot; NA  
 [31] &quot;36&quot; NA   &quot;1&quot;  NA   NA   NA   &quot;6&quot;  NA   &quot;12&quot; NA   &quot;95&quot; NA   NA   &quot;95&quot; NA  
 [46] NA   NA   NA   NA   NA   NA   &quot;36&quot; &quot;1&quot;  &quot;4&quot;  NA   NA   NA   NA   &quot;6&quot;  NA  
 [61] NA   NA   NA   NA   &quot;77&quot; NA   NA   NA   NA   NA   NA   NA   NA   NA   &quot;74&quot;
 [76] NA   NA   NA   NA   &quot;2&quot;  NA   NA   NA   NA   NA   NA   NA   &quot;95&quot; NA   NA  
 [91] NA   NA   NA   NA   NA   &quot;53&quot; &quot;7&quot;  NA   NA   NA   NA   NA   &quot;44&quot; NA   &quot;9&quot; 
[106] NA   NA   NA   NA   NA   NA   NA   NA   &quot;2&quot;  NA   NA   NA   NA   &quot;2&quot;  NA  
[121] NA   &quot;69&quot; NA   &quot;7&quot;  NA   NA   NA   &quot;1&quot;  NA   NA   NA   NA   NA   NA   &quot;1&quot; 
[136] NA   NA   NA   &quot;95&quot; NA   NA   &quot;75&quot; NA   NA   NA   NA   NA   NA   &quot;13&quot; NA  
[151] NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   NA   &quot;11&quot; NA   NA  
[166] NA   NA   &quot;1&quot;  NA   NA   NA   &quot;12&quot; NA   NA   NA   NA   NA   NA   &quot;9&quot;  &quot;95&quot;
[181] NA   NA   &quot;16&quot; NA   NA   &quot;1&quot;  NA   NA   NA   NA   &quot;70&quot; NA   &quot;&quot;   &quot;&quot;   &quot;hi&quot;
[196] &quot;30&quot; &quot;29&quot; NA   &quot;32&quot; &quot;2&quot;  NA   &quot;2&quot;  &quot;12&quot; NA   &quot;9&quot;  &quot;89&quot; &quot;22&quot; &quot;23&quot; &quot;&quot;   &quot;&quot;  
[211] &quot;&quot;   &quot;&quot;   &quot;&quot;   &quot;&quot;  </code></pre>
<p>Where are the empty strings toward the end of <code>trimmed$hi</code> coming from?
Let’s backtrack by examining the <code>hi</code> column of each of our intermediate variables interactively in the console…</p>
<p>…and there’s our bug.
We are creating a variable called <code>sliced</code> that has only the rows we care about,
but then using the full table in <code>raw</code> to create <code>body</code>.
It’s a simple mistake,
and one that could easily have slipped by us.
Here is our revised script:</p>
<div class="sourceCode" id="cb494"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb494-1" data-line-number="1">raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">&quot;data/infant_hiv.csv&quot;</span>, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>))</a></code></pre></div>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt; &#39;Estimate_1&#39; [6],
&#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt; &#39;Estimate_2&#39; [9], &#39;hi&#39;
=&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt; &#39;Estimate_3&#39; [12], &#39;hi&#39;
=&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt; &#39;Estimate_4&#39; [15], &#39;hi&#39;
=&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt; &#39;Estimate_5&#39; [18], &#39;hi&#39;
=&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt; &#39;Estimate_6&#39; [21], &#39;hi&#39;
=&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt; &#39;Estimate_7&#39; [24], &#39;hi&#39;
=&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt; &#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt;
&#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character(),
  X30 = col_logical()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<div class="sourceCode" id="cb499"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb499-1" data-line-number="1">sliced &lt;-<span class="st"> </span><span class="kw">slice</span>(raw, <span class="dv">1</span><span class="op">:</span><span class="dv">192</span>)</a>
<a class="sourceLine" id="cb499-2" data-line-number="2">countries &lt;-<span class="st"> </span>sliced<span class="op">$</span>ISO3</a>
<a class="sourceLine" id="cb499-3" data-line-number="3">body &lt;-<span class="st"> </span>sliced <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb499-4" data-line-number="4"><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>ISO3, <span class="op">-</span>Countries)</a>
<a class="sourceLine" id="cb499-5" data-line-number="5">trimmed &lt;-<span class="st"> </span><span class="kw">map_dfr</span>(body, str_replace, <span class="dt">pattern =</span> <span class="st">&quot;&gt;?(</span><span class="ch">\\</span><span class="st">d+)%&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>)</a>
<a class="sourceLine" id="cb499-6" data-line-number="6">percents &lt;-<span class="st"> </span><span class="kw">map_dfr</span>(trimmed, <span class="cf">function</span>(col) <span class="kw">as.numeric</span>(col) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>)</a></code></pre></div>
<p>and here are the checks on the head:</p>
<div class="sourceCode" id="cb500"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb500-1" data-line-number="1"><span class="kw">head</span>(percents)</a></code></pre></div>
<pre><code># A tibble: 6 x 28
  Estimate    hi    lo Estimate_1  hi_1  lo_1 Estimate_2  hi_2  lo_2 Estimate_3
     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;
1       NA    NA    NA      NA    NA    NA         NA    NA    NA         NA   
2       NA    NA    NA      NA    NA    NA         NA    NA    NA         NA   
3       NA    NA    NA      NA    NA    NA          0.38  0.42  0.35       0.23
4       NA    NA    NA       0.03  0.04  0.02       0.05  0.07  0.04       0.06
5       NA    NA    NA      NA    NA    NA         NA    NA    NA         NA   
6       NA    NA    NA      NA    NA    NA         NA    NA    NA         NA   
# … with 18 more variables: hi_3 &lt;dbl&gt;, lo_3 &lt;dbl&gt;, Estimate_4 &lt;dbl&gt;,
#   hi_4 &lt;dbl&gt;, lo_4 &lt;dbl&gt;, Estimate_5 &lt;dbl&gt;, hi_5 &lt;dbl&gt;, lo_5 &lt;dbl&gt;,
#   Estimate_6 &lt;dbl&gt;, hi_6 &lt;dbl&gt;, lo_6 &lt;dbl&gt;, Estimate_7 &lt;dbl&gt;, hi_7 &lt;dbl&gt;,
#   lo_7 &lt;dbl&gt;, Estimate_8 &lt;dbl&gt;, hi_8 &lt;dbl&gt;, lo_8 &lt;dbl&gt;, X30 &lt;dbl&gt;</code></pre>
<p>and tail:</p>
<div class="sourceCode" id="cb502"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb502-1" data-line-number="1"><span class="kw">tail</span>(percents)</a></code></pre></div>
<pre><code># A tibble: 6 x 28
  Estimate    hi    lo Estimate_1  hi_1  lo_1 Estimate_2  hi_2  lo_2 Estimate_3
     &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;
1    NA     NA   NA         NA    NA    NA         NA    NA    NA         NA   
2    NA     NA   NA         NA    NA    NA         NA    NA    NA         NA   
3    NA     NA   NA         NA    NA    NA          0.31  0.37  0.26       0.3 
4    NA     NA   NA         NA    NA    NA         NA    NA    NA         NA   
5     0.59   0.7  0.53       0.27  0.32  0.24       0.7   0.84  0.63       0.74
6    NA     NA   NA          0.12  0.15  0.1        0.23  0.28  0.2        0.38
# … with 18 more variables: hi_3 &lt;dbl&gt;, lo_3 &lt;dbl&gt;, Estimate_4 &lt;dbl&gt;,
#   hi_4 &lt;dbl&gt;, lo_4 &lt;dbl&gt;, Estimate_5 &lt;dbl&gt;, hi_5 &lt;dbl&gt;, lo_5 &lt;dbl&gt;,
#   Estimate_6 &lt;dbl&gt;, hi_6 &lt;dbl&gt;, lo_6 &lt;dbl&gt;, Estimate_7 &lt;dbl&gt;, hi_7 &lt;dbl&gt;,
#   lo_7 &lt;dbl&gt;, Estimate_8 &lt;dbl&gt;, hi_8 &lt;dbl&gt;, lo_8 &lt;dbl&gt;, X30 &lt;dbl&gt;</code></pre>
<p>Comparing this to the raw data file convinces us that yes,
we are now converting the percentages properly,
which means we are halfway home.</p>
</div>
<div id="how-do-i-reorganize-the-columns" class="section level2">
<h2><span class="header-section-number">5.4</span> How do I reorganize the columns?</h2>
<p>We now have numeric values in <code>percents</code> and corresponding ISO3 codes in <code>countries</code>.
What we do <em>not</em> have is tidy data:
countries are not associated with records,
years are not recorded at all,
and the column headers for <code>percents</code> have mostly been manufactured for us by R.
We must now sew these parts together like Dr. Frankenstein’s trusty assistant Igor
(who, like so many lab assistants, did most of the actual work but was given only crumbs of credit).</p>
<p>We could write a loop to grab three columns at a time and relabel them,
but a more concise solution makes use of a pair of functions called <code>pivot_longer</code> and <code>separate</code>.
<code>pivot_longer</code> takes multiple columns and collapses them into two,
one of which holds a key and the other of which holds a value.
To show how it works,
let’s create a small tibble by hand using the function <code>tribble</code>.
The first few arguments use <code>~</code> as a <a href="glossary.html#prefix-operator">prefix operator</a> to define columns names,
and all of the other values are then put into a tibble with those columns:</p>
<div class="sourceCode" id="cb504"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb504-1" data-line-number="1">small &lt;-<span class="st"> </span><span class="kw">tribble</span>(</a>
<a class="sourceLine" id="cb504-2" data-line-number="2">  <span class="op">~</span>ISO, <span class="op">~</span>est, <span class="op">~</span>hi, <span class="op">~</span>lo,</a>
<a class="sourceLine" id="cb504-3" data-line-number="3">  <span class="st">&#39;ABC&#39;</span>, <span class="fl">0.25</span>, <span class="fl">0.3</span>, <span class="fl">0.2</span>,</a>
<a class="sourceLine" id="cb504-4" data-line-number="4">  <span class="st">&#39;DEF&#39;</span>, <span class="fl">0.55</span>, <span class="fl">0.6</span>, <span class="fl">0.5</span></a>
<a class="sourceLine" id="cb504-5" data-line-number="5">)</a>
<a class="sourceLine" id="cb504-6" data-line-number="6">small</a></code></pre></div>
<pre><code># A tibble: 2 x 4
  ISO     est    hi    lo
  &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 ABC    0.25   0.3   0.2
2 DEF    0.55   0.6   0.5</code></pre>
<p>and then rearrange the data in <code>est</code>, <code>hi</code>, and <code>lo</code>:</p>
<div class="sourceCode" id="cb506"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb506-1" data-line-number="1">small <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb506-2" data-line-number="2"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="dt">cols =</span> <span class="kw">c</span>(est, hi, lo), <span class="dt">names_to =</span> <span class="st">&quot;kind&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;reported&quot;</span>)</a></code></pre></div>
<pre><code># A tibble: 6 x 3
  ISO   kind  reported
  &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;
1 ABC   est       0.25
2 ABC   hi        0.3 
3 ABC   lo        0.2 
4 DEF   est       0.55
5 DEF   hi        0.6 
6 DEF   lo        0.5 </code></pre>
<p>The <code>cols</code> parameter tells <code>pivot_longer</code> which columns to rearrange.
The new column <code>names_to</code> gets the old column titles (in our case, <code>est</code>, <code>hi</code>, and <code>lo</code>),
while the new column <code>values_to</code> gets the values.
The result is a table which is longer and narrower than the original,
which is what inspired the function’s name.
(Previous versions of the tidyverse called this function <code>gather</code>,
but users reported that they found the name confusing.)</p>
<p>The other tool we need to rearrange our data is <code>separate</code>,
which splits one column into two.
For example,
if we have the year and the heading type in a single column:</p>
<div class="sourceCode" id="cb508"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb508-1" data-line-number="1">single &lt;-<span class="st"> </span><span class="kw">tribble</span>(</a>
<a class="sourceLine" id="cb508-2" data-line-number="2">  <span class="op">~</span>combined, <span class="op">~</span>value,</a>
<a class="sourceLine" id="cb508-3" data-line-number="3">  <span class="st">&#39;2009-est&#39;</span>, <span class="dv">123</span>,</a>
<a class="sourceLine" id="cb508-4" data-line-number="4">  <span class="st">&#39;2009-hi&#39;</span>,  <span class="dv">456</span>,</a>
<a class="sourceLine" id="cb508-5" data-line-number="5">  <span class="st">&#39;2009-lo&#39;</span>,  <span class="dv">789</span>,</a>
<a class="sourceLine" id="cb508-6" data-line-number="6">  <span class="st">&#39;2010-est&#39;</span>, <span class="dv">987</span>,</a>
<a class="sourceLine" id="cb508-7" data-line-number="7">  <span class="st">&#39;2010-hi&#39;</span>,  <span class="dv">654</span>,</a>
<a class="sourceLine" id="cb508-8" data-line-number="8">  <span class="st">&#39;2010-lo&#39;</span>,  <span class="dv">321</span></a>
<a class="sourceLine" id="cb508-9" data-line-number="9">)</a>
<a class="sourceLine" id="cb508-10" data-line-number="10">single</a></code></pre></div>
<pre><code># A tibble: 6 x 2
  combined value
  &lt;chr&gt;    &lt;dbl&gt;
1 2009-est   123
2 2009-hi    456
3 2009-lo    789
4 2010-est   987
5 2010-hi    654
6 2010-lo    321</code></pre>
<p>we can get the year and the heading into separate columns by separating on the <code>-</code> character:</p>
<div class="sourceCode" id="cb510"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb510-1" data-line-number="1">single <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb510-2" data-line-number="2"><span class="st">  </span><span class="kw">separate</span>(combined, <span class="dt">sep =</span> <span class="st">&quot;-&quot;</span>, <span class="kw">c</span>(<span class="st">&quot;year&quot;</span>, <span class="st">&quot;kind&quot;</span>))</a></code></pre></div>
<pre><code># A tibble: 6 x 3
  year  kind  value
  &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;
1 2009  est     123
2 2009  hi      456
3 2009  lo      789
4 2010  est     987
5 2010  hi      654
6 2010  lo      321</code></pre>
<p>Our strategy is therefore going to be:</p>
<ol style="list-style-type: decimal">
<li>Replace the double column headers in the existing data with a single header that combines the year with the kind.</li>
<li>Gather the data so that the year-kind values are in a single column.</li>
<li>Split that column.</li>
</ol>
<p>We’ve seen the tools we need for the second and third step;
the first involves a little bit of list manipulation.
Let’s start by repeating <code>&quot;est&quot;</code>, <code>&quot;hi&quot;</code>, and <code>&quot;lo&quot;</code> as many times as we need them:</p>
<div class="sourceCode" id="cb512"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb512-1" data-line-number="1">num_years &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">2017</span> <span class="op">-</span><span class="st"> </span><span class="dv">2009</span></a>
<a class="sourceLine" id="cb512-2" data-line-number="2">kinds &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;est&quot;</span>, <span class="st">&quot;hi&quot;</span>, <span class="st">&quot;lo&quot;</span>), num_years)</a>
<a class="sourceLine" id="cb512-3" data-line-number="3">kinds</a></code></pre></div>
<pre><code> [1] &quot;est&quot; &quot;hi&quot;  &quot;lo&quot;  &quot;est&quot; &quot;hi&quot;  &quot;lo&quot;  &quot;est&quot; &quot;hi&quot;  &quot;lo&quot;  &quot;est&quot; &quot;hi&quot;  &quot;lo&quot; 
[13] &quot;est&quot; &quot;hi&quot;  &quot;lo&quot;  &quot;est&quot; &quot;hi&quot;  &quot;lo&quot;  &quot;est&quot; &quot;hi&quot;  &quot;lo&quot;  &quot;est&quot; &quot;hi&quot;  &quot;lo&quot; 
[25] &quot;est&quot; &quot;hi&quot;  &quot;lo&quot; </code></pre>
<p>As you can probably guess from its name,
<code>rep</code> repeats things a specified number of times,
and as noted previously,
a vector of vectors is flattened into a single vector,
so what an innocent might expect to be <code>c(c('est', 'hi', 'lo'), c('est', 'hi', 'lo))</code>
automatically becomes <code>c('est', 'hi', 'lo', 'est', 'hi', 'lo)</code>.</p>
<p>What about the years?
We want to wind up with:</p>
<div class="sourceCode" id="cb514"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb514-1" data-line-number="1"><span class="kw">c</span>(<span class="st">&quot;2009&quot;</span>, <span class="st">&quot;2009&quot;</span> <span class="st">&quot;2009&quot;</span>, <span class="st">&quot;2010&quot;</span>, <span class="st">&quot;2010&quot;</span>, <span class="st">&quot;2010&quot;</span>, ...)</a></code></pre></div>
<p>i.e., with each year repeated three times.
<code>rep</code> won’t do this,
but we can get there with <code>map</code>:</p>
<div class="sourceCode" id="cb515"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb515-1" data-line-number="1">years &lt;-<span class="st"> </span><span class="kw">map</span>(<span class="dv">2009</span><span class="op">:</span><span class="dv">2017</span>, rep, <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb515-2" data-line-number="2">years</a></code></pre></div>
<pre><code>[[1]]
[1] 2009 2009 2009

[[2]]
[1] 2010 2010 2010

[[3]]
[1] 2011 2011 2011

[[4]]
[1] 2012 2012 2012

[[5]]
[1] 2013 2013 2013

[[6]]
[1] 2014 2014 2014

[[7]]
[1] 2015 2015 2015

[[8]]
[1] 2016 2016 2016

[[9]]
[1] 2017 2017 2017</code></pre>
<p>That’s almost right,
but <code>map</code> hasn’t flattened the list for us.
Luckily,
we can use <code>unlist</code> to do that:</p>
<div class="sourceCode" id="cb517"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb517-1" data-line-number="1">years &lt;-<span class="st"> </span><span class="kw">map</span>(<span class="dv">2009</span><span class="op">:</span><span class="dv">2017</span>, rep, <span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unlist</span>()</a>
<a class="sourceLine" id="cb517-2" data-line-number="2">years</a></code></pre></div>
<pre><code> [1] 2009 2009 2009 2010 2010 2010 2011 2011 2011 2012 2012 2012 2013 2013 2013
[16] 2014 2014 2014 2015 2015 2015 2016 2016 2016 2017 2017 2017</code></pre>
<p>We can now combine the years and kinds by pasting the two vectors together with <code>&quot;-&quot;</code> as a separator:</p>
<div class="sourceCode" id="cb519"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb519-1" data-line-number="1">headers &lt;-<span class="st"> </span><span class="kw">paste</span>(years, kinds, <span class="dt">sep =</span> <span class="st">&quot;-&quot;</span>)</a>
<a class="sourceLine" id="cb519-2" data-line-number="2">headers</a></code></pre></div>
<pre><code> [1] &quot;2009-est&quot; &quot;2009-hi&quot;  &quot;2009-lo&quot;  &quot;2010-est&quot; &quot;2010-hi&quot;  &quot;2010-lo&quot; 
 [7] &quot;2011-est&quot; &quot;2011-hi&quot;  &quot;2011-lo&quot;  &quot;2012-est&quot; &quot;2012-hi&quot;  &quot;2012-lo&quot; 
[13] &quot;2013-est&quot; &quot;2013-hi&quot;  &quot;2013-lo&quot;  &quot;2014-est&quot; &quot;2014-hi&quot;  &quot;2014-lo&quot; 
[19] &quot;2015-est&quot; &quot;2015-hi&quot;  &quot;2015-lo&quot;  &quot;2016-est&quot; &quot;2016-hi&quot;  &quot;2016-lo&quot; 
[25] &quot;2017-est&quot; &quot;2017-hi&quot;  &quot;2017-lo&quot; </code></pre>
<p>Remember,
everything in R is a vector and most functions are vectorized,
so if we give <code>paste</code> two vectors to combine,
it will paste corresponding elements together and give us a vector result.</p>
<p>Let’s use this to relabel the columns of <code>percents</code>
(which holds our data without the ISO country codes):</p>
<div class="sourceCode" id="cb521"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb521-1" data-line-number="1"><span class="kw">names</span>(percents) &lt;-<span class="st"> </span>headers</a></code></pre></div>
<pre><code>Warning: The `value` argument of ``names&lt;-`()` must have the same length as `x` as of tibble 3.0.0.
`names` must have length 28, not 27.
This warning is displayed once every 8 hours.
Call `lifecycle::last_warnings()` to see where this warning was generated.</code></pre>
<pre><code>Warning: The `value` argument of ``names&lt;-`()` can&#39;t be empty as of tibble 3.0.0.
Column 28 must be named.
This warning is displayed once every 8 hours.
Call `lifecycle::last_warnings()` to see where this warning was generated.</code></pre>
<div class="sourceCode" id="cb524"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb524-1" data-line-number="1">percents</a></code></pre></div>
<pre><code># A tibble: 192 x 28
   `2009-est` `2009-hi` `2009-lo` `2010-est` `2010-hi` `2010-lo` `2011-est`
        &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;
 1         NA        NA        NA      NA        NA        NA         NA   
 2         NA        NA        NA      NA        NA        NA         NA   
 3         NA        NA        NA      NA        NA        NA          0.38
 4         NA        NA        NA       0.03      0.04      0.02       0.05
 5         NA        NA        NA      NA        NA        NA         NA   
 6         NA        NA        NA      NA        NA        NA         NA   
 7         NA        NA        NA      NA        NA        NA          0.13
 8         NA        NA        NA      NA        NA        NA         NA   
 9         NA        NA        NA      NA        NA        NA         NA   
10         NA        NA        NA      NA        NA        NA         NA   
# … with 182 more rows, and 21 more variables: `2011-hi` &lt;dbl&gt;,
#   `2011-lo` &lt;dbl&gt;, `2012-est` &lt;dbl&gt;, `2012-hi` &lt;dbl&gt;, `2012-lo` &lt;dbl&gt;,
#   `2013-est` &lt;dbl&gt;, `2013-hi` &lt;dbl&gt;, `2013-lo` &lt;dbl&gt;, `2014-est` &lt;dbl&gt;,
#   `2014-hi` &lt;dbl&gt;, `2014-lo` &lt;dbl&gt;, `2015-est` &lt;dbl&gt;, `2015-hi` &lt;dbl&gt;,
#   `2015-lo` &lt;dbl&gt;, `2016-est` &lt;dbl&gt;, `2016-hi` &lt;dbl&gt;, `2016-lo` &lt;dbl&gt;,
#   `2017-est` &lt;dbl&gt;, `2017-hi` &lt;dbl&gt;, `2017-lo` &lt;dbl&gt;, NA &lt;dbl&gt;</code></pre>
<p>This example shows that <code>names(table)</code> doesn’t just give us a list of column names:
it gives us something we can assign to when we want to rename those columns.
This example also shows us that <code>percents</code> has the wrong number of columns.
Inspecting the tibble in the console,
we see that the last column is full of NAs:</p>
<div class="sourceCode" id="cb526"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb526-1" data-line-number="1">percents[, <span class="kw">ncol</span>(percents)]</a></code></pre></div>
<pre><code># A tibble: 192 x 1
      ``
   &lt;dbl&gt;
 1    NA
 2    NA
 3    NA
 4    NA
 5    NA
 6    NA
 7    NA
 8    NA
 9    NA
10    NA
# … with 182 more rows</code></pre>
<div class="sourceCode" id="cb528"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb528-1" data-line-number="1"><span class="kw">all</span>(<span class="kw">is.na</span>(percents[,<span class="kw">ncol</span>(percents)]))</a></code></pre></div>
<pre><code>[1] TRUE</code></pre>
<p>Let’s relabel our data again and then drop the empty column.
(There are other ways to do this, but I find steps easier to read after the fact this way.)</p>
<div class="sourceCode" id="cb530"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb530-1" data-line-number="1">headers &lt;-<span class="st"> </span><span class="kw">c</span>(headers, <span class="st">&quot;empty&quot;</span>)</a>
<a class="sourceLine" id="cb530-2" data-line-number="2"><span class="kw">names</span>(percents) &lt;-<span class="st"> </span>headers</a>
<a class="sourceLine" id="cb530-3" data-line-number="3">percents &lt;-<span class="st"> </span><span class="kw">select</span>(percents, <span class="op">-</span>empty)</a>
<a class="sourceLine" id="cb530-4" data-line-number="4">percents</a></code></pre></div>
<pre><code># A tibble: 192 x 27
   `2009-est` `2009-hi` `2009-lo` `2010-est` `2010-hi` `2010-lo` `2011-est`
        &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;
 1         NA        NA        NA      NA        NA        NA         NA   
 2         NA        NA        NA      NA        NA        NA         NA   
 3         NA        NA        NA      NA        NA        NA          0.38
 4         NA        NA        NA       0.03      0.04      0.02       0.05
 5         NA        NA        NA      NA        NA        NA         NA   
 6         NA        NA        NA      NA        NA        NA         NA   
 7         NA        NA        NA      NA        NA        NA          0.13
 8         NA        NA        NA      NA        NA        NA         NA   
 9         NA        NA        NA      NA        NA        NA         NA   
10         NA        NA        NA      NA        NA        NA         NA   
# … with 182 more rows, and 20 more variables: `2011-hi` &lt;dbl&gt;,
#   `2011-lo` &lt;dbl&gt;, `2012-est` &lt;dbl&gt;, `2012-hi` &lt;dbl&gt;, `2012-lo` &lt;dbl&gt;,
#   `2013-est` &lt;dbl&gt;, `2013-hi` &lt;dbl&gt;, `2013-lo` &lt;dbl&gt;, `2014-est` &lt;dbl&gt;,
#   `2014-hi` &lt;dbl&gt;, `2014-lo` &lt;dbl&gt;, `2015-est` &lt;dbl&gt;, `2015-hi` &lt;dbl&gt;,
#   `2015-lo` &lt;dbl&gt;, `2016-est` &lt;dbl&gt;, `2016-hi` &lt;dbl&gt;, `2016-lo` &lt;dbl&gt;,
#   `2017-est` &lt;dbl&gt;, `2017-hi` &lt;dbl&gt;, `2017-lo` &lt;dbl&gt;</code></pre>
<p>It’s time to put the country codes back on the table,
move the year and kind from column headers to a column with <code>pivot_longer</code>,
and then split that column with <code>separate</code>:</p>
<div class="sourceCode" id="cb532"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb532-1" data-line-number="1">final &lt;-<span class="st"> </span>percents <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb532-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">country =</span> countries) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb532-3" data-line-number="3"><span class="st">  </span><span class="kw">pivot_longer</span>(<span class="op">-</span>country, <span class="dt">names_to =</span> <span class="st">&quot;year_kind&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;reported&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb532-4" data-line-number="4"><span class="st">  </span><span class="kw">separate</span>(year_kind, <span class="kw">c</span>(<span class="st">&quot;year&quot;</span>, <span class="st">&quot;kind&quot;</span>), <span class="dt">sep =</span> <span class="st">&quot;-&quot;</span>)</a>
<a class="sourceLine" id="cb532-5" data-line-number="5">final</a></code></pre></div>
<pre><code># A tibble: 5,184 x 4
   country year  kind  reported
   &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;
 1 AFG     2009  est         NA
 2 AFG     2009  hi          NA
 3 AFG     2009  lo          NA
 4 AFG     2010  est         NA
 5 AFG     2010  hi          NA
 6 AFG     2010  lo          NA
 7 AFG     2011  est         NA
 8 AFG     2011  hi          NA
 9 AFG     2011  lo          NA
10 AFG     2012  est         NA
# … with 5,174 more rows</code></pre>
<p>Here’s everything in one function:</p>
<div class="sourceCode" id="cb534"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb534-1" data-line-number="1">clean_infant_hiv &lt;-<span class="st"> </span><span class="cf">function</span>(filename, num_rows) {</a>
<a class="sourceLine" id="cb534-2" data-line-number="2">  <span class="co"># Read raw data.</span></a>
<a class="sourceLine" id="cb534-3" data-line-number="3">  raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(filename, <span class="dt">skip =</span> <span class="dv">2</span>, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb534-4" data-line-number="4"><span class="st">    </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span>num_rows)</a>
<a class="sourceLine" id="cb534-5" data-line-number="5">  </a>
<a class="sourceLine" id="cb534-6" data-line-number="6">  <span class="co"># Save the country names to reattach later.</span></a>
<a class="sourceLine" id="cb534-7" data-line-number="7">  countries &lt;-<span class="st"> </span>raw<span class="op">$</span>ISO3</a>
<a class="sourceLine" id="cb534-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb534-9" data-line-number="9">  <span class="co"># Convert data values to percentages.</span></a>
<a class="sourceLine" id="cb534-10" data-line-number="10">  percents &lt;-<span class="st"> </span>raw <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb534-11" data-line-number="11"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>ISO3, <span class="op">-</span>Countries) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb534-12" data-line-number="12"><span class="st">    </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span>num_rows) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb534-13" data-line-number="13"><span class="st">    </span><span class="kw">map_dfr</span>(str_replace, <span class="dt">pattern =</span> <span class="st">&quot;&gt;?(</span><span class="ch">\\</span><span class="st">d+)%&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb534-14" data-line-number="14"><span class="st">    </span><span class="kw">map_dfr</span>(<span class="cf">function</span>(col) <span class="kw">as.numeric</span>(col) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>)</a>
<a class="sourceLine" id="cb534-15" data-line-number="15"></a>
<a class="sourceLine" id="cb534-16" data-line-number="16">  <span class="co"># Change the headers on the percentages.</span></a>
<a class="sourceLine" id="cb534-17" data-line-number="17">  num_years &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">2017</span> <span class="op">-</span><span class="st"> </span><span class="dv">2009</span></a>
<a class="sourceLine" id="cb534-18" data-line-number="18">  kinds &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;est&quot;</span>, <span class="st">&quot;hi&quot;</span>, <span class="st">&quot;lo&quot;</span>), num_years)</a>
<a class="sourceLine" id="cb534-19" data-line-number="19">  years &lt;-<span class="st"> </span><span class="kw">map</span>(<span class="dv">2009</span><span class="op">:</span><span class="dv">2017</span>, rep, <span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unlist</span>()</a>
<a class="sourceLine" id="cb534-20" data-line-number="20">  headers &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">paste</span>(years, kinds, <span class="dt">sep =</span> <span class="st">&quot;-&quot;</span>), <span class="st">&quot;empty&quot;</span>)</a>
<a class="sourceLine" id="cb534-21" data-line-number="21">  <span class="kw">names</span>(percents) &lt;-<span class="st"> </span>headers</a>
<a class="sourceLine" id="cb534-22" data-line-number="22">  </a>
<a class="sourceLine" id="cb534-23" data-line-number="23">  <span class="co"># Stitch everything back together.</span></a>
<a class="sourceLine" id="cb534-24" data-line-number="24">  percents <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb534-25" data-line-number="25"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">country =</span> countries) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb534-26" data-line-number="26"><span class="st">    </span><span class="kw">pivot_longer</span>(<span class="op">-</span>country, <span class="dt">names_to =</span> <span class="st">&quot;year_kind&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;reported&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb534-27" data-line-number="27"><span class="st">    </span><span class="kw">separate</span>(year_kind, <span class="kw">c</span>(<span class="st">&quot;year&quot;</span>, <span class="st">&quot;kind&quot;</span>), <span class="dt">sep =</span> <span class="st">&quot;-&quot;</span>)</a>
<a class="sourceLine" id="cb534-28" data-line-number="28">}</a>
<a class="sourceLine" id="cb534-29" data-line-number="29"></a>
<a class="sourceLine" id="cb534-30" data-line-number="30"><span class="kw">clean_infant_hiv</span>(<span class="st">&quot;data/infant_hiv.csv&quot;</span>, <span class="dv">192</span>)</a></code></pre></div>
<pre><code>Warning: Missing column names filled in: &#39;X30&#39; [30]</code></pre>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Estimate&#39; =&gt; &#39;Estimate_1&#39; [6],
&#39;hi&#39; =&gt; &#39;hi_1&#39; [7], &#39;lo&#39; =&gt; &#39;lo_1&#39; [8], &#39;Estimate&#39; =&gt; &#39;Estimate_2&#39; [9], &#39;hi&#39;
=&gt; &#39;hi_2&#39; [10], &#39;lo&#39; =&gt; &#39;lo_2&#39; [11], &#39;Estimate&#39; =&gt; &#39;Estimate_3&#39; [12], &#39;hi&#39;
=&gt; &#39;hi_3&#39; [13], &#39;lo&#39; =&gt; &#39;lo_3&#39; [14], &#39;Estimate&#39; =&gt; &#39;Estimate_4&#39; [15], &#39;hi&#39;
=&gt; &#39;hi_4&#39; [16], &#39;lo&#39; =&gt; &#39;lo_4&#39; [17], &#39;Estimate&#39; =&gt; &#39;Estimate_5&#39; [18], &#39;hi&#39;
=&gt; &#39;hi_5&#39; [19], &#39;lo&#39; =&gt; &#39;lo_5&#39; [20], &#39;Estimate&#39; =&gt; &#39;Estimate_6&#39; [21], &#39;hi&#39;
=&gt; &#39;hi_6&#39; [22], &#39;lo&#39; =&gt; &#39;lo_6&#39; [23], &#39;Estimate&#39; =&gt; &#39;Estimate_7&#39; [24], &#39;hi&#39;
=&gt; &#39;hi_7&#39; [25], &#39;lo&#39; =&gt; &#39;lo_7&#39; [26], &#39;Estimate&#39; =&gt; &#39;Estimate_8&#39; [27], &#39;hi&#39; =&gt;
&#39;hi_8&#39; [28], &#39;lo&#39; =&gt; &#39;lo_8&#39; [29]</code></pre>
<pre><code>Parsed with column specification:
cols(
  .default = col_character(),
  X30 = col_logical()
)</code></pre>
<pre><code>See spec(...) for full column specifications.</code></pre>
<pre><code>Warning: Expected 2 pieces. Missing pieces filled with `NA` in 192 rows [28, 56,
84, 112, 140, 168, 196, 224, 252, 280, 308, 336, 364, 392, 420, 448, 476, 504,
532, 560, ...].</code></pre>
<pre><code># A tibble: 5,376 x 4
   country year  kind  reported
   &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt;
 1 AFG     2009  est         NA
 2 AFG     2009  hi          NA
 3 AFG     2009  lo          NA
 4 AFG     2010  est         NA
 5 AFG     2010  hi          NA
 6 AFG     2010  lo          NA
 7 AFG     2011  est         NA
 8 AFG     2011  hi          NA
 9 AFG     2011  lo          NA
10 AFG     2012  est         NA
# … with 5,366 more rows</code></pre>
<p>We’re done,
and we have learned a lot of R,
but what we have also learned is that we make mistakes,
and that those mistakes can easily slip past us.
It would be <a href="glossary.html#hubris">hubris</a> to believe that we will not make more as we continue to clean this data.
What will guide us safely through these dark caverns and back into the light of day?</p>
<p>The answer is testing.
We must test our assumptions, test our code, test our very <em>being</em> if we are to advance.
R provides tools for this purpose,
but in order to use them,
we must venture into the greater realm of packaging in R.</p>
</div>
<div id="how-do-i-create-a-package" class="section level2">
<h2><span class="header-section-number">5.5</span> How do I create a package?</h2>
<p>The more software you write,
the more you realize that a programming language is mostly
a way to build and combine software packages.
Every widely-used language now has an online <a href="glossary.html#repository">repository</a>
from which people can download and install packages,
and sharing ours is a great way to contribute to the community
that has helped us on our journey.</p>
<blockquote>
<h3 id="cran-and-alternatives"><span class="header-section-number">5.5</span> CRAN and Alternatives</h3>
<p><a href="https://cran.r-project.org/">CRAN</a>,
the Comprehensive R Archive Network,
is the best place to find the packages you need.
CRAN’s famously strict rules ensure that packages run for everyone,
but also makes package development a little more onerous than it might be.
You can also share packages directly from GitHub,
which many people do while packages are still in development.
We will explore this in more detail below.</p>
</blockquote>
<p>We cannot turn this tutorial into an R package because we’re building it as a website,
not as a package.
Instead, we will create an R package called <code>unicefdata</code> to hold cleaned-up copies of
<a href="https://data.unicef.org/resources/dataset/hiv-aids-statistical-tables/">some HIV/AIDS data</a> and <a href="https://data.unicef.org/resources/dataset/maternal-health-data/">maternal health data</a> from UNICEF.</p>
<p>An R package must contain the following files:</p>
<ul>
<li><p>The text file <code>DESCRIPTION</code> (with no suffix) describes what the package does,
who wrote it,
and what other packages it requires to run.
We will edit its contents as we go along.</p></li>
<li><p><code>NAMESPACE</code>,
(whose name also has no suffix)
contains the names of everything exported from the package
(i.e., everything that is visible to the outside world).
As we will see,
we should leave its management in the hands of RStudio
and the <code>devtools</code> package we will meet below.</p></li>
<li><p>Just as <code>.gitignore</code> tells Git what files in a project to ignore,
<code>.Rbuildignore</code> tells R which files to include or not include in the package.</p></li>
<li><p>All of the R source for our package must go in a directory called <code>R</code>;
sub-directories below this are not allowed.</p></li>
<li><p>As you would expect from its name,
the optional <code>data</code> directory contains any data we have put in our package.
In order for it to be loadable as part of the package,
the data must be saved in R’s custom <code>.rda</code> format.
We will see how to do this below.</p></li>
<li><p>Manual pages go in the <code>man</code> directory.
The bad news is that they have to be in a sort-of-LaTeX format
that is only a bit less obscure than the runes inscribed on the ancient dagger
your colleague brought back from her latest archeological dig.
The good news is,
we can embed Markdown comments in our source code
and use a tool called <code>roxygen2</code>
to extract them and translate them into the format that R packages require.</p></li>
<li><p>The <code>tests</code> directory holds the package’s unit tests.
It should contain files with names like <code>test_<em>some_feature</em>.R</code>,
which should in turn contain functions named <code>test_<em>something_specific</em></code>.
We’ll have a closer look at these in Chapter <a href="testerror.html#testerror">8</a>.</p></li>
</ul>
<p>We can type all of this in if we want,
but R has a very useful package called <code>usethis</code> to help us create and maintain packages.
To use it,
we load <code>usethis</code> in the console with <code>library(usethis)</code>
and use <code>usethis::create_package</code>
with the path to the new package directory as an argument:</p>
<div class="sourceCode" id="cb541"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb541-1" data-line-number="1">usethis<span class="op">::</span><span class="kw">create_package</span>(<span class="st">&#39;~/unicefdata&#39;</span>)</a></code></pre></div>
<pre><code>✔ Creating &#39;/Users/gvwilson/unicefdata/&#39;
✔ Setting active project to &#39;/Users/gvwilson/unicefdata&#39;
✔ Creating &#39;R/&#39;
✔ Writing &#39;DESCRIPTION&#39;
Package: unicefdata
Title: What the Package Does (One Line, Title Case)
Version: 0.0.0.9000
Authors@R (parsed):
    * First Last &lt;first.last@example.com&gt; [aut, cre] (&lt;https://orcid.org/YOUR-ORCID-ID&gt;)
Description: What the package does (one paragraph).
License: What license it uses
Encoding: UTF-8
LazyData: true
✔ Writing &#39;NAMESPACE&#39;
✔ Writing &#39;unicefdata.Rproj&#39;
✔ Adding &#39;.Rproj.user&#39; to &#39;.gitignore&#39;
✔ Adding &#39;^unicefdata\\.Rproj$&#39;, &#39;^\\.Rproj\\.user$&#39; to &#39;.Rbuildignore&#39;
✔ Opening &#39;/Users/gvwilson/unicefdata/&#39; in new RStudio session
✔ Setting active project to &#39;&lt;no active project&gt;&#39;</code></pre>
<p>Every well-behaved package should have a README file,
a license,
and a Code of Conduct,
so we will ask <code>usethis</code> to add those
<em>in the RStudio session that just opened up</em>
(rather than in the one in which this tutorial is being written,
and yes,
imprecations were uttered upon making that mistake for the second time):</p>
<div class="sourceCode" id="cb543"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb543-1" data-line-number="1">usethis<span class="op">::</span><span class="kw">use_readme_md</span>()</a></code></pre></div>
<pre><code>✔ Setting active project to &#39;/Users/gvwilson/unicefdata&#39;
✔ Writing &#39;README.md&#39;
● Modify &#39;README.md&#39;</code></pre>
<div class="sourceCode" id="cb545"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb545-1" data-line-number="1">usethis<span class="op">::</span><span class="kw">use_mit_license</span>(<span class="dt">name=</span><span class="st">&quot;UNICEF Data&quot;</span>)</a></code></pre></div>
<pre><code>✔ Setting License field in DESCRIPTION to &#39;MIT + file LICENSE&#39;
✔ Writing &#39;LICENSE.md&#39;
✔ Adding &#39;^LICENSE\\.md$&#39; to &#39;.Rbuildignore&#39;
✔ Writing &#39;LICENSE&#39;</code></pre>
<p><code>use_mit_license</code> creates two files: <code>LICENSE</code> and <code>LICENSE.md</code>.
The rules for R packages require the former,
but GitHub expects the latter.</p>
<div class="sourceCode" id="cb547"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb547-1" data-line-number="1">usethis<span class="op">::</span><span class="kw">use_code_of_conduct</span>()</a></code></pre></div>
<pre><code>✔ Setting active project to &#39;/Users/gvwilson/tidynomicon&#39;</code></pre>
<pre><code>✔ Leaving &#39;CODE_OF_CONDUCT.md&#39; unchanged</code></pre>
<pre><code>● Don&#39;t forget to describe the code of conduct in your README:</code></pre>
<pre><code>  ## Code of Conduct
  
  Please note that the placeholder project is released with a [Contributor Code of Conduct](https://contributor-covenant.org/version/2/0/CODE_OF_CONDUCT.html). By contributing to this project, you agree to abide by its terms.</code></pre>
<pre><code>✔ Writing &#39;CODE_OF_CONDUCT.md&#39;
✔ Adding &#39;^CODE_OF_CONDUCT\\.md$&#39; to &#39;.Rbuildignore&#39;
● Don&#39;t forget to describe the code of conduct in your README:
  Please note that the &#39;unicefdata&#39; project is released with a
  [Contributor Code of Conduct](CODE_OF_CONDUCT.md).
  By contributing to this project, you agree to abide by its terms.
  [Copied to clipboard]</code></pre>
<p>We then edit <code>README.md</code> to be:</p>
<pre><code># unicefdata

unicefdata is a small R data package created for tutorial purposes.
See `data/README.md` for the provenance of the original data.

## Installation

You can install unicefdata from GitHub with `devtools::install_github(&quot;gvwilson/unicefdata)`</code></pre>
<p>and similarly edit <code>DESCRIPTION</code> so that it contains:</p>
<pre><code>Package: unicefdata
Title: Small UNICEF Dataset for Tutorial Purposes
Version: 0.0.0.9000
Authors@R: 
    person(given = &quot;Greg&quot;,
           family = &quot;Wilson&quot;,
           role = c(&quot;aut&quot;, &quot;cre&quot;),
           email = &quot;gvwilson@third-bit.com&quot;,
           comment = c(ORCID = &quot;0000-0001-8659-8979&quot;))
Description: This package demonstrates how to share small datasets in R.
License: MIT + file LICENSE
Encoding: UTF-8
LazyData: true</code></pre>
<p>We can now go to the <code>Build</code> tab in RStudio and run <code>Check</code>
to make sure our empty package is judged sane by our strict, yet impartial, machine.</p>
<p>We can now put the function we wrote to clean up the infant HIV data
in a file called <code>R/clean_infant_hiv.R</code>
either by using <code>File...New</code> in RStudio
or by running <code>usethis::use_r('clean_infant_hiv.R')</code>
(which always creates the file in the <code>R</code> directory).
We do <em>not</em> include the line that actually runs the function,
since we don’t want that to happen every time this file is loaded.
We also fix the number of valid rows inside the function rather than passing it as a parameter,
since it’s highly unlikely that users will know or guess the value 192:</p>
<div class="sourceCode" id="cb555"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb555-1" data-line-number="1">clean_infant_hiv &lt;-<span class="st"> </span><span class="cf">function</span>(filename) {</a>
<a class="sourceLine" id="cb555-2" data-line-number="2">  <span class="co"># Indexes into the specific file.</span></a>
<a class="sourceLine" id="cb555-3" data-line-number="3">  header_rows &lt;-<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb555-4" data-line-number="4">  num_rows &lt;-<span class="st"> </span><span class="dv">192</span></a>
<a class="sourceLine" id="cb555-5" data-line-number="5">  first_year &lt;-<span class="st"> </span><span class="dv">2009</span></a>
<a class="sourceLine" id="cb555-6" data-line-number="6">  last_year &lt;-<span class="st"> </span><span class="dv">2017</span></a>
<a class="sourceLine" id="cb555-7" data-line-number="7"></a>
<a class="sourceLine" id="cb555-8" data-line-number="8">  <span class="co"># Read raw data.</span></a>
<a class="sourceLine" id="cb555-9" data-line-number="9">  raw &lt;-<span class="st"> </span><span class="kw">read_csv</span>(filename, <span class="dt">skip =</span> header_rows, <span class="dt">na =</span> <span class="kw">c</span>(<span class="st">&quot;-&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb555-10" data-line-number="10"><span class="st">    </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span>num_rows)</a>
<a class="sourceLine" id="cb555-11" data-line-number="11">  </a>
<a class="sourceLine" id="cb555-12" data-line-number="12">  <span class="co"># Save the country names to reattach later.</span></a>
<a class="sourceLine" id="cb555-13" data-line-number="13">  countries &lt;-<span class="st"> </span>raw<span class="op">$</span>ISO3</a>
<a class="sourceLine" id="cb555-14" data-line-number="14">  </a>
<a class="sourceLine" id="cb555-15" data-line-number="15">  <span class="co"># Convert data values to percentages.</span></a>
<a class="sourceLine" id="cb555-16" data-line-number="16">  percents &lt;-<span class="st"> </span>raw <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb555-17" data-line-number="17"><span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>ISO3, <span class="op">-</span>Countries) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb555-18" data-line-number="18"><span class="st">    </span><span class="kw">slice</span>(<span class="dv">1</span><span class="op">:</span>num_rows) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb555-19" data-line-number="19"><span class="st">    </span><span class="kw">map_dfr</span>(str_replace, <span class="dt">pattern =</span> <span class="st">&quot;&gt;?(</span><span class="ch">\\</span><span class="st">d+)%&quot;</span>, <span class="dt">replacement =</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">1&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb555-20" data-line-number="20"><span class="st">    </span><span class="kw">map_dfr</span>(<span class="cf">function</span>(col) <span class="kw">as.numeric</span>(col) <span class="op">/</span><span class="st"> </span><span class="dv">100</span>)</a>
<a class="sourceLine" id="cb555-21" data-line-number="21"></a>
<a class="sourceLine" id="cb555-22" data-line-number="22">  <span class="co"># Change the headers on the percentages.</span></a>
<a class="sourceLine" id="cb555-23" data-line-number="23">  num_years &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>last_year <span class="op">-</span><span class="st"> </span>first_year</a>
<a class="sourceLine" id="cb555-24" data-line-number="24">  kinds &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">c</span>(<span class="st">&quot;est&quot;</span>, <span class="st">&quot;hi&quot;</span>, <span class="st">&quot;lo&quot;</span>), num_years)</a>
<a class="sourceLine" id="cb555-25" data-line-number="25">  years &lt;-<span class="st"> </span><span class="kw">map</span>(first_year<span class="op">:</span>last_year, rep, <span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unlist</span>()</a>
<a class="sourceLine" id="cb555-26" data-line-number="26">  headers &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">paste</span>(years, kinds, <span class="dt">sep =</span> <span class="st">&quot;-&quot;</span>), <span class="st">&quot;empty&quot;</span>)</a>
<a class="sourceLine" id="cb555-27" data-line-number="27">  <span class="kw">names</span>(percents) &lt;-<span class="st"> </span>headers</a>
<a class="sourceLine" id="cb555-28" data-line-number="28">  </a>
<a class="sourceLine" id="cb555-29" data-line-number="29">  <span class="co"># Stitch everything back together.</span></a>
<a class="sourceLine" id="cb555-30" data-line-number="30">  percents <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb555-31" data-line-number="31"><span class="st">    </span><span class="kw">mutate</span>(<span class="dt">country =</span> countries) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb555-32" data-line-number="32"><span class="st">    </span><span class="kw">pivot_longer</span>(<span class="op">-</span>country, <span class="dt">names_to =</span> <span class="st">&quot;year_kind&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;reported&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb555-33" data-line-number="33"><span class="st">    </span><span class="kw">separate</span>(year_kind, <span class="kw">c</span>(<span class="st">&quot;year&quot;</span>, <span class="st">&quot;kind&quot;</span>), <span class="dt">sep =</span> <span class="st">&quot;-&quot;</span>)</a>
<a class="sourceLine" id="cb555-34" data-line-number="34">}</a></code></pre></div>
</div>
<div id="how-can-i-document-the-contents-of-a-package" class="section level2">
<h2><span class="header-section-number">5.6</span> How can I document the contents of a package?</h2>
<p><code>Build...Check</code> runs a lot more checks now
because we have some actual code for it to look at.
It also produces some warnings:</p>
<pre><code>── R CMD check results ────────────────────────────── unicefdata 0.0.0.9000 ────
Duration: 19.5s

❯ checking for missing documentation entries ... WARNING
  Undocumented code objects:
    ‘infant_hiv’
  All user-level objects in a package should have documentation entries.
  See chapter ‘Writing R documentation files’ in the ‘Writing R
  Extensions’ manual.

❯ checking R code for possible problems ... NOTE
  infant_hiv: no visible global function definition for ‘%&gt;%’
  infant_hiv: no visible global function definition for ‘read_csv’
  infant_hiv: no visible global function definition for ‘slice’
  infant_hiv: no visible global function definition for ‘select’
  infant_hiv: no visible binding for global variable ‘ISO3’
  infant_hiv: no visible binding for global variable ‘Countries’
  infant_hiv: no visible global function definition for ‘map_dfr’
  infant_hiv: no visible binding for global variable ‘str_replace’
  infant_hiv: no visible global function definition for ‘map’
  infant_hiv: no visible global function definition for ‘mutate’
  infant_hiv: no visible global function definition for ‘gather’
  infant_hiv: no visible binding for global variable ‘country’
  infant_hiv: no visible global function definition for ‘separate’
  infant_hiv: no visible binding for global variable ‘year_kind’
  Undefined global functions or variables:
    %&gt;% Countries ISO3 country gather map map_dfr mutate read_csv select
    separate slice str_replace year_kind

0 errors ✔ | 1 warning ✖ | 1 note ✖
Error: R CMD check found WARNINGs
Execution halted</code></pre>
<p>A little documentation seems like a fair request.
For this,
we turn to Hadley Wickham’s <em><a href="http://r-pkgs.had.co.nz/">R Packages</a></em>
and Karl Broman’s “<a href="https://kbroman.org/pkg_primer/">R package primer</a>”
for advice on writing roxygen2 documentation.
We then return to our source file and prefix our existing code with this:</p>
<div class="sourceCode" id="cb557"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb557-1" data-line-number="1"><span class="co">#&#39; Tidy up the infant HIV data set.</span></a>
<a class="sourceLine" id="cb557-2" data-line-number="2"><span class="co">#&#39;</span></a>
<a class="sourceLine" id="cb557-3" data-line-number="3"><span class="co">#&#39; @param filename path to source file</span></a>
<a class="sourceLine" id="cb557-4" data-line-number="4"><span class="co">#&#39;</span></a>
<a class="sourceLine" id="cb557-5" data-line-number="5"><span class="co">#&#39; @return a tibble of tidy data</span></a>
<a class="sourceLine" id="cb557-6" data-line-number="6"><span class="co">#&#39;</span></a>
<a class="sourceLine" id="cb557-7" data-line-number="7"><span class="co">#&#39; @export</span></a>
<a class="sourceLine" id="cb557-8" data-line-number="8"></a>
<a class="sourceLine" id="cb557-9" data-line-number="9">infant_hiv &lt;-<span class="st"> </span><span class="cf">function</span>(filename) {</a>
<a class="sourceLine" id="cb557-10" data-line-number="10">  …all the code from before…</a>
<a class="sourceLine" id="cb557-11" data-line-number="11">}</a></code></pre></div>
<p>roxygen2 processes comment lines that start with <code>#'</code> (hash followed by single quote).
Putting a comment block right before a function associates that documentation with that function,
so here we are saying that:</p>
<ul>
<li>the function has a single parameter called <code>filename</code>;</li>
<li>it returns a tibble of tidy data; and</li>
<li>we want it exported (i.e., we want it to be visible outside the package).</li>
</ul>
<p>Our function is now documented,
but when we run <code>Check</code>,
we still get a warning.
After a bit more searching and experimentation,
we discover that we need to load the <code>devtools</code> package
and run <code>devtools::document()</code> in the console to regenerate documentation—it isn’t done automatically.</p>
<div class="sourceCode" id="cb558"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb558-1" data-line-number="1">devtools<span class="op">::</span><span class="kw">document</span>()</a></code></pre></div>
<pre><code>Updating unicefdata documentation
Updating roxygen version in /Users/gvwilson/unicefdata/DESCRIPTION
Writing NAMESPACE
Loading unicefdata
Writing NAMESPACE
Writing clean_infant_hiv.Rd</code></pre>
<p>Another check confirms that our function is now documented.
<code>NAMESPACE</code> now contains:</p>
<pre><code># Generated by roxygen2: do not edit by hand

export(infant_hiv)</code></pre>
<p>The <code>export</code> directive signals that we want <code>infant_hiv</code> to be visible outside the package,
and the comment helpfully reminds us that we shouldn’t edit this file ourselves,
but should instead trust our tools to do the work for us.
As for <code>man/clean_infant_hiv.Rd</code>,
it shows us more clearly than mere words ever could why we want to use <code>roxygen2</code>:</p>
<pre><code>% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/clean_infant_hiv.R
\name{infant_hiv}
\alias{infant_hiv}
\title{Tidy up the infant HIV data set.}
\usage{
infant_hiv(filename)
}
\arguments{
\item{filename}{path to source file}
}
\value{
a tibble of tidy data
}
\description{
Tidy up the infant HIV data set.
}</code></pre>
</div>
<div id="how-can-my-package-import-what-it-needs" class="section level2">
<h2><span class="header-section-number">5.7</span> How can my package import what it needs?</h2>
<p>Running the build again still gives us undefined function warnings for <code>read_csv</code>, <code>%&gt;%</code>, and many others.
The reason is that R packages are distributed as compiled bytecode,
<em>not</em> as source code (which is how Python does it).
When a package is built,
R loads and checks the code,
then saves the corresponding instructions.
Our R files should therefore define functions,
not run commands immediately,
because if they do the latter,
those commands will be executed every time the script loads,
which is probably not what users will want.</p>
<p>As a side effect,
this means that if a package uses <code>load(something)</code>,
then that <code>load</code> command is executed <em>while the package is being compiled</em>,
and <em>not</em> while the compiled package is being loaded by a user after distribution.
Thus,
this simple and rather pointless “package”:</p>
<div class="sourceCode" id="cb562"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb562-1" data-line-number="1"><span class="kw">library</span>(stringr)</a>
<a class="sourceLine" id="cb562-2" data-line-number="2"></a>
<a class="sourceLine" id="cb562-3" data-line-number="3">sr &lt;-<span class="st"> </span><span class="cf">function</span>(text, pattern, replacement) {</a>
<a class="sourceLine" id="cb562-4" data-line-number="4">  <span class="kw">str_replace</span>(text, pattern, replacement)</a>
<a class="sourceLine" id="cb562-5" data-line-number="5">}</a></code></pre></div>
<p>probably won’t work when it’s loaded by a user,
because <code>stringr</code> may not be in memory on the user’s machine at the time <code>str_replace</code> is called.</p>
<p>How then can our packages use libraries?
One way is to add import directives to the documentation for our functions
to tell R what we depend on:</p>
<div class="sourceCode" id="cb563"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb563-1" data-line-number="1"><span class="co">#&#39; @import dplyr</span></a>
<a class="sourceLine" id="cb563-2" data-line-number="2"><span class="co">#&#39; @importFrom magrittr %&gt;%</span></a></code></pre></div>
<p>The safer way is to use <a href="glossary.html#fully-qualified-name">fully-qualified names</a>
such as <code>stringr::str_replace</code>
every time we call a function defined somewhere outside our package,
as in:</p>
<div class="sourceCode" id="cb564"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb564-1" data-line-number="1">  percents <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb564-2" data-line-number="2"><span class="st">    </span>dplyr<span class="op">::</span><span class="kw">mutate</span>(<span class="dt">country =</span> countries) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb564-3" data-line-number="3"><span class="st">    </span>tidyr<span class="op">::</span><span class="kw">pivot_longer</span>(<span class="dt">cols =</span> <span class="kw">c</span>(est, hi, lo), <span class="dt">names_to =</span> <span class="st">&quot;kind&quot;</span>, <span class="dt">values_to =</span> <span class="st">&quot;reported&quot;</span>)</a>
<a class="sourceLine" id="cb564-4" data-line-number="4">    tidyr<span class="op">::</span><span class="kw">separate</span>(year_kind, <span class="kw">c</span>(<span class="st">&quot;year&quot;</span>, <span class="st">&quot;kind&quot;</span>))</a></code></pre></div>
<p>This changes the error to one that is slightly more confusing:</p>
<pre><code>── R CMD check results ────────────────────────────── unicefdata 0.0.0.9000 ────
Duration: 21.3s

❯ checking dependencies in R code ... WARNING
  &#39;::&#39; or &#39;:::&#39; imports not declared from:
    ‘dplyr’ ‘purrr’ ‘reader’ ‘stringr’ ‘tidyr’

❯ checking R code for possible problems ... NOTE
  infant_hiv: no visible global function definition for ‘%&gt;%’
  infant_hiv: no visible binding for global variable ‘ISO3’
  infant_hiv: no visible binding for global variable ‘Countries’
  infant_hiv: no visible binding for global variable ‘purrr’
  infant_hiv: no visible global function definition for ‘map’
  infant_hiv: no visible binding for global variable ‘country’
  infant_hiv: no visible binding for global variable ‘year_kind’
  Undefined global functions or variables:
    %&gt;% Countries ISO3 country map purrr year_kind</code></pre>
<p>More searching,
more experimentation,
and finally we add this to the <code>DESCRIPTION</code> file:</p>
<pre><code>Imports:
    readr (&gt;= 1.1.0),
    dplyr (&gt;= 0.7.0),
    magrittr (&gt;= 1.5.0),
    purrr (&gt;= 0.2.0),
    rlang (&gt;= 0.3.0),
    stringr (&gt;= 1.3.0),
    tidyr (&gt;= 0.8.3)</code></pre>
<p>The <code>Imports</code> field in <code>DESCRIPTION</code> actually has nothing to do with importing functions;
it just ensures that those packages are installed when this package is.
As for the version numbers in parentheses,
we got those by running <code>packageVersion(&quot;readr&quot;)</code> and similar commands inside RStudio
and then rounding off.</p>
<p>But that is still not enough,
because the check still complains about <code>%&gt;%</code>.
Luckily,
others have ventured into this poorly-lit basement before us
and lived to tell the tale.
<code>usethis::use_pipe()</code> at the console creates a file called <code>R/utils-pipe.R</code> containing:</p>
<div class="sourceCode" id="cb567"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb567-1" data-line-number="1"><span class="co">#&#39; Pipe operator</span></a>
<a class="sourceLine" id="cb567-2" data-line-number="2"><span class="co">#&#39;</span></a>
<a class="sourceLine" id="cb567-3" data-line-number="3"><span class="co">#&#39; See \code{magrittr::\link[magrittr:pipe]{\%&gt;\%}} for details.</span></a>
<a class="sourceLine" id="cb567-4" data-line-number="4"><span class="co">#&#39;</span></a>
<a class="sourceLine" id="cb567-5" data-line-number="5"><span class="co">#&#39; @name %&gt;%</span></a>
<a class="sourceLine" id="cb567-6" data-line-number="6"><span class="co">#&#39; @rdname pipe</span></a>
<a class="sourceLine" id="cb567-7" data-line-number="7"><span class="co">#&#39; @keywords internal</span></a>
<a class="sourceLine" id="cb567-8" data-line-number="8"><span class="co">#&#39; @export</span></a>
<a class="sourceLine" id="cb567-9" data-line-number="9"><span class="co">#&#39; @importFrom magrittr %&gt;%</span></a>
<a class="sourceLine" id="cb567-10" data-line-number="10"><span class="co">#&#39; @usage lhs \%&gt;\% rhs</span></a>
<a class="sourceLine" id="cb567-11" data-line-number="11"><span class="ot">NULL</span></a></code></pre></div>
<pre><code>NULL</code></pre>
<p>which is all the documentation we need to satisfy the check.</p>
<p>All right: are we done now?
No, we are not:</p>
<pre><code>checking R code for possible problems ... NOTE
tidy_infant_hiv: no visible binding for global variable &#39;ISO3&#39;
tidy_infant_hiv: no visible binding for global variable &#39;Countries&#39;
tidy_infant_hiv: no visible binding for global variable &#39;country&#39;
tidy_infant_hiv: no visible binding for global variable &#39;year&#39;</code></pre>
<p>This is annoying but understandable.
When the package builder is checking our code,
it has no idea what columns are going to be in our data frames,
so it has no way to know if <code>ISO3</code> or <code>Countries</code> will cause a problem.
However,
this is just a <code>NOTE</code>, not an <code>ERROR</code>,
so we can try running “Build…Install and Restart”
to build our package,
re-start our R session (so that memory is clean),
and load our newly-created package,
and then run <code>infant_hiv(&quot;~/tidynomicon/data/infant_hiv.csv&quot;)</code>.</p>
<p>Our data loads,
so we return to the problem of “variables” that are actually column names.
A bit more searching online tells us to add this to the documentation block for our function:</p>
<div class="sourceCode" id="cb570"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb570-1" data-line-number="1"><span class="co">#&#39; @importFrom rlang .data</span></a></code></pre></div>
<p>and then modify the calls that use naked column names to look like:</p>
<div class="sourceCode" id="cb571"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb571-1" data-line-number="1">    dplyr<span class="op">::</span><span class="kw">select</span>(<span class="op">-</span>.data<span class="op">$</span>ISO3, <span class="op">-</span>.data<span class="op">$</span>Countries)</a></code></pre></div>
<p>What is this <code>.data</code> that we have invoked?
Typing <code>?rlang::.data</code> gives us the answer:
it is a pronoun that allows us to be explicit when we refer to an object inside the data.
Adding this—i.e.,
being explicity that <code>country</code> is a column of <code>.data</code> rather than an undefined variable—finally
(finally)
gives us a clean build.</p>
</div>
<div id="how-can-i-add-data-to-a-package" class="section level2">
<h2><span class="header-section-number">5.8</span> How can I add data to a package?</h2>
<p>But we are not done,
because we are never <em>truly</em> done,
any more than we are ever truly safe.
We still need to add our cleaned-up data to our package
and document the package as a whole.
There are three steps to this.</p>
<p>First,
we put the raw data file into <code>inst/extdata/infant_hiv.csv</code>
Data that <em>isn’t</em> meant to be loaded directly into are should go in <code>inst/extdata</code>.
The first part of the directory name, <code>inst</code>, is short for “install”:
when the package is installed,
everything in this directory is bumped up a level and put in the installation directory.
Thus,
the installation directory will get a sub-directory called <code>extdata</code> (for “external data”),
and that can hold whatever we want.</p>
<p>Next,
we use <code>clean_infant_hiv</code> to put a tidy version of this data in a variable called <code>infant_hiv</code>,
then call <code>usethis::use_data(infant_hiv)</code> to store the tibble in <code>data/infant_hiv.rda</code>.
We <em>must</em> save the data as <code>.rda</code>, not as (for example) <code>.rds</code> or <code>.csv</code>;
only <code>.rda</code> will be automatically loaded as part of the project.
(We can write this file using <code>save</code> if we want,
but <code>usethis::use_data</code> automatically uses the right format and location.)</p>
<p>We now create a file called <code>R/infant_hiv.R</code> to hold documentation about the dataset:</p>
<div class="sourceCode" id="cb572"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb572-1" data-line-number="1"><span class="co">#&#39; Tidied infant HIV data.</span></a>
<a class="sourceLine" id="cb572-2" data-line-number="2"><span class="co">#&#39;</span></a>
<a class="sourceLine" id="cb572-3" data-line-number="3"><span class="co">#&#39; This tidy data is derived from the `infant_hiv.csv` file, which in turn is</span></a>
<a class="sourceLine" id="cb572-4" data-line-number="4"><span class="co">#&#39; derived from an Excel spreadsheet provided by UNICEF - see the README.md file</span></a>
<a class="sourceLine" id="cb572-5" data-line-number="5"><span class="co">#&#39; in the raw data directory for details.</span></a>
<a class="sourceLine" id="cb572-6" data-line-number="6"><span class="co">#&#39;</span></a>
<a class="sourceLine" id="cb572-7" data-line-number="7"><span class="co">#&#39; @format A data frame</span></a>
<a class="sourceLine" id="cb572-8" data-line-number="8"><span class="co">#&#39; \describe{</span></a>
<a class="sourceLine" id="cb572-9" data-line-number="9"><span class="co">#&#39;   \item{country}{Country reporting (ISO3 code)}</span></a>
<a class="sourceLine" id="cb572-10" data-line-number="10"><span class="co">#&#39;   \item{kind}{Type of report (low, estimate, high)}</span></a>
<a class="sourceLine" id="cb572-11" data-line-number="11"><span class="co">#&#39;   \item{reported}{Value reported (may be NA)}</span></a>
<a class="sourceLine" id="cb572-12" data-line-number="12"><span class="co">#&#39;   \item{year}{Year reported}</span></a>
<a class="sourceLine" id="cb572-13" data-line-number="13"><span class="co">#&#39; }</span></a>
<a class="sourceLine" id="cb572-14" data-line-number="14"><span class="st">&quot;infant_hiv&quot;</span></a></code></pre></div>
<p>Everything except the last line is a roxygen2 comment block
that describes the data in plain language,
then uses some tags and directives to document its format and fields.
(Note that we have also documented our data in <code>inst/extdata/README.md</code>,
but that focuses on the format and meaning of the raw data,
not the cleaned-up version.)</p>
<p>The last line is the string <code>&quot;infant_hiv&quot;</code>,
i.e.,
the name of the dataset.
We will create one placeholder R file like this for each of our datasets,
and each will have that dataset’s name as the thing being documented.</p>
<p>Let’s run a check:</p>
<pre><code>    Warning: package needs dependence on R (&gt;= 2.10)</code></pre>
<p>That’s easy enough to fix—we just add another section to <code>DESCRIPTION</code>
to specify the version of R we depend on:</p>
<pre><code>Depends:
    R (&gt;= 2.10)</code></pre>
<p>and voilà, a clean build.</p>
<p>We use a similar trick to document the package as a whole:
we create a file <code>R/unicefdata.R</code>
(i.e., a file with exactly the same name as the package)
and put this in it:</p>
<div class="sourceCode" id="cb575"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb575-1" data-line-number="1"><span class="co">#&#39; Clean up and share some data from UNICEF on infant HIV rates.</span></a>
<a class="sourceLine" id="cb575-2" data-line-number="2"><span class="co">#&#39;</span></a>
<a class="sourceLine" id="cb575-3" data-line-number="3"><span class="co">#&#39; @author Greg Wilson, \email{gvwilson@third-bit.com}</span></a>
<a class="sourceLine" id="cb575-4" data-line-number="4"><span class="co">#&#39; @docType package</span></a>
<a class="sourceLine" id="cb575-5" data-line-number="5"><span class="co">#&#39; @name unicefdata</span></a>
<a class="sourceLine" id="cb575-6" data-line-number="6"><span class="ot">NULL</span></a></code></pre></div>
<p>That’s right:
to document the entire package,
we document <code>NULL</code>,
which is one of the few times R uses call-by-value.
(That’s a fairly clumsy joke,
but honestly,
who among us is at our best at times like these?)</p>
</div>
<div id="key-points-3" class="section level2">
<h2><span class="header-section-number">5.9</span> Key Points</h2>
<ul>
<li>Develop data-cleaning scripts one step at a time, checking intermediate results carefully.</li>
<li>Use <code>read_csv</code> to read CSV-formatted tabular data into a tibble.</li>
<li>Use the <code>skip</code> and <code>na</code> parameters of <code>read_csv</code> to skip rows and interpret certain values as <code>NA</code>.</li>
<li>Use <code>str_replace</code> to replace portions of strings that match patterns with new strings.</li>
<li>Use <code>is.numeric</code> to test if a value is a number and <code>as.numeric</code> to convert it to a number.</li>
<li>Use <code>map</code> to apply a function to every element of a vector in turn.</li>
<li>Use <code>map_dfc</code> and <code>map_dfr</code> to map functions across the columns and rows of a tibble.</li>
<li>Pre-allocate storage in a list for each result from a loop and fill it in rather than repeatedly extending the list.</li>
<li>An R package can contain code, data, and documentation.</li>
<li>R code is distributed as compiled bytecode in packages, not as source.</li>
<li>R packages are almost always distributed through CRAN, the Comprehensive R Archive Network.</li>
<li>Most of a project’s metadata goes in a file called <code>DESCRIPTION</code>.</li>
<li>Metadata related to imports and exports goes in a file called <code>NAMESPACE</code>.</li>
<li>Add patterns to a file called <code>.Rbuildignore</code> to ignore files or directories when building a project.</li>
<li>All source code for a package must go in the <code>R</code> sub-directory.</li>
<li><code>library</code> calls in a package’s source code will <em>not</em> be executed as the package is loaded after distribution.</li>
<li>Data can be included in a package by putting it in the <code>data</code> sub-directory.</li>
<li>Data must be in <code>.rda</code> format in order to be loaded as part of a package.</li>
<li>Data in other formats can be put in the <code>inst/extdata</code> directory, and will be installed when the package is installed.</li>
<li>Add comments starting with <code>#'</code> to an R file to document functions.</li>
<li>Use roxygen2 to extract these comments to create manual pages in the <code>man</code> directory.</li>
<li>Use <code>@export</code> directives in roxygen2 comment blocks to make functions visible outside a package.</li>
<li>Add required libraries to the <code>Imports</code> section of the <code>DESCRIPTION</code> file to indicate that your package depends on them.</li>
<li>Use <code>package::function</code> to access externally-defined functions inside a package.</li>
<li>Alternatively, add <code>@import</code> directives to roxygen2 comment blocks to make external functions available inside the package.</li>
<li>Import <code>.data</code> from <code>rlang</code> and use <code>.data$column</code> to refer to columns instead of using bare column names.</li>
<li>Create a file called <code>R/<em>package</em>.R</code> and document <code>NULL</code> to document the package as a whole.</li>
<li>Create a file called <code>R/<em>dataset</em>.R</code> and document the string <code>‘<em>dataset</em>’</code> to document a dataset.</li>
</ul>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="rmarkdown.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="nse.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/gvwilson/tidynomicon/edit/master/package.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/gvwilson/tidynomicon/edit/master/package.Rmd",
"text": null
},
"download": ["r4de.pdf", "r4de.epub"],
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>

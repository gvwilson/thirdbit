<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Maya Gans, Toby Hodges, and Greg Wilson" />
  <title>JavaScript for Data Science</title>
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style>
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="assets/bootstrap.min.css" />
  <link rel="stylesheet" href="assets/tango.css" />
  <link rel="stylesheet" href="assets/book.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
<script defer data-domain="third-bit.com" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <nav class="col-md-2 col-toc">
      <a href="#title-block-header"><img src="assets/logo.png" alt="JavaScript for Data Science" width="100%" /></a>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#s:intro">Introduction</a>
<ul>
<li><a href="#s:intro-personas">Who You Are</a></li>
<li><a href="#s:intro-contributors">Who We Are</a></li>
<li><a href="#s:intro-setup">Setting Up</a></li>
<li><a href="#s:index-contrib">Contributing</a></li>
<li><a href="#s:intro-exercises">Exercises</a></li>
<li><a href="#key-points">Key Points</a></li>
</ul></li>
<li><a href="#s:basics">Basic Features</a>
<ul>
<li><a href="#s:basics-hello-world">Hello, World</a></li>
<li><a href="#s:basics-data-types">Basic Data Types</a></li>
<li><a href="#s:basics-control-flow">Control Flow</a></li>
<li><a href="#s:basics-formatting">Formatting Strings</a></li>
<li><a href="#s:basics-objects">Objects</a></li>
<li><a href="#s:basics-functions">Functions</a></li>
<li><a href="#s:basics-modules">Modules</a></li>
<li><a href="#s:basics-exercises">Exercises</a></li>
<li><a href="#key-points-1">Key Points</a></li>
</ul></li>
<li><a href="#s:callbacks">Callbacks</a>
<ul>
<li><a href="#s:callbacks-callstack">The Call Stack</a></li>
<li><a href="#s:callbacks-func">Functions of Functions</a></li>
<li><a href="#s:callbacks-anonymous">Anonymous Functions</a></li>
<li><a href="#s:callbacks-functional">Functional Programming</a></li>
<li><a href="#s:callbacks-closures">Closures</a></li>
<li><a href="#s:callbacks-exercises">Exercises</a></li>
<li><a href="#key-points-2">Key Points</a></li>
</ul></li>
<li><a href="#s:oop">Objects and Classes</a>
<ul>
<li><a href="#s:oop-manual">Doing It By Hand</a></li>
<li><a href="#s:oop-classes">Classes</a></li>
<li><a href="#s:oop-inheritance">Inheritance</a></li>
<li><a href="#s:oop-exercises">Exercises</a></li>
<li><a href="#key-points-3">Key Points</a></li>
</ul></li>
<li><a href="#s:htmlcss">HTML and CSS</a>
<ul>
<li><a href="#s:htmlcss-formatting">Formatting</a></li>
<li><a href="#s:htmlcss-text">Text</a></li>
<li><a href="#s:htmlcss-pages">Pages</a></li>
<li><a href="#s:htmlcss-attributes">Attributes</a></li>
<li><a href="#s:htmlcss-lists">Lists</a></li>
<li><a href="#s:htmlcss-tables">Tables</a></li>
<li><a href="#s:htmlcss-links">Links</a></li>
<li><a href="#s:htmlcss-images">Images</a></li>
<li><a href="#s:htmlcss-css">Cascading Style Sheets</a></li>
<li><a href="#s:htmlcss-bootstrap">Bootstrap</a></li>
<li><a href="#s:htmlcss-exercises">Exercises</a></li>
<li><a href="#key-points-4">Key Points</a></li>
</ul></li>
<li><a href="#s:pages">Manipulating Pages</a>
<ul>
<li><a href="#s:pages-counting">Counting Paragraphs</a></li>
<li><a href="#s:pages-toc">Creating a Table of Contents</a></li>
<li><a href="#s:pages-sort-list">Sortable Lists</a></li>
<li><a href="#s:pages-citations">Bibliographic Citations</a></li>
<li><a href="#s:pages-clock">A Real-time Clock</a></li>
<li><a href="#s:pages-exercises">Exercises</a></li>
<li><a href="#key-points-5">Key Points</a></li>
</ul></li>
<li><a href="#s:dynamic">Dynamic Pages</a>
<ul>
<li><a href="#s:dynamic-hello">Hello, World</a></li>
<li><a href="#s:dynamic-jsx">JSX</a></li>
<li><a href="#s:dynamic-components">Creating Components</a></li>
<li><a href="#s:dynamic-parcel">Developing with Parcel</a></li>
<li><a href="#s:dynamic-multiple">Multiple Files</a></li>
<li><a href="#s:dynamic-exercises">Exercises</a></li>
<li><a href="#key-points-6">Key Points</a></li>
</ul></li>
<li><a href="#s:vis">Visualizing Data</a>
<ul>
<li><a href="#s:vis-vega-lite">Vega-Lite</a></li>
<li><a href="#s:vis-vega-local">Local Installation</a></li>
<li><a href="#s:vis-exercises">Exercises</a></li>
<li><a href="#key-points-7">Key Points</a></li>
</ul></li>
<li><a href="#s:promises">Promises</a>
<ul>
<li><a href="#s:promises-queue">The Execution Queue</a></li>
<li><a href="#s:promises-promises">Promises</a></li>
<li><a href="#s:promises-usage">Using Promises</a></li>
<li><a href="#s:promises-async-await"><code>async</code> and <code>await</code></a></li>
<li><a href="#s:promises-exercises">Exercises</a></li>
<li><a href="#key-points-8">Key Points</a></li>
</ul></li>
<li><a href="#s:interactive">Interactive Sites</a>
<ul>
<li><a href="#s:interactive-babel">But It Doesn’t Work</a></li>
<li><a href="#s:interactive-models-views">Models and Views</a></li>
<li><a href="#s:interactive-fetching">Fetching Data</a></li>
<li><a href="#s:interactive-exercises">Exercises</a></li>
<li><a href="#key-points-9">Key Points</a></li>
</ul></li>
<li><a href="#s:dataman">Managing Data</a>
<ul>
<li><a href="#s:dataman-formats">Data Formats</a></li>
<li><a href="#s:dataman-slicing">Slicing Data</a></li>
<li><a href="#s:dataman-manager">Data Manager</a></li>
<li><a href="#s:dataman-exercises">Exercises</a></li>
<li><a href="#key-points-10">Key Points</a></li>
</ul></li>
<li><a href="#s:server">Creating a Server</a>
<ul>
<li><a href="#s:server-http">HTTP</a></li>
<li><a href="#s:server-express">Hello, Express</a></li>
<li><a href="#s:server-paths">Handling Multiple Paths</a></li>
<li><a href="#s:server-files">Serving Files from Disk</a></li>
<li><a href="#s:server-content-types">Content Types</a></li>
<li><a href="#s:server-exercises">Exercises</a></li>
<li><a href="#key-points-11">Key Points</a></li>
</ul></li>
<li><a href="#s:testing">Testing</a>
<ul>
<li><a href="#s:testing-mocha">Introducing Mocha</a></li>
<li><a href="#s:testing-refactoring">Refactoring</a></li>
<li><a href="#s:testing-server">Testing the Server</a></li>
<li><a href="#s:testing-html">Checking the HTML</a></li>
<li><a href="#s:testing-exercises">Exercises</a></li>
<li><a href="#key-points-12">Key Points</a></li>
</ul></li>
<li><a href="#s:dataforge">Using Data-Forge</a>
<ul>
<li><a href="#s:dataforge-basics">Basic Operations</a></li>
<li><a href="#s:dataforge-calc">Doing Calculations</a></li>
<li><a href="#s:dataforge-subset">Subsets</a></li>
<li><a href="#s:dataforge-aggregate">Aggregation</a></li>
<li><a href="#s:dataforge-real">In Real Life</a></li>
<li><a href="#s:dataforge-exercises">Exercises</a></li>
<li><a href="#key-points-13">Key Points</a></li>
</ul></li>
<li><a href="#s:capstone">Capstone Project</a>
<ul>
<li><a href="#s:capstone-data">Data Manager</a></li>
<li><a href="#s:capstone-server">Server</a></li>
<li><a href="#s:capstone-api">API</a></li>
<li><a href="#s:capstone-display">The Display</a></li>
<li><a href="#s:capstone-tables">The Tables</a></li>
<li><a href="#s:capstone-chart">The Chart</a></li>
<li><a href="#s:capstone-run">Running It</a></li>
<li><a href="#s:capstone-exercises">Exercises</a></li>
<li><a href="#key-points-14">Key Points</a></li>
</ul></li>
<li><a href="#s:finale">Finale</a>
<ul>
<li><a href="#key-points-15">Key Points</a></li>
</ul></li>
<li><a href="#s:license">License</a></li>
<li><a href="#s:conduct">Code of Conduct</a>
<ul>
<li><a href="#s:conduct-standards">Our Standards</a></li>
<li><a href="#s:conduct-responsibilities">Our Responsibilities</a></li>
<li><a href="#s:conduct-scope">Scope</a></li>
<li><a href="#s:conduct-enforcement">Enforcement</a></li>
<li><a href="#s:conduct-attribution">Attribution</a></li>
</ul></li>
<li><a href="#s:contributing">Contributing</a></li>
<li><a href="#s:gloss">Glossary</a></li>
<li><a href="#s:keypoints">Key Points</a>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#basic-features">Basic Features</a></li>
<li><a href="#callbacks">Callbacks</a></li>
<li><a href="#objects-and-classes">Objects and Classes</a></li>
<li><a href="#html-and-css">HTML and CSS</a></li>
<li><a href="#manipulating-pages">Manipulating Pages</a></li>
<li><a href="#dynamic-pages">Dynamic Pages</a></li>
<li><a href="#visualizing-data">Visualizing Data</a></li>
<li><a href="#promises">Promises</a></li>
<li><a href="#interactive-sites">Interactive Sites</a></li>
<li><a href="#managing-data">Managing Data</a></li>
<li><a href="#creating-a-server">Creating a Server</a></li>
<li><a href="#testing">Testing</a></li>
<li><a href="#using-data-forge">Using Data-Forge</a></li>
<li><a href="#capstone-project">Capstone Project</a></li>
<li><a href="#finale">Finale</a></li>
</ul></li>
<li><a href="#s:collab">Collaborating</a>
<ul>
<li><a href="#s:collab-software">Licensing Software</a></li>
<li><a href="#s:collab-datadocs">Licensing Data and Documentation</a></li>
<li><a href="#s:collab-conduct">Code of Conduct</a></li>
<li><a href="#s:collab-governance">Governance</a></li>
</ul></li>
<li><a href="#s:legacy">Legacy JavaScript Issues</a>
<ul>
<li><a href="#s:legacy-equality">Equality</a></li>
<li><a href="#s:legacy-iteration">Iteration</a></li>
<li><a href="#s:legacy-prototypes">Prototypes</a></li>
</ul></li>
<li><a href="#s:regexp">Regular Expressions</a></li>
<li><a href="#s:logging">Logging</a></li>
<li><a href="#s:extensible">Extensible Servers</a></li>
<li><a href="#s:db">Using a Database</a>
<ul>
<li><a href="#s:db-start">Starting Point</a></li>
<li><a href="#s:db-in-memory">In-Memory Database</a></li>
<li><a href="#s:db-testable">Making It Testable</a></li>
<li><a href="#s:db-testing">Testing</a></li>
<li><a href="#s:db-mutate">Updating the Database</a></li>
<li><a href="#s:db-exercises">Exercises</a></li>
</ul></li>
<li><a href="#s:deploy">Deploying</a></li>
<li><a href="#references">References</a></li>
</ul>
</nav>
      <p>
        <a href="#s:license"><img src="assets/cc-by-nc.svg" alt="CC-BY-NC License" width="50%" /></a>
        <a href="mailto:gvwilson@third-bit.com?subject=JavaScript for Data Science"><img src="assets/email.svg" alt="Email" width="20%" /></a>
        <a href="https://github.com/software-tools-books/js4ds/"><img src="assets/github.svg" alt="GitHub" width="20%" /></a>
      </p>
    </nav>
    <div class="col-md-10 col-body">
      <div class="container">
        <header>
          <h1 class="title">JavaScript for Data Science</h1>
                              <p class="author">Maya Gans, Toby Hodges, and Greg Wilson</p>
                              <p class="date">Version 4.0 / January 2020</p>
                  </header>
        <div class="dedication">
          <p><strong>Dedication</strong></p>
          <p>
            For Jordan, who taught me failures pave the way to success.<br/>
            — Maya
          </p>
          <p>
            For Oskar.<br/>
            — Toby
          </p>
          <p>
            For Kara, Claudia, Erin, Gabriela, Hannah, Laura, and Julia.<br/>
            — Greg
          </p>
          <p>
            <em><strong>
              This book can now be purchased
              <a href="https://www.crcpress.com/JavaScript-for-Data-Science/Gans-Hodges-Wilson/p/book/9780367422486">directly from the publisher</a>
              or through most online bookstores.
              <br/>
              All royalties from the sale of this book are being donated to <a href="https://rladies.org/">R-Ladies</a>,<br/>
              a worldwide organization whose mission is to promote gender diversity in the R community.
            </strong></em>
          </p>
        </div>
<h1 id="s:intro">Introduction</h1>
<p><a href="https://www.dabeaz.com/">David Beazley</a> thought that “JavaScript <em>versus</em> Data Science” would be a better title for this book. While that one word sums up how many people view the language, we hope we can convince you that modern JavaScript is usable as well as useful. Scientists and engineers are who we were thinking of when we wrote this book but we hope that these lessons will also help librarians, digital humanists, and everyone else who uses computing in their research.</p>
<p>We will cover:</p>
<ul>
<li><p>Core features of modern JavaScript</p></li>
<li><p>Programming with callbacks and promises</p></li>
<li><p>Creating objects and classes</p></li>
<li><p>Writing HTML and CSS</p></li>
<li><p>Creating interactive pages with React</p></li>
<li><p>Building data services</p></li>
<li><p>Testing</p></li>
<li><p>Data visualization</p></li>
<li><p>Combining everything to create a three-tier web application</p></li>
</ul>
<p>Unlike most introductions to JavaScript, these lessons present an even mix of browser programming and server programming. We give each topic only shallow coverage; if you want to know more, there are many other free tutorials you can dive into once you’ve mastered the basics, some of which are both up-to-date and well designed.</p>
<h2 id="s:intro-personas">Who You Are</h2>
<p>Every lesson should aim to <a href="http://teachtogether.tech/en/process/">meet the needs of specific learners</a> <span class="citation" data-cites="Wils2019"></span>. The three people described below define the intended audience for this one.</p>
<dl>
<dt>Bhadra</dt>
<dd><p>received a BSc in microbiology five years ago, and has worked since then for a biotech firm with labs in four countries. She did a statistics class using R as an undergrad, then learned some more R and some Unix shell scripting in a <a href="http://software-carpentry.org/">Software Carpentry</a> workshop, but has no other training as a programmer. Bhadra’s team is developing tools to detect structural similarities between proteins. They would like to build a browser interface to their tools so that people can test different algorithms on various datasets. This book will show Bhadra how to build, test, and deploy that interface.</p>
</dd>
<dt>Efraim</dt>
<dd><p>did fieldwork for the Ministry of Natural Resources for thirty-one years. He learned Visual Basic so that he could write Excel macros, then mastered C in order to maintain the control software for some second-hand remote sensing equipment. Efraim recently retired, and is now an active member of several citizen science projects. This book will show him how to create a service to share those projects’ data with the world, and how to build a web-based administrative interface for it.</p>
</dd>
<dt>Sumi</dt>
<dd><p>is completing a PhD in 19th Century history. As part of her research, she is transcribing and cataloging the records of several dozen Japanese-American midwives. She has been creating and customizing WordPress sites for several years, and has picked up bits and pieces of JavaScript while doing so. Sumi is about to start looking for a job, and wants to create an interactive website to showcase her research. This book will fill in some of the gaps in her knowledge and show her how to take advantage of JavaScript’s more modern features.</p>
</dd>
</dl>
<p>These prototypical users:</p>
<ul>
<li><p>can write two-page programs that use lists, loops, conditionals, and functions,</p></li>
<li><p>can run commands in the Unix shell to navigate the filesystem and create and delete directories and files, and</p></li>
<li><p>have reliable access to the Internet.</p></li>
</ul>
<h2 id="s:intro-contributors">Who We Are</h2>
<p><strong><a href="https://maya.rbind.io/">Maya Gans</a></strong> is a freelance data scientist and front-end developer by way of quantitative biology. She has 4 years of experience programming in R, and her passion for data visualization brought her to the weird world of JavaScript. When she isn’t debugging <a href="https://maya.rbind.io/">or blogging</a> about code, she’s somewhere remote climbing large mountains. She dedicates this book to her fellow self-taught programmers who were told they weren’t good enough but are too driven and excited to care.</p>
<p><strong><a href="https://tbyhdgs.info/">Toby Hodges</a></strong> is a bioinformatician turned community coordinator, working on the <a href="https://bio-it.embl.de">Bio-IT Project</a> at <a href="https://www.embl.de">EMBL</a>. He teaches a lot of courses in computing, organizes a lot of community-building events, listens to a lot of punk rock, and occasionally still finds time to write code and ride his bike. Toby would like to thank his wife for her support and patience while he swore about how annoying JavaScript is to debug.</p>
<p><strong><a href="https://third-bit.com/">Greg Wilson</a></strong> has worked for 35 years in both industry and academia, and is the author or editor of several books on computing and two for children. He co-founded <a href="http://carpentries.org">Software Carpentry</a>, a non-profit organization that teaches basic computing skills to researchers, and is now part of the education team at <a href="http://rstudio.com">RStudio</a>. Greg would like to thank everyone at <a href="https://rangle.io/">Rangle</a> who was so patient with him when he was learning JavaScript.</p>
<h2 id="s:intro-setup">Setting Up</h2>
<p>You can find the examples for each chapter in the <code>src</code> directory in our <a href="https://github.com/software-tools-books/js4ds">GitHub repository</a>. Each sub-folder contains the code and data needed to follow along with the text.</p>
<p>The exercises at the end of each chapter include new information that you will need later in the book, and are therefore not optional. You can do the first few online, using a service like <a href="https://runkit.com/">RunKit</a>, which gives you an interactive JavaScript playground in your browser. For larger things, and for chapters starting with the one on creating dynamic web pages (Chapter <a href="#s:dynamic" data-reference-type="ref" data-reference="s:dynamic">7</a>), you should <a href="https://nodejs.org/en/download/">download and install</a> the latest Long-term Support (LTS) versions of Node and NPM.</p>
<p><a href="#g:node-js"><strong>Node</strong></a> is an open source implementation of JavaScript that includes a command-line interpreter like those for languages such as Python and R. The command <code>node</code> on its own starts a <a href="#g:repl"><strong>read-evaluate-print loop</strong></a> (REPL) that executes commands as they are typed in and displays their output. The command <code>node filename.js</code> reads and runs the commands in <code>filename.js</code>; we will see in Chapter <a href="#s:pages" data-reference-type="ref" data-reference="s:pages">6</a> how to run JavaScript in a browser.</p>
<p><code>npm</code> is the Node <a href="#g:package-manager"><strong>Package Manager</strong></a>, a command-line tool for finding, installing, updating, building, and executing JavaScript libraries. The command <code>npm install --global library-name</code> (without a <code>.js</code> extension) installs a library <a href="#g:global-installation"><strong>globally</strong></a> so that all projects can use it, while <code>npm install --save library-name</code> installs the library <a href="#g:local-installation"><strong>locally</strong></a> (i.e., in the current project folder). Local installation is usually a better idea, since it isolates projects from one another.</p>
<h2 id="s:index-contrib">Contributing</h2>
<p>Contributions of all kinds are welcome, from errata and minor improvements to entirely new sections and chapters: please submit an issue or pull request to <a href="https://github.com/software-tools-books/js4ds/">our GitHub repository</a>. Everyone whose work is incorporated will be acknowledged; please note that all contributors are required to abide by our Code of Conduct (Appendix <a href="#s:conduct" data-reference-type="ref" data-reference="s:conduct">18</a>). Please note that we use Simplified English rather than Traditional English, i.e., American rather than British spelling and grammar. We encourage translations; if you would like to take this on, please <a href="mailto:gvwilson@third-bit.com">email us</a>.</p>
<p>If you wish to report errata or suggest improvements to wording, please include the chapter name in the first line of the body of your report (e.g., <code>Testing Data Analysis</code>).</p>
<h3 id="s:intro-acknowledgments">Acknowledgments</h3>
<p>We are grateful as always to Shashi Kumar for help with the LaTeX. We are also grateful for fixes from:</p>
<ul>
<li><p><a href="https://asbates.rbind.io/">Andrew Bates</a></p></li>
<li><p><a href="https://github.com/sdruskat">Stephan Druskat</a></p></li>
<li><p><a href="https://github.com/cRAN-cg">Chiranjeev Gupta</a></p></li>
<li><p><a href="https://github.com/karchern">Nicolai Karcher</a></p></li>
<li><p><a href="https://erictleung.com/">Eric Leung</a></p></li>
<li><p><a href="https://github.com/pdm55">Peter Munro</a></p></li>
<li><p><a href="http://www.leouieda.com/">Leonardo Uieda</a></p></li>
</ul>
<h2 id="s:intro-exercises">Exercises</h2>
<h3 class="unnumbered" id="setting-up">Setting Up</h3>
<p><a href="https://nodejs.org/en/download/">Install Node</a> on your computer, then run the commands <code>node --version</code> and <code>npm --version</code> to see which versions you have.</p>
<h2 class="unnumbered" id="key-points">Key Points</h2>
<ul>
<li><p>Modern JavaScript is a good tool for building desktop and web-based applications.</p></li>
<li><p>This course is for people who know what loops and functions are, but have never used JavaScript or built web applications.</p></li>
<li><p>Node is a command-line interpreter for JavaScript, which can be used interactively or to run scripts in files.</p></li>
<li><p>NPM is the Node Package Manager, which can be used to find, install, update, build, and execute JavaScript libraries.</p></li>
</ul>
<h1 id="s:basics">Basic Features</h1>
<p>This lesson introduces the core features of JavaScript, including how to run programs, the language’s basic data types, arrays and objects, loops, conditionals, functions, and modules. All of these concepts should be familiar if you have programmed before.</p>
<h2 id="s:basics-hello-world">Hello, World</h2>
<p>Use your favorite text editor to put the following line in a file called <code>hello.js</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;hello, world&#39;</span>)</span></code></pre></div>
<p><code>console</code> is a built-in <a href="#g:module"><strong>module</strong></a> that provides basic printing services (among other things). As in many languages, we use the <a href="#g:dotted-notation"><strong>dotted notation</strong></a> <code>X.Y</code> to get part <code>Y</code> of thing <code>X</code>—in this case, to get <code>console</code>’s <code>log</code> function. <a href="#g:string"><strong>Character strings</strong></a> like <code>’hello, world’</code> can be written with either single quotes or double quotes, so long as the quotation marks match, and semi-colons at the ends of statements are now (mostly) optional.</p>
<p>To run a program, type <code>node program_name.js</code> at the command line. (We will preface shell commands with <code>$</code> to make them easier to spot.)</p>
<pre class="shell"><code>$ node src/basics/hello.js</code></pre>
<pre class="text"><code>hello, world</code></pre>
<h2 id="s:basics-data-types">Basic Data Types</h2>
<p>JavaScript has the usual datatypes, though unlike C, Python, and many other languages, there is no separate type for integers: it stores all numbers as 64-bit floating-point values, which is accurate up to about 15 decimal digits. We can check this using <code>typeof</code>, which returns a string. (Note: <code>typeof</code> is an operator, <em>not</em> a function: we apply it to something by typing a space followed by the name of the thing we’d like to check the type of, e.g., <code>typeof dress</code> as opposed to <code>typeof(dress)</code>.) We use it alongside <code>const</code> below, which itself is helpful when we want to give a name to a <a href="#g:constant"><strong>constant</strong></a> value:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> aNumber <span class="op">=</span> <span class="fl">123.45</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;the type of&#39;</span><span class="op">,</span> aNumber<span class="op">,</span> <span class="st">&#39;is&#39;</span><span class="op">,</span> <span class="kw">typeof</span> aNumber)</span></code></pre></div>
<pre class="text"><code>the type of 123.45 is number</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> anInteger <span class="op">=</span> <span class="dv">123</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;the type of&#39;</span><span class="op">,</span> anInteger<span class="op">,</span> <span class="st">&#39;is&#39;</span><span class="op">,</span> <span class="kw">typeof</span> anInteger)</span></code></pre></div>
<pre class="text"><code>the type of 123 is number</code></pre>
<p>We have already met strings, which may contain any <a href="#g:unicode"><strong>Unicode</strong></a> character:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> aString <span class="op">=</span> <span class="st">&#39;some text&#39;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;the type of&#39;</span><span class="op">,</span> aString<span class="op">,</span> <span class="st">&#39;is&#39;</span><span class="op">,</span> <span class="kw">typeof</span> aString)</span></code></pre></div>
<pre class="text"><code>the type of some text is string</code></pre>
<p>Functions are also a type of data, a fact whose implications we will explore in Chapter <a href="#s:callbacks" data-reference-type="ref" data-reference="s:callbacks">3</a>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;the type of&#39;</span><span class="op">,</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span><span class="op">,</span> <span class="st">&#39;is&#39;</span><span class="op">,</span> <span class="kw">typeof</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>)</span></code></pre></div>
<pre class="text"><code>the type of function () { [native code] } is function</code></pre>
<p>Rather than showing the other basic types one by one, we will put three values in a list and loop over it:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> otherValues <span class="op">=</span> [<span class="kw">true</span><span class="op">,</span> <span class="kw">undefined</span><span class="op">,</span> <span class="kw">null</span>]</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> value <span class="kw">of</span> otherValues) {</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;the type of&#39;</span><span class="op">,</span> value<span class="op">,</span> <span class="st">&#39;is&#39;</span><span class="op">,</span> <span class="kw">typeof</span> value)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre class="text"><code>the type of true is boolean
the type of undefined is undefined
the type of null is object</code></pre>
<p>As the example above shows, we create an array of values to loop through called <code>otherValues</code>. We initiate our loop with the word <code>for</code>. Within the parentheses, <code>let</code> creates a variable called <code>value</code> to iterate over each element within <code>otherValues</code>, and <code>value</code> is the changing array value of <code>otherValues</code>. Finally, within the curly braces we perform our desired operation on every value.</p>
<p>Note that we use <code>let</code> rather than the older <code>var</code> and <code>of</code> rather than <code>in</code>: the latter returns the indexes of the collection (e.g., 0, 1, 2), which has some traps for the unwary (Appendix <a href="#s:legacy-iteration" data-reference-type="ref" data-reference="s:legacy-iteration">23.2</a>). Note also that indexing starts from 0 rather than 1, and that indentation is optional and for readability purposes only. This may be different from the language that you’re used to.</p>
<blockquote>
<h4 id="constants-versus-variables" class="unnumbered">Constants versus Variables</h4>
<p>You should make things constants unless they really need to be variables because it’s easier for both people and computers to keep track of things that are defined once and never change.</p>
</blockquote>
<p>After all this, the types themselves are somewhat anticlimactic. JavaScript’s <a href="#g:boolean"><strong><code>boolean</code></strong></a> type can be either <code>true</code> or <code>false</code>, though we will see below that other things can be treated as Booleans. <code>undefined</code> means “hasn’t been given a value”, while <code>null</code> means “has a value, which is nothing”.</p>
<h2 id="s:basics-control-flow">Control Flow</h2>
<p>We have already seen <code>for</code> loops and flat arrays, so let’s have a look at nested arrays and conditionals. We start with arrays that contain other arrays, which are usually processed by <a href="#g:nested-loop"><strong>nested loops</strong></a>:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> nested <span class="op">=</span> [[<span class="st">&#39;northwest&#39;</span><span class="op">,</span> <span class="st">&#39;northeast&#39;</span>]<span class="op">,</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                [<span class="st">&#39;southwest&#39;</span><span class="op">,</span> <span class="st">&#39;southeast&#39;</span>]]</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> outer <span class="kw">of</span> nested) {</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> inner <span class="kw">of</span> outer) {</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(inner)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre class="text"><code>northwest
northeast
southwest
southeast</code></pre>
<p>The <a href="#g:inner-loop"><strong>inner loop</strong></a> runs a complete cycle of iterations for each iteration of the <a href="#g:outer-loop"><strong>outer loop</strong></a>. Each value assigned to the variable <code>outer</code> is a pair, so each value assigned to <code>inner</code> is one of the two strings from that pair (Figure <a href="#f:basics-traversal" data-reference-type="ref" data-reference="f:basics-traversal">2.1</a>).</p>
<figure>
<img src="figures/basics-traversal.svg" id="f:basics-traversal" /><figcaption aria-hidden="true"><span>Nested Loop Traversal</span><span id="f:basics-traversal" label="f:basics-traversal">[f:basics-traversal]</span></figcaption>
</figure>
<p>A JavaScript program can also make choices: it executes the <a href="#g:body-statement"><strong>body</strong></a> of an <code>if</code> statement if and only if the <a href="#g:condition"><strong>condition</strong></a> is true. Each <code>if</code> can have an <code>else</code>, whose body is only executed if the condition <em>isn’t</em> true:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> values <span class="op">=</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="st">&#39;text&#39;</span><span class="op">,</span> <span class="kw">undefined</span><span class="op">,</span> <span class="kw">null</span><span class="op">,</span> []<span class="op">,</span> [<span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>]]</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> element <span class="kw">of</span> values) {</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (element) {</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(element<span class="op">,</span> <span class="st">&#39;of type&#39;</span><span class="op">,</span> <span class="kw">typeof</span> element<span class="op">,</span> <span class="st">&#39;is truthy&#39;</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(element<span class="op">,</span> <span class="st">&#39;of type&#39;</span><span class="op">,</span> <span class="kw">typeof</span> element<span class="op">,</span> <span class="st">&#39;is falsy&#39;</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre class="text"><code>0 of type number is falsy
1 of type number is truthy
 of type string is falsy
text of type string is truthy
undefined of type undefined is falsy
null of type object is falsy
 of type object is truthy
2,3 of type object is truthy</code></pre>
<p>This example shows that arrays are <a href="#g:heterogeneous"><strong>heterogeneous</strong></a>, i.e., that they can contain values of many different types. It also shows that JavaScript has some rather odd ideas about the nature of truth. 0 is <a href="#g:falsy"><strong>falsy</strong></a>, while all other numbers are <a href="#g:truthy"><strong>truthy</strong></a>; similarly, the empty string is falsy and all other strings are truthy. <code>undefined</code> and <code>null</code> are both falsy, as most programmers would expect.</p>
<p>But as the last two lines of output show, an empty array is truthy, which is different from its treatment in most programming languages. The argument made by JavaScript’s advocates is that an empty array is there, it just happens to be empty, but this behavior is still a common cause of bugs. When testing an array, check that <code>Array.length</code> is zero. (Note that this is a <a href="#g:property"><strong>property</strong></a>, not a <a href="#g:method"><strong>method</strong></a>, i.e., it should be treated as a variable, not called like a function.)</p>
<blockquote>
<h4 id="safety-tip" class="unnumbered">Safety Tip</h4>
<p>Always use <code>===</code> (triple equals) and <code>!==</code> when testing for equality and inequality in JavaScript. <code>==</code> and <code>!=</code> do type conversion, which can produce some ugly surprises (Section <a href="#s:legacy-equality" data-reference-type="ref" data-reference="s:legacy-equality">23.1</a>).</p>
</blockquote>
<h2 id="s:basics-formatting">Formatting Strings</h2>
<p>Rather than printing multiple strings and expressions, we can <a href="#g:string-interpolation"><strong>interpolate</strong></a> values into a back-quoted string. (We have to use back quotes because this feature was added to JavaScript long after the language was first created.) As the example below shows, the value to be interpolated is put in <code>${...}</code>, and can be any valid JavaScript expression, including a function or method call.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> color <span class="kw">of</span> [<span class="st">&#39;red&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]) {</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> message <span class="op">=</span> <span class="vs">`color is </span><span class="sc">${</span>color<span class="sc">}</span><span class="vs">`</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(message<span class="op">,</span> <span class="vs">`and capitalized is </span><span class="sc">${</span>color<span class="op">.</span><span class="fu">toUpperCase</span>()<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre class="text"><code>color is red and capitalized is RED
color is green and capitalized is GREEN
color is blue and capitalized is BLUE</code></pre>
<p>This allows us to succinctly add variables to a string instead of:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> message <span class="op">=</span> <span class="st">&quot;color is&quot;</span> <span class="op">+</span> color <span class="op">+</span> <span class="st">&quot;and capitalized is &quot;</span> <span class="op">+</span> color<span class="op">.</span><span class="fu">toUpperCase</span>()</span></code></pre></div>
<h2 id="s:basics-objects">Objects</h2>
<p>An <a href="#g:object"><strong>object</strong></a> in JavaScript is a collection of key-value pairs, and is equivalent in simple cases to what Python would call a dictionary. It’s common to visualize an object as a two-column table with the keys in one column and the values in another (Figure <a href="#f:basics-object-table" data-reference-type="ref" data-reference="f:basics-object-table">2.2</a>). The keys must be strings; the values can be anything. We can create an object by putting key-value pairs in curly brackets; there must be a colon between the key and the value, and pairs must be separated by commas like the elements of arrays:</p>
<figure>
<img src="figures/basics-object-table.svg" id="f:basics-object-table" /><figcaption aria-hidden="true"><span>Objects in Memory</span><span id="f:basics-object-table" label="f:basics-object-table">[f:basics-object-table]</span></figcaption>
</figure>
<div class="sourceCode" id="cb21"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> creature <span class="op">=</span> {</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;order&#39;</span><span class="op">:</span> <span class="st">&#39;Primates&#39;</span><span class="op">,</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;family&#39;</span><span class="op">:</span> <span class="st">&#39;Callitrichidae&#39;</span><span class="op">,</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;genus&#39;</span><span class="op">:</span> <span class="st">&#39;Callithrix&#39;</span><span class="op">,</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;species&#39;</span><span class="op">:</span> <span class="st">&#39;Jacchus&#39;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`creature is </span><span class="sc">${</span>creature<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`creature.genus is </span><span class="sc">${</span>creature<span class="op">.</span><span class="at">genus</span><span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> key <span class="kw">in</span> creature) {</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`creature[</span><span class="sc">${</span>key<span class="sc">}</span><span class="vs">] is </span><span class="sc">${</span>creature[key]<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre class="text"><code>creature is [object Object]
creature.genus is Callithrix
creature[order] is Primates
creature[family] is Callitrichidae
creature[genus] is Callithrix
creature[species] is Jacchus</code></pre>
<p>The type of an object is always <code>object</code>. We can get the value associated with a key using <code>object[key]</code>, but if the key has a simple name, we can use <code>object.key</code> instead. Note that the square bracket form can be used with variables for keys, but the dotted notation cannot: i.e., <code>creature.genus</code> is the same as <code>creature[’genus’]</code>, but the assignment <code>g = ’genus’</code> followed by <code>creature.g</code> does not work.</p>
<p>Because string keys are so common, and because programmers use simple names so often, JavaScript allows us to create objects without quoting the names of the keys:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> creature <span class="op">=</span> {</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">order</span><span class="op">:</span> <span class="st">&#39;Primates&#39;</span><span class="op">,</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">family</span><span class="op">:</span> <span class="st">&#39;Callitrichidae&#39;</span><span class="op">,</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">genus</span><span class="op">:</span> <span class="st">&#39;Callithrix&#39;</span><span class="op">,</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">species</span><span class="op">:</span> <span class="st">&#39;Jacchus&#39;</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><code>[object Object]</code> is not particularly useful output when we want to see what an object contains. To get a more helpful string representation, use <code>JSON.stringify(object)</code>:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="bu">JSON</span><span class="op">.</span><span class="fu">stringify</span>(creature))</span></code></pre></div>
<pre class="text"><code>{&quot;order&quot;:&quot;Primates&quot;,&quot;family&quot;:&quot;Callitrichidae&quot;,
 &quot;genus&quot;:&quot;Callithrix&quot;,&quot;species&quot;:&quot;Jacchus&quot;}</code></pre>
<p>Here, “JSON” stands for “JavaScript Object Notation”; we will learn more about it in Chapter <a href="#s:dataman" data-reference-type="ref" data-reference="s:dataman">11</a>.</p>
<h2 id="s:basics-functions">Functions</h2>
<p>Functions make it possible for mere mortals to understand programs by allowing us to think about them one piece at a time. Here is a function that finds the lowest and highest values in an array:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">limits</span> (values) {</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>values<span class="op">.</span><span class="at">length</span>) {</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [<span class="kw">undefined</span><span class="op">,</span> <span class="kw">undefined</span>]</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> low <span class="op">=</span> values[<span class="dv">0</span>]</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> high <span class="op">=</span> values[<span class="dv">0</span>]</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> v <span class="kw">of</span> values) {</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (v <span class="op">&lt;</span> low) low <span class="op">=</span> v</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (v <span class="op">&gt;</span> high) high <span class="op">=</span> v</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [low<span class="op">,</span> high]</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Its definition consists of the keyword <code>function</code>, its name, a parenthesized list of <a href="#g:parameter"><strong>parameters</strong></a> (which might be empty), and its body.</p>
<p>The body of the function begins with a test of the thing, referred to inside the function as <code>values</code>, provided as an <a href="#g:argument"><strong>argument</strong></a> to the function. If <code>values</code> has no length—i.e., it does not consist of multiple entries—the function returns <code>[undefined,undefined]</code>. (We will address the rationale behind this behavior in the exercises.)</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>values<span class="op">.</span><span class="at">length</span>) {</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [<span class="kw">undefined</span><span class="op">,</span> <span class="kw">undefined</span>]</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>If that initial check finds that <code>values</code> does have a length—i.e., <code>!values.length</code> returns <code>false</code>—the rest of the function is run. This involves first initializing two variables, <code>low</code> and <code>high</code>, with their values set as equal to the first item in <code>values</code>.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> low <span class="op">=</span> values[<span class="dv">0</span>]</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> high <span class="op">=</span> values[<span class="dv">0</span>]</span></code></pre></div>
<p>In the next stage of the function, all of the values are iterated over and <code>low</code> and <code>high</code> are assigned a new value, equal to that of the next item, if that value is lower than <code>low</code> or higher than <code>high</code> respectively.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> v <span class="kw">of</span> values) {</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (v <span class="op">&lt;</span> low) low <span class="op">=</span> v</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (v <span class="op">&gt;</span> high) high <span class="op">=</span> v</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>Once all of the items in <code>values</code> have been examined, the values of <code>low</code> and <code>high</code> are the minimum and maximum of <code>values</code>. These are returned as a pair inside an array.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [low<span class="op">,</span> high]</span></code></pre></div>
<p>Note that we can use <code>return</code> to explicitly return a value at any time; if nothing is returned, the function’s result is <code>undefined</code>.</p>
<p>One oddity of JavaScript is that almost anything can be compared to almost anything else. Here are a few tests that demonstrate this:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> allTests <span class="op">=</span> [</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  []<span class="op">,</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  [<span class="dv">9</span>]<span class="op">,</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  [<span class="dv">3</span><span class="op">,</span> <span class="dv">30</span><span class="op">,</span> <span class="dv">300</span>]<span class="op">,</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  [<span class="st">&#39;apple&#39;</span><span class="op">,</span> <span class="st">&#39;Grapefruit&#39;</span><span class="op">,</span> <span class="st">&#39;banana&#39;</span>]<span class="op">,</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  [<span class="dv">3</span><span class="op">,</span> <span class="st">&#39;apple&#39;</span><span class="op">,</span> [<span class="st">&#39;sub-array&#39;</span>]]</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> test <span class="kw">of</span> allTests) {</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`limits of </span><span class="sc">${</span>test<span class="sc">}</span><span class="vs"> are </span><span class="sc">${</span><span class="fu">limits</span>(test)<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre class="text"><code>limits of  are ,
limits of 9 are 9,9
limits of 3,30,300 are 3,300
limits of apple,Grapefruit,banana are Grapefruit,banana
limits of 3,apple,sub-array are 3,3</code></pre>
<p>Programmers generally don’t write functions this way any longer, since it interacts in odd ways with other features of the language; Section <a href="#s:legacy-prototypes" data-reference-type="ref" data-reference="s:legacy-prototypes">23.3</a> explains why and how in more detail. Instead, most programmers now write <a href="#g:fat-arrow"><strong>fat arrow functions</strong></a> consisting of a parameter list, the <code>=&gt;</code> symbol, and a body. Fat arrow functions don’t have names, so the function must be assigned that to a constant or variable for later use:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> limits <span class="op">=</span> (values) <span class="kw">=&gt;</span> {</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>values<span class="op">.</span><span class="at">length</span>) {</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [<span class="kw">undefined</span><span class="op">,</span> <span class="kw">undefined</span>]</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> low <span class="op">=</span> values[<span class="dv">0</span>]</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> high <span class="op">=</span> values[<span class="dv">0</span>]</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> v <span class="kw">of</span> values) {</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (v <span class="op">&lt;</span> low) low <span class="op">=</span> v</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (v <span class="op">&gt;</span> high) high <span class="op">=</span> v</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [low<span class="op">,</span> high]</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>No matter how functions are defined, each one is a <a href="#g:scope"><strong>scope</strong></a>, which means its parameters and any variables created inside it are <a href="#g:local-variable"><strong>local</strong></a> to the function. We will discuss scope in more detail in Chapter <a href="#s:callbacks" data-reference-type="ref" data-reference="s:callbacks">3</a>.</p>
<blockquote>
<h4 id="stuck-in-the-past" class="unnumbered">Stuck in the Past</h4>
<p>Why did JavaScript introduce another syntax rather than fixing the behavior of those defined with <code>function</code>? The twin answers are that changes would break legacy programs that rely on the old behavior, and that the language’s developers wanted to make it really easy to define little functions. Here and elsewhere, we will see how a language’s history and use shape its evolution.</p>
</blockquote>
<h2 id="s:basics-modules">Modules</h2>
<p>As our programs grow larger, we will want to put code in multiple files. The unavoidable bad news is that JavaScript has several module systems: Node still uses one called CommonJS, but is converting to the modern standard called ES6, so what we use on the command line is different from what we use in the browser (for now).</p>
<blockquote>
<h4 id="ee-ess" class="unnumbered">Ee Ess</h4>
<p>JavaScript’s official name is ECMAScript, though only people who use the word “datum” in everyday conversation ever call it that. Successive versions of the language are therefore known as ES5, ES6, and so on, except when they’re referred to as (for example) ES2018.</p>
</blockquote>
<p>Since we’re going to build command-line programs before doing anything in the browser, we will introduce Node’s module system first (Figure <a href="#f:basics-require" data-reference-type="ref" data-reference="f:basics-require">2.3</a>). We start by putting this code in a file called <code>utilities.js</code>:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>DEFAULT_BOUND <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> clip <span class="op">=</span> (values<span class="op">,</span> bound <span class="op">=</span> DEFAULT_BOUND) <span class="kw">=&gt;</span> {</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> result <span class="op">=</span> []</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> v <span class="kw">of</span> values) {</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (v <span class="op">&lt;=</span> bound) {</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>      result<span class="op">.</span><span class="fu">push</span>(v)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> {</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">clip</span><span class="op">:</span> clip</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The function definition is straightforward; as you may have guessed, <code>bound = DEFAULT_BOUND</code> sets a default value for that parameter so that <code>clip</code> can be called with just an array. You may also have guessed that <code>Array.push</code> appends a value to the end of an array; if you didn’t, well, now you know.</p>
<p>What’s more important is assigning an object to <code>module.exports</code>. Only those things named in this object are visible to the outside world, so <code>DEFAULT_BOUND</code> won’t be. Remember, keys that are simple names don’t have to be quoted, so <code>clip: clip</code> means “associate a reference to the function <code>clip</code> with the string key <code>"clip"</code>.</p>
<p>To use our newly-defined module we must <code>require</code> it. For example, we can put this in <code>application.js</code>:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> utilities <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;./utilities&#39;</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> data <span class="op">=</span> [<span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">10</span>]</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`clip(</span><span class="sc">${</span>data<span class="sc">}</span><span class="vs">) -&gt; </span><span class="sc">${</span>utilities<span class="op">.</span><span class="fu">clip</span>(data)<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`clip(</span><span class="sc">${</span>data<span class="sc">}</span><span class="vs">, 5) -&gt; </span><span class="sc">${</span>utilities<span class="op">.</span><span class="fu">clip</span>(data<span class="op">,</span> <span class="dv">5</span>)<span class="sc">}</span><span class="vs">`</span>)</span></code></pre></div>
<pre class="text"><code>clip(-1,5,3,0,10) -&gt; -1,3,0
clip(-1,5,3,0,10, 5) -&gt; -1,5,3,0</code></pre>
<p><code>require</code> returns the object that was assigned to <code>module.exports</code>, so if we have assigned its result to a variable called <code>utilities</code>, we must then call our function as <code>utilities.clip</code>. We use a relative path starting with <code>./</code> or <code>../</code> to import local files; paths that start with names are taken from installed Node libraries.</p>
<figure>
<img src="figures/basics-require.svg" id="f:basics-require" /><figcaption aria-hidden="true"><span>How Require Works</span><span id="f:basics-require" label="f:basics-require">[f:basics-require]</span></figcaption>
</figure>
<h2 id="s:basics-exercises">Exercises</h2>
<h3 class="unnumbered" id="typeof">Typeof</h3>
<p>What kind of thing is <code>typeof</code>? Is it an expression? A function? Something else? (You might notice that <code>typeof typeof</code> is syntactically invalid. In such circumstances, an Internet search engine is your friend, as is the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference">Mozilla Developer Network</a> JavaScript reference.)</p>
<h3 class="unnumbered" id="fill-in-the-blanks">Fill in the Blanks</h3>
<p>Answer these questions about the program below:</p>
<ol>
<li><p>What does <code>Array.push</code> do?</p></li>
<li><p>How does a <code>while</code> loop work?</p></li>
<li><p>What does <code>+=</code> do?</p></li>
<li><p>What does <code>Array.reverse</code> do, and what does it return?</p></li>
</ol>
<div class="sourceCode" id="cb37"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> current <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> table <span class="op">=</span> []</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (current <span class="op">&lt;</span> <span class="dv">5</span>) {</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> entry <span class="op">=</span> <span class="vs">`square of </span><span class="sc">${</span>current<span class="sc">}</span><span class="vs"> is </span><span class="sc">${</span>current <span class="op">*</span> current<span class="sc">}</span><span class="vs">`</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  table<span class="op">.</span><span class="fu">push</span>(entry)</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  current <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>table<span class="op">.</span><span class="fu">reverse</span>()</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> line <span class="kw">of</span> table) {</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(line)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre class="text"><code>square of 4 is 16
square of 3 is 9
square of 2 is 4
square of 1 is 1
square of 0 is 0</code></pre>
<h3 class="unnumbered" id="what-is-truth">What Is Truth?</h3>
<p>Write a function called <code>isTruthy</code> that returns <code>true</code> for everything that JavaScript considers truthy, and <code>false</code> for everything it considers <code>falsy</code> <em>except</em> empty arrays: <code>isTruthy</code> should return <code>false</code> for those.</p>
<h3 class="unnumbered" id="the-shape-of-things-to-come">The Shape of Things to Come</h3>
<p>We wrote the example function, <code>limits</code>, above to return <code>[undefined,undefined]</code> if a variable with no length is fed into it. What is the advantage of doing this as opposed to returning <code>undefined</code> only?</p>
<h3 class="unnumbered" id="combining-different-types">Combining Different Types</h3>
<p>What does <a href="#g:nan"><strong><code>NaN</code></strong></a> represent? What output would you expect from the code below? Try running it and see whether the results match your expectations. What are the implications of this behavior when working with real-world data?</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> first <span class="op">=</span> [<span class="dv">3</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span> <span class="dv">8</span><span class="op">,</span> <span class="dv">9</span><span class="op">,</span> <span class="dv">1</span>]</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`aggregating </span><span class="sc">${</span>first<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> total <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> d <span class="kw">of</span> first) {</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  total <span class="op">+=</span> d</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(total)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> second <span class="op">=</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="kw">NaN</span><span class="op">,</span> <span class="dv">8</span>]</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`aggregating </span><span class="sc">${</span>second<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>total <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> d <span class="kw">of</span> second) {</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>  total <span class="op">+=</span> d</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(total)</span></code></pre></div>
<h3 class="unnumbered" id="what-does-this-do">What Does This Do?</h3>
<p>Explain what is happening in the assignment statement that creates the constant <code>creature</code>.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> genus <span class="op">=</span> <span class="st">&#39;Callithrix&#39;</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> species <span class="op">=</span> <span class="st">&#39;Jacchus&#39;</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> creature <span class="op">=</span> {genus<span class="op">,</span> species}</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(creature)</span></code></pre></div>
<pre class="text"><code>{ genus: &#39;Callithrix&#39;, species: &#39;Jacchus&#39; }</code></pre>
<h3 class="unnumbered" id="destructuring-assignment">Destructuring Assignment</h3>
<p>When this short program runs:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> creature <span class="op">=</span> {</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">genus</span><span class="op">:</span> <span class="st">&#39;Callithrix&#39;</span><span class="op">,</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">species</span><span class="op">:</span> <span class="st">&#39;Jacchus&#39;</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> {genus<span class="op">,</span> species} <span class="op">=</span> creature</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`genus is </span><span class="sc">${</span>genus<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`species is </span><span class="sc">${</span>species<span class="sc">}</span><span class="vs">`</span>)</span></code></pre></div>
<p>it produces the output:</p>
<pre class="text"><code>genus is Callithrix
species is Jacchus</code></pre>
<p>but when this program runs:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> creature <span class="op">=</span> {</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">first</span><span class="op">:</span> <span class="st">&#39;Callithrix&#39;</span><span class="op">,</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">second</span><span class="op">:</span> <span class="st">&#39;Jacchus&#39;</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> {genus<span class="op">,</span> species} <span class="op">=</span> creature</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`genus is </span><span class="sc">${</span>genus<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`species is </span><span class="sc">${</span>species<span class="sc">}</span><span class="vs">`</span>)</span></code></pre></div>
<p>it produces:</p>
<pre class="text"><code>genus is undefined
species is undefined</code></pre>
<ol>
<li><p>What is the difference between these two programs?</p></li>
<li><p>How does <a href="#g:destructuring"><strong>destructuring assignment</strong></a> work in general?</p></li>
<li><p>How can we use this technique to rewrite the <code>require</code> statement in <code>src/basics/application.js</code> so that <code>clip</code> can be called directly as <code>clip(...)</code> rather than as <code>utilities.clip(...)</code>?</p></li>
</ol>
<h3 class="unnumbered" id="return-to-me-for-my-heart-wants-you-only">Return To Me, For My Heart Wants You Only</h3>
<p>What output would you see in the console if you ran this code?</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> verbose_sum <span class="op">=</span> (first<span class="op">,</span> second) <span class="kw">=&gt;</span> {</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Going to add </span><span class="sc">${</span>first<span class="sc">}</span><span class="vs"> to </span><span class="sc">${</span>second<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> total <span class="op">=</span> first <span class="op">+</span> second</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> total</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Finished summing`</span>)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> result <span class="op">=</span> <span class="fu">verbose_sum</span>(<span class="dv">3</span><span class="op">,</span> <span class="dv">6</span>)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(result)</span></code></pre></div>
<ol>
<li><p><code>Going to add ${first} to ${second}</code><br />
<code>9</code></p></li>
<li><p><code>Going to add 3 to 6</code><br />
<code>9</code><br />
<code>Finished summing</code></p></li>
<li><p><code>Going to add 3 to 6</code><br />
<code>9</code></p></li>
<li><p><code>Going to add 3 to 6</code><br />
<code>36</code></p></li>
</ol>
<h2 class="unnumbered" id="key-points-1">Key Points</h2>
<ul>
<li><p>Use <code>console.log</code> to print messages.</p></li>
<li><p>Use dotted notation <code>X.Y</code> to get part <code>Y</code> of object <code>X</code>.</p></li>
<li><p>Basic data types are Booleans, numbers, and character strings.</p></li>
<li><p>Arrays store multiple values in order.</p></li>
<li><p>The special values <code>null</code> and <code>undefined</code> mean ‘no value’ and ‘does not exist’.</p></li>
<li><p>Define constants with <code>const</code> and variables with <code>let</code>.</p></li>
<li><p><code>typeof</code> returns the type of a value.</p></li>
<li><p><code>for (let variable of collection) {...}</code> iterates through the values in an array.</p></li>
<li><p><code>if (condition) {...} else {...}</code> conditionally executes some code.</p></li>
<li><p><code>false</code>, 0, the empty string, <code>null</code>, and <code>undefined</code> are false; everything else is true.</p></li>
<li><p>Use back quotes and <code>${...}</code> to interpolate values into strings.</p></li>
<li><p>An object is a collection of name/value pairs written in <code>{...}</code>.</p></li>
<li><p><code>object[key]</code> or <code>object.key</code> gets a value from an object.</p></li>
<li><p>Functions are objects that can be assigned to variables, stored in lists, etc.</p></li>
<li><p><code>function name(...parameters...) {...body...}</code> is the old way to define a function.</p></li>
<li><p><code>name = (...parameters...) =&gt; {...body...}</code> is the new way to define a function.</p></li>
<li><p>Use <code>return</code> inside a function body to return a value at any point.</p></li>
<li><p>Use modules to divide code between multiple files for re-use.</p></li>
<li><p>Assign to <code>module.exports</code> to specify what a module exports.</p></li>
<li><p><code>require(...path...)</code> imports a module.</p></li>
<li><p>Paths beginning with ‘.’ or ‘/’ are imported locally, but paths without ‘.’ or ‘/’ look in the library.</p></li>
</ul>
<h1 id="s:callbacks">Callbacks</h1>
<p>JavaScript relies heavily on <a href="#g:callback-function"><strong>callback functions</strong></a>: Instead of a function giving us a result immediately, we give it another function that tells it what to do next. Many other languages use them as well, but JavaScript is often the first place that programmers with data science backgrounds encounter them. In order to understand how they work and how to use them, we must first understand what actually happens when functions are defined and called.</p>
<h2 id="s:callbacks-callstack">The Call Stack</h2>
<p>When JavaScript <a href="#g:parse"><strong>parses</strong></a> the expression <code>let name = "text"</code>, it allocates a block of memory big enough for four characters and stores a reference to that block of characters in the variable <code>name</code>. We can show this by drawing a <a href="#g:memory-diagram"><strong>memory diagram</strong></a> like the one in Figure <a href="#f:callbacks-name-value" data-reference-type="ref" data-reference="f:callbacks-name-value">3.1</a>.</p>
<figure>
<img src="figures/callbacks-name-value.svg" id="f:callbacks-name-value" /><figcaption aria-hidden="true"><span>Name and Value</span><span id="f:callbacks-name-value" label="f:callbacks-name-value">[f:callbacks-name-value]</span></figcaption>
</figure>
<p>When we write:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>oneMore <span class="op">=</span> (x) <span class="kw">=&gt;</span> {</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> x <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>JavaScript allocates a block of memory big enough to store several instructions, translates the text of the function into instructions, and stores a reference to those instructions in the variable <code>oneMore</code> (Figure <a href="#f:callbacks-one-more" data-reference-type="ref" data-reference="f:callbacks-one-more">3.2</a>).</p>
<figure>
<img src="figures/callbacks-one-more.svg" id="f:callbacks-one-more" /><figcaption aria-hidden="true"><span>Functions in Memory</span><span id="f:callbacks-one-more" label="f:callbacks-one-more">[f:callbacks-one-more]</span></figcaption>
</figure>
<p>The only difference between these two cases is what’s on the other end of the reference: four characters or a bunch of instructions that add one to a number. This means that we can assign the function to another variable, just as we would assign a number:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co">// assign the function oneMore to the variable anotherName </span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> anotherName <span class="op">=</span> oneMore</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co">// instead of calling the function oneMore we can call the function anotherName</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">anotherName</span>(<span class="dv">5</span>))</span></code></pre></div>
<pre class="text"><code>6</code></pre>
<p>Doing this does <em>not</em> call the function: as Figure <a href="#f:callbacks-alias-function" data-reference-type="ref" data-reference="f:callbacks-alias-function">3.3</a> shows, it creates a second name, or <a href="#g:alias"><strong>alias</strong></a>, that refers to the same block of instructions.</p>
<figure>
<img src="figures/callbacks-alias-function.svg" id="f:callbacks-alias-function" /><figcaption aria-hidden="true"><span>Aliasing a Function</span><span id="f:callbacks-alias-function" label="f:callbacks-alias-function">[f:callbacks-alias-function]</span></figcaption>
</figure>
<p>As explained in Chapter <a href="#s:basics" data-reference-type="ref" data-reference="s:basics">2</a>, when JavaScript calls a function it assigns the arguments in the call to the function’s parameters. In order for this to be safe, we need to ensure that there are no <a href="#g:name-collision"><strong>name collisions</strong></a>, i.e., that if there is a variable called <code>something</code> and one of the function’s parameters is also called <code>something</code>, the function will use the right one. The way every modern language implements this is to use a <a href="#g:call-stack"><strong>call stack</strong></a>. Instead of putting all our variables in one big table, we have one table for global variables and one extra table for each function call. This means that if we assign 100 to <code>x</code>, call <code>oneMore(2 * x + 1)</code>, and look at memory in the middle of that call, we will see what’s in Figure <a href="#f:callbacks-call-stack" data-reference-type="ref" data-reference="f:callbacks-call-stack">3.4</a>.</p>
<figure>
<img src="figures/callbacks-call-stack.svg" id="f:callbacks-call-stack" /><figcaption aria-hidden="true"><span>The Call Stack</span><span id="f:callbacks-call-stack" label="f:callbacks-call-stack">[f:callbacks-call-stack]</span></figcaption>
</figure>
<h2 id="s:callbacks-func">Functions of Functions</h2>
<p>The call stack allows us to write and call functions without worrying about whether we’re accidentally going to refer to the wrong variable. And since functions are just another kind of data, we can pass one function into another. For example, we can write a function called <code>doTwice</code> that calls some other function two times:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> doTwice <span class="op">=</span> (action) <span class="kw">=&gt;</span> {</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">action</span>()</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">action</span>()</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> hello <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;hello&#39;</span>)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="fu">doTwice</span>(hello)</span></code></pre></div>
<pre class="text"><code>hello
hello</code></pre>
<p>Again, this is clearer when we look at the state of memory while <code>doTwice</code> is running (Figure <a href="#f:callbacks-do-twice" data-reference-type="ref" data-reference="f:callbacks-do-twice">3.5</a>).</p>
<figure>
<img src="figures/callbacks-do-twice.svg" id="f:callbacks-do-twice" /><figcaption aria-hidden="true"><span>Functions of Functions</span><span id="f:callbacks-do-twice" label="f:callbacks-do-twice">[f:callbacks-do-twice]</span></figcaption>
</figure>
<p>This becomes more useful when the function or functions passed in have parameters of their own. For example, the function <code>pipeline</code> passes a value to one function, then takes that function’s result and passes it to a second, and returns the final result:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pipeline <span class="op">=</span> (initial<span class="op">,</span> first<span class="op">,</span> second) <span class="kw">=&gt;</span> {</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">second</span>(<span class="fu">first</span>(initial))</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Let’s use this to combine a function that trims blanks off the starts and ends of strings and another function that uses a <a href="#g:regular-expression"><strong>regular expression</strong></a> (Appendix <a href="#s:regexp" data-reference-type="ref" data-reference="s:regexp">24</a>) to replace spaces with dots:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> trim <span class="op">=</span> (text) <span class="kw">=&gt;</span> { <span class="cf">return</span> text<span class="op">.</span><span class="fu">trim</span>() }</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> dot <span class="op">=</span> (text) <span class="kw">=&gt;</span> { <span class="cf">return</span> text<span class="op">.</span><span class="fu">replace</span>(<span class="ss">/ /g</span><span class="op">,</span> <span class="st">&#39;.&#39;</span>) }</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> original <span class="op">=</span> <span class="st">&#39;  this example uses text  &#39;</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> trimThenDot <span class="op">=</span> <span class="fu">pipeline</span>(original<span class="op">,</span> trim<span class="op">,</span> dot)</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`trim then dot: |</span><span class="sc">${</span>trimThenDot<span class="sc">}</span><span class="vs">|`</span>)</span></code></pre></div>
<pre class="text"><code>trim then dot: |this.example.uses.text|</code></pre>
<p>During the call to <code>temp = first(initial)</code>, but before a value has been returned to be assigned to <code>temp</code>, memory looks like Figure <a href="#f:callbacks-pipeline" data-reference-type="ref" data-reference="f:callbacks-pipeline">3.6</a>.</p>
<figure>
<img src="figures/callbacks-pipeline.svg" id="f:callbacks-pipeline" /><figcaption aria-hidden="true"><span>Implementing a Pipeline</span><span id="f:callbacks-pipeline" label="f:callbacks-pipeline">[f:callbacks-pipeline]</span></figcaption>
</figure>
<p>Reversing the order of the functions changes the result:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> dotThenTrim <span class="op">=</span> <span class="fu">pipeline</span>(original<span class="op">,</span> dot<span class="op">,</span> trim)</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`dot then trim: |</span><span class="sc">${</span>dotThenTrim<span class="sc">}</span><span class="vs">|`</span>)</span></code></pre></div>
<pre class="text"><code>dot then trim: |..this.example.uses.text..|</code></pre>
<p>We can make a more general pipeline by passing an array of functions:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pipeline <span class="op">=</span> (initial<span class="op">,</span> operations) <span class="kw">=&gt;</span> {</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> current <span class="op">=</span> initial</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> op <span class="kw">of</span> operations) {</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    current <span class="op">=</span> <span class="fu">op</span>(current)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> current</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Going through this line by line:</p>
<ul>
<li><p>The function <code>pipeline</code> takes an initial input value and array of functions. Each of those functions must take one value as an input and produce one value as output.</p></li>
<li><p>We initialize a variable called <code>current</code> to hold the current value. We have to use <code>let</code> for this rather than <code>const</code> because we want to update it after each step of the pipeline runs.</p></li>
<li><p>We then call each of the functions in the pipeline in turn, passing in the current value and storing the result to be passed into the next function.</p></li>
<li><p>The final result is whatever came out of the last step in the pipeline.</p></li>
</ul>
<p>We don’t actually have to create a separate variable for the current value; since parameters are always variables rather than constants, we could just overwrite the parameter <code>initial</code> over and over again like this:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pipeline <span class="op">=</span> (current<span class="op">,</span> operations) <span class="kw">=&gt;</span> {</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> op <span class="kw">of</span> operations) {</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>    current <span class="op">=</span> <span class="fu">op</span>(current)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> current</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Let’s add a function <code>double</code> to our suite of text manglers:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> double <span class="op">=</span> (text) <span class="kw">=&gt;</span> { <span class="cf">return</span> text <span class="op">+</span> text }</span></code></pre></div>
<p>and then try it out:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> original <span class="op">=</span> <span class="st">&#39; some text &#39;</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> final <span class="op">=</span> <span class="fu">pipeline</span>(original<span class="op">,</span> [double<span class="op">,</span> trim<span class="op">,</span> dot])</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`|</span><span class="sc">${</span>original<span class="sc">}</span><span class="vs">| -&gt; |</span><span class="sc">${</span>final<span class="sc">}</span><span class="vs">|`</span>)</span></code></pre></div>
<pre class="text"><code>| some text | -&gt; |some.text..some.text|</code></pre>
<p>The order of operations is:</p>
<ol>
<li><p><code>current</code> is assigned <code>’ some text ’</code> (with spaces around each word).</p></li>
<li><p>It is then assigned <code>double(’ some text ’)</code>, or <code>’ some text  some text ’</code>.</p></li>
<li><p>That value is then passed to <code>trim</code>, so <code>’some text  some text’</code> (without leading or trailing spaces) is assigned to <code>current</code>.</p></li>
<li><p>Finally, the current value is passed to <code>dot</code> and the result <code>some.text..some.text.</code> is returned.</p></li>
</ol>
<h2 id="s:callbacks-anonymous">Anonymous Functions</h2>
<p>Remember the function <code>oneMore</code>? We can pass it a value that we have calculated on the fly:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>oneMore <span class="op">=</span> (x) <span class="kw">=&gt;</span> {</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> x <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="fu">oneMore</span>(<span class="dv">3</span> <span class="op">*</span> <span class="dv">2</span>))</span></code></pre></div>
<pre class="text"><code>7</code></pre>
<p>Behind the scenes, JavaScript allocates a nameless temporary variable to hold the value of <code>3 * 2</code>, then passes a reference to that temporary variable into <code>oneMore</code>. We can do the same thing with functions, i.e., create one on the fly without giving it a name as we’re passing it into some other function. For example, suppose that instead of pushing one value through a pipeline of functions, we want to call a function once for each value in an array:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> transform <span class="op">=</span> (values<span class="op">,</span> operation) <span class="kw">=&gt;</span> {</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> result <span class="op">=</span> []</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> v <span class="kw">of</span> values) {</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span><span class="fu">push</span>(<span class="fu">operation</span>(v))</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> data <span class="op">=</span> [<span class="st">&#39;one&#39;</span><span class="op">,</span> <span class="st">&#39;two&#39;</span><span class="op">,</span> <span class="st">&#39;three&#39;</span>]</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> upper <span class="op">=</span> <span class="fu">transform</span>(data<span class="op">,</span> (x) <span class="kw">=&gt;</span> { <span class="cf">return</span> x<span class="op">.</span><span class="fu">toUpperCase</span>() })</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`upper: </span><span class="sc">${</span>upper<span class="sc">}</span><span class="vs">`</span>)</span></code></pre></div>
<pre class="text"><code>upper: ONE,TWO,THREE</code></pre>
<p>Taking the first letter of a word is so simple that it’s hardly worth giving the function a name, so let’s move the definition into the call to <code>transform</code>:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> first <span class="op">=</span> <span class="fu">transform</span>(data<span class="op">,</span> (x) <span class="kw">=&gt;</span> { <span class="cf">return</span> x[<span class="dv">0</span>] })</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`first: </span><span class="sc">${</span>first<span class="sc">}</span><span class="vs">`</span>)</span></code></pre></div>
<pre class="text"><code>first: o,t,t</code></pre>
<p>A function that is defined where it is used and isn’t assigned a name is called an <a href="#g:anonymous-function"><strong>anonymous function</strong></a>. Most callback functions in JavaScript are written this way: the function with the given parameters and body (in this case, <code>x</code> and <code>return x[0]</code>) is passed directly to something else (in this case, <code>transform</code>) to be called.</p>
<h2 id="s:callbacks-functional">Functional Programming</h2>
<p><a href="#g:functional-programming"><strong>Functional programming</strong></a> is a style of programming that relies heavily on <a href="#g:higher-order-function"><strong>higher-order functions</strong></a> like <code>pipeline</code> that take other functions as parameters. In addition, functional programming expects that functions won’t modify data in place, but will instead create new data from old. For example, a true believer in functional programming would be saddened by this:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create test array</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> test <span class="op">=</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">3</span>]</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> impure <span class="op">=</span> (values) <span class="kw">=&gt;</span> {</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> i <span class="kw">in</span> values) {</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    values[i] <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Run function</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a><span class="fu">impure</span>(test)</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Original array has been modified</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`test: </span><span class="sc">${</span>test<span class="sc">}</span><span class="vs">`</span>)</span></code></pre></div>
<pre class="text"><code>test: 2,3,4</code></pre>
<p>and would politely but firmly suggest that it be rewritten like this:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> test <span class="op">=</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">3</span>]</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pure <span class="op">=</span> (values) <span class="kw">=&gt;</span> {</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>  result <span class="op">=</span> []</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> v <span class="kw">of</span> values) {</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span><span class="fu">push</span>(v <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Rather than modify test, we create a new array for the results</span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> newArray <span class="op">=</span> <span class="fu">pure</span>(test)</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`newArray: </span><span class="sc">${</span>newArray<span class="sc">}</span><span class="vs">$`</span>)</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`test: </span><span class="sc">${</span>test<span class="sc">}</span><span class="vs">`</span>)</span></code></pre></div>
<pre class="text"><code>newArray: 2,3,4
test: 1,2,3</code></pre>
<p>JavaScript arrays provide several methods to support functional programming. For example, <code>Array.some</code> returns <code>true</code> if <em>any</em> element in an array passes a test, while <code>Array.every</code> returns <code>true</code> if <em>all</em> elements in an array pass a test. Here’s how they work:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> data <span class="op">=</span> [<span class="st">&#39;this&#39;</span><span class="op">,</span> <span class="st">&#39;is&#39;</span><span class="op">,</span> <span class="st">&#39;a&#39;</span><span class="op">,</span> <span class="st">&#39;test&#39;</span>]</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;some longer than 3:&#39;</span><span class="op">,</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>            data<span class="op">.</span><span class="fu">some</span>((x) <span class="kw">=&gt;</span> { <span class="cf">return</span> x<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">3</span> }))</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;all longer than 3:&#39;</span><span class="op">,</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>            data<span class="op">.</span><span class="fu">every</span>((x) <span class="kw">=&gt;</span> { <span class="cf">return</span> x<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">3</span> }))</span></code></pre></div>
<pre class="text"><code>some longer than 3: true
all longer than 3: false</code></pre>
<p><code>Array.filter</code> creates a new array containing only values that pass a test:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> data <span class="op">=</span> [<span class="st">&#39;this&#39;</span><span class="op">,</span> <span class="st">&#39;is&#39;</span><span class="op">,</span> <span class="st">&#39;a&#39;</span><span class="op">,</span> <span class="st">&#39;test&#39;</span>]</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;those longer than 3:&#39;</span><span class="op">,</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>            data<span class="op">.</span><span class="fu">filter</span>((x) <span class="kw">=&gt;</span> { <span class="cf">return</span> x<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">3</span> }))</span></code></pre></div>
<pre class="text"><code>those longer than 3: [ &#39;this&#39;, &#39;test&#39; ]</code></pre>
<p>So do all of the elements with more than 3 characters start with a ‘t’?</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> data <span class="op">=</span> [<span class="st">&#39;this&#39;</span><span class="op">,</span> <span class="st">&#39;is&#39;</span><span class="op">,</span> <span class="st">&#39;a&#39;</span><span class="op">,</span> <span class="st">&#39;test&#39;</span>]</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> result <span class="op">=</span> data</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>               <span class="op">.</span><span class="fu">filter</span>((x) <span class="kw">=&gt;</span> { <span class="cf">return</span> x<span class="op">.</span><span class="at">length</span> <span class="op">&gt;</span> <span class="dv">3</span> })</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>               <span class="op">.</span><span class="fu">every</span>((x) <span class="kw">=&gt;</span> { <span class="cf">return</span> x[<span class="dv">0</span>] <span class="op">===</span> <span class="st">&#39;t&#39;</span> })</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`all longer than 3 start with t: </span><span class="sc">${</span>result<span class="sc">}</span><span class="vs">`</span>)</span></code></pre></div>
<pre class="text"><code>all longer than 3 start with t: true</code></pre>
<p><code>Array.map</code> creates a new array by calling a function for each element of an existing array:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> data <span class="op">=</span> [<span class="st">&#39;this&#39;</span><span class="op">,</span> <span class="st">&#39;is&#39;</span><span class="op">,</span> <span class="st">&#39;a&#39;</span><span class="op">,</span> <span class="st">&#39;test&#39;</span>]</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;shortened&#39;</span><span class="op">,</span> data<span class="op">.</span><span class="fu">map</span>((x) <span class="kw">=&gt;</span> { <span class="cf">return</span> x<span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">2</span>) }))</span></code></pre></div>
<pre class="text"><code>shortened [ &#39;th&#39;, &#39;is&#39;, &#39;a&#39;, &#39;te&#39; ]</code></pre>
<p>Finally, <code>Array.reduce</code> reduces an array to a single value using a combining function and a starting value. The combining function must take two values, which are the current running total and the next value from the array; if the array is empty, <code>Array.reduce</code> returns the starting value.</p>
<p>An example will make this clearer. To start, let’s create an acronym using a loop:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> data <span class="op">=</span> [<span class="st">&#39;this&#39;</span><span class="op">,</span> <span class="st">&#39;is&#39;</span><span class="op">,</span> <span class="st">&#39;a&#39;</span><span class="op">,</span> <span class="st">&#39;test&#39;</span>]</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> acronym <span class="op">=</span> <span class="st">&#39;&#39;</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> value <span class="kw">of</span> data) {</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>  acronym <span class="op">=</span> acronym <span class="op">+</span> value[<span class="dv">0</span>]</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`acronym of </span><span class="sc">${</span>data<span class="sc">}</span><span class="vs"> is </span><span class="sc">${</span>acronym<span class="sc">}</span><span class="vs">`</span>)</span></code></pre></div>
<pre class="text"><code>acronym of this,is,a,test is tiat</code></pre>
<p>The three key elements in the short program above are the input data, the initial value of the variable <code>acronym</code>, and the way that variable is updated. When <code>Array.reduce</code> is used, the array is the data and the initial value and update function are passed as parameters:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> data <span class="op">=</span> [<span class="st">&#39;this&#39;</span><span class="op">,</span> <span class="st">&#39;is&#39;</span><span class="op">,</span> <span class="st">&#39;a&#39;</span><span class="op">,</span> <span class="st">&#39;test&#39;</span>]</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> concatFirst <span class="op">=</span> (accumulator<span class="op">,</span> nextValue) <span class="kw">=&gt;</span> {</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> accumulator <span class="op">+</span> nextValue[<span class="dv">0</span>]</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> acronym <span class="op">=</span> data<span class="op">.</span><span class="fu">reduce</span>(concatFirst<span class="op">,</span> <span class="st">&#39;&#39;</span>)</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`acronym of </span><span class="sc">${</span>data<span class="sc">}</span><span class="vs"> is </span><span class="sc">${</span>acronym<span class="sc">}</span><span class="vs">`</span>)</span></code></pre></div>
<pre class="text"><code>acronym of this,is,a,test is tiat</code></pre>
<p>As elsewhere, we can define the function where we use it:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> data <span class="op">=</span> [<span class="st">&#39;this&#39;</span><span class="op">,</span> <span class="st">&#39;is&#39;</span><span class="op">,</span> <span class="st">&#39;a&#39;</span><span class="op">,</span> <span class="st">&#39;test&#39;</span>]</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>acronym <span class="op">=</span> data<span class="op">.</span><span class="fu">reduce</span>((accum<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> accum <span class="op">+</span> next[<span class="dv">0</span>]</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> <span class="st">&#39;&#39;</span>)</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;all in one step:&#39;</span><span class="op">,</span> acronym)</span></code></pre></div>
<pre class="text"><code>all in one step: tiat</code></pre>
<p>The indentation of the anonymous function defined inside <code>reduce</code> may look a little odd, but this is the style the JavaScript community has settled on.</p>
<h2 id="s:callbacks-closures">Closures</h2>
<p>The last tool we need to introduce is an extremely useful side-effect of the way memory is handled. The easiest way to explain it is by example. We have already defined a function called <code>pipeline</code> that chains any number of other functions together:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pipeline <span class="op">=</span> (initial<span class="op">,</span> operations) <span class="kw">=&gt;</span> {</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> current <span class="op">=</span> initial</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> op <span class="kw">of</span> operations) {</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>    current <span class="op">=</span> <span class="fu">op</span>(current)</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> current</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>However, <code>pipeline</code> only works if each function in the array <code>operations</code> has a single parameter. If we want to be able to add 1, add 2, and so on, we have to write separate functions, which is annoying.</p>
<p>A better option is to write a function that creates the function we want:</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> adder <span class="op">=</span> (increment) <span class="kw">=&gt;</span> {</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> f <span class="op">=</span> (value) <span class="kw">=&gt;</span> {</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> value <span class="op">+</span> increment</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> f</span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> add_1 <span class="op">=</span> <span class="fu">adder</span>(<span class="dv">1</span>)</span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> add_2 <span class="op">=</span> <span class="fu">adder</span>(<span class="dv">2</span>)</span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`add_1(100) is </span><span class="sc">${</span><span class="fu">add_1</span>(<span class="dv">100</span>)<span class="sc">}</span><span class="vs">, add_2(100) is </span><span class="sc">${</span><span class="fu">add_2</span>(<span class="dv">100</span>)<span class="sc">}</span><span class="vs">`</span>)</span></code></pre></div>
<pre class="text"><code>add_1(100) is 101, add_2(100) is 102</code></pre>
<p>The best way to understand what’s going on is to draw a step-by-step memory diagram. In step 1, we call <code>adder(1)</code> (Figure <a href="#f:callbacks-adder-1" data-reference-type="ref" data-reference="f:callbacks-adder-1">3.7</a>). <code>adder</code> creates a new function that includes a reference to that 1 we just passed in (Figure <a href="#f:callbacks-adder-2" data-reference-type="ref" data-reference="f:callbacks-adder-2">3.8</a>). In step 3, <code>adder</code> returns that function, which is assigned to <code>add_1</code> (Figure <a href="#f:callbacks-adder-3" data-reference-type="ref" data-reference="f:callbacks-adder-3">3.9</a>). Crucially, the function that <code>add_1</code> refers to still has a reference to the value 1, even though that value isn’t referred to any longer by anyone else.</p>
<figure>
<img src="figures/callbacks-adder-1.svg" id="f:callbacks-adder-1" /><figcaption aria-hidden="true"><span>Creating an Adder (Step 1)</span><span id="f:callbacks-adder-1" label="f:callbacks-adder-1">[f:callbacks-adder-1]</span></figcaption>
</figure>
<figure>
<img src="figures/callbacks-adder-2.svg" id="f:callbacks-adder-2" /><figcaption aria-hidden="true"><span>Creating an Adder (Step 2)</span><span id="f:callbacks-adder-2" label="f:callbacks-adder-2">[f:callbacks-adder-2]</span></figcaption>
</figure>
<figure>
<img src="figures/callbacks-adder-3.svg" id="f:callbacks-adder-3" /><figcaption aria-hidden="true"><span>Creating an Adder (Step 3)</span><span id="f:callbacks-adder-3" label="f:callbacks-adder-3">[f:callbacks-adder-3]</span></figcaption>
</figure>
<p>In steps 4–6, we repeat these three steps to create another function that has a reference to the value 2, and assign that function to <code>add_2</code> (Figure <a href="#f:callbacks-adder-4" data-reference-type="ref" data-reference="f:callbacks-adder-4">3.10</a>).</p>
<figure>
<img src="figures/callbacks-adder-4.svg" id="f:callbacks-adder-4" /><figcaption aria-hidden="true"><span>Creating an Adder (Steps 4-6)</span><span id="f:callbacks-adder-4" label="f:callbacks-adder-4">[f:callbacks-adder-4]</span></figcaption>
</figure>
<p>When we now call <code>add_1</code> or <code>add_2</code>, they add the value passed in and the value they’ve kept a reference to.</p>
<p>This trick of capturing a reference to a value inside something else is called a <a href="#g:closure"><strong>closure</strong></a>. It works because JavaScript holds on to values as long as anything, anywhere, still refers to them. Closures solve our pipeline problem by letting us define little functions on the fly and give them extra data to work with:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> result <span class="op">=</span> <span class="fu">pipeline</span>(<span class="dv">100</span><span class="op">,</span> [<span class="fu">adder</span>(<span class="dv">1</span>)<span class="op">,</span> <span class="fu">adder</span>(<span class="dv">2</span>)])</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`adding 1 and 2 to 100 -&gt; </span><span class="sc">${</span>result<span class="sc">}</span><span class="vs">`</span>)</span></code></pre></div>
<pre class="text"><code>adding 1 and 2 to 100 -&gt; 103</code></pre>
<p>Again, <code>adder(1)</code> and <code>adder(2)</code> do not add anything to anything: they define new (unnamed) functions that add 1 and 2 respectively when called.</p>
<p>Programmers often go one step further and define little functions like this inline:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> result <span class="op">=</span> <span class="fu">pipeline</span>(<span class="dv">100</span><span class="op">,</span> [(x) <span class="kw">=&gt;</span> x <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> (x) <span class="kw">=&gt;</span> x <span class="op">+</span> <span class="dv">2</span>])</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`adding 1 and 2 to 100 -&gt; </span><span class="sc">${</span>result<span class="sc">}</span><span class="vs">`</span>)</span></code></pre></div>
<pre class="text"><code>adding 1 and 2 to 100 -&gt; 103</code></pre>
<p>As this example shows, if the body of a function is a single expression, it doesn’t have to be enclosed in <code>{...}</code> and <code>return</code> doesn’t need to be used.</p>
<h2 id="s:callbacks-exercises">Exercises</h2>
<h3 class="unnumbered" id="side-effects-with-foreach">Side Effects With <code>forEach</code></h3>
<p>JavaScript arrays have a method called <code>forEach</code>, which calls a callback function once for each element of the array. Unlike <code>map</code>, <code>forEach</code> does <em>not</em> save the values returned by these calls or return an array of results. The full syntax is:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>someArray<span class="op">.</span><span class="fu">forEach</span>((value<span class="op">,</span> location<span class="op">,</span> container) <span class="kw">=&gt;</span> {</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// &#39;value&#39; is the value in &#39;someArray&#39;</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// &#39;location&#39; is the index of that value</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// &#39;container&#39; is the containing array (in this case, &#39;someArray&#39;)</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>If you only need the value, you can provide a callback that only takes one parameter; if you only need the value and its location, you can provide a callback that takes two. Use this to write a function <code>doubleInPlace</code> that doubles all the values in an array in place:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> vals <span class="op">=</span> [<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>]</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="fu">doubleInPlace</span>(vals)</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`vals after change: </span><span class="sc">${</span>vals<span class="sc">}</span><span class="vs">`</span>)</span></code></pre></div>
<pre class="text"><code>vals after change: 2,4,6</code></pre>
<h3 class="unnumbered" id="annotating-data">Annotating Data</h3>
<p>Given an array of objects representing observations of wild animals:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> [</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>  {<span class="st">&#39;date&#39;</span><span class="op">:</span> <span class="st">&#39;1977-7-16&#39;</span><span class="op">,</span> <span class="st">&#39;sex&#39;</span><span class="op">:</span> <span class="st">&#39;M&#39;</span><span class="op">,</span> <span class="st">&#39;species&#39;</span><span class="op">:</span> <span class="st">&#39;NL&#39;</span>}<span class="op">,</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>  {<span class="st">&#39;date&#39;</span><span class="op">:</span> <span class="st">&#39;1977-7-16&#39;</span><span class="op">,</span> <span class="st">&#39;sex&#39;</span><span class="op">:</span> <span class="st">&#39;M&#39;</span><span class="op">,</span> <span class="st">&#39;species&#39;</span><span class="op">:</span> <span class="st">&#39;NL&#39;</span>}<span class="op">,</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>  {<span class="st">&#39;date&#39;</span><span class="op">:</span> <span class="st">&#39;1977-7-16&#39;</span><span class="op">,</span> <span class="st">&#39;sex&#39;</span><span class="op">:</span> <span class="st">&#39;F&#39;</span><span class="op">,</span> <span class="st">&#39;species&#39;</span><span class="op">:</span> <span class="st">&#39;DM&#39;</span>}<span class="op">,</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>  {<span class="st">&#39;date&#39;</span><span class="op">:</span> <span class="st">&#39;1977-7-16&#39;</span><span class="op">,</span> <span class="st">&#39;sex&#39;</span><span class="op">:</span> <span class="st">&#39;M&#39;</span><span class="op">,</span> <span class="st">&#39;species&#39;</span><span class="op">:</span> <span class="st">&#39;DM&#39;</span>}<span class="op">,</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>  {<span class="st">&#39;date&#39;</span><span class="op">:</span> <span class="st">&#39;1977-7-16&#39;</span><span class="op">,</span> <span class="st">&#39;sex&#39;</span><span class="op">:</span> <span class="st">&#39;M&#39;</span><span class="op">,</span> <span class="st">&#39;species&#39;</span><span class="op">:</span> <span class="st">&#39;DM&#39;</span>}<span class="op">,</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>  {<span class="st">&#39;date&#39;</span><span class="op">:</span> <span class="st">&#39;1977-7-16&#39;</span><span class="op">,</span> <span class="st">&#39;sex&#39;</span><span class="op">:</span> <span class="st">&#39;M&#39;</span><span class="op">,</span> <span class="st">&#39;species&#39;</span><span class="op">:</span> <span class="st">&#39;PF&#39;</span>}<span class="op">,</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>  {<span class="st">&#39;date&#39;</span><span class="op">:</span> <span class="st">&#39;1977-7-16&#39;</span><span class="op">,</span> <span class="st">&#39;sex&#39;</span><span class="op">:</span> <span class="st">&#39;F&#39;</span><span class="op">,</span> <span class="st">&#39;species&#39;</span><span class="op">:</span> <span class="st">&#39;PE&#39;</span>}<span class="op">,</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>  {<span class="st">&#39;date&#39;</span><span class="op">:</span> <span class="st">&#39;1977-7-16&#39;</span><span class="op">,</span> <span class="st">&#39;sex&#39;</span><span class="op">:</span> <span class="st">&#39;M&#39;</span><span class="op">,</span> <span class="st">&#39;species&#39;</span><span class="op">:</span> <span class="st">&#39;DM&#39;</span>}</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
<p>write a function that returns a new array of objects like this:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>newData <span class="op">=</span> [</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>  {<span class="st">&#39;seq&#39;</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="st">&#39;year&#39;</span><span class="op">:</span> <span class="st">&#39;1977&#39;</span><span class="op">,</span> <span class="st">&#39;sex&#39;</span><span class="op">:</span> <span class="st">&#39;F&#39;</span><span class="op">,</span> <span class="st">&#39;species&#39;</span><span class="op">:</span> <span class="st">&#39;DM&#39;</span>}<span class="op">,</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>  {<span class="st">&#39;seq&#39;</span><span class="op">:</span> <span class="dv">7</span><span class="op">,</span> <span class="st">&#39;year&#39;</span><span class="op">:</span> <span class="st">&#39;1977&#39;</span><span class="op">,</span> <span class="st">&#39;sex&#39;</span><span class="op">:</span> <span class="st">&#39;F&#39;</span><span class="op">,</span> <span class="st">&#39;species&#39;</span><span class="op">:</span> <span class="st">&#39;PE&#39;</span>}</span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
<p><em>without</em> using any loops. The changes are:</p>
<ul>
<li><p>The <code>date</code> field is replaced with just the year.</p></li>
<li><p>Only observations of female animals are retained.</p></li>
<li><p>The retained records are given sequence numbers to relate them back to the original data. (These sequence numbers are 1-based rather than 0-based.)</p></li>
</ul>
<p>You will probably want to use <code>Array.reduce</code> to generate the sequence numbers.</p>
<h2 class="unnumbered" id="key-points-2">Key Points</h2>
<ul>
<li><p>JavaScript stores the instructions making up a function in memory like any other object.</p></li>
<li><p>Function objects can be assigned to variables, put in lists, passed as arguments to other functions, etc.</p></li>
<li><p>Functions can be defined in place without ever being given a name.</p></li>
<li><p>A callback function is one that is passed in to another function for it to execute at a particular moment.</p></li>
<li><p>Functional programming uses higher-order functions on immutable data.</p></li>
<li><p><code>Array.some</code> is true if any element in an array passes a test, while <code>Array.every</code> is true if they all do.</p></li>
<li><p><code>Array.filter</code> selects elements of an array that pass a test.</p></li>
<li><p><code>Array.map</code> creates a new array by transforming values in an existing one.</p></li>
<li><p><code>Array.reduce</code> reduces an array to a single value.</p></li>
<li><p>A closure is a set of variables captured during the definition of a function.</p></li>
</ul>
<h1 id="s:oop">Objects and Classes</h1>
<p>Making new code use old code is easy: just load the libraries you want and write calls to the functions you need. Making <em>old</em> code use <em>new</em> code without rewriting it is trickier, but <a href="#g:oop"><strong>object-oriented programming</strong></a> (OOP) can help.</p>
<h2 id="s:oop-manual">Doing It By Hand</h2>
<p>As we saw in Chapter <a href="#s:basics" data-reference-type="ref" data-reference="s:basics">2</a>, an object in JavaScript is a set of key-value pairs. Since functions are just another kind of data, an object’s values can be functions, so data can carry around functions that work on it. For example, we can create an object to represent a square:</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> square <span class="op">=</span> {</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;square&#39;</span><span class="op">,</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">size</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">area</span><span class="op">:</span> (it) <span class="kw">=&gt;</span> { <span class="cf">return</span> it<span class="op">.</span><span class="at">size</span> <span class="op">*</span> it<span class="op">.</span><span class="at">size</span> }<span class="op">,</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">perimeter</span><span class="op">:</span> (it) <span class="kw">=&gt;</span> { <span class="cf">return</span> <span class="dv">4</span> <span class="op">*</span> it<span class="op">.</span><span class="at">size</span> }</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>and then pass the object itself into each of its own functions:</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> a <span class="op">=</span> square<span class="op">.</span><span class="fu">area</span>(square)</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`area of square is </span><span class="sc">${</span>a<span class="sc">}</span><span class="vs">`</span>)</span></code></pre></div>
<pre class="text"><code>area of square is 25</code></pre>
<p>This is clumsy—we’ll often forget to pass the object into its functions—but it allows us to handle many different kinds of things in the same way. For example, we can create another object to represent a circle:</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> circle <span class="op">=</span> {</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;circle&#39;</span><span class="op">,</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">radius</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">area</span><span class="op">:</span> (it) <span class="kw">=&gt;</span> { <span class="cf">return</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span> <span class="op">*</span> it<span class="op">.</span><span class="at">radius</span> <span class="op">*</span> it<span class="op">.</span><span class="at">radius</span> }<span class="op">,</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">perimeter</span><span class="op">:</span> (it) <span class="kw">=&gt;</span> { <span class="cf">return</span> <span class="dv">2</span> <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span> <span class="op">*</span> it<span class="op">.</span><span class="at">radius</span> }</span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>and then put all of these different objects in an array and operate on them in the same way without knowing precisely what kind of object we’re dealing with:</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> show_all <span class="op">=</span> (shapes) <span class="kw">=&gt;</span> {</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> s <span class="kw">of</span> shapes) {</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> a <span class="op">=</span> s<span class="op">.</span><span class="fu">area</span>(s)</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> p <span class="op">=</span> s<span class="op">.</span><span class="fu">perimeter</span>(s)</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`</span><span class="sc">${</span>s<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">: area </span><span class="sc">${</span>a<span class="sc">}</span><span class="vs"> perimeter </span><span class="sc">${</span>p<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a><span class="fu">show_all</span>([square<span class="op">,</span> circle])</span></code></pre></div>
<pre class="text"><code>square: area 25 perimeter 20
circle: area 28.274333882308138 perimeter 18.84955592153876</code></pre>
<p>As long as we only use the value <code>name</code> and the functions <code>area</code> and <code>perimeter</code> we don’t need to know what kind of shape we have. This is called <a href="#g:polymorphism"><strong>polymorphism</strong></a>, and it allows us to add new shapes without changing the code in our loop. In other words, it allows old code (in this case, the function <code>show_all</code>) to use new code (the new object <code>rectangle</code>):</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> rectangle <span class="op">=</span> {</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">name</span><span class="op">:</span> <span class="st">&#39;rectangle&#39;</span><span class="op">,</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">area</span><span class="op">:</span> (it) <span class="kw">=&gt;</span> { <span class="cf">return</span> it<span class="op">.</span><span class="at">width</span> <span class="op">*</span> it<span class="op">.</span><span class="at">height</span> }<span class="op">,</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">perimeter</span><span class="op">:</span> (it) <span class="kw">=&gt;</span> { <span class="cf">return</span> <span class="dv">2</span> <span class="op">*</span> (it<span class="op">.</span><span class="at">width</span> <span class="op">+</span> it<span class="op">.</span><span class="at">height</span>) }</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a><span class="fu">show_all</span>([square<span class="op">,</span> circle<span class="op">,</span> rectangle])</span></code></pre></div>
<pre class="text"><code>square: area 25 perimeter 20
circle: area 28.274333882308138 perimeter 18.84955592153876
rectangle: area 6 perimeter 10</code></pre>
<h2 id="s:oop-classes">Classes</h2>
<p>Building every object by hand and calling <code>thing.function(thing)</code> is clumsy. JavaScript solved these problems using <a href="#g:prototype"><strong>prototypes</strong></a>, which turned out to be almost as clumsy as our hand-rolled solution (Section <a href="#s:legacy-prototypes" data-reference-type="ref" data-reference="s:legacy-prototypes">23.3</a>). Most object-oriented languages use <a href="#g:class"><strong>classes</strong></a> instead (Figure <a href="#f:oop-memory" data-reference-type="ref" data-reference="f:oop-memory">4.1</a>); these were added to JavaScript in ES6, and we will use them instead of prototypes throughout. Here’s how we create a class that defines the properties of a square, without actually creating any specific squares:</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Square {</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span> (size) {</span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">name</span> <span class="op">=</span> <span class="st">&#39;square&#39;</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">size</span> <span class="op">=</span> size</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">area</span> () { <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">size</span> <span class="op">*</span> <span class="kw">this</span><span class="op">.</span><span class="at">size</span> }</span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">perimeter</span> () { <span class="cf">return</span> <span class="dv">4</span> <span class="op">*</span> <span class="kw">this</span><span class="op">.</span><span class="at">size</span> }</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>(Class names are written in CamelCase by convention.) We can then create a specific square by using the class’s name as if it were a function:</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> sq <span class="op">=</span> <span class="kw">new</span> <span class="fu">Square</span>(<span class="dv">3</span>)</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`sq name </span><span class="sc">${</span>sq<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs"> and area </span><span class="sc">${</span>sq<span class="op">.</span><span class="fu">area</span>()<span class="sc">}</span><span class="vs">`</span>)</span></code></pre></div>
<pre class="text"><code>sq name square and area 9</code></pre>
<p><code>new ClassName(...)</code> creates a new blank object and marks it to show that it is an <a href="#g:instance"><strong>instance</strong></a> of <code>ClassName</code>. Objects need to know what class they belong to so that they can find their <a href="#g:method"><strong>methods</strong></a>, which are the functions defined within the class that operate on instances of it. (We’ll explain how JavaScript marks objects in Section <a href="#s:legacy-prototypes" data-reference-type="ref" data-reference="s:legacy-prototypes">23.3</a>; it’s more complicated than it needs to be in order to be compatible with older versions of the language.)</p>
<figure>
<img src="figures/oop-memory.svg" id="f:oop-memory" /><figcaption aria-hidden="true"><span>Objects and Classes in Memory</span><span id="f:oop-memory" label="f:oop-memory">[f:oop-memory]</span></figcaption>
</figure>
<p>Before <code>new</code> hands the newly-created object back to the program, it calls the specially-named <a href="#g:constructor"><strong>constructor</strong></a> to initialize the object’s state. Inside the constructor and other methods, the object being operated on is referred to by the pronoun <code>this</code>. For example, if the constructor assigns an array to <code>this.values</code>, then every instance of that class gets its own array.</p>
<blockquote>
<h4 id="everything-old-is-new-again" class="unnumbered">Everything Old is New Again</h4>
<p>Methods are defined within a class using classic <code>function</code> syntax rather than the fat arrows we have been using. The inconsistency is unfortunate but this way of defining methods is what the current version of Node prefers; we will explore this topic further in Chapter <a href="#s:vis" data-reference-type="ref" data-reference="s:vis">8</a>.</p>
</blockquote>
<p>There are a lot of new terms packed into the preceding three paragraphs, so let’s retrace the execution of:</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> sq <span class="op">=</span> <span class="kw">new</span> <span class="fu">Square</span>(<span class="dv">3</span>)</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`sq name </span><span class="sc">${</span>sq<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs"> and area </span><span class="sc">${</span>sq<span class="op">.</span><span class="fu">area</span>()<span class="sc">}</span><span class="vs">`</span>)</span></code></pre></div>
<ol>
<li><p><code>new</code> creates a blank object, then looks up the definition of the class <code>Square</code> and calls the <code>constructor</code> defined inside it with the value 3.</p></li>
<li><p>Inside that call, <code>this</code> refers to the newly-created blank object. The constructor adds two keys to the object: <code>name</code>, which has the value <code>’square’</code>, and <code>size</code>, which has the value 3.</p></li>
<li><p>Once the constructor finishes, the newly-created object is assigned to the variable <code>sq</code>.</p></li>
<li><p>In order to create a string to pass to <code>console.log</code>, the program has to look up the value of <code>sq.name</code>, which works like looking up any other key in an object.</p></li>
<li><p>The program also has to call <code>sq.area</code>. During that call, JavaScript temporarily assigns <code>sq</code> to the variable <code>this</code> so that the <code>area</code> method can look up the value of <code>size</code> in the object it’s being called for.</p></li>
<li><p>Finally, the program fills in the template string and calls <code>console.log</code>.</p></li>
</ol>
<p>JavaScript classes support polymorphism: if two or more classes have some methods with the same names that take the same parameters and return the same kinds of values, other code can use objects of those classes interchangeably. For example, here’s a class-based rewrite of our shapes code:</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Circle {</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span> (radius) {</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">name</span> <span class="op">=</span> <span class="st">&#39;circle&#39;</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">radius</span> <span class="op">=</span> radius</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">area</span> () { <span class="cf">return</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span> <span class="op">*</span> <span class="kw">this</span><span class="op">.</span><span class="at">radius</span> <span class="op">*</span> <span class="kw">this</span><span class="op">.</span><span class="at">radius</span> }</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">perimeter</span> () { <span class="cf">return</span> <span class="dv">2</span> <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span> <span class="op">*</span> <span class="kw">this</span><span class="op">.</span><span class="at">radius</span> }</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Rectangle {</span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span> (width<span class="op">,</span> height) {</span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">name</span> <span class="op">=</span> <span class="st">&#39;rectangle&#39;</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">width</span> <span class="op">=</span> width</span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">height</span> <span class="op">=</span> height</span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">area</span> () { <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">width</span> <span class="op">*</span> <span class="kw">this</span><span class="op">.</span><span class="at">height</span> }</span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">perimeter</span> () { <span class="cf">return</span> <span class="dv">2</span> <span class="op">*</span> (<span class="kw">this</span><span class="op">.</span><span class="at">width</span> <span class="op">+</span> <span class="kw">this</span><span class="op">.</span><span class="at">height</span>) }</span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> everything <span class="op">=</span> [</span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> <span class="fu">Square</span>(<span class="fl">3.5</span>)<span class="op">,</span></span>
<span id="cb110-22"><a href="#cb110-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> <span class="fu">Circle</span>(<span class="fl">2.5</span>)<span class="op">,</span></span>
<span id="cb110-23"><a href="#cb110-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">new</span> <span class="fu">Rectangle</span>(<span class="fl">1.5</span><span class="op">,</span> <span class="fl">0.5</span>)</span>
<span id="cb110-24"><a href="#cb110-24" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb110-25"><a href="#cb110-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> thing <span class="kw">of</span> everything) {</span>
<span id="cb110-26"><a href="#cb110-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> a <span class="op">=</span> thing<span class="op">.</span><span class="fu">area</span>(thing)</span>
<span id="cb110-27"><a href="#cb110-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> p <span class="op">=</span> thing<span class="op">.</span><span class="fu">perimeter</span>(thing)</span>
<span id="cb110-28"><a href="#cb110-28" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`</span><span class="sc">${</span>thing<span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">: area </span><span class="sc">${</span>a<span class="sc">}</span><span class="vs"> perimeter </span><span class="sc">${</span>p<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb110-29"><a href="#cb110-29" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre class="text"><code>square: area 12.25 perimeter 14
circle: area 19.634954084936208 perimeter 15.707963267948966
rectangle: area 0.75 perimeter 4</code></pre>
<h2 id="s:oop-inheritance">Inheritance</h2>
<p>We can build new classes from old ones by adding or <a href="#g:override-method"><strong>overriding</strong></a> methods. To show this, we’ll start by defining a person:</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Person {</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span> (name) {</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">name</span> <span class="op">=</span> name</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">greeting</span> (formal) {</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (formal) {</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="vs">`Hello, my name is </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">`</span></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="vs">`Hi, I&#39;m </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">name</span><span class="sc">}</span><span class="vs">`</span></span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">farewell</span> () {</span>
<span id="cb112-15"><a href="#cb112-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`Goodbye`</span></span>
<span id="cb112-16"><a href="#cb112-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb112-17"><a href="#cb112-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This class allows us to create an instance with a formal greeting:</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> parent <span class="op">=</span> <span class="kw">new</span> <span class="fu">Person</span>(<span class="st">&#39;Hakim&#39;</span>)</span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`parent: </span><span class="sc">${</span>parent<span class="op">.</span><span class="fu">greeting</span>(<span class="kw">true</span>)<span class="sc">}</span><span class="vs"> - </span><span class="sc">${</span>parent<span class="op">.</span><span class="fu">farewell</span>()<span class="sc">}</span><span class="vs">`</span>)</span></code></pre></div>
<pre class="text"><code>parent: Hello, my name is Hakim - Goodbye</code></pre>
<p>We can now <a href="#g:extend"><strong>extend</strong></a> <code>Person</code> to create a new class <code>Scientist</code>, in which case we say that <code>Scientist</code> <a href="#g:inherit"><strong>inherits</strong></a> from <code>Person</code>, or that <code>Person</code> is a <a href="#g:parent-class"><strong>parent class</strong></a> of <code>Scientist</code> and <code>Scientist</code> is a <a href="#g:child-class"><strong>child class</strong></a> of <code>Person</code>.</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Scientist <span class="kw">extends</span> Person {</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span> (name<span class="op">,</span> area) {</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>(name)</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">area</span> <span class="op">=</span> area</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">greeting</span> (formal) {</span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="vs">`</span><span class="sc">${</span><span class="kw">super</span><span class="op">.</span><span class="fu">greeting</span>(formal)<span class="sc">}</span><span class="vs">. Let&#39;s talk about </span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">area</span><span class="sc">}</span><span class="vs">...`</span></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This tells us that a <code>Scientist</code> is a <code>Person</code> who:</p>
<ul>
<li><p>Has an area of specialization as well as a name.</p></li>
<li><p>Says hello in a slightly longer way</p></li>
<li><p>Says goodbye in the same way as a <code>Person</code> (since <code>Scientist</code> <em>doesn’t</em> define its own <code>farewell</code> method)</p></li>
</ul>
<p>The word <code>super</code> is used in two ways here:</p>
<ul>
<li><p>In the constructor for <code>Scientist</code>, <code>super(...)</code> calls up to the constructor of the parent class <code>Person</code> so that it can do whatever initialization it does before <code>Scientist</code> does its own initialization. This saves us from duplicating steps.</p></li>
<li><p>Inside <code>greeting</code>, the expression <code>super.greeting(formal)</code> means “call the parent class’s <code>greeting</code> method for this object”. This allows methods defined in child classes to add to or modify the behavior of methods defined in parent classes, again without duplicating code.</p></li>
</ul>
<p>Let’s try it out:</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> child <span class="op">=</span> <span class="kw">new</span> <span class="fu">Scientist</span>(<span class="st">&#39;Bhadra&#39;</span><span class="op">,</span> <span class="st">&#39;microbiology&#39;</span>)</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`child: </span><span class="sc">${</span>child<span class="op">.</span><span class="fu">greeting</span>(<span class="kw">false</span>)<span class="sc">}</span><span class="vs"> - </span><span class="sc">${</span>child<span class="op">.</span><span class="fu">farewell</span>()<span class="sc">}</span><span class="vs">`</span>)</span></code></pre></div>
<pre class="text"><code>child: Hi, I&#39;m Bhadra. Let&#39;s talk about microbiology... - Goodbye</code></pre>
<p>Figure <a href="#f:oop-inheritance" data-reference-type="ref" data-reference="f:oop-inheritance">4.2</a> shows what memory looks like after these classes have been defined and the objects <code>parent</code> and <code>child</code> have been created. It looks complex at first, but allows us to see how JavaScript finds the right method when <code>child.farewell()</code> is called:</p>
<ul>
<li><p>It looks in the object <code>child</code> to see if there’s a function there with the right name.</p></li>
<li><p>There isn’t, so it follows <code>child</code>’s link to its class <code>Scientist</code> to see if a function is there.</p></li>
<li><p>There isn’t, so it follows the link from <code>Scientist</code> to the parent class <code>Person</code> and finds the function it’s looking for.</p></li>
</ul>
<figure>
<img src="figures/oop-inheritance.svg" id="f:oop-inheritance" /><figcaption aria-hidden="true"><span>Object-Oriented Inheritance</span><span id="f:oop-inheritance" label="f:oop-inheritance">[f:oop-inheritance]</span></figcaption>
</figure>
<h2 id="s:oop-exercises">Exercises</h2>
<h3 class="unnumbered" id="delays">Delays</h3>
<p>Define a class called <code>Delay</code> whose <code>call</code> method always returns the value given in the <em>previous</em> call:</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> example <span class="op">=</span> <span class="kw">new</span> <span class="fu">Delay</span>(<span class="st">&#39;a&#39;</span>)</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> value <span class="kw">of</span> [<span class="st">&#39;b&#39;</span><span class="op">,</span> <span class="st">&#39;c&#39;</span><span class="op">,</span> <span class="st">&#39;d&#39;</span>]) {</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(value<span class="op">,</span> <span class="st">&#39;-&gt;&#39;</span><span class="op">,</span> example<span class="op">.</span><span class="fu">call</span>(value))</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre class="text"><code>b -&gt; a
c -&gt; b
d -&gt; c</code></pre>
<p>A class like <code>Delay</code> is sometimes called <a href="#g:stateful"><strong>stateful</strong></a>, since it remembers its state from call to call.</p>
<h3 class="unnumbered" id="filtering">Filtering</h3>
<p>Define a class called <code>Filter</code> whose <code>call</code> method returns <code>null</code> if its input matches one of the values given to its constructor, or the input as output otherwise:</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> example <span class="op">=</span> <span class="kw">new</span> <span class="fu">Filter</span>(<span class="st">&#39;a&#39;</span><span class="op">,</span> <span class="st">&#39;e&#39;</span><span class="op">,</span> <span class="st">&#39;i&#39;</span><span class="op">,</span> <span class="st">&#39;o&#39;</span><span class="op">,</span> <span class="st">&#39;u&#39;</span>)</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> value <span class="kw">of</span> [<span class="st">&#39;a&#39;</span><span class="op">,</span> <span class="st">&#39;b&#39;</span><span class="op">,</span> <span class="st">&#39;c&#39;</span><span class="op">,</span> <span class="st">&#39;d&#39;</span><span class="op">,</span> <span class="st">&#39;e&#39;</span>]) {</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(value<span class="op">,</span> <span class="st">&#39;-&gt;&#39;</span><span class="op">,</span> example<span class="op">.</span><span class="fu">call</span>(value))</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre class="text"><code>a -&gt; null
b -&gt; b
c -&gt; c
d -&gt; d
e -&gt; null</code></pre>
<p>A class like <code>Filter</code> is sometimes called <a href="#g:stateless"><strong>stateless</strong></a>, since it does not remember its state from call to call.</p>
<h3 class="unnumbered" id="pipelines">Pipelines</h3>
<p>Define a class called <code>Pipeline</code> whose constructor takes one or more objects with a single-parameter <code>call</code> method, and whose own <code>call</code> method passes a value through each of them in turn. If any of the components’ <code>call</code> methods returns <code>null</code>, <code>Pipeline</code> stops immediately and returns <code>null</code>.</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> example <span class="op">=</span> <span class="kw">new</span> <span class="fu">Pipeline</span>(<span class="kw">new</span> <span class="fu">Filter</span>(<span class="st">&#39;a&#39;</span><span class="op">,</span> <span class="st">&#39;e&#39;</span><span class="op">,</span> <span class="st">&#39;i&#39;</span><span class="op">,</span> <span class="st">&#39;o&#39;</span><span class="op">,</span> <span class="st">&#39;u&#39;</span>)<span class="op">,</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>                             <span class="kw">new</span> <span class="fu">Delay</span>(<span class="st">&#39;a&#39;</span>))</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> value <span class="kw">of</span> [<span class="st">&#39;a&#39;</span> <span class="op">,</span><span class="st">&#39;b&#39;</span><span class="op">,</span> <span class="st">&#39;c&#39;</span><span class="op">,</span> <span class="st">&#39;d&#39;</span><span class="op">,</span> <span class="st">&#39;e&#39;</span>]) {</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(value<span class="op">,</span> <span class="st">&#39;-&gt;&#39;</span><span class="op">,</span> example<span class="op">.</span><span class="fu">call</span>(value))</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre class="text"><code>a -&gt; null
b -&gt; a
c -&gt; b
d -&gt; c
e -&gt; null</code></pre>
<h3 class="unnumbered" id="active-expressions">Active Expressions</h3>
<p>Consider this class:</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Active {</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span> (name<span class="op">,</span> transform) {</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">name</span> <span class="op">=</span> name</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">transform</span> <span class="op">=</span> transform</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subscribers</span> <span class="op">=</span> []</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">subscribe</span> (someone) {</span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">subscribers</span><span class="op">.</span><span class="fu">push</span>(someone)</span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update</span> (input) {</span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="kw">this</span><span class="op">.</span><span class="at">name</span><span class="op">,</span> <span class="st">&#39;got&#39;</span><span class="op">,</span> input)</span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> output <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">transform</span>(input)</span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> s <span class="kw">of</span> <span class="kw">this</span><span class="op">.</span><span class="at">subscribers</span>) {</span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a>      s<span class="op">.</span><span class="fu">update</span>(output)</span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>and this program that uses it:</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> start <span class="op">=</span> <span class="kw">new</span> <span class="fu">Active</span>(<span class="st">&#39;start&#39;</span><span class="op">,</span> (x) <span class="kw">=&gt;</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(x<span class="op">,</span> <span class="dv">10</span>))</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> left <span class="op">=</span> <span class="kw">new</span> <span class="fu">Active</span>(<span class="st">&#39;left&#39;</span><span class="op">,</span> (x) <span class="kw">=&gt;</span> <span class="dv">2</span> <span class="op">*</span> x)</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> right <span class="op">=</span> <span class="kw">new</span> <span class="fu">Active</span>(<span class="st">&#39;right&#39;</span><span class="op">,</span> (x) <span class="kw">=&gt;</span> x <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> final <span class="op">=</span> <span class="kw">new</span> <span class="fu">Active</span>(<span class="st">&#39;final&#39;</span><span class="op">,</span> (x) <span class="kw">=&gt;</span> x)</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>start<span class="op">.</span><span class="fu">subscribe</span>(left)</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>start<span class="op">.</span><span class="fu">subscribe</span>(right)</span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>left<span class="op">.</span><span class="fu">subscribe</span>(final)</span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>right<span class="op">.</span><span class="fu">subscribe</span>(final)</span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>start<span class="op">.</span><span class="fu">update</span>(<span class="dv">123</span>)</span></code></pre></div>
<ol>
<li><p>Trace what happens when the last line of the program is called.</p></li>
<li><p>Modify <code>Active</code> so that it calls <code>transform</code> <em>if</em> that function was provided, or a method <code>Active.transform</code> if a transformation function wasn’t provided.</p></li>
<li><p>Create a new class <code>Delay</code> whose <code>transform</code> method always returns the previous value. (Its constructor will need to take an initial value as a parameter.)</p></li>
</ol>
<p>This pattern is called <a href="#g:observer-observable"><strong>observer/observable</strong></a>.</p>
<h2 class="unnumbered" id="key-points-3">Key Points</h2>
<ul>
<li><p>Create classes to define combinations of data and behavior.</p></li>
<li><p>Use the class’s constructor to initialize objects.</p></li>
<li><p><code>this</code> refers to the current object.</p></li>
<li><p>Use polymorphism to express common behavior patterns.</p></li>
<li><p>Extend existing classes to create new ones-sometimes.</p></li>
<li><p>Override methods to change or extend their behavior.</p></li>
</ul>
<h1 id="s:htmlcss">HTML and CSS</h1>
<p>HTML is the standard way to represent documents for presentation in web browsers, and CSS is the standard way to describe how it should look. Both are more complicated than they should have been, but in order to create web applications, we need to understand a little of both.</p>
<h2 id="s:htmlcss-formatting">Formatting</h2>
<p>An HTML <a href="#g:document"><strong>document</strong></a> contains <a href="#g:element"><strong>elements</strong></a> and text (and possibly other things that we will ignore for now). Elements are shown using <a href="#g:tag"><strong>tags</strong></a>: an opening tag <code>&lt;tagname&gt;</code> shows where the element begins, and a corresponding closing tag <code>&lt;/tagname&gt;</code> (with a leading slash) shows where it ends. If there’s nothing between the two, we can write <code>&lt;tagname/&gt;</code> (with a trailing slash).</p>
<p>A document’s elements must form a <a href="#g:tree"><strong>tree</strong></a> (Figure <a href="#f:htmlcss-tree" data-reference-type="ref" data-reference="f:htmlcss-tree">5.1</a>), i.e., they must be strictly nested. This means that if Y starts inside X, Y must end before X ends, so <code>&lt;X&gt;…&lt;Y&gt;…&lt;/Y&gt;&lt;/X&gt;</code> is legal, but <code>&lt;X&gt;…&lt;Y&gt;…&lt;/X&gt;&lt;/Y&gt;</code> is not. Finally, every document should have a single <a href="#g:root-element"><strong>root element</strong></a> that encloses everything else, although browsers aren’t strict about enforcing this. In fact, most browsers are pretty relaxed about enforcing any kind of rules at all, since most people don’t obey them anyway.</p>
<h2 id="s:htmlcss-text">Text</h2>
<p>The text in an HTML page is normal printable text. However, since <code>&lt;</code> and <code>&gt;</code> are used to show where tags start and end, we must use <a href="#g:escape-sequence"><strong>escape sequences</strong></a> to represent them, just as we use <code>\"</code> to represented a literal double-quote character inside a double-quoted string in JavaScript. In HTML, escape sequences are written <code>&amp;name;</code>, i.e., an ampersand, the name of the character, and a semi-colon. A few common escape sequences are shown in Table <a href="#t:htmlcss-escapes" data-reference-type="ref" data-reference="t:htmlcss-escapes">5.1</a>.</p>
<div id="t:htmlcss-escapes">
<table class="table table-striped">
<caption><span>HTML Escapes</span><span id="t:htmlcss-escapes" label="t:htmlcss-escapes">[t:htmlcss-escapes]</span></caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">Escape Sequence</td>
<td style="text-align: left;">Character</td>
</tr>
<tr class="even">
<td style="text-align: left;">Less than</td>
<td style="text-align: left;"><code>&amp;lt;</code></td>
<td style="text-align: left;"><span>&lt;</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Greater than</td>
<td style="text-align: left;"><code>&amp;gt;</code></td>
<td style="text-align: left;"><span>&gt;</span></td>
</tr>
<tr class="even">
<td style="text-align: left;">Ampersand</td>
<td style="text-align: left;"><code>&amp;amp;</code></td>
<td style="text-align: left;">&amp;</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Copyright</td>
<td style="text-align: left;"><code>&amp;copy;</code></td>
<td style="text-align: left;">©</td>
</tr>
<tr class="even">
<td style="text-align: left;">Plus/minus</td>
<td style="text-align: left;"><code>&amp;plusmn;</code></td>
<td style="text-align: left;">±</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Micro</td>
<td style="text-align: left;"><code>&amp;micro;</code></td>
<td style="text-align: left;">µ</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
</div>
<p>The first two are self-explanatory, and <code>&amp;amp;</code> is needed so that we can write a literal ampersand (just as <code>\\</code> is needed in JavaScript strings so that we can write a literal backslash). <code>&amp;copy;</code>, <code>&amp;plusmn;</code>, and <code>&amp;micro;</code> are usually not needed any longer, since most editors will allow us to put non-ASCII characters directly into documents these days, but occasionally we will run into older or stricter systems.</p>
<h2 id="s:htmlcss-pages">Pages</h2>
<p>An HTML page should have:</p>
<ul>
<li><p>a single <code>html</code> element that encloses everything else</p></li>
<li><p>a single <code>head</code> element that contains information about the page</p></li>
<li><p>a single <code>body</code> element that contains the content to be displayed.</p></li>
</ul>
<p>It doesn’t matter whether or how we indent the tags showing these elements and the content they contain, but laying them out on separate lines and indenting to show nesting helps human readers. Well-written pages also use comments, just like code: these start with <code>&lt;!--</code> and end with <code>--&gt;</code>. Unfortunately, comments cannot be nested, i.e., if you comment out a section of a page that already contains a comment, the results are unpredictable.</p>
<p>Here’s an empty HTML page with the structure described above:</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- description of page goes here --&gt;</span></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- content of page goes here --&gt;</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>Nothing shows up if we open this in a browser, so let’s add a little content:</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;title&gt;</span>This text is displayed in the browser bar<span class="kw">&lt;/title&gt;</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;h1&gt;</span>Displayed Content Starts Here<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;p&gt;</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>      This course introduces core features of <span class="kw">&lt;em&gt;</span>JavaScript<span class="kw">&lt;/em&gt;</span></span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>      and shows where and how to use them.</span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/p&gt;</span></span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- The word &quot;JavaScript&quot; is in italics (emphasis) in the preceding paragraph. --&gt;</span></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<figure>
<img src="figures/htmlcss-tree.svg" id="f:htmlcss-tree" /><figcaption aria-hidden="true"><span>HTML as a Tree</span><span id="f:htmlcss-tree" label="f:htmlcss-tree">[f:htmlcss-tree]</span></figcaption>
</figure>
<ul>
<li><p>The <code>title</code> element inside <code>head</code> gives the page a title. This is displayed in the browser bar when the page is open, but is <em>not</em> displayed as part of the page itself.</p></li>
<li><p>The <code>h1</code> element is a level-1 heading; we can use <code>h2</code>, <code>h3</code>, and so on to create sub-headings.</p></li>
<li><p>The <code>p</code> element is a paragraph.</p></li>
<li><p>Inside a heading or a paragraph, we can use <code>em</code> to <em>emphasize</em> text. We can also use <code>strong</code> to make text <strong>stronger</strong>. Tags like these are better than tags like <code>i</code> (for italics) or <code>b</code> (for bold) because they signal intention rather than forcing a particular layout. Someone who is visually impaired, or someone using a small-screen device, may want emphasis of various kinds displayed in different ways.</p></li>
</ul>
<h2 id="s:htmlcss-attributes">Attributes</h2>
<p>Elements can be customized by giving them <a href="#g:attribute"><strong>attributes</strong></a>, which are written as <code>name="value"</code> pairs inside the element’s opening tag. For example:</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;h1</span> <span class="er">align</span><span class="ot">=</span><span class="st">&quot;center&quot;</span><span class="kw">&gt;</span>A Centered Heading<span class="kw">&lt;/h1&gt;</span></span></code></pre></div>
<p>centers the <code>h1</code> heading on the page, while:</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;p</span> <span class="er">class</span><span class="ot">=</span><span class="st">&quot;disclaimer&quot;</span><span class="kw">&gt;</span>This planet provided as-is.<span class="kw">&lt;/p&gt;</span></span></code></pre></div>
<p>marks this paragraph as a disclaimer. That doesn’t mean anything special to HTML, but as we’ll see later, we can define styles based on the <code>class</code> attributes of elements.</p>
<p>An attribute’s name may appear at most once in any element, just like a key can only appear once in any JavaScript object, so <code>&lt;p align="left" align="right"&gt;…&lt;/p&gt;</code> is illegal. If we want to give an attribute multiple values—for example, if we want an element to have several classes—we put all the values in one string. Unfortunately, as the example below shows, HTML is inconsistent about whether values should be separated by spaces or semi-colons:</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;p</span> <span class="er">class</span><span class="ot">=</span><span class="st">&quot;disclaimer optional&quot;</span> <span class="er">style</span><span class="ot">=</span><span class="st">&quot;color: blue; font-size: 200%;&quot;</span><span class="kw">&gt;</span></span></code></pre></div>
<p>However they are separated, values are supposed to be quoted, but in practice we can often get away with <code>name=value</code>. And for Boolean attributes whose values are just true or false, we can even sometimes just get away with <code>name</code> on its own.</p>
<h2 id="s:htmlcss-lists">Lists</h2>
<p>Headings and paragraphs are all very well, but data scientists need more. To create an unordered (bulleted) list, we use a <code>ul</code> element, and wrap each item inside the list in <code>li</code>. To create an ordered (numbered) list, we use <code>ol</code> instead of <code>ul</code>, but still use <code>li</code> for the list items.</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;ul&gt;</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;li&gt;</span>first<span class="kw">&lt;/li&gt;</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;li&gt;</span>second<span class="kw">&lt;/li&gt;</span></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;li&gt;</span>third<span class="kw">&lt;/li&gt;</span></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/ul&gt;</span></span></code></pre></div>
<ul>
<li><p>first</p></li>
<li><p>second</p></li>
<li><p>third</p></li>
</ul>
<div class="sourceCode" id="cb132"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;ol&gt;</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;li&gt;</span>first<span class="kw">&lt;/li&gt;</span></span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;li&gt;</span>second<span class="kw">&lt;/li&gt;</span></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;li&gt;</span>third<span class="kw">&lt;/li&gt;</span></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/ol&gt;</span></span></code></pre></div>
<ol>
<li><p>first</p></li>
<li><p>second</p></li>
<li><p>third</p></li>
</ol>
<p>Lists can be nested by putting the inner list’s <code>ul</code> or <code>ol</code> inside one of the outer list’s <code>li</code> elements:</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;ol&gt;</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;li&gt;</span>Major A</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;ol&gt;</span></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;li&gt;</span>minor p<span class="kw">&lt;/li&gt;</span></span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;li&gt;</span>minor q<span class="kw">&lt;/li&gt;</span></span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/ol&gt;</span></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/li&gt;</span></span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;li&gt;</span>Major B</span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;ol&gt;</span></span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;li&gt;</span>minor r<span class="kw">&lt;/li&gt;</span></span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;li&gt;</span>minor s<span class="kw">&lt;/li&gt;</span></span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/ol&gt;</span></span>
<span id="cb133-13"><a href="#cb133-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/li&gt;</span></span>
<span id="cb133-14"><a href="#cb133-14" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/ol&gt;</span></span></code></pre></div>
<ol>
<li><p>Major A</p>
<ol>
<li><p>minor p</p></li>
<li><p>minor q</p></li>
</ol></li>
<li><p>Major B</p>
<ol>
<li><p>minor r</p></li>
<li><p>minor s</p></li>
</ol></li>
</ol>
<h2 id="s:htmlcss-tables">Tables</h2>
<p>Lists are a great way to get started, but if we <em>really</em> want to impress people with our data science skills, we need tables. Unsurprisingly, we use the <code>table</code> element to create these. Each row is a <code>tr</code> (for “table row”), and within rows, column items are shown with <code>td</code> (for “table data”) or <code>th</code> (for “table heading”).</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;table&gt;</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;tr&gt;</span> <span class="kw">&lt;th&gt;</span>Alkali<span class="kw">&lt;/th&gt;</span>   <span class="kw">&lt;th&gt;</span>Noble Gas<span class="kw">&lt;/th&gt;</span> <span class="kw">&lt;/tr&gt;</span></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;tr&gt;</span> <span class="kw">&lt;td&gt;</span>Hydrogen<span class="kw">&lt;/td&gt;</span> <span class="kw">&lt;td&gt;</span>Helium<span class="kw">&lt;/td&gt;</span>    <span class="kw">&lt;/tr&gt;</span></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;tr&gt;</span> <span class="kw">&lt;td&gt;</span>Lithium<span class="kw">&lt;/td&gt;</span>  <span class="kw">&lt;td&gt;</span>Neon<span class="kw">&lt;/td&gt;</span>      <span class="kw">&lt;/tr&gt;</span></span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;tr&gt;</span> <span class="kw">&lt;td&gt;</span>Sodium<span class="kw">&lt;/td&gt;</span>   <span class="kw">&lt;td&gt;</span>Argon<span class="kw">&lt;/td&gt;</span>     <span class="kw">&lt;/tr&gt;</span></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/table&gt;</span></span></code></pre></div>
<table class="table table-striped">
<tbody>
<tr class="odd">
<td style="text-align: left;">Alkali</td>
<td style="text-align: left;">Noble Gas</td>
</tr>
<tr class="even">
<td style="text-align: left;">Hydrogen</td>
<td style="text-align: left;">Helium</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Lithium</td>
<td style="text-align: left;">Neon</td>
</tr>
<tr class="even">
<td style="text-align: left;">Sodium</td>
<td style="text-align: left;">Argon</td>
</tr>
</tbody>
</table>
<p>Do <em>not</em> use tables to create multi-column layouts: there’s a better way.</p>
<h2 id="s:htmlcss-links">Links</h2>
<p>Links to other pages are what make HTML hypertext (Figure <a href="#f:htmlcss-links" data-reference-type="ref" data-reference="f:htmlcss-links">5.2</a>). Confusingly, the element used to show a link is called <code>a</code>. The text inside the element is displayed and (usually) highlighted for clicking. Its <code>href</code> attribute specifies what the link is pointing at; both local filenames and URLs are supported. Oh, and we can use <code>&lt;br/&gt;</code> to force a line break in text (with a trailing slash inside the tag, since the <code>br</code> element doesn’t contain any content):</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">&quot;https://nodejs.org/&quot;</span><span class="kw">&gt;</span>Node.js<span class="kw">&lt;/a&gt;</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;br/&gt;</span></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">&quot;https://facebook.github.io/react/&quot;</span><span class="kw">&gt;</span>React<span class="kw">&lt;/a&gt;</span></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;br/&gt;</span></span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">&quot;../index.html&quot;</span><span class="kw">&gt;</span>home page (relative path)<span class="kw">&lt;/a&gt;</span></span></code></pre></div>
<p>This appears as:</p>
<pre class="text"><code>Node.js
React
home page (relative path)</code></pre>
<p>with the usual clickability.</p>
<figure>
<img src="figures/htmlcss-links.svg" id="f:htmlcss-links" /><figcaption aria-hidden="true"><span>Pages and Links</span><span id="f:htmlcss-links" label="f:htmlcss-links">[f:htmlcss-links]</span></figcaption>
</figure>
<h2 id="s:htmlcss-images">Images</h2>
<p>Images can be stored inside HTML pages in two ways: by using SVG (which we will discuss in Chapter <a href="#s:vis" data-reference-type="ref" data-reference="s:vis">8</a>) or by encoding the image as text and including that text in the body of the page, which is clever, but makes the source of the pages very hard to read.</p>
<p>It is far more common to store each image in a separate file and refer to that file using an <code>img</code> element (which also allows us to use the image in many places without copying it). The <code>src</code> attribute of the <code>img</code> tag specifies where to find the file; as with the <code>href</code> attribute of an <code>a</code> element, this can be either a URL or a local path. Every <code>img</code> should also include a <code>title</code> attribute (whose purpose is self-explanatory) and an <code>alt</code> attribute with some descriptive text to aid accessibility and search engines. (Again, we have wrapped and broken lines so that they will display nicely in the printed version.)</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;img</span> <span class="er">src</span><span class="ot">=</span><span class="st">&quot;./assets/logo.png&quot;</span> <span class="er">title</span><span class="ot">=</span><span class="st">&quot;Book Logo&quot;</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="ot">         alt=</span><span class="st">&quot;Displays the book logo using a local path&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;img</span> <span class="er">src</span><span class="ot">=</span><span class="st">&quot;https://js4ds.org/assets/logo.png&quot;</span></span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a><span class="ot">         title=</span><span class="st">&quot;Book Logo&quot;</span></span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a><span class="ot">         alt=</span><span class="st">&quot;Display the book logo using a URL&quot;</span> <span class="kw">/&gt;</span></span></code></pre></div>
<p>Two things to note here are:</p>
<ol>
<li><p>Since <code>img</code> elements don’t contain any text, they are often written with the trailing-slash notation. However, they are also often written improperly as <code>&lt;img src="..."&gt;</code> without any slashes at all. Browsers will understand this, but some software packages will complain.</p></li>
<li><p>If an image file is referred to using a path rather than a URL, that path can be either <a href="#g:relative-path"><strong>relative</strong></a> or <a href="#g:absolute-path"><strong>absolute</strong></a>. If it’s a relative path, it’s interpreted starting from where the web page is located; if it’s an absolute path, it’s interpreted relative to wherever the web browser thinks the <a href="#g:root-directory"><strong>root directory</strong></a> of the filesystem is. As we will see in Chapter <a href="#s:server" data-reference-type="ref" data-reference="s:server">12</a>, this can change from one installation to the next, so you should always try to use relative paths, except where you can’t. It’s all very confusing<span>…</span></p></li>
</ol>
<h2 id="s:htmlcss-css">Cascading Style Sheets</h2>
<p>When HTML first appeared, people styled elements by setting their attributes:</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;h1</span> <span class="er">align</span><span class="ot">=</span><span class="st">&quot;center&quot;</span><span class="kw">&gt;</span>Heading is Centered<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;p&gt;</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;b&gt;</span>Text<span class="kw">&lt;/b&gt;</span> can be highlighted</span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>      or <span class="kw">&lt;font</span> <span class="er">color</span><span class="ot">=</span><span class="st">&quot;coral&quot;</span><span class="kw">&gt;</span>colorized<span class="kw">&lt;/font&gt;</span>.</span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/p&gt;</span></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>Many still do, but a better way is to use <a href="#g:css"><strong>Cascading Style Sheets</strong></a> (CSS). These allow us to define a style once and use it many times, which makes it much easier to maintain consistency. (We were going to say “<span>…</span>and keep pages readable”, but given how complex CSS can be, that’s not a claim we feel we can make.) Here’s a page that uses CSS instead of direct styling:</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;link</span> <span class="er">rel</span><span class="ot">=</span><span class="st">&quot;stylesheet&quot;</span> <span class="er">href</span><span class="ot">=</span><span class="st">&quot;simple-style.css&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;h1</span> <span class="er">class</span><span class="ot">=</span><span class="st">&quot;title&quot;</span><span class="kw">&gt;</span>Heading is Centered<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;p&gt;</span></span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;span</span> <span class="er">class</span><span class="ot">=</span><span class="st">&quot;keyword&quot;</span><span class="kw">&gt;</span>Text<span class="kw">&lt;/span&gt;</span> can be highlighted</span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a>      or <span class="kw">&lt;span</span> <span class="er">class</span><span class="ot">=</span><span class="st">&quot;highlight&quot;</span><span class="kw">&gt;</span>colorized<span class="kw">&lt;/span&gt;</span>.</span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/p&gt;</span></span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>The <code>head</code> contains a link to an <a href="#g:external-style-sheet"><strong>external style sheet</strong></a> stored in the same directory as the page itself; we could use a URL here instead of a relative path, but the <code>link</code> element <em>must</em> have the <code>rel="stylesheet"</code> attribute. Inside the page, we then set the <code>class</code> attribute of each element we want to style.</p>
<p>The file <code>simple-style.css</code> looks like this:</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode css"><code class="sourceCode css"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>h1<span class="fu">.title</span> {</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">text-align</span>: <span class="dv">center</span><span class="op">;</span></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>span<span class="fu">.keyword</span> {</span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">font-weight</span>: <span class="dv">bold</span><span class="op">;</span></span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a><span class="fu">.highlight</span> {</span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">color</span>: <span class="cn">coral</span><span class="op">;</span></span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Each entry has the form <code>tag.class</code> followed by a group of properties inside curly braces, and each property is a key-value pair. We can omit the class and just write (for example):</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode css"><code class="sourceCode css"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a>p {</span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">font-style</span>: <span class="dv">italic</span><span class="op">;</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>in which case the style applies to everything with that tag. If we do this, we can override general rules with specific ones: the style for a disclaimer paragraph is defined by <code>p</code> with overrides defined by <code>p.disclaimer</code>. We can also omit the tag and simply use <code>.class</code>, in which case every element with that class has that style.</p>
<p>As suggested by the earlier discussion of separators, elements may have multiple values for class, as in <code>&lt;span class="keyword highlight"&gt;…&lt;/span&gt;</code>. (The <code>span</code> element simply marks a region of text, but has no effect unless it’s styled.)</p>
<p>These features are one (but unfortunately not the only) common source of confusion with CSS: if one may override general rules with specific ones but also provide multiple values for class, how do we keep track of which rules will apply to an element with multiple classes? A detailed discussion of the order of precedence for CSS rules is outside the scope of this tutorial. We recommend that those likely to work often with stylesheets read (and consider bookmarking) <a href="https://www.w3schools.com/css/css_specificity.asp">this W3Schools page</a>.</p>
<p>One other thing CSS can do is match specific elements. We can label particular elements uniquely within a page using the <code>id</code> attribute, then refer to those elements using <code>#name</code> as a <a href="#g:selector"><strong>selector</strong></a>. For example, if we create a page that gives two spans unique IDs:</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;link</span> <span class="er">rel</span><span class="ot">=</span><span class="st">&quot;stylesheet&quot;</span> <span class="er">href</span><span class="ot">=</span><span class="st">&quot;selector-style.css&quot;</span> <span class="kw">/&gt;</span></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;p&gt;</span></span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a>      First <span class="kw">&lt;span</span> <span class="er">id</span><span class="ot">=</span><span class="st">&quot;major&quot;</span><span class="kw">&gt;</span>keyword<span class="kw">&lt;/span&gt;</span>.</span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/p&gt;</span></span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;p&gt;</span></span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>      Full <span class="kw">&lt;span</span> <span class="er">id</span><span class="ot">=</span><span class="st">&quot;minor&quot;</span><span class="kw">&gt;</span>explanation<span class="kw">&lt;/span&gt;</span>.</span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/p&gt;</span></span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>then we can style those spans like this:</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode css"><code class="sourceCode css"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#major</span> {</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">text-decoration</span>: <span class="dv">underline</span> <span class="cn">red</span><span class="op">;</span></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#minor</span> {</span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">text-decoration</span>: <span class="dv">overline</span> <span class="cn">blue</span><span class="op">;</span></span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<blockquote>
<h4 id="internal-links" class="unnumbered">Internal Links</h4>
<p>We can link to an element in a page using <code>#name</code> inside the link’s <code>href</code>: for example, <code>&lt;a href="page.html#place"&gt;text&lt;/a&gt;</code> refers to the <code>#place</code> element in <code>page.html</code>. This is particularly useful <em>within</em> pages: <code>&lt;a href="#place"&gt;jump&lt;/a&gt;</code> takes us straight to the <code>#place</code> element within this page. Internal links like this are often used for cross-referencing and to create a table of contents.</p>
</blockquote>
<h2 id="s:htmlcss-bootstrap">Bootstrap</h2>
<p>CSS can become very complicated very quickly, so most people use a framework to take care of the details. One of the most popular is <a href="https://getbootstrap.com/">Bootstrap</a> (which is what we’re using to style this website). Here’s the entire source of a page that uses Bootstrap to create a two-column layout with a banner at the top (Figure <a href="#f:htmlcss-bootstrap" data-reference-type="ref" data-reference="f:htmlcss-bootstrap">[f:htmlcss-bootstrap]</a>):</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;link</span> <span class="er">rel</span><span class="ot">=</span><span class="st">&quot;stylesheet&quot;</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a><span class="ot">          href=</span><span class="st">&quot;https://stackpath.bootstrapcdn.com/bootstrap/\</span></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a><span class="st">                4.1.3/css/bootstrap.min.css&quot;</span><span class="kw">&gt;</span></span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;style&gt;</span></span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>      div {</span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">border</span>: <span class="dv">solid</span> <span class="dv">1</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/style&gt;</span></span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;div</span> <span class="er">class</span><span class="ot">=</span><span class="st">&quot;jumbotron text-center&quot;</span><span class="kw">&gt;</span></span>
<span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;h1&gt;</span>Page Title<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb144-16"><a href="#cb144-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;p&gt;</span>Resize this page to see the layout adjust dynamically.<span class="kw">&lt;/p&gt;</span></span>
<span id="cb144-17"><a href="#cb144-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/div&gt;</span></span>
<span id="cb144-18"><a href="#cb144-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-19"><a href="#cb144-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;div</span> <span class="er">class</span><span class="ot">=</span><span class="st">&quot;container&quot;</span><span class="kw">&gt;</span></span>
<span id="cb144-20"><a href="#cb144-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;div</span> <span class="er">class</span><span class="ot">=</span><span class="st">&quot;row&quot;</span><span class="kw">&gt;</span></span>
<span id="cb144-21"><a href="#cb144-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;div</span> <span class="er">class</span><span class="ot">=</span><span class="st">&quot;col-sm-4&quot;</span><span class="kw">&gt;</span></span>
<span id="cb144-22"><a href="#cb144-22" aria-hidden="true" tabindex="-1"></a>          <span class="kw">&lt;h2&gt;</span>First column is 4 wide<span class="kw">&lt;/h2&gt;</span></span>
<span id="cb144-23"><a href="#cb144-23" aria-hidden="true" tabindex="-1"></a>          <span class="kw">&lt;p&gt;</span>Text here goes<span class="kw">&lt;/p&gt;</span></span>
<span id="cb144-24"><a href="#cb144-24" aria-hidden="true" tabindex="-1"></a>          <span class="kw">&lt;p&gt;</span>in the column<span class="kw">&lt;/p&gt;</span></span>
<span id="cb144-25"><a href="#cb144-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;/div&gt;</span></span>
<span id="cb144-26"><a href="#cb144-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;div</span> <span class="er">class</span><span class="ot">=</span><span class="st">&quot;col-sm-8&quot;</span><span class="kw">&gt;</span></span>
<span id="cb144-27"><a href="#cb144-27" aria-hidden="true" tabindex="-1"></a>          <span class="kw">&lt;h2&gt;</span>Second column is 8 wide<span class="kw">&lt;/h2&gt;</span></span>
<span id="cb144-28"><a href="#cb144-28" aria-hidden="true" tabindex="-1"></a>          <span class="kw">&lt;p&gt;</span>Text over here goes<span class="kw">&lt;/p&gt;</span></span>
<span id="cb144-29"><a href="#cb144-29" aria-hidden="true" tabindex="-1"></a>          <span class="kw">&lt;p&gt;</span>in the other column<span class="kw">&lt;/p&gt;</span></span>
<span id="cb144-30"><a href="#cb144-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;/div&gt;</span></span>
<span id="cb144-31"><a href="#cb144-31" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;/div&gt;</span></span>
<span id="cb144-32"><a href="#cb144-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/div&gt;</span></span>
<span id="cb144-33"><a href="#cb144-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-34"><a href="#cb144-34" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb144-35"><a href="#cb144-35" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>The page opens by loading Bootstrap from the web; we can also download <code>bootstrap.min.css</code> and refer to it with a local path. (The <code>.min</code> in the file’s name signals that the file has been <a href="#g:minimization"><strong>minimized</strong></a> so that it will load more quickly.)</p>
<p>The page then uses a <code>style</code> element to create an <a href="#g:internal-style-sheet"><strong>internal style sheet</strong></a> to put a solid one-pixel border around every <code>div</code> so that we can see the regions of the page more clearly. Defining styles in the page header is generally a bad idea, but it’s a good way to test things quickly. Oh, and a <code>div</code> just marks a region of a page without doing anything to it, just as a <code>span</code> marks a region of text without changing its appearance unless we apply a style.</p>
<p>The first <code>div</code> creates a header box (called a “jumbotron”) and centers its text. The second <code>div</code> is a container, which creates a bit of margin on the left and right sides of our content. Inside that container is a row with two columns, one 4/12 as wide as the row and the other 8/12 as wide. (Bootstrap uses a 12-column system because 12 has lots of divisors.)</p>
<p>Bootstrap is <a href="#g:responsive-design"><strong>responsive</strong></a>: elements change size as the page grows narrower, and are then stacked when the screen becomes too small to display them side by side.</p>
<p>We’ve left out many other aspects of HTML and CSS as well, such as figure captions, multi-column table cells, and why it’s so hard to center text vertically within a <code>div</code>. One thing we will return to in Chapter <a href="#s:interactive" data-reference-type="ref" data-reference="s:interactive">10</a> is how to include interactive elements like buttons and forms in a page. Handling those is part of why JavaScript was invented in the first place, but we need more experience before tackling them.</p>
<h2 id="s:htmlcss-exercises">Exercises</h2>
<h3 class="unnumbered" id="cutting-corners">Cutting Corners</h3>
<p>What does your browser display if you forget to close a paragraph or list item tag like this:</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;p&gt;</span>This paragraph starts but doesn&#39;t officially end.</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;p&gt;</span>Another paragraph starts here but also doesn&#39;t end.</span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;ul&gt;</span></span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;li&gt;</span>First item in the list isn&#39;t closed.</span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;li&gt;</span>Neither is the second.</span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/ul&gt;</span></span></code></pre></div>
<ol>
<li><p>What happens if you don’t close a <code>ul</code> or <code>ol</code> list?</p></li>
<li><p>Is that behavior consistent with what happens when you omit <code>&lt;/p&gt;</code> or <code>&lt;/li&gt;</code>?</p></li>
</ol>
<h3 class="unnumbered" id="mix-and-match">Mix and Match</h3>
<ol>
<li><p>Create a page that contains a 2x2 table, each cell of which has a three-item bullet-point list. How can you reduce the indentation of the list items within their cells using CSS?</p></li>
<li><p>Open your page in a different browser (e.g., Firefox or Edge). Do they display your indented lists consistently?</p></li>
<li><p>Why do programs behave inconsistently? Why do programmers do this to us? Why? Why why why why why?</p></li>
</ol>
<h3 class="unnumbered" id="naming">Naming</h3>
<p>What does the <code>sm</code> in Bootstrap’s <code>col-sm-4</code> and <code>col-sm-8</code> stand for? What other options could you use instead? Why do web developers still use FORTRAN-style names in the 21st Century?</p>
<h3 class="unnumbered" id="color">Color</h3>
<p>HTML and CSS define names for a small number of colors. All other colors must be specified using <a href="#g:rgb"><strong>RGB</strong></a> values. Write a small JavaScript program that creates an HTML page that displays the word <code>color</code> in 100 different randomly-generated colors. Compare this to the color scheme used in your departmental website. Which one hurts your eyes less?</p>
<h3 class="unnumbered" id="units">Units</h3>
<p>What different units can you use to specify text size in CSS? What do they mean? What does <em>anything</em> mean, when you get right down to it?</p>
<h2 class="unnumbered" id="key-points-4">Key Points</h2>
<ul>
<li><p>HTML is the latest in a long line of markup languages.</p></li>
<li><p>HTML documents contain elements (represented by tags in angle brackets) and text.</p></li>
<li><p>Elements must be strictly nested.</p></li>
<li><p>Elements can contain attributes.</p></li>
<li><p>Use escape sequences beginning with ampersand to represent special characters.</p></li>
<li><p>Every page should have one <code>html</code> element containing a <code>head</code> and a <code>body</code>.</p></li>
<li><p>Use <code>&lt;!--...--&gt;</code> to include comments in HTML.</p></li>
<li><p>Use <code>ul</code> and <code>ol</code> for unordered and ordered lists, and <code>li</code> for list elements.</p></li>
<li><p>Use <code>table</code> for tables, <code>tr</code> for rows, <code>th</code> for headings, and <code>td</code> for regular data.</p></li>
<li><p>Use <code>&lt;a href="..."&gt;...&lt;/a&gt;</code> to create links.</p></li>
<li><p>Use <code>&lt;img src="..." title="..." alt="..." /&gt;</code> to include images.</p></li>
<li><p>Use CSS to define appearance of elements.</p></li>
<li><p>Use <code>class</code> and <code>id</code> to identify elements.</p></li>
<li><p>Use selectors to specify the elements that CSS applies to.</p></li>
</ul>
<h1 id="s:pages">Manipulating Pages</h1>
<p>We have presented a lot of tools, but as yet no applications. As a reward for your patience, we will therefore work through several examples that show how to do useful things to web pages. These examples introduce some new concepts, the most important of which is the way in which HTML pages are represented in, and manipulated by, JavaScript.</p>
<p>One thing these examples <em>don’t</em> show is how to build interactive web pages. JavaScript was invented primarily to support buttons, forms, and the like, but we will need a bit more background before exploring them. Still, we can do a surprising number of useful things simply by playing with the content of pages.</p>
<h2 id="s:pages-counting">Counting Paragraphs</h2>
<p>Let’s begin by counting the number of paragraphs in a page:</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;meta</span> <span class="er">charset</span><span class="ot">=</span><span class="st">&quot;utf-8&quot;</span><span class="kw">/&gt;</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;h1&gt;</span>Title<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;div</span> <span class="er">id</span><span class="ot">=</span><span class="st">&quot;fill&quot;</span><span class="kw">&gt;&lt;/div&gt;</span></span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;h2</span> <span class="er">id</span><span class="ot">=</span><span class="st">&quot;one&quot;</span><span class="kw">&gt;</span>First <span class="kw">&lt;em&gt;</span>emphasized<span class="kw">&lt;/em&gt;&lt;/h2&gt;</span></span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;p&gt;</span>stuff<span class="kw">&lt;/p&gt;</span></span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;h2</span> <span class="er">id</span><span class="ot">=</span><span class="st">&quot;two&quot;</span><span class="kw">&gt;</span>Second <span class="kw">&lt;code&gt;</span>with code<span class="kw">&lt;/code&gt;&lt;/h2&gt;</span></span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;h3&gt;</span>stuff<span class="kw">&lt;/h3&gt;</span></span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;h2</span> <span class="er">id</span><span class="ot">=</span><span class="st">&quot;three&quot;</span><span class="kw">&gt;</span>Third<span class="kw">&lt;/h2&gt;</span></span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;p&gt;</span>stuff<span class="kw">&lt;/p&gt;</span></span>
<span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-15"><a href="#cb146-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script&gt;</span></span>
<span id="cb146-16"><a href="#cb146-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> counter <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb146-17"><a href="#cb146-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> paragraphs <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;p&#39;</span>)</span>
<span id="cb146-18"><a href="#cb146-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> paragraphs<span class="op">.</span><span class="at">length</span></span>
<span id="cb146-19"><a href="#cb146-19" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb146-20"><a href="#cb146-20" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`number of paragraphs: </span><span class="sc">${</span><span class="fu">counter</span>()<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb146-21"><a href="#cb146-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/script&gt;</span></span>
<span id="cb146-22"><a href="#cb146-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb146-23"><a href="#cb146-23" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>This page has three main parts:</p>
<ol>
<li><p>The <code>head</code> contains a <code>meta</code> tag that specifies the page’s <a href="#g:character-encoding"><strong>character encoding</strong></a>, i.e., the scheme used to represent characters not found on a standard American keyboard in the 1970s. Character sets and character encodings are out of scope for this lesson; see <a href="https://www.joelonsoftware.com/2003/10/08/the-absolute-minimum-every-software-developer-absolutely-positively-must-know-about-unicode-and-character-sets-no-excuses/">this essay</a> for an unfortunately timeless discussion.</p></li>
<li><p>The top half of the <code>body</code> has some headings and paragraphs for the JavaScript to play with. It also contains a <code>div</code> marked with <code>class="fill"</code> that our script will eventually fill in with a count.</p></li>
<li><p>The script itself is contained in a <code>script</code> tag at the bottom of the page; we will explore it in depth below.</p></li>
</ol>
<blockquote>
<h4 id="when-scripts-run" class="unnumbered">When Scripts Run</h4>
<p>We have put the script at the bottom of the page because we want to be sure that the page’s contents actually exist in memory before trying to process them. If we put the <code>script</code> tag and its contents at the top of the page, the browser might run our JavaScript <em>after</em> the page has been read but <em>before</em> its elements and text have been parsed and stored in memory. <a href="#g:race-condition"><strong>Race conditions</strong></a> like this bedevil web programming; we will see more robust ways to deal with them later.</p>
</blockquote>
<p>Inside the <code>script</code> tag, we define a function called <code>counter</code> that takes no arguments, then use <code>console.log</code> to display the result of calling it. The only thing inside the function that we haven’t encountered before is the call <code>document.querySelectorAll(’p’)</code>. As you might guess from its name, <code>document</code> is an object that gives us a handle on the page the script is in; it is created and provided automatically by the browser. Its <code>querySelectorAll</code> method finds all elements in the page that match the selector we provide. In this case, we’re looking for all paragraphs, so we simply search for <code>’p’</code>.</p>
<p>To see the JavaScript in action, run a browser, open its developer tools so that you can see the JavaScript console, and then load the page. The page’s elements will be displayed as usual, and the console will show:</p>
<pre class="text"><code>number of paragraphs: 2</code></pre>
<blockquote>
<h4 id="developer-tools" class="unnumbered">Developer Tools</h4>
<p>To open developer tools in Firefox, go to the main menu and select <code>Tools &gt; Web Developer &gt; Toggle Tools</code>. A tabbed display will open in the bottom of your page; choose <code>Console</code> to view the output of your JavaScript, or to write a little bit to run immediately. You can open a similar set of tools from <code>View &gt; Developer &gt; JavaScript Console</code> in Chrome, or by using <code>Ctrl+Shift+I</code> on Windows for Firefox, Chrome, or Microsoft Edge.</p>
</blockquote>
<p>Showing results in the console is good enough for development work, but we would like to see the result in the page itself. To do this, we can replace the call to <code>console.log</code> with the two lines shown below:</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> counter <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> paragraphs <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;p&#39;</span>)</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> paragraphs<span class="op">.</span><span class="at">length</span></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fill <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;fill&#39;</span>)</span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>fill<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="vs">`number of paragraphs: </span><span class="sc">${</span><span class="fu">counter</span>()<span class="sc">}</span><span class="vs">`</span></span></code></pre></div>
<p>Where <code>document.querySelectorAll</code> returns all nodes that match a selector, <code>document.getElementById</code> returns a single element that has the specified ID (which is set inside the element’s opening tag with <code>id="some_name"</code>). The variable <code>fill</code> is therefore assigned a reference to our <code>div</code>. We can then change the text inside that element by assigning to its <code>innerHTML</code> property. When we do this, JavaScript parses the string we provided as if it were HTML and creates whatever nodes it needs to represent the result. In this case, the content is just text, so JavaScript will create a single text node, store <code>"number of paragraphs: 2"</code> as its content, and add it to the in-memory structure that represents the page.</p>
<p><span>…</span>at which point some magic happens behind the scenes. The browser stores the elements and text of the current page in a data structure called the Document Object Model, or more commonly the <a href="#g:dom"><strong>DOM</strong></a>. As shown in Figure <a href="#f:htmlcss-tree" data-reference-type="ref" data-reference="f:htmlcss-tree">5.1</a>, the DOM is organized as a tree: each element or piece of text is a <a href="#g:node"><strong>node</strong></a> in the tree, and a node’s children are the elements contained within it. Any time the browser detects a change to the DOM, it automatically refreshes just as much of its display as it needs to. We can insert or remove text, change elements’ styles, or copy in entire sub-pages: each time, the browser will do only the work required to reflect that change as quickly as possible.</p>
<h2 id="s:pages-toc">Creating a Table of Contents</h2>
<p>Reporting the number of paragraphs is a good way to see how JavaScript works in the browser, but isn’t particularly useful (although counting the number of words is—we will tackle that in the exercises). Something we’re more likely to put in a real page is a table of contents, which takes only a little more code than what we’ve already seen:</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>(() <span class="kw">=&gt;</span> {</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> container <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;fill&#39;</span>)</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> headings <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="bu">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;h2&#39;</span>))</span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> items <span class="op">=</span> headings</span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">map</span>((h) <span class="kw">=&gt;</span> <span class="vs">`&lt;li&gt;&lt;a href=&quot;#</span><span class="sc">${</span>h<span class="op">.</span><span class="at">id</span><span class="sc">}</span><span class="vs">&quot;&gt;</span><span class="sc">${</span>h<span class="op">.</span><span class="at">innerHTML</span><span class="sc">}</span><span class="vs">&lt;/a&gt;&lt;/li&gt;`</span>)</span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)</span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>  container<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;ul&gt;&#39;</span> <span class="op">+</span> items <span class="op">+</span> <span class="st">&#39;&lt;/ul&gt;&#39;</span></span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a>})()</span></code></pre></div>
<p>Let’s start with the first and last lines, since they demonstrate a commonly-used idiom. We’ve seen how to define a function and then call it:</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> f <span class="op">=</span> (param) <span class="kw">=&gt;</span> {</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// body</span></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a><span class="fu">f</span>()</span></code></pre></div>
<p>If we’re only going to call the function once, we might as well define it and call it immediately without giving it a name:</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a>(param) <span class="kw">=&gt;</span> {</span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// body</span></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>}(actual_value)</span></code></pre></div>
<p>However, this doesn’t reliably work as written; in order to make JavaScript happy, we have to put parentheses around the function definition so that it’s clear exactly what’s being called:</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>((param) <span class="kw">=&gt;</span> {</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// body</span></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>})(actual_value)</span></code></pre></div>
<p><code>()</code> before the fat arrow means “this function doesn’t take any parameters”. The second <code>()</code> after the closing curly brace means “call the function”. If the function doesn’t take any arguments, this becomes:</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a>(() <span class="kw">=&gt;</span> {</span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// body</span></span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a>})()</span></code></pre></div>
<p>which is a lot of parentheses in a row, but that’s what people write.</p>
<p>Let’s come back to the body of the function:</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> container <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;fill&#39;</span>)</span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> headings <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="bu">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;h2&#39;</span>))</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> items <span class="op">=</span> headings</span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">map</span>((h) <span class="kw">=&gt;</span> <span class="vs">`&lt;li&gt;&lt;a href=&quot;#</span><span class="sc">${</span>h<span class="op">.</span><span class="at">id</span><span class="sc">}</span><span class="vs">&quot;&gt;</span><span class="sc">${</span>h<span class="op">.</span><span class="at">innerHTML</span><span class="sc">}</span><span class="vs">&lt;/a&gt;&lt;/li&gt;`</span>)</span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;&#39;</span>)</span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>  container<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> <span class="st">&#39;&lt;ul&gt;&#39;</span> <span class="op">+</span> items <span class="op">+</span> <span class="st">&#39;&lt;/ul&gt;&#39;</span></span></code></pre></div>
<p>As before, the first line gets the <code>div</code> we’re going to fill in. The second line grabs all the <code>h2</code> headings, which we have arbitrarily decided are the only things worthy of inclusion in the table of contents. We run the result of <code>document.querySelectorAll</code> through the function <code>Array.from</code> because the former’s result isn’t a JavaScript array: for reasons that probably made sense to someone, somewhere, it’s a thing called a <code>NodeList</code> that lacks most of <code>Array</code>’s useful methods.</p>
<blockquote>
<h4 id="static-methods" class="unnumbered">Static Methods</h4>
<p><code>Array.from</code> is a <a href="#g:static-method"><strong>static method</strong></a>: it belongs to the class as a whole, not to objects of that class. Static methods are primarily used to associate utility functions with classes, like <code>dist</code> in the example below. Unlike calls to <a href="#g:instance-method"><strong>instance methods</strong></a> like <code>magnitude</code>, static methods are called using <code>class.method()</code> rather than <code>some_object.method()</code>.</p>
</blockquote>
<p>We then have three lines that do most of the function’s work. The first tells us that <code>items</code> is going to be assigned something derived from <code>headings</code>; the second transforms the array of headings into an array of strings, and the third joins those strings to create a single string. Looking at the <code>map</code> call, each heading becomes a list item (<code>li</code>) containing a link (<code>a</code>) whose <code>href</code> attribute is the ID of the heading and whose displayed content (the text between <code>&lt;a...&gt;</code> and <code>&lt;/a&gt;</code>) is the text of the heading. The <code>href</code> attribute’s value starts with <code>#</code>, which makes this a local link (i.e., it links to something inside the same page). If one of our <code>h2</code> headings doesn’t have an <code>id</code> set, this <code>map</code> will fail; we’ll explore ways to handle this in the exercises.</p>
<p>Finally, the last line of the code shown above fills in the content of the container (i.e., the <code>div</code>) with an unordered list (<code>ul</code>) that contains all of the items we just constructed. Again, when we assign to an element’s <code>innerHTML</code> property, JavaScript parses the string we give it and constructs the HTML nodes we need. It would be marginally faster to build these nodes ourselves (which we will do in the exercises), but building and parsing strings is usually easier to read, and the performance differences are small enough in modern browsers that we should only worry about them if they actually prove themselves a problem.</p>
<h2 id="s:pages-sort-list">Sortable Lists</h2>
<p>Creating nodes allows us to add content to a page, but we can also rearrange the nodes that are there (Figure <a href="#f:pages-sortlist" data-reference-type="ref" data-reference="f:pages-sortlist">6.1</a>). Our next exercise is to sort the elements of a list, so that if the author writes:</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;ul&gt;</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;li&gt;</span>pee (P)<span class="kw">&lt;/li&gt;</span></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;li&gt;</span>cue (Q)<span class="kw">&lt;/li&gt;</span></span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;li&gt;</span>are (R)<span class="kw">&lt;/li&gt;</span></span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/ul&gt;</span></span></code></pre></div>
<p>we will automatically rearrange the items to be:</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;ul&gt;</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;li&gt;</span>are (R)<span class="kw">&lt;/li&gt;</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;li&gt;</span>cue (Q)<span class="kw">&lt;/li&gt;</span></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;li&gt;</span>pee (P)<span class="kw">&lt;/li&gt;</span></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/ul&gt;</span></span></code></pre></div>
<p>Our first attempt uses this as the HTML page:</p>
<div class="sourceCode" id="cb157"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;meta</span> <span class="er">charset</span><span class="ot">=</span><span class="st">&quot;utf-8&quot;</span><span class="kw">&gt;</span></span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="er">src</span><span class="ot">=</span><span class="st">&quot;sort-lists.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body</span> <span class="er">onload</span><span class="ot">=</span><span class="st">&quot;sortLists()&quot;</span><span class="kw">&gt;</span></span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;ul</span> <span class="er">class</span><span class="ot">=</span><span class="st">&quot;sorted&quot;</span><span class="kw">&gt;</span></span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;li&gt;</span>first<span class="kw">&lt;/li&gt;</span></span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;li&gt;</span>second<span class="kw">&lt;/li&gt;</span></span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;li&gt;</span>third<span class="kw">&lt;/li&gt;</span></span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;li&gt;</span>fourth<span class="kw">&lt;/li&gt;</span></span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;li&gt;</span>fifth<span class="kw">&lt;/li&gt;</span></span>
<span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/ul&gt;</span></span>
<span id="cb157-16"><a href="#cb157-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-17"><a href="#cb157-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;ol</span> <span class="er">class</span><span class="ot">=</span><span class="st">&quot;sorted&quot;</span><span class="kw">&gt;</span></span>
<span id="cb157-18"><a href="#cb157-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;li&gt;</span>one<span class="kw">&lt;/li&gt;</span></span>
<span id="cb157-19"><a href="#cb157-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;li&gt;</span>two<span class="kw">&lt;/li&gt;</span></span>
<span id="cb157-20"><a href="#cb157-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;li&gt;</span>three<span class="kw">&lt;/li&gt;</span></span>
<span id="cb157-21"><a href="#cb157-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;li&gt;</span>four<span class="kw">&lt;/li&gt;</span></span>
<span id="cb157-22"><a href="#cb157-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;li&gt;</span>five<span class="kw">&lt;/li&gt;</span></span>
<span id="cb157-23"><a href="#cb157-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/ol&gt;</span></span>
<span id="cb157-24"><a href="#cb157-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-25"><a href="#cb157-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb157-26"><a href="#cb157-26" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>and this as our initial script:</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> sortLists <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> lists <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="bu">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;#sorted&#39;</span>))</span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>  lists<span class="op">.</span><span class="fu">forEach</span>((list) <span class="kw">=&gt;</span> {</span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> children <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(list<span class="op">.</span><span class="at">childNodes</span>)</span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">filter</span>(c <span class="kw">=&gt;</span> c<span class="op">.</span><span class="at">nodeName</span> <span class="op">!==</span> <span class="st">&#39;#text&#39;</span>)</span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>    children<span class="op">.</span><span class="fu">sort</span>((left<span class="op">,</span> right) <span class="kw">=&gt;</span></span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a>                  left<span class="op">.</span><span class="at">textContent</span><span class="op">.</span><span class="fu">localeCompare</span>(right<span class="op">.</span><span class="at">textContent</span>))</span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (list<span class="op">.</span><span class="at">firstChild</span>) {</span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a>      list<span class="op">.</span><span class="fu">removeChild</span>(list<span class="op">.</span><span class="at">firstChild</span>)</span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a>    children<span class="op">.</span><span class="fu">forEach</span>(c <span class="kw">=&gt;</span> list<span class="op">.</span><span class="fu">appendChild</span>(c))</span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb158-13"><a href="#cb158-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>When we load the page, though, the items aren’t sorted. A bit of trial and error reveals that we have tripped over the race condition alluded to earlier: if we call our function in the <code>onload</code> attribute of the <code>body</code> tag, it is run when the page is loaded into memory but <em>before</em> the page’s content has been parsed and turned into a DOM tree. After searching online for “run JavaScript when page loaded”, we go back to this:</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;meta</span> <span class="er">charset</span><span class="ot">=</span><span class="st">&quot;utf-8&quot;</span><span class="kw">&gt;</span></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="er">src</span><span class="ot">=</span><span class="st">&quot;sort-lists-event.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a>    ...lists as before...</span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>and write our JavaScript like this:</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> sortLists <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...function to sort lists...</span></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a><span class="bu">document</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&quot;DOMContentLoaded&quot;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sortLists</span>()</span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>An <a href="#g:event-listener"><strong>event listener</strong></a> is a function that the browser calls when some kind of event occurs. In our example, the event we care about is “DOM content has been loaded”. When that occurs, the browser will call <code>sortLists()</code>. (The <code>event</code> parameter to our function will be given an object that stores details about what precisely happened. We don’t need that information now, but will use it later when we start handling button clicks and the like.)</p>
<p>Let’s return to the function:</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> sortLists <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> lists <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="bu">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;.sorted&#39;</span>))</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>  lists<span class="op">.</span><span class="fu">forEach</span>((list) <span class="kw">=&gt;</span> {</span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> children <span class="op">=</span> <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(list<span class="op">.</span><span class="at">childNodes</span>)</span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a>          <span class="op">.</span><span class="fu">filter</span>(c <span class="kw">=&gt;</span> c<span class="op">.</span><span class="at">nodeName</span> <span class="op">!==</span> <span class="st">&#39;#text&#39;</span>)</span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a>    children<span class="op">.</span><span class="fu">sort</span>((left<span class="op">,</span> right) <span class="kw">=&gt;</span></span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a>                  left<span class="op">.</span><span class="at">textContent</span><span class="op">.</span><span class="fu">localeCompare</span>(right<span class="op">.</span><span class="at">textContent</span>))</span>
<span id="cb161-8"><a href="#cb161-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> (list<span class="op">.</span><span class="at">firstChild</span>) {</span>
<span id="cb161-9"><a href="#cb161-9" aria-hidden="true" tabindex="-1"></a>      list<span class="op">.</span><span class="fu">removeChild</span>(list<span class="op">.</span><span class="at">firstChild</span>)</span>
<span id="cb161-10"><a href="#cb161-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb161-11"><a href="#cb161-11" aria-hidden="true" tabindex="-1"></a>    children<span class="op">.</span><span class="fu">forEach</span>(c <span class="kw">=&gt;</span> list<span class="op">.</span><span class="fu">appendChild</span>(c))</span>
<span id="cb161-12"><a href="#cb161-12" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb161-13"><a href="#cb161-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<figure>
<img src="figures/pages-sortlist.svg" id="f:pages-sortlist" /><figcaption aria-hidden="true"><span>Sorting and Replacing</span><span id="f:pages-sortlist" label="f:pages-sortlist">[f:pages-sortlist]</span></figcaption>
</figure>
<p>As before, it starts by creating an array containing the nodes we want to operate on. (We use the selector <code>.sorted</code> (with a leading dot) to select everything with the class <code>sorted</code>, rather than <code>#sorted</code>, which would find nodes with the ID <code>sorted</code>.) This array will then have all the <code>ul</code> or <code>ol</code> lists that the function is to sort.</p>
<p>We process each list separately with <code>lists.forEach</code>. The callback function inside <code>forEach</code> uses <code>Array.from</code> to create an array containing the child nodes of the main list element, then filters that list to remove any that are text nodes. We need the <code>Array.from</code> call because (once again) the DOM doesn’t use a JavaScript array to store children, but a structure of its own devising that lacks the methods we want to call. We remove the text nodes because they represent the <a href="#g:whitespace"><strong>whitespace</strong></a> between list elements, such as newline characters after a closing <code>&lt;/li&gt;</code> and before the next opening <code>&lt;li&gt;</code>.</p>
<blockquote>
<h4 id="identifying-text-nodes" class="unnumbered">Identifying Text Nodes</h4>
<p>We could check <code>c.nodeType</code> instead of <code>c.nodeName</code> to spot text nodes, but we felt that <code>nodeName</code> made the code easier to understand. As always, we use <code>!==</code> for the comparison in order to prevent unpleasant surprises (Section <a href="#s:legacy-equality" data-reference-type="ref" data-reference="s:legacy-equality">23.1</a>).</p>
</blockquote>
<p>Now that we have an array of the <code>li</code> elements to be sorted, we can use <code>Array.sort</code> to order them. Since we want to sort them by the text they contain, we have to provide our own sorting function that returns a negative number, 0, or a positive number to show whether its <code>left</code> argument is less than, equal to, or greater than its <code>right</code> argument. We use the <code>textContent</code> member of the node to get the text it contains, and the string object’s <code>localeCompare</code> to get a -1/0/1 result. All of this was discovered by searching online, primarily on the <a href="https://www.w3schools.com/">W3Schools</a> site.</p>
<p>Unfortunately, searching for “remove all children from node” tells us that we have to do it ourselves, so we use a <code>while</code> loop to remove all the children (including the unwanted top-level text elements) from the <code>ul</code> or <code>ol</code> list, then add all of the children back in sorted order. Sure enough, the page now displays the nodes in the right order.</p>
<h2 id="s:pages-citations">Bibliographic Citations</h2>
<p>And so we come to the largest example in this lesson. HTML has a <code>cite</code> tag for formatting citations, but it doesn’t allow us to link directly to a bibliography entry. In order to minimize typing in scholarly papers, we’d like to find links like this:</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">&quot;#b&quot;</span><span class="kw">&gt;</span>key1, key2<span class="kw">&lt;/a&gt;</span></span></code></pre></div>
<p>and turn them into this:</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>[<span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">&quot;../bib/#key1&quot;</span><span class="kw">&gt;</span>key1<span class="kw">&lt;/a&gt;</span>, <span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">&quot;../bib/#key2&quot;</span><span class="kw">&gt;</span>key2<span class="kw">&lt;/a&gt;</span>]</span></code></pre></div>
<p>The typed-in form is about as little typing as we can get away with; the displayed form then wraps the citations in <code>[...]</code> and turns each individual citation into a link to our bibliography. For now, we’ll assume that the bibliography can be found at <code>../bib/</code>, i.e., in a file called <code>index.html</code> that’s in a directory called <code>bib</code> that’s a sibling of the directory containing whatever page the citation is in. This is very fragile, and we should be ashamed of ourselves, but we can tell ourselves that we’re going to fix it later and get on with learning JavaScript for now.</p>
<p>Our test page contains two bibliographic links and one non-bibliographic link:</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;meta</span> <span class="er">charset</span><span class="ot">=</span><span class="st">&quot;utf-8&quot;</span><span class="kw">&gt;</span></span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="er">src</span><span class="ot">=</span><span class="st">&quot;citations.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;p&gt;</span>As <span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">&quot;#b&quot;</span><span class="kw">&gt;</span>Moreau1896<span class="kw">&lt;/a&gt;</span> shows...<span class="kw">&lt;/p&gt;</span></span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;p&gt;</span></span>
<span id="cb164-10"><a href="#cb164-10" aria-hidden="true" tabindex="-1"></a>      We can look to <span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">&quot;#b&quot;</span><span class="kw">&gt;</span>Brundle1982, Brundle1984<span class="kw">&lt;/a&gt;</span></span>
<span id="cb164-11"><a href="#cb164-11" aria-hidden="true" tabindex="-1"></a>      for answers.</span>
<span id="cb164-12"><a href="#cb164-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/p&gt;</span></span>
<span id="cb164-13"><a href="#cb164-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;hr/&gt;</span></span>
<span id="cb164-14"><a href="#cb164-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;p&gt;&lt;em&gt;</span>Visit <span class="kw">&lt;a</span> <span class="er">href</span><span class="ot">=</span><span class="st">&quot;http://somewhere.org&quot;</span><span class="kw">&gt;</span>the author&#39;s site<span class="kw">&lt;/a&gt;</span>.<span class="kw">&lt;/em&gt;&lt;/p&gt;</span></span>
<span id="cb164-15"><a href="#cb164-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-16"><a href="#cb164-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb164-17"><a href="#cb164-17" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>Here’s our function (Figure <a href="#f:pages-pipeline" data-reference-type="ref" data-reference="f:pages-pipeline">6.2</a>), which we’ll call from an event listener as before:</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> citations <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="bu">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;a&#39;</span>))</span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(link <span class="kw">=&gt;</span> link<span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;href&#39;</span>) <span class="op">===</span> <span class="st">&#39;#b&#39;</span>)</span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(link <span class="kw">=&gt;</span> (</span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a>      {<span class="dt">node</span><span class="op">:</span> link<span class="op">,</span></span>
<span id="cb165-6"><a href="#cb165-6" aria-hidden="true" tabindex="-1"></a>       <span class="dt">text</span><span class="op">:</span> link<span class="op">.</span><span class="at">textContent</span><span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;,&#39;</span>)<span class="op">.</span><span class="fu">map</span>(s <span class="kw">=&gt;</span> s<span class="op">.</span><span class="fu">trim</span>())}</span>
<span id="cb165-7"><a href="#cb165-7" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb165-8"><a href="#cb165-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(({node<span class="op">,</span> text}) <span class="kw">=&gt;</span> (</span>
<span id="cb165-9"><a href="#cb165-9" aria-hidden="true" tabindex="-1"></a>      {node<span class="op">,</span></span>
<span id="cb165-10"><a href="#cb165-10" aria-hidden="true" tabindex="-1"></a>       <span class="dt">text</span><span class="op">:</span> text<span class="op">.</span><span class="fu">map</span>(cite <span class="kw">=&gt;</span> <span class="vs">`&lt;a href=&quot;../bib/#</span><span class="sc">${</span>cite<span class="sc">}</span><span class="vs">&quot;&gt;</span><span class="sc">${</span>cite<span class="sc">}</span><span class="vs">&lt;/a&gt;`</span>)}</span>
<span id="cb165-11"><a href="#cb165-11" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb165-12"><a href="#cb165-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(({node<span class="op">,</span> text}) <span class="kw">=&gt;</span> (</span>
<span id="cb165-13"><a href="#cb165-13" aria-hidden="true" tabindex="-1"></a>      {node<span class="op">,</span></span>
<span id="cb165-14"><a href="#cb165-14" aria-hidden="true" tabindex="-1"></a>       <span class="dt">text</span><span class="op">:</span> <span class="vs">`[</span><span class="sc">${</span>text<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;, &#39;</span>)<span class="sc">}</span><span class="vs">]`</span>}</span>
<span id="cb165-15"><a href="#cb165-15" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb165-16"><a href="#cb165-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">forEach</span>(({node<span class="op">,</span> text}) <span class="kw">=&gt;</span> {</span>
<span id="cb165-17"><a href="#cb165-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> span <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;span&#39;</span>)</span>
<span id="cb165-18"><a href="#cb165-18" aria-hidden="true" tabindex="-1"></a>      span<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> text</span>
<span id="cb165-19"><a href="#cb165-19" aria-hidden="true" tabindex="-1"></a>      node<span class="op">.</span><span class="at">parentNode</span><span class="op">.</span><span class="fu">replaceChild</span>(span<span class="op">,</span> node)</span>
<span id="cb165-20"><a href="#cb165-20" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb165-21"><a href="#cb165-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<figure>
<img src="figures/pages-pipeline.svg" id="f:pages-pipeline" /><figcaption aria-hidden="true"><span>A Processing Pipeline</span><span id="f:pages-pipeline" label="f:pages-pipeline">[f:pages-pipeline]</span></figcaption>
</figure>
<p>There is a lot going on here, but it all uses patterns we have seen before. It starts by building an array of all the links in the document i.e., every <code>a</code> element:</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Array</span><span class="op">.</span><span class="fu">from</span>(<span class="bu">document</span><span class="op">.</span><span class="fu">querySelectorAll</span>(<span class="st">&#39;a&#39;</span>))</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// output:</span></span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// - &lt;a href=&quot;#b&quot;&gt;Moreau1896&lt;/a&gt;</span></span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// - &lt;a href=&quot;#b&quot;&gt;Brundle1982, Brundle1984&lt;/a&gt;</span></span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// - &lt;a href=&quot;http://somewhere.org&quot;&gt;the author&#39;s site&lt;/a&gt;</span></span></code></pre></div>
<p>(We show the nodes in comments to visualize what each step of the pipeline does.) We then filter this array to find the links pointing at <code>#b</code>, which is what we’re using to signal citations:</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(link <span class="kw">=&gt;</span> link<span class="op">.</span><span class="fu">getAttribute</span>(<span class="st">&#39;href&#39;</span>) <span class="op">===</span> <span class="st">&#39;#b&#39;</span>)</span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// output:</span></span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// - &lt;a href=&quot;#b&quot;&gt;Moreau1896&lt;/a&gt;</span></span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// - &lt;a href=&quot;#b&quot;&gt;Brundle1982, Brundle1984&lt;/a&gt;</span></span></code></pre></div>
<p>We now have a problem. We could use a <code>map</code> call to get the text out of each link and process it, but then all we’d have is an array of strings. We’re going to want the nodes those strings came out of later on as well so that we can modify their <code>href</code> attributes, so somehow we have to pass the nodes and strings together through our pipeline. One option would be to create a two-element array for each:</p>
<div class="sourceCode" id="cb168"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb168-1"><a href="#cb168-1" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(link <span class="kw">=&gt;</span> [link<span class="op">,</span> link<span class="op">.</span><span class="at">textContent</span><span class="op">.</span><span class="at">whatever</span>])</span></code></pre></div>
<p>but it’s more readable to create an object so that each component has a name:</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(link <span class="kw">=&gt;</span> (</span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>      {<span class="dt">node</span><span class="op">:</span> link<span class="op">,</span></span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>       <span class="dt">text</span><span class="op">:</span> link<span class="op">.</span><span class="at">textContent</span><span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;,&#39;</span>)<span class="op">.</span><span class="fu">map</span>(s <span class="kw">=&gt;</span> s<span class="op">.</span><span class="fu">trim</span>())}</span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// output:</span></span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// - {node: &lt;a href=&quot;#b&quot;&gt;Moreau1896&lt;/a&gt;,</span></span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">//    text: [&#39;Moreau1896&#39;]}</span></span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// - {node: &lt;a href=&quot;#b&quot;&gt;Brundle1982, Brundle1984&lt;/a&gt;,</span></span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">//    text: [&#39;Brundle1982&#39;, &#39;Brundle1984&#39;]}</span></span></code></pre></div>
<p>Here, we are turning each link into an object whose <code>"node"</code> key has the link’s DOM node as its value, and whose <code>"text"</code> key has the node’s text, which we split on commas and trim to remove leading and trailing whitespace.</p>
<p>But we’re not done looking at this stage of our pipeline:</p>
<ol>
<li><p>We don’t need to quote the names <code>"node"</code> and <code>"text"</code>, though we could.</p></li>
<li><p>JavaScript’s <code>String.split</code> returns an array, so the value associated with <code>"text"</code> is an array. We then <code>map</code> over its elements to trim leading and trailing space from each.</p></li>
<li><p>If we wrote <code>link =&gt; {node: link, text: whatever}</code>, JavaScript would interpret the curly braces <code>{...}</code> as meaning, “Here is the body of a function,” and then complain because what’s in those curly braces clearly <em>isn’t</em> a function body. Putting parentheses around the curly braces, i.e., writing <code>({...})</code>, tells JavaScript that the function is returning an object.</p></li>
</ol>
<p>After all of this, the next stage of the pipeline is almost a relief:</p>
<div class="sourceCode" id="cb170"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb170-1"><a href="#cb170-1" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(({node<span class="op">,</span> text}) <span class="kw">=&gt;</span> (</span>
<span id="cb170-2"><a href="#cb170-2" aria-hidden="true" tabindex="-1"></a>      {node<span class="op">,</span></span>
<span id="cb170-3"><a href="#cb170-3" aria-hidden="true" tabindex="-1"></a>       <span class="dt">text</span><span class="op">:</span> text<span class="op">.</span><span class="fu">map</span>(cite <span class="kw">=&gt;</span> <span class="vs">`&lt;a href=&quot;../bib/#</span><span class="sc">${</span>cite<span class="sc">}</span><span class="vs">&quot;&gt;</span><span class="sc">${</span>cite<span class="sc">}</span><span class="vs">&lt;/a&gt;`</span>)}</span>
<span id="cb170-4"><a href="#cb170-4" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb170-5"><a href="#cb170-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// output:</span></span>
<span id="cb170-6"><a href="#cb170-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// - {node: &lt;a href=&quot;#b&quot;&gt;Moreau1896&lt;/a&gt;,</span></span>
<span id="cb170-7"><a href="#cb170-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">//    text: [&lt;a href=&quot;../bib/#Moreau1896&quot;Moreau1896&lt;/a&gt;]}</span></span>
<span id="cb170-8"><a href="#cb170-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// - {node: &lt;a href=&quot;#b&quot;&gt;Brundle1982, Brundle1984&lt;/a&gt;,</span></span>
<span id="cb170-9"><a href="#cb170-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">//    text: [&lt;a href=&quot;../bib/#Brundle1982&quot;&gt;Brundle1982&lt;/a&gt;,</span></span>
<span id="cb170-10"><a href="#cb170-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">//           &lt;a href=&quot;../bib/#Brundle1984&quot;&gt;Brundle1984&lt;/a&gt;]}</span></span></code></pre></div>
<p>All right, that’s not actually much of a relief, but it does make a strange kind of sense. First, if we have an object whose keys are called <code>a</code> and <code>b</code>, then the call <code>f({a, b})</code> means, “Match the value of key <code>a</code> to a parameter called <code>a</code> and the value of key <code>b</code> to a parameter called <code>b</code>.” This is called <a href="#g:destructuring"><strong>destructuring</strong></a>, and can save a lot of wear and tear on our keyboard and eyes.</p>
<p>Second, if we have a variable called <code>name</code>, then define an object with <code>{name}</code>, JavaScript helpfully assumes that what we mean is <code>{"name": name}</code>, i.e., that we want a key called <code>"name"</code> with whatever value <code>name</code> currently has. This allows us to pass the value of <code>node</code> from call to call in our pipeline without typing anything more than its name.</p>
<p>And after all of <em>this</em>, the <code>text.map</code> call actually <em>is</em> a relief. The value associated with the key <code>text</code> is an array of strings, each of which is a bibliography key. All the <code>map</code> does is convert each to the text we want: a link that refers to <code>../bib/#citation_key</code> and whose displayed text is also the citation key.</p>
<p>On to the next stage, which joins the string in <code>text</code> together to create a single string with commas between the entries and square brackets around the whole thing:</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(({node<span class="op">,</span> text}) <span class="kw">=&gt;</span> (</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>      {node<span class="op">,</span></span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>       <span class="dt">text</span><span class="op">:</span> <span class="vs">`[</span><span class="sc">${</span>text<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;, &#39;</span>)<span class="sc">}</span><span class="vs">]`</span>}</span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a>    ))</span></code></pre></div>
<p>(We haven’t shown the output in comments because typesetting it would overflow the page and because our pseudo-HTML notation gets really confusing once we’re showing strings containing HTML that contains strings.)</p>
<p>The last stage in our pipeline uses <code>forEach</code> instead of <code>map</code> because we want to do something for each element of the array, but don’t need a value returned (because what we’re doing has the side effect of modifying the document):</p>
<div class="sourceCode" id="cb172"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">forEach</span>(({node<span class="op">,</span> text}) <span class="kw">=&gt;</span> {</span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> span <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">createElement</span>(<span class="st">&#39;span&#39;</span>)</span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a>      span<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> text</span>
<span id="cb172-4"><a href="#cb172-4" aria-hidden="true" tabindex="-1"></a>      node<span class="op">.</span><span class="at">parentNode</span><span class="op">.</span><span class="fu">replaceChild</span>(span<span class="op">,</span> node)</span>
<span id="cb172-5"><a href="#cb172-5" aria-hidden="true" tabindex="-1"></a>    })</span></code></pre></div>
<p>This is the point at which carrying the node itself forward through the pipeline pays off. We create a <code>span</code> element, fill it in by assigning to its <code>innerHTML</code> property, and then replace the original link node with the node we have just created. If we now add an event listener after our function to call it when the page is loaded, we see our citations formatted as we desired.</p>
<h2 id="s:pages-clock">A Real-time Clock</h2>
<p>We will wrap up this lesson with an example that is short, but hints at the possibilities to come:</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>html<span class="op">&gt;</span></span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>head<span class="op">&gt;</span></span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>script<span class="op">&gt;</span></span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> startTime <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> today <span class="op">=</span> <span class="kw">new</span> <span class="bu">Date</span>()</span>
<span id="cb173-6"><a href="#cb173-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> fields <span class="op">=</span> [today<span class="op">.</span><span class="fu">getHours</span>()<span class="op">,</span></span>
<span id="cb173-7"><a href="#cb173-7" aria-hidden="true" tabindex="-1"></a>                        today<span class="op">.</span><span class="fu">getMinutes</span>()<span class="op">,</span></span>
<span id="cb173-8"><a href="#cb173-8" aria-hidden="true" tabindex="-1"></a>                        today<span class="op">.</span><span class="fu">getSeconds</span>()]</span>
<span id="cb173-9"><a href="#cb173-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> current <span class="op">=</span> fields</span>
<span id="cb173-10"><a href="#cb173-10" aria-hidden="true" tabindex="-1"></a>              <span class="op">.</span><span class="fu">map</span>(t <span class="kw">=&gt;</span> <span class="vs">`</span><span class="sc">${</span>t<span class="sc">}</span><span class="vs">`</span><span class="op">.</span><span class="fu">padStart</span>(<span class="dv">2</span><span class="op">,</span> <span class="st">&#39;0&#39;</span>))</span>
<span id="cb173-11"><a href="#cb173-11" aria-hidden="true" tabindex="-1"></a>              <span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;:&#39;</span>)</span>
<span id="cb173-12"><a href="#cb173-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;current&#39;</span>)<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> current</span>
<span id="cb173-13"><a href="#cb173-13" aria-hidden="true" tabindex="-1"></a>        <span class="pp">setTimeout</span>(startTime<span class="op">,</span> <span class="dv">1000</span>)</span>
<span id="cb173-14"><a href="#cb173-14" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb173-15"><a href="#cb173-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-16"><a href="#cb173-16" aria-hidden="true" tabindex="-1"></a>      <span class="bu">document</span><span class="op">.</span><span class="fu">addEventListener</span>(<span class="st">&quot;DOMContentLoaded&quot;</span><span class="op">,</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb173-17"><a href="#cb173-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">startTime</span>()</span>
<span id="cb173-18"><a href="#cb173-18" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb173-19"><a href="#cb173-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;/</span>script<span class="op">&gt;</span></span>
<span id="cb173-20"><a href="#cb173-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;/</span>head<span class="op">&gt;</span></span>
<span id="cb173-21"><a href="#cb173-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-22"><a href="#cb173-22" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>body<span class="op">&gt;</span></span>
<span id="cb173-23"><a href="#cb173-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>p id<span class="op">=</span><span class="st">&quot;current&quot;</span><span class="op">&gt;&lt;/</span>p<span class="op">&gt;</span></span>
<span id="cb173-24"><a href="#cb173-24" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;/</span>body<span class="op">&gt;</span></span>
<span id="cb173-25"><a href="#cb173-25" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span>html<span class="op">&gt;</span></span></code></pre></div>
<p>Defining a function: check. Calling that function when the DOM is ready: check. What about inside the function? It’s pretty easy to guess that <code>Date()</code> creates an object that holds a date, and from the fact that we’re assigning that object to a variable called <code>today</code>, you might even guess that if we don’t specify which date we want, we get today’s values. We then pull the hours, minutes, and seconds out of the date and put them in an array so that we can turn each value into a two-character string, padded with a leading zero if necessary, and then join those strings to create a time like <code>17:48:02</code> to stuff into the element whose ID is <code>current</code>.</p>
<p>But what does <code>setTimeout</code> do? It tells the browser to run a function after some number of milliseconds have passed. In this case, we’re running the same function <code>startTime</code> a second from now. That call will change the displayed time, then set up another callback to run a second later, and so on forever. When we load the page, we see the current time updating itself second by second to remind us just how quickly life is passing by.</p>
<h2 id="s:pages-exercises">Exercises</h2>
<h3 class="unnumbered" id="what-encoding-is-this">What Encoding Is This?</h3>
<ol>
<li><p>Write a function that looks up the character encoding of the page the script is in and prints it to the console.</p></li>
<li><p>Extend the function to look up all the <code>meta</code> tags in the current page and print their names and values.</p></li>
</ol>
<h3 class="unnumbered" id="word-count">Word Count</h3>
<ol>
<li><p>Write a function called <code>countWords</code> that finds all the text nodes in a page, splits them on whitespace, and returns the total number of words in the page.</p></li>
<li><p>Write a second function called <code>showWords</code> that uses the first to find the number of words, then displays that number in a paragraph whose ID is <code>wordcount</code>.</p></li>
</ol>
<h3 class="unnumbered" id="a-more-robust-table-of-contents">A More Robust Table of Contents</h3>
<ol>
<li><p>What does the table of contents example generate if an <code>h2</code> <em>doesn’t</em> have an <code>id</code> attribute?</p></li>
<li><p>Modify the example so that it only includes <code>h2</code> elements that have an <code>id</code> attribute in the table of contents.</p></li>
</ol>
<h3 class="unnumbered" id="explicitly-creating-nodes">Explicitly Creating Nodes</h3>
<p>Find documentation online for the two functions <code>document.createElement</code> and <code>document.createTextNode</code>, then rewrite the table of contents example to use these methods (and any others like them that you need) instead of assigning to a node’s <code>innerHTML</code> property.</p>
<h2 class="unnumbered" id="key-points-5">Key Points</h2>
<ul>
<li><p>Use a <code>meta</code> tag in a page’s header to specify the page’s character encoding.</p></li>
<li><p>Pages are represented in memory using a Document Object Model (DOM).</p></li>
<li><p>The <code>document</code> object represents the page a script is in.</p></li>
<li><p>Use the <code>querySelectorAll</code> method to find DOM nodes that match a condition.</p></li>
<li><p>Assign HTML text to a node’s <code>innerHTML</code> property to change the node’s content.</p></li>
<li><p>Use <code>((params) =&gt; {...})(arguments)</code> to create and call a function in a single step.</p></li>
<li><p>An event listener is a function run by the browser when some specific event occurs.</p></li>
<li><p>Create an event listener for <code>’DOMContentLoaded’</code> to trigger execution of scripts <em>after</em> the DOM has been constructed.</p></li>
<li><p>Check the <code>nodeType</code> or <code>nodeName</code> property of a DOM node to find out what kind of node it is.</p></li>
<li><p>Destructuring assignment allows us to assign to multiple variables by name in a single statement.</p></li>
<li><p>Use <code>setTimeout</code> to trigger execution of a function after a delay.</p></li>
<li><p>To make something run forever, have the function called by <code>setTimeout</code> set another timeout of the same function.</p></li>
</ul>
<h1 id="s:dynamic">Dynamic Pages</h1>
<p>In the beginning, people created HTML pages by typing them in (just as we have been doing). They quickly realized that a lot of pages share a lot of content: navigation menus, contact info, and so on. The nearly universal response was to create a <a href="#g:template"><strong>template</strong></a> and embed commands to include other snippets of HTML (like headers) and loop over data structures to create lists and tables. This is called <a href="#g:server-page-gen"><strong>server-side page generation</strong></a>: the HTML is generated on the <a href="#g:server"><strong>server</strong></a>, and it was popular because that’s where the data was, and that was the only place complex code could be run. (This tutorial uses a templating tool called <a href="https://jekyllrb.com/">Jekyll</a>. It’s clumsy and limited, but it’s the default on <a href="http://github.com/">GitHub</a>.)</p>
<p>Server-side generation can be done statically or dynamically, i.e., pages can be compiled once, stored on disk, and served thereafter, or each page can be recompiled whenever it’s needed, which makes it easy to include dynamic elements like today’s top news story (Figure <a href="#f:dynamic-alternatives" data-reference-type="ref" data-reference="f:dynamic-alternatives">7.1</a>).</p>
<figure>
<img src="figures/dynamic-alternatives.svg" id="f:dynamic-alternatives" /><figcaption aria-hidden="true"><span>Page Generation Alternatives</span><span id="f:dynamic-alternatives" label="f:dynamic-alternatives">[f:dynamic-alternatives]</span></figcaption>
</figure>
<p>As browsers and JavaScript became more powerful, the balance shifted toward <a href="#g:client-page-gen"><strong>client-side page generation</strong></a>. In this model, the browser fetches data from one or more servers and feeds that data to a JavaScript library that generates HTML in the browser for display. This allows the <a href="#g:client"><strong>client</strong></a> to decide how best to render data, which is increasingly important as phones and tablets take over from desktop and laptop computers. It also moves the computational burden off the server and onto the client device, which lowers the cost of providing data.</p>
<p>Many (many) JavaScript frameworks for client-side page generation have been created, and more are probably being developed right now. We have chosen <a href="https://reactjs.org/">React</a> because it is freely available, widely used, well documented, simpler than many alternatives, and has a cool logo. Its central design principles are:</p>
<ol>
<li><p>Page creators use functions to describe the HTML they want.</p></li>
<li><p>They then let React decide which functions to run when data changes.</p></li>
</ol>
<p>We will show how to use it in pure JavaScript, then introduce a tool called JSX that simplifies things.</p>
<h2 id="s:dynamic-hello">Hello, World</h2>
<p>Let’s begin by saying hello:</p>
<div class="sourceCode" id="cb174"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb174-1"><a href="#cb174-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!</span>DOCTYPE html<span class="op">&gt;</span></span>
<span id="cb174-2"><a href="#cb174-2" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb174-3"><a href="#cb174-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb174-4"><a href="#cb174-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;meta</span> <span class="ot">charset</span><span class="op">=</span><span class="st">&quot;utf-8&quot;</span><span class="kw">&gt;</span></span>
<span id="cb174-5"><a href="#cb174-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;title&gt;</span>Hello React<span class="kw">&lt;/title&gt;</span></span>
<span id="cb174-6"><a href="#cb174-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="ot">src</span><span class="op">=</span><span class="st">&quot;https://fb.me/react-15.0.1.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb174-7"><a href="#cb174-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="ot">src</span><span class="op">=</span><span class="st">&quot;https://fb.me/react-dom-15.0.1.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb174-8"><a href="#cb174-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb174-9"><a href="#cb174-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb174-10"><a href="#cb174-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;div</span> <span class="ot">id</span><span class="op">=</span><span class="st">&quot;app&quot;</span><span class="kw">&gt;</span></span>
<span id="cb174-11"><a href="#cb174-11" aria-hidden="true" tabindex="-1"></a>      <span class="er">&lt;</span>!-- this is filled in --&gt;</span>
<span id="cb174-12"><a href="#cb174-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/div&gt;</span></span>
<span id="cb174-13"><a href="#cb174-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script&gt;</span></span>
<span id="cb174-14"><a href="#cb174-14" aria-hidden="true" tabindex="-1"></a>      ReactDOM.render(</span>
<span id="cb174-15"><a href="#cb174-15" aria-hidden="true" tabindex="-1"></a>        React.DOM.h1(null, &quot;Hello React&quot;),</span>
<span id="cb174-16"><a href="#cb174-16" aria-hidden="true" tabindex="-1"></a>        document.getElementById(&quot;app&quot;)</span>
<span id="cb174-17"><a href="#cb174-17" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb174-18"><a href="#cb174-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/script&gt;</span></span>
<span id="cb174-19"><a href="#cb174-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb174-20"><a href="#cb174-20" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>The <code>head</code> of the page loads two React libraries from the web; we will use locally-installed libraries later. The <code>body</code> contains a <code>div</code> with an ID to make it findable. When our script runs, React will put the HTML it generates into this <code>div</code>.</p>
<p>The script itself creates an <code>h1</code> with the text “Hello, React” using <code>React.DOM.h1</code>, then finds the document element whose ID is <code>"app"</code> and uses <code>ReactDOM.render</code> to insert the former into the latter. This alters the representation of the page in memory, not the source of the page on disk; if we want to inspect the resulting HTML, we have to do so in the browser. Finally, we put the script at the bottom of the page so that the browser will have turned the HTML into a DOM tree in memory before the script runs. We will come back and fix this later.</p>
<blockquote>
<h4 id="inspection-tools" class="unnumbered">Inspection Tools</h4>
<p>If you are using the Firefox browser, you can open the developer tools pane by going to the main menu and selecting <code>Tools… Web Developer… Toggle Tools</code>. A tabbed display will open in the bottom of your page; choose <code>Inspector</code> to view the content of your page and page’s CSS. As you move your mouse around the page itself, corresponding structural elements will be highlighted. It’s actually pretty cool<span>…</span></p>
</blockquote>
<p>The first parameter to <code>React.DOM.h1</code> is <code>null</code> in the example above, but it can more generally be an object that specifies the attributes we want the newly-created node to have. There are a few quirks in this—for example, we have to use <code>fontStyle</code> rather than <code>font-style</code> so that the attribute object’s keys look like legal JavaScript variables—but the mechanism is seductively easy to use:</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;div</span> <span class="ot">id</span><span class="op">=</span><span class="st">&quot;app&quot;</span><span class="kw">&gt;&lt;/div&gt;</span></span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script&gt;</span></span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a>      const attributes = <span class="va">{</span></span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;style&#39;</span><span class="op">:</span> {</span>
<span id="cb175-6"><a href="#cb175-6" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;background&#39;</span><span class="op">:</span> <span class="st">&#39;pink&#39;</span><span class="op">,</span></span>
<span id="cb175-7"><a href="#cb175-7" aria-hidden="true" tabindex="-1"></a>          <span class="st">&#39;fontStyle&#39;</span><span class="op">:</span> <span class="st">&#39;italic&#39;</span></span>
<span id="cb175-8"><a href="#cb175-8" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb175-9"><a href="#cb175-9" aria-hidden="true" tabindex="-1"></a>      <span class="va">}</span></span>
<span id="cb175-10"><a href="#cb175-10" aria-hidden="true" tabindex="-1"></a>      ReactDOM.render(</span>
<span id="cb175-11"><a href="#cb175-11" aria-hidden="true" tabindex="-1"></a>        React.DOM.h1(attributes, &quot;Hello Stylish&quot;),</span>
<span id="cb175-12"><a href="#cb175-12" aria-hidden="true" tabindex="-1"></a>        document.getElementById(&quot;app&quot;)</span>
<span id="cb175-13"><a href="#cb175-13" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb175-14"><a href="#cb175-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/script&gt;</span></span>
<span id="cb175-15"><a href="#cb175-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span></code></pre></div>
<h2 id="s:dynamic-jsx">JSX</h2>
<p>Writing nested functions is a clumsy way to write HTML, so most React programmers use a tool called <a href="https://reactjs.org/docs/introducing-jsx.html">JSX</a> that translates HTML into JavaScript function calls. And yes, those JavaScript function calls then produce HTML—it’s a funny world. Here’s an example:</p>
<div class="sourceCode" id="cb176"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!</span>DOCTYPE html<span class="op">&gt;</span></span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;meta</span> <span class="ot">charset</span><span class="op">=</span><span class="st">&quot;utf-8&quot;</span><span class="kw">&gt;</span></span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;title&gt;</span>Hello JSX<span class="kw">&lt;/title&gt;</span></span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="ot">src</span><span class="op">=</span><span class="st">&quot;https://fb.me/react-15.0.1.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="ot">src</span><span class="op">=</span><span class="st">&quot;https://fb.me/react-dom-15.0.1.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="ot">src</span><span class="op">=</span><span class="st">&quot;https://unpkg.com/babel-standalone@6/babel.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb176-10"><a href="#cb176-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb176-11"><a href="#cb176-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;div</span> <span class="ot">id</span><span class="op">=</span><span class="st">&quot;app&quot;</span><span class="kw">&gt;&lt;/div&gt;</span></span>
<span id="cb176-12"><a href="#cb176-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="ot">type</span><span class="op">=</span><span class="st">&quot;text/babel&quot;</span><span class="kw">&gt;</span></span>
<span id="cb176-13"><a href="#cb176-13" aria-hidden="true" tabindex="-1"></a>      ReactDOM.render(</span>
<span id="cb176-14"><a href="#cb176-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;h1&gt;</span>Hello JSX<span class="kw">&lt;/h1&gt;</span>,</span>
<span id="cb176-15"><a href="#cb176-15" aria-hidden="true" tabindex="-1"></a>        document.getElementById(&#39;app&#39;)</span>
<span id="cb176-16"><a href="#cb176-16" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb176-17"><a href="#cb176-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/script&gt;</span></span>
<span id="cb176-18"><a href="#cb176-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb176-19"><a href="#cb176-19" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>Along with the two React libraries, this page includes a tool called <a href="https://babeljs.io/">Babel</a> to translate a mix of HTML and JavaScript into pure JavaScript. To trigger translation, we add the attribute <code>type="text/babel"</code> to the <code>script</code> tag.</p>
<p>Why bother? Because as the example above shows, it allows us to write <code>&lt;h1&gt;Hello JSX&lt;/h1&gt;</code> instead of calling a function. More generally, JSX lets us put JavaScript inside our HTML (inside our JavaScript (inside our HTML)), so we can (for example) use <code>map</code> to turn a list of strings into an HTML list:</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;h1&gt;</span>JSX List<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;div</span> <span class="ot">id</span><span class="op">=</span><span class="st">&quot;app&quot;</span><span class="kw">&gt;&lt;/div&gt;</span></span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="ot">type</span><span class="op">=</span><span class="st">&quot;text/babel&quot;</span><span class="kw">&gt;</span></span>
<span id="cb177-5"><a href="#cb177-5" aria-hidden="true" tabindex="-1"></a>      const allNames = [&#39;McNulty&#39;, &#39;Jennings&#39;, &#39;Snyder&#39;,</span>
<span id="cb177-6"><a href="#cb177-6" aria-hidden="true" tabindex="-1"></a>                        &#39;Meltzer&#39;, &#39;Bilas&#39;, &#39;Lichterman&#39;]</span>
<span id="cb177-7"><a href="#cb177-7" aria-hidden="true" tabindex="-1"></a>      ReactDOM.render(</span>
<span id="cb177-8"><a href="#cb177-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;ul&gt;</span><span class="va">{</span>allNames<span class="op">.</span><span class="fu">map</span>((name) <span class="kw">=&gt; &lt;li&gt;</span><span class="va">{</span>name<span class="va">}</span><span class="kw">&lt;/li&gt;</span> )<span class="va">}</span><span class="kw">&lt;/ul&gt;</span>,</span>
<span id="cb177-9"><a href="#cb177-9" aria-hidden="true" tabindex="-1"></a>        document.getElementById(&#39;app&#39;)</span>
<span id="cb177-10"><a href="#cb177-10" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb177-11"><a href="#cb177-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/script&gt;</span></span>
<span id="cb177-12"><a href="#cb177-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span></code></pre></div>
<p>We have to use <code>map</code> rather than a loop because whatever code we run has to return something that can be inserted into the DOM, and <code>for</code> loops don’t return anything. (We could use a loop to build up a string through repeated concatenation, but <code>map</code> is cleaner.) And note: we must return exactly one node, because this is one function call. We will look in the exercises at why the curly braces immediately inside the <code>&lt;ul&gt;</code> element are necessary.</p>
<p>Note also that when we run this, the browser console will warn us that each list element ought to have a unique <code>key</code> property, because React wants each element of the page to be selectable. We will add this later.</p>
<h2 id="s:dynamic-components">Creating Components</h2>
<p>One of the most powerful features of React is that it lets us create new <a href="#g:component"><strong>components</strong></a> that look like custom HTML tags, but are associated with functions that we write. React requires the names of these components to start with a capital letter to differentiate them from regular tags. We can, for example, define a function <code>ListOfNames</code> to generate our list of names, then put that element directly in <code>ReactDOM.Render</code> just as we would put an <code>h1</code> or <code>p</code>:</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;h1&gt;</span>Create Component<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;div</span> <span class="ot">id</span><span class="op">=</span><span class="st">&quot;app&quot;</span><span class="kw">&gt;&lt;/div&gt;</span></span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="ot">type</span><span class="op">=</span><span class="st">&quot;text/babel&quot;</span><span class="kw">&gt;</span></span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a>      const allNames = [&#39;McNulty&#39;, &#39;Jennings&#39;, &#39;Snyder&#39;,</span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a>                        &#39;Meltzer&#39;, &#39;Bilas&#39;, &#39;Lichterman&#39;]</span>
<span id="cb178-7"><a href="#cb178-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-8"><a href="#cb178-8" aria-hidden="true" tabindex="-1"></a>      const ListOfNames = () =&gt; <span class="va">{</span></span>
<span id="cb178-9"><a href="#cb178-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (<span class="kw">&lt;ul&gt;</span><span class="va">{</span>allNames<span class="op">.</span><span class="fu">map</span>((name) <span class="kw">=&gt; &lt;li&gt;</span><span class="va">{</span>name<span class="va">}</span><span class="kw">&lt;/li&gt;</span> )<span class="va">}</span><span class="kw">&lt;/ul&gt;</span>)</span>
<span id="cb178-10"><a href="#cb178-10" aria-hidden="true" tabindex="-1"></a>      <span class="va">}</span></span>
<span id="cb178-11"><a href="#cb178-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-12"><a href="#cb178-12" aria-hidden="true" tabindex="-1"></a>      ReactDOM.render(</span>
<span id="cb178-13"><a href="#cb178-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">&lt;ListOfNames</span> <span class="fu">/&gt;</span>,</span>
<span id="cb178-14"><a href="#cb178-14" aria-hidden="true" tabindex="-1"></a>        document.getElementById(&#39;app&#39;)</span>
<span id="cb178-15"><a href="#cb178-15" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb178-16"><a href="#cb178-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/script&gt;</span></span>
<span id="cb178-17"><a href="#cb178-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span></code></pre></div>
<p>What we really want to do, though, is pass parameters to these components: after all, JSX is turning them into functions, and functions are far more useful when we can give them data. In React, all the attributes we put inside the component’s tag are passed to our function in a single <code>props</code> object:</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;h1&gt;</span>Pass Parameters<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;div</span> <span class="ot">id</span><span class="op">=</span><span class="st">&quot;app&quot;</span><span class="kw">&gt;&lt;/div&gt;</span></span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="ot">type</span><span class="op">=</span><span class="st">&quot;text/babel&quot;</span><span class="kw">&gt;</span></span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>      const allNames = [&#39;McNulty&#39;, &#39;Jennings&#39;, &#39;Snyder&#39;,</span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a>                        &#39;Meltzer&#39;, &#39;Bilas&#39;, &#39;Lichterman&#39;]</span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-8"><a href="#cb179-8" aria-hidden="true" tabindex="-1"></a>      const ListElement = (props) =&gt;</span>
<span id="cb179-9"><a href="#cb179-9" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">&lt;li</span> <span class="ot">id</span><span class="op">=</span><span class="va">{</span>props<span class="op">.</span><span class="at">name</span><span class="va">}</span><span class="kw">&gt;&lt;em&gt;</span><span class="va">{</span>props<span class="op">.</span><span class="at">name</span><span class="va">}</span><span class="kw">&lt;/em&gt;&lt;/li&gt;</span>)</span>
<span id="cb179-10"><a href="#cb179-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-11"><a href="#cb179-11" aria-hidden="true" tabindex="-1"></a>      ReactDOM.render(</span>
<span id="cb179-12"><a href="#cb179-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;ul&gt;</span><span class="va">{</span>allNames<span class="op">.</span><span class="fu">map</span>((name) <span class="kw">=&gt; </span><span class="fu">&lt;ListElement</span> <span class="ot">name</span><span class="op">=</span><span class="va">{</span>name<span class="va">}</span> <span class="fu">/&gt;</span> )<span class="va">}</span><span class="kw">&lt;/ul&gt;</span>,</span>
<span id="cb179-13"><a href="#cb179-13" aria-hidden="true" tabindex="-1"></a>        document.getElementById(&#39;app&#39;)</span>
<span id="cb179-14"><a href="#cb179-14" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb179-15"><a href="#cb179-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/script&gt;</span></span>
<span id="cb179-16"><a href="#cb179-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span></code></pre></div>
<p>If you look carefully, you’ll see that the <code>name</code> attribute passed to the use of <code>ListElement</code> becomes the value of <code>prop.names</code> inside the function that implements <code>ListElement</code>.</p>
<p>Before we <code>map</code> each component of our array within <code>ReactDOM.render</code> as in the examples above, the <code>ListElement</code> function gives us exactly one logical place to set attributes. Here we’ve used <code>ListElement</code> to italicize each element in our array and give them ids, but these functions can also be used for any transformation or calculation on each element to be rendered.</p>
<h2 id="s:dynamic-parcel">Developing with Parcel</h2>
<p>Putting all of the source for an application in one HTML file is a bad practice, but we’ve already seen the race conditions that can arise when we load JavaScript in a page’s header. And what about <code>require</code> statements? The browser will try to load the required files when those statements run, but who is going to serve them?</p>
<p>The solution is to use a <a href="#g:bundler"><strong>bundler</strong></a> (Figure <a href="#f:dynamic-parcel" data-reference-type="ref" data-reference="f:dynamic-parcel">7.2</a>) to combine everything into one big file, and to run a <a href="#g:local-server"><strong>local server</strong></a> to preview our application during development. However, this solution brings with it another problem: which bundler to choose? As with front-end frameworks, there are many to choose from, and new ones are being added almost weekly. <a href="https://webpack.js.org/">Webpack</a> is probably the most widely used, but it is rather complex, so we will use <a href="https://parceljs.org/">Parcel</a>, which is younger and therefore not yet bloated (but give it time).</p>
<blockquote>
<h4 id="initiate-a-project-with-node-package-manager" class="unnumbered">Initiate a Project with Node Package Manager</h4>
<p>If you’ve been coding along, so far we’ve created single HTML and JavaScript files, and we’ve used the Node command to run JavaScript files in the terminal, but we have not yet used the Node Package Manager <code>npm</code>. Before we install Parcel, we can turn the directory which we’ve been creating our HTML and JavaScript files into a project by typing:</p>
<pre class="shell"><code>$ npm init -y</code></pre>
</blockquote>
<p>To install Parcel, run:</p>
<pre class="shell"><code>$ npm install parcel-bundler</code></pre>
<p>Once Parcel is installed, we can tell it to run one of our test pages like this:</p>
<pre class="shell"><code>$ node_modules/.bin/parcel serve -p 4000 src/dynamic/pass-params.html</code></pre>
<pre class="text"><code>Server running at http://localhost:4000
+ Built in 128ms.</code></pre>
<blockquote>
<h4 id="quitting-parcel" class="unnumbered">Quitting Parcel</h4>
<p>To leave Parcel use the keyboard interrupt Control-C.</p>
</blockquote>
<p>This works because when NPM installs a library in a project’s <code>node_modules</code> directory, that library may put a runnable script in <code>node_modules/.bin</code> (note that it’s <code>.bin</code> with a leading <code>.</code>, not <code>bin</code>). When we ask Parcel to serve an application, it:</p>
<ul>
<li><p>looks in the named file to find JavaScript,</p></li>
<li><p>looks recursively at what that file loads,</p></li>
<li><p>copies some files into a directory called <code>./dist</code> (which stands for “distribution”), and</p></li>
<li><p>serves the application out of there.</p></li>
</ul>
<p>Parcel also caches things in <code>./.cache</code> so that it doesn’t need to do redundant work; both directories are normally added to <code>.gitignore</code>. To learn more about Parcel, see <a href="https://medium.com/codingthesmartway-com-blog/getting-started-with-parcel-197eb85a2c8c">this short tutorial</a>.</p>
<figure>
<img src="figures/dynamic-parcel.svg" id="f:dynamic-parcel" /><figcaption aria-hidden="true"><span>What Goes Where with Parcel</span><span id="f:dynamic-parcel" label="f:dynamic-parcel">[f:dynamic-parcel]</span></figcaption>
</figure>
<p>It’s very common to put tasks like “run my application” into NPM’s <code>package.json</code> file, just as older programmers would put frequently-used commands into a project’s Makefile. Look for the section in <code>package.json</code> whose key is <code>"scripts"</code> and add this:</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;scripts&quot;</span><span class="op">:</span> {</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;dev&quot;</span><span class="op">:</span> <span class="st">&quot;parcel serve -p 4000&quot;</span><span class="op">,</span></span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb184-4"><a href="#cb184-4" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span></code></pre></div>
<p>We can now use <code>npm run dev -- src/dynamic/pass-params.html</code>, since everything after <code>--</code> is passed to the script being run. This doesn’t just save us typing; it also gives other developers a record of how to use the project. Unfortunately, there is no standard way to add comments to a JSON file<span>…</span></p>
<blockquote>
<h4 id="whoops" class="unnumbered">Whoops</h4>
<p>Note: if we accidentally specify the name of a directory like <code>src/dynamic</code> instead of the name of an HTML file, Parcel prints an error on the console saying “no entries found”. This happens because it is trying to read the directory itself as a file.</p>
</blockquote>
<h2 id="s:dynamic-multiple">Multiple Files</h2>
<p>Now that we can bundle things up, let’s move our JSX into <code>app.js</code> and load that in the <code>head</code> of the page:</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!</span>DOCTYPE html<span class="op">&gt;</span></span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;meta</span> <span class="ot">charset</span><span class="op">=</span><span class="st">&quot;utf-8&quot;</span><span class="kw">&gt;</span></span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;title&gt;</span>Hello Separate<span class="kw">&lt;/title&gt;</span></span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="ot">src</span><span class="op">=</span><span class="st">&quot;https://fb.me/react-15.0.1.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb185-7"><a href="#cb185-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="ot">src</span><span class="op">=</span><span class="st">&quot;https://fb.me/react-dom-15.0.1.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb185-8"><a href="#cb185-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="ot">src</span><span class="op">=</span><span class="st">&quot;https://unpkg.com/babel-standalone@6/babel.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb185-9"><a href="#cb185-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="ot">src</span><span class="op">=</span><span class="st">&quot;app.js&quot;</span> <span class="ot">type</span><span class="op">=</span><span class="st">&quot;text/babel&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb185-10"><a href="#cb185-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb185-11"><a href="#cb185-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb185-12"><a href="#cb185-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;h1&gt;</span>Hello Separate<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb185-13"><a href="#cb185-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;div</span> <span class="ot">id</span><span class="op">=</span><span class="st">&quot;app&quot;</span><span class="kw">&gt;&lt;/div&gt;</span></span>
<span id="cb185-14"><a href="#cb185-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb185-15"><a href="#cb185-15" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>For now, the JavaScript in <code>app.js</code> is:</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>ReactDOM<span class="op">.</span><span class="fu">render</span>(</span>
<span id="cb186-2"><a href="#cb186-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>p<span class="op">&gt;</span>Rendered by React<span class="op">&lt;/</span>p<span class="op">&gt;,</span></span>
<span id="cb186-3"><a href="#cb186-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&quot;app&quot;</span>)</span>
<span id="cb186-4"><a href="#cb186-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>When we load this page we get the <code>h1</code> title but <em>not</em> the paragraph. The browser console displays the message:</p>
<pre class="text"><code>Error: _registerComponent(...): Target container is not a DOM element.</code></pre>
<p>This is the same race condition that has bitten us before. After sighing in frustration and making another cup of tea, we decide that to keep things simple we will load the script in the body of the page:</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!</span>DOCTYPE html<span class="op">&gt;</span></span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>html<span class="op">&gt;</span></span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>head<span class="op">&gt;</span></span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>meta charset<span class="op">=</span><span class="st">&quot;utf-8&quot;</span><span class="op">&gt;</span></span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>title<span class="op">&gt;</span>Hello Bottom<span class="op">&lt;/</span>title<span class="op">&gt;</span></span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;/</span>head<span class="op">&gt;</span></span>
<span id="cb188-7"><a href="#cb188-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>body<span class="op">&gt;</span></span>
<span id="cb188-8"><a href="#cb188-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>h1<span class="op">&gt;</span>Hello Bottom<span class="op">&lt;/</span>h1<span class="op">&gt;</span></span>
<span id="cb188-9"><a href="#cb188-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>div id<span class="op">=</span><span class="st">&quot;app&quot;</span><span class="op">&gt;&lt;/</span>div<span class="op">&gt;</span></span>
<span id="cb188-10"><a href="#cb188-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;</span>script src<span class="op">=</span><span class="st">&quot;./app.js&quot;</span> type<span class="op">=</span><span class="st">&quot;text/babel&quot;</span><span class="op">&gt;&lt;/</span>script<span class="op">&gt;</span></span>
<span id="cb188-11"><a href="#cb188-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;/</span>body<span class="op">&gt;</span></span>
<span id="cb188-12"><a href="#cb188-12" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;/</span>html<span class="op">&gt;</span></span></code></pre></div>
<blockquote>
<h4 id="installing-react-and-reactdom" class="unnumbered">Installing React and ReactDOM</h4>
<p>Now that we have made a project folder using <code>npm init</code> and have created a <code>project.json</code> file, we can install our first modules:</p>
<pre class="shell"><code>$ npm install react
$ npm install react-dom</code></pre>
<p>In general, uses of the function <code>require</code> indicate that we need to install that library to access the module’s functions.</p>
</blockquote>
<p>More importantly, we will rewrite <code>app.js</code> so that it loads the libraries it needs, because there’s no guarantee that libraries loaded in <code>head</code> will be available when <code>app.js</code> runs:</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> React <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;react&#39;</span>)</span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> ReactDOM <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;react-dom&#39;</span>)</span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a>ReactDOM<span class="op">.</span><span class="fu">render</span>(</span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>p<span class="op">&gt;</span>Rendered by React<span class="op">&lt;/</span>p<span class="op">&gt;,</span></span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;app&#39;</span>)</span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>We don’t have to shut down the server and restart it every time we make changes like this, because Parcel watches for changes in files and relaunches itself as needed. Each time it does so, it looks at the libraries <code>app.js</code> loads and rebundles what it needs: right now, for example, <code>dist/app.ef6b320b.js</code> is 19930 lines long.</p>
<p>A more modern option than loading in the bottom is to add the <code>async</code> attribute to the script in the head of the page, which tells the browser not to do anything with the JavaScript until the page has finished building:</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;!</span>DOCTYPE html<span class="op">&gt;</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;meta</span> <span class="ot">charset</span><span class="op">=</span><span class="st">&quot;utf-8&quot;</span><span class="kw">&gt;</span></span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;title&gt;</span>Hello Parcel<span class="kw">&lt;/title&gt;</span></span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="ot">src</span><span class="op">=</span><span class="st">&quot;./app.js&quot;</span> <span class="ot">type</span><span class="op">=</span><span class="st">&quot;text/babel&quot;</span> <span class="ot">async</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;div</span> <span class="ot">id</span><span class="op">=</span><span class="st">&quot;app&quot;</span><span class="kw">&gt;&lt;/div&gt;</span></span>
<span id="cb191-10"><a href="#cb191-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb191-11"><a href="#cb191-11" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<h2 id="s:dynamic-exercises">Exercises</h2>
<h3 class="unnumbered" id="those-damn-curly-braces">Those Damn Curly Braces</h3>
<p>Our list-building example includes this line of code:</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;ul&gt;</span><span class="va">{</span>allNames<span class="op">.</span><span class="fu">map</span>((name) <span class="kw">=&gt; &lt;li&gt;</span><span class="va">{</span>name<span class="va">}</span><span class="kw">&lt;/li&gt;</span> )<span class="va">}</span><span class="kw">&lt;/ul&gt;</span><span class="op">,</span></span></code></pre></div>
<p>Why are the curly braces immediately inside the <code>&lt;ul&gt;</code> element necessary? What happens if you take them out?</p>
<h3 class="unnumbered" id="real-data">Real Data</h3>
<ol>
<li><p>Create a file called <code>programmers.js</code> that defines a list of JSON objects called <code>programmers</code> with <code>firstName</code> and <code>lastName</code> fields for our programmers. (You can search the Internet to find their names.)</p></li>
<li><p>Load that file in your page like any other JavaScript file.</p></li>
<li><p>Delete the list <code>allNames</code> from the application and modify it to use data from the list <code>programmers</code> instead.</p></li>
</ol>
<p>Loading constant data like this is a common practice during testing.</p>
<h3 class="unnumbered" id="ordering">Ordering</h3>
<p>What happens if you change the order in which the JavaScript files are loaded in your web page? For example, what happens if you load <code>app.js</code> <em>before</em> you load <code>ListElement.js</code>?</p>
<h3 class="unnumbered" id="multiple-targets">Multiple Targets</h3>
<p>What happens if your HTML page contains two <code>div</code> elements with <code>id="app"</code>?</p>
<h3 class="unnumbered" id="creating-a-component-for-names">Creating a Component for Names</h3>
<p>Create a new React component that renders a name, and modify the example to use it instead of always displaying names in <code>&lt;li&gt;</code> elements.</p>
<h3 class="unnumbered" id="striping">Striping</h3>
<p>Suppose we want to render every second list element in italics. (This would be a horrible design, but once we start creating tables, we might want to highlight alternate rows in different background colors to make it easier to read.) Modify the application so that even-numbered list elements are <code>&lt;li&gt;{name}&lt;/li&gt;</code> and odd-numbered list elements are <code>&lt;li&gt;&lt;em&gt;{name}&lt;/em&gt;&lt;/li&gt;</code>. (Hint: use the fact that a <code>map</code> callback can have two parameters instead of one.)</p>
<h2 class="unnumbered" id="key-points-6">Key Points</h2>
<ul>
<li><p>Older dynamic web sites generated pages on the server.</p></li>
<li><p>Newer dynamic web sites generate pages in the client.</p></li>
<li><p>React is a JavaScript library for client-side page generation that represents HTML elements as function calls.</p></li>
<li><p>React replaces page elements with dynamically-generated content in memory (not on disk).</p></li>
<li><p>React functions can be customized with elements.</p></li>
<li><p>JSX translates HTML into React function calls so that HTML and JavaScript can be mixed freely.</p></li>
<li><p>Use Babel to translate JSX into JavaScript in the browser.</p></li>
<li><p>Define new React components with a pseudo-HTML element and a corresponding function.</p></li>
<li><p>Attributes to pseudo-HTML are passed to the JavaScript function as a <code>props</code> object.</p></li>
</ul>
<h1 id="s:vis">Visualizing Data</h1>
<p>Tables and lists are great, but visualizations are often more effective—if they’re well designed and your audience is sighted, that is. There are even more ways to visualize data in the browser than there are front-end toolkits for JavaScript. We have chosen to use <a href="http://vega.github.io/">Vega-Lite</a>, which is a <a href="#g:declarative"><strong>declarative</strong></a> framework: as a user, you specify the data and settings, and let the library take care of everything else. It doesn’t do everything, but it does common things well and easily, and it interacts nicely with React.</p>
<h2 id="s:vis-vega-lite">Vega-Lite</h2>
<p>Let’s start by creating a skeleton web page to hold our visualization. For now, we will load Vega, Vega-Lite, and Vega-Embed from the web; we’ll worry about local installation later. We will create a <code>div</code> to be filled in by the visualization—we don’t have to give it the ID <code>vis</code>, but it’s common to do so—and we will leave space for the script. Our skeleton looks like this (with lines broken for the benefit of the printed version):</p>
<div class="sourceCode" id="cb193"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;head&gt;</span></span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;title&gt;</span>Embedding Vega-Lite<span class="kw">&lt;/title&gt;</span></span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;script</span> <span class="er">src</span><span class="ot">=</span><span class="st">&quot;https://cdn.jsdelivr.net/npm/vega@5&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb193-6"><a href="#cb193-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;script</span> <span class="er">src</span><span class="ot">=</span><span class="st">&quot;https://cdn.jsdelivr.net/npm/vega-lite@3&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb193-7"><a href="#cb193-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;script</span> <span class="er">src</span><span class="ot">=</span><span class="st">&quot;https://cdn.jsdelivr.net/npm/vega-embed@4&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb193-8"><a href="#cb193-8" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/head&gt;</span></span>
<span id="cb193-9"><a href="#cb193-9" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;body&gt;</span></span>
<span id="cb193-10"><a href="#cb193-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-11"><a href="#cb193-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;div</span> <span class="er">id</span><span class="ot">=</span><span class="st">&quot;vis&quot;</span><span class="kw">&gt;&lt;/div&gt;</span></span>
<span id="cb193-12"><a href="#cb193-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-13"><a href="#cb193-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">&quot;text/javascript&quot;</span><span class="kw">&gt;</span></span>
<span id="cb193-14"><a href="#cb193-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/script&gt;</span></span>
<span id="cb193-15"><a href="#cb193-15" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/body&gt;</span></span>
<span id="cb193-16"><a href="#cb193-16" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>We can now start filling in the script with the beginning of a visualization specification. This is a blob of <a href="#g:json"><strong>JSON</strong></a> with certain required fields:</p>
<ul>
<li><p><code>$schema</code> identifies the version of the spec being used (as a URL).</p></li>
<li><p><code>description</code> is a comment to remind us what we thought we were doing when we created this.</p></li>
<li><p><code>data</code> is the actual data.</p></li>
</ul>
<div class="sourceCode" id="cb194"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>...rest of page as before...</span>
<span id="cb194-2"><a href="#cb194-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">&quot;text/javascript&quot;</span><span class="kw">&gt;</span></span>
<span id="cb194-3"><a href="#cb194-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> spec <span class="op">=</span> {</span>
<span id="cb194-4"><a href="#cb194-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;$schema&quot;</span><span class="op">:</span> <span class="st">&quot;https://vega.github.io/schema/vega-lite/v2.0.json&quot;</span><span class="op">,</span></span>
<span id="cb194-5"><a href="#cb194-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;description&quot;</span><span class="op">:</span> <span class="st">&quot;Create data array but do not display anything.&quot;</span><span class="op">,</span></span>
<span id="cb194-6"><a href="#cb194-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;data&quot;</span><span class="op">:</span> {</span>
<span id="cb194-7"><a href="#cb194-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;values&quot;</span><span class="op">:</span> [</span>
<span id="cb194-8"><a href="#cb194-8" aria-hidden="true" tabindex="-1"></a>          {<span class="st">&quot;a&quot;</span><span class="op">:</span> <span class="st">&quot;A&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">:</span> <span class="dv">28</span>}<span class="op">,</span></span>
<span id="cb194-9"><a href="#cb194-9" aria-hidden="true" tabindex="-1"></a>          {<span class="st">&quot;a&quot;</span><span class="op">:</span> <span class="st">&quot;B&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">:</span> <span class="dv">55</span>}<span class="op">,</span></span>
<span id="cb194-10"><a href="#cb194-10" aria-hidden="true" tabindex="-1"></a>          {<span class="st">&quot;a&quot;</span><span class="op">:</span> <span class="st">&quot;C&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">:</span> <span class="dv">43</span>}<span class="op">,</span></span>
<span id="cb194-11"><a href="#cb194-11" aria-hidden="true" tabindex="-1"></a>          {<span class="st">&quot;a&quot;</span><span class="op">:</span> <span class="st">&quot;D&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">:</span> <span class="dv">91</span>}<span class="op">,</span></span>
<span id="cb194-12"><a href="#cb194-12" aria-hidden="true" tabindex="-1"></a>          {<span class="st">&quot;a&quot;</span><span class="op">:</span> <span class="st">&quot;E&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">:</span> <span class="dv">81</span>}<span class="op">,</span></span>
<span id="cb194-13"><a href="#cb194-13" aria-hidden="true" tabindex="-1"></a>          {<span class="st">&quot;a&quot;</span><span class="op">:</span> <span class="st">&quot;F&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">:</span> <span class="dv">53</span>}<span class="op">,</span></span>
<span id="cb194-14"><a href="#cb194-14" aria-hidden="true" tabindex="-1"></a>          {<span class="st">&quot;a&quot;</span><span class="op">:</span> <span class="st">&quot;G&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">:</span> <span class="dv">19</span>}<span class="op">,</span></span>
<span id="cb194-15"><a href="#cb194-15" aria-hidden="true" tabindex="-1"></a>          {<span class="st">&quot;a&quot;</span><span class="op">:</span> <span class="st">&quot;H&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">:</span> <span class="dv">87</span>}<span class="op">,</span></span>
<span id="cb194-16"><a href="#cb194-16" aria-hidden="true" tabindex="-1"></a>          {<span class="st">&quot;a&quot;</span><span class="op">:</span> <span class="st">&quot;I&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">:</span> <span class="dv">52</span>}</span>
<span id="cb194-17"><a href="#cb194-17" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb194-18"><a href="#cb194-18" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb194-19"><a href="#cb194-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb194-20"><a href="#cb194-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/script&gt;</span></span>
<span id="cb194-21"><a href="#cb194-21" aria-hidden="true" tabindex="-1"></a>...rest of page as before...</span></code></pre></div>
<p>In this case, we represent a two-dimensional data table as objects with explicit indices <code>"a"</code> and <code>"b"</code>. We have to do this because JSON (like JavaScript) doesn’t have a native representation of two-dimensional arrays with row and column headers.</p>
<p>Once we have created our spec, we can call <code>vegaEmbed</code> with the ID of the element that will hold the visualization, the spec, and some options (which for now we will leave empty):</p>
<div class="sourceCode" id="cb195"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> spec <span class="op">=</span> {</span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;$schema&quot;</span><span class="op">:</span> <span class="st">&quot;https://vega.github.io/schema/vega-lite/v2.0.json&quot;</span><span class="op">,</span></span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;description&quot;</span><span class="op">:</span> <span class="st">&quot;Create data array but do not display anything.&quot;</span><span class="op">,</span></span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;data&quot;</span><span class="op">:</span> {</span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;values&quot;</span><span class="op">:</span> [</span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a>          <span class="co">// ...as above...</span></span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb195-9"><a href="#cb195-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb195-10"><a href="#cb195-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">vegaEmbed</span>(<span class="st">&quot;#vis&quot;</span><span class="op">,</span> spec<span class="op">,</span> {})</span></code></pre></div>
<p>When we open the page, though, nothing appears, because we haven’t told Vega-Lite <em>how</em> to display the data. To do that, we need to add two more fields to the spec:</p>
<ul>
<li><p><code>mark</code> specifies the visual element used to show the data</p></li>
<li><p><code>encoding</code> tells Vega how to map values to marks</p></li>
</ul>
<p>Here’s our updated spec:</p>
<div class="sourceCode" id="cb196"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> spec <span class="op">=</span> {</span>
<span id="cb196-2"><a href="#cb196-2" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;$schema&quot;</span><span class="op">:</span> <span class="st">&quot;https://vega.github.io/schema/vega-lite/v2.0.json&quot;</span><span class="op">,</span></span>
<span id="cb196-3"><a href="#cb196-3" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;description&quot;</span><span class="op">:</span> <span class="st">&quot;Add mark and encoding for data.&quot;</span><span class="op">,</span></span>
<span id="cb196-4"><a href="#cb196-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;data&quot;</span><span class="op">:</span> {</span>
<span id="cb196-5"><a href="#cb196-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;values&quot;</span><span class="op">:</span> [</span>
<span id="cb196-6"><a href="#cb196-6" aria-hidden="true" tabindex="-1"></a>          <span class="co">// ...as above...</span></span>
<span id="cb196-7"><a href="#cb196-7" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb196-8"><a href="#cb196-8" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb196-9"><a href="#cb196-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;mark&quot;</span><span class="op">:</span> <span class="st">&quot;bar&quot;</span><span class="op">,</span></span>
<span id="cb196-10"><a href="#cb196-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;encoding&quot;</span><span class="op">:</span> {</span>
<span id="cb196-11"><a href="#cb196-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;x&quot;</span><span class="op">:</span> {<span class="st">&quot;field&quot;</span><span class="op">:</span> <span class="st">&quot;a&quot;</span><span class="op">,</span> <span class="st">&quot;type&quot;</span><span class="op">:</span> <span class="st">&quot;ordinal&quot;</span>}<span class="op">,</span></span>
<span id="cb196-12"><a href="#cb196-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;y&quot;</span><span class="op">:</span> {<span class="st">&quot;field&quot;</span><span class="op">:</span> <span class="st">&quot;b&quot;</span><span class="op">,</span> <span class="st">&quot;type&quot;</span><span class="op">:</span> <span class="st">&quot;quantitative&quot;</span>}</span>
<span id="cb196-13"><a href="#cb196-13" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb196-14"><a href="#cb196-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb196-15"><a href="#cb196-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">vegaEmbed</span>(<span class="st">&quot;#vis&quot;</span><span class="op">,</span> spec<span class="op">,</span> {})</span></code></pre></div>
<p>When we open the page now, we see a bar chart, and feel very proud of ourselves (Figure <a href="#f:vis-mark-encoding" data-reference-type="ref" data-reference="f:vis-mark-encoding">[f:vis-mark-encoding]</a>).</p>
<p>There are also some poorly-styled links for various controls that we’re not going to use. We can fill in the options argument to <code>vegaEmbed</code> to turn those off:</p>
<div class="sourceCode" id="cb197"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> spec <span class="op">=</span> {</span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;$schema&quot;</span><span class="op">:</span> <span class="st">&quot;https://vega.github.io/schema/vega-lite/v2.0.json&quot;</span><span class="op">,</span></span>
<span id="cb197-3"><a href="#cb197-3" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;description&quot;</span><span class="op">:</span> <span class="st">&quot;Disable control links.&quot;</span><span class="op">,</span></span>
<span id="cb197-4"><a href="#cb197-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;data&quot;</span><span class="op">:</span> {</span>
<span id="cb197-5"><a href="#cb197-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ...as before...</span></span>
<span id="cb197-6"><a href="#cb197-6" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb197-7"><a href="#cb197-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb197-8"><a href="#cb197-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> options <span class="op">=</span> {</span>
<span id="cb197-9"><a href="#cb197-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;actions&quot;</span><span class="op">:</span> {</span>
<span id="cb197-10"><a href="#cb197-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;export&quot;</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb197-11"><a href="#cb197-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;source&quot;</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb197-12"><a href="#cb197-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;editor&quot;</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb197-13"><a href="#cb197-13" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb197-14"><a href="#cb197-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb197-15"><a href="#cb197-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">vegaEmbed</span>(<span class="st">&quot;#vis&quot;</span><span class="op">,</span> spec<span class="op">,</span> options)</span></code></pre></div>
<p>We now have the visualization we wanted (Figure <a href="#f:vis-disable-controls" data-reference-type="ref" data-reference="f:vis-disable-controls">[f:vis-disable-controls]</a>).</p>
<p>Vega-Lite has a <em>lot</em> of options: for example, we can use points and average the Y values. (We will change the X data so that values aren’t distinct in order to show this off, because otherwise averaging doesn’t do much.) In our revised spec, <code>x</code> is now <code>"nominal"</code> instead of <code>"ordinal"</code> and <code>y</code> has an extra property <code>"aggregate"</code>, which is set to <code>"average"</code> (but can be used to specify other <a href="#g:aggregation-function"><strong>aggregation functions</strong></a>):</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> spec <span class="op">=</span> {</span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;$schema&quot;</span><span class="op">:</span> <span class="st">&quot;https://vega.github.io/schema/vega-lite/v2.0.json&quot;</span><span class="op">,</span></span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;description&quot;</span><span class="op">:</span> <span class="st">&quot;Disable control links.&quot;</span><span class="op">,</span></span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;data&quot;</span><span class="op">:</span> {</span>
<span id="cb198-5"><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;values&quot;</span><span class="op">:</span> [</span>
<span id="cb198-6"><a href="#cb198-6" aria-hidden="true" tabindex="-1"></a>          {<span class="st">&quot;a&quot;</span><span class="op">:</span> <span class="st">&quot;P&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">:</span> <span class="dv">19</span>}<span class="op">,</span></span>
<span id="cb198-7"><a href="#cb198-7" aria-hidden="true" tabindex="-1"></a>          {<span class="st">&quot;a&quot;</span><span class="op">:</span> <span class="st">&quot;P&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">:</span> <span class="dv">28</span>}<span class="op">,</span></span>
<span id="cb198-8"><a href="#cb198-8" aria-hidden="true" tabindex="-1"></a>          {<span class="st">&quot;a&quot;</span><span class="op">:</span> <span class="st">&quot;P&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">:</span> <span class="dv">91</span>}<span class="op">,</span></span>
<span id="cb198-9"><a href="#cb198-9" aria-hidden="true" tabindex="-1"></a>          {<span class="st">&quot;a&quot;</span><span class="op">:</span> <span class="st">&quot;Q&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">:</span> <span class="dv">55</span>}<span class="op">,</span></span>
<span id="cb198-10"><a href="#cb198-10" aria-hidden="true" tabindex="-1"></a>          {<span class="st">&quot;a&quot;</span><span class="op">:</span> <span class="st">&quot;Q&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">:</span> <span class="dv">81</span>}<span class="op">,</span></span>
<span id="cb198-11"><a href="#cb198-11" aria-hidden="true" tabindex="-1"></a>          {<span class="st">&quot;a&quot;</span><span class="op">:</span> <span class="st">&quot;Q&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">:</span> <span class="dv">87</span>}<span class="op">,</span></span>
<span id="cb198-12"><a href="#cb198-12" aria-hidden="true" tabindex="-1"></a>          {<span class="st">&quot;a&quot;</span><span class="op">:</span> <span class="st">&quot;R&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">:</span> <span class="dv">43</span>}<span class="op">,</span></span>
<span id="cb198-13"><a href="#cb198-13" aria-hidden="true" tabindex="-1"></a>          {<span class="st">&quot;a&quot;</span><span class="op">:</span> <span class="st">&quot;R&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">:</span> <span class="dv">52</span>}<span class="op">,</span></span>
<span id="cb198-14"><a href="#cb198-14" aria-hidden="true" tabindex="-1"></a>          {<span class="st">&quot;a&quot;</span><span class="op">:</span> <span class="st">&quot;R&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">:</span> <span class="dv">53</span>}</span>
<span id="cb198-15"><a href="#cb198-15" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb198-16"><a href="#cb198-16" aria-hidden="true" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb198-17"><a href="#cb198-17" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;mark&quot;</span><span class="op">:</span> <span class="st">&quot;point&quot;</span><span class="op">,</span></span>
<span id="cb198-18"><a href="#cb198-18" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;encoding&quot;</span><span class="op">:</span> {</span>
<span id="cb198-19"><a href="#cb198-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;x&quot;</span><span class="op">:</span> {<span class="st">&quot;field&quot;</span><span class="op">:</span> <span class="st">&quot;a&quot;</span><span class="op">,</span> <span class="st">&quot;type&quot;</span><span class="op">:</span> <span class="st">&quot;nominal&quot;</span>}<span class="op">,</span></span>
<span id="cb198-20"><a href="#cb198-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;y&quot;</span><span class="op">:</span> {<span class="st">&quot;field&quot;</span><span class="op">:</span> <span class="st">&quot;b&quot;</span><span class="op">,</span> <span class="st">&quot;type&quot;</span><span class="op">:</span> <span class="st">&quot;quantitative&quot;</span><span class="op">,</span> <span class="st">&quot;aggregate&quot;</span><span class="op">:</span> <span class="st">&quot;average&quot;</span>}</span>
<span id="cb198-21"><a href="#cb198-21" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb198-22"><a href="#cb198-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb198-23"><a href="#cb198-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> options <span class="op">=</span> {</span>
<span id="cb198-24"><a href="#cb198-24" aria-hidden="true" tabindex="-1"></a>      <span class="op">...</span>disable controls <span class="im">as</span> before<span class="op">...</span></span>
<span id="cb198-25"><a href="#cb198-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb198-26"><a href="#cb198-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">vegaEmbed</span>(<span class="st">&quot;#vis&quot;</span><span class="op">,</span> spec<span class="op">,</span> options)</span></code></pre></div>
<p>Figure <a href="#f:vis-aggregate-points" data-reference-type="ref" data-reference="f:vis-aggregate-points">[f:vis-aggregate-points]</a> shows the result.</p>
<h2 id="s:vis-vega-local">Local Installation</h2>
<p>Loading Vega from a <a href="#g:cdn"><strong>Content Delivery Network</strong></a> (CDN) reduces the load on our server, but prevents offline development. Since we want to be able to work when we’re disconnected, let’s load from local files.</p>
<p>Step 1 is to slim down our HTML file so that it only loads our application:</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span></span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;title&gt;</span>Load Vega from a File<span class="kw">&lt;/title&gt;</span></span>
<span id="cb199-5"><a href="#cb199-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;meta</span> <span class="er">charset</span><span class="ot">=</span><span class="st">&quot;utf-8&quot;</span><span class="kw">&gt;</span></span>
<span id="cb199-6"><a href="#cb199-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="er">src</span><span class="ot">=</span><span class="st">&quot;app.js&quot;</span> <span class="er">async</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb199-7"><a href="#cb199-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb199-8"><a href="#cb199-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb199-9"><a href="#cb199-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;div</span> <span class="er">id</span><span class="ot">=</span><span class="st">&quot;vis&quot;</span><span class="kw">&gt;&lt;/div&gt;</span></span>
<span id="cb199-10"><a href="#cb199-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb199-11"><a href="#cb199-11" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>In step 2, we <code>npm install vega vega-lite vega-embed</code> and <code>require(’vega-embed’)</code> in <code>app.js</code>:</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> vegaEmbed <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;vega-embed&#39;</span>)</span>
<span id="cb200-2"><a href="#cb200-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-3"><a href="#cb200-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> spec <span class="op">=</span> {</span>
<span id="cb200-4"><a href="#cb200-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...as before...</span></span>
<span id="cb200-5"><a href="#cb200-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb200-6"><a href="#cb200-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-7"><a href="#cb200-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> options <span class="op">=</span> {</span>
<span id="cb200-8"><a href="#cb200-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...as before...</span></span>
<span id="cb200-9"><a href="#cb200-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb200-10"><a href="#cb200-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-11"><a href="#cb200-11" aria-hidden="true" tabindex="-1"></a><span class="fu">vegaEmbed</span>(<span class="st">&quot;#vis&quot;</span><span class="op">,</span> spec<span class="op">,</span> options)</span></code></pre></div>
<p>We launch this with Parcel via our saved <code>npm run</code> command:</p>
<pre class="shell"><code>$ npm run dev -- src/vis/react-01/index.html</code></pre>
<p>Our hearts break when we open <code>http://localhost:4000</code> in our browser and nothing appears. Looking in the browser console, we see a message telling us that <code>vegaEmbed</code> is not a function.</p>
<p>What we have tripped over is a leftover from JavaScript’s evolution. The old method of getting libraries is <code>require</code>, and that’s still what Node supports as of Version 10.9.0. The new standard is <code>import</code>, which allows a module to define a default value so that <code>import ’something’</code> gets a function, a class, or whatever. This is really handy, but <code>require</code> doesn’t work that way.</p>
<p>We can either add the <code>--experimental-modules</code> flag when using Node on the command line, or rename our files with a <code>.mjs</code> extension, both of which are annoying. Alternatively, we can get the thing we want by accessing <code>.default</code> during import, or by referring to <code>vegaEmbed.default</code> when we call it. These choices are also annoying, but after a bit of fiddling and cursing, we decide to make the fix as the library is loaded:</p>
<div class="sourceCode" id="cb202"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> vegaEmbed <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;vega-embed&#39;</span>)<span class="op">.</span><span class="at">default</span></span>
<span id="cb202-2"><a href="#cb202-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb202-3"><a href="#cb202-3" aria-hidden="true" tabindex="-1"></a><span class="co">// ...as before...</span></span></code></pre></div>
<p>The third option is to use <code>import</code> where we can and fix the <code>require</code> statements in the server-side code when Node is upgraded. We can call the thing we import anything we want, but we will stick to <code>vegaEmbed</code> for consistency with previous examples:</p>
<div class="sourceCode" id="cb203"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> vegaEmbed <span class="im">from</span> <span class="st">&#39;vega-embed&#39;</span></span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a><span class="co">// ...as before...</span></span></code></pre></div>
<p>If we do this, the bundled file is 74.5K lines of JavaScript, but at least it’s all in one place for distribution.</p>
<h2 id="s:vis-exercises">Exercises</h2>
<h3 class="unnumbered" id="binned-scatterplots">Binned Scatterplots</h3>
<p>Vega-Lite can create <a href="https://vega.github.io/vega-lite/examples/circle_binned.html">binned scatterplots</a> in which the sizes of markers indicate how many values were put in each bin. Modify the aggregating scatterplot shown above so that values are binned in this way.</p>
<h3 class="unnumbered" id="grouped-bar-charts">Grouped Bar Charts</h3>
<p>Vega-Lite can display <a href="https://vega.github.io/vega-lite/examples/bar_grouped.html">grouped bar charts</a> as well as simple ones. Find or create a simple dataset and construct a grouped bar chart. How impressed will your supervisor, your committee, or a future employee be by your chosen color scheme?</p>
<h3 class="unnumbered" id="limits-of-declarative-programming">Limits of Declarative Programming</h3>
<p>Look at Vega-Lite’s <a href="https://vega.github.io/vega-lite/examples/">example gallery</a> and identify one kind of plot or transformation you’ve used or seen that <em>isn’t</em> included there. Do you think this is because they just haven’t gotten around to it yet, or is there something about that plot or transformation that doesn’t lend itself to Vega-Lite’s declarative model?</p>
<h3 class="unnumbered" id="working-with-arrays">Working With Arrays</h3>
<p>Vega-Lite is built on top of a visualization toolkit called <a href="https://d3js.org/">D3</a>, which includes <a href="https://github.com/d3/d3-array">a library for manipulating arrays</a>. Write a small application that generates 1000 random values using <code>Math.random</code> and reports the mean, standard deviation, and quartiles. (You may also want to create a histogram showing the distribution of values.)</p>
<h2 class="unnumbered" id="key-points-7">Key Points</h2>
<ul>
<li><p>Vega-Lite is a simple way to build common visualizations.</p></li>
<li><p>Vega-Lite is declarative: the user creates a data structure describing what they want, and the library creates the visualization.</p></li>
<li><p>A Vega-Lite specification contains a schema identifier, a description, data, marks, and encodings.</p></li>
<li><p>The overall layout of a Vega-Lite visualization can be controlled by setting options.</p></li>
<li><p>Some applications will use <code>require</code> for server-side code and <code>import</code> for client-side code.</p></li>
</ul>
<h1 id="s:promises">Promises</h1>
<p>By now we have got used to providing callback functions as arguments to other functions. Callbacks quickly become complicated because of:</p>
<ul>
<li><p>Nesting: a delayed calculation may need the result of a delayed calculation that needs<span>…</span></p></li>
<li><p>Error handling: who notices and takes care of errors? (This is often a problem in real life too.)</p></li>
</ul>
<p>For example, suppose we want to turn a set of CSV files into HTML pages. The inputs to our function are the name of a directory that contains one or more CSV files and the name of an output directory; the desired results are that the output directory is created if it doesn’t already exist, that one HTML file is created for each CSV file, that any HTML files in the directory that <em>don’t</em> correspond to CSV files are removed, and that an index page is created with links to all the pages.</p>
<p>We can do this with synchronous operations, but that’s not the JavaScript way (by which we mean that doing it that way won’t introduce you to tools we’re going to need later). We can also try doing it with callbacks, but:</p>
<ul>
<li><p>we can’t create the output directory until the existing one has been emptied;</p></li>
<li><p>can’t generate the HTML pages until the output directory has been re-created; and</p></li>
<li><p>we can’t generate the index page until the CSV files have been processed.</p></li>
</ul>
<p>Instead of a tangled nest of callbacks, it’s better to use <a href="#g:promise"><strong>promises</strong></a>, and then to use <code>async</code> and <code>await</code> to make things even easier. JavaScript offers three mechanisms because its developers have invented better ways to do things as the language has evolved, but the simple high-level ideas often don’t make sense unless you understand how they work. (This too is often a problem in real life.)</p>
<h2 id="s:promises-queue">The Execution Queue</h2>
<p>In order for any of what follows to make sense, it’s vital to understand JavaScript’s <a href="#g:event-loop"><strong>event loop</strong></a>, a full explanation of which can be found <a href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/">here</a>. Most functions execute in order:</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1000</span><span class="op">,</span> <span class="dv">1500</span><span class="op">,</span> <span class="dv">500</span>]<span class="op">.</span><span class="fu">forEach</span>(t <span class="kw">=&gt;</span> {</span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(t)</span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre class="text"><code>1000
1500
500</code></pre>
<p>However, a handful of built-in functions delay execution: instead of running right away, they add a callback to a list that the JavaScript interpreter uses to keep track of things that want to be run. When one task finishes, the interpreter takes the next one from this queue and runs it.</p>
<p><code>setTimeout</code> is one of the most widely used functions of this kind. Here it is in operation:</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1000</span><span class="op">,</span> <span class="dv">1500</span><span class="op">,</span> <span class="dv">500</span>]<span class="op">.</span><span class="fu">forEach</span>(t <span class="kw">=&gt;</span> {</span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`about to setTimeout for </span><span class="sc">${</span>t<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb206-3"><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a>  <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {<span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`inside handler for </span><span class="sc">${</span>t<span class="sc">}</span><span class="vs">`</span>)}<span class="op">,</span> t)</span>
<span id="cb206-4"><a href="#cb206-4" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre class="text"><code>about to setTimeout for 1000
about to setTimeout for 1500
about to setTimeout for 500
inside handler for 500
inside handler for 1000
inside handler for 1500</code></pre>
<p>That’s not surprising: if we ask JavaScript to delay execution, execution is delayed. What may be surprising is that setting a timeout of zero also defers execution:</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> values <span class="op">=</span> [<span class="dv">1000</span><span class="op">,</span> <span class="dv">1500</span><span class="op">,</span> <span class="dv">500</span>]</span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;starting...&#39;</span>)</span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a>values<span class="op">.</span><span class="fu">forEach</span>(t <span class="kw">=&gt;</span> {</span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`about to setTimeout for </span><span class="sc">${</span>t<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb208-5"><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a>  <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {<span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`inside handler for </span><span class="sc">${</span>t<span class="sc">}</span><span class="vs">`</span>)}<span class="op">,</span> <span class="dv">0</span>)</span>
<span id="cb208-6"><a href="#cb208-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb208-7"><a href="#cb208-7" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;...finishing&#39;</span>)</span></code></pre></div>
<pre class="text"><code>starting...
about to setTimeout for 1000
about to setTimeout for 1500
about to setTimeout for 500
...finishing
inside handler for 1000
inside handler for 1500
inside handler for 500</code></pre>
<figure>
<img src="figures/promises-queue.svg" id="f:promises-queue" /><figcaption aria-hidden="true"><span>Run Queue</span><span id="f:promises-queue" label="f:promises-queue">[f:promises-queue]</span></figcaption>
</figure>
<p>Figure <a href="#f:promises-queue" data-reference-type="ref" data-reference="f:promises-queue">9.1</a> shows what the run queue looks like just before the program prints <code>...finishing</code>. We can use <code>setTimeout</code> to build a generic non-blocking function:</p>
<div class="sourceCode" id="cb210"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> nonBlocking <span class="op">=</span> (callback) <span class="kw">=&gt;</span> {</span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a>  <span class="pp">setTimeout</span>(callback<span class="op">,</span> <span class="dv">0</span>)</span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb210-4"><a href="#cb210-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb210-5"><a href="#cb210-5" aria-hidden="true" tabindex="-1"></a>[<span class="st">&#39;a&#39;</span><span class="op">,</span> <span class="st">&#39;b&#39;</span><span class="op">,</span> <span class="st">&#39;c&#39;</span>]<span class="op">.</span><span class="fu">forEach</span>(val <span class="kw">=&gt;</span> {</span>
<span id="cb210-6"><a href="#cb210-6" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`about to do nonBlocking for </span><span class="sc">${</span>val<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb210-7"><a href="#cb210-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">nonBlocking</span>(() <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`inside callback for </span><span class="sc">${</span>val<span class="sc">}</span><span class="vs">`</span>))</span>
<span id="cb210-8"><a href="#cb210-8" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre class="text"><code>about to do nonBlocking for a
about to do nonBlocking for b
about to do nonBlocking for c
inside callback for a
inside callback for b
inside callback for c</code></pre>
<p>Why bother doing this? Because we may want to give something else a chance to run. In particular, file I/O and anything involving a network request are incredibly slow from a computer’s point of view. <a href="http://exple.tive.org/blarg/2018/08/15/time-dilation/">If a single CPU cycle was one second long</a>, then getting data from RAM would take several minutes, getting it from a solid-state disk would take six to eight days, and getting it over the network is the equivalent of eight years. Rather than wasting that time, JavaScript is designed to let us (or our browser) switch tasks and do something else.</p>
<p>Using a timeout of zero is a clever trick, but Node provides another function called <code>setImmediate</code> to do this for us. (There is also <code>process.nextTick</code>, which doesn’t do quite the same thing. You should probably not use it.)</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a>[<span class="st">&#39;a&#39;</span><span class="op">,</span> <span class="st">&#39;b&#39;</span><span class="op">,</span> <span class="st">&#39;c&#39;</span>]<span class="op">.</span><span class="fu">forEach</span>(val <span class="kw">=&gt;</span> {</span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`about to do setImmediate for </span><span class="sc">${</span>val<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setImmediate</span>(() <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`inside immediate handler for </span><span class="sc">${</span>val<span class="sc">}</span><span class="vs">`</span>))</span>
<span id="cb212-4"><a href="#cb212-4" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre class="text"><code>about to do setImmediate for a
about to do setImmediate for b
about to do setImmediate for c
inside immediate handler for a
inside immediate handler for b
inside immediate handler for c</code></pre>
<h2 id="s:promises-promises">Promises</h2>
<p>Recent versions of JavaScript encourage programmers to use promises to manage delayed actions. For example, if we want to find the size of a file, we can write this:</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;fs-extra&#39;</span>)</span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a>fs<span class="op">.</span><span class="fu">stat</span>(<span class="st">&#39;moby-dick.txt&#39;</span>)<span class="op">.</span><span class="fu">then</span>((stats) <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(stats<span class="op">.</span><span class="at">size</span>))</span></code></pre></div>
<pre class="text"><code>1276201</code></pre>
<p><code>fs-extra.stat</code> will eventually produce some statistics about the file, but this will take a while, so <code>fs-extra.stat</code> returns an object of the class <code>Promise</code> right away. <code>Promise</code> has a method <code>then</code> that takes a callback as an argument and stores it in the promise object. When the <code>stat</code> call completes, the remembered callback is called, and passed yet another object with statistics about the file (including its size).</p>
<p>To understand this a little better, let’s create our own promise to fetch a file from the web. (We have broken the URL over two lines using string concatenation so that it will print nicely.)</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fetch <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;node-fetch&#39;</span>)</span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-3"><a href="#cb216-3" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">&#39;https://api.nasa.gov/neo/rest/v1/feed&#39;</span> <span class="op">+</span></span>
<span id="cb216-4"><a href="#cb216-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;?api_key=DEMO_KEY&amp;start_date=2018-08-20&#39;</span></span>
<span id="cb216-5"><a href="#cb216-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> prom <span class="op">=</span> <span class="kw">new</span> <span class="bu">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> {</span>
<span id="cb216-6"><a href="#cb216-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fetch</span>(url)</span>
<span id="cb216-7"><a href="#cb216-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">then</span>((response) <span class="kw">=&gt;</span> {</span>
<span id="cb216-8"><a href="#cb216-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (response<span class="op">.</span><span class="at">status</span> <span class="op">===</span> <span class="dv">200</span>) {</span>
<span id="cb216-9"><a href="#cb216-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">resolve</span>(<span class="st">&#39;fetched page successfully&#39;</span>)</span>
<span id="cb216-10"><a href="#cb216-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb216-11"><a href="#cb216-11" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb216-12"><a href="#cb216-12" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span><span class="fu">then</span>((message) <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(message))</span></code></pre></div>
<p>This code constructs a new <code>Promise</code> object. The constructor takes one argument; this must be a callback function of two arguments, which by convention are called <code>resolve</code> and <code>reject</code>. Inside the body of the callback, we call <code>resolve</code> to return a value if and when everything worked as planned. That value is then passed to the <code>then</code> method of the <code>Promise</code>.</p>
<p>This may seem a roundabout way of doing things, but it solves several problems at once. The first and most important is error handling: if something goes wrong inside the callback passed to <code>Promise</code>’s constructor, we can call <code>reject</code> instead of <code>resolve</code>. Just as <code>then</code> handles whatever we pass to <code>resolve</code>, <code>Promise</code> defines a method called <code>catch</code> to handle whatever is passed to <code>reject</code>. We can therefore build a slightly more robust version of our data fetcher that will report something sensible if we mis-type a month as <code>80</code>:</p>
<div class="sourceCode" id="cb217"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fetch <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;node-fetch&#39;</span>)</span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-3"><a href="#cb217-3" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">&#39;https://api.nasa.gov/neo/rest/v1/feed&#39;</span> <span class="op">+</span></span>
<span id="cb217-4"><a href="#cb217-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;?api_key=DEMO_KEY&amp;start_date=2018-80-20&#39;</span></span>
<span id="cb217-5"><a href="#cb217-5" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="bu">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> {</span>
<span id="cb217-6"><a href="#cb217-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fetch</span>(url)</span>
<span id="cb217-7"><a href="#cb217-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">then</span>((response) <span class="kw">=&gt;</span> {</span>
<span id="cb217-8"><a href="#cb217-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (response<span class="op">.</span><span class="at">status</span> <span class="op">===</span> <span class="dv">200</span>) {</span>
<span id="cb217-9"><a href="#cb217-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">resolve</span>(<span class="st">&#39;fetched page successfully&#39;</span>)</span>
<span id="cb217-10"><a href="#cb217-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb217-11"><a href="#cb217-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> {</span>
<span id="cb217-12"><a href="#cb217-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">reject</span>(<span class="bu">Error</span>(<span class="vs">`got HTTP status code </span><span class="sc">${</span>response<span class="op">.</span><span class="at">status</span><span class="sc">}</span><span class="vs">`</span>))</span>
<span id="cb217-13"><a href="#cb217-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb217-14"><a href="#cb217-14" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb217-15"><a href="#cb217-15" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span><span class="fu">then</span>((message) <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(message))</span>
<span id="cb217-16"><a href="#cb217-16" aria-hidden="true" tabindex="-1"></a><span class="op">.</span><span class="fu">catch</span>((error) <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(error<span class="op">.</span><span class="at">message</span>))</span></code></pre></div>
<pre class="text"><code>got HTTP status code 400</code></pre>
<p>Note that we didn’t assign our Promise object to a variable in the example above. We can create promises on the fly if we need them only to define behavior on successful completion/exception and won’t need to refer to them again later.</p>
<figure>
<img src="figures/promises-object-a.svg" id="f:promises-object-a" /><figcaption aria-hidden="true"><span>Promises as Objects (after creation)</span><span id="f:promises-object-a" label="f:promises-object-a">[f:promises-object-a]</span></figcaption>
</figure>
<p>What makes this all work is that a promise is an object. Figure <a href="#f:promises-object-a" data-reference-type="ref" data-reference="f:promises-object-a">9.2</a> shows what’s in memory just after this promise has been created. There are a lot of arrows in this diagram, but they all serve a purpose:</p>
<ul>
<li><p>The promise has three fields: the initial action (which is the callback passed to the constructor), the action to be taken if everything succeeds, and the action to be taken if there’s an error.</p></li>
<li><p>The success and error actions are empty, because the initial action hasn’t executed yet.</p></li>
</ul>
<p>Once the promise is created, the program calls its <code>then</code> and <code>catch</code> methods in that order, giving each a callback. This happens <em>before</em> the callback passed to the constructor (i.e., the initial action) is executed, and leaves the promise in the state shown in Figure <a href="#f:promises-object-b" data-reference-type="ref" data-reference="f:promises-object-b">9.3</a>:</p>
<figure>
<img src="figures/promises-object-b.svg" id="f:promises-object-b" /><figcaption aria-hidden="true"><span>Promises as Objects (after then and catch)</span><span id="f:promises-object-b" label="f:promises-object-b">[f:promises-object-b]</span></figcaption>
</figure>
<p>Calling <code>then</code> and <code>catch</code> assigns callbacks to the success action and error action members of the promise object. Those methods are then passed into the initial action callback as <code>resolve</code> and <code>reject</code>, i.e., if <code>resolve</code> is called because the page was fetched successfully, what’s actually called is the promise’s success action, which is the callback that was given to <code>then</code>. If <code>reject</code> is called, on the other hand, it triggers execution of the error action, which is the callback that was passed to <code>catch</code>.</p>
<p>Yes, this is complicated—so complicated that another layer (which we will look at in Section <a href="#s:promises-async-await" data-reference-type="ref" data-reference="s:promises-async-await">9.4</a>) has been added to JavaScript to hide these details. Without this complexity, though, it’s extremely difficult to handle errors from delayed computations. If we run this using JavaScript’s <code>try {...} catch {...}</code> syntax for handling exceptions:</p>
<div class="sourceCode" id="cb219"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fetch <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;node-fetch&#39;</span>)</span>
<span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-3"><a href="#cb219-3" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">&#39;https://api.nasa.gov/neo/rest/v1/feed&#39;</span> <span class="op">+</span></span>
<span id="cb219-4"><a href="#cb219-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;?api_key=DEMO_KEY&amp;start_date=2018-80-20&#39;</span> <span class="co">// illegal date</span></span>
<span id="cb219-5"><a href="#cb219-5" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span> {</span>
<span id="cb219-6"><a href="#cb219-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fetch</span>(url)</span>
<span id="cb219-7"><a href="#cb219-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb219-8"><a href="#cb219-8" aria-hidden="true" tabindex="-1"></a><span class="cf">catch</span> (err) {</span>
<span id="cb219-9"><a href="#cb219-9" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(err)</span>
<span id="cb219-10"><a href="#cb219-10" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>then the error message won’t appear because the function <code>fetch</code> is asynchronous, which means that code executes in this order:</p>
<ol>
<li><p>inside try, ask the computer to execute <code>fetch(url)</code> at some point in the future</p></li>
<li><p>since asking this doesn’t cause an exception, skip the catch</p></li>
<li><p>then run <code>fetch(url)</code>, which fails without anything in place to catch the exception because the <code>try...catch</code> has already finished so <code>console.log</code> never runs and the error message doesn’t appear.</p></li>
</ol>
<figure>
<img src="figures/promises-try-catch-fail.svg" id="f:try-catch-fail" /><figcaption aria-hidden="true"><span>When Try...Catch Fails</span><span id="f:try-catch-fail" label="f:try-catch-fail">[f:try-catch-fail]</span></figcaption>
</figure>
<p>There are two passes of execution in this block: The first is the <code>try...catch</code> event loop, and the second is <code>fetch</code>. JavaScript rips the asynchronous code right out of the execution context! There’s no error, because <code>fetch</code> hasn’t yet had the chance to run.</p>
<p>Going back to the <code>fs-extra.stat</code> example above, what if we want to process multiple files, for example to calculate their total size? We could write a loop:</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;fs-extra&#39;</span>)</span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> total_size <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb220-4"><a href="#cb220-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> files <span class="op">=</span> [<span class="st">&#39;jane-eyre.txt&#39;</span><span class="op">,</span> <span class="st">&#39;moby-dick.txt&#39;</span><span class="op">,</span></span>
<span id="cb220-5"><a href="#cb220-5" aria-hidden="true" tabindex="-1"></a>               <span class="st">&#39;life-of-frederick-douglass.txt&#39;</span>]</span>
<span id="cb220-6"><a href="#cb220-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> fileName <span class="kw">of</span> files) {</span>
<span id="cb220-7"><a href="#cb220-7" aria-hidden="true" tabindex="-1"></a>  fs<span class="op">.</span><span class="fu">stat</span>(fileName)<span class="op">.</span><span class="fu">then</span>((stats) <span class="kw">=&gt;</span> {</span>
<span id="cb220-8"><a href="#cb220-8" aria-hidden="true" tabindex="-1"></a>    total_size <span class="op">+=</span> stats<span class="op">.</span><span class="at">size</span></span>
<span id="cb220-9"><a href="#cb220-9" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb220-10"><a href="#cb220-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb220-11"><a href="#cb220-11" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(total_size)</span></code></pre></div>
<p>but this doesn’t work: the <code>stat</code> in each iteration is executed asynchronously, so the loop finishes and the script prints a total size of zero before any of the promised code has run.</p>
<p>Plan B is to chain the promises together to ensure that each executes only after the last has resolved:</p>
<div class="sourceCode" id="cb221"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;fs-extra&#39;</span>)</span>
<span id="cb221-2"><a href="#cb221-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb221-3"><a href="#cb221-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> total_size <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb221-4"><a href="#cb221-4" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="bu">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> {</span>
<span id="cb221-5"><a href="#cb221-5" aria-hidden="true" tabindex="-1"></a>  fs<span class="op">.</span><span class="fu">stat</span>(<span class="st">&#39;jane-eyre.txt&#39;</span>)<span class="op">.</span><span class="fu">then</span>((jeStats) <span class="kw">=&gt;</span> {</span>
<span id="cb221-6"><a href="#cb221-6" aria-hidden="true" tabindex="-1"></a>    fs<span class="op">.</span><span class="fu">stat</span>(<span class="st">&#39;moby-dick.txt&#39;</span>)<span class="op">.</span><span class="fu">then</span>((mdStats) <span class="kw">=&gt;</span> {</span>
<span id="cb221-7"><a href="#cb221-7" aria-hidden="true" tabindex="-1"></a>      fs<span class="op">.</span><span class="fu">stat</span>(<span class="st">&#39;life-of-frederick-douglass.txt&#39;</span>)<span class="op">.</span><span class="fu">then</span>((fdStats) <span class="kw">=&gt;</span> {</span>
<span id="cb221-8"><a href="#cb221-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">resolve</span>(jeStats<span class="op">.</span><span class="at">size</span> <span class="op">+</span> mdStats<span class="op">.</span><span class="at">size</span> <span class="op">+</span> fdStats<span class="op">.</span><span class="at">size</span>)</span>
<span id="cb221-9"><a href="#cb221-9" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb221-10"><a href="#cb221-10" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb221-11"><a href="#cb221-11" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb221-12"><a href="#cb221-12" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span><span class="fu">then</span>((total) <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(total))</span></code></pre></div>
<p>but this obviously doesn’t handle an arbitrary number of files, since we have to write one level of nesting for each file. It’s also potentially inefficient, since we could be waiting for one promise to complete while other promises further down are ready to be processed.</p>
<p>The answer is <code>Promise.all</code>, which returns an array of results from completed promises after all of them have resolved. The order of results corresponds to the order of the promises in the input array, which makes processing straightforward:</p>
<div class="sourceCode" id="cb222"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb222-1"><a href="#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;fs-extra&#39;</span>)</span>
<span id="cb222-2"><a href="#cb222-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb222-3"><a href="#cb222-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> total_size <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb222-4"><a href="#cb222-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> files <span class="op">=</span> [<span class="st">&#39;jane-eyre.txt&#39;</span><span class="op">,</span> <span class="st">&#39;moby-dick.txt&#39;</span><span class="op">,</span></span>
<span id="cb222-5"><a href="#cb222-5" aria-hidden="true" tabindex="-1"></a>               <span class="st">&#39;life-of-frederick-douglass.txt&#39;</span>]</span>
<span id="cb222-6"><a href="#cb222-6" aria-hidden="true" tabindex="-1"></a><span class="bu">Promise</span><span class="op">.</span><span class="fu">all</span>(files<span class="op">.</span><span class="fu">map</span>(f <span class="kw">=&gt;</span> fs<span class="op">.</span><span class="fu">stat</span>(f)))<span class="op">.</span></span>
<span id="cb222-7"><a href="#cb222-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">then</span>(stats <span class="kw">=&gt;</span> stats<span class="op">.</span><span class="fu">reduce</span>((total<span class="op">,</span> s) <span class="kw">=&gt;</span> {<span class="cf">return</span> total <span class="op">+</span> s<span class="op">.</span><span class="at">size</span>}<span class="op">,</span> <span class="dv">0</span>))<span class="op">.</span></span>
<span id="cb222-8"><a href="#cb222-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">then</span>(<span class="bu">console</span><span class="op">.</span><span class="fu">log</span>)</span></code></pre></div>
<pre class="text"><code>2594901</code></pre>
<p>In future, we might also find an opportunity to use <code>Promise.race</code>, which takes an array of promises and returns the result of the first one to complete.</p>
<h2 id="s:promises-usage">Using Promises</h2>
<p>Promises don’t really make sense until we start to use them, so let’s try counting the number of lines in a set of files that are larger than a specified threshold. This is a slightly complex example but we will go through and build it up step-by-step.</p>
<p>Before we begin, we will want the name of the directory to search for files. We could put this in our code, but it’s a lot more convenient if we allow users to provide it as a command-line argument when they run our script. To aid this, we’ll use the property within Node called <code>process.argv</code> which is an array containing all the command line arguments passed to the script.</p>
<p>If we put this line in a file called <code>echo.js</code>:</p>
<div class="sourceCode" id="cb224"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb224-1"><a href="#cb224-1" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;arguments are:&#39;</span><span class="op">,</span> <span class="bu">process</span><span class="op">.</span><span class="at">argv</span>)</span></code></pre></div>
<p>and run it like this:</p>
<pre class="shell"><code>$ node src/promises/echo.js first second third</code></pre>
<p>the output is:</p>
<pre class="text"><code>arguments are: [ &#39;/usr/local/bin/node&#39;,
  &#39;/Users/stj/js4ds/src/promises/echo.js&#39;,
  &#39;first&#39;,
  &#39;second&#39;,
  &#39;third&#39; ]</code></pre>
<p>The full path to Node is the first argument, the name of our script is the second, and all of the extra arguments provided by the users follow that. If we want the first of those, we therefore need <code>process.argv[2]</code>.</p>
<p>The first step in counting lines is now to find the input files:</p>
<div class="sourceCode" id="cb227"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb227-1"><a href="#cb227-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;fs-extra&#39;</span>)</span>
<span id="cb227-2"><a href="#cb227-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> glob <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;glob-promise&#39;</span>)</span>
<span id="cb227-3"><a href="#cb227-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-4"><a href="#cb227-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> srcDir <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">argv</span>[<span class="dv">2</span>]</span>
<span id="cb227-5"><a href="#cb227-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb227-6"><a href="#cb227-6" aria-hidden="true" tabindex="-1"></a><span class="fu">glob</span>(<span class="vs">`</span><span class="sc">${</span>srcDir<span class="sc">}</span><span class="vs">/**/*.txt`</span>)</span>
<span id="cb227-7"><a href="#cb227-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">then</span>(files <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;glob&#39;</span><span class="op">,</span> files))</span>
<span id="cb227-8"><a href="#cb227-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">catch</span>(error <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(error))</span></code></pre></div>
<p>If we go into the directory <code>src/promises</code> and run:</p>
<pre class="shell"><code>$ node step-01.js .</code></pre>
<p>to run the program with the current working directory <code>.</code> as its only argument, then the output is:</p>
<pre class="text"><code>glob [ &#39;./common-sense.txt&#39;,
  &#39;./jane-eyre.txt&#39;,
  &#39;./life-of-frederick-douglass.txt&#39;,
  &#39;./moby-dick.txt&#39;,
  &#39;./sense-and-sensibility.txt&#39;,
  &#39;./time-machine.txt&#39; ]</code></pre>
<p>Step 2 is to get the status of each file. This approach doesn’t work because <code>fs.stat</code> is delayed:</p>
<div class="sourceCode" id="cb230"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb230-1"><a href="#cb230-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ...imports and arguments as before...</span></span>
<span id="cb230-2"><a href="#cb230-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb230-3"><a href="#cb230-3" aria-hidden="true" tabindex="-1"></a><span class="fu">glob</span>(<span class="vs">`</span><span class="sc">${</span>srcDir<span class="sc">}</span><span class="vs">/**/*.txt`</span>)</span>
<span id="cb230-4"><a href="#cb230-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">then</span>(files <span class="kw">=&gt;</span> files<span class="op">.</span><span class="fu">map</span>(f <span class="kw">=&gt;</span> fs<span class="op">.</span><span class="fu">stat</span>(f)))</span>
<span id="cb230-5"><a href="#cb230-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">then</span>(files <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;glob + files.map/stat&#39;</span><span class="op">,</span> files))</span>
<span id="cb230-6"><a href="#cb230-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">catch</span>(error <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(error))</span></code></pre></div>
<pre class="text"><code>glob + files.map/stat [ Promise { &lt;pending&gt; },
  Promise { &lt;pending&gt; },
  Promise { &lt;pending&gt; },
  Promise { &lt;pending&gt; },
  Promise { &lt;pending&gt; },
  Promise { &lt;pending&gt; } ]</code></pre>
<p>Step 3 is to use <code>Promise.all</code> to wait for all these promises to resolve:</p>
<div class="sourceCode" id="cb232"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb232-1"><a href="#cb232-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ...imports and arguments as before...</span></span>
<span id="cb232-2"><a href="#cb232-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb232-3"><a href="#cb232-3" aria-hidden="true" tabindex="-1"></a><span class="fu">glob</span>(<span class="vs">`</span><span class="sc">${</span>srcDir<span class="sc">}</span><span class="vs">/**/*.txt`</span>)</span>
<span id="cb232-4"><a href="#cb232-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">then</span>(files <span class="kw">=&gt;</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">all</span>(files<span class="op">.</span><span class="fu">map</span>(f <span class="kw">=&gt;</span> fs<span class="op">.</span><span class="fu">stat</span>(f))))</span>
<span id="cb232-5"><a href="#cb232-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">then</span>(files <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;glob + Promise.all(...)&#39;</span><span class="op">,</span> files))</span>
<span id="cb232-6"><a href="#cb232-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">catch</span>(error <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(error))</span></code></pre></div>
<pre class="text"><code>glob + Promise.all(...) [ Stats {
    dev: 16777220,
    mode: 33188,
    ...more information... },
    ...five more Stats objects...
]</code></pre>
<p>In step 4, we remember that we need to keep track of the names of the files we are looking at, so we need to write our own function that returns an object with two keys (one for the filename, and one for the stats). As described in Chapter <a href="#s:pages" data-reference-type="ref" data-reference="s:pages">6</a>, the notation <code>{a, b}</code> produces an object <code>{"a": a, "b": b}</code>:</p>
<div class="sourceCode" id="cb234"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb234-1"><a href="#cb234-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ...imports and arguments as before...</span></span>
<span id="cb234-2"><a href="#cb234-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-3"><a href="#cb234-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> statPair <span class="op">=</span> (filename) <span class="kw">=&gt;</span> {</span>
<span id="cb234-4"><a href="#cb234-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> {</span>
<span id="cb234-5"><a href="#cb234-5" aria-hidden="true" tabindex="-1"></a>    fs<span class="op">.</span><span class="fu">stat</span>(filename)</span>
<span id="cb234-6"><a href="#cb234-6" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">then</span>(stats <span class="kw">=&gt;</span> <span class="fu">resolve</span>({filename<span class="op">,</span> stats}))</span>
<span id="cb234-7"><a href="#cb234-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">catch</span>(error <span class="kw">=&gt;</span> <span class="fu">reject</span>(error))</span>
<span id="cb234-8"><a href="#cb234-8" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb234-9"><a href="#cb234-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb234-10"><a href="#cb234-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb234-11"><a href="#cb234-11" aria-hidden="true" tabindex="-1"></a><span class="fu">glob</span>(<span class="vs">`</span><span class="sc">${</span>srcDir<span class="sc">}</span><span class="vs">/**/*.txt`</span>)</span>
<span id="cb234-12"><a href="#cb234-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">then</span>(files <span class="kw">=&gt;</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">all</span>(files<span class="op">.</span><span class="fu">map</span>(f <span class="kw">=&gt;</span> <span class="fu">statPair</span>(f))))</span>
<span id="cb234-13"><a href="#cb234-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">then</span>(files <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;glob + Promise.all(...)&#39;</span><span class="op">,</span> files))</span>
<span id="cb234-14"><a href="#cb234-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">catch</span>(error <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(error))</span></code></pre></div>
<pre class="text"><code>glob + Promise.all(...) [ { filename: &#39;./common-sense.txt&#39;,
    stats:
     Stats {
       dev: 16777220,
       mode: 33188,
       ...more information... }
     },
     ...five more (filename, Stats) pairs...
]</code></pre>
<p>Step 5 is to make sure that we’re only working with files more than 100,000 characters long:</p>
<div class="sourceCode" id="cb236"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb236-1"><a href="#cb236-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ...imports and arguments as before...</span></span>
<span id="cb236-2"><a href="#cb236-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb236-3"><a href="#cb236-3" aria-hidden="true" tabindex="-1"></a><span class="fu">glob</span>(<span class="vs">`</span><span class="sc">${</span>srcDir<span class="sc">}</span><span class="vs">/**/*.txt`</span>)</span>
<span id="cb236-4"><a href="#cb236-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">then</span>(files <span class="kw">=&gt;</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">all</span>(files<span class="op">.</span><span class="fu">map</span>(f <span class="kw">=&gt;</span> <span class="fu">statPair</span>(f))))</span>
<span id="cb236-5"><a href="#cb236-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">then</span>(files <span class="kw">=&gt;</span> files<span class="op">.</span><span class="fu">filter</span>(pair <span class="kw">=&gt;</span> pair<span class="op">.</span><span class="at">stats</span><span class="op">.</span><span class="at">size</span> <span class="op">&gt;</span> <span class="dv">100000</span>))</span>
<span id="cb236-6"><a href="#cb236-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">then</span>(files <span class="kw">=&gt;</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">all</span>(files<span class="op">.</span><span class="fu">map</span>(f <span class="kw">=&gt;</span> fs<span class="op">.</span><span class="fu">readFile</span>(f<span class="op">.</span><span class="at">filename</span><span class="op">,</span> <span class="st">&#39;utf8&#39;</span>))))</span>
<span id="cb236-7"><a href="#cb236-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">then</span>(contents <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;...readFile&#39;</span><span class="op">,</span> contents<span class="op">.</span><span class="fu">map</span>(c <span class="kw">=&gt;</span> c<span class="op">.</span><span class="at">length</span>)))</span>
<span id="cb236-8"><a href="#cb236-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">catch</span>(error <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(error))</span></code></pre></div>
<pre class="text"><code>...readFile [ 148134, 1070331, 248369, 1276201, 706124, 204492 ]</code></pre>
<p>In step 6, we split each file’s content into lines and count:</p>
<div class="sourceCode" id="cb238"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb238-1"><a href="#cb238-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ...imports and arguments as before...</span></span>
<span id="cb238-2"><a href="#cb238-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-3"><a href="#cb238-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> countLines <span class="op">=</span> (text) <span class="kw">=&gt;</span> {</span>
<span id="cb238-4"><a href="#cb238-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> text<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>)<span class="op">.</span><span class="at">length</span></span>
<span id="cb238-5"><a href="#cb238-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb238-6"><a href="#cb238-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb238-7"><a href="#cb238-7" aria-hidden="true" tabindex="-1"></a><span class="fu">glob</span>(<span class="vs">`</span><span class="sc">${</span>srcDir<span class="sc">}</span><span class="vs">/**/*.txt`</span>)</span>
<span id="cb238-8"><a href="#cb238-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">then</span>(files <span class="kw">=&gt;</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">all</span>(files<span class="op">.</span><span class="fu">map</span>(f <span class="kw">=&gt;</span> <span class="fu">statPair</span>(f))))</span>
<span id="cb238-9"><a href="#cb238-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">then</span>(files <span class="kw">=&gt;</span> files<span class="op">.</span><span class="fu">filter</span>(pair <span class="kw">=&gt;</span> pair<span class="op">.</span><span class="at">stats</span><span class="op">.</span><span class="at">size</span> <span class="op">&gt;</span> <span class="dv">100000</span>))</span>
<span id="cb238-10"><a href="#cb238-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">then</span>(files <span class="kw">=&gt;</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">all</span>(files<span class="op">.</span><span class="fu">map</span>(f <span class="kw">=&gt;</span> fs<span class="op">.</span><span class="fu">readFile</span>(f<span class="op">.</span><span class="at">filename</span><span class="op">,</span> <span class="st">&#39;utf8&#39;</span>))))</span>
<span id="cb238-11"><a href="#cb238-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">then</span>(contents <span class="kw">=&gt;</span> contents<span class="op">.</span><span class="fu">map</span>(c <span class="kw">=&gt;</span> <span class="fu">countLines</span>(c)))</span>
<span id="cb238-12"><a href="#cb238-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">then</span>(lengths <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;lengths&#39;</span><span class="op">,</span> lengths))</span>
<span id="cb238-13"><a href="#cb238-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">catch</span>(error <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">error</span>(error))</span></code></pre></div>
<pre class="text"><code>lengths [ 2654, 21063, 4105, 22334, 13028, 3584 ]</code></pre>
<p>There’s a lot going on in the example above but the important points are:</p>
<ul>
<li><p>Promises always return another <code>Promise</code> object.</p></li>
<li><p>This allows us to chain multiple <code>then</code> calls.</p></li>
<li><p>This chain is formed of processes that will each wait to run until their predecessor has completed.</p></li>
<li><p>A single <code>catch</code> method works to handle exceptions raised by <em>any</em> of the previous steps.</p></li>
</ul>
<h2 id="s:promises-async-await"><code>async</code> and <code>await</code></h2>
<p>Programmers are never content to leave well enough alone, so the latest version of JavaScript offers yet another tool for managing asynchronous computation. As we saw above, the result of <code>Promise.then</code> is another promise, which allows us to create long chains of <code>.then(...)</code> calls. It works, but it isn’t the most readable of notations and has been known to create a feeling of being trapped.</p>
<p>We can avoid this using two new keywords, <code>async</code> and <code>await</code>. <code>async</code> tells JavaScript that a function is asynchronous, i.e., that it might want to wait for something to complete. Inside an asynchronous function, <code>await</code> tells JavaScript to act as if it had waited for something to finish. We use the two together like this:</p>
<div class="sourceCode" id="cb240"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb240-1"><a href="#cb240-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;fs-extra&#39;</span>)</span>
<span id="cb240-2"><a href="#cb240-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-3"><a href="#cb240-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> statPairAsync <span class="op">=</span> <span class="kw">async</span> (filename) <span class="kw">=&gt;</span> {</span>
<span id="cb240-4"><a href="#cb240-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> stats <span class="op">=</span> <span class="cf">await</span> fs<span class="op">.</span><span class="fu">stat</span>(filename)</span>
<span id="cb240-5"><a href="#cb240-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {filename<span class="op">,</span> stats}</span>
<span id="cb240-6"><a href="#cb240-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb240-7"><a href="#cb240-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb240-8"><a href="#cb240-8" aria-hidden="true" tabindex="-1"></a><span class="fu">statPairAsync</span>(<span class="st">&#39;moby-dick.txt&#39;</span>)<span class="op">.</span><span class="fu">then</span>(</span>
<span id="cb240-9"><a href="#cb240-9" aria-hidden="true" tabindex="-1"></a>  (white_whale) <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(white_whale<span class="op">.</span><span class="at">stats</span>))</span></code></pre></div>
<p>An <code>async</code> function still returns a <code>Promise</code>, but we can chain those promises together with other <code>async</code> functions using <code>await</code>, which collects the result returned by a resolved promise. As before, we can use <code>.catch</code> to handle any errors thrown.</p>
<p>Let’s use these to convert the complete example from the previous section:</p>
<div class="sourceCode" id="cb241"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;fs-extra&#39;</span>)</span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> glob <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;glob-promise&#39;</span>)</span>
<span id="cb241-3"><a href="#cb241-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-4"><a href="#cb241-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> statPairAsync <span class="op">=</span> <span class="kw">async</span> (filename) <span class="kw">=&gt;</span> {</span>
<span id="cb241-5"><a href="#cb241-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> stats <span class="op">=</span> <span class="cf">await</span> fs<span class="op">.</span><span class="fu">stat</span>(filename)</span>
<span id="cb241-6"><a href="#cb241-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {filename<span class="op">,</span> stats}</span>
<span id="cb241-7"><a href="#cb241-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb241-8"><a href="#cb241-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-9"><a href="#cb241-9" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> countLines <span class="op">=</span> (text) <span class="kw">=&gt;</span> {</span>
<span id="cb241-10"><a href="#cb241-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> text<span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>)<span class="op">.</span><span class="at">length</span></span>
<span id="cb241-11"><a href="#cb241-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb241-12"><a href="#cb241-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-13"><a href="#cb241-13" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> processFiles <span class="op">=</span> <span class="kw">async</span> (globpath) <span class="kw">=&gt;</span> {</span>
<span id="cb241-14"><a href="#cb241-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> filenames <span class="op">=</span> <span class="cf">await</span> <span class="fu">glob</span>(globpath)</span>
<span id="cb241-15"><a href="#cb241-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> pairs <span class="op">=</span> <span class="cf">await</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">all</span>(</span>
<span id="cb241-16"><a href="#cb241-16" aria-hidden="true" tabindex="-1"></a>    filenames<span class="op">.</span><span class="fu">map</span>(f <span class="kw">=&gt;</span> <span class="fu">statPairAsync</span>(f)))</span>
<span id="cb241-17"><a href="#cb241-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> filtered <span class="op">=</span> pairs<span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb241-18"><a href="#cb241-18" aria-hidden="true" tabindex="-1"></a>    pair <span class="kw">=&gt;</span> pair<span class="op">.</span><span class="at">stats</span><span class="op">.</span><span class="at">size</span> <span class="op">&gt;</span> <span class="dv">100000</span>)</span>
<span id="cb241-19"><a href="#cb241-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> contents <span class="op">=</span> <span class="cf">await</span> <span class="bu">Promise</span><span class="op">.</span><span class="fu">all</span>(</span>
<span id="cb241-20"><a href="#cb241-20" aria-hidden="true" tabindex="-1"></a>    filtered<span class="op">.</span><span class="fu">map</span>(f <span class="kw">=&gt;</span> fs<span class="op">.</span><span class="fu">readFile</span>(f<span class="op">.</span><span class="at">filename</span><span class="op">,</span> <span class="st">&#39;utf8&#39;</span>)))</span>
<span id="cb241-21"><a href="#cb241-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> lengths <span class="op">=</span> contents<span class="op">.</span><span class="fu">map</span>(c <span class="kw">=&gt;</span> <span class="fu">countLines</span>(c))</span>
<span id="cb241-22"><a href="#cb241-22" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(lengths)</span>
<span id="cb241-23"><a href="#cb241-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb241-24"><a href="#cb241-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-25"><a href="#cb241-25" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> srcDir <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">argv</span>[<span class="dv">2</span>]</span>
<span id="cb241-26"><a href="#cb241-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb241-27"><a href="#cb241-27" aria-hidden="true" tabindex="-1"></a><span class="fu">processFiles</span>(<span class="vs">`</span><span class="sc">${</span>srcDir<span class="sc">}</span><span class="vs">/**/*.txt`</span>)</span>
<span id="cb241-28"><a href="#cb241-28" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">catch</span>(e <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(e<span class="op">.</span><span class="at">message</span>))</span></code></pre></div>
<p>Using <code>async</code> and <code>await</code> lets us avoid long <code>then</code> chains; unless and until JavaScript allows us to define operators like R’s <code>%&gt;%</code> pipe operator, they are probably the easiest way to write readable code. Note, though, that we can only use <code>await</code> inside <code>async</code> functions: JavaScript will report a syntax error if we use them elsewhere. In particular, we cannot use them interactively unless we wrap whatever we want to do in a wee function.</p>
<h2 id="s:promises-exercises">Exercises</h2>
<h3 class="unnumbered" id="whats-going-on">What’s Going On?</h3>
<p>This code runs fine:</p>
<div class="sourceCode" id="cb242"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb242-1"><a href="#cb242-1" aria-hidden="true" tabindex="-1"></a>[<span class="dv">500</span><span class="op">,</span> <span class="dv">1000</span>]<span class="op">.</span><span class="fu">forEach</span>(t <span class="kw">=&gt;</span> {</span>
<span id="cb242-2"><a href="#cb242-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`about to setTimeout for </span><span class="sc">${</span>t<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb242-3"><a href="#cb242-3" aria-hidden="true" tabindex="-1"></a>  <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {<span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`inside timer handler for </span><span class="sc">${</span>t<span class="sc">}</span><span class="vs">`</span>)}<span class="op">,</span> <span class="dv">0</span>)</span>
<span id="cb242-4"><a href="#cb242-4" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>but this code fails:</p>
<div class="sourceCode" id="cb243"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;starting...&#39;</span>)</span>
<span id="cb243-2"><a href="#cb243-2" aria-hidden="true" tabindex="-1"></a>[<span class="dv">500</span><span class="op">,</span> <span class="dv">1000</span>]<span class="op">.</span><span class="fu">forEach</span>(t <span class="kw">=&gt;</span> {</span>
<span id="cb243-3"><a href="#cb243-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`about to setTimeout for </span><span class="sc">${</span>t<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb243-4"><a href="#cb243-4" aria-hidden="true" tabindex="-1"></a>  <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {<span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`inside timer handler for </span><span class="sc">${</span>t<span class="sc">}</span><span class="vs">`</span>)}<span class="op">,</span> <span class="dv">0</span>)</span>
<span id="cb243-5"><a href="#cb243-5" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Why?</p>
<h3 class="unnumbered" id="a-stay-of-execution">A Stay of Execution</h3>
<p>Insert a call to <code>console.log</code> in the appropriate place in the code block below so that the output reads</p>
<pre class="text"><code>Waiting...
This is a sharp Medicine, but it is a Physician for all diseases and miseries.
Waiting...
Finished.</code></pre>
<div class="sourceCode" id="cb245"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> holdingMessage <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb245-2"><a href="#cb245-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Waiting...&#39;</span>)</span>
<span id="cb245-3"><a href="#cb245-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb245-4"><a href="#cb245-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-5"><a href="#cb245-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> swingAxe <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb245-6"><a href="#cb245-6" aria-hidden="true" tabindex="-1"></a>  <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb245-7"><a href="#cb245-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">holdingMessage</span>()</span>
<span id="cb245-8"><a href="#cb245-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Finished.&#39;</span>)</span>
<span id="cb245-9"><a href="#cb245-9" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span> <span class="dv">100</span>)</span>
<span id="cb245-10"><a href="#cb245-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">holdingMessage</span>()</span>
<span id="cb245-11"><a href="#cb245-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb245-12"><a href="#cb245-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb245-13"><a href="#cb245-13" aria-hidden="true" tabindex="-1"></a><span class="fu">swingAxe</span>()</span></code></pre></div>
<h3 class="unnumbered" id="a-synchronous-or-asynchronous">A Synchronous or Asynchronous?</h3>
<p>Which of these functions would you expect to be asynchronous? How can you tell? Does it matter? And, if so, what is a good strategy to find out for sure if a function is asynchronous?</p>
<ol>
<li><p><code>findNearestTown(coords)</code>: given a set of coordinates (<code>coords</code>) in Brazil, looks up and returns the name of the nearest settlement with an estimated population greater than 5000. The function throws an error if <code>coords</code> fall outside Brazil.</p></li>
<li><p><code>calculateSphereVolume(r)</code>: calculates and returns the volume of a sphere with radius <code>r</code>.</p></li>
<li><p><code>calculateRoute(A,B)</code>: returns all possible routes by air between airports <code>A</code> and <code>B</code>, including direct routes and those with no more than 2 transfers.</p></li>
</ol>
<h3 class="unnumbered" id="handling-exceptions">Handling Exceptions</h3>
<p>What (if any) output would you expect to see in the console when the code below is executed?</p>
<div class="sourceCode" id="cb246"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb246-1"><a href="#cb246-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> checkForBlanks <span class="op">=</span> (inputValue) <span class="kw">=&gt;</span> {</span>
<span id="cb246-2"><a href="#cb246-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> {</span>
<span id="cb246-3"><a href="#cb246-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (inputValue <span class="op">===</span> <span class="st">&#39;&#39;</span>) {</span>
<span id="cb246-4"><a href="#cb246-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">reject</span>(<span class="bu">Error</span>(<span class="st">&quot;Blank values are not allowed&quot;</span>))</span>
<span id="cb246-5"><a href="#cb246-5" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb246-6"><a href="#cb246-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">resolve</span>(inputValue)</span>
<span id="cb246-7"><a href="#cb246-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb246-8"><a href="#cb246-8" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb246-9"><a href="#cb246-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb246-10"><a href="#cb246-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb246-11"><a href="#cb246-11" aria-hidden="true" tabindex="-1"></a><span class="kw">new</span> <span class="bu">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> {</span>
<span id="cb246-12"><a href="#cb246-12" aria-hidden="true" tabindex="-1"></a>  <span class="pp">setTimeout</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb246-13"><a href="#cb246-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">reject</span>(<span class="bu">Error</span>(<span class="st">&#39;Timed out!&#39;</span>))</span>
<span id="cb246-14"><a href="#cb246-14" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span> <span class="dv">1000</span>)</span>
<span id="cb246-15"><a href="#cb246-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resolve</span>(<span class="st">&#39;&#39;</span>)</span>
<span id="cb246-16"><a href="#cb246-16" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span><span class="fu">then</span>(</span>
<span id="cb246-17"><a href="#cb246-17" aria-hidden="true" tabindex="-1"></a>  output <span class="kw">=&gt;</span> <span class="fu">checkForBlanks</span>(output)<span class="op">,</span> error <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(error<span class="op">.</span><span class="at">message</span>))<span class="op">.</span><span class="fu">then</span>(</span>
<span id="cb246-18"><a href="#cb246-18" aria-hidden="true" tabindex="-1"></a>    checkedOutput <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(checkedOutput))<span class="op">.</span><span class="fu">catch</span>(</span>
<span id="cb246-19"><a href="#cb246-19" aria-hidden="true" tabindex="-1"></a>      error <span class="kw">=&gt;</span> <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(error<span class="op">.</span><span class="at">message</span>))</span></code></pre></div>
<ol>
<li><p><code>Timed out!</code></p></li>
<li><p>blank output</p></li>
<li><p><code>Blank values are not allowed</code></p></li>
<li><p>a new <code>Promise</code> object</p></li>
</ol>
<h3 class="unnumbered" id="empty-promises">Empty Promises</h3>
<p>Fill in the blanks (<code>___</code>) in the code block below so that the function returns <code>Array[7, 8, 2, 6, 5]</code>.</p>
<div class="sourceCode" id="cb247"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> makePromise <span class="op">=</span> (someInteger) <span class="kw">=&gt;</span> {</span>
<span id="cb247-2"><a href="#cb247-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ___ <span class="bu">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> {</span>
<span id="cb247-3"><a href="#cb247-3" aria-hidden="true" tabindex="-1"></a>    <span class="pp">setTimeout</span>(<span class="fu">___</span>(someInteger)<span class="op">,</span> someInteger <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb247-4"><a href="#cb247-4" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb247-5"><a href="#cb247-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb247-6"><a href="#cb247-6" aria-hidden="true" tabindex="-1"></a><span class="bu">Promise</span><span class="op">.</span><span class="fu">___</span>([<span class="fu">makePromise</span>(<span class="dv">7</span>)<span class="op">,</span> <span class="fu">makePromise</span>(___)<span class="op">,</span> <span class="fu">makePromise</span>(<span class="dv">2</span>)<span class="op">,</span></span>
<span id="cb247-7"><a href="#cb247-7" aria-hidden="true" tabindex="-1"></a>             <span class="fu">makePromise</span>(<span class="dv">6</span>)<span class="op">,</span> <span class="fu">makePromise</span>(<span class="dv">5</span>)])<span class="op">.</span><span class="fu">then</span>(</span>
<span id="cb247-8"><a href="#cb247-8" aria-hidden="true" tabindex="-1"></a>  numbers <span class="kw">=&gt;</span> <span class="fu">___</span>(numbers))</span></code></pre></div>
<p>Now adapt the function so that it returns only <code>2</code>. (Hint: you can achieve this by changing only one of the blank fields.)</p>
<h3 class="unnumbered" id="async-therefore-i-am"><code>async</code>, Therefore I Am</h3>
<p>Using <code>async</code> and <code>await</code>, convert the completed function above into an asynchronous function with the same behavior and output. Do you find your solution easier to read and follow than the original version? Do you think that that is only because you wrote this version?</p>
<h2 class="unnumbered" id="key-points-8">Key Points</h2>
<ul>
<li><p>JavaScript keeps an execution queue for delayed computations.</p></li>
<li><p>Use promises to manage delayed computation instead of raw callbacks.</p></li>
<li><p>Use a callback with two arguments to handle successful completion (resolve) and unsuccessful completion (reject) of a promise.</p></li>
<li><p>Use <code>then</code> to express the next step after successful completion and <code>catch</code> to handle errors.</p></li>
<li><p>Use <code>Promise.all</code> to wait for all promises in a list to complete and <code>Promise.race</code> to wait for the first promise in a set to complete.</p></li>
<li><p>Use <code>await</code> to wait for the result of a computation.</p></li>
<li><p>Mark functions that can be waited on with <code>async</code>.</p></li>
</ul>
<h1 id="s:interactive">Interactive Sites</h1>
<p>Browsers allow us to define <a href="#g:event-handler"><strong>event handlers</strong></a> to specify what to do in response to an externally-triggered action, such as a page loading or a user pressing a button. These event handlers are just callback functions that are (usually) given an <a href="#g:event-object"><strong>event object</strong></a> containing information about what happened, and while we can write them in pure JavaScript, they’re even easier to build in React.</p>
<p>Let’s switch back to single-page examples for a moment to show how we pass a callback function as a specifically-named property of the thing whose behavior we are specifying. (Don’t forget to load the required libraries in the HTML header, like we did in Chapter <a href="#s:dynamic" data-reference-type="ref" data-reference="s:dynamic">7</a>.)</p>
<div class="sourceCode" id="cb248"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb248-1"><a href="#cb248-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb248-2"><a href="#cb248-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;div</span> <span class="ot">id</span><span class="op">=</span><span class="st">&quot;app&quot;</span><span class="kw">&gt;&lt;/div&gt;</span></span>
<span id="cb248-3"><a href="#cb248-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="ot">type</span><span class="op">=</span><span class="st">&quot;text/babel&quot;</span><span class="kw">&gt;</span></span>
<span id="cb248-4"><a href="#cb248-4" aria-hidden="true" tabindex="-1"></a>      let counter = 0</span>
<span id="cb248-5"><a href="#cb248-5" aria-hidden="true" tabindex="-1"></a>      const sayHello = (event) =&gt; <span class="va">{</span></span>
<span id="cb248-6"><a href="#cb248-6" aria-hidden="true" tabindex="-1"></a>        counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb248-7"><a href="#cb248-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`Hello, button: </span><span class="sc">${</span>counter<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb248-8"><a href="#cb248-8" aria-hidden="true" tabindex="-1"></a>      <span class="va">}</span></span>
<span id="cb248-9"><a href="#cb248-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb248-10"><a href="#cb248-10" aria-hidden="true" tabindex="-1"></a>      ReactDOM.render(</span>
<span id="cb248-11"><a href="#cb248-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;button</span> <span class="ot">onClick</span><span class="op">=</span><span class="va">{</span>sayHello<span class="va">}</span><span class="kw">&gt;</span>click this<span class="kw">&lt;/button&gt;</span>,</span>
<span id="cb248-12"><a href="#cb248-12" aria-hidden="true" tabindex="-1"></a>        document.getElementById(&quot;app&quot;)</span>
<span id="cb248-13"><a href="#cb248-13" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb248-14"><a href="#cb248-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/script&gt;</span></span>
<span id="cb248-15"><a href="#cb248-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span></code></pre></div>
<p>As its name suggests, <code>onClick</code> is the event handler called when a button is clicked. Here, we are telling React to call <code>sayHello</code>, which adds one to the event object <code>counter</code> and then prints its value along with a greeting message.</p>
<p>Global variables and functions are a poor way to structure code. It’s far better to define the component as a class and then use a method as the event handler:</p>
<div class="sourceCode" id="cb249"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb249-1"><a href="#cb249-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb249-2"><a href="#cb249-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;div</span> <span class="ot">id</span><span class="op">=</span><span class="st">&quot;app&quot;</span><span class="kw">&gt;&lt;/div&gt;</span></span>
<span id="cb249-3"><a href="#cb249-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="ot">type</span><span class="op">=</span><span class="st">&quot;text/babel&quot;</span><span class="kw">&gt;</span></span>
<span id="cb249-4"><a href="#cb249-4" aria-hidden="true" tabindex="-1"></a>      class Counter extends React.Component <span class="va">{</span></span>
<span id="cb249-5"><a href="#cb249-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-6"><a href="#cb249-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">constructor</span> (props) {</span>
<span id="cb249-7"><a href="#cb249-7" aria-hidden="true" tabindex="-1"></a>          <span class="kw">super</span>(props)</span>
<span id="cb249-8"><a href="#cb249-8" aria-hidden="true" tabindex="-1"></a>          <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> {<span class="dt">counter</span><span class="op">:</span> <span class="dv">0</span>}</span>
<span id="cb249-9"><a href="#cb249-9" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb249-10"><a href="#cb249-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-11"><a href="#cb249-11" aria-hidden="true" tabindex="-1"></a>        increment <span class="op">=</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb249-12"><a href="#cb249-12" aria-hidden="true" tabindex="-1"></a>          <span class="kw">this</span><span class="op">.</span><span class="fu">setState</span>({<span class="dt">counter</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">counter</span><span class="op">+</span><span class="dv">1</span>})</span>
<span id="cb249-13"><a href="#cb249-13" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb249-14"><a href="#cb249-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-15"><a href="#cb249-15" aria-hidden="true" tabindex="-1"></a>        render <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb249-16"><a href="#cb249-16" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> (</span>
<span id="cb249-17"><a href="#cb249-17" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;p&gt;</span></span>
<span id="cb249-18"><a href="#cb249-18" aria-hidden="true" tabindex="-1"></a>              <span class="kw">&lt;button</span> <span class="ot">onClick</span><span class="op">=</span><span class="va">{</span><span class="kw">this</span><span class="op">.</span><span class="at">increment</span><span class="va">}</span><span class="kw">&gt;</span>increment<span class="kw">&lt;/button&gt;</span></span>
<span id="cb249-19"><a href="#cb249-19" aria-hidden="true" tabindex="-1"></a>              <span class="kw">&lt;br/&gt;</span></span>
<span id="cb249-20"><a href="#cb249-20" aria-hidden="true" tabindex="-1"></a>              current: <span class="va">{</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">counter</span><span class="va">}</span></span>
<span id="cb249-21"><a href="#cb249-21" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;/p&gt;</span></span>
<span id="cb249-22"><a href="#cb249-22" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb249-23"><a href="#cb249-23" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb249-24"><a href="#cb249-24" aria-hidden="true" tabindex="-1"></a>      <span class="va">}</span></span>
<span id="cb249-25"><a href="#cb249-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb249-26"><a href="#cb249-26" aria-hidden="true" tabindex="-1"></a>      ReactDOM.render(</span>
<span id="cb249-27"><a href="#cb249-27" aria-hidden="true" tabindex="-1"></a>        <span class="fu">&lt;Counter</span> <span class="fu">/&gt;</span>,</span>
<span id="cb249-28"><a href="#cb249-28" aria-hidden="true" tabindex="-1"></a>        document.getElementById(&quot;app&quot;)</span>
<span id="cb249-29"><a href="#cb249-29" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb249-30"><a href="#cb249-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/script&gt;</span></span>
<span id="cb249-31"><a href="#cb249-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb249-32"><a href="#cb249-32" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span><span class="ss">/html&gt;</span></span></code></pre></div>
<p>Working from bottom to top, the <code>ReactDOM.render</code> call inserts whatever HTML is produced by <code>&lt;Counter /&gt;</code> into the element whose ID is <code>"app"</code>. In this case, though, the counter is not a function, but a class with three parts:</p>
<ol>
<li><p>Its constructor passes the properties provided by the user to <code>React.Component</code>’s constructor. (There aren’t any properties in this case, but there will be in future examples, so it’s a good habit to get into.) The constructor then creates a property called <code>state</code> that holds this component’s state. This property <em>must</em> have this name so that React knows to watch it for changes.</p></li>
<li><p>The <code>increment</code> method uses <code>setState</code> (inherited from <code>React.Component</code>) to change the value of the counter. We <em>must</em> do this rather than creating and modifying <code>this.counter</code> so that React will notice the change in state and re-draw what it needs to.</p></li>
<li><p>The <code>render</code> method takes the place of the functions we have been using so far. It can do anything it wants, but must return some HTML (using JSX). Here, it creates a button with an event handler and displays the current value of the counter.</p></li>
</ol>
<p>React calls each component’s <code>render</code> method each time <code>setState</code> is used to update the component’s state. Behind the scenes, React does some thinking to minimize how much redrawing takes place: while it may look as though the paragraph, button, and current count are all being redrawn each time, React will only actually redraw as little as it can.</p>
<h2 id="s:interactive-babel">But It Doesn’t Work</h2>
<p>If we try running this little application from the command line with Parcel:</p>
<pre class="shell"><code>$ npm run dev -- src/interactive/display-counter.html</code></pre>
<p>everything works as planned. But now try taking the code out of the web page and putting it in its own file:</p>
<div class="sourceCode" id="cb251"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb251-1"><a href="#cb251-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb251-2"><a href="#cb251-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb251-3"><a href="#cb251-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;meta</span> <span class="er">charset</span><span class="ot">=</span><span class="st">&quot;utf-8&quot;</span><span class="kw">&gt;</span></span>
<span id="cb251-4"><a href="#cb251-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;title&gt;</span>Counter<span class="kw">&lt;/title&gt;</span></span>
<span id="cb251-5"><a href="#cb251-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="er">src</span><span class="ot">=</span><span class="st">&quot;app.js&quot;</span> <span class="er">async</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb251-6"><a href="#cb251-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb251-7"><a href="#cb251-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb251-8"><a href="#cb251-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;div</span> <span class="er">id</span><span class="ot">=</span><span class="st">&quot;app&quot;</span><span class="kw">&gt;&lt;/div&gt;</span></span>
<span id="cb251-9"><a href="#cb251-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb251-10"><a href="#cb251-10" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<div class="sourceCode" id="cb252"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb252-1"><a href="#cb252-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> React <span class="im">from</span> <span class="st">&#39;react&#39;</span></span>
<span id="cb252-2"><a href="#cb252-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ReactDOM <span class="im">from</span> <span class="st">&#39;react-dom&#39;</span></span>
<span id="cb252-3"><a href="#cb252-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-4"><a href="#cb252-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Counter <span class="kw">extends</span> React<span class="op">.</span><span class="at">Component</span> {</span>
<span id="cb252-5"><a href="#cb252-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-6"><a href="#cb252-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span> (props) {</span>
<span id="cb252-7"><a href="#cb252-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...as before...</span></span>
<span id="cb252-8"><a href="#cb252-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-9"><a href="#cb252-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-10"><a href="#cb252-10" aria-hidden="true" tabindex="-1"></a>  increment <span class="op">=</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb252-11"><a href="#cb252-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setState</span>({<span class="dt">counter</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">counter</span><span class="op">+</span><span class="dv">1</span>})</span>
<span id="cb252-12"><a href="#cb252-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-13"><a href="#cb252-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-14"><a href="#cb252-14" aria-hidden="true" tabindex="-1"></a>  render <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb252-15"><a href="#cb252-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...as before...</span></span>
<span id="cb252-16"><a href="#cb252-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb252-17"><a href="#cb252-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb252-18"><a href="#cb252-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb252-19"><a href="#cb252-19" aria-hidden="true" tabindex="-1"></a>ReactDOM<span class="op">.</span><span class="fu">render</span>(</span>
<span id="cb252-20"><a href="#cb252-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">&lt;Counter</span> <span class="fu">/&gt;</span><span class="op">,</span></span>
<span id="cb252-21"><a href="#cb252-21" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;app&#39;</span>)</span>
<span id="cb252-22"><a href="#cb252-22" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Let’s try running this:</p>
<pre class="shell"><code>$ npm run dev -- src/interactive/counter/index.html</code></pre>
<pre class="text"><code>&gt; js4ds@0.1.0 dev /Users/stj/js4ds
&gt; parcel serve -p 4000 &quot;src/interactive/counter/index.html&quot;

Server running at http://localhost:4000
!!  /Users/stj/js4ds/src/interactive/counter/app.js:11:12: \
  Unexpected token (11:12)
   9 |   }
  10 |
&gt; 11 |   increment = (event) =&gt; {
     |             ^
  12 |     this.setState({counter: this.state.counter+1})
  13 |   }
  14 |</code></pre>
<p>It seems that Parcel doesn’t like fat arrow methods. This happens because React is still using ES6 JavaScript by default, and fat arrow methods weren’t included in JavaScript at that point. All right, let’s try using “normal” function-style method definitions instead:</p>
<div class="sourceCode" id="cb255"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb255-1"><a href="#cb255-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ...imports as before...</span></span>
<span id="cb255-2"><a href="#cb255-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-3"><a href="#cb255-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Counter <span class="kw">extends</span> React<span class="op">.</span><span class="at">Component</span> {</span>
<span id="cb255-4"><a href="#cb255-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-5"><a href="#cb255-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span> (props) {</span>
<span id="cb255-6"><a href="#cb255-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>(props)</span>
<span id="cb255-7"><a href="#cb255-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> {<span class="dt">counter</span><span class="op">:</span> <span class="dv">0</span>}</span>
<span id="cb255-8"><a href="#cb255-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb255-9"><a href="#cb255-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-10"><a href="#cb255-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">increment</span> (<span class="bu">event</span>) {</span>
<span id="cb255-11"><a href="#cb255-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setState</span>({<span class="dt">counter</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">counter</span><span class="op">+</span><span class="dv">1</span>})</span>
<span id="cb255-12"><a href="#cb255-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb255-13"><a href="#cb255-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-14"><a href="#cb255-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">render</span> () {</span>
<span id="cb255-15"><a href="#cb255-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb255-16"><a href="#cb255-16" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;p&gt;</span></span>
<span id="cb255-17"><a href="#cb255-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;button</span> <span class="ot">onClick</span><span class="op">=</span><span class="va">{</span><span class="kw">this</span><span class="op">.</span><span class="at">increment</span><span class="va">}</span><span class="kw">&gt;</span>increment<span class="kw">&lt;/button&gt;</span></span>
<span id="cb255-18"><a href="#cb255-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;br/&gt;</span></span>
<span id="cb255-19"><a href="#cb255-19" aria-hidden="true" tabindex="-1"></a>        current: <span class="va">{</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">counter</span><span class="va">}</span></span>
<span id="cb255-20"><a href="#cb255-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;/p&gt;</span></span>
<span id="cb255-21"><a href="#cb255-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb255-22"><a href="#cb255-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb255-23"><a href="#cb255-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb255-24"><a href="#cb255-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb255-25"><a href="#cb255-25" aria-hidden="true" tabindex="-1"></a><span class="co">// ...render as before...</span></span></code></pre></div>
<p>Parcel runs this without complaint, but clicking on the button doesn’t change the display. Despair is once again our friend—our <em>only</em> friend—but we persevere. When we open the debugging console in the browser, we see the message <code>TypeError: this is undefined</code>. Section <a href="#s:legacy-prototypes" data-reference-type="ref" data-reference="s:legacy-prototypes">23.3</a> explains in detail why this happens; for now, suffice to say that some poor choices were made early in JavaScript’s development about variable scoping.</p>
<p>At this point it appears that we can compile but not run, or not bundle files together. But wait—when we used an in-page script, we specified the type as <code>text/babel</code> and loaded:</p>
<pre class="text"><code>https://unpkg.com/babel-standalone@6/babel.js</code></pre>
<p>in the page header along with React. Can Babel save us?</p>
<p>The answer is “yes”, though it takes a fair bit of searching on the web to find this out (particularly if you don’t know what you’re looking for). The magic is to create a file in the project’s root directory called <code>.babelrc</code> and add the following lines:</p>
<div class="sourceCode" id="cb257"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb257-1"><a href="#cb257-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb257-2"><a href="#cb257-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;presets&quot;</span><span class="op">:</span> [</span>
<span id="cb257-3"><a href="#cb257-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;react&quot;</span></span>
<span id="cb257-4"><a href="#cb257-4" aria-hidden="true" tabindex="-1"></a>  ]<span class="op">,</span></span>
<span id="cb257-5"><a href="#cb257-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;plugins&quot;</span><span class="op">:</span> [</span>
<span id="cb257-6"><a href="#cb257-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;transform-class-properties&quot;</span></span>
<span id="cb257-7"><a href="#cb257-7" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb257-8"><a href="#cb257-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Once we’ve done this, we can use NPM to install <code>babel-preset-react</code> and <code>babel-plugin-transform-class-properties</code> and then switch back to fat arrow methods. Voila: everything works.</p>
<p>What’s happening here is that when Babel translates our sparkly modern JavaScript into old-fashioned JavaScript compatible with all browsers, it reads <code>.babelrc</code> and obeys that configuration. The settings above tell it to do everything React needs using the <code>transform-class-properties</code> plugin; in particular, to accept fat arrow method definitions and bind <code>this</code> correctly. This works, but is a form of madness: something outside our program determines how that program is interpreted, and the commands controlling it go in yet another configuration file. Still, it is a useful form of madness, so we will press on.</p>
<h2 id="s:interactive-models-views">Models and Views</h2>
<p>Well-designed applications separate <a href="#g:model"><strong>models</strong></a> (which store data) from <a href="#g:view"><strong>views</strong></a> (which display it) so that each can be tested and modified independently. When we use React, the models are typically classes, and the views are typically pure functions.</p>
<p>To introduce this architecture, let’s re-implement the counter using:</p>
<ul>
<li><p><code>App</code> to store the state and provide methods for altering it,</p></li>
<li><p><code>NumberDisplay</code> to display a number, and</p></li>
<li><p><code>UpAndDown</code> to provide buttons that increment and decrement that number.</p></li>
</ul>
<p>The crucial design feature is that <code>NumberDisplay</code> and <code>UpAndDown</code> don’t know what they’re displaying or what actions are being taken on their behalf, which makes them easier to re-use. Of course, no good deed goes unpunished. The price that we pay for organizing our application into separate components is that now we must import the dependencies of each component and export the component itself within each script.</p>
<p>After we’ve done this, our dependencies will be bundled by parcel. So we must remove the script loading from the HTML header. The whole page is:</p>
<div class="sourceCode" id="cb258"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb258-1"><a href="#cb258-1" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb258-2"><a href="#cb258-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb258-3"><a href="#cb258-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;meta</span> <span class="er">charset</span><span class="ot">=</span><span class="st">&quot;utf-8&quot;</span><span class="kw">&gt;</span></span>
<span id="cb258-4"><a href="#cb258-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;title&gt;</span>Up and Down<span class="kw">&lt;/title&gt;</span></span>
<span id="cb258-5"><a href="#cb258-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb258-6"><a href="#cb258-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb258-7"><a href="#cb258-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;div</span> <span class="er">id</span><span class="ot">=</span><span class="st">&quot;app&quot;</span><span class="kw">&gt;&lt;/div&gt;</span></span>
<span id="cb258-8"><a href="#cb258-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="er">src</span><span class="ot">=</span><span class="st">&quot;app.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb258-9"><a href="#cb258-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb258-10"><a href="#cb258-10" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>The <code>NumberDisplay</code> class takes a label and a value and puts them in a paragraph (remember, the label and value will appear in our function as properties of the <code>props</code> parameter):</p>
<div class="sourceCode" id="cb259"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb259-1"><a href="#cb259-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> NumberDisplay <span class="op">=</span> (props) <span class="kw">=&gt;</span> {</span>
<span id="cb259-2"><a href="#cb259-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (<span class="kw">&lt;p&gt;</span><span class="va">{</span>props<span class="op">.</span><span class="at">label</span><span class="va">}</span>: <span class="va">{</span>props<span class="op">.</span><span class="at">value</span><span class="va">}</span><span class="kw">&lt;/p&gt;</span>)</span>
<span id="cb259-3"><a href="#cb259-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Similarly, <code>UpAndDown</code> expects two functions as its <code>up</code> and <code>down</code> properties, and makes each the event handler for an appropriately-labelled button:</p>
<div class="sourceCode" id="cb260"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> UpAndDown <span class="op">=</span> (props) <span class="kw">=&gt;</span> {</span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (</span>
<span id="cb260-3"><a href="#cb260-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;p&gt;</span></span>
<span id="cb260-4"><a href="#cb260-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;button</span> <span class="ot">onClick</span><span class="op">=</span><span class="va">{</span>props<span class="op">.</span><span class="at">up</span><span class="va">}</span><span class="kw">&gt;</span> [+] <span class="kw">&lt;/button&gt;</span></span>
<span id="cb260-5"><a href="#cb260-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;button</span> <span class="ot">onClick</span><span class="op">=</span><span class="va">{</span>props<span class="op">.</span><span class="at">down</span><span class="va">}</span><span class="kw">&gt;</span> [-] <span class="kw">&lt;/button&gt;</span></span>
<span id="cb260-6"><a href="#cb260-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/p&gt;</span></span>
<span id="cb260-7"><a href="#cb260-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb260-8"><a href="#cb260-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Both of these components will use React and ReactDOM when they are rendered so we must import these. We do this by adding import statements to the beginning of both components:</p>
<div class="sourceCode" id="cb261"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb261-1"><a href="#cb261-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> React <span class="im">from</span> <span class="st">&quot;react&quot;</span></span>
<span id="cb261-2"><a href="#cb261-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ReactDOM <span class="im">from</span> <span class="st">&quot;react-dom&quot;</span></span></code></pre></div>
<p>Similarly, our application will need to import the <code>UpAndDown</code> and <code>NumberDisplay</code> components, so we need to export them after they’ve been defined. This is done by adding <code>export {&lt;object_name&gt;}</code> to the end of the component script. (We will explore why the curly braces are necessary in the exercises.) After we’ve done this for <code>UpAndDown</code>, the complete component script looks like this:</p>
<div class="sourceCode" id="cb262"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> React <span class="im">from</span> <span class="st">&quot;react&quot;</span></span>
<span id="cb262-2"><a href="#cb262-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ReactDOM <span class="im">from</span> <span class="st">&quot;react-dom&quot;</span></span>
<span id="cb262-3"><a href="#cb262-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-4"><a href="#cb262-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> UpAndDown <span class="op">=</span> (props) <span class="kw">=&gt;</span> {</span>
<span id="cb262-5"><a href="#cb262-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (</span>
<span id="cb262-6"><a href="#cb262-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;p&gt;</span></span>
<span id="cb262-7"><a href="#cb262-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;button</span> <span class="ot">onClick</span><span class="op">=</span><span class="va">{</span>props<span class="op">.</span><span class="at">up</span><span class="va">}</span><span class="kw">&gt;</span> [+] <span class="kw">&lt;/button&gt;</span></span>
<span id="cb262-8"><a href="#cb262-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;button</span> <span class="ot">onClick</span><span class="op">=</span><span class="va">{</span>props<span class="op">.</span><span class="at">down</span><span class="va">}</span><span class="kw">&gt;</span> [-] <span class="kw">&lt;/button&gt;</span></span>
<span id="cb262-9"><a href="#cb262-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/p&gt;</span></span>
<span id="cb262-10"><a href="#cb262-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb262-11"><a href="#cb262-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb262-12"><a href="#cb262-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-13"><a href="#cb262-13" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> {UpAndDown}</span></code></pre></div>
<p>We are now ready to build the overall application. It creates a <code>state</code> containing a counter and defines methods to increment or decrement the counter’s value. Its <code>render</code> method then lays out the buttons and the current state using those elements (Figure <a href="#f:interactive-objects-dom" data-reference-type="ref" data-reference="f:interactive-objects-dom">10.1</a>):</p>
<div class="sourceCode" id="cb263"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb263-1"><a href="#cb263-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> App <span class="kw">extends</span> React<span class="op">.</span><span class="at">Component</span> {</span>
<span id="cb263-2"><a href="#cb263-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-3"><a href="#cb263-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span> (props) {</span>
<span id="cb263-4"><a href="#cb263-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>(props)</span>
<span id="cb263-5"><a href="#cb263-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> {<span class="dt">counter</span><span class="op">:</span> <span class="dv">0</span>}</span>
<span id="cb263-6"><a href="#cb263-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb263-7"><a href="#cb263-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-8"><a href="#cb263-8" aria-hidden="true" tabindex="-1"></a>  increment <span class="op">=</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb263-9"><a href="#cb263-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setState</span>({<span class="dt">counter</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">counter</span> <span class="op">+</span> <span class="dv">1</span>})</span>
<span id="cb263-10"><a href="#cb263-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb263-11"><a href="#cb263-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-12"><a href="#cb263-12" aria-hidden="true" tabindex="-1"></a>  decrement <span class="op">=</span> (<span class="bu">event</span>) <span class="kw">=&gt;</span> {</span>
<span id="cb263-13"><a href="#cb263-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setState</span>({<span class="dt">counter</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">counter</span> <span class="op">-</span> <span class="dv">1</span>})</span>
<span id="cb263-14"><a href="#cb263-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb263-15"><a href="#cb263-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb263-16"><a href="#cb263-16" aria-hidden="true" tabindex="-1"></a>  render <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb263-17"><a href="#cb263-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb263-18"><a href="#cb263-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;div&gt;</span></span>
<span id="cb263-19"><a href="#cb263-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">&lt;UpAndDown</span> <span class="ot">up</span><span class="op">=</span><span class="va">{</span><span class="kw">this</span><span class="op">.</span><span class="at">increment</span><span class="va">}</span> <span class="ot">down</span><span class="op">=</span><span class="va">{</span><span class="kw">this</span><span class="op">.</span><span class="at">decrement</span><span class="va">}</span> <span class="fu">/&gt;</span></span>
<span id="cb263-20"><a href="#cb263-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">&lt;NumberDisplay</span> <span class="ot">label</span><span class="op">=</span><span class="st">&#39;counter&#39;</span> <span class="ot">value</span><span class="op">=</span><span class="va">{</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">counter</span><span class="va">}</span> <span class="fu">/&gt;</span></span>
<span id="cb263-21"><a href="#cb263-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;/div&gt;</span></span>
<span id="cb263-22"><a href="#cb263-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb263-23"><a href="#cb263-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb263-24"><a href="#cb263-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<figure>
<img src="figures/interactive-objects-dom.svg" id="f:interactive-objects-dom" /><figcaption aria-hidden="true"><span>React Objects and the DOM</span><span id="f:interactive-objects-dom" label="f:interactive-objects-dom">[f:interactive-objects-dom]</span></figcaption>
</figure>
<p>We must import the dependencies as we did with the other components. As well as <code>React</code> and <code>ReactDOM</code>, we need to include the components that we’ve written. Dependencies stored locally can be imported by providing the path to the file in which they are defined, with the <code>.js</code> removed from the file name:</p>
<div class="sourceCode" id="cb264"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb264-1"><a href="#cb264-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> React <span class="im">from</span> <span class="st">&quot;react&quot;</span></span>
<span id="cb264-2"><a href="#cb264-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ReactDOM <span class="im">from</span> <span class="st">&quot;react-dom&quot;</span></span>
<span id="cb264-3"><a href="#cb264-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> {UpAndDown} <span class="im">from</span> <span class="st">&quot;./UpAndDown&quot;</span></span>
<span id="cb264-4"><a href="#cb264-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> {NumberDisplay} <span class="im">from</span> <span class="st">&quot;./NumberDisplay&quot;</span></span>
<span id="cb264-5"><a href="#cb264-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb264-6"><a href="#cb264-6" aria-hidden="true" tabindex="-1"></a><span class="co">// ...script body...</span></span></code></pre></div>
<p>Finally, we can render the application with <code>ReactDOM</code> as before:</p>
<div class="sourceCode" id="cb265"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb265-1"><a href="#cb265-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ...script body...</span></span>
<span id="cb265-2"><a href="#cb265-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb265-3"><a href="#cb265-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> mount <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&quot;app&quot;</span>)</span>
<span id="cb265-4"><a href="#cb265-4" aria-hidden="true" tabindex="-1"></a>ReactDOM<span class="op">.</span><span class="fu">render</span>(<span class="op">&lt;</span>App<span class="op">/&gt;,</span> mount)</span></code></pre></div>
<p>This seems pretty complicated because it is: our small example would be much simpler without all this indirection. However, we need this strategy to manage large applications: data and event handlers are defined in one class, then passed into display components to be displayed and interacted with.</p>
<h2 id="s:interactive-fetching">Fetching Data</h2>
<p>Let’s use what we’ve learned to look at how the world might end. NASA provides a web interface to get information about near-approach asteroids. We will use it to build a small display with:</p>
<ul>
<li><p>a text box for submitting a starting date (get one week by default), and</p></li>
<li><p>a list of asteroids in that time period.</p></li>
</ul>
<p>Here’s the first version of our <code>App</code> class:</p>
<div class="sourceCode" id="cb266"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb266-1"><a href="#cb266-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> React <span class="im">from</span> <span class="st">&quot;react&quot;</span></span>
<span id="cb266-2"><a href="#cb266-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ReactDOM <span class="im">from</span> <span class="st">&quot;react-dom&quot;</span></span>
<span id="cb266-3"><a href="#cb266-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> {AsteroidList} <span class="im">from</span> <span class="st">&quot;./AsteroidList&quot;</span></span>
<span id="cb266-4"><a href="#cb266-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> {DateSubmit} <span class="im">from</span> <span class="st">&quot;./DateSubmit&quot;</span></span>
<span id="cb266-5"><a href="#cb266-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-6"><a href="#cb266-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> App <span class="kw">extends</span> React<span class="op">.</span><span class="at">Component</span> {</span>
<span id="cb266-7"><a href="#cb266-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-8"><a href="#cb266-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span> (props) {</span>
<span id="cb266-9"><a href="#cb266-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>(props)</span>
<span id="cb266-10"><a href="#cb266-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> {</span>
<span id="cb266-11"><a href="#cb266-11" aria-hidden="true" tabindex="-1"></a>      <span class="co">// ...fill in...</span></span>
<span id="cb266-12"><a href="#cb266-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb266-13"><a href="#cb266-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb266-14"><a href="#cb266-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-15"><a href="#cb266-15" aria-hidden="true" tabindex="-1"></a>  onNewDate <span class="op">=</span> (text) <span class="kw">=&gt;</span> {</span>
<span id="cb266-16"><a href="#cb266-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...fill in...</span></span>
<span id="cb266-17"><a href="#cb266-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb266-18"><a href="#cb266-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-19"><a href="#cb266-19" aria-hidden="true" tabindex="-1"></a>  render <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb266-20"><a href="#cb266-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb266-21"><a href="#cb266-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;div&gt;</span></span>
<span id="cb266-22"><a href="#cb266-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">&lt;DateSubmit</span> <span class="ot">newValue</span><span class="op">=</span><span class="va">{</span><span class="kw">this</span><span class="op">.</span><span class="at">onNewDate</span><span class="va">}</span> <span class="fu">/&gt;</span></span>
<span id="cb266-23"><a href="#cb266-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">&lt;AsteroidList</span> <span class="ot">asteroids</span><span class="op">=</span><span class="va">{</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">asteroids</span><span class="va">}</span> <span class="fu">/&gt;</span></span>
<span id="cb266-24"><a href="#cb266-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;/div&gt;</span></span>
<span id="cb266-25"><a href="#cb266-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb266-26"><a href="#cb266-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb266-27"><a href="#cb266-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb266-28"><a href="#cb266-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb266-29"><a href="#cb266-29" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> mount <span class="op">=</span> <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&quot;app&quot;</span>)</span>
<span id="cb266-30"><a href="#cb266-30" aria-hidden="true" tabindex="-1"></a>ReactDOM<span class="op">.</span><span class="fu">render</span>(<span class="fu">&lt;App/&gt;</span><span class="op">,</span> mount)</span></code></pre></div>
<p>We’ll test it by displaying asteroids using fake data; as in our first example, the display component <code>AsteroidList</code> doesn’t modify data, but just displays it in a table:</p>
<div class="sourceCode" id="cb267"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb267-1"><a href="#cb267-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> React <span class="im">from</span> <span class="st">&quot;react&quot;</span></span>
<span id="cb267-2"><a href="#cb267-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ReactDOM <span class="im">from</span> <span class="st">&quot;react-dom&quot;</span></span>
<span id="cb267-3"><a href="#cb267-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-4"><a href="#cb267-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> AsteroidList <span class="op">=</span> (props) <span class="kw">=&gt;</span> {</span>
<span id="cb267-5"><a href="#cb267-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (</span>
<span id="cb267-6"><a href="#cb267-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;table&gt;</span></span>
<span id="cb267-7"><a href="#cb267-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;tbody&gt;</span></span>
<span id="cb267-8"><a href="#cb267-8" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;tr&gt;</span></span>
<span id="cb267-9"><a href="#cb267-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;th&gt;</span>Name<span class="kw">&lt;/th&gt;</span></span>
<span id="cb267-10"><a href="#cb267-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;th&gt;</span>Date<span class="kw">&lt;/th&gt;</span></span>
<span id="cb267-11"><a href="#cb267-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;th&gt;</span>Diameter (m)<span class="kw">&lt;/th&gt;</span></span>
<span id="cb267-12"><a href="#cb267-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;th&gt;</span>Approach (km)<span class="kw">&lt;/th&gt;</span></span>
<span id="cb267-13"><a href="#cb267-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;/tr&gt;</span></span>
<span id="cb267-14"><a href="#cb267-14" aria-hidden="true" tabindex="-1"></a>      <span class="va">{</span>props<span class="op">.</span><span class="at">asteroids</span><span class="op">.</span><span class="fu">map</span>((a) <span class="kw">=&gt;</span> {</span>
<span id="cb267-15"><a href="#cb267-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (</span>
<span id="cb267-16"><a href="#cb267-16" aria-hidden="true" tabindex="-1"></a>          <span class="kw">&lt;tr</span> <span class="ot">key</span><span class="op">=</span><span class="va">{</span>a<span class="op">.</span><span class="at">name</span><span class="va">}</span><span class="kw">&gt;</span></span>
<span id="cb267-17"><a href="#cb267-17" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;td&gt;</span><span class="va">{</span>a<span class="op">.</span><span class="at">name</span><span class="va">}</span><span class="kw">&lt;/td&gt;</span></span>
<span id="cb267-18"><a href="#cb267-18" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;td&gt;</span><span class="va">{</span>a<span class="op">.</span><span class="at">date</span><span class="va">}</span><span class="kw">&lt;/td&gt;</span></span>
<span id="cb267-19"><a href="#cb267-19" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;td&gt;</span><span class="va">{</span>a<span class="op">.</span><span class="at">diameter</span><span class="va">}</span><span class="kw">&lt;/td&gt;</span></span>
<span id="cb267-20"><a href="#cb267-20" aria-hidden="true" tabindex="-1"></a>            <span class="kw">&lt;td&gt;</span><span class="va">{</span>a<span class="op">.</span><span class="at">distance</span><span class="va">}</span><span class="kw">&lt;/td&gt;</span></span>
<span id="cb267-21"><a href="#cb267-21" aria-hidden="true" tabindex="-1"></a>          <span class="kw">&lt;/tr&gt;</span></span>
<span id="cb267-22"><a href="#cb267-22" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb267-23"><a href="#cb267-23" aria-hidden="true" tabindex="-1"></a>      })<span class="va">}</span></span>
<span id="cb267-24"><a href="#cb267-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;/tbody&gt;</span></span>
<span id="cb267-25"><a href="#cb267-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/table&gt;</span></span>
<span id="cb267-26"><a href="#cb267-26" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb267-27"><a href="#cb267-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb267-28"><a href="#cb267-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb267-29"><a href="#cb267-29" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> {AsteroidList}</span></code></pre></div>
<p><code>React</code> will complain if we don’t provide a unique key to distinguish elements that we create, since having these keys helps it keep track of the component-to-DOM relationship, which in turn <a href="https://stackoverflow.com/questions/28329382/understanding-unique-keys-for-array-children-in-react-js">makes updates much more efficient</a>. Since each asteroid’s name is supposed to be unique, we use that name as the key for each table row.</p>
<p><code>AsteroidList</code> expects data to arrive in <code>props.asteroids</code>, so let’s put some made-up values in <code>App</code> for now that we can then pass in:</p>
<div class="sourceCode" id="cb268"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb268-1"><a href="#cb268-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> App <span class="kw">extends</span> React<span class="op">.</span><span class="at">Component</span> {</span>
<span id="cb268-2"><a href="#cb268-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb268-3"><a href="#cb268-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span> (props) {</span>
<span id="cb268-4"><a href="#cb268-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>(props)</span>
<span id="cb268-5"><a href="#cb268-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> {</span>
<span id="cb268-6"><a href="#cb268-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">asteroids</span><span class="op">:</span> [</span>
<span id="cb268-7"><a href="#cb268-7" aria-hidden="true" tabindex="-1"></a>        {<span class="dt">name</span><span class="op">:</span> <span class="st">&#39;a30x1000&#39;</span><span class="op">,</span> <span class="dt">date</span><span class="op">:</span> <span class="st">&#39;2017-03-03&#39;</span><span class="op">,</span></span>
<span id="cb268-8"><a href="#cb268-8" aria-hidden="true" tabindex="-1"></a>         <span class="dt">diameter</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span> <span class="dt">distance</span><span class="op">:</span> <span class="dv">1000</span>}<span class="op">,</span></span>
<span id="cb268-9"><a href="#cb268-9" aria-hidden="true" tabindex="-1"></a>        {<span class="dt">name</span><span class="op">:</span> <span class="st">&#39;a5x500&#39;</span><span class="op">,</span> <span class="dt">date</span><span class="op">:</span> <span class="st">&#39;2017-05-05&#39;</span><span class="op">,</span></span>
<span id="cb268-10"><a href="#cb268-10" aria-hidden="true" tabindex="-1"></a>         <span class="dt">diameter</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span> <span class="dt">distance</span><span class="op">:</span> <span class="dv">500</span>}<span class="op">,</span></span>
<span id="cb268-11"><a href="#cb268-11" aria-hidden="true" tabindex="-1"></a>        {<span class="dt">name</span><span class="op">:</span> <span class="st">&#39;a2000x200&#39;</span><span class="op">,</span> <span class="dt">date</span><span class="op">:</span> <span class="st">&#39;2017-02-02&#39;</span><span class="op">,</span></span>
<span id="cb268-12"><a href="#cb268-12" aria-hidden="true" tabindex="-1"></a>         <span class="dt">diameter</span><span class="op">:</span> <span class="dv">2000</span><span class="op">,</span> <span class="dt">distance</span><span class="op">:</span> <span class="dv">200</span>}</span>
<span id="cb268-13"><a href="#cb268-13" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb268-14"><a href="#cb268-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb268-15"><a href="#cb268-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb268-16"><a href="#cb268-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb268-17"><a href="#cb268-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...other code...</span></span>
<span id="cb268-18"><a href="#cb268-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Let’s also create a placeholder for <code>DateSubmit</code>:</p>
<div class="sourceCode" id="cb269"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb269-1"><a href="#cb269-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> React <span class="im">from</span> <span class="st">&quot;react&quot;</span></span>
<span id="cb269-2"><a href="#cb269-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ReactDOM <span class="im">from</span> <span class="st">&quot;react-dom&quot;</span></span>
<span id="cb269-3"><a href="#cb269-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb269-4"><a href="#cb269-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> DateSubmit <span class="op">=</span> (props) <span class="kw">=&gt;</span> {</span>
<span id="cb269-5"><a href="#cb269-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (<span class="kw">&lt;p&gt;</span>DateSubmit<span class="kw">&lt;/p&gt;</span>)</span>
<span id="cb269-6"><a href="#cb269-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb269-7"><a href="#cb269-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb269-8"><a href="#cb269-8" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> {DateSubmit}</span></code></pre></div>
<p>and run it to get Figure <a href="#f:interactive-asteroids-screenshot" data-reference-type="ref" data-reference="f:interactive-asteroids-screenshot">[f:interactive-asteroids-screenshot]</a>.</p>
<p>The next step is to handle date submission. Since we’re trying to instill good practices, we will make a reusable component whose caller will pass in:</p>
<ul>
<li><p>a text label;</p></li>
<li><p>a variable to update with the current value of a text box;</p></li>
<li><p>a function to call when the text box’s value changes, and</p></li>
<li><p>another function to call when a button is clicked to submit.</p></li>
</ul>
<div class="sourceCode" id="cb270"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb270-1"><a href="#cb270-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ...imports as before...</span></span>
<span id="cb270-2"><a href="#cb270-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-3"><a href="#cb270-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> DateSubmit <span class="op">=</span> ({label<span class="op">,</span> value<span class="op">,</span> onChange<span class="op">,</span> onCommit}) <span class="kw">=&gt;</span> {</span>
<span id="cb270-4"><a href="#cb270-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (</span>
<span id="cb270-5"><a href="#cb270-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;p&gt;</span></span>
<span id="cb270-6"><a href="#cb270-6" aria-hidden="true" tabindex="-1"></a>      <span class="va">{</span>label<span class="va">}</span>:</span>
<span id="cb270-7"><a href="#cb270-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;input</span> <span class="ot">type</span><span class="op">=</span><span class="st">&quot;text&quot;</span> <span class="ot">value</span><span class="op">=</span><span class="va">{</span>value<span class="va">}</span></span>
<span id="cb270-8"><a href="#cb270-8" aria-hidden="true" tabindex="-1"></a>             <span class="ot">onChange</span><span class="op">=</span><span class="va">{</span>(<span class="bu">event</span>) <span class="kw">=&gt;</span> <span class="fu">onChange</span>(<span class="bu">event</span><span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">value</span>)<span class="va">}</span> <span class="kw">/&gt;</span></span>
<span id="cb270-9"><a href="#cb270-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;button</span> <span class="ot">onClick</span><span class="op">=</span><span class="va">{</span>(<span class="bu">event</span>) <span class="kw">=&gt;</span> <span class="fu">onCommit</span>(value)<span class="va">}</span><span class="kw">&gt;</span>new<span class="kw">&lt;/button&gt;</span></span>
<span id="cb270-10"><a href="#cb270-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/p&gt;</span></span>
<span id="cb270-11"><a href="#cb270-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb270-12"><a href="#cb270-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb270-13"><a href="#cb270-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb270-14"><a href="#cb270-14" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> {DateSubmit}</span></code></pre></div>
<p>Note the use of destructuring in <code>DateSubmit</code>’s parameter list; this was introduced in Section <a href="#s:pages-citations" data-reference-type="ref" data-reference="s:pages-citations">6.4</a> and is an easy way to pull values out of the <code>props</code> parameter.</p>
<p>It’s important to understand the order of operations in the example above. <code>value={value}</code> puts a value in the input box to display each time <code>DateSubmit</code> is called. We re-bind <code>onChange</code> and <code>onClick</code> to functions on each call as well (remember, JSX gets translated into function calls). So yes, this whole paragraph is being re-created every time someone types, but React and the browser work together to minimize recalculation.</p>
<p>Back to our application:</p>
<div class="sourceCode" id="cb271"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb271-1"><a href="#cb271-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ...imports as before...</span></span>
<span id="cb271-2"><a href="#cb271-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-3"><a href="#cb271-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> App <span class="kw">extends</span> React<span class="op">.</span><span class="at">Component</span> {</span>
<span id="cb271-4"><a href="#cb271-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-5"><a href="#cb271-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span> (props) {</span>
<span id="cb271-6"><a href="#cb271-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>(props)</span>
<span id="cb271-7"><a href="#cb271-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> {</span>
<span id="cb271-8"><a href="#cb271-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">newDate</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span></span>
<span id="cb271-9"><a href="#cb271-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">asteroids</span><span class="op">:</span> [</span>
<span id="cb271-10"><a href="#cb271-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">//...data as before...</span></span>
<span id="cb271-11"><a href="#cb271-11" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb271-12"><a href="#cb271-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb271-13"><a href="#cb271-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb271-14"><a href="#cb271-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-15"><a href="#cb271-15" aria-hidden="true" tabindex="-1"></a>  onEditNewDate <span class="op">=</span> (text) <span class="kw">=&gt;</span> {</span>
<span id="cb271-16"><a href="#cb271-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setState</span>({<span class="dt">newDate</span><span class="op">:</span> text})</span>
<span id="cb271-17"><a href="#cb271-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb271-18"><a href="#cb271-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-19"><a href="#cb271-19" aria-hidden="true" tabindex="-1"></a>  onSubmitNewDate <span class="op">=</span> (text) <span class="kw">=&gt;</span> {</span>
<span id="cb271-20"><a href="#cb271-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`new date </span><span class="sc">${</span>text<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb271-21"><a href="#cb271-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setState</span>({<span class="dt">newDate</span><span class="op">:</span> <span class="st">&#39;&#39;</span>})</span>
<span id="cb271-22"><a href="#cb271-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb271-23"><a href="#cb271-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-24"><a href="#cb271-24" aria-hidden="true" tabindex="-1"></a>  render <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb271-25"><a href="#cb271-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb271-26"><a href="#cb271-26" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;div&gt;</span></span>
<span id="cb271-27"><a href="#cb271-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;h1&gt;</span>Asteroids<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb271-28"><a href="#cb271-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">&lt;DateSubmit</span></span>
<span id="cb271-29"><a href="#cb271-29" aria-hidden="true" tabindex="-1"></a>          <span class="ot">label</span><span class="op">=</span><span class="st">&#39;Date&#39;</span></span>
<span id="cb271-30"><a href="#cb271-30" aria-hidden="true" tabindex="-1"></a>          <span class="ot">value</span><span class="op">=</span><span class="va">{</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">newDate</span><span class="va">}</span></span>
<span id="cb271-31"><a href="#cb271-31" aria-hidden="true" tabindex="-1"></a>          <span class="ot">onChange</span><span class="op">=</span><span class="va">{</span><span class="kw">this</span><span class="op">.</span><span class="at">onEditNewDate</span><span class="va">}</span></span>
<span id="cb271-32"><a href="#cb271-32" aria-hidden="true" tabindex="-1"></a>          <span class="ot">onCommit</span><span class="op">=</span><span class="va">{</span><span class="kw">this</span><span class="op">.</span><span class="at">onSubmitNewDate</span><span class="va">}</span> <span class="fu">/&gt;</span></span>
<span id="cb271-33"><a href="#cb271-33" aria-hidden="true" tabindex="-1"></a>        <span class="fu">&lt;AsteroidList</span> <span class="ot">asteroids</span><span class="op">=</span><span class="va">{</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">asteroids</span><span class="va">}</span> <span class="fu">/&gt;</span></span>
<span id="cb271-34"><a href="#cb271-34" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;/div&gt;</span></span>
<span id="cb271-35"><a href="#cb271-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb271-36"><a href="#cb271-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb271-37"><a href="#cb271-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb271-38"><a href="#cb271-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb271-39"><a href="#cb271-39" aria-hidden="true" tabindex="-1"></a><span class="co">// ...mount as before...</span></span></code></pre></div>
<p>It’s safe to pass <code>this.state.newDate</code> to <code>value</code> because we’re re-drawing each time there’s a change; remember, we’re passing a value for display, not a reference to be modified. And note that we are not doing any kind of validation: the user could type <code>abc123</code> as a date and we would blithely try to process it.</p>
<p>It’s now time to get real data, which we will do using <code>fetch</code> with a URL. This returns a promise (Chapter <a href="#s:promises" data-reference-type="ref" data-reference="s:promises">9</a>), so we’ll handle the result of the fetch in the promise’s <code>then</code> method, and then chain another <code>then</code> method to transform the data into what we need:</p>
<div class="sourceCode" id="cb272"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb272-1"><a href="#cb272-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ...previous code as before...</span></span>
<span id="cb272-2"><a href="#cb272-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-3"><a href="#cb272-3" aria-hidden="true" tabindex="-1"></a>  onSubmitNewDate <span class="op">=</span> (text) <span class="kw">=&gt;</span> {</span>
<span id="cb272-4"><a href="#cb272-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> url <span class="op">=</span> <span class="st">&#39;https://api.nasa.gov/neo/rest/v1/feed&#39;</span> <span class="op">+</span></span>
<span id="cb272-5"><a href="#cb272-5" aria-hidden="true" tabindex="-1"></a>                <span class="vs">`?api_key=DEMO_KEY&amp;start_date=</span><span class="sc">${</span>text<span class="sc">}</span><span class="vs">`</span></span>
<span id="cb272-6"><a href="#cb272-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fetch</span>(url)<span class="op">.</span><span class="fu">then</span>((response) <span class="kw">=&gt;</span> {</span>
<span id="cb272-7"><a href="#cb272-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> response<span class="op">.</span><span class="fu">json</span>()</span>
<span id="cb272-8"><a href="#cb272-8" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">then</span>((raw) <span class="kw">=&gt;</span> {</span>
<span id="cb272-9"><a href="#cb272-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> asteroids <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="fu">transform</span>(raw)</span>
<span id="cb272-10"><a href="#cb272-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">setState</span>({</span>
<span id="cb272-11"><a href="#cb272-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">newDate</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span></span>
<span id="cb272-12"><a href="#cb272-12" aria-hidden="true" tabindex="-1"></a>        <span class="dt">asteroids</span><span class="op">:</span> asteroids</span>
<span id="cb272-13"><a href="#cb272-13" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb272-14"><a href="#cb272-14" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb272-15"><a href="#cb272-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb272-16"><a href="#cb272-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb272-17"><a href="#cb272-17" aria-hidden="true" tabindex="-1"></a><span class="co">//...render as before...</span></span></code></pre></div>
<p>Line by line, the steps are:</p>
<ol>
<li><p>Build the URL for the data</p></li>
<li><p>Start to fetch data from that URL</p></li>
<li><p>Give a callback to execute when the data arrives</p></li>
<li><p>Give another callback to use when the data has been converted from text to JSON (which we will look at in more detail in Chapter <a href="#s:dataman" data-reference-type="ref" data-reference="s:dataman">11</a>).</p></li>
<li><p>Transform that data from its raw form into the objects we need</p></li>
<li><p>Set state</p></li>
</ol>
<p>Finally, the method to transform the data NASA gives us is:</p>
<div class="sourceCode" id="cb273"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb273-1"><a href="#cb273-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ...previous code as before...</span></span>
<span id="cb273-2"><a href="#cb273-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-3"><a href="#cb273-3" aria-hidden="true" tabindex="-1"></a>  transform <span class="op">=</span> (raw) <span class="kw">=&gt;</span> {</span>
<span id="cb273-4"><a href="#cb273-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> result <span class="op">=</span> []</span>
<span id="cb273-5"><a href="#cb273-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> key <span class="kw">in</span> raw<span class="op">.</span><span class="at">near_earth_objects</span>) {</span>
<span id="cb273-6"><a href="#cb273-6" aria-hidden="true" tabindex="-1"></a>      raw<span class="op">.</span><span class="at">near_earth_objects</span>[key]<span class="op">.</span><span class="fu">forEach</span>((asteroid) <span class="kw">=&gt;</span> {</span>
<span id="cb273-7"><a href="#cb273-7" aria-hidden="true" tabindex="-1"></a>        result<span class="op">.</span><span class="fu">push</span>({</span>
<span id="cb273-8"><a href="#cb273-8" aria-hidden="true" tabindex="-1"></a>          <span class="dt">name</span><span class="op">:</span> asteroid<span class="op">.</span><span class="at">name</span><span class="op">,</span></span>
<span id="cb273-9"><a href="#cb273-9" aria-hidden="true" tabindex="-1"></a>          <span class="dt">date</span><span class="op">:</span> asteroid<span class="op">.</span><span class="at">close_approach_data</span>[<span class="dv">0</span>]<span class="op">.</span><span class="at">close_approach_date</span><span class="op">,</span></span>
<span id="cb273-10"><a href="#cb273-10" aria-hidden="true" tabindex="-1"></a>          <span class="dt">diameter</span><span class="op">:</span> asteroid<span class="op">.</span><span class="at">estimated_diameter</span><span class="op">.</span><span class="at">meters</span><span class="op">.</span><span class="at">estimated_diameter_max</span><span class="op">,</span></span>
<span id="cb273-11"><a href="#cb273-11" aria-hidden="true" tabindex="-1"></a>          <span class="dt">distance</span><span class="op">:</span> asteroid<span class="op">.</span><span class="at">close_approach_data</span>[<span class="dv">0</span>]<span class="op">.</span><span class="at">miss_distance</span><span class="op">.</span><span class="at">kilometers</span></span>
<span id="cb273-12"><a href="#cb273-12" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb273-13"><a href="#cb273-13" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb273-14"><a href="#cb273-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb273-15"><a href="#cb273-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb273-16"><a href="#cb273-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb273-17"><a href="#cb273-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb273-18"><a href="#cb273-18" aria-hidden="true" tabindex="-1"></a><span class="co">// ...render as before...</span></span></code></pre></div>
<p>We built this by looking at the structure of the JSON that NASA returned and figuring out how to index the fields we need. (Unfortunately, the top level of <code>near_earth_objects</code> is an object with dates as keys rather than an array, so we have to use <code>let... in...</code> rather than purely <code>map</code> or <code>forEach</code>.)</p>
<h2 id="s:interactive-exercises">Exercises</h2>
<h3 class="unnumbered" id="reset">Reset</h3>
<p>Add a “reset” button to the counter application that always sets the counter’s value to zero. Does using it to wipe out every change you’ve made to the counter feel like a metaphor for programming in general?</p>
<h3 class="unnumbered" id="transform">Transform</h3>
<p>Modify all of the examples <em>after</em> the introduction of Babel to use external scripts rather than in-pace scripts.</p>
<h3 class="unnumbered" id="exports">Exports</h3>
<p>Are the curly braces necessary when exporting from a component file? What happens if you remove them? Read this <a href="http://2ality.com/2014/09/es6-modules-final.html">blogpost</a> and then consider whether it might have been more appropriate to use default exports and imports in the examples above.</p>
<h3 class="unnumbered" id="validation">Validation</h3>
<p>Modify the application so that if the starting date isn’t valid when the button is clicked, the application displays a warning message instead of fetching data.</p>
<ol>
<li><p>Add a field called <code>validDate</code> to the state and initialize it to <code>true</code>.</p></li>
<li><p>Add an <code>ErrorMessage</code> component that displays a paragraph containing either “date OK” or “date invalid” depending on the value of <code>validDate</code>.</p></li>
<li><p>Modify <code>onSubmitNewDate</code> so that it <em>either</em> fetches new data <em>or</em> modifies <code>validDate</code>.</p></li>
</ol>
<p>Once you are done, search the Internet for React validation and error messages and explore other tools you could use to do this.</p>
<h2 class="unnumbered" id="key-points-9">Key Points</h2>
<ul>
<li><p>Define event handlers to specify what actions the browser should take when the user interacts with an application.</p></li>
<li><p>The browser passes event objects containing details of events to event handlers.</p></li>
<li><p>Use classes to keep state and event handlers together.</p></li>
<li><p>React calls a class’s <code>render</code> to display it.</p></li>
<li><p>Separate models (which store data) from views (which display it).</p></li>
<li><p>Use <code>fetch</code> to get data from servers.</p></li>
<li><p>Use destructuring to get individual members from an object in a single step.</p></li>
<li><p>Modern JavaScript uses promises to manage asynchronous activities.</p></li>
</ul>
<h1 id="s:dataman">Managing Data</h1>
<p>There’s not much point creating interactive web pages if they don’t have something to interact with. To provide that, we need something to store data and something to serve it. We could build one program to do both, but experience teaches that it’s better to create one for each so that they are easier to understand, test, and maintain. After tossing a coin, we decide to start with the data store; Chapter <a href="#s:server" data-reference-type="ref" data-reference="s:server">12</a> will look at how to build a server.</p>
<h2 id="s:dataman-formats">Data Formats</h2>
<p>The most widely used text format for tabular data is undoubtedly <a href="#g:csv"><strong>comma-separated values</strong></a> (CSV). Each row of the table is a line in the file; the values within each row—i.e., the columns—are separated by commas. Numbers appear as themselves; strings may or may not be wrapped in quotation marks, unless they contain commas themselves, in which case they definitely are:</p>
<pre class="text"><code>&quot;maroon&quot;,128,0,0
&quot;olive&quot;,128,128,0
&quot;aqua&quot;,0,255,255
&quot;fuchsia&quot;,255,0,255</code></pre>
<p>The first line of a CSV file is often a <a href="#g:header-row"><strong>header row</strong></a> that defines the names of the columns. For example, the small table shown above would better be represented as:</p>
<pre class="text"><code>&quot;name&quot;,&quot;red&quot;,&quot;green&quot;,&quot;blue&quot;
&quot;maroon&quot;,128,0,0
&quot;olive&quot;,128,128,0
&quot;aqua&quot;,0,255,255
&quot;fuchsia&quot;,255,0,255</code></pre>
<p>Tragically, CSV doesn’t require the first row to be a header, and CSV files usually don’t specify units or data types. We can guess that the values in the table above are integers, but it’s all too common to have a CSV file whose columns are labelled “height” and “weight” without any indication of whether the heights are in feet or meters or the weights in pounds or kilograms.</p>
<p>CSV is good for tabular data, but a lot of data doesn’t neatly fit into rows and columns. Many programmers use <a href="#g:json"><strong>JSON</strong></a> instead: it supports a subset of the syntax for values, arrays, and objects in JavaScript, so that (for example) we can store configuration values for a program like this:</p>
<div class="sourceCode" id="cb276"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb276-1"><a href="#cb276-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb276-2"><a href="#cb276-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;name&quot;</span> <span class="op">:</span> <span class="st">&quot;DataExplorer&quot;</span><span class="op">,</span></span>
<span id="cb276-3"><a href="#cb276-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;version&quot;</span> <span class="op">:</span> <span class="st">&quot;1.2.1&quot;</span><span class="op">,</span></span>
<span id="cb276-4"><a href="#cb276-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;preferences&quot;</span> <span class="op">:</span> {</span>
<span id="cb276-5"><a href="#cb276-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;colorscheme&quot;</span> <span class="op">:</span> <span class="st">&quot;dark&quot;</span><span class="op">,</span></span>
<span id="cb276-6"><a href="#cb276-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;autofill&quot;</span> <span class="op">:</span> <span class="kw">true</span></span>
<span id="cb276-7"><a href="#cb276-7" aria-hidden="true" tabindex="-1"></a>  }<span class="op">,</span></span>
<span id="cb276-8"><a href="#cb276-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;last_opened&quot;</span> <span class="op">:</span> [</span>
<span id="cb276-9"><a href="#cb276-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;raw/biotic.dat&quot;</span><span class="op">,</span></span>
<span id="cb276-10"><a href="#cb276-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;raw/genomic.dat&quot;</span><span class="op">,</span></span>
<span id="cb276-11"><a href="#cb276-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;cooked/inferred.dat&quot;</span></span>
<span id="cb276-12"><a href="#cb276-12" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb276-13"><a href="#cb276-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>JSON can be used for tabular data as well. The whole table is an array, and each record is an object with name-value pairs:</p>
<div class="sourceCode" id="cb277"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> colors <span class="op">=</span> [</span>
<span id="cb277-2"><a href="#cb277-2" aria-hidden="true" tabindex="-1"></a>  {<span class="st">&quot;name&quot;</span><span class="op">:</span> <span class="st">&quot;maroon&quot;</span><span class="op">,</span> <span class="st">&quot;red&quot;</span><span class="op">:</span> <span class="dv">128</span><span class="op">,</span> <span class="st">&quot;green&quot;</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="st">&quot;blue&quot;</span><span class="op">:</span> <span class="dv">0</span>}<span class="op">,</span></span>
<span id="cb277-3"><a href="#cb277-3" aria-hidden="true" tabindex="-1"></a>  {<span class="st">&quot;name&quot;</span><span class="op">:</span> <span class="st">&quot;olive&quot;</span><span class="op">,</span> <span class="st">&quot;red&quot;</span><span class="op">:</span> <span class="dv">128</span><span class="op">,</span> <span class="st">&quot;green&quot;</span><span class="op">:</span> <span class="dv">128</span><span class="op">,</span> <span class="st">&quot;blue&quot;</span><span class="op">:</span> <span class="dv">0</span>}<span class="op">,</span></span>
<span id="cb277-4"><a href="#cb277-4" aria-hidden="true" tabindex="-1"></a>  {<span class="st">&quot;name&quot;</span><span class="op">:</span> <span class="st">&quot;aqua&quot;</span><span class="op">,</span> <span class="st">&quot;red&quot;</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="st">&quot;green&quot;</span><span class="op">:</span> <span class="dv">255</span><span class="op">,</span> <span class="st">&quot;blue&quot;</span><span class="op">:</span> <span class="dv">255</span>}<span class="op">,</span></span>
<span id="cb277-5"><a href="#cb277-5" aria-hidden="true" tabindex="-1"></a>  {<span class="st">&quot;name&quot;</span><span class="op">:</span> <span class="st">&quot;fuchsia&quot;</span><span class="op">,</span> <span class="st">&quot;red&quot;</span><span class="op">:</span> <span class="dv">255</span><span class="op">,</span> <span class="st">&quot;green&quot;</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="st">&quot;blue&quot;</span><span class="op">:</span> <span class="dv">255</span>}</span>
<span id="cb277-6"><a href="#cb277-6" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
<p>Repeating field names like this is wasteful compared to listing them once at the top of a table, but it does mean that the fields within rows can be accessed directly using expressions like <code>colors[1].red</code>.</p>
<h2 id="s:dataman-slicing">Slicing Data</h2>
<p>The data we will use as an example is available in a variety of formats from the <a href="https://figshare.com/articles/Portal_Project_Teaching_Database/1314459">Portal Project Teaching Database</a>. We will focus on <code>surveys.csv</code>, which has over 35,500 records. That’s a lot to look at, so we will create a 10-record slice for testing.</p>
<p>Although it would be easy to take the first ten, or the last, there’s a good chance that neither would be representative of the data as a whole. Instead, we will write a little script that selects some records at random. Since it doesn’t need to be efficient, we will read everything, pair each line with a random number, sort the lines using those random numbers as keys, then take the top few lines.</p>
<div class="sourceCode" id="cb278"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb278-1"><a href="#cb278-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;fs&#39;</span>)</span>
<span id="cb278-2"><a href="#cb278-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb278-3"><a href="#cb278-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> [inputFile<span class="op">,</span> numLines<span class="op">,</span> outputFile] <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">argv</span><span class="op">.</span><span class="fu">splice</span>(<span class="dv">2</span>)</span>
<span id="cb278-4"><a href="#cb278-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> lines <span class="op">=</span> fs<span class="op">.</span><span class="fu">readFileSync</span>(inputFile<span class="op">,</span> <span class="st">&#39;utf-8&#39;</span>)</span>
<span id="cb278-5"><a href="#cb278-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">split</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>)</span>
<span id="cb278-6"><a href="#cb278-6" aria-hidden="true" tabindex="-1"></a>header <span class="op">=</span> lines[<span class="dv">0</span>]</span>
<span id="cb278-7"><a href="#cb278-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> sample <span class="op">=</span> lines<span class="op">.</span><span class="fu">slice</span>(<span class="dv">1</span>)</span>
<span id="cb278-8"><a href="#cb278-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(line <span class="kw">=&gt;</span> [<span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>()<span class="op">,</span> line])</span>
<span id="cb278-9"><a href="#cb278-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">sort</span>((left<span class="op">,</span> right) <span class="kw">=&gt;</span> { <span class="cf">return</span> left[<span class="dv">0</span>] <span class="op">-</span> right[<span class="dv">0</span>] })</span>
<span id="cb278-10"><a href="#cb278-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> <span class="pp">parseInt</span>(numLines))</span>
<span id="cb278-11"><a href="#cb278-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(pair <span class="kw">=&gt;</span> pair[<span class="dv">1</span>])</span>
<span id="cb278-12"><a href="#cb278-12" aria-hidden="true" tabindex="-1"></a>fs<span class="op">.</span><span class="fu">writeFileSync</span>(outputFile<span class="op">,</span> header <span class="op">+</span> <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span> <span class="op">+</span> sample<span class="op">.</span><span class="fu">join</span>(<span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span>))</span></code></pre></div>
<p>When we run this on the command line:</p>
<pre class="shell"><code>$ node select-random.js ../../data/surveys.csv 10 slice.csv</code></pre>
<p>we get:</p>
<pre class="text"><code>record_id,month,day,year,plot_id,species_id,sex,hindfoot_length,weight
18501,3,14,1991,13,OT,M,21,28
2283,1,15,1980,11,OL,M,21,23
19941,5,2,1992,1,PP,M,22,13
27413,12,29,1997,5,,,,
16002,5,9,1989,19,SC,,,
28813,11,21,1998,12,DO,M,35,56
9338,7,4,1984,11,DO,F,35,57
28336,8,22,1998,7,PB,M,26,23
25323,3,16,1997,9,DM,F,33,26
6785,10,23,1982,5,DM,F,37,45</code></pre>
<p>Running it again will probably generate a different data slice, since we’re not specifying a random number generation <a href="#g:seed"><strong>seed</strong></a>. We are bad people, and will fix this in the exercises.</p>
<blockquote>
<h4 id="slicing-command-line-arguments" class="unnumbered">Slicing Command-Line Arguments</h4>
<p>When we run:</p>
<pre class="shell"><code>$ node select-random.js ../../data/surveys.csv 10 slice.csv</code></pre>
<p>the array <code>process.argv</code> contains five strings: the <code>node</code> command, the name of our script <code>select-random.js</code>, and then the name of the input file, the number of lines we can, and the name of the output file. <code>process.argv.slice(2)</code> discards elements 0 and 1 from this list, leaving us the three values we need to assign to <code>inputFile</code>, <code>numLines</code>, and <code>outputFile</code> respectively. We will explore a better way to do this in the exercises.</p>
</blockquote>
<h2 id="s:dataman-manager">Data Manager</h2>
<p>Rather arbitrarily, we decide that our data manager will be able to answer two questions:</p>
<ol>
<li><p>How many records do we have and what range of years do they cover? This is the kind of opening question that many client programs will ask.</p></li>
<li><p>What are the minimum, average, and maximum values for weight and hindfoot length by year for a given range of years? This would be very specific to a particular kind of client program; a good service would either provide many such specialized queries or provide a way to apply common <a href="#g:aggregation-function"><strong>aggregation functions</strong></a> to particular columns.</p></li>
</ol>
<p>We will use <a href="https://www.papaparse.com/">PapaParse</a> to parse our CSV, so our first step is to install it:</p>
<pre class="shell"><code>$ npm install papaparse</code></pre>
<p>After loading the library and reading our test data file a couple of times, we break down and read the documentation, then come up with this as the first version of our data manager:</p>
<div class="sourceCode" id="cb283"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;fs&#39;</span>)</span>
<span id="cb283-2"><a href="#cb283-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> papa <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;papaparse&#39;</span>)</span>
<span id="cb283-3"><a href="#cb283-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-4"><a href="#cb283-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataManager {</span>
<span id="cb283-5"><a href="#cb283-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-6"><a href="#cb283-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span> (filename) {</span>
<span id="cb283-7"><a href="#cb283-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> raw <span class="op">=</span> fs<span class="op">.</span><span class="fu">readFileSync</span>(filename<span class="op">,</span> <span class="st">&#39;utf-8&#39;</span>)</span>
<span id="cb283-8"><a href="#cb283-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> options <span class="op">=</span> {<span class="dt">header</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> <span class="dt">dynamicTyping</span><span class="op">:</span> <span class="kw">true</span>}</span>
<span id="cb283-9"><a href="#cb283-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">data</span> <span class="op">=</span> papa<span class="op">.</span><span class="fu">parse</span>(raw<span class="op">,</span> options)<span class="op">.</span><span class="at">data</span></span>
<span id="cb283-10"><a href="#cb283-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb283-11"><a href="#cb283-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb283-12"><a href="#cb283-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb283-13"><a href="#cb283-13" aria-hidden="true" tabindex="-1"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> DataManager</span></code></pre></div>
<p><code>papa.parse</code> takes two arguments: the CSV file to be parsed and a configuration object that controls how the parser behaves. This configuration object is highly customizable.; here, our <code>options</code> instruct the parser to interpret the first row as a header (which sets column names) and to convert things that look like numbers to numbers (the <code>dynamicTyping</code> option). The output of <code>papa.parse</code> looks like this:</p>
<div class="sourceCode" id="cb284"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb284-1"><a href="#cb284-1" aria-hidden="true" tabindex="-1"></a>{ <span class="dt">data</span><span class="op">:</span></span>
<span id="cb284-2"><a href="#cb284-2" aria-hidden="true" tabindex="-1"></a>   [ { <span class="dt">record_id</span><span class="op">:</span> <span class="dv">18501</span><span class="op">,</span></span>
<span id="cb284-3"><a href="#cb284-3" aria-hidden="true" tabindex="-1"></a>       <span class="dt">month</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb284-4"><a href="#cb284-4" aria-hidden="true" tabindex="-1"></a>       <span class="dt">day</span><span class="op">:</span> <span class="dv">14</span><span class="op">,</span></span>
<span id="cb284-5"><a href="#cb284-5" aria-hidden="true" tabindex="-1"></a>       <span class="dt">year</span><span class="op">:</span> <span class="dv">1991</span><span class="op">,</span></span>
<span id="cb284-6"><a href="#cb284-6" aria-hidden="true" tabindex="-1"></a>       <span class="dt">plot_id</span><span class="op">:</span> <span class="dv">13</span><span class="op">,</span></span>
<span id="cb284-7"><a href="#cb284-7" aria-hidden="true" tabindex="-1"></a>       <span class="dt">species_id</span><span class="op">:</span> <span class="st">&#39;OT&#39;</span><span class="op">,</span></span>
<span id="cb284-8"><a href="#cb284-8" aria-hidden="true" tabindex="-1"></a>       <span class="dt">sex</span><span class="op">:</span> <span class="st">&#39;M&#39;</span><span class="op">,</span></span>
<span id="cb284-9"><a href="#cb284-9" aria-hidden="true" tabindex="-1"></a>       <span class="dt">hindfoot_length</span><span class="op">:</span> <span class="dv">21</span><span class="op">,</span></span>
<span id="cb284-10"><a href="#cb284-10" aria-hidden="true" tabindex="-1"></a>       <span class="dt">weight</span><span class="op">:</span> <span class="dv">28</span> }<span class="op">,</span></span>
<span id="cb284-11"><a href="#cb284-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb284-12"><a href="#cb284-12" aria-hidden="true" tabindex="-1"></a>     <span class="op">...</span>eight more records<span class="op">...</span></span>
<span id="cb284-13"><a href="#cb284-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb284-14"><a href="#cb284-14" aria-hidden="true" tabindex="-1"></a>     { <span class="dt">record_id</span><span class="op">:</span> <span class="dv">6785</span><span class="op">,</span></span>
<span id="cb284-15"><a href="#cb284-15" aria-hidden="true" tabindex="-1"></a>       <span class="dt">month</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb284-16"><a href="#cb284-16" aria-hidden="true" tabindex="-1"></a>       <span class="dt">day</span><span class="op">:</span> <span class="dv">23</span><span class="op">,</span></span>
<span id="cb284-17"><a href="#cb284-17" aria-hidden="true" tabindex="-1"></a>       <span class="dt">year</span><span class="op">:</span> <span class="dv">1982</span><span class="op">,</span></span>
<span id="cb284-18"><a href="#cb284-18" aria-hidden="true" tabindex="-1"></a>       <span class="dt">plot_id</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span></span>
<span id="cb284-19"><a href="#cb284-19" aria-hidden="true" tabindex="-1"></a>       <span class="dt">species_id</span><span class="op">:</span> <span class="st">&#39;DM&#39;</span><span class="op">,</span></span>
<span id="cb284-20"><a href="#cb284-20" aria-hidden="true" tabindex="-1"></a>       <span class="dt">sex</span><span class="op">:</span> <span class="st">&#39;F&#39;</span><span class="op">,</span></span>
<span id="cb284-21"><a href="#cb284-21" aria-hidden="true" tabindex="-1"></a>       <span class="dt">hindfoot_length</span><span class="op">:</span> <span class="dv">37</span><span class="op">,</span></span>
<span id="cb284-22"><a href="#cb284-22" aria-hidden="true" tabindex="-1"></a>       <span class="dt">weight</span><span class="op">:</span> <span class="dv">45</span> } ]<span class="op">,</span></span>
<span id="cb284-23"><a href="#cb284-23" aria-hidden="true" tabindex="-1"></a>  <span class="dt">errors</span><span class="op">:</span> []<span class="op">,</span></span>
<span id="cb284-24"><a href="#cb284-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">meta</span><span class="op">:</span></span>
<span id="cb284-25"><a href="#cb284-25" aria-hidden="true" tabindex="-1"></a>   { <span class="dt">delimiter</span><span class="op">:</span> <span class="st">&#39;,&#39;</span><span class="op">,</span></span>
<span id="cb284-26"><a href="#cb284-26" aria-hidden="true" tabindex="-1"></a>     <span class="dt">linebreak</span><span class="op">:</span> <span class="st">&#39;</span><span class="sc">\n</span><span class="st">&#39;</span><span class="op">,</span></span>
<span id="cb284-27"><a href="#cb284-27" aria-hidden="true" tabindex="-1"></a>     <span class="dt">aborted</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb284-28"><a href="#cb284-28" aria-hidden="true" tabindex="-1"></a>     <span class="dt">truncated</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb284-29"><a href="#cb284-29" aria-hidden="true" tabindex="-1"></a>     <span class="dt">cursor</span><span class="op">:</span> <span class="dv">350</span><span class="op">,</span></span>
<span id="cb284-30"><a href="#cb284-30" aria-hidden="true" tabindex="-1"></a>     <span class="dt">fields</span><span class="op">:</span></span>
<span id="cb284-31"><a href="#cb284-31" aria-hidden="true" tabindex="-1"></a>      [ <span class="st">&#39;record_id&#39;</span><span class="op">,</span></span>
<span id="cb284-32"><a href="#cb284-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;month&#39;</span><span class="op">,</span></span>
<span id="cb284-33"><a href="#cb284-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;day&#39;</span><span class="op">,</span></span>
<span id="cb284-34"><a href="#cb284-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;year&#39;</span><span class="op">,</span></span>
<span id="cb284-35"><a href="#cb284-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;plot_id&#39;</span><span class="op">,</span></span>
<span id="cb284-36"><a href="#cb284-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;species_id&#39;</span><span class="op">,</span></span>
<span id="cb284-37"><a href="#cb284-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;sex&#39;</span><span class="op">,</span></span>
<span id="cb284-38"><a href="#cb284-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;hindfoot_length&#39;</span><span class="op">,</span></span>
<span id="cb284-39"><a href="#cb284-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;weight&#39;</span> ] } }</span></code></pre></div>
<p>so <code>papa.parse(raw, options).data</code> gets the data we want as JSON. Let’s write a method to get some overall statistics:</p>
<div class="sourceCode" id="cb285"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb285-1"><a href="#cb285-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getSurveyStats</span> () {</span>
<span id="cb285-2"><a href="#cb285-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb285-3"><a href="#cb285-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">year_low</span> <span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">_get</span>(<span class="kw">this</span><span class="op">.</span><span class="at">data</span><span class="op">,</span> <span class="st">&#39;year&#39;</span><span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>)<span class="op">,</span></span>
<span id="cb285-4"><a href="#cb285-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">year_high</span> <span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">_get</span>(<span class="kw">this</span><span class="op">.</span><span class="at">data</span><span class="op">,</span> <span class="st">&#39;year&#39;</span><span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>)<span class="op">,</span></span>
<span id="cb285-5"><a href="#cb285-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">record_count</span> <span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="at">length</span></span>
<span id="cb285-6"><a href="#cb285-6" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb285-7"><a href="#cb285-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb285-8"><a href="#cb285-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb285-9"><a href="#cb285-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...other methods...</span></span>
<span id="cb285-10"><a href="#cb285-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb285-11"><a href="#cb285-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">_get</span>(values<span class="op">,</span> field<span class="op">,</span> func) {</span>
<span id="cb285-12"><a href="#cb285-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">func</span>(<span class="op">...</span>values<span class="op">.</span><span class="fu">map</span>(rec <span class="kw">=&gt;</span> rec[field])<span class="op">.</span><span class="fu">filter</span>(val <span class="kw">=&gt;</span> <span class="op">!</span><span class="pp">isNaN</span>(val)))</span>
<span id="cb285-13"><a href="#cb285-13" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>Functions like <code>Math.min</code> and <code>Math.max</code> take any number of scalar values as arguments, but do not directly process arrays. Enter <a href="#g:spread-syntax"><strong>spread syntax</strong></a> <code>...</code>: the notation <code>func(...array)</code> means “pass all the values in the array as separate arguments”, which saves us from writing our own minimum and maximum functions. Thus, <code>func(...this.data.map(rec =&gt; rec[field]))</code> means “select the specified field from each record in <code>this.data</code> to create an array of fields, then pass all of those values as arguments to <code>func</code>. We include an underscore at the start of the name of <code>_get</code> to indicate that we intend it to be used only inside <code>DataManager</code> and not to be called elsewhere.</p>
<p>Adding the method to get weight and hindfoot length for a range of years is comparatively straightforward. First, we write a function to calculate the average of one or more arguments:</p>
<div class="sourceCode" id="cb286"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> _average <span class="op">=</span> (<span class="op">...</span>values) <span class="kw">=&gt;</span> {</span>
<span id="cb286-2"><a href="#cb286-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> sum <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb286-3"><a href="#cb286-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> v <span class="kw">of</span> values) {</span>
<span id="cb286-4"><a href="#cb286-4" aria-hidden="true" tabindex="-1"></a>    sum <span class="op">+=</span> v</span>
<span id="cb286-5"><a href="#cb286-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb286-6"><a href="#cb286-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> sum <span class="op">/</span> values<span class="op">.</span><span class="at">length</span></span>
<span id="cb286-7"><a href="#cb286-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>It would be more natural for <code>_average</code> to take an array rather than a variable number of arguments, but we want to be able to use it in the same way that we use <code>Math.min</code> and <code>Math.max</code>, so we have to conform to their signature.</p>
<p>After some thought we realize that it’s possible for <code>subset</code> to be empty—i.e., it’s possible that there are years that have no data in our dataset. We should filter these out, to prevent unnecessary effort being made to render summary statistics with <code>NaN</code> values. Remembering that empty arrays are not falsy in JavaScript (Chapter <a href="#s:basics" data-reference-type="ref" data-reference="s:basics">2</a>), we decide to test that the <code>subset</code> returned by filtering for each year contains at least one entry.</p>
<p>The last thing that we need to ensure is that each data object has a unique key, which will make it much easier for React to efficiently update the display of the data when we are ready to render it.</p>
<p>The method to get the values for a range of years is now:</p>
<div class="sourceCode" id="cb287"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb287-1"><a href="#cb287-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getSurveyRange</span> (minYear<span class="op">,</span> maxYear) {</span>
<span id="cb287-2"><a href="#cb287-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">Array</span>(<span class="dv">1</span> <span class="op">+</span> maxYear <span class="op">-</span> minYear)</span>
<span id="cb287-3"><a href="#cb287-3" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">fill</span>(<span class="dv">0</span>)</span>
<span id="cb287-4"><a href="#cb287-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">map</span>((v<span class="op">,</span> i) <span class="kw">=&gt;</span> minYear <span class="op">+</span> i)</span>
<span id="cb287-5"><a href="#cb287-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">map</span>(year <span class="kw">=&gt;</span> {</span>
<span id="cb287-6"><a href="#cb287-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> subset <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="fu">filter</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">year</span> <span class="op">===</span> year)</span>
<span id="cb287-7"><a href="#cb287-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (subset<span class="op">.</span><span class="at">length</span>) {</span>
<span id="cb287-8"><a href="#cb287-8" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> {</span>
<span id="cb287-9"><a href="#cb287-9" aria-hidden="true" tabindex="-1"></a>            <span class="dt">key</span>  <span class="op">:</span> <span class="fu">toString</span>(year)<span class="op">,</span></span>
<span id="cb287-10"><a href="#cb287-10" aria-hidden="true" tabindex="-1"></a>            <span class="dt">year</span> <span class="op">:</span> year<span class="op">,</span></span>
<span id="cb287-11"><a href="#cb287-11" aria-hidden="true" tabindex="-1"></a>            <span class="dt">min_hindfoot_length</span> <span class="op">:</span><span class="kw">this</span><span class="op">.</span><span class="fu">_get</span>(subset<span class="op">,</span></span>
<span id="cb287-12"><a href="#cb287-12" aria-hidden="true" tabindex="-1"></a>                                           <span class="st">&#39;hindfoot_length&#39;</span><span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>)<span class="op">,</span></span>
<span id="cb287-13"><a href="#cb287-13" aria-hidden="true" tabindex="-1"></a>            <span class="dt">ave_hindfoot_length</span> <span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">_get</span>(subset<span class="op">,</span></span>
<span id="cb287-14"><a href="#cb287-14" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">&#39;hindfoot_length&#39;</span><span class="op">,</span> _average)<span class="op">,</span></span>
<span id="cb287-15"><a href="#cb287-15" aria-hidden="true" tabindex="-1"></a>            <span class="dt">max_hindfoot_length</span> <span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">_get</span>(subset<span class="op">,</span></span>
<span id="cb287-16"><a href="#cb287-16" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">&#39;hindfoot_length&#39;</span><span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>)<span class="op">,</span></span>
<span id="cb287-17"><a href="#cb287-17" aria-hidden="true" tabindex="-1"></a>            <span class="dt">min_weight</span> <span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">_get</span>(subset<span class="op">,</span> <span class="st">&#39;weight&#39;</span><span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>)<span class="op">,</span></span>
<span id="cb287-18"><a href="#cb287-18" aria-hidden="true" tabindex="-1"></a>            <span class="dt">ave_weight</span> <span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">_get</span>(subset<span class="op">,</span> <span class="st">&#39;weight&#39;</span><span class="op">,</span> _average)<span class="op">,</span></span>
<span id="cb287-19"><a href="#cb287-19" aria-hidden="true" tabindex="-1"></a>            <span class="dt">max_weight</span> <span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">_get</span>(subset<span class="op">,</span> <span class="st">&#39;weight&#39;</span><span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">max</span>)</span>
<span id="cb287-20"><a href="#cb287-20" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb287-21"><a href="#cb287-21" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb287-22"><a href="#cb287-22" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb287-23"><a href="#cb287-23" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<h2 id="s:dataman-exercises">Exercises</h2>
<h3 class="unnumbered" id="tracing-data">Tracing Data</h3>
<p>Trace the execution of the utility program that creates a small sample of the original data, explaining what is passed into each of the chained methods calls.</p>
<h3 class="unnumbered" id="unrandom">Unrandom</h3>
<p>Programs that rely on random numbers are impossible to test because there’s (deliberately) no way to predict their output. Luckily, computer programs don’t actually use random numbers: they use <a href="#g:pseudo-random-number"><strong>pseudo-random numbers</strong></a> that are generated in a repeatable but unpredictable way. Given the same initial <a href="#g:seed"><strong>seed</strong></a>, a pseudo-random number generator will always produce the same sequence of values.</p>
<p>There is no way to set a seed for <code>Math.random</code> out of the box, but the <a href="https://www.npmjs.com/package/seedrandom">seedrandom</a> package provides an add-on function for this purpose. Install the package and modify the slice selection utility so that it takes a word or phrase as a command-line argument and uses it to seed the random number generator.</p>
<h3 class="unnumbered" id="one-record-per-year">One Record Per Year</h3>
<p>Another way to slice the data for testing purposes is to select one record from each year. Write a small command-line JavaScript program that:</p>
<ol>
<li><p>Reads all the data from the CSV.</p></li>
<li><p>Keeps the first record it finds for each year.</p></li>
<li><p>Prints these records formatted as SQL <code>insert</code> statements.</p></li>
</ol>
<h3 class="unnumbered" id="error-handling">Error Handling</h3>
<p>Modify <code>DataManager</code>’s constructor so that it checks for errors.</p>
<h3 class="unnumbered" id="generalization">Generalization</h3>
<p>Modify <code>getSurveyRange</code> so that it can be called like this:</p>
<div class="sourceCode" id="cb288"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb288-1"><a href="#cb288-1" aria-hidden="true" tabindex="-1"></a><span class="fu">getSurveyRange</span>(minYear<span class="op">,</span> maxYear<span class="op">,</span> <span class="st">&#39;hindfoot_length&#39;</span><span class="op">,</span> <span class="st">&#39;weight&#39;</span>)</span></code></pre></div>
<p>i.e., so that the names of the fields whose minimum, average, and maximum values are wanted can be passed as strings, and the method will automatically create the right names and values in its result.</p>
<h3 class="unnumbered" id="handling-command-line-arguments">Handling Command-Line Arguments</h3>
<p>Read the documentation for the <a href="https://www.npmjs.com/package/command-line-args"><code>command-line-args</code></a> package and rewrite the data slicing script to use it instead of <code>process.argv.slice</code>.</p>
<h2 class="unnumbered" id="key-points-10">Key Points</h2>
<ul>
<li><p>Small tabular datasets are commonly stored as Comma-Separated Values (CSV).</p></li>
<li><p>CSV can only represent regular data, and CSV files usually don’t include units.</p></li>
<li><p>Nested data is commonly stored using JavaScript Object Notation (JSON).</p></li>
<li><p>JSON representations of tabular data often include redundant (and therefore possibly inconsistent) specifications of column names.</p></li>
<li><p>PapaParse is a robust CSV parsing library that produces JSON output.</p></li>
</ul>
<h1 id="s:server">Creating a Server</h1>
<p>Now that we have a data manager (Chapter <a href="#s:dataman" data-reference-type="ref" data-reference="s:dataman">11</a>) the next step is to create a server to share our data with the world, which we will build using a library called <a href="https://expressjs.com/">Express</a>. Before we start writing code, though, we need to understand how computers talk to each other.</p>
<h2 id="s:server-http">HTTP</h2>
<p>Almost everything on the web communicates via the HyperText Transfer Protocol (<a href="#g:http"><strong>HTTP</strong></a>). The core of HTTP is a <a href="#g:http-request"><strong>request</strong></a>/<a href="#g:http-response"><strong>response</strong></a> cycle that specifies the kinds of requests applications can make of servers, how they exchange data, and so on. Figure <a href="#f:server-cycle" data-reference-type="ref" data-reference="f:server-cycle">12.1</a> shows this cycle in action for a page that includes one image.</p>
<figure>
<img src="figures/server-cycle.svg" id="f:server-cycle" /><figcaption aria-hidden="true"><span>HTTP Request/Response Cycle</span><span id="f:server-cycle" label="f:server-cycle">[f:server-cycle]</span></figcaption>
</figure>
<ol>
<li><p>The client (a browser or some other program) makes a connection to a server.</p></li>
<li><p>It then sends a blob of text specifying what it’s asking for.</p></li>
<li><p>The server replies with a blob of text and the HTML.</p></li>
<li><p>The connection is closed.</p></li>
<li><p>The client parses the text and realizes it needs an image.</p></li>
<li><p>It sends another blob of text to the server asking for that image.</p></li>
<li><p>The server replies with a blob of text and the contents of the image file.</p></li>
<li><p>The connection is closed.</p></li>
</ol>
<p>This cycle might be repeated many times to display a single web page, since a separate request has to be made for every image, every CSS or JavaScript file, and so on. In practice, a lot of behind-the-scenes engineering is done to keep connections alive as long as they’re needed, and to <a href="#g:cache"><strong>cache</strong></a> items that are likely to be re-used.</p>
<p>An HTTP request is just a block of text with two important parts:</p>
<ul>
<li><p>The <a href="#g:http-method"><strong>method</strong></a> is almost always either <code>GET</code> (to get data) or <code>POST</code> (to submit data).</p></li>
<li><p>The <a href="#g:url"><strong>URL</strong></a> is typically a path to a file, but as we’ll see below, it’s completely up to the server to interpret it.</p></li>
</ul>
<p>The request can also contain <a href="#g:http-header"><strong>headers</strong></a>, which are key-value pairs with more information about what the client wants. Some examples include:</p>
<ul>
<li><p><code>"Accept: text/html"</code> to specify that the client wants HTML</p></li>
<li><p><code>"Accept-Language: fr, en"</code> to specify that the client prefers French, but will accept English</p></li>
<li><p><code>"If-Modified-Since: 16-May-2018"</code> to tell the server that the client is only interested in recent data</p></li>
</ul>
<p>Unlike a dictionary, a key may appear any number of times, which allows a request to do things like specify that it’s willing to accept several types of content. The <a href="#g:body-http"><strong>body</strong></a> of the request is any extra data associated with it, such as files that are being uploaded. If a body is present, the request must contain the <code>Content-Length</code> header so that the server knows how much data to read (Figure <a href="#f:server-request" data-reference-type="ref" data-reference="f:server-request">12.2</a>).</p>
<figure>
<img src="figures/server-request.svg" id="f:server-request" /><figcaption aria-hidden="true"><span>Structure of an HTTP Request</span><span id="f:server-request" label="f:server-request">[f:server-request]</span></figcaption>
</figure>
<p>The headers and body in an HTTP response have the same form, and mean the same thing. Crucially, the response also includes a <a href="#g:http-status-code"><strong>status code</strong></a> to indicate what happened: 200 for OK, 404 for “page not found”, and so on. Some of the more common are shown in Table <a href="#t:server-codes" data-reference-type="ref" data-reference="t:server-codes">12.1</a>.</p>
<div id="t:server-codes">
<table class="table table-striped">
<caption><span>HTTP Status Codes</span><span id="t:server-codes" label="t:server-codes">[t:server-codes]</span></caption>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>Code</strong></td>
<td style="text-align: left;"><strong>Name</strong></td>
<td style="text-align: left;"><strong>Meaning</strong></td>
</tr>
<tr class="even">
<td style="text-align: left;">100</td>
<td style="text-align: left;">Continue</td>
<td style="text-align: left;">The client should continue sending data</td>
</tr>
<tr class="odd">
<td style="text-align: left;">200</td>
<td style="text-align: left;">OK</td>
<td style="text-align: left;">The request has succeeded</td>
</tr>
<tr class="even">
<td style="text-align: left;">204</td>
<td style="text-align: left;">No Content</td>
<td style="text-align: left;">The server completed the request but there is no data</td>
</tr>
<tr class="odd">
<td style="text-align: left;">301</td>
<td style="text-align: left;">Moved Permanently</td>
<td style="text-align: left;">The resource has moved to a new permanent location</td>
</tr>
<tr class="even">
<td style="text-align: left;">307</td>
<td style="text-align: left;">Temporary Redirect</td>
<td style="text-align: left;">The resource is temporarily at a different location</td>
</tr>
<tr class="odd">
<td style="text-align: left;">400</td>
<td style="text-align: left;">Bad Request</td>
<td style="text-align: left;">The request is badly formatted</td>
</tr>
<tr class="even">
<td style="text-align: left;">401</td>
<td style="text-align: left;">Unauthorized</td>
<td style="text-align: left;">The request requires authentication</td>
</tr>
<tr class="odd">
<td style="text-align: left;">404</td>
<td style="text-align: left;">Not Found</td>
<td style="text-align: left;">The requested resource could not be found</td>
</tr>
<tr class="even">
<td style="text-align: left;">408</td>
<td style="text-align: left;">Timeout</td>
<td style="text-align: left;">The server gave up waiting for the client</td>
</tr>
<tr class="odd">
<td style="text-align: left;">418</td>
<td style="text-align: left;">I’m a Teapot</td>
<td style="text-align: left;">An April Fool’s joke</td>
</tr>
<tr class="even">
<td style="text-align: left;">500</td>
<td style="text-align: left;">Internal Server Error</td>
<td style="text-align: left;">A server error occurred while handling the request</td>
</tr>
<tr class="odd">
<td style="text-align: left;">601</td>
<td style="text-align: left;">Connection Timed Out</td>
<td style="text-align: left;">The server did not respond before the connection timed out</td>
</tr>
</tbody>
</table>
</div>
<p>One final thing we need to understand is the structure and interpretation of URLs. This one:</p>
<pre class="text"><code>http://example.org:1234/some/path?value=deferred&amp;limit=200</code></pre>
<p>has five parts:</p>
<ul>
<li><p>The protocol <code>http</code>, which specifies what rules are going to be used to exchange data.</p></li>
<li><p>The <a href="#g:hostname"><strong>hostname</strong></a> <code>example.org</code>, which tells the client where to find the server. If we are running a server on our own computer for testing, we can use the name <code>localhost</code> to connect to it. (Computers rely on a service called <a href="#g:dns"><strong>DNS</strong></a> to find the machines associated with human-readable hostnames, but its operation is out of scope for this tutorial.)</p></li>
<li><p>The <a href="#g:port"><strong>port</strong></a> <code>1234</code>, which tells the client where to call the service it wants. (If a host is like an office building, a port is like a phone number in that building. The fact that we think of phone numbers as having physical locations says something about our age<span>…</span>)</p></li>
<li><p>The path <code>/some/path</code> tells the server what the client wants.</p></li>
<li><p>The <a href="#g:query-parameter"><strong>query parameters</strong></a> <code>value=deferred</code> and <code>limit=200</code>. These come after a question mark and are separated by ampersands, and are used to provide extra information.</p></li>
</ul>
<p>It used to be common for paths to identify actual files on the server, but the server can interpret the path however it wants. In particular, when we are writing a data service, the segments of the path can identify what data we are asking for. Alternatively, it’s common to think of the path as identifying a function on the server that we want to call, and to think of the query parameters as the arguments to that function. We’ll return to these ideas after we’ve seen how a simple server works.</p>
<h2 id="s:server-express">Hello, Express</h2>
<p>A Node-based library called Express handles most of the details of HTTP for us. When we build a server using Express, we provide callback functions that take three parameters:</p>
<ul>
<li><p>the original request,</p></li>
<li><p>the response we’re building up, and</p></li>
<li><p>what to do next (which we’ll ignore for now).</p></li>
</ul>
<p>We also provide a pattern with each function that specifies what URLs it is to match. Here is a simple example:</p>
<div class="sourceCode" id="cb290"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb290-1"><a href="#cb290-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> express <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;express&#39;</span>)</span>
<span id="cb290-2"><a href="#cb290-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-3"><a href="#cb290-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> PORT <span class="op">=</span> <span class="dv">3418</span></span>
<span id="cb290-4"><a href="#cb290-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-5"><a href="#cb290-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Main server object.</span></span>
<span id="cb290-6"><a href="#cb290-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> app <span class="op">=</span> <span class="fu">express</span>()</span>
<span id="cb290-7"><a href="#cb290-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-8"><a href="#cb290-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Return a static page.</span></span>
<span id="cb290-9"><a href="#cb290-9" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb290-10"><a href="#cb290-10" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">status</span>(<span class="dv">200</span>)<span class="op">.</span><span class="fu">send</span>(<span class="st">&#39;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Asteroids&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#39;</span>)</span>
<span id="cb290-11"><a href="#cb290-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb290-12"><a href="#cb290-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb290-13"><a href="#cb290-13" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">listen</span>(PORT<span class="op">,</span> () <span class="kw">=&gt;</span> { <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;listening...&#39;</span>) })</span></code></pre></div>
<p>The first line of code loads the Express library. The next defines the port we will listen on, and then the third creates the object that will do most of the work.</p>
<p>Further down, the call to <code>app.get</code> tells that object to handle any <code>GET</code> request for ‘/’ by sending a reply whose status is 200 (OK) and whose body is an HTML page containing only an <code>h1</code> heading. There is no actual HTML file on disk, and in fact no way for the browser to know if there was one or not: the server can send whatever it wants in response to whatever requests it wants to handle.</p>
<p>Note that <code>app.get</code> doesn’t actually get anything right away. Instead, it registers a callback with Express that says, “When you see this URL, call this function to handle it.” As we’ll see below, we can register as many path/callback pairs as we want to handle different things.</p>
<p>Finally, the last line of this script tells our application to listen on the specified port, while the callback tells it to print a message as it starts running. When we run this, we see:</p>
<pre class="shell"><code>$ node static-page.js</code></pre>
<pre class="text"><code>listening...</code></pre>
<p>Our little server is now waiting for something to ask it for something. If we go to our browser and request <code>http://localhost:3418/</code>, we get a page with a large title <code>Asteroids</code> on it. Our server has worked, and we can now stop it by typing Ctrl-C in the shell.</p>
<h2 id="s:server-paths">Handling Multiple Paths</h2>
<p>Let’s extend our server to do different things when given different paths, and to handle the case where the request path is not known:</p>
<div class="sourceCode" id="cb293"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb293-1"><a href="#cb293-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> express <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;express&#39;</span>)</span>
<span id="cb293-2"><a href="#cb293-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-3"><a href="#cb293-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> PORT <span class="op">=</span> <span class="dv">3418</span></span>
<span id="cb293-4"><a href="#cb293-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-5"><a href="#cb293-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Main server object.</span></span>
<span id="cb293-6"><a href="#cb293-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> app <span class="op">=</span> <span class="fu">express</span>()</span>
<span id="cb293-7"><a href="#cb293-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-8"><a href="#cb293-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Root page.</span></span>
<span id="cb293-9"><a href="#cb293-9" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb293-10"><a href="#cb293-10" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">status</span>(<span class="dv">200</span>)<span class="op">.</span><span class="fu">send</span>(<span class="st">&#39;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Home&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#39;</span>)</span>
<span id="cb293-11"><a href="#cb293-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb293-12"><a href="#cb293-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-13"><a href="#cb293-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Alternative page.</span></span>
<span id="cb293-14"><a href="#cb293-14" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/asteroids&#39;</span><span class="op">,</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb293-15"><a href="#cb293-15" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">status</span>(<span class="dv">200</span>)<span class="op">.</span><span class="fu">send</span>(<span class="st">&#39;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Asteroids&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#39;</span>)</span>
<span id="cb293-16"><a href="#cb293-16" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb293-17"><a href="#cb293-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-18"><a href="#cb293-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Nothing else worked.</span></span>
<span id="cb293-19"><a href="#cb293-19" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>((req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb293-20"><a href="#cb293-20" aria-hidden="true" tabindex="-1"></a>  res</span>
<span id="cb293-21"><a href="#cb293-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">status</span>(<span class="dv">404</span>)</span>
<span id="cb293-22"><a href="#cb293-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">send</span>(<span class="vs">`&lt;html&gt;&lt;body&gt;&lt;p&gt;ERROR: </span><span class="sc">${</span>req<span class="op">.</span><span class="at">url</span><span class="sc">}</span><span class="vs"> not found&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;`</span>)</span>
<span id="cb293-23"><a href="#cb293-23" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb293-24"><a href="#cb293-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb293-25"><a href="#cb293-25" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">listen</span>(PORT<span class="op">,</span> () <span class="kw">=&gt;</span> { <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;listening...&#39;</span>) })</span></code></pre></div>
<p>The first few lines are the same as before. We then specify handlers for the paths <code>/</code> and <code>/asteroids</code>, each of which sends a different chunk of HTML.</p>
<p>The call to <code>app.use</code> specifies a default handler: if none of the <code>app.get</code> handlers above it took care of the request, this callback function will send a “page not found” code <em>and</em> a page containing an error message. Some sites skip the first part and only return error messages in pages for people to read, but this is sinful: making the code explicit makes it a lot easier to write programs to scrape data.</p>
<p>As before, we can run our server from the command line and then go to various URLs to test it. <code>http://localhost:3418/</code> produces a page with the title “Home”, <code>http://localhost:3418/asteroids</code> produces one with the title “Asteroids”, and <code>http://localhost:3418/test</code> produces an error page.</p>
<h2 id="s:server-files">Serving Files from Disk</h2>
<p>It’s common to generate HTML in memory when building data services, but it’s also common for the server to return files. To do this, we will provide our server with the path to the directory it’s allowed to read pages from, and then run it with <code>node server-name.js path/to/directory</code>. We have to tell the server whence it’s allowed to read files because we definitely do <em>not</em> want it to be able to send everything on our computer to whoever asks for it. (For example, a request for the <code>/etc/passwd</code> password file on a Linux server should probably be refused.)</p>
<p>Here’s our updated server:</p>
<div class="sourceCode" id="cb294"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb294-1"><a href="#cb294-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> express <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;express&#39;</span>)</span>
<span id="cb294-2"><a href="#cb294-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> path <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;path&#39;</span>)</span>
<span id="cb294-3"><a href="#cb294-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;fs&#39;</span>)</span>
<span id="cb294-4"><a href="#cb294-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-5"><a href="#cb294-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> PORT <span class="op">=</span> <span class="dv">3418</span></span>
<span id="cb294-6"><a href="#cb294-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> <span class="bu">root</span> <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">argv</span>[<span class="dv">2</span>]</span>
<span id="cb294-7"><a href="#cb294-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-8"><a href="#cb294-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Main server object.</span></span>
<span id="cb294-9"><a href="#cb294-9" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> app <span class="op">=</span> <span class="fu">express</span>()</span>
<span id="cb294-10"><a href="#cb294-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-11"><a href="#cb294-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Handle all requests.</span></span>
<span id="cb294-12"><a href="#cb294-12" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>((req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb294-13"><a href="#cb294-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> actual <span class="op">=</span> path<span class="op">.</span><span class="fu">join</span>(<span class="bu">root</span><span class="op">,</span> req<span class="op">.</span><span class="at">url</span>)</span>
<span id="cb294-14"><a href="#cb294-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> data <span class="op">=</span> fs<span class="op">.</span><span class="fu">readFileSync</span>(actual<span class="op">,</span> <span class="st">&#39;utf-8&#39;</span>)</span>
<span id="cb294-15"><a href="#cb294-15" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">status</span>(<span class="dv">200</span>)<span class="op">.</span><span class="fu">send</span>(data)</span>
<span id="cb294-16"><a href="#cb294-16" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb294-17"><a href="#cb294-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-18"><a href="#cb294-18" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">listen</span>(PORT<span class="op">,</span> () <span class="kw">=&gt;</span> { <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;listening...&#39;</span>) })</span></code></pre></div>
<p>The steps in handling a request are:</p>
<ol>
<li><p>The URL requested by the client is given to us in <code>req.url</code>.</p></li>
<li><p>We use <code>path.join</code> to combine that with the path to the root directory, which we got from a command-line argument when the server was run.</p></li>
<li><p>We try to read that file using <code>readFileSync</code>, which blocks the server until the file is read. We will see later how to do this I/O asynchronously so that our server is more responsive.</p></li>
<li><p>Once the file has been read, we return it with a status code of 200.</p></li>
</ol>
<p>If a sub-directory called <code>web-dir</code> holds a file called <code>title.html</code>, and we run the server as:</p>
<pre class="shell"><code>$ node serve-pages.js ./web-dir</code></pre>
<p>we can then ask for <code>http://localhost:3418/title.html</code> and get the content of <code>web-dir/title.html</code>. Notice that the directory <code>./web-dir</code> doesn’t appear in the URL: our server interprets all paths as if the directory we’ve given it is the root of the filesystem.</p>
<figure>
<img src="figures/server-mapping.svg" id="f:server-mapping" /><figcaption aria-hidden="true"><span>Mapping URLs to Files</span><span id="f:server-mapping" label="f:server-mapping">[f:server-mapping]</span></figcaption>
</figure>
<p>If we ask for a nonexistent page like <code>http://localhost:3418/missing.html</code> we get this:</p>
<pre class="text"><code>Error: ENOENT: no such file or directory, open &#39;web-dir/missing.html&#39;
    at Object.openSync (fs.js:434:3)
    at Object.readFileSync (fs.js:339:35)
    ... etc. ...</code></pre>
<p>We will see in the exercises how to add proper error handling to our server.</p>
<blockquote>
<h4 id="favorites-and-icons" class="unnumbered">Favorites and Icons</h4>
<p>If we use a browser to request a page such as <code>title.html</code>, the browser may actually make two requests: one for the page, and one for a file called <code>favicon.ico</code>. Browsers do this automatically, then display that file in tabs, bookmark lists, and so on. Despite its <code>.ico</code> suffix, the file is (usually) a small PNG-formatted image, and must be placed in the root directory of the website.</p>
</blockquote>
<h2 id="s:server-content-types">Content Types</h2>
<p>So far we have only served HTML, but the server can send any type of data, including images and other binary files. For example, let’s serve some JSON data:</p>
<div class="sourceCode" id="cb297"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb297-1"><a href="#cb297-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ...as before...</span></span>
<span id="cb297-2"><a href="#cb297-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb297-3"><a href="#cb297-3" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>((req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb297-4"><a href="#cb297-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> actual <span class="op">=</span> path<span class="op">.</span><span class="fu">join</span>(<span class="bu">root</span><span class="op">,</span> req<span class="op">.</span><span class="at">url</span>)</span>
<span id="cb297-5"><a href="#cb297-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb297-6"><a href="#cb297-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (actual<span class="op">.</span><span class="fu">endsWith</span>(<span class="st">&#39;.json&#39;</span>)) {</span>
<span id="cb297-7"><a href="#cb297-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> fs<span class="op">.</span><span class="fu">readFileSync</span>(actual<span class="op">,</span> <span class="st">&#39;utf-8&#39;</span>)</span>
<span id="cb297-8"><a href="#cb297-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> json <span class="op">=</span> <span class="bu">JSON</span><span class="op">.</span><span class="fu">parse</span>(data)</span>
<span id="cb297-9"><a href="#cb297-9" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">setHeader</span>(<span class="st">&#39;Content-Type&#39;</span><span class="op">,</span> <span class="st">&#39;application/json&#39;</span>)</span>
<span id="cb297-10"><a href="#cb297-10" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">status</span>(<span class="dv">200</span>)<span class="op">.</span><span class="fu">send</span>(json)</span>
<span id="cb297-11"><a href="#cb297-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb297-12"><a href="#cb297-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb297-13"><a href="#cb297-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> {</span>
<span id="cb297-14"><a href="#cb297-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> fs<span class="op">.</span><span class="fu">readFileSync</span>(actual<span class="op">,</span> <span class="st">&#39;utf-8&#39;</span>)</span>
<span id="cb297-15"><a href="#cb297-15" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">status</span>(<span class="dv">200</span>)<span class="op">.</span><span class="fu">send</span>(data)</span>
<span id="cb297-16"><a href="#cb297-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb297-17"><a href="#cb297-17" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>What’s different here is that when the requested path ends with <code>.json</code> we explicitly set the <code>Content-Type</code> header to <code>application/json</code> to tell the client how to interpret the bytes we’re sending back. If we run this server with <code>web-dir</code> as the directory to serve from and ask for <code>http://localhost:3418/data.json</code>, a modern browser will provide a folding display of the data rather than displaying the raw text.</p>
<blockquote>
<h4 id="so-whats-an-api" class="unnumbered">So What’s an API?</h4>
<p>A library’s <a href="#g:api"><strong>Application Programming Interface</strong></a> (API) is simply the set of functions other programs are allowed to call. This is usually a subset of all of the functions defined in the library, since many may be helpers intended for internal use only. Similarly, a server’s API is the set of requests it knows how to respond to. For example, NASA’s near-approach asteroid API (Section <a href="#s:interactive-fetching" data-reference-type="ref" data-reference="s:interactive-fetching">10.3</a>) can handle requests that include an authentication key and a starting date, while the server we have built in this chapter can respond to requests for HTML and JSON files. We will look a little more closely at API design in Section <a href="#s:capstone-server" data-reference-type="ref" data-reference="s:capstone-server">15.2</a>.</p>
</blockquote>
<h2 id="s:server-exercises">Exercises</h2>
<h3 class="unnumbered" id="report-missing-files">Report Missing Files</h3>
<p>Modify the version of the server that returns files from disk to report a 404 error if a file cannot be found. What should it return if the file exists but cannot be read (e.g., if the server does not have permissions)?</p>
<h3 class="unnumbered" id="serving-images">Serving Images</h3>
<p>Modify the version of the server that returns files from disk so that if the file it is asked for has a name ending in <code>.png</code> or <code>.jpg</code>, it is returned with the right <code>Content-Type</code> header.</p>
<h3 class="unnumbered" id="delayed-replies">Delayed Replies</h3>
<p>Our file server uses <code>fs.readFileSync</code> to read files, which means that it stops each time a file is requested rather than handling other queries while waiting for the file to be read. Modify the callback given to <code>app.use</code> so that it uses <code>fs.readFile</code> with a callback instead.</p>
<h3 class="unnumbered" id="using-query-parameters">Using Query Parameters</h3>
<p>URLs can contain query parameters in the form:</p>
<pre class="text"><code>http://site.edu?first=123&amp;second=beta</code></pre>
<p>Read the online documentation for <a href="https://expressjs.com/">Express</a> to find out how to access them in a server, and then write a server to do simple arithmetic: the URL <code>http://localhost:3654/add?left=1&amp;right=2</code> should return <code>3</code>, while the URL <code>http://localhost:3654/subtract?left=1&amp;right=2</code> should return <code>-1</code>.</p>
<h2 class="unnumbered" id="key-points-11">Key Points</h2>
<ul>
<li><p>An HTTP request or response consists of a plain-text header and an optional body.</p></li>
<li><p>HTTP is a stateless protocol.</p></li>
<li><p>Express provides a simple path-based JavaScript server.</p></li>
<li><p>Write callback functions to handle requests matching specified paths.</p></li>
<li><p>Provide a default handler for unrecognized requests.</p></li>
<li><p>Use <code>Content-Type</code> to specify the type of data being returned.</p></li>
<li><p>Use dynamic loading to support plugin extensions.</p></li>
</ul>
<h1 id="s:testing">Testing</h1>
<p>We are bad people, because we have been writing code without testing it. In this lesson we will redeem ourselves (partially) by correcting that (also partially).</p>
<p>JavaScript uses the same pattern for <a href="#g:unit-test"><strong>unit testing</strong></a> as most other modern languages. Each test is written as a function, and each of those functions tests one particular aspect of the code. A standalone program called a <a href="#g:test-runner"><strong>test runner</strong></a> finds test functions, runs them, and reports the results. Any setup code that needs to be run before each test to create the data for the test’s input (called its <a href="#g:fixture"><strong>fixture</strong></a>) is put in a function of its own. Similarly (but less frequently), if some teardown needs to be done <em>after</em> each test, we put those operations in a function as well.</p>
<p>Each unit test can have one of three results:</p>
<ul>
<li><p>pass: everything worked,</p></li>
<li><p>fail: the system being tested didn’t do what was expected, or</p></li>
<li><p>error: something went wrong with the test itself.</p></li>
</ul>
<p>We can combine tests into <a href="#g:test-suite"><strong>test suites</strong></a> (and test suites into larger suites, and so on) so that we can more easily run related sets of tests. This makes testing during development faster, which in turn makes it more likely that we’ll actually do it. Finally, we write the tests themselves using <a href="#g:assertion"><strong>assertions</strong></a>: statements that check whether or not some condition holds and generate an error if it doesn’t. Node provides an <code>assert</code> library with some useful functions for asserting various things; we’ll explore this as we go along.</p>
<h2 id="s:testing-mocha">Introducing Mocha</h2>
<p>JavaScript has almost as many testing libraries as it has front-end frameworks. We will use one called <a href="https://mochajs.org/">Mocha</a> that is popular and well documented. Unlike the libraries we have seen before, we don’t import anything to use it; instead, <em>it</em> imports <em>our</em> code and calls our functions.</p>
<p>When we’re writing tests for Mocha to run, we use a function called <code>describe</code> to create a group of tests and another function called <code>it</code> for each test in that group:</p>
<div class="sourceCode" id="cb299"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb299-1"><a href="#cb299-1" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;first test&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb299-2"><a href="#cb299-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should run without errors&#39;</span><span class="op">,</span> (done) <span class="kw">=&gt;</span> {</span>
<span id="cb299-3"><a href="#cb299-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">done</span>()</span>
<span id="cb299-4"><a href="#cb299-4" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb299-5"><a href="#cb299-5" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>As this example shows, <code>describe</code>’s arguments are an explanatory string and a callback function. That callback makes calls to <code>it</code>, which takes:</p>
<ul>
<li><p>another explanatory string describing how the system should behave, and</p></li>
<li><p>a callback that receives a function (called <code>done</code> by convention).</p></li>
</ul>
<p>(The name <code>it</code> was chosen so that when we read tests aloud, it sounds like we’re saying, “It should do this or that.”) At the end of each test we call <code>done</code> to signal that it has finished. We have to do this because callbacks run out of order, so Mocha needs to know when each one completes.</p>
<p>We can run our tests from the shell by invoking <code>mocha</code> and giving it the path to the file that contains the tests:</p>
<pre class="shell"><code>$ ./node_modules/.bin/mocha path/to/test.js</code></pre>
<pre class="text"><code>  first test
    + should run without errors


  1 passing (12ms)</code></pre>
<p>As with bundling, we normally put the <code>mocha</code> command in <code>package.json</code> so that <code>./node_modules/.bin</code> is automatically included in the path. After we add this:</p>
<div class="sourceCode" id="cb302"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb302-1"><a href="#cb302-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb302-2"><a href="#cb302-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb302-3"><a href="#cb302-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;scripts&quot;</span><span class="op">:</span> {</span>
<span id="cb302-4"><a href="#cb302-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb302-5"><a href="#cb302-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;test&quot;</span><span class="op">:</span> <span class="st">&quot;mocha&quot;</span><span class="op">,</span></span>
<span id="cb302-6"><a href="#cb302-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb302-7"><a href="#cb302-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb302-8"><a href="#cb302-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>to <code>package.json</code>, our command becomes:</p>
<pre class="shell"><code>$ npm test -- path/to/test.js</code></pre>
<p>(Again, everything after <code>--</code> is passed to the script itself.) If we don’t specify where to find tests, Mocha looks for a directory called <code>test</code> and runs the files it finds there whose names begin with <code>test</code> (Figure <a href="#f:testing-mocha" data-reference-type="ref" data-reference="f:testing-mocha">13.1</a>).</p>
<figure>
<img src="figures/testing-mocha.svg" id="f:testing-mocha" /><figcaption aria-hidden="true"><span>Mocha in Action</span><span id="f:testing-mocha" label="f:testing-mocha">[f:testing-mocha]</span></figcaption>
</figure>
<h2 id="s:testing-refactoring">Refactoring</h2>
<p>The next step is to <a href="#g:refactor"><strong>refactor</strong></a> our software to make it testable. In the case of our server, we have to:</p>
<ul>
<li><p>move the code that listens on a port into one file, and</p></li>
<li><p>have that import a file that contains the code to do everything else.</p></li>
</ul>
<p>Once we have done this, we can run the server code in other contexts. Here’s the file <code>standalone.js</code> that actually launches a server:</p>
<div class="sourceCode" id="cb304"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> server <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;./server&#39;</span>)</span>
<span id="cb304-2"><a href="#cb304-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> PORT <span class="op">=</span> <span class="dv">3418</span></span>
<span id="cb304-3"><a href="#cb304-3" aria-hidden="true" tabindex="-1"></a>server<span class="op">.</span><span class="fu">listen</span>(PORT<span class="op">,</span></span>
<span id="cb304-4"><a href="#cb304-4" aria-hidden="true" tabindex="-1"></a>              () <span class="kw">=&gt;</span> { <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`listening on port </span><span class="sc">${</span>PORT<span class="sc">}</span><span class="vs">...`</span>) })</span></code></pre></div>
<p>And here is the application code we’ve extracted into <code>server.js</code> so that we can test it:</p>
<div class="sourceCode" id="cb305"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb305-1"><a href="#cb305-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> express <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;express&#39;</span>)</span>
<span id="cb305-2"><a href="#cb305-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb305-3"><a href="#cb305-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Main server object.</span></span>
<span id="cb305-4"><a href="#cb305-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> app <span class="op">=</span> <span class="fu">express</span>()</span>
<span id="cb305-5"><a href="#cb305-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb305-6"><a href="#cb305-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Root page.</span></span>
<span id="cb305-7"><a href="#cb305-7" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/&#39;</span><span class="op">,</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb305-8"><a href="#cb305-8" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">status</span>(<span class="dv">200</span>)<span class="op">.</span><span class="fu">send</span>(<span class="st">&#39;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Home&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#39;</span>)</span>
<span id="cb305-9"><a href="#cb305-9" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb305-10"><a href="#cb305-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb305-11"><a href="#cb305-11" aria-hidden="true" tabindex="-1"></a><span class="co">// ...as before...</span></span>
<span id="cb305-12"><a href="#cb305-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb305-13"><a href="#cb305-13" aria-hidden="true" tabindex="-1"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> app</span></code></pre></div>
<p>Before going any further, we check that we haven’t broken anything by running:</p>
<pre class="shell"><code>$ node standalone.js</code></pre>
<h2 id="s:testing-server">Testing the Server</h2>
<p>All right: now that we have extracted the code that’s specific to our server, how do we test it? The answer is yet another library called <a href="https://github.com/visionmedia/supertest">supertest</a> that sends fake HTTP requests to an Express server that has been split in the way we just split ours and lets us interact with that server’s replies.</p>
<figure>
<img src="figures/testing-supertest.svg" id="f:testing-supertest" /><figcaption aria-hidden="true"><span>Supertest versus Reality</span><span id="f:testing-supertest" label="f:testing-supertest">[f:testing-supertest]</span></figcaption>
</figure>
<p>Here’s a test of a simple request that uses Mocha to manage the test, and supertest’s <code>request</code> function to send something to the server and check the result:</p>
<div class="sourceCode" id="cb307"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb307-1"><a href="#cb307-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> assert <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;assert&#39;</span>)</span>
<span id="cb307-2"><a href="#cb307-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> request <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;supertest&#39;</span>)</span>
<span id="cb307-3"><a href="#cb307-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> server <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;./server&#39;</span>)</span>
<span id="cb307-4"><a href="#cb307-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-5"><a href="#cb307-5" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;server&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb307-6"><a href="#cb307-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-7"><a href="#cb307-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should return HTML with expected title&#39;</span><span class="op">,</span> (done) <span class="kw">=&gt;</span> {</span>
<span id="cb307-8"><a href="#cb307-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">request</span>(server)</span>
<span id="cb307-9"><a href="#cb307-9" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/&#39;</span>)</span>
<span id="cb307-10"><a href="#cb307-10" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">expect</span>(<span class="dv">200</span>)</span>
<span id="cb307-11"><a href="#cb307-11" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">expect</span>(<span class="st">&#39;Content-Type&#39;</span><span class="op">,</span> <span class="ss">/html/</span>)</span>
<span id="cb307-12"><a href="#cb307-12" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">end</span>((err<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb307-13"><a href="#cb307-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assert</span>(res<span class="op">.</span><span class="at">text</span><span class="op">.</span><span class="fu">includes</span>(<span class="st">&#39;Home&#39;</span>)<span class="op">,</span> <span class="st">&#39;Has expected title&#39;</span>)</span>
<span id="cb307-14"><a href="#cb307-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">done</span>()</span>
<span id="cb307-15"><a href="#cb307-15" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb307-16"><a href="#cb307-16" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb307-17"><a href="#cb307-17" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Going through this line by line:</p>
<ol>
<li><p><code>request(server)</code> starts building up a request to send.</p></li>
<li><p><code>.get(’/’)</code> specifies the path in the URL we are sending.</p></li>
<li><p><code>.expect(200)</code> checks that the return code is 200 (OK).</p></li>
<li><p><code>.expect(’Content-Type’, /html/)</code> checks the content type in the returned value against a <a href="#g:regular-expression"><strong>regular expression</strong></a> (Appendix <a href="#s:regexp" data-reference-type="ref" data-reference="s:regexp">24</a>).</p></li>
<li><p><code>.end</code> is called when the whole response has been received, i.e., when we can start looking at the content of the page or data that the server has sent.</p></li>
<li><p>Inside the callback to <code>end</code>, <code>res</code> is the result data. We make sure that its text (i.e., <code>res.text</code>) includes the word “Home”. We really should check <code>err</code> here to make sure everything worked properly, but we’re not quite that virtuous.</p></li>
<li><p>Finally, we call <code>done()</code> to signal the end of the test. Again, we have to do this because there’s no way Mocha can know when the enclosing <code>.end(...)</code> will be called</p></li>
</ol>
<p>Let’s run our code:</p>
<pre class="text"><code>  server
    + should return HTML with expected title (48ms)


  1 passing (58ms)</code></pre>
<p>Excellent: let’s add some more tests.</p>
<div class="sourceCode" id="cb309"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb309-1"><a href="#cb309-1" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;server&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb309-2"><a href="#cb309-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-3"><a href="#cb309-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should return HTML with expected title&#39;</span><span class="op">,</span> (done) <span class="kw">=&gt;</span> {</span>
<span id="cb309-4"><a href="#cb309-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...as before...</span></span>
<span id="cb309-5"><a href="#cb309-5" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb309-6"><a href="#cb309-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-7"><a href="#cb309-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should return page as HTML with expected title&#39;</span><span class="op">,</span> (done) <span class="kw">=&gt;</span> {</span>
<span id="cb309-8"><a href="#cb309-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">request</span>(server)</span>
<span id="cb309-9"><a href="#cb309-9" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/asteroids&#39;</span>)</span>
<span id="cb309-10"><a href="#cb309-10" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">expect</span>(<span class="dv">200</span>)</span>
<span id="cb309-11"><a href="#cb309-11" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">expect</span>(<span class="st">&#39;Content-Type&#39;</span><span class="op">,</span> <span class="ss">/html/</span>)</span>
<span id="cb309-12"><a href="#cb309-12" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">end</span>((err<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb309-13"><a href="#cb309-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assert</span>(res<span class="op">.</span><span class="at">text</span><span class="op">.</span><span class="fu">includes</span>(<span class="st">&#39;Asteroids&#39;</span>)<span class="op">,</span> <span class="st">&#39;Has expected title&#39;</span>)</span>
<span id="cb309-14"><a href="#cb309-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">done</span>()</span>
<span id="cb309-15"><a href="#cb309-15" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb309-16"><a href="#cb309-16" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb309-17"><a href="#cb309-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-18"><a href="#cb309-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should 404 for other pages&#39;</span><span class="op">,</span> (done) <span class="kw">=&gt;</span> {</span>
<span id="cb309-19"><a href="#cb309-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">request</span>(server)</span>
<span id="cb309-20"><a href="#cb309-20" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">expect</span>(<span class="dv">404</span>)</span>
<span id="cb309-21"><a href="#cb309-21" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/other&#39;</span>)</span>
<span id="cb309-22"><a href="#cb309-22" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">end</span>((err<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb309-23"><a href="#cb309-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assert</span>(res<span class="op">.</span><span class="at">text</span><span class="op">.</span><span class="fu">includes</span>(<span class="st">&#39;ERROR&#39;</span>)<span class="op">,</span> <span class="st">&#39;Has expected error message&#39;</span>)</span>
<span id="cb309-24"><a href="#cb309-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">done</span>()</span>
<span id="cb309-25"><a href="#cb309-25" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb309-26"><a href="#cb309-26" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb309-27"><a href="#cb309-27" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre class="text"><code>  server
    + should return HTML with expected title (42ms)
    + should return asteroids page as HTML with expected title
    + should 404 for other pages


  3 passing (62ms)</code></pre>
<p>Notice that we check to make sure that the server sends a 404 when we ask for something that doesn’t exist. Making sure the system fails gracefully is just as important as making sure that it provides data when asked to.</p>
<h2 id="s:testing-html">Checking the HTML</h2>
<p>It’s increasingly common for servers to return data that is rendered by the client rather than generating and returning HTML, but some servers still do the latter. Do <em>not</em> try to check this with substrings or regular expressions: the exceptions have exceptions, and <a href="https://stackoverflow.com/a/1732454">that way lies madness</a>. Instead, we should parse the HTML to create a structure in memory and check that; if parsing fails because the HTML is badly formatted, that’s worth knowing too. The structure in question is our new friend the DOM, and to get it, we will use (yet another) library called <a href="https://cheerio.js.org/">cheerio</a>. <code>cheerio.load</code> turns HTML text into a DOM tree; the resulting object can be used like a function, and we can use the same selectors we met previously to find things in it. Here’s our test:</p>
<div class="sourceCode" id="cb311"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb311-1"><a href="#cb311-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> assert <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;assert&#39;</span>)</span>
<span id="cb311-2"><a href="#cb311-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> request <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;supertest&#39;</span>)</span>
<span id="cb311-3"><a href="#cb311-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cheerio <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;cheerio&#39;</span>)</span>
<span id="cb311-4"><a href="#cb311-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> server <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;./server&#39;</span>)</span>
<span id="cb311-5"><a href="#cb311-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb311-6"><a href="#cb311-6" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;server&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb311-7"><a href="#cb311-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should have the correct headings&#39;</span><span class="op">,</span> (done) <span class="kw">=&gt;</span> {</span>
<span id="cb311-8"><a href="#cb311-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">request</span>(server)</span>
<span id="cb311-9"><a href="#cb311-9" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/&#39;</span>)</span>
<span id="cb311-10"><a href="#cb311-10" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">expect</span>(<span class="st">&#39;Content-Type&#39;</span><span class="op">,</span> <span class="ss">/html/</span>)</span>
<span id="cb311-11"><a href="#cb311-11" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">expect</span>(<span class="dv">200</span>)</span>
<span id="cb311-12"><a href="#cb311-12" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">end</span>((err<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb311-13"><a href="#cb311-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> tree <span class="op">=</span> cheerio<span class="op">.</span><span class="fu">load</span>(res<span class="op">.</span><span class="at">text</span>)</span>
<span id="cb311-14"><a href="#cb311-14" aria-hidden="true" tabindex="-1"></a>        assert<span class="op">.</span><span class="fu">equal</span>(<span class="fu">tree</span>(<span class="st">&#39;h1&#39;</span>)<span class="op">.</span><span class="at">length</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="st">&#39;Correct number of headings&#39;</span>)</span>
<span id="cb311-15"><a href="#cb311-15" aria-hidden="true" tabindex="-1"></a>        assert<span class="op">.</span><span class="fu">equal</span>(<span class="fu">tree</span>(<span class="st">&#39;h1&#39;</span>)<span class="op">.</span><span class="fu">text</span>()<span class="op">,</span> <span class="st">&#39;Home&#39;</span><span class="op">,</span> <span class="st">&#39;Correct heading text&#39;</span>)</span>
<span id="cb311-16"><a href="#cb311-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">done</span>()</span>
<span id="cb311-17"><a href="#cb311-17" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb311-18"><a href="#cb311-18" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb311-19"><a href="#cb311-19" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre class="text"><code>  server
    + should have the correct headings (67ms)


  1 passing (77ms)</code></pre>
<p>This gets the page as before, parses it, then looks for <code>h1</code> elements and checks the text of the first one. (Note that this <em>doesn’t</em> check if the title is <code>&lt;em&gt;H&lt;/em&gt;ome</code> because <code>.text()</code> concatenates all the text of the children.) We won’t explore this approach further because we’re going to serve data for rendering rather than generating HTML and sending that, but if you’re doing any web scraping at all, libraries like <code>cheerio</code> are there to help.</p>
<h2 id="s:testing-exercises">Exercises</h2>
<h3 class="unnumbered" id="not-done">Not Done</h3>
<p>What happens if we forget to call <code>done()</code> in a test?</p>
<h3 class="unnumbered" id="adding-tests">Adding Tests</h3>
<ol>
<li><p>What is the most useful test you could add for the asteroids application? Why?</p></li>
<li><p>Implement it.</p></li>
<li><p>Ask yourself why tutorials like this one don’t say “<em>please</em> implement it”. Reflect on the fact that this question didn’t say “please” either. Are you comfortable with the paternalistic power relationship embodied in the absence of that one little word, and with the somewhat uncomfortable attempt at ironic humor embodied in this question?</p></li>
</ol>
<h3 class="unnumbered" id="lifecycle">Lifecycle</h3>
<p>Suppose a JavaScript program contains some JSX expressions that produce HTML which is then read and displayed by a browser. Draw a diagram to show the form taken by an H1 heading containing the word “data” from start to finish.</p>
<h2 class="unnumbered" id="key-points-12">Key Points</h2>
<ul>
<li><p>A unit test checks the behavior of one software component in isolation.</p></li>
<li><p>The result of a unit test can be pass, fail, or error.</p></li>
<li><p>Use Mocha to write and run unit tests in JavaScript.</p></li>
<li><p>Put assertions in unit tests to check results.</p></li>
<li><p>Combine tests in suites for easier management.</p></li>
<li><p>Divide modules into interactive and non-interactive parts for easier testing.</p></li>
<li><p>Use <code>supertest</code> to simulate interaction with a server for testing.</p></li>
<li><p>HTML is represented in memory using the Document Object Model (DOM).</p></li>
<li><p>Check the structure of the DOM rather than the textual representation of the HTML when testing.</p></li>
</ul>
<h1 id="s:dataforge">Using Data-Forge</h1>
<p>We have now seen how to do everything a data scientist would want to do in JavaScript except actual data science. This is unfortunately one of the areas where the language still lags behind R and Python, but statistical libraries are now appearing, and if the last twenty-five years have taught us anything, it’s not to underestimate JavaScript.</p>
<p>In this chapter we will look at a library called Data-Forge that is designed for working with tabular data. Data-Forge was inspired by Python’s Pandas library, but should be familiar to anyone who has worked with the tidyverse in R as well. Its <a href="#g:dataframe"><strong><code>DataFrame</code></strong></a> class represents a table made up of named columns and any number of rows. Dataframes are <a href="#g:immutable"><strong>immutable</strong></a>: once a dataframe has been constructed, its contents cannot be changed. Instead, every operation produces a new dataframe. (Some clever behind-the-scenes data recycling makes this much more efficient than it sounds.)</p>
<p>Like Pandas and the tidyverse, Data-Forge is designed to work on <a href="#g:tidy-data"><strong>tidy data</strong></a>. As defined in <span class="citation" data-cites="Wick2014"></span>, tabular data is tidy if:</p>
<ul>
<li><p>Each column contains one statistical variable (i.e., one property that was measured or observed).</p></li>
<li><p>Each different observation is in a different row.</p></li>
<li><p>There is one table for each set of observations.</p></li>
<li><p>If there are multiple tables, each table has a column containing a unique key so that related data can be linked.</p></li>
</ul>
<p>For example, this data is not tidy:</p>
<table class="table table-striped">
<thead>
<tr class="header">
<th style="text-align: center;" colspan="5">Rodent Pleurisy Rates</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: center;" colspan="2">Female</td>
<td style="text-align: center;" colspan="2">Male</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;">2018</td>
<td style="text-align: left;">2019</td>
<td style="text-align: left;">2018</td>
<td style="text-align: left;">2019</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Jan</td>
<td style="text-align: left;">0.05</td>
<td style="text-align: left;">0.07</td>
<td style="text-align: left;">0.03</td>
<td style="text-align: left;">0.06</td>
</tr>
<tr class="even">
<td style="text-align: left;">Feb</td>
<td style="text-align: left;">0.05</td>
<td style="text-align: left;">0.08</td>
<td style="text-align: left;">0.04</td>
<td style="text-align: left;">0.07</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Mar</td>
<td style="text-align: left;">0.05</td>
<td style="text-align: left;">0.11</td>
<td style="text-align: left;">0.04</td>
<td style="text-align: left;">0.10</td>
</tr>
</tbody>
</table>
<p>but this data is:</p>
<table class="table table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">Year</th>
<th style="text-align: left;">Month</th>
<th style="text-align: left;">Sex</th>
<th style="text-align: left;">Rate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">2018</td>
<td style="text-align: left;">Jan</td>
<td style="text-align: left;">Female</td>
<td style="text-align: left;">0.05</td>
</tr>
<tr class="even">
<td style="text-align: left;">2018</td>
<td style="text-align: left;">Feb</td>
<td style="text-align: left;">Female</td>
<td style="text-align: left;">0.05</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2018</td>
<td style="text-align: left;">Mar</td>
<td style="text-align: left;">Female</td>
<td style="text-align: left;">0.05</td>
</tr>
<tr class="even">
<td style="text-align: left;">2018</td>
<td style="text-align: left;">Jan</td>
<td style="text-align: left;">Male</td>
<td style="text-align: left;">0.03</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2018</td>
<td style="text-align: left;">Feb</td>
<td style="text-align: left;">Male</td>
<td style="text-align: left;">0.04</td>
</tr>
<tr class="even">
<td style="text-align: left;">2018</td>
<td style="text-align: left;">Mar</td>
<td style="text-align: left;">Male</td>
<td style="text-align: left;">0.04</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2019</td>
<td style="text-align: left;">Jan</td>
<td style="text-align: left;">Female</td>
<td style="text-align: left;">0.07</td>
</tr>
<tr class="even">
<td style="text-align: left;">2019</td>
<td style="text-align: left;">Feb</td>
<td style="text-align: left;">Female</td>
<td style="text-align: left;">0.08</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2019</td>
<td style="text-align: left;">Mar</td>
<td style="text-align: left;">Female</td>
<td style="text-align: left;">0.11</td>
</tr>
<tr class="even">
<td style="text-align: left;">2019</td>
<td style="text-align: left;">Jan</td>
<td style="text-align: left;">Male</td>
<td style="text-align: left;">0.06</td>
</tr>
<tr class="odd">
<td style="text-align: left;">2019</td>
<td style="text-align: left;">Feb</td>
<td style="text-align: left;">Male</td>
<td style="text-align: left;">0.07</td>
</tr>
<tr class="even">
<td style="text-align: left;">2019</td>
<td style="text-align: left;">Mar</td>
<td style="text-align: left;">Male</td>
<td style="text-align: left;">0.10</td>
</tr>
</tbody>
</table>
<h2 id="s:dataforge-basics">Basic Operations</h2>
<p>To get started, we install Data-Forge using <code>npm install data-forge</code> and then load the library and create a dataframe from a list of objects. Each of these objects must use the same keys, which become the names of the dataframe’s columns:</p>
<div class="sourceCode" id="cb313"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb313-1"><a href="#cb313-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> DF <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;data-forge&#39;</span>)</span>
<span id="cb313-2"><a href="#cb313-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb313-3"><a href="#cb313-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fromObjects <span class="op">=</span> <span class="kw">new</span> DF<span class="op">.</span><span class="fu">DataFrame</span>([</span>
<span id="cb313-4"><a href="#cb313-4" aria-hidden="true" tabindex="-1"></a>    {<span class="dt">ones</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">tens</span><span class="op">:</span> <span class="dv">10</span>}<span class="op">,</span></span>
<span id="cb313-5"><a href="#cb313-5" aria-hidden="true" tabindex="-1"></a>    {<span class="dt">ones</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span> <span class="dt">tens</span><span class="op">:</span> <span class="dv">20</span>}<span class="op">,</span></span>
<span id="cb313-6"><a href="#cb313-6" aria-hidden="true" tabindex="-1"></a>    {<span class="dt">ones</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">tens</span><span class="op">:</span> <span class="dv">30</span>}</span>
<span id="cb313-7"><a href="#cb313-7" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb313-8"><a href="#cb313-8" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;fromObjects:</span><span class="sc">\n</span><span class="st">&#39;</span><span class="op">,</span> fromObjects)</span></code></pre></div>
<p>When we print the dataframe, we see this rather complex structure:</p>
<pre class="text"><code>fromObjects:
 DataFrame {
  configFn: null,
  content:
   { index: CountIterable {},
     values: [ [Object], [Object], [Object] ],
     pairs: MultiIterable { iterables: [Array] },
     isBaked: true,
     columnNames: [ &#39;ones&#39;, &#39;tens&#39; ] } }</code></pre>
<p>Each column is stored as a <code>Series</code> object; once in a while, we will need to work with these objects directly instead of with the dataframe as a whole. (Figure <a href="#f:dataforge-rows-and-columns" data-reference-type="ref" data-reference="f:dataforge-rows-and-columns">14.1</a>). If we want to see the actual data, we need to convert the dataframe back to an array of objects:</p>
<figure>
<img src="figures/dataforge-rows-and-columns.svg" id="f:dataforge-rows-and-columns" /><figcaption aria-hidden="true"><span>How Tables Are Stored</span><span id="f:dataforge-rows-and-columns" label="f:dataforge-rows-and-columns">[f:dataforge-rows-and-columns]</span></figcaption>
</figure>
<div class="sourceCode" id="cb315"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb315-1"><a href="#cb315-1" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;fromObjects as array:</span><span class="sc">\n</span><span class="st">&#39;</span><span class="op">,</span> fromObjects<span class="op">.</span><span class="fu">toArray</span>())</span></code></pre></div>
<pre class="text"><code>fromObjects as array:
 [ { ones: 1, tens: 10 },
  { ones: 2, tens: 20 },
  { ones: 3, tens: 30 } ]</code></pre>
<p>We can instead create a dataframe by providing the names of the columns in one list and the rows’ values in another:</p>
<div class="sourceCode" id="cb317"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb317-1"><a href="#cb317-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fromSpec <span class="op">=</span> <span class="kw">new</span> DF<span class="op">.</span><span class="fu">DataFrame</span>({</span>
<span id="cb317-2"><a href="#cb317-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">columnNames</span><span class="op">:</span> [<span class="st">&#39;ones&#39;</span><span class="op">,</span> <span class="st">&#39;tens&#39;</span>]<span class="op">,</span></span>
<span id="cb317-3"><a href="#cb317-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">rows</span><span class="op">:</span> [</span>
<span id="cb317-4"><a href="#cb317-4" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">4</span><span class="op">,</span> <span class="dv">40</span>]<span class="op">,</span></span>
<span id="cb317-5"><a href="#cb317-5" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">5</span><span class="op">,</span> <span class="dv">50</span>]<span class="op">,</span></span>
<span id="cb317-6"><a href="#cb317-6" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">6</span><span class="op">,</span> <span class="dv">60</span>]</span>
<span id="cb317-7"><a href="#cb317-7" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb317-8"><a href="#cb317-8" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb317-9"><a href="#cb317-9" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;fromSpec as array:</span><span class="sc">\n</span><span class="st">&#39;</span><span class="op">,</span> fromSpec<span class="op">.</span><span class="fu">toArray</span>())</span></code></pre></div>
<pre class="text"><code>fromSpec as array:
 [ { ones: 4, tens: 40 },
  { ones: 5, tens: 50 },
  { ones: 6, tens: 60 } ]</code></pre>
<p>However, we usually won’t create a dataframe directly like this; instead, we will read data from a file or a database. Data-Forge provides a function called <code>fromCSV</code> for doing this:</p>
<div class="sourceCode" id="cb319"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb319-1"><a href="#cb319-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> text <span class="op">=</span> <span class="vs">`ones,tens</span></span>
<span id="cb319-2"><a href="#cb319-2" aria-hidden="true" tabindex="-1"></a><span class="vs">7,70</span></span>
<span id="cb319-3"><a href="#cb319-3" aria-hidden="true" tabindex="-1"></a><span class="vs">8,80</span></span>
<span id="cb319-4"><a href="#cb319-4" aria-hidden="true" tabindex="-1"></a><span class="vs">9,90`</span></span>
<span id="cb319-5"><a href="#cb319-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fromText <span class="op">=</span> DF<span class="op">.</span><span class="fu">fromCSV</span>(text)</span>
<span id="cb319-6"><a href="#cb319-6" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;fromText as array:</span><span class="sc">\n</span><span class="st">&#39;</span><span class="op">,</span> fromText<span class="op">.</span><span class="fu">toArray</span>())</span></code></pre></div>
<pre class="text"><code>fromText as array:
 [ { ones: &#39;7&#39;, tens: &#39;70&#39; },
  { ones: &#39;8&#39;, tens: &#39;80&#39; },
  { ones: &#39;9&#39;, tens: &#39;90&#39; } ]</code></pre>
<p>However we create our dataframe, we can ask it for its columns’ names:</p>
<div class="sourceCode" id="cb321"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb321-1"><a href="#cb321-1" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(data<span class="op">.</span><span class="fu">getColumnNames</span>())</span></code></pre></div>
<pre class="text"><code>[ &#39;ones&#39;, &#39;tens&#39; ]</code></pre>
<p>or get its content as a list of lists (rather than as a list of objects):</p>
<div class="sourceCode" id="cb323"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb323-1"><a href="#cb323-1" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(data<span class="op">.</span><span class="fu">toRows</span>())</span></code></pre></div>
<pre class="text"><code>[ [ 1, 10 ], [ 2, 20 ], [ 3, 30 ] ]</code></pre>
<p>We can also process the rows using a <code>for</code> loop:</p>
<div class="sourceCode" id="cb325"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb325-1"><a href="#cb325-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> row <span class="kw">of</span> data) {</span>
<span id="cb325-2"><a href="#cb325-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(row)</span>
<span id="cb325-3"><a href="#cb325-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre class="text"><code>{ ones: 1, tens: 10 }
{ ones: 2, tens: 20 }
{ ones: 3, tens: 30 }</code></pre>
<p>or its <code>forEach</code> method:</p>
<div class="sourceCode" id="cb327"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb327-1"><a href="#cb327-1" aria-hidden="true" tabindex="-1"></a>data<span class="op">.</span><span class="fu">forEach</span>(row <span class="kw">=&gt;</span> {</span>
<span id="cb327-2"><a href="#cb327-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(row)</span>
<span id="cb327-3"><a href="#cb327-3" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre class="text"><code>{ ones: 1, tens: 10 }
{ ones: 2, tens: 20 }
{ ones: 3, tens: 30 }</code></pre>
<p>However, a good rule of thumb is that if you’re using a loop on a dataframe, you’re doing the wrong thing: you should instead use the methods described below.</p>
<h2 id="s:dataforge-calc">Doing Calculations</h2>
<p>Suppose we want to add a new column to a dataframe—or rather, create a new dataframe with an extra column, since we can’t modify a dataframe in place. To do this, we create a new <code>Series</code> object to represent that column, then use <code>withSeries</code> to construct our result:</p>
<div class="sourceCode" id="cb329"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb329-1"><a href="#cb329-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> double_oh <span class="op">=</span> <span class="kw">new</span> DF<span class="op">.</span><span class="fu">Series</span>([<span class="dv">100</span><span class="op">,</span> <span class="dv">200</span><span class="op">,</span> <span class="dv">300</span>])</span>
<span id="cb329-2"><a href="#cb329-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-3"><a href="#cb329-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> withHundreds <span class="op">=</span> data<span class="op">.</span><span class="fu">withSeries</span>({<span class="dt">hundreds</span><span class="op">:</span> double_oh})</span>
<span id="cb329-4"><a href="#cb329-4" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(withHundreds<span class="op">.</span><span class="fu">toArray</span>())</span></code></pre></div>
<pre class="text"><code>[ { ones: 1, tens: 10, hundreds: 100 },
  { ones: 2, tens: 20, hundreds: 200 },
  { ones: 3, tens: 30, hundreds: 300 } ]</code></pre>
<p>Just as we usually create dataframes by reading data from external sources, we will usually create new columns from existing values. As you probably won’t be surprised to learn, we tell Data-Forge how to do this by writing callback functions. Since we often want to create several new columns at once, we give the <code>generateSeries</code> method an object whose keys are the names of the new columns and whose values are callbacks taking a row as input and producing a new value as output:</p>
<div class="sourceCode" id="cb331"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb331-1"><a href="#cb331-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> sumsAndProducts <span class="op">=</span> data<span class="op">.</span><span class="fu">generateSeries</span>({</span>
<span id="cb331-2"><a href="#cb331-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">sum</span><span class="op">:</span> row <span class="kw">=&gt;</span> row<span class="op">.</span><span class="at">ones</span> <span class="op">+</span> row<span class="op">.</span><span class="at">tens</span><span class="op">,</span></span>
<span id="cb331-3"><a href="#cb331-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">product</span><span class="op">:</span> row <span class="kw">=&gt;</span> row<span class="op">.</span><span class="at">ones</span> <span class="op">*</span> row<span class="op">.</span><span class="at">tens</span></span>
<span id="cb331-4"><a href="#cb331-4" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb331-5"><a href="#cb331-5" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(sumsAndProducts<span class="op">.</span><span class="fu">toArray</span>())</span></code></pre></div>
<pre class="text"><code>[ { ones: 1, tens: 10, sum: 11, product: 10 },
  { ones: 2, tens: 20, sum: 22, product: 40 },
  { ones: 3, tens: 30, sum: 33, product: 90 } ]</code></pre>
<p>We can also get rid of columns entirely using <code>dropSeries</code>:</p>
<div class="sourceCode" id="cb333"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb333-1"><a href="#cb333-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> justResults <span class="op">=</span> sumsAndProducts<span class="op">.</span><span class="fu">dropSeries</span>([<span class="st">&quot;ones&quot;</span><span class="op">,</span> <span class="st">&quot;tens&quot;</span>])</span>
<span id="cb333-2"><a href="#cb333-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(justResults<span class="op">.</span><span class="fu">toArray</span>())</span></code></pre></div>
<pre class="text"><code>[ { sum: 11, product: 10 },
  { sum: 22, product: 40 },
  { sum: 33, product: 90 } ]</code></pre>
<p>Since every dataframe method returns a dataframe, we can use <a href="#g:method-chaining"><strong>method chaining</strong></a> to combine operations (Figure <a href="#f:dataforge-method-chaining" data-reference-type="ref" data-reference="f:dataforge-method-chaining">14.2</a>). We have seen this technique before with chains of <code>.then</code> calls on promises; here, it is used like pipes in the Unix command line or the pipe operator <code>%&gt;%</code> in modern R code:</p>
<div class="sourceCode" id="cb335"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb335-1"><a href="#cb335-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> result <span class="op">=</span> data</span>
<span id="cb335-2"><a href="#cb335-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">withSeries</span>({<span class="dt">hundreds</span><span class="op">:</span> double_oh})</span>
<span id="cb335-3"><a href="#cb335-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">generateSeries</span>({</span>
<span id="cb335-4"><a href="#cb335-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">sum</span><span class="op">:</span> row <span class="kw">=&gt;</span> row<span class="op">.</span><span class="at">ones</span> <span class="op">+</span> row<span class="op">.</span><span class="at">tens</span> <span class="op">+</span> row<span class="op">.</span><span class="at">hundreds</span></span>
<span id="cb335-5"><a href="#cb335-5" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb335-6"><a href="#cb335-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">dropSeries</span>([<span class="st">&quot;ones&quot;</span><span class="op">,</span> <span class="st">&quot;tens&quot;</span><span class="op">,</span> <span class="st">&quot;hundreds&quot;</span>])</span>
<span id="cb335-7"><a href="#cb335-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">toArray</span>()</span></code></pre></div>
<figure>
<img src="figures/dataforge-method-chaining.svg" id="f:dataforge-method-chaining" /><figcaption aria-hidden="true"><span>A More Complicated Pipeline</span><span id="f:dataforge-method-chaining" label="f:dataforge-method-chaining">[f:dataforge-method-chaining]</span></figcaption>
</figure>
<p>To make results easier to understand, we will often want to sort our data. Suppose we have a file containing the red-green-blue values for several colors:</p>
<pre class="text"><code>name,red,green,blue
maroon,128,0,0
lime,0,255,0
navy,0,0,128
yellow,255,255,0
fuchsia,255,0,255
aqua,0,255,255</code></pre>
<p>We can pass the name of this file to our program as a command-line argument, read it (remembering to set the encoding to UTF-8 so that we get characters rather than raw bytes), and then display it:</p>
<div class="sourceCode" id="cb337"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb337-1"><a href="#cb337-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;fs&#39;</span>)</span>
<span id="cb337-2"><a href="#cb337-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> DF <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;data-forge&#39;</span>)</span>
<span id="cb337-3"><a href="#cb337-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb337-4"><a href="#cb337-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> text <span class="op">=</span> fs<span class="op">.</span><span class="fu">readFileSync</span>(<span class="bu">process</span><span class="op">.</span><span class="at">argv</span>[<span class="dv">2</span>]<span class="op">,</span> <span class="st">&#39;utf-8&#39;</span>)</span>
<span id="cb337-5"><a href="#cb337-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> colors <span class="op">=</span> DF<span class="op">.</span><span class="fu">fromCSV</span>(text)</span>
<span id="cb337-6"><a href="#cb337-6" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(colors<span class="op">.</span><span class="fu">toArray</span>())</span></code></pre></div>
<pre class="text"><code>[ { name: &#39;maroon&#39;, red: &#39;128&#39;, green: &#39;0&#39;, blue: &#39;0&#39; },
  { name: &#39;lime&#39;, red: &#39;0&#39;, green: &#39;255&#39;, blue: &#39;0&#39; },
  { name: &#39;navy&#39;, red: &#39;0&#39;, green: &#39;0&#39;, blue: &#39;128&#39; },
  { name: &#39;yellow&#39;, red: &#39;255&#39;, green: &#39;255&#39;, blue: &#39;0&#39; },
  { name: &#39;fuchsia&#39;, red: &#39;255&#39;, green: &#39;0&#39;, blue: &#39;255&#39; },
  { name: &#39;aqua&#39;, red: &#39;0&#39;, green: &#39;255&#39;, blue: &#39;255&#39; } ]</code></pre>
<p>If we want to see the colors in alphabetical order, we call <code>orderBy</code> with a callback that gives Data-Forge the value to sort by:</p>
<div class="sourceCode" id="cb339"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb339-1"><a href="#cb339-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> sorted <span class="op">=</span> colors<span class="op">.</span><span class="fu">orderBy</span>(row <span class="kw">=&gt;</span> row<span class="op">.</span><span class="at">name</span>)</span>
<span id="cb339-2"><a href="#cb339-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(sorted<span class="op">.</span><span class="fu">toArray</span>())</span></code></pre></div>
<pre class="text"><code>[ { name: &#39;aqua&#39;, red: &#39;0&#39;, green: &#39;255&#39;, blue: &#39;255&#39; },
  { name: &#39;fuchsia&#39;, red: &#39;255&#39;, green: &#39;0&#39;, blue: &#39;255&#39; },
  { name: &#39;lime&#39;, red: &#39;0&#39;, green: &#39;255&#39;, blue: &#39;0&#39; },
  { name: &#39;maroon&#39;, red: &#39;128&#39;, green: &#39;0&#39;, blue: &#39;0&#39; },
  { name: &#39;navy&#39;, red: &#39;0&#39;, green: &#39;0&#39;, blue: &#39;128&#39; },
  { name: &#39;yellow&#39;, red: &#39;255&#39;, green: &#39;255&#39;, blue: &#39;0&#39; } ]</code></pre>
<p>To sub-sort (Figure <a href="#f:dataforge-sorting" data-reference-type="ref" data-reference="f:dataforge-sorting">14.3</a>) by another column we use <code>thenBy</code>:</p>
<div class="sourceCode" id="cb341"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb341-1"><a href="#cb341-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> doubleSorted <span class="op">=</span> colors</span>
<span id="cb341-2"><a href="#cb341-2" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">orderBy</span>(row <span class="kw">=&gt;</span> row<span class="op">.</span><span class="at">green</span>)</span>
<span id="cb341-3"><a href="#cb341-3" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">thenBy</span>(row <span class="kw">=&gt;</span> row<span class="op">.</span><span class="at">blue</span>)</span>
<span id="cb341-4"><a href="#cb341-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">dropSeries</span>([<span class="st">&#39;name&#39;</span><span class="op">,</span> <span class="st">&#39;red&#39;</span>])</span>
<span id="cb341-5"><a href="#cb341-5" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(doubleSorted<span class="op">.</span><span class="fu">toArray</span>())</span></code></pre></div>
<pre class="text"><code>[ { green: &#39;0&#39;, blue: &#39;0&#39; },
  { green: &#39;0&#39;, blue: &#39;128&#39; },
  { green: &#39;0&#39;, blue: &#39;255&#39; },
  { green: &#39;255&#39;, blue: &#39;0&#39; },
  { green: &#39;255&#39;, blue: &#39;0&#39; },
  { green: &#39;255&#39;, blue: &#39;255&#39; } ]</code></pre>
<figure>
<img src="figures/dataforge-sorting.svg" id="f:dataforge-sorting" /><figcaption aria-hidden="true"><span>Sorting and Sub-sorting</span><span id="f:dataforge-sorting" label="f:dataforge-sorting">[f:dataforge-sorting]</span></figcaption>
</figure>
<p>We can remove duplicates with <code>distinct</code>:</p>
<div class="sourceCode" id="cb343"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb343-1"><a href="#cb343-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> notTheSame <span class="op">=</span> colors<span class="op">.</span><span class="fu">distinct</span>(row <span class="kw">=&gt;</span> row<span class="op">.</span><span class="at">red</span>)</span>
<span id="cb343-2"><a href="#cb343-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(notTheSame<span class="op">.</span><span class="fu">toArray</span>())</span></code></pre></div>
<pre class="text"><code>[ { name: &#39;maroon&#39;, red: &#39;128&#39;, green: &#39;0&#39;, blue: &#39;0&#39; },
  { name: &#39;lime&#39;, red: &#39;0&#39;, green: &#39;255&#39;, blue: &#39;0&#39; },
  { name: &#39;yellow&#39;, red: &#39;255&#39;, green: &#39;255&#39;, blue: &#39;0&#39; } ]</code></pre>
<p>but this is trickier than it appears. Each row does indeed have a distinct <code>red</code> value, but Data-Forge gets to decide which row to keep from each subset. What’s more surprising is that multi-column <code>distinct</code> <em>doesn’t</em> work:</p>
<div class="sourceCode" id="cb345"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb345-1"><a href="#cb345-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> multiColumn <span class="op">=</span> colors</span>
<span id="cb345-2"><a href="#cb345-2" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">distinct</span>(row <span class="kw">=&gt;</span> [row<span class="op">.</span><span class="at">red</span><span class="op">,</span> row<span class="op">.</span><span class="at">green</span>])</span>
<span id="cb345-3"><a href="#cb345-3" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">orderBy</span>(row <span class="kw">=&gt;</span> row<span class="op">.</span><span class="at">red</span>)</span>
<span id="cb345-4"><a href="#cb345-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">thenBy</span>(row <span class="kw">=&gt;</span> row<span class="op">.</span><span class="at">green</span>)</span>
<span id="cb345-5"><a href="#cb345-5" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(multiColumn<span class="op">.</span><span class="fu">toArray</span>())</span></code></pre></div>
<pre class="text"><code>[ { name: &#39;navy&#39;, red: &#39;0&#39;, green: &#39;0&#39;, blue: &#39;128&#39; },
  { name: &#39;lime&#39;, red: &#39;0&#39;, green: &#39;255&#39;, blue: &#39;0&#39; },
  { name: &#39;aqua&#39;, red: &#39;0&#39;, green: &#39;255&#39;, blue: &#39;255&#39; },
  { name: &#39;maroon&#39;, red: &#39;128&#39;, green: &#39;0&#39;, blue: &#39;0&#39; },
  { name: &#39;fuchsia&#39;, red: &#39;255&#39;, green: &#39;0&#39;, blue: &#39;255&#39; },
  { name: &#39;yellow&#39;, red: &#39;255&#39;, green: &#39;255&#39;, blue: &#39;0&#39; } ]</code></pre>
<p>This isn’t Data-Forge’s fault. In JavaScript, two arrays are only equal if they’re the same object, i.e., <code>[0] === [0]</code> is <code>false</code>. We will explore ways of doing multi-column <code>distinct</code> in the exercises.</p>
<h2 id="s:dataforge-subset">Subsets</h2>
<p>You may have noticed that the color values in the table above are strings rather than numbers. If we want Data-Forge to convert values to more useful types, we can use the methods <code>parseDates</code>, <code>parseFloats</code>, and so on. The program below does this for a subset of <a href="https://earthquake.usgs.gov/earthquakes/feed/v1.0/csv.php">USGS data about earthquakes in August 2016</a>:</p>
<div class="sourceCode" id="cb347"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb347-1"><a href="#cb347-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;fs&#39;</span>)</span>
<span id="cb347-2"><a href="#cb347-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> DF <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;data-forge&#39;</span>)</span>
<span id="cb347-3"><a href="#cb347-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb347-4"><a href="#cb347-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> text <span class="op">=</span> fs<span class="op">.</span><span class="fu">readFileSync</span>(<span class="st">&#39;earthquakes.csv&#39;</span><span class="op">,</span> <span class="st">&#39;utf-8&#39;</span>)</span>
<span id="cb347-5"><a href="#cb347-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> earthquakes <span class="op">=</span> DF</span>
<span id="cb347-6"><a href="#cb347-6" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">fromCSV</span>(text)</span>
<span id="cb347-7"><a href="#cb347-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">parseDates</span>(<span class="st">&#39;Time&#39;</span>)</span>
<span id="cb347-8"><a href="#cb347-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">parseFloats</span>([<span class="st">&#39;Latitude&#39;</span><span class="op">,</span> <span class="st">&#39;Longitude&#39;</span><span class="op">,</span> <span class="st">&#39;Depth_Km&#39;</span><span class="op">,</span> <span class="st">&#39;Magnitude&#39;</span>])</span>
<span id="cb347-9"><a href="#cb347-9" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Data has&#39;</span><span class="op">,</span> earthquakes<span class="op">.</span><span class="fu">count</span>()<span class="op">,</span> <span class="st">&#39;rows&#39;</span>)</span></code></pre></div>
<pre class="text"><code>Data has 798 rows</code></pre>
<p>Whether we convert it or not, we will often want to work with subsets of data. We can select values by position using <code>head</code> and <code>tail</code> (which are named after classic Unix commands):</p>
<div class="sourceCode" id="cb349"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb349-1"><a href="#cb349-1" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(earthquakes<span class="op">.</span><span class="fu">head</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">toArray</span>())</span></code></pre></div>
<pre class="text"><code>[ { Time: 2016-08-24T07:36:32.000Z,
    Latitude: 42.6983,
    Longitude: 13.2335,
    Depth_Km: 8.1,
    Magnitude: 6 },
  { Time: 2016-08-24T07:37:26.580Z,
    Latitude: 42.7123,
    Longitude: 13.2533,
    Depth_Km: 9,
    Magnitude: 4.5 },
  { Time: 2016-08-24T07:40:46.590Z,
    Latitude: 42.7647,
    Longitude: 13.1723,
    Depth_Km: 9.7,
    Magnitude: 3.8 } ]</code></pre>
<div class="sourceCode" id="cb351"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb351-1"><a href="#cb351-1" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(earthquakes<span class="op">.</span><span class="fu">tail</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">toArray</span>())</span></code></pre></div>
<pre class="text"><code>[ { Time: 2016-08-26T10:09:45.380Z,
    Latitude: 42.6953,
    Longitude: 13.2363,
    Depth_Km: 9.5,
    Magnitude: 2.3 },
  { Time: 2016-08-26T10:11:55.960Z,
    Latitude: 42.6163,
    Longitude: 13.2985,
    Depth_Km: 11,
    Magnitude: 2.1 },
  { Time: 2016-08-26T10:21:09.870Z,
    Latitude: 42.6153,
    Longitude: 13.2952,
    Depth_Km: 7.5,
    Magnitude: 3 } ]</code></pre>
<p>If we want data from the middle of the table, we can skip a few rows and then take as many as we want (Figure <a href="#f:dataforge-positional" data-reference-type="ref" data-reference="f:dataforge-positional">14.4</a>):</p>
<div class="sourceCode" id="cb353"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb353-1"><a href="#cb353-1" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(earthquakes<span class="op">.</span><span class="fu">skip</span>(<span class="dv">10</span>)<span class="op">.</span><span class="fu">take</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">toArray</span>())</span></code></pre></div>
<pre class="text"><code>[ { Time: 2016-08-24T07:47:51.540Z,
    Latitude: 42.6675,
    Longitude: 13.3238,
    Depth_Km: 6.5,
    Magnitude: 3.3 },
  { Time: 2016-08-24T07:52:25.710Z,
    Latitude: 42.7447,
    Longitude: 13.2827,
    Depth_Km: 7.9,
    Magnitude: 2.9 },
  { Time: 2016-08-24T07:52:43.210Z,
    Latitude: 42.6378,
    Longitude: 13.2313,
    Depth_Km: 10.9,
    Magnitude: 3.1 } ]</code></pre>
<figure>
<img src="figures/dataforge-positional.svg" id="f:dataforge-positional" /><figcaption aria-hidden="true"><span>Selecting by Position</span><span id="f:dataforge-positional" label="f:dataforge-positional">[f:dataforge-positional]</span></figcaption>
</figure>
<p>However, it’s far more common to select rows by the values they contain rather than by their position. Just like the <code>Array.filter</code> method we met way back in Section <a href="#s:callbacks-functional" data-reference-type="ref" data-reference="s:callbacks-functional">3.4</a>, we do this by giving Data-Forge a callback function that tells it whether a given row should be kept or not. This text can be as complex as desired, but must work row by row: we cannot make a decision about one row based on the values in the rows before it or after it.</p>
<div class="sourceCode" id="cb355"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb355-1"><a href="#cb355-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> large <span class="op">=</span> earthquakes<span class="op">.</span><span class="fu">where</span>(row <span class="kw">=&gt;</span> (row<span class="op">.</span><span class="at">Magnitude</span> <span class="op">&gt;=</span> <span class="fl">5.0</span>))</span>
<span id="cb355-2"><a href="#cb355-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(large<span class="op">.</span><span class="fu">toArray</span>())</span></code></pre></div>
<pre class="text"><code>[ { Time: 2016-08-24T07:36:32.000Z,
    Latitude: 42.6983,
    Longitude: 13.2335,
    Depth_Km: 8.1,
    Magnitude: 6 },
  { Time: 2016-08-24T08:33:28.890Z,
    Latitude: 42.7922,
    Longitude: 13.1507,
    Depth_Km: 8,
    Magnitude: 5.4 } ]</code></pre>
<h2 id="s:dataforge-aggregate">Aggregation</h2>
<p>Working with individual observations is all very well, but if we want to understand our data, we need to look at its aggregate properties. If, for example, we want to know the average depth and magnitude of our earthquakes, we use the <code>summarize</code> method:</p>
<div class="sourceCode" id="cb357"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb357-1"><a href="#cb357-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> averageValues <span class="op">=</span> earthquakes<span class="op">.</span><span class="fu">summarize</span>({</span>
<span id="cb357-2"><a href="#cb357-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Depth_Km</span><span class="op">:</span> series <span class="kw">=&gt;</span> series<span class="op">.</span><span class="fu">average</span>()<span class="op">,</span></span>
<span id="cb357-3"><a href="#cb357-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Magnitude</span><span class="op">:</span> series <span class="kw">=&gt;</span> series<span class="op">.</span><span class="fu">average</span>()</span>
<span id="cb357-4"><a href="#cb357-4" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb357-5"><a href="#cb357-5" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(averageValues)</span></code></pre></div>
<pre class="text"><code>{ Depth_Km: 9.545614035087722, Magnitude: 2.5397243107769376 }</code></pre>
<p>As with <code>filter</code>, we can do many calculations at once by giving <code>summarize</code> several callbacks. The keys of the object we pass in specify the columns we want to aggregate; the callbacks invoke methods of the <code>Series</code> class that Data-Forge uses to store individual columns. Instead of producing a dataframe with a single row, <code>summarize</code> produces an object whose keys match the names of the columns in our original dataframe.</p>
<p>Aggregation is often combined with grouping: for example, we may want to calculate the average weight of rats of different breeds or the distribution of votes by province. The first step is to group the data:</p>
<div class="sourceCode" id="cb359"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb359-1"><a href="#cb359-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> groupedByMagnitude <span class="op">=</span> earthquakes<span class="op">.</span><span class="fu">groupBy</span>(row <span class="kw">=&gt;</span> row<span class="op">.</span><span class="at">Magnitude</span>)</span>
<span id="cb359-2"><a href="#cb359-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`</span><span class="sc">${</span>groupedByMagnitude<span class="op">.</span><span class="fu">count</span>()<span class="sc">}</span><span class="vs"> groups`</span>)</span>
<span id="cb359-3"><a href="#cb359-3" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(groupedByMagnitude<span class="op">.</span><span class="fu">head</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">toArray</span>())</span></code></pre></div>
<pre class="text"><code>28 groups
[ DataFrame {
    configFn: null,
    content:
     { index: [ExtractElementIterable],
       values: [ExtractElementIterable],
       pairs: [Array],
       isBaked: false,
       columnNames: [ColumnNamesIterable] } },
  DataFrame {
    configFn: null,
    content:
     { index: [ExtractElementIterable],
       values: [ExtractElementIterable],
       pairs: [Array],
       isBaked: false,
       columnNames: [ColumnNamesIterable] } } ]</code></pre>
<p>As the output shows, <code>groupBy</code> returns an array containing one new dataframe for each group in our original data. Here’s how we find the average depth of earthquakes according to magnitude:</p>
<div class="sourceCode" id="cb361"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb361-1"><a href="#cb361-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> averaged <span class="op">=</span> earthquakes</span>
<span id="cb361-2"><a href="#cb361-2" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">groupBy</span>(row <span class="kw">=&gt;</span> row<span class="op">.</span><span class="at">Magnitude</span>)</span>
<span id="cb361-3"><a href="#cb361-3" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">select</span>(group <span class="kw">=&gt;</span> ({</span>
<span id="cb361-4"><a href="#cb361-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Magnitude</span><span class="op">:</span> group<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="at">Magnitude</span><span class="op">,</span></span>
<span id="cb361-5"><a href="#cb361-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Depth_Km</span><span class="op">:</span> group<span class="op">.</span><span class="fu">deflate</span>(row <span class="kw">=&gt;</span> row<span class="op">.</span><span class="at">Depth_Km</span>)<span class="op">.</span><span class="fu">average</span>()</span>
<span id="cb361-6"><a href="#cb361-6" aria-hidden="true" tabindex="-1"></a>      }))</span>
<span id="cb361-7"><a href="#cb361-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">inflate</span>()</span>
<span id="cb361-8"><a href="#cb361-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">orderBy</span>(row <span class="kw">=&gt;</span> row<span class="op">.</span><span class="at">Magnitude</span>)</span>
<span id="cb361-9"><a href="#cb361-9" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(averaged<span class="op">.</span><span class="fu">toArray</span>())</span></code></pre></div>
<pre class="text"><code>[ { Magnitude: 2, Depth_Km: 9.901052631578946 },
  { Magnitude: 2.1, Depth_Km: 9.702083333333333 },
  { Magnitude: 2.2, Depth_Km: 9.843037974683545 },
  ...
  { Magnitude: 4.5, Depth_Km: 9.4 },
  { Magnitude: 5.4, Depth_Km: 8 },
  { Magnitude: 6, Depth_Km: 8.1 } ]</code></pre>
<p>Going through this step by step:</p>
<ol>
<li><p>The <code>groupBy</code> call produces a list of 28 dataframes, one for each distinct value of <code>Magnitude</code>.</p></li>
<li><p><code>select</code> then converts each of these dataframes into an object whose <code>Magnitude</code> is equal to the magnitude of the group’s first element and whose <code>Depth_Km</code> is the average of the depths.</p>
<ul>
<li><p>We can use the magnitude of the group’s first element because all of the magnitudes in the group are the same.</p></li>
<li><p>We must also remember to use <code>deflate</code> to turn a column of a dataframe into a <code>Series</code> so that we can then call <code>average</code>.</p></li>
</ul></li>
<li><p>The output of <code>select</code> is a <code>Series</code> of two-valued objects, so we must call <code>inflate</code> to convert it back to a <code>DataFrame</code>.</p></li>
<li><p>Finally, we order by the magnitude of the earthquakes to produce our output.</p></li>
</ol>
<p>Figure <a href="#f:dataforge-summarizing" data-reference-type="ref" data-reference="f:dataforge-summarizing">14.5</a> shows these steps graphically. It’s easy to forget the <code>inflate</code> and <code>deflate</code> steps at first (we did when writing this example), but they quickly become habitual.</p>
<figure>
<img src="figures/dataforge-summarizing.svg" id="f:dataforge-summarizing" /><figcaption aria-hidden="true"><span>Summarizing Groups</span><span id="f:dataforge-summarizing" label="f:dataforge-summarizing">[f:dataforge-summarizing]</span></figcaption>
</figure>
<h2 id="s:dataforge-real">In Real Life</h2>
<p>To wrap up our exploration of Data-Forge, we will explore data from <a href="http://dataisplural/data.world">http://dataisplural/data.world</a> to find the annual recreational visits to national parks in the United States for the last ten years. Our strategy is to:</p>
<ol>
<li><p>import the data,</p></li>
<li><p>inspect the columns to make sure the data is clean,</p></li>
<li><p>fix any problems we notice,</p></li>
<li><p>group the data by year and summarize the total visitors, and then</p></li>
<li><p>filter to keep only the years that are greater than 2009.</p></li>
</ol>
<p>We’ll start by reading the data and looking at the first couple of rows:</p>
<div class="sourceCode" id="cb363"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb363-1"><a href="#cb363-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;fs&#39;</span>)</span>
<span id="cb363-2"><a href="#cb363-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> DF <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;data-forge&#39;</span>)</span>
<span id="cb363-3"><a href="#cb363-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb363-4"><a href="#cb363-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> text <span class="op">=</span> fs<span class="op">.</span><span class="fu">readFileSync</span>(<span class="st">&#39;../../data/national_parks.csv&#39;</span><span class="op">,</span> <span class="st">&#39;utf-8&#39;</span>)</span>
<span id="cb363-5"><a href="#cb363-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> raw <span class="op">=</span> DF<span class="op">.</span><span class="fu">fromCSV</span>(text)</span>
<span id="cb363-6"><a href="#cb363-6" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(raw<span class="op">.</span><span class="fu">head</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">toArray</span>())</span></code></pre></div>
<pre class="text"><code>[ { year: &#39;1904&#39;,
    gnis_id: &#39;1163670&#39;,
    geometry: &#39;POLYGON&#39;,
    metadata: &#39;NA&#39;,
    number_of_records: &#39;1&#39;,
    parkname: &#39;Crater Lake&#39;,
    region: &#39;PW&#39;,
    state: &#39;OR&#39;,
    unit_code: &#39;CRLA&#39;,
    unit_name: &#39;Crater Lake National Park&#39;,
    unit_type: &#39;National Park&#39;,
    visitors: &#39;1500&#39; },
  { year: &#39;1941&#39;,
    gnis_id: &#39;1531834&#39;,
    geometry: &#39;MULTIPOLYGON&#39;,
    metadata: &#39;NA&#39;,
    number_of_records: &#39;1&#39;,
    parkname: &#39;Lake Roosevelt&#39;,
    region: &#39;PW&#39;,
    state: &#39;WA&#39;,
    unit_code: &#39;LARO&#39;,
    unit_name: &#39;Lake Roosevelt National Recreation Area&#39;,
    unit_type: &#39;National Recreation Area&#39;,
    visitors: &#39;0&#39; } ]</code></pre>
<p>It’s always good to look at the structure of the data before we dive into any analysis. The dataframe method <code>detectTypes</code> shows us the frequency of data types in our dataframe:</p>
<div class="sourceCode" id="cb365"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb365-1"><a href="#cb365-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> typesDf <span class="op">=</span> raw<span class="op">.</span><span class="fu">detectTypes</span>() </span>
<span id="cb365-2"><a href="#cb365-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(typesDf<span class="op">.</span><span class="fu">toString</span>())</span></code></pre></div>
<pre class="text"><code>__index__  Type    Frequency  Column
---------  ------  ---------  -----------------
0          string  100        year
1          string  100        gnis_id
2          string  100        geometry
3          string  100        metadata
4          string  100        number_of_records
5          string  100        parkname
6          string  100        region
7          string  100        state
8          string  100        unit_code
9          string  100        unit_name
10         string  100        unit_type
11         string  100        visitors</code></pre>
<p>We want numbers instead of strings for <code>year</code> and <code>visitors</code>, but before we transform them, let’s check and see if any values in those columns are <code>NA</code>, meaning “not available”:</p>
<div class="sourceCode" id="cb367"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb367-1"><a href="#cb367-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cleaned <span class="op">=</span> raw</span>
<span id="cb367-2"><a href="#cb367-2" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">where</span>(row <span class="kw">=&gt;</span> ((row<span class="op">.</span><span class="at">year</span> <span class="op">!=</span> <span class="st">&#39;NA&#39;</span>) <span class="op">&amp;&amp;</span> (row<span class="op">.</span><span class="at">visitors</span> <span class="op">!=</span> <span class="st">&#39;NA&#39;</span>)))</span>
<span id="cb367-3"><a href="#cb367-3" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`</span><span class="sc">${</span>raw<span class="op">.</span><span class="fu">count</span>()<span class="sc">}</span><span class="vs"> original rows and </span><span class="sc">${</span>cleaned<span class="op">.</span><span class="fu">count</span>()<span class="sc">}</span><span class="vs"> cleaned rows`</span>)</span></code></pre></div>
<pre class="text"><code>21560 original rows and 21556 cleaned rows</code></pre>
<p>Four rows contain missing values. We probably wouldn’t spot them if we scrolled through the data ourselves, so it’s good that we let the computer do the work. Let’s remove those four rows and convert the two columns of interest from strings to numbers:</p>
<div class="sourceCode" id="cb369"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb369-1"><a href="#cb369-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> data <span class="op">=</span> raw</span>
<span id="cb369-2"><a href="#cb369-2" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">where</span>(row <span class="kw">=&gt;</span> ((row<span class="op">.</span><span class="at">year</span> <span class="op">!=</span> <span class="st">&#39;NA&#39;</span>) <span class="op">&amp;&amp;</span> (row<span class="op">.</span><span class="at">visitors</span> <span class="op">!=</span> <span class="st">&#39;NA&#39;</span>)))</span>
<span id="cb369-3"><a href="#cb369-3" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">parseFloats</span>([<span class="st">&#39;year&#39;</span><span class="op">,</span> <span class="st">&#39;visitors&#39;</span>])</span>
<span id="cb369-4"><a href="#cb369-4" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`</span><span class="sc">${</span>data<span class="op">.</span><span class="fu">count</span>()<span class="sc">}</span><span class="vs"> rows`</span>)</span>
<span id="cb369-5"><a href="#cb369-5" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(data<span class="op">.</span><span class="fu">detectTypes</span>()<span class="op">.</span><span class="fu">toString</span>())</span></code></pre></div>
<pre class="text"><code>21556 rows
__index__  Type    Frequency  Column
---------  ------  ---------  -----------------
0          number  100        year
...        ...     ...        ...
11         number  100        visitors</code></pre>
<p>This looks good: we have dropped the four offending rows and everything else is a number. With clean data, we can now group by year and find the total number of visitors in each year:</p>
<div class="sourceCode" id="cb371"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb371-1"><a href="#cb371-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> annual <span class="op">=</span> data</span>
<span id="cb371-2"><a href="#cb371-2" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">groupBy</span>(row <span class="kw">=&gt;</span> row<span class="op">.</span><span class="at">year</span>)</span>
<span id="cb371-3"><a href="#cb371-3" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">select</span>(group <span class="kw">=&gt;</span> ({</span>
<span id="cb371-4"><a href="#cb371-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">year</span><span class="op">:</span> group<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="at">year</span><span class="op">,</span></span>
<span id="cb371-5"><a href="#cb371-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">visitors</span><span class="op">:</span> group<span class="op">.</span><span class="fu">deflate</span>(row <span class="kw">=&gt;</span> row<span class="op">.</span><span class="at">visitors</span>)<span class="op">.</span><span class="fu">sum</span>()</span>
<span id="cb371-6"><a href="#cb371-6" aria-hidden="true" tabindex="-1"></a>      }))</span>
<span id="cb371-7"><a href="#cb371-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">inflate</span>()</span>
<span id="cb371-8"><a href="#cb371-8" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">orderBy</span>(row <span class="kw">=&gt;</span> row<span class="op">.</span><span class="at">year</span>)</span>
<span id="cb371-9"><a href="#cb371-9" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(annual<span class="op">.</span><span class="fu">toString</span>())</span></code></pre></div>
<pre class="text"><code>__index__  year  visitors   
---------  ----  -----------
0          1904  120690     
112        1905  140954     
88         NaN   13764633135
55         1906  30569      
113        1907  32935      
61         1908  42768      
111        1909  60899      
110        1910  173416     
...        ...   ...
23         2011  276799292  
91         2012  281392715  
70         2013  271305455  
89         2014  290105230  
78         2015  304730566  
75         2016  328483428  </code></pre>
<p>Uh oh. What’s that <code>NaN</code> doing there in the third row? Are there still some missing values in the <code>year</code> column?</p>
<div class="sourceCode" id="cb373"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb373-1"><a href="#cb373-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> numNan <span class="op">=</span> data</span>
<span id="cb373-2"><a href="#cb373-2" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">where</span>(row <span class="kw">=&gt;</span> (<span class="pp">isNaN</span>(row<span class="op">.</span><span class="at">year</span>) <span class="op">||</span> <span class="pp">isNaN</span>(row<span class="op">.</span><span class="at">visitors</span>)))</span>
<span id="cb373-3"><a href="#cb373-3" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">count</span>()</span>
<span id="cb373-4"><a href="#cb373-4" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`</span><span class="sc">${</span>numNan<span class="sc">}</span><span class="vs"> rows have NaN`</span>)</span></code></pre></div>
<pre class="text"><code>382 rows have NaN</code></pre>
<p>The exercises will look at where these non-numbers have come from and how we should handle them. Even if you don’t live close to a national park, we encourage you to take a break and step outside before tackling the exercises below.</p>
<h2 id="s:dataforge-exercises">Exercises</h2>
<h3 class="unnumbered" id="other-data-formats">Other Data Formats</h3>
<p>Write a short program that reads data from <code>colors.csv</code>, converts the red-green-blue values to numbers, and saves the result as JSON. Once that is working, write another program that reads the JSON file and converts it back to CSV. Are there any differences between your second program’s output and your original CSV file?</p>
<h3 class="unnumbered" id="directional-sorting">Directional Sorting</h3>
<p>Modify the program in Section <a href="#s:dataforge-calc" data-reference-type="ref" data-reference="s:dataforge-calc">14.2</a> to sort color values by <em>increasing</em> red and <em>decreasing</em> green.</p>
<h3 class="unnumbered" id="multi-column-distinct">Multi-Column Distinct</h3>
<p>Section <a href="#s:dataforge-calc" data-reference-type="ref" data-reference="s:dataforge-calc">14.2</a> pointed out that we cannot use <code>distinct</code> to find rows with distinct combinations of values. What <em>can</em> we do? To show that your idea works, write a program that gets distinct combinations of red and green values from the color data:</p>
<pre class="text"><code>red,green
0,0
0,255
128,0
255,0
255,255</code></pre>
<h3 class="unnumbered" id="revisiting-data-manipulation">Revisiting Data Manipulation</h3>
<p>Back in the chapter on data manipulation, we aggregated <code>surveys.csv</code> to find the minimum, maximum, and average values for <code>year</code>, <code>hindfoot_length</code>, and <code>weight</code>. Repeat this exercise using the methods of <code>data-forge</code>.</p>
<h3 class="unnumbered" id="grouping-and-aggregating">Grouping and Aggregating</h3>
<p>Retrace the steps in the example that calculated the average depth of earthquakes of different magnitudes and show the data structure after each method call. Are they all dataframes, or are other data structures created or manipulated as well?</p>
<h3 class="unnumbered" id="not-a-number">Not a Number</h3>
<p>Write a short pipeline that prints out the values in the <code>year</code> and <code>visitors</code> columns that wind up being converted to <code>NaN</code>. (Hint: copy the columns, convert the copies to numbers, filter to keep those rows, then print the original values.)</p>
<h2 class="unnumbered" id="key-points-13">Key Points</h2>
<ul>
<li><p>Create a <code>DataFrame</code> from an array of objects with identical keys, from a spec with <code>columnNames</code> and <code>rows</code> fields, or by parsing text that contains CSV or JSON.</p></li>
<li><p>If you’re using a loop on a dataframe, you’re doing the wrong thing.</p></li>
<li><p>Use method chaining to create pipelines that filter data and create new values from old.</p></li>
<li><p>Use grouping and aggregation to summarize data.</p></li>
</ul>
<h1 id="s:capstone">Capstone Project</h1>
<p>It’s time to bring everything together in an extended example: a (slightly) interactive visualization of species data from the <a href="https://figshare.com/articles/Portal_Project_Teaching_Database/1314459">Portal Project Teaching Database</a>. Our plan is to:</p>
<ul>
<li><p>slice data for testing,</p></li>
<li><p>write a data server to serve that data,</p></li>
<li><p>test the server,</p></li>
<li><p>build an interactive tabular display of our data, and</p></li>
<li><p>add visualization.</p></li>
</ul>
<p>This will require a few new ideas, but will mostly recapitulate what’s come before.</p>
<h2 id="s:capstone-data">Data Manager</h2>
<p>We could use exactly the same data manager as the one we built in Chapter <a href="#s:dataman" data-reference-type="ref" data-reference="s:dataman">11</a>, but let’s apply our new-found knowledge of the Data-Forge library instead. As a reminder, the key class in our data manager is:</p>
<div class="sourceCode" id="cb376"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb376-1"><a href="#cb376-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataManager {</span>
<span id="cb376-2"><a href="#cb376-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb376-3"><a href="#cb376-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span> (filename) {</span>
<span id="cb376-4"><a href="#cb376-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...read and store data from CSV file...</span></span>
<span id="cb376-5"><a href="#cb376-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb376-6"><a href="#cb376-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb376-7"><a href="#cb376-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getSurveyStats</span> () {</span>
<span id="cb376-8"><a href="#cb376-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...return summary statistics...</span></span>
<span id="cb376-9"><a href="#cb376-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb376-10"><a href="#cb376-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb376-11"><a href="#cb376-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getSurveyRange</span> (minYear<span class="op">,</span> maxYear) {</span>
<span id="cb376-12"><a href="#cb376-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...return slice of data...</span></span>
<span id="cb376-13"><a href="#cb376-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb376-14"><a href="#cb376-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The new <code>DataManager</code> must still begin by reading data from a CSV file, so we keep the line where we use <code>fs</code> to open the file and convert the rest of <code>constructor</code>:</p>
<div class="sourceCode" id="cb377"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb377-1"><a href="#cb377-1" aria-hidden="true" tabindex="-1"></a><span class="fu">constructor</span> (filename) {</span>
<span id="cb377-2"><a href="#cb377-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> raw <span class="op">=</span> fs<span class="op">.</span><span class="fu">readFileSync</span>(filename<span class="op">,</span> <span class="st">&#39;utf-8&#39;</span>)</span>
<span id="cb377-3"><a href="#cb377-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="at">data</span> <span class="op">=</span> DF<span class="op">.</span><span class="fu">fromCSV</span>(raw)</span>
<span id="cb377-4"><a href="#cb377-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">parseInts</span>([<span class="st">&#39;record_id&#39;</span><span class="op">,</span><span class="st">&#39;month&#39;</span><span class="op">,</span><span class="st">&#39;day&#39;</span><span class="op">,</span><span class="st">&#39;year&#39;</span><span class="op">,</span><span class="st">&#39;plot_id&#39;</span>])</span>
<span id="cb377-5"><a href="#cb377-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">parseFloats</span>([<span class="st">&#39;hindfoot_length&#39;</span><span class="op">,</span><span class="st">&#39;weight&#39;</span>])</span>
<span id="cb377-6"><a href="#cb377-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Remember that <code>_get</code> method we had to write to summarize the data for each year? Working with dataframes allows us to avoid doing that ourselves in <code>getSurveyStats</code> and makes things comparatively easy to read:</p>
<div class="sourceCode" id="cb378"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb378-1"><a href="#cb378-1" aria-hidden="true" tabindex="-1"></a><span class="fu">getSurveyStats</span> () {</span>
<span id="cb378-2"><a href="#cb378-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {</span>
<span id="cb378-3"><a href="#cb378-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">year_low</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="fu">deflate</span>(row <span class="kw">=&gt;</span> row<span class="op">.</span><span class="at">year</span>)<span class="op">.</span><span class="fu">min</span>()<span class="op">,</span></span>
<span id="cb378-4"><a href="#cb378-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">year_high</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="fu">deflate</span>(row <span class="kw">=&gt;</span> row<span class="op">.</span><span class="at">year</span>)<span class="op">.</span><span class="fu">max</span>()<span class="op">,</span></span>
<span id="cb378-5"><a href="#cb378-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">record_count</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="fu">count</span>()</span>
<span id="cb378-6"><a href="#cb378-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb378-7"><a href="#cb378-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We must also adapt <code>getSurveyRange</code> to work with the dataframe:</p>
<div class="sourceCode" id="cb379"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb379-1"><a href="#cb379-1" aria-hidden="true" tabindex="-1"></a><span class="fu">getSurveyRange</span> (minYear<span class="op">,</span> maxYear) {</span>
<span id="cb379-2"><a href="#cb379-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">Array</span>(<span class="dv">1</span> <span class="op">+</span> maxYear <span class="op">-</span> minYear)</span>
<span id="cb379-3"><a href="#cb379-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">fill</span>(<span class="dv">0</span>)</span>
<span id="cb379-4"><a href="#cb379-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>((v<span class="op">,</span> i) <span class="kw">=&gt;</span> minYear <span class="op">+</span> i)</span>
<span id="cb379-5"><a href="#cb379-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(year <span class="kw">=&gt;</span> {</span>
<span id="cb379-6"><a href="#cb379-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> subset <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="fu">where</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">year</span> <span class="op">===</span> year)</span>
<span id="cb379-7"><a href="#cb379-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (subset<span class="op">.</span><span class="fu">count</span>()) {</span>
<span id="cb379-8"><a href="#cb379-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> {</span>
<span id="cb379-9"><a href="#cb379-9" aria-hidden="true" tabindex="-1"></a>        <span class="dt">key</span><span class="op">:</span> <span class="fu">toString</span>(year)<span class="op">,</span></span>
<span id="cb379-10"><a href="#cb379-10" aria-hidden="true" tabindex="-1"></a>        <span class="dt">year</span><span class="op">:</span> year<span class="op">,</span></span>
<span id="cb379-11"><a href="#cb379-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">min_hindfoot_length</span><span class="op">:</span> subset<span class="op">.</span><span class="fu">deflate</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">hindfoot_length</span>)</span>
<span id="cb379-12"><a href="#cb379-12" aria-hidden="true" tabindex="-1"></a>                                   <span class="op">.</span><span class="fu">min</span>()<span class="op">,</span></span>
<span id="cb379-13"><a href="#cb379-13" aria-hidden="true" tabindex="-1"></a>        <span class="dt">ave_hindfoot_length</span><span class="op">:</span> subset<span class="op">.</span><span class="fu">deflate</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">hindfoot_length</span>)</span>
<span id="cb379-14"><a href="#cb379-14" aria-hidden="true" tabindex="-1"></a>                                   <span class="op">.</span><span class="fu">average</span>()<span class="op">,</span></span>
<span id="cb379-15"><a href="#cb379-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">max_hindfoot_length</span><span class="op">:</span> subset<span class="op">.</span><span class="fu">deflate</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">hindfoot_length</span>)</span>
<span id="cb379-16"><a href="#cb379-16" aria-hidden="true" tabindex="-1"></a>                                   <span class="op">.</span><span class="fu">max</span>()<span class="op">,</span></span>
<span id="cb379-17"><a href="#cb379-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">min_weight</span><span class="op">:</span> subset<span class="op">.</span><span class="fu">deflate</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">weight</span>)</span>
<span id="cb379-18"><a href="#cb379-18" aria-hidden="true" tabindex="-1"></a>                          <span class="op">.</span><span class="fu">min</span>()<span class="op">,</span></span>
<span id="cb379-19"><a href="#cb379-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">ave_weight</span><span class="op">:</span> subset<span class="op">.</span><span class="fu">deflate</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">weight</span>)</span>
<span id="cb379-20"><a href="#cb379-20" aria-hidden="true" tabindex="-1"></a>                          <span class="op">.</span><span class="fu">average</span>()<span class="op">,</span></span>
<span id="cb379-21"><a href="#cb379-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">max_weight</span><span class="op">:</span> subset<span class="op">.</span><span class="fu">deflate</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">weight</span>)</span>
<span id="cb379-22"><a href="#cb379-22" aria-hidden="true" tabindex="-1"></a>                          <span class="op">.</span><span class="fu">max</span>()</span>
<span id="cb379-23"><a href="#cb379-23" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb379-24"><a href="#cb379-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb379-25"><a href="#cb379-25" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb379-26"><a href="#cb379-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This removes the need for the <code>_get</code> method, but when we test the code we find that blank spaces are displayed where the summary values should be for a suspicious number of years. On closer inspection, we discover that <code>min</code> and other summarizing methods are sensitive to missing data: they return <code>NaN</code> if any values are absent in the series on which they are called, or <code>undefined</code> if they’re all missing. We therefore need an additional filter step to remove the rows with missing data in the columns that we’re interested in (weight and hindfoot length):</p>
<div class="sourceCode" id="cb380"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb380-1"><a href="#cb380-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ...as before...</span></span>
<span id="cb380-2"><a href="#cb380-2" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (subset<span class="op">.</span><span class="fu">count</span>()) {</span>
<span id="cb380-3"><a href="#cb380-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb380-4"><a href="#cb380-4" aria-hidden="true" tabindex="-1"></a>          <span class="dt">key</span><span class="op">:</span> <span class="fu">toString</span>(year)<span class="op">,</span></span>
<span id="cb380-5"><a href="#cb380-5" aria-hidden="true" tabindex="-1"></a>          <span class="dt">year</span><span class="op">:</span> year<span class="op">,</span></span>
<span id="cb380-6"><a href="#cb380-6" aria-hidden="true" tabindex="-1"></a>          <span class="dt">min_hindfoot_length</span><span class="op">:</span> subset</span>
<span id="cb380-7"><a href="#cb380-7" aria-hidden="true" tabindex="-1"></a>                               <span class="op">.</span><span class="fu">where</span>(r <span class="kw">=&gt;</span> <span class="op">!</span><span class="pp">isNaN</span>(r<span class="op">.</span><span class="at">hindfoot_length</span>))</span>
<span id="cb380-8"><a href="#cb380-8" aria-hidden="true" tabindex="-1"></a>                               <span class="op">.</span><span class="fu">deflate</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">hindfoot_length</span>)</span>
<span id="cb380-9"><a href="#cb380-9" aria-hidden="true" tabindex="-1"></a>                               <span class="op">.</span><span class="fu">min</span>()<span class="op">,</span></span>
<span id="cb380-10"><a href="#cb380-10" aria-hidden="true" tabindex="-1"></a>          <span class="dt">ave_hindfoot_length</span><span class="op">:</span> subset</span>
<span id="cb380-11"><a href="#cb380-11" aria-hidden="true" tabindex="-1"></a>                               <span class="op">.</span><span class="fu">where</span>(r <span class="kw">=&gt;</span> <span class="op">!</span><span class="pp">isNaN</span>(r<span class="op">.</span><span class="at">hindfoot_length</span>))</span>
<span id="cb380-12"><a href="#cb380-12" aria-hidden="true" tabindex="-1"></a>                               <span class="op">.</span><span class="fu">deflate</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">hindfoot_length</span>)</span>
<span id="cb380-13"><a href="#cb380-13" aria-hidden="true" tabindex="-1"></a>                               <span class="op">.</span><span class="fu">average</span>()<span class="op">,</span></span>
<span id="cb380-14"><a href="#cb380-14" aria-hidden="true" tabindex="-1"></a>          <span class="dt">max_hindfoot_length</span><span class="op">:</span> subset</span>
<span id="cb380-15"><a href="#cb380-15" aria-hidden="true" tabindex="-1"></a>                               <span class="op">.</span><span class="fu">where</span>(r <span class="kw">=&gt;</span> <span class="op">!</span><span class="pp">isNaN</span>(r<span class="op">.</span><span class="at">hindfoot_length</span>))</span>
<span id="cb380-16"><a href="#cb380-16" aria-hidden="true" tabindex="-1"></a>                               <span class="op">.</span><span class="fu">deflate</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">hindfoot_length</span>)</span>
<span id="cb380-17"><a href="#cb380-17" aria-hidden="true" tabindex="-1"></a>                               <span class="op">.</span><span class="fu">max</span>()<span class="op">,</span></span>
<span id="cb380-18"><a href="#cb380-18" aria-hidden="true" tabindex="-1"></a>          <span class="dt">min_weight</span><span class="op">:</span> subset</span>
<span id="cb380-19"><a href="#cb380-19" aria-hidden="true" tabindex="-1"></a>                      <span class="op">.</span><span class="fu">where</span>(r <span class="kw">=&gt;</span> <span class="op">!</span><span class="pp">isNaN</span>(r<span class="op">.</span><span class="at">weight</span>))</span>
<span id="cb380-20"><a href="#cb380-20" aria-hidden="true" tabindex="-1"></a>                      <span class="op">.</span><span class="fu">deflate</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">weight</span>)</span>
<span id="cb380-21"><a href="#cb380-21" aria-hidden="true" tabindex="-1"></a>                      <span class="op">.</span><span class="fu">min</span>()<span class="op">,</span></span>
<span id="cb380-22"><a href="#cb380-22" aria-hidden="true" tabindex="-1"></a>          <span class="dt">ave_weight</span><span class="op">:</span> subset</span>
<span id="cb380-23"><a href="#cb380-23" aria-hidden="true" tabindex="-1"></a>                      <span class="op">.</span><span class="fu">where</span>(r <span class="kw">=&gt;</span> <span class="op">!</span><span class="pp">isNaN</span>(r<span class="op">.</span><span class="at">weight</span>))</span>
<span id="cb380-24"><a href="#cb380-24" aria-hidden="true" tabindex="-1"></a>                      <span class="op">.</span><span class="fu">deflate</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">weight</span>)</span>
<span id="cb380-25"><a href="#cb380-25" aria-hidden="true" tabindex="-1"></a>                      <span class="op">.</span><span class="fu">average</span>()<span class="op">,</span></span>
<span id="cb380-26"><a href="#cb380-26" aria-hidden="true" tabindex="-1"></a>          <span class="dt">max_weight</span><span class="op">:</span> subset</span>
<span id="cb380-27"><a href="#cb380-27" aria-hidden="true" tabindex="-1"></a>                      <span class="op">.</span><span class="fu">where</span>(r <span class="kw">=&gt;</span> <span class="op">!</span><span class="pp">isNaN</span>(r<span class="op">.</span><span class="at">weight</span>))</span>
<span id="cb380-28"><a href="#cb380-28" aria-hidden="true" tabindex="-1"></a>                      <span class="op">.</span><span class="fu">deflate</span>(r <span class="kw">=&gt;</span> r<span class="op">.</span><span class="at">weight</span>)</span>
<span id="cb380-29"><a href="#cb380-29" aria-hidden="true" tabindex="-1"></a>                      <span class="op">.</span><span class="fu">max</span>()</span>
<span id="cb380-30"><a href="#cb380-30" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb380-31"><a href="#cb380-31" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb380-32"><a href="#cb380-32" aria-hidden="true" tabindex="-1"></a><span class="co">// ...as before...</span></span></code></pre></div>
<p>Making these changes we discover that, although the summarizing functions run and return <code>NaN</code> or <code>undefined</code> when presented with a series with at least one missing observation, they throw an error when called on a completely empty series (that is, a series of length zero). To make our data manager robust to this, we go back to writing internal methods to ensure that data is only summarized if it actually exists in the first place:</p>
<div class="sourceCode" id="cb381"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb381-1"><a href="#cb381-1" aria-hidden="true" tabindex="-1"></a>    <span class="fu">getSurveyRange</span> (minYear<span class="op">,</span> maxYear) {</span>
<span id="cb381-2"><a href="#cb381-2" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="bu">Array</span>(<span class="dv">1</span> <span class="op">+</span> maxYear <span class="op">-</span> minYear)</span>
<span id="cb381-3"><a href="#cb381-3" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">fill</span>(<span class="dv">0</span>)</span>
<span id="cb381-4"><a href="#cb381-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">map</span>((v<span class="op">,</span> i) <span class="kw">=&gt;</span> minYear <span class="op">+</span> i)</span>
<span id="cb381-5"><a href="#cb381-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">map</span>(year <span class="kw">=&gt;</span> {</span>
<span id="cb381-6"><a href="#cb381-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> subset <span class="op">=</span> <span class="kw">this</span><span class="op">.</span><span class="at">data</span><span class="op">.</span><span class="fu">where</span>(row <span class="kw">=&gt;</span> row<span class="op">.</span><span class="at">year</span> <span class="op">===</span> year)</span>
<span id="cb381-7"><a href="#cb381-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (subset<span class="op">.</span><span class="fu">count</span>()) {</span>
<span id="cb381-8"><a href="#cb381-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb381-9"><a href="#cb381-9" aria-hidden="true" tabindex="-1"></a>          <span class="dt">key</span><span class="op">:</span> <span class="fu">toString</span>(year)<span class="op">,</span></span>
<span id="cb381-10"><a href="#cb381-10" aria-hidden="true" tabindex="-1"></a>          <span class="dt">year</span><span class="op">:</span> year<span class="op">,</span></span>
<span id="cb381-11"><a href="#cb381-11" aria-hidden="true" tabindex="-1"></a>          <span class="dt">min_hindfoot_length</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">_getMin</span>(subset<span class="op">,</span> <span class="st">&#39;hindfoot_length&#39;</span>)<span class="op">,</span></span>
<span id="cb381-12"><a href="#cb381-12" aria-hidden="true" tabindex="-1"></a>          <span class="dt">ave_hindfoot_length</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">_getAve</span>(subset<span class="op">,</span> <span class="st">&#39;hindfoot_length&#39;</span>)<span class="op">,</span></span>
<span id="cb381-13"><a href="#cb381-13" aria-hidden="true" tabindex="-1"></a>          <span class="dt">max_hindfoot_length</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">_getMax</span>(subset<span class="op">,</span> <span class="st">&#39;hindfoot_length&#39;</span>)<span class="op">,</span></span>
<span id="cb381-14"><a href="#cb381-14" aria-hidden="true" tabindex="-1"></a>          <span class="dt">min_weight</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">_getMin</span>(subset<span class="op">,</span> <span class="st">&#39;weight&#39;</span>)<span class="op">,</span></span>
<span id="cb381-15"><a href="#cb381-15" aria-hidden="true" tabindex="-1"></a>          <span class="dt">ave_weight</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">_getAve</span>(subset<span class="op">,</span> <span class="st">&#39;weight&#39;</span>)<span class="op">,</span></span>
<span id="cb381-16"><a href="#cb381-16" aria-hidden="true" tabindex="-1"></a>          <span class="dt">max_weight</span><span class="op">:</span> <span class="kw">this</span><span class="op">.</span><span class="fu">_getMax</span>(subset<span class="op">,</span> <span class="st">&#39;weight&#39;</span>)</span>
<span id="cb381-17"><a href="#cb381-17" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb381-18"><a href="#cb381-18" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb381-19"><a href="#cb381-19" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb381-20"><a href="#cb381-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb381-21"><a href="#cb381-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-22"><a href="#cb381-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">_getMin</span> (yearData<span class="op">,</span> columnName) {</span>
<span id="cb381-23"><a href="#cb381-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> filtered <span class="op">=</span> yearData<span class="op">.</span><span class="fu">where</span>(row <span class="kw">=&gt;</span> <span class="op">!</span><span class="pp">isNaN</span>(row[columnName]))</span>
<span id="cb381-24"><a href="#cb381-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (filtered<span class="op">.</span><span class="fu">count</span>()) {</span>
<span id="cb381-25"><a href="#cb381-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> filtered<span class="op">.</span><span class="fu">deflate</span>(row <span class="kw">=&gt;</span> row[columnName])<span class="op">.</span><span class="fu">min</span>()</span>
<span id="cb381-26"><a href="#cb381-26" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb381-27"><a href="#cb381-27" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="st">&#39;no data&#39;</span></span>
<span id="cb381-28"><a href="#cb381-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb381-29"><a href="#cb381-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb381-30"><a href="#cb381-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-31"><a href="#cb381-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">_getAve</span> (yearData<span class="op">,</span> columnName) {</span>
<span id="cb381-32"><a href="#cb381-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> filtered <span class="op">=</span> yearData<span class="op">.</span><span class="fu">where</span>(row <span class="kw">=&gt;</span> <span class="op">!</span><span class="pp">isNaN</span>(row[columnName]))</span>
<span id="cb381-33"><a href="#cb381-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (filtered<span class="op">.</span><span class="fu">count</span>()) {</span>
<span id="cb381-34"><a href="#cb381-34" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> filtered<span class="op">.</span><span class="fu">deflate</span>(row <span class="kw">=&gt;</span> row[columnName])<span class="op">.</span><span class="fu">average</span>()</span>
<span id="cb381-35"><a href="#cb381-35" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb381-36"><a href="#cb381-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="st">&#39;no data&#39;</span></span>
<span id="cb381-37"><a href="#cb381-37" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb381-38"><a href="#cb381-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb381-39"><a href="#cb381-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb381-40"><a href="#cb381-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">_getMax</span> (yearData<span class="op">,</span> columnName) {</span>
<span id="cb381-41"><a href="#cb381-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> filtered <span class="op">=</span> yearData<span class="op">.</span><span class="fu">where</span>(row <span class="kw">=&gt;</span> <span class="op">!</span><span class="pp">isNaN</span>(row[columnName]))</span>
<span id="cb381-42"><a href="#cb381-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (filtered<span class="op">.</span><span class="fu">count</span>()) {</span>
<span id="cb381-43"><a href="#cb381-43" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> filtered<span class="op">.</span><span class="fu">deflate</span>(row <span class="kw">=&gt;</span> row[columnName])<span class="op">.</span><span class="fu">max</span>()</span>
<span id="cb381-44"><a href="#cb381-44" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb381-45"><a href="#cb381-45" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="st">&#39;no data&#39;</span></span>
<span id="cb381-46"><a href="#cb381-46" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb381-47"><a href="#cb381-47" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<h2 id="s:capstone-server">Server</h2>
<p>The server is going to be almost the same as the one in Chapter <a href="#s:server" data-reference-type="ref" data-reference="s:server">12</a>. However, we need to connect it to the data manager. We’ll do this by having the driver create a data manager and then pass that data manager to the server when the latter is created:</p>
<div class="sourceCode" id="cb382"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb382-1"><a href="#cb382-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> DataManager <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;./data-manager&#39;</span>)</span>
<span id="cb382-2"><a href="#cb382-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> server <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;./server-0&#39;</span>)</span>
<span id="cb382-3"><a href="#cb382-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-4"><a href="#cb382-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> PORT <span class="op">=</span> <span class="dv">3418</span></span>
<span id="cb382-5"><a href="#cb382-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb382-6"><a href="#cb382-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> filename <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">argv</span>[<span class="dv">2</span>]</span>
<span id="cb382-7"><a href="#cb382-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> db <span class="op">=</span> <span class="kw">new</span> <span class="fu">DataManager</span>(filename)</span>
<span id="cb382-8"><a href="#cb382-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> app <span class="op">=</span> <span class="fu">server</span>(db)</span>
<span id="cb382-9"><a href="#cb382-9" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">listen</span>(PORT<span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb382-10"><a href="#cb382-10" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`listening on port </span><span class="sc">${</span>PORT<span class="sc">}</span><span class="vs">...`</span>)</span>
<span id="cb382-11"><a href="#cb382-11" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>As you can probably guess from the fact that we’re referring to <code>server-0</code>, we’re going to be making some changes down the road<span>…</span> Here’s the start of the server it works with:</p>
<div class="sourceCode" id="cb383"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb383-1"><a href="#cb383-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> express <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;express&#39;</span>)</span>
<span id="cb383-2"><a href="#cb383-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb383-3"><a href="#cb383-3" aria-hidden="true" tabindex="-1"></a><span class="co">// &#39;dataManager&#39; is a global variable that refers to our database.</span></span>
<span id="cb383-4"><a href="#cb383-4" aria-hidden="true" tabindex="-1"></a><span class="co">// It must be set when the server is created.</span></span>
<span id="cb383-5"><a href="#cb383-5" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> dataManager <span class="op">=</span> <span class="kw">null</span></span>
<span id="cb383-6"><a href="#cb383-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb383-7"><a href="#cb383-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Main server object.</span></span>
<span id="cb383-8"><a href="#cb383-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> app <span class="op">=</span> <span class="fu">express</span>()</span>
<span id="cb383-9"><a href="#cb383-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb383-10"><a href="#cb383-10" aria-hidden="true" tabindex="-1"></a><span class="co">// ...handle requests...</span></span>
<span id="cb383-11"><a href="#cb383-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb383-12"><a href="#cb383-12" aria-hidden="true" tabindex="-1"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> (dbm) <span class="kw">=&gt;</span> {</span>
<span id="cb383-13"><a href="#cb383-13" aria-hidden="true" tabindex="-1"></a>  dataManager <span class="op">=</span> dbm</span>
<span id="cb383-14"><a href="#cb383-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> app</span>
<span id="cb383-15"><a href="#cb383-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We’ll look at handling requests for data in the next section. The most important thing for now is the way we manage the connection to the data manager. Down at the bottom of <code>server-0.js</code>, we export a function that assigns its single argument to a variable called <code>dataManager</code>. Inside the methods that handle requests, we’ll be able to send database queries to <code>dataManager</code>.</p>
<p>This variable is global within this file, but since it’s not exported, it’s invisible outside. Variables like this are called <a href="#g:module-variable"><strong>module variables</strong></a>, and give us a way to share information among the functions in a module without giving anything outside the module a way to cause (direct) harm to that information.</p>
<h2 id="s:capstone-api">API</h2>
<p>The next step is to decide what our server’s API will be, i.e., what URLs it will understand and what data they will fetch. <code>GET /survey/stats</code> will get summary statistics as a single JSON record, and <code>GET /survey/:start/:end</code> gets aggregate values for a range of years. (We will add error checking on the year range as an exercise.) Anything else will return a 404 error code and a snippet of HTML telling us we’re bad people. We will put this code in <code>server.js</code> and a command-line driver in <code>driver.js</code> for testability. The server functions are:</p>
<div class="sourceCode" id="cb384"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb384-1"><a href="#cb384-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Get survey statistics.</span></span>
<span id="cb384-2"><a href="#cb384-2" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/survey/stats&#39;</span><span class="op">,</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb384-3"><a href="#cb384-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> data <span class="op">=</span> dataManager<span class="op">.</span><span class="fu">getSurveyStats</span>()</span>
<span id="cb384-4"><a href="#cb384-4" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">setHeader</span>(<span class="st">&#39;Content-Type&#39;</span><span class="op">,</span> <span class="st">&#39;application/json&#39;</span>)</span>
<span id="cb384-5"><a href="#cb384-5" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">status</span>(<span class="dv">200</span>)<span class="op">.</span><span class="fu">send</span>(data)</span>
<span id="cb384-6"><a href="#cb384-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb384-7"><a href="#cb384-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb384-8"><a href="#cb384-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Get a slice of the survey data.</span></span>
<span id="cb384-9"><a href="#cb384-9" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/survey/:start/:end&#39;</span><span class="op">,</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb384-10"><a href="#cb384-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> start <span class="op">=</span> <span class="pp">parseInt</span>(req<span class="op">.</span><span class="at">params</span><span class="op">.</span><span class="at">start</span>)</span>
<span id="cb384-11"><a href="#cb384-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> end <span class="op">=</span> <span class="pp">parseInt</span>(req<span class="op">.</span><span class="at">params</span><span class="op">.</span><span class="at">end</span>)</span>
<span id="cb384-12"><a href="#cb384-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> data <span class="op">=</span> dataManager<span class="op">.</span><span class="fu">getSurveyRange</span>(start<span class="op">,</span> end)</span>
<span id="cb384-13"><a href="#cb384-13" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">setHeader</span>(<span class="st">&#39;Content-Type&#39;</span><span class="op">,</span> <span class="st">&#39;application/json&#39;</span>)</span>
<span id="cb384-14"><a href="#cb384-14" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">status</span>(<span class="dv">200</span>)<span class="op">.</span><span class="fu">send</span>(data)</span>
<span id="cb384-15"><a href="#cb384-15" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>We also write an error handling function:</p>
<div class="sourceCode" id="cb385"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb385-1"><a href="#cb385-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Nothing else worked.</span></span>
<span id="cb385-2"><a href="#cb385-2" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>((req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb385-3"><a href="#cb385-3" aria-hidden="true" tabindex="-1"></a>  page <span class="op">=</span> <span class="vs">`&lt;html&gt;&lt;body&gt;&lt;p&gt;error: &quot;</span><span class="sc">${</span>req<span class="op">.</span><span class="at">url</span><span class="sc">}</span><span class="vs">&quot; not found&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;`</span></span>
<span id="cb385-4"><a href="#cb385-4" aria-hidden="true" tabindex="-1"></a>  res<span class="op">.</span><span class="fu">status</span>(<span class="dv">404</span>)</span>
<span id="cb385-5"><a href="#cb385-5" aria-hidden="true" tabindex="-1"></a>     <span class="op">.</span><span class="fu">send</span>(page)</span>
<span id="cb385-6"><a href="#cb385-6" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Now let’s write our first test:</p>
<div class="sourceCode" id="cb386"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb386-1"><a href="#cb386-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> path <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;path&#39;</span>)</span>
<span id="cb386-2"><a href="#cb386-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> assert <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;assert&#39;</span>)</span>
<span id="cb386-3"><a href="#cb386-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> request <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;supertest&#39;</span>)</span>
<span id="cb386-4"><a href="#cb386-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> DataManager <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;./data-manager&#39;</span>)</span>
<span id="cb386-5"><a href="#cb386-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> make_server <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;./server-0&#39;</span>)</span>
<span id="cb386-6"><a href="#cb386-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb386-7"><a href="#cb386-7" aria-hidden="true" tabindex="-1"></a>TEST_DATA_PATH <span class="op">=</span> path<span class="op">.</span><span class="fu">resolve</span>(<span class="bu">__dirname</span><span class="op">,</span> <span class="st">&#39;test-data.csv&#39;</span>)</span>
<span id="cb386-8"><a href="#cb386-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb386-9"><a href="#cb386-9" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;server&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb386-10"><a href="#cb386-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb386-11"><a href="#cb386-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should return statistics about survey data&#39;</span><span class="op">,</span> (done) <span class="kw">=&gt;</span> {</span>
<span id="cb386-12"><a href="#cb386-12" aria-hidden="true" tabindex="-1"></a>    expected <span class="op">=</span> {</span>
<span id="cb386-13"><a href="#cb386-13" aria-hidden="true" tabindex="-1"></a>      <span class="dt">minYear</span><span class="op">:</span> <span class="dv">1979</span><span class="op">,</span></span>
<span id="cb386-14"><a href="#cb386-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">maxYear</span><span class="op">:</span> <span class="dv">2000</span><span class="op">,</span></span>
<span id="cb386-15"><a href="#cb386-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">count</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb386-16"><a href="#cb386-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb386-17"><a href="#cb386-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> db <span class="op">=</span> <span class="kw">new</span> <span class="fu">DataManager</span>(TEST_DATA_PATH)</span>
<span id="cb386-18"><a href="#cb386-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> server <span class="op">=</span> <span class="fu">make_server</span>(db)</span>
<span id="cb386-19"><a href="#cb386-19" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/survey/stats&#39;</span>)</span>
<span id="cb386-20"><a href="#cb386-20" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">expect</span>(<span class="dv">200</span>)</span>
<span id="cb386-21"><a href="#cb386-21" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">expect</span>(<span class="st">&#39;Content-Type&#39;</span><span class="op">,</span> <span class="st">&#39;application/json&#39;</span>)</span>
<span id="cb386-22"><a href="#cb386-22" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">end</span>((err<span class="op">,</span> res) <span class="kw">=&gt;</span> {</span>
<span id="cb386-23"><a href="#cb386-23" aria-hidden="true" tabindex="-1"></a>        assert<span class="op">.</span><span class="fu">deepEqual</span>(res<span class="op">.</span><span class="at">body</span><span class="op">,</span> expected<span class="op">,</span> <span class="st">&#39;&#39;</span>)</span>
<span id="cb386-24"><a href="#cb386-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">done</span>()</span>
<span id="cb386-25"><a href="#cb386-25" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb386-26"><a href="#cb386-26" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb386-27"><a href="#cb386-27" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Note that the range of years is 1979-2000, which is <em>not</em> the range in the full dataset. We run this with:</p>
<pre class="shell"><code>$ npm test -- src/capstone/back/test-server.js</code></pre>
<p>and it passes.</p>
<h2 id="s:capstone-display">The Display</h2>
<p>The front end is a straightforward recapitulation of what we’ve done before. There is a single HTML page called <code>index.html</code>:</p>
<div class="sourceCode" id="cb388"><pre class="sourceCode html"><code class="sourceCode html"><span id="cb388-1"><a href="#cb388-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span></span>
<span id="cb388-2"><a href="#cb388-2" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;html&gt;</span></span>
<span id="cb388-3"><a href="#cb388-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;head&gt;</span></span>
<span id="cb388-4"><a href="#cb388-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;title&gt;</span>Creatures<span class="kw">&lt;/title&gt;</span></span>
<span id="cb388-5"><a href="#cb388-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;meta</span> <span class="er">charset</span><span class="ot">=</span><span class="st">&quot;utf-8&quot;</span><span class="kw">&gt;</span></span>
<span id="cb388-6"><a href="#cb388-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;script</span> <span class="er">src</span><span class="ot">=</span><span class="st">&quot;app.js&quot;</span> <span class="er">async</span><span class="kw">&gt;&lt;/script&gt;</span></span>
<span id="cb388-7"><a href="#cb388-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/head&gt;</span></span>
<span id="cb388-8"><a href="#cb388-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;body&gt;</span></span>
<span id="cb388-9"><a href="#cb388-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;div</span> <span class="er">id</span><span class="ot">=</span><span class="st">&quot;app&quot;</span><span class="kw">&gt;&lt;/div&gt;</span></span>
<span id="cb388-10"><a href="#cb388-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">&lt;/body&gt;</span></span>
<span id="cb388-11"><a href="#cb388-11" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/html&gt;</span></span></code></pre></div>
<p>The main application in <code>app.js</code> imports components to display summary statistics, choose a range of years, and display annual data. There is not usually such a close coupling between API calls and components, but it’s not a bad place to start. Note that we are using <code>import</code> because we’re trying to be modern, even though the back end still needs <code>require</code>.</p>
<div class="sourceCode" id="cb389"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb389-1"><a href="#cb389-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> React <span class="im">from</span> <span class="st">&#39;react&#39;</span></span>
<span id="cb389-2"><a href="#cb389-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ReactDOM <span class="im">from</span> <span class="st">&#39;react-dom&#39;</span></span>
<span id="cb389-3"><a href="#cb389-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> SurveyStats <span class="im">from</span> <span class="st">&#39;./SurveyStats&#39;</span></span>
<span id="cb389-4"><a href="#cb389-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ChooseRange <span class="im">from</span> <span class="st">&#39;./ChooseRange&#39;</span></span>
<span id="cb389-5"><a href="#cb389-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> DataDisplay <span class="im">from</span> <span class="st">&#39;./DataDisplay&#39;</span></span>
<span id="cb389-6"><a href="#cb389-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb389-7"><a href="#cb389-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> App <span class="kw">extends</span> React<span class="op">.</span><span class="at">Component</span> {</span>
<span id="cb389-8"><a href="#cb389-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb389-9"><a href="#cb389-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span> (props) {</span>
<span id="cb389-10"><a href="#cb389-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...constructor...</span></span>
<span id="cb389-11"><a href="#cb389-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb389-12"><a href="#cb389-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb389-13"><a href="#cb389-13" aria-hidden="true" tabindex="-1"></a>  componentDidMount <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb389-14"><a href="#cb389-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...initialize...</span></span>
<span id="cb389-15"><a href="#cb389-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb389-16"><a href="#cb389-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb389-17"><a href="#cb389-17" aria-hidden="true" tabindex="-1"></a>  onStart <span class="op">=</span> (start) <span class="kw">=&gt;</span> {</span>
<span id="cb389-18"><a href="#cb389-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...update start year...</span></span>
<span id="cb389-19"><a href="#cb389-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb389-20"><a href="#cb389-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb389-21"><a href="#cb389-21" aria-hidden="true" tabindex="-1"></a>  onEnd <span class="op">=</span> (end) <span class="kw">=&gt;</span> {</span>
<span id="cb389-22"><a href="#cb389-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...update end year...</span></span>
<span id="cb389-23"><a href="#cb389-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb389-24"><a href="#cb389-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb389-25"><a href="#cb389-25" aria-hidden="true" tabindex="-1"></a>  onNewRange <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb389-26"><a href="#cb389-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...handle submission of year range...</span></span>
<span id="cb389-27"><a href="#cb389-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb389-28"><a href="#cb389-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb389-29"><a href="#cb389-29" aria-hidden="true" tabindex="-1"></a>  render <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb389-30"><a href="#cb389-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...render current application state...</span></span>
<span id="cb389-31"><a href="#cb389-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb389-32"><a href="#cb389-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb389-33"><a href="#cb389-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb389-34"><a href="#cb389-34" aria-hidden="true" tabindex="-1"></a>ReactDOM<span class="op">.</span><span class="fu">render</span>(</span>
<span id="cb389-35"><a href="#cb389-35" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>App <span class="op">/&gt;,</span></span>
<span id="cb389-36"><a href="#cb389-36" aria-hidden="true" tabindex="-1"></a>  <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">&#39;app&#39;</span>)</span>
<span id="cb389-37"><a href="#cb389-37" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>The constructor defines the URL for the data source and sets up the initial state, which has summary data, start and end years, and data for those years:</p>
<div class="sourceCode" id="cb390"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb390-1"><a href="#cb390-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span> (props) {</span>
<span id="cb390-2"><a href="#cb390-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">super</span>(props)</span>
<span id="cb390-3"><a href="#cb390-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">baseUrl</span> <span class="op">=</span> <span class="st">&#39;http://localhost:3418&#39;</span></span>
<span id="cb390-4"><a href="#cb390-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">state</span> <span class="op">=</span> {</span>
<span id="cb390-5"><a href="#cb390-5" aria-hidden="true" tabindex="-1"></a>      <span class="dt">summary</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span></span>
<span id="cb390-6"><a href="#cb390-6" aria-hidden="true" tabindex="-1"></a>      <span class="dt">start</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span></span>
<span id="cb390-7"><a href="#cb390-7" aria-hidden="true" tabindex="-1"></a>      <span class="dt">end</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span></span>
<span id="cb390-8"><a href="#cb390-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">data</span><span class="op">:</span> <span class="kw">null</span></span>
<span id="cb390-9"><a href="#cb390-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb390-10"><a href="#cb390-10" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>The method <code>componentDidMount</code> is new: it fetches data for the very first time so that the user sees something useful on the page when they first load it.</p>
<div class="sourceCode" id="cb391"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb391-1"><a href="#cb391-1" aria-hidden="true" tabindex="-1"></a>  componentDidMount <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb391-2"><a href="#cb391-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> url <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">baseUrl</span><span class="sc">}</span><span class="vs">/survey/stats`</span></span>
<span id="cb391-3"><a href="#cb391-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fetch</span>(url)<span class="op">.</span><span class="fu">then</span>((response) <span class="kw">=&gt;</span> {</span>
<span id="cb391-4"><a href="#cb391-4" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> response<span class="op">.</span><span class="fu">json</span>()</span>
<span id="cb391-5"><a href="#cb391-5" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">then</span>((summary) <span class="kw">=&gt;</span> {</span>
<span id="cb391-6"><a href="#cb391-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">setState</span>({</span>
<span id="cb391-7"><a href="#cb391-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">summary</span><span class="op">:</span> summary</span>
<span id="cb391-8"><a href="#cb391-8" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb391-9"><a href="#cb391-9" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb391-10"><a href="#cb391-10" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>We don’t call this method ourselves; instead, React automatically calls it once our application and its children have been loaded and initialized. We can’t fetch the initial data in the application’s constructor because we have no control over the order in which bits of display are initialized. On the upside, we can use <code>response.json()</code> directly because we know the source is returning JSON data. This method is the only place where the summary is updated, since the data isn’t changing underneath us.</p>
<p>Next up we need to handle typing in the “start” and “end” boxes. The HTML controls in the web page will capture the characters without our help, but we need those values in our state variables:</p>
<div class="sourceCode" id="cb392"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb392-1"><a href="#cb392-1" aria-hidden="true" tabindex="-1"></a>  onStart <span class="op">=</span> (start) <span class="kw">=&gt;</span> {</span>
<span id="cb392-2"><a href="#cb392-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setState</span>({</span>
<span id="cb392-3"><a href="#cb392-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">start</span><span class="op">:</span> start</span>
<span id="cb392-4"><a href="#cb392-4" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb392-5"><a href="#cb392-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb392-6"><a href="#cb392-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb392-7"><a href="#cb392-7" aria-hidden="true" tabindex="-1"></a>  onEnd <span class="op">=</span> (end) <span class="kw">=&gt;</span> {</span>
<span id="cb392-8"><a href="#cb392-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="fu">setState</span>({</span>
<span id="cb392-9"><a href="#cb392-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">end</span><span class="op">:</span> end</span>
<span id="cb392-10"><a href="#cb392-10" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb392-11"><a href="#cb392-11" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>When the button is clicked, we send a request for JSON data to the appropriate URL and record the result in the application’s state. React will notice the state change and call <code>render</code> for us. More precisely, the browser will call the first <code>then</code> callback when the response arrives, and the second <code>then</code> callback when the data has been converted to JSON.</p>
<div class="sourceCode" id="cb393"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb393-1"><a href="#cb393-1" aria-hidden="true" tabindex="-1"></a>  onNewRange <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb393-2"><a href="#cb393-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> params <span class="op">=</span> {</span>
<span id="cb393-3"><a href="#cb393-3" aria-hidden="true" tabindex="-1"></a>      <span class="dt">method</span><span class="op">:</span> <span class="st">&#39;GET&#39;</span><span class="op">,</span></span>
<span id="cb393-4"><a href="#cb393-4" aria-hidden="true" tabindex="-1"></a>      <span class="dt">headers</span><span class="op">:</span> {</span>
<span id="cb393-5"><a href="#cb393-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Accept&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span><span class="op">,</span></span>
<span id="cb393-6"><a href="#cb393-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Content-Type&#39;</span><span class="op">:</span> <span class="st">&#39;application/json&#39;</span></span>
<span id="cb393-7"><a href="#cb393-7" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb393-8"><a href="#cb393-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb393-9"><a href="#cb393-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> url <span class="op">=</span> <span class="vs">`</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">baseUrl</span><span class="sc">}</span><span class="vs">/survey/</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">start</span><span class="sc">}</span><span class="vs">/</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">end</span><span class="sc">}</span><span class="vs">`</span></span>
<span id="cb393-10"><a href="#cb393-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fetch</span>(url<span class="op">,</span> params)<span class="op">.</span><span class="fu">then</span>((response) <span class="kw">=&gt;</span> {</span>
<span id="cb393-11"><a href="#cb393-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> response<span class="op">.</span><span class="fu">json</span>()</span>
<span id="cb393-12"><a href="#cb393-12" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">then</span>((data) <span class="kw">=&gt;</span> {</span>
<span id="cb393-13"><a href="#cb393-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">setState</span>({</span>
<span id="cb393-14"><a href="#cb393-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">data</span><span class="op">:</span> data</span>
<span id="cb393-15"><a href="#cb393-15" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb393-16"><a href="#cb393-16" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb393-17"><a href="#cb393-17" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>Now let’s update the display with <code>SurveyStats</code>, <code>ChooseRange</code>, <code>DataChart</code>, and <code>DataDisplay</code>, which are all stateless components (i.e., they display things but don’t change anything):</p>
<div class="sourceCode" id="cb394"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb394-1"><a href="#cb394-1" aria-hidden="true" tabindex="-1"></a>  render <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb394-2"><a href="#cb394-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> tableStyle <span class="op">=</span> {<span class="dt">overflow</span><span class="op">:</span> <span class="st">&#39;scroll&#39;</span><span class="op">,</span> <span class="dt">height</span><span class="op">:</span> <span class="st">&#39;200px&#39;</span>}</span>
<span id="cb394-3"><a href="#cb394-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb394-4"><a href="#cb394-4" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;div&gt;</span></span>
<span id="cb394-5"><a href="#cb394-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;h1&gt;</span>Creatures<span class="kw">&lt;/h1&gt;</span></span>
<span id="cb394-6"><a href="#cb394-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">&lt;SurveyStats</span> <span class="ot">data</span><span class="op">=</span><span class="va">{</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">summary</span><span class="va">}</span> <span class="fu">/&gt;</span></span>
<span id="cb394-7"><a href="#cb394-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">&lt;ChooseRange</span></span>
<span id="cb394-8"><a href="#cb394-8" aria-hidden="true" tabindex="-1"></a>          <span class="ot">start</span><span class="op">=</span><span class="va">{</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">start</span><span class="va">}</span> <span class="ot">onStart</span><span class="op">=</span><span class="va">{</span><span class="kw">this</span><span class="op">.</span><span class="at">onStart</span><span class="va">}</span></span>
<span id="cb394-9"><a href="#cb394-9" aria-hidden="true" tabindex="-1"></a>          <span class="ot">end</span><span class="op">=</span><span class="va">{</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">end</span><span class="va">}</span> <span class="ot">onEnd</span><span class="op">=</span><span class="va">{</span><span class="kw">this</span><span class="op">.</span><span class="at">onEnd</span><span class="va">}</span></span>
<span id="cb394-10"><a href="#cb394-10" aria-hidden="true" tabindex="-1"></a>          <span class="ot">onNewRange</span><span class="op">=</span><span class="va">{</span><span class="kw">this</span><span class="op">.</span><span class="at">onNewRange</span><span class="va">}</span> <span class="fu">/&gt;</span></span>
<span id="cb394-11"><a href="#cb394-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">&lt;DataChart</span> <span class="ot">data</span><span class="op">=</span><span class="va">{</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">data</span><span class="va">}</span> <span class="fu">/&gt;</span></span>
<span id="cb394-12"><a href="#cb394-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;div</span> <span class="ot">style</span><span class="op">=</span><span class="va">{</span>tableStyle<span class="va">}</span><span class="kw">&gt;</span></span>
<span id="cb394-13"><a href="#cb394-13" aria-hidden="true" tabindex="-1"></a>          <span class="fu">&lt;DataDisplay</span> <span class="ot">data</span><span class="op">=</span><span class="va">{</span><span class="kw">this</span><span class="op">.</span><span class="at">state</span><span class="op">.</span><span class="at">data</span><span class="va">}</span> <span class="fu">/&gt;</span></span>
<span id="cb394-14"><a href="#cb394-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;/div&gt;</span></span>
<span id="cb394-15"><a href="#cb394-15" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;/div&gt;</span></span>
<span id="cb394-16"><a href="#cb394-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb394-17"><a href="#cb394-17" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<h2 id="s:capstone-tables">The Tables</h2>
<p>We will display survey statistics as tables, with a paragraph fallback when there’s no data. First, we display summary statistics for the whole dataset (as returned by the <code>GET /survey/stats</code> query we wrote a handler for earlier) as a table at the top of the page. (Again, we need parentheses around the HTML fragment so that it will parse properly.)</p>
<div class="sourceCode" id="cb395"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb395-1"><a href="#cb395-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> React <span class="im">from</span> <span class="st">&#39;react&#39;</span></span>
<span id="cb395-2"><a href="#cb395-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-3"><a href="#cb395-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> SurveyStats <span class="op">=</span> ({data}) <span class="kw">=&gt;</span> {</span>
<span id="cb395-4"><a href="#cb395-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (data <span class="op">===</span> <span class="kw">null</span>) {</span>
<span id="cb395-5"><a href="#cb395-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (<span class="kw">&lt;p&gt;</span>no data<span class="kw">&lt;/p&gt;</span>)</span>
<span id="cb395-6"><a href="#cb395-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb395-7"><a href="#cb395-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (</span>
<span id="cb395-8"><a href="#cb395-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;table&gt;</span></span>
<span id="cb395-9"><a href="#cb395-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;tbody&gt;</span></span>
<span id="cb395-10"><a href="#cb395-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;tr&gt;&lt;th&gt;</span>record count<span class="kw">&lt;/th&gt;&lt;td&gt;</span><span class="va">{</span>data<span class="op">.</span><span class="at">record_count</span><span class="va">}</span><span class="kw">&lt;/td&gt;&lt;/tr&gt;</span></span>
<span id="cb395-11"><a href="#cb395-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;tr&gt;&lt;th&gt;</span>year low<span class="kw">&lt;/th&gt;&lt;td&gt;</span><span class="va">{</span>data<span class="op">.</span><span class="at">year_low</span><span class="va">}</span><span class="kw">&lt;/td&gt;&lt;/tr&gt;</span></span>
<span id="cb395-12"><a href="#cb395-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;tr&gt;&lt;th&gt;</span>year high<span class="kw">&lt;/th&gt;&lt;td&gt;</span><span class="va">{</span>data<span class="op">.</span><span class="at">year_high</span><span class="va">}</span><span class="kw">&lt;/td&gt;&lt;/tr&gt;</span></span>
<span id="cb395-13"><a href="#cb395-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;/tbody&gt;</span></span>
<span id="cb395-14"><a href="#cb395-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/table&gt;</span></span>
<span id="cb395-15"><a href="#cb395-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb395-16"><a href="#cb395-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb395-17"><a href="#cb395-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-18"><a href="#cb395-18" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> SurveyStats</span></code></pre></div>
<p>Next, we display aggregated statistics for a given range of years (the <code>GET /survey/:start/:end</code> query) in another table.</p>
<div class="sourceCode" id="cb396"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb396-1"><a href="#cb396-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> React <span class="im">from</span> <span class="st">&#39;react&#39;</span></span>
<span id="cb396-2"><a href="#cb396-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-3"><a href="#cb396-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> DataDisplay <span class="op">=</span> ({data}) <span class="kw">=&gt;</span> {</span>
<span id="cb396-4"><a href="#cb396-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-5"><a href="#cb396-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span> data) {</span>
<span id="cb396-6"><a href="#cb396-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (<span class="kw">&lt;p&gt;</span>no data<span class="kw">&lt;/p&gt;</span>)</span>
<span id="cb396-7"><a href="#cb396-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb396-8"><a href="#cb396-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-9"><a href="#cb396-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> columns <span class="op">=</span> [</span>
<span id="cb396-10"><a href="#cb396-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;year&#39;</span><span class="op">,</span></span>
<span id="cb396-11"><a href="#cb396-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;min_hindfoot_length&#39;</span><span class="op">,</span></span>
<span id="cb396-12"><a href="#cb396-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;ave_hindfoot_length&#39;</span><span class="op">,</span></span>
<span id="cb396-13"><a href="#cb396-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;max_hindfoot_length&#39;</span><span class="op">,</span></span>
<span id="cb396-14"><a href="#cb396-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;min_weight&#39;</span><span class="op">,</span></span>
<span id="cb396-15"><a href="#cb396-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;ave_weight&#39;</span><span class="op">,</span></span>
<span id="cb396-16"><a href="#cb396-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;max_weight&#39;</span></span>
<span id="cb396-17"><a href="#cb396-17" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb396-18"><a href="#cb396-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-19"><a href="#cb396-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (</span>
<span id="cb396-20"><a href="#cb396-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;table&gt;</span></span>
<span id="cb396-21"><a href="#cb396-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;tbody&gt;</span></span>
<span id="cb396-22"><a href="#cb396-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">&lt;tr&gt;</span><span class="va">{</span>columns<span class="op">.</span><span class="fu">map</span>((c) <span class="kw">=&gt;</span> (<span class="kw">&lt;th&gt;</span><span class="va">{</span>c<span class="va">}</span><span class="kw">&lt;/th&gt;</span>))<span class="va">}</span><span class="kw">&lt;/tr&gt;</span></span>
<span id="cb396-23"><a href="#cb396-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">{</span>data<span class="op">.</span><span class="fu">filter</span>(r <span class="kw">=&gt;</span> r)<span class="op">.</span><span class="fu">map</span>((record) <span class="kw">=&gt;</span> {</span>
<span id="cb396-24"><a href="#cb396-24" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> (<span class="kw">&lt;tr&gt;</span><span class="va">{</span>columns<span class="op">.</span><span class="fu">map</span>((c) <span class="kw">=&gt;</span> (<span class="kw">&lt;td&gt;</span><span class="va">{</span>record[c]<span class="va">}</span><span class="kw">&lt;/td&gt;</span>))<span class="va">}</span><span class="kw">&lt;/tr&gt;</span>)</span>
<span id="cb396-25"><a href="#cb396-25" aria-hidden="true" tabindex="-1"></a>        })<span class="va">}</span></span>
<span id="cb396-26"><a href="#cb396-26" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&lt;/tbody&gt;</span></span>
<span id="cb396-27"><a href="#cb396-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">&lt;/table&gt;</span></span>
<span id="cb396-28"><a href="#cb396-28" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb396-29"><a href="#cb396-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb396-30"><a href="#cb396-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb396-31"><a href="#cb396-31" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> DataDisplay</span></code></pre></div>
<p>Like <code>SurveyStats</code>, <code>DataDisplay</code> returns a table listing the results returned from the server. Unlike <code>SurveyStats</code>, this component needs to check whether each record exists before it builds the table row. Remember that, when we defined how the year range query is handled in <code>DataManager</code> earlier, we told it to only return record objects for those years that have data. Here, we add <code>.filter(r =&gt; r)</code> before mapping the data to the callback to ensure that <code>DataDisplay</code> will only try to make <code>tr</code> elements from non-<code>null</code> records. We do the same when plotting the data.</p>
<h2 id="s:capstone-chart">The Chart</h2>
<p>We initially tried using Vega-Lite directly for the chart, but after a few failures and some online searching, we switched to <code>react-vega-lite</code>: Vega-Lite’s <code>vega-embed</code> wants to modify an existing DOM element when called, while <code>react-vega-lite</code> constructs an element to be put in place at the right time, which proved easier to use. The steps are:</p>
<ol>
<li><p>Create a paragraph placeholder if there’s no data.</p></li>
<li><p>Re-organize non-<code>null</code> data into the form the chart needs.</p></li>
<li><p>Construct a spec like the ones we have seen before.</p></li>
<li><p>Create options to turn off the annoying links (also seen before).</p></li>
<li><p>Return an instance of the <code>VegaLite</code> component.</p></li>
</ol>
<div class="sourceCode" id="cb397"><pre class="sourceCode jsx"><code class="sourceCode javascriptreact"><span id="cb397-1"><a href="#cb397-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> React <span class="im">from</span> <span class="st">&#39;react&#39;</span></span>
<span id="cb397-2"><a href="#cb397-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> VegaLite <span class="im">from</span> <span class="st">&#39;react-vega-lite&#39;</span></span>
<span id="cb397-3"><a href="#cb397-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-4"><a href="#cb397-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> DataChart <span class="op">=</span> ({data}) <span class="kw">=&gt;</span> {</span>
<span id="cb397-5"><a href="#cb397-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span> data) {</span>
<span id="cb397-6"><a href="#cb397-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (<span class="kw">&lt;p&gt;</span>no data<span class="kw">&lt;/p&gt;</span>)</span>
<span id="cb397-7"><a href="#cb397-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb397-8"><a href="#cb397-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-9"><a href="#cb397-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> values <span class="op">=</span> data</span>
<span id="cb397-10"><a href="#cb397-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">filter</span>(r <span class="kw">=&gt;</span> r)</span>
<span id="cb397-11"><a href="#cb397-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span><span class="fu">map</span>(r <span class="kw">=&gt;</span> ({<span class="dt">x</span><span class="op">:</span> r<span class="op">.</span><span class="at">ave_hindfoot_length</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> r<span class="op">.</span><span class="at">ave_weight</span>}))</span>
<span id="cb397-12"><a href="#cb397-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> spec <span class="op">=</span> {</span>
<span id="cb397-13"><a href="#cb397-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;$schema&#39;</span><span class="op">:</span> <span class="st">&#39;https://vega.github.io/schema/vega-lite/v2.0.json&#39;</span><span class="op">,</span></span>
<span id="cb397-14"><a href="#cb397-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;description&#39;</span><span class="op">:</span> <span class="st">&#39;Mean Weight vs Mean Hindfoot Length&#39;</span><span class="op">,</span></span>
<span id="cb397-15"><a href="#cb397-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;mark&#39;</span><span class="op">:</span> <span class="st">&#39;point&#39;</span><span class="op">,</span></span>
<span id="cb397-16"><a href="#cb397-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;encoding&#39;</span><span class="op">:</span> {</span>
<span id="cb397-17"><a href="#cb397-17" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;x&#39;</span><span class="op">:</span> {<span class="st">&#39;field&#39;</span><span class="op">:</span> <span class="st">&#39;x&#39;</span><span class="op">,</span> <span class="st">&#39;type&#39;</span><span class="op">:</span> <span class="st">&#39;quantitative&#39;</span>}<span class="op">,</span></span>
<span id="cb397-18"><a href="#cb397-18" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;y&#39;</span><span class="op">:</span> {<span class="st">&#39;field&#39;</span><span class="op">:</span> <span class="st">&#39;y&#39;</span><span class="op">,</span> <span class="st">&#39;type&#39;</span><span class="op">:</span> <span class="st">&#39;quantitative&#39;</span>}</span>
<span id="cb397-19"><a href="#cb397-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb397-20"><a href="#cb397-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb397-21"><a href="#cb397-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> options <span class="op">=</span> {</span>
<span id="cb397-22"><a href="#cb397-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;actions&#39;</span><span class="op">:</span> {</span>
<span id="cb397-23"><a href="#cb397-23" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;export&#39;</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb397-24"><a href="#cb397-24" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;source&#39;</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb397-25"><a href="#cb397-25" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;editor&#39;</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb397-26"><a href="#cb397-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb397-27"><a href="#cb397-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb397-28"><a href="#cb397-28" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> scatterData <span class="op">=</span> {</span>
<span id="cb397-29"><a href="#cb397-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;values&#39;</span><span class="op">:</span> values</span>
<span id="cb397-30"><a href="#cb397-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb397-31"><a href="#cb397-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (<span class="fu">&lt;VegaLite</span> <span class="ot">spec</span><span class="op">=</span><span class="va">{</span>spec<span class="va">}</span> <span class="ot">data</span><span class="op">=</span><span class="va">{</span>scatterData<span class="va">}</span> <span class="ot">options</span><span class="op">=</span><span class="va">{</span>options<span class="va">}</span><span class="fu">/&gt;</span>)</span>
<span id="cb397-32"><a href="#cb397-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb397-33"><a href="#cb397-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb397-34"><a href="#cb397-34" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="im">default</span> DataChart</span></code></pre></div>
<p>The other components are similar to those we have seen before.</p>
<h2 id="s:capstone-run">Running It</h2>
<p>In order to test our application, we need to run a data server, and then launch our application with Parcel. The easiest way to do that is to open two windows on our computer and make each half the width (or height) of our screen so that we can see messages from both halves of what we’re doing.</p>
<p>In one window, we run:</p>
<pre class="shell"><code>$ node src/capstone/back/driver-0.js src/capstone/back/test-data.csv</code></pre>
<p>Note that we <em>don’t</em> use <code>npm run dev</code> to trigger Parcel: this is running on the server, so no bundling is necessary.</p>
<p>In our other window, we run:</p>
<pre class="shell"><code>$ npm run dev src/capstone/front/index.html</code></pre>
<p>which displays:</p>
<pre class="text"><code>&gt; js4ds@0.1.0 dev /Users/stj/js4ds
&gt; parcel serve -p 4000 &quot;src/capstone/front/index.html&quot;

Server running at http://localhost:4000
+  Built in 20.15s.</code></pre>
<p>We then open <code>http://localhost:4000</code> in our browser and see Figure <a href="#f:capstone-first-attempt" data-reference-type="ref" data-reference="f:capstone-first-attempt">[f:capstone-first-attempt]</a>. That’s unexpected: we should see the initial data displayed. If we open the console in the browser and reload the page, we see this error message:</p>
<pre class="text"><code>Cross-Origin Request Blocked:
The Same Origin Policy disallows reading the remote resource \
  at http://localhost:3418/survey/stats.
(Reason: CORS header &#39;Access-Control-Allow-Origin&#39; missing).</code></pre>
<p>The “Learn More” link given with the error message takes us to <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS/Errors/CORSMissingAllowOrigin">this page</a>, which uses many science words we don’t know. A web search turns up <a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing">this article on Wikipedia</a>, which tells us that <a href="#g:cors"><strong>cross-origin resource sharing</strong></a> (CORS) is a security mechanism. If a page loads some JavaScript, and that JavaScript is allowed to send requests to servers other than the one that the page came from, then villains would be able to do things like send passwords saved in the browser to themselves. The details are too complex for this tutorial; the good news is that they’ve been wrapped up in a Node library called <code>cors</code>, which we can add to our server with just a couple of lines of code:</p>
<div class="sourceCode" id="cb402"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb402-1"><a href="#cb402-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> express <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;express&#39;</span>)</span>
<span id="cb402-2"><a href="#cb402-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> cors <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;cors&#39;</span>)          <span class="co">// added</span></span>
<span id="cb402-3"><a href="#cb402-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb402-4"><a href="#cb402-4" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> dataManager <span class="op">=</span> <span class="kw">null</span></span>
<span id="cb402-5"><a href="#cb402-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb402-6"><a href="#cb402-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> app <span class="op">=</span> <span class="fu">express</span>()</span>
<span id="cb402-7"><a href="#cb402-7" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>(<span class="fu">cors</span>())                       <span class="co">// added</span></span>
<span id="cb402-8"><a href="#cb402-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb402-9"><a href="#cb402-9" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/survey/stats&#39;</span><span class="op">,</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb402-10"><a href="#cb402-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...as before...</span></span>
<span id="cb402-11"><a href="#cb402-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb402-12"><a href="#cb402-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb402-13"><a href="#cb402-13" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;/survey/:start/:end&#39;</span><span class="op">,</span> (req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb402-14"><a href="#cb402-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...as before...</span></span>
<span id="cb402-15"><a href="#cb402-15" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb402-16"><a href="#cb402-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb402-17"><a href="#cb402-17" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>((req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb402-18"><a href="#cb402-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...as before...</span></span>
<span id="cb402-19"><a href="#cb402-19" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb402-20"><a href="#cb402-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb402-21"><a href="#cb402-21" aria-hidden="true" tabindex="-1"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> (dbm) <span class="kw">=&gt;</span> {</span>
<span id="cb402-22"><a href="#cb402-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...as before...</span></span>
<span id="cb402-23"><a href="#cb402-23" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Since this code is saved in <code>server-1.js</code>, we need to create a copy of the driver called <code>driver-1.js</code> that invokes it. Let’s run that:</p>
<pre class="shell"><code>$ node src/capstone/back/driver-1.js src/capstone/back/test-data.csv</code></pre>
<p>and then re-launch our application to get Figure <a href="#f:capstone-second-attempt" data-reference-type="ref" data-reference="f:capstone-second-attempt">[f:capstone-second-attempt]</a>.</p>
<p>This is much better. We can now type some dates into the “start” and “end” boxes and, after we press “update”, we get a chart and table of the aggregated statistics for the year range given (Figure <a href="#f:capstone-complete" data-reference-type="ref" data-reference="f:capstone-complete">[f:capstone-complete]</a>).</p>
<p>We’ve built an interface, used it to submit queries that are then handled by a server, which returns data that can be converted to content by our React components, and our capstone project is complete.</p>
<h2 id="s:capstone-exercises">Exercises</h2>
<h3 class="unnumbered" id="reporting-other-data">Reporting Other Data</h3>
<p>A user has asked for the number of male and female animals observed for each year.</p>
<ol>
<li><p>Should you add this to the existing query for yearly data or create a new API call?</p></li>
<li><p>Implement your choice.</p></li>
</ol>
<h3 class="unnumbered" id="error-checking">Error Checking</h3>
<ol>
<li><p>Modify the server to return 400 with an error message if the range of years requested is invalid</p></li>
<li><p>Compare your implementation to someone else’s. Did you define “invalid” in the same way, i.e., will your programs always return the same status codes for every query?</p></li>
</ol>
<h3 class="unnumbered" id="adding-more-tests">Adding More Tests</h3>
<ol>
<li><p>Our updated <code>server-1.js</code> doesn’t have a test associated with it. Make a copy of <code>test-server.js</code> and adjust it to test this version of the server.</p></li>
<li><p>What other elements of the application could and should be tested? Try writing tests for those. In doing this, did you discover imperfections in the example code? If so, we’d love to hear about them (see Appendix <a href="#s:contributing" data-reference-type="ref" data-reference="s:contributing">19</a>).</p></li>
</ol>
<h3 class="unnumbered" id="use-all-the-data">Use All the Data</h3>
<p>Create a database using all of the survey data and test the display. What bugs or shortcomings do you notice compared to displaying test data?</p>
<h3 class="unnumbered" id="merging-displays">Merging Displays</h3>
<p>The <code>SurveyStats</code> and <code>DataDisplay</code> components in the front end both display tables.</p>
<ol>
<li><p>Write a new component <code>TableDisplay</code> that will display an arbitrary table given a list of column names and a list of objects which all have (at least) those fields.</p></li>
<li><p>Replace <code>SurveyStats</code> and <code>DataDisplay</code> with your new component.</p></li>
<li><p>Modify your component so that it generates a unique ID for each value in the table. (Hint: you may need to pass in a third parameter to each call to serve as the root or stem of those unique IDs.)</p></li>
</ol>
<h3 class="unnumbered" id="formatting">Formatting</h3>
<p>Modify <code>DataDisplay</code> to format fractional numbers with a single decimal place, but leave the integers as they are. Ask yourself why, seven decades after the invention of digital computers, this isn’t easier.</p>
<h3 class="unnumbered" id="data-data-everywhere">Data, Data Everywhere</h3>
<p>Modify <code>DataChart</code> so that the word <code>data</code> isn’t used in so many different ways. Does doing this make you feel better about yourself as a person? Modify it again so that the height and width of the chart are passed in as well. Did that help?</p>
<h2 class="unnumbered" id="key-points-14">Key Points</h2>
<ul>
<li><p>Use slices of actual data to test applications.</p></li>
<li><p>Test summaries and small cases so that results can be checked by hand.</p></li>
<li><p>Store state in a class, use pure functions to display it.</p></li>
</ul>
<h1 id="s:finale">Finale</h1>
<p>We have come a long way since <code>console.log(’hello, world’)</code> in Chapter <a href="#s:basics" data-reference-type="ref" data-reference="s:basics">2</a>. Callbacks and promises, JSON and web servers, packaging, unit tests, and visualization: every modern language can do them, but JavaScript is an increasingly popular choice. Yes, it has its flaws, but if we avoid some of the legacy features in Appendix <a href="#s:legacy" data-reference-type="ref" data-reference="s:legacy">23</a> it’s both usable and powerful.</p>
<p>Our journey doesn’t stop here, though. The appendices explore some next steps, such as logging what our server does (Appendix <a href="#s:logging" data-reference-type="ref" data-reference="s:logging">25</a>) and using a relational database (Appendix <a href="#s:db" data-reference-type="ref" data-reference="s:db">27</a>) instead of a text file as a data store. Beyond that, you could look at more advanced techniques in JavaScript [<a class="cite" href="#ref-Have2018">Have2018</a>], dive into data wrangling <span class="citation" data-cites="Davi2018"></span>, or start over completely the way JavaScript programmers do every eight months and rewrite everything with <a href="https://developer.mozilla.org/en-US/docs/Web/Web_Components">Web Components</a>. Whatever you do, we hope that this tutorial has helped you get started.</p>
<p>Contributions of all kinds are welcome, from errata and minor improvements to entirely new sections and chapters. Please <a href="https://github.com/software-tools-books/js4ds/issues">file an issue</a> or <a href="https://github.com/software-tools-books/js4ds/pulls">submit a pull request</a> in <a href="https://github.com/software-tools-books/js4ds/">our GitHub repository</a>. Everyone whose work is incorporated will be acknowledged. Please see the contributors’ guide for more information, and please note that all contributors are required to abide by our Code of Conduct.</p>
<h2 class="unnumbered" id="key-points-15">Key Points</h2>
<ul>
<li><p>We have learned a lot.</p></li>
<li><p>Contributions are very welcome.</p></li>
</ul>
<h1 id="s:license">License</h1>
<p><em>This is a human-readable summary of (and not a substitute for) the license. Please see <a href="https://creativecommons.org/licenses/by-nc/4.0/legalcode">https://creativecommons.org/licenses/by-nc/4.0/legalcode</a> for the full legal text.</em></p>
<p>This work is licensed under the <a href="https://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0</a> license (CC-BY-NC-4.0).<br />
<strong>You are free to:</strong></p>
<ul>
<li><p><strong>Share</strong>—copy and redistribute the material in any medium or format</p></li>
<li><p><strong>Adapt</strong>—remix, transform, and build upon the material.</p></li>
</ul>
<p>The licensor cannot revoke these freedoms as long as you follow the license terms.</p>
<p><strong>Under the following terms:</strong></p>
<ul>
<li><p><strong>Attribution</strong>—You must give appropriate credit, provide a link to the license, and indicate if changes were made. You may do so in any reasonable manner, but not in any way that suggests the licensor endorses you or your use.<br />
</p></li>
<li><p><strong>NonCommercial</strong>—You may not use the material for commercial purposes.</p></li>
</ul>
<p><strong>No additional restrictions</strong>—You may not apply legal terms or technological measures that legally restrict others from doing anything the license permits.</p>
<p><strong>Notices:</strong></p>
<ul>
<li><p>You do not have to comply with the license for elements of the material in the public domain or where your use is permitted by an applicable exception or limitation.</p></li>
<li><p>No warranties are given. The license may not give you all of the permissions necessary for your intended use. For example, other rights such as publicity, privacy, or moral rights may limit how you use the material.</p></li>
</ul>
<h1 id="s:conduct">Code of Conduct</h1>
<p>In the interest of fostering an open and welcoming environment, we as contributors and maintainers pledge to making participation in our project and our community a harassment-free experience for everyone, regardless of age, body size, disability, ethnicity, gender identity and expression, level of experience, education, socio-economic status, nationality, personal appearance, race, religion, or sexual identity and orientation.</p>
<h2 id="s:conduct-standards">Our Standards</h2>
<p>Examples of behavior that contributes to creating a positive environment include:</p>
<ul>
<li><p>using welcoming and inclusive language,</p></li>
<li><p>being respectful of differing viewpoints and experiences,</p></li>
<li><p>gracefully accepting constructive criticism,</p></li>
<li><p>focusing on what is best for the community, and</p></li>
<li><p>showing empathy towards other community members.</p></li>
</ul>
<p>Examples of unacceptable behavior by participants include:</p>
<ul>
<li><p>the use of sexualized language or imagery and unwelcome sexual attention or advances,</p></li>
<li><p>trolling, insulting/derogatory comments, and personal or political attacks,</p></li>
<li><p>public or private harassment,</p></li>
<li><p>publishing others’ private information, such as a physical or electronic address, without explicit permission, and</p></li>
<li><p>other conduct which could reasonably be considered inappropriate in a professional setting</p></li>
</ul>
<h2 id="s:conduct-responsibilities">Our Responsibilities</h2>
<p>Project maintainers are responsible for clarifying the standards of acceptable behavior and are expected to take appropriate and fair corrective action in response to any instances of unacceptable behavior.</p>
<p>Project maintainers have the right and responsibility to remove, edit, or reject comments, commits, code, wiki edits, issues, and other contributions that are not aligned to this Code of Conduct, or to ban temporarily or permanently any contributor for other behaviors that they deem inappropriate, threatening, offensive, or harmful.</p>
<h2 id="s:conduct-scope">Scope</h2>
<p>This Code of Conduct applies both within project spaces and in public spaces when an individual is representing the project or its community. Examples of representing a project or community include using an official project e-mail address, posting via an official social media account, or acting as an appointed representative at an online or offline event. Representation of a project may be further defined and clarified by project maintainers.</p>
<h2 id="s:conduct-enforcement">Enforcement</h2>
<p>Instances of abusive, harassing, or otherwise unacceptable behavior may be reported by <a href="mailto:gvwilson@third-bit.com">emailing the project team</a>. All complaints will be reviewed and investigated and will result in a response that is deemed necessary and appropriate to the circumstances. The project team is obligated to maintain confidentiality with regard to the reporter of an incident. Further details of specific enforcement policies may be posted separately.</p>
<p>Project maintainers who do not follow or enforce the Code of Conduct in good faith may face temporary or permanent repercussions as determined by other members of the project’s leadership.</p>
<h2 id="s:conduct-attribution">Attribution</h2>
<p>This Code of Conduct is adapted from the <a href="https://www.contributor-covenant.org">Contributor Covenant</a> version 1.4.</p>
<h1 id="s:contributing">Contributing</h1>
<p>Contributions of all kinds are welcome, from errata and minor improvements to entirely new sections and chapters: please submit an issue or pull request to <a href="https://github.com/software-tools-books/js4ds/">our GitHub repository</a>. Everyone whose work is incorporated will be acknowledged; please note that all contributors are required to abide by our Code of Conduct (Appendix <a href="#s:conduct" data-reference-type="ref" data-reference="s:conduct">18</a>). Please note that we use Simplified English rather than Traditional English, i.e., American rather than British spelling and grammar. We encourage translations; if you would like to take this on, please <a href="mailto:gvwilson@third-bit.com">email us</a>.</p>
<p>If you wish to report errata or suggest improvements to wording, please include the chapter name in the first line of the body of your report (e.g., <code>Testing Data Analysis</code>).</p>
<h1 id="s:gloss">Glossary</h1>
<dl>
<dt><span id="g:absolute-path">absolute path</span></dt>
<dd><p>A path that points to the same location in the filesystem regardless of where it’s evaluated. An absolute path is the equivalent of latitude and longitude in geography. See also <a href="#g:relative-path"><strong>relative path</strong></a>.</p>
</dd>
<dt><span id="g:aggregation-function">aggregation function</span></dt>
<dd><p>A function that combines many values into one, such as <code>sum</code> or <code>max</code>.</p>
</dd>
<dt><span id="g:alias">alias</span></dt>
<dd><p>A second or subsequent name referring to the same data or function.</p>
</dd>
<dt><span id="g:anonymous-function">anonymous function</span></dt>
<dd><p>A function that is defined without giving it a name, such as a callback defined where it is used. Anonymous functions are sometimes called <em>lambda functions</em> because the Greek letter lambda is used for them in mathematics.</p>
</dd>
<dt><span id="g:api">Application Programming Interface (API)</span></dt>
<dd><p>the set of functions that a library or web service makes available for other code to use.</p>
</dd>
<dt><span id="g:argument">argument</span></dt>
<dd><p>see <a href="#g:parameter"><strong>parameter</strong></a>.</p>
</dd>
<dt><span id="g:array">array</span></dt>
<dd><p>A collection of values stored in a particular order and indexed numerically. Arrays are written as comma-separated values in square brackets, such as <code>[’a’, ’b’, ’c’]</code>. The term <a href="#g:list"><strong>list</strong></a> is often used synonymously.</p>
</dd>
<dt><span id="g:ascii">ASCII</span></dt>
<dd><p>A widely-used set of numeric codes for representing characters from the Latin alphabet and common punctuation symbols, now superseded by <a href="#g:unicode"><strong>Unicode</strong></a>.</p>
</dd>
<dt><span id="g:assertion">assertion</span></dt>
<dd><p>A statement that something is true at a certain point in a program. Assertions are often used to define tests, but are also used in <a href="#g:production-code"><strong>production code</strong></a> to check that software is behaving as it should.</p>
</dd>
<dt><span id="g:attribute">attribute</span></dt>
<dd><p>A named property attached to an HTML <a href="#g:element"><strong>element</strong></a>.</p>
</dd>
<dt><span id="g:backward-compatible">backward-compatible</span></dt>
<dd><p>Able to work consistently with older systems.</p>
</dd>
<dt><span id="g:body-http">body (of an HTTP message)</span></dt>
<dd><p>any optional data sent after the message’s headers.</p>
</dd>
<dt><span id="g:body-statement">body (of a statement)</span></dt>
<dd><p>The statements in a program that are nested within or controlled by another statement, such as those making up a function or those that are only executed if the <a href="#g:condition"><strong>condition</strong></a> of an <code>if</code> is true.</p>
</dd>
<dt><span id="g:boolean">Boolean</span></dt>
<dd><p>A value that can be either true or false, named after the English mathematician George Boole (deceased).</p>
</dd>
<dt><span id="g:bundler">bundler</span></dt>
<dd><p>A tool that combines JavaScript files, web pages, images, and other assets into a single bundle for deployment.</p>
</dd>
<dt><span id="g:cache">cache</span></dt>
<dd><p>A place where copies of recently-used values are stored for quicker access.</p>
</dd>
<dt><span id="g:call-stack">call stack</span></dt>
<dd><p>A data structure that stores information about function calls that are currently in progress. Each function call adds another table of variable-value pairs to the top of the stack; when the function completes, that table is discarded. See also <a href="#g:closure"><strong>closure</strong></a>.</p>
</dd>
<dt><span id="g:callback-function">callback function</span></dt>
<dd><p>A function A that is passed to another function B for B to call at a later time. Callback functions are used to implement delayed actions, such as what to do when data arrives in response to a network request.</p>
</dd>
<dt><span id="g:css">Cascading Style Sheets (CSS)</span></dt>
<dd><p>A way to describe how HTML should be rendered.</p>
</dd>
<dt><span id="g:catch">catch</span></dt>
<dd><p>To take responsibility for handling an <a href="#g:exception"><strong>exception</strong></a>. Catch is the counterpart of <a href="#g:throw"><strong>throw</strong></a>.</p>
</dd>
<dt><span id="g:cc-by">Creative Commons–Attribution License (CC-BY)</span></dt>
<dd><p>A license that allows people to re-use work as long as they cite its original source.</p>
</dd>
<dt><span id="g:character-encoding">character encoding</span></dt>
<dd><p>A specification of how characters are stored as bytes. The most commonly-used encoding today is <a href="#g:utf-8"><strong>UTF-8</strong></a>.</p>
</dd>
<dt><span id="g:child-class">child class</span></dt>
<dd><p>A new <a href="#g:class"><strong>class</strong></a> that <a href="#g:extend"><strong>extends</strong></a> an existing class (called the <a href="#g:parent-class"><strong>parent class</strong></a>).</p>
</dd>
<dt><span id="g:child-node">child node</span></dt>
<dd><p>A <a href="#g:node"><strong>node</strong></a> in a <a href="#g:tree"><strong>tree</strong></a> that is below some other node (which is called the child node’s <a href="#g:parent-node"><strong>parent</strong></a>).</p>
</dd>
<dt><span id="g:class">class</span></dt>
<dd><p>A programming structure that defines the properties and behavior of a family of related <a href="#g:object"><strong>objects</strong></a>. Classes can <a href="#g:inherit"><strong>inherit</strong></a> from other classes to specify or change behavior incrementally.</p>
</dd>
<dt><span id="g:client">client</span></dt>
<dd><p>A program such as a browser that sends requests to a <a href="#g:server"><strong>server</strong></a> and does something with the response. It is sometimes helpful to think of clients as sorcerers petitioning ancient gods for favors. Sometimes.</p>
</dd>
<dt><span id="g:client-page-gen">client-side page generation</span></dt>
<dd><p>To create an HTML page within a <a href="#g:client"><strong>client</strong></a> using data provided by a <a href="#g:server"><strong>server</strong></a>. See also <a href="#g:server-page-gen"><strong>server-side page generation</strong></a>.</p>
</dd>
<dt><span id="g:closure">closure</span></dt>
<dd><p>A set of variables defined in the same <a href="#g:scope"><strong>scope</strong></a> whose existence has been preserved after that scope has ended. Closures are one of the trickiest ideas in programming.</p>
</dd>
<dt><span id="g:component">component (in React)</span></dt>
<dd><p>A user-defined “tag” associated with a call to a function that generates HTML.</p>
</dd>
<dt><span id="g:condition">condition</span></dt>
<dd><p>The logical test that controls whether or not the <a href="#g:body-statement"><strong>body</strong></a> of an <code>if</code> statement executes or not.</p>
</dd>
<dt><span id="g:constructor">constructor</span></dt>
<dd><p>A “method” that is automatically called to initialize an object when it is created.</p>
</dd>
<dt><span id="g:csv">Comma-Separated Values (CSV)</span></dt>
<dd><p>A text format for tabular data in which each record is one row and fields are separated by commas. There are many minor variations, particularly around quoting of strings.</p>
</dd>
<dt><span id="g:connection-manager">connection manager</span></dt>
<dd><p>An object that maintains a connection to a database. When the code is finished working with the database, the connection manager ensures that the connection is closed gracefully, which helps to avoid the corruption of data.</p>
</dd>
<dt><span id="g:cdn">Content Delivery Network (CDN)</span></dt>
<dd><p>A geographically distributed set of servers that store commonly-used or recently-used data such as web pages so that they can be served more quickly.</p>
</dd>
<dt><span id="g:constant">constant</span></dt>
<dd><p>a variable whose value cannot be changed. Note that the value itself might be changed: for example, after the statement <code>const v = [’a’, ’b’]</code>, the name <code>v</code> will always refer to the same array, but the array’s contents can be changed. See also <a href="#g:variable"><strong>variable</strong></a>.</p>
</dd>
<dt><span id="g:cors">Cross-Origin Resource Sharing (CORS)</span></dt>
<dd><p>A way to control requests made for data and other resources that aren’t served by the site that gave the browser the original page.</p>
</dd>
<dt><span id="g:dataframe">dataframe</span></dt>
<dd><p>A data structure designed to store tabular data. A dataframe has zero or more named columns and zero or more rows, each of which has exactly one value for each column.</p>
</dd>
<dt><span id="g:declarative">declarative programming</span></dt>
<dd><p>A style of programming in which the user specifies what they want, and the computer figures out how to deliver it.</p>
</dd>
<dt><span id="g:deployment">deployment</span></dt>
<dd><p>The act of making software available for others to use.</p>
</dd>
<dt><span id="g:destructuring">destructuring</span></dt>
<dd><p>a form of assignment that unpacks a data structure in one step, such as <code>[a, b] = [1, 2]</code> or <code>{left, right} = {left: 1, right: 2}</code>.</p>
</dd>
<dt><span id="g:dns">Domain Name System (DNS)</span></dt>
<dd><p>A decentralized naming system for computers that translates logical names such as <code>third-bit.com</code> into the addresses of particular computers.</p>
</dd>
<dt><span id="g:document">document</span></dt>
<dd><p>An entire HTML page.</p>
</dd>
<dt><span id="g:dom">Document Object Model (DOM)</span></dt>
<dd><p>A standard way to represent HTML in memory. The <a href="#g:element"><strong>elements</strong></a> and <a href="#g:attribute"><strong>attributes</strong></a> of the page, along with its text, are stored as <a href="#g:node"><strong>nodes</strong></a> organized in a tree.</p>
</dd>
<dt><span id="g:dotted-notation">dotted notation</span></dt>
<dd><p>A common way to refer to the parts of structures in programming languages. <code>whole.part</code> means “the thing called <code>part</code> belonging to <code>whole</code>”.</p>
</dd>
<dt><span id="g:driver">driver</span></dt>
<dd><p>A program that provides a standard interface through which to communicate with another piece of hardware or software. Every graphics card has a driver that translates generic drawing commands into card-specific operations; every database comes with drivers that (theoretically) allow other programs to talk to them all in the same way.</p>
</dd>
<dt><span id="g:element">element</span></dt>
<dd><p>An individual component of a web page. In HTML, elements are enclosed in matching <code>&lt;tag&gt;</code> and <code>&lt;/tag&gt;</code> pairs, or written as <code>&lt;tag/&gt;</code> if they contain no content. Elements are represented as <a href="#g:node"><strong>nodes</strong></a> in the <a href="#g:dom"><strong>DOM</strong></a>.</p>
</dd>
<dt><span id="g:entry-point">entry point</span></dt>
<dd><p>A function with a known name and <a href="#g:signature"><strong>signature</strong></a> that a framework requires every plugin or other dynamically-loaded content to have. The entry point is (as the name suggests) how the framework gets into the plugin.</p>
</dd>
<dt><span id="g:escape-sequence">escape sequence</span></dt>
<dd><p>A sequence of characters used to represent some other character that would otherwise have a special meaning. For example, the escape sequence <code>\"</code> is used to represent a double-quote character inside a double-quoted string.</p>
</dd>
<dt><span id="g:event-handler">event handler</span></dt>
<dd><p>A <a href="#g:callback-function"><strong>callback function</strong></a> that does something in response to a particular interaction with a browser, such as a key being pressed or a link being clicked.</p>
</dd>
<dt><span id="g:event-listener">event listener</span></dt>
<dd><p>see <a href="#g:event-handler"><strong>event handler</strong></a>.</p>
</dd>
<dt><span id="g:event-loop">event loop</span></dt>
<dd><p>The fundamental processing cycle in JavaScript that takes the next task from a list and runs it, possibly adding more tasks to the list as it does so.</p>
</dd>
<dt><span id="g:event-object">event object</span></dt>
<dd><p>An <a href="#g:object"><strong>object</strong></a> that the system passes to an <a href="#g:event-handler"><strong>event handler</strong></a> that contains information about the event, such as which key was pressed.</p>
</dd>
<dt><span id="g:exception">exception</span></dt>
<dd><p>An object that stores information about an error or other unusual event in a program. One part of a program will create and <a href="#g:throw"><strong>throw</strong></a> an exception to signal that something unexpected has happened; another part will <a href="#g:catch"><strong>catch</strong></a> it.</p>
</dd>
<dt><span id="g:extend">extend</span></dt>
<dd><p>To create a new class from an existing class. We say that the new class <a href="#g:inherit"><strong>inherits</strong></a> from the old one.</p>
</dd>
<dt><span id="g:external-style-sheet">external style sheet</span></dt>
<dd><p>A set of <a href="#g:css"><strong>CSS</strong></a> definitions placed in an external file rather than inside a web page. See also <a href="#g:internal-style-sheet"><strong>internal style sheet</strong></a>.</p>
</dd>
<dt><span id="g:falsy">falsy</span></dt>
<dd><p>A horrible neologism meaning “equivalent to false”. See also the equally horrible <a href="#g:truthy"><strong>truthy</strong></a>.</p>
</dd>
<dt><span id="g:fat-arrow">fat arrow function</span></dt>
<dd><p>A function defined using <code>(parameters) =&gt; {body}</code>. Fat arrow functions treat the special value <code>this</code> in a less inconsistent way than their older equivalents.</p>
</dd>
<dt><span id="g:field">field</span></dt>
<dd><p>A named part of a <a href="#g:record"><strong>record</strong></a> in a <a href="#g:relational-database"><strong>relational database</strong></a>. Fields are typically shown as columns in a <a href="#g:table"><strong>table</strong></a>.</p>
</dd>
<dt><span id="g:fixture">fixture</span></dt>
<dd><p>The data on which a <a href="#g:unit-test"><strong>unit test</strong></a> is run.</p>
</dd>
<dt><span id="g:functional-programming">functional programming</span></dt>
<dd><p>A style of programming in which data is transformed through successive application of functions, rather than by using control structures such as loops. Functional programming in JavaScript relies heavily on <a href="#g:callback-function"><strong>callbacks</strong></a> and <a href="#g:higher-order-function"><strong>higher-order functions</strong></a>.</p>
</dd>
<dt><span id="g:global-installation">global installation</span></dt>
<dd><p>A JavaScript library placed in a location where it can be accessed by all users and projects. See also <a href="#g:local-installation"><strong>local installation</strong></a>.</p>
</dd>
<dt><span id="g:global-variable">global variable</span></dt>
<dd><p>A variable defined outside any particular function, which is therefore visible to all functions. See also <a href="#g:local-variable"><strong>local variable</strong></a>.</p>
</dd>
<dt><span id="g:gpl">GNU Public License (GPL)</span></dt>
<dd><p>A license that allows people to re-use software as long as they distribute the source of their changes.</p>
</dd>
<dt><span id="g:header-row">header row</span></dt>
<dd><p>If present, the first of a <a href="#g:csv"><strong>CSV</strong></a> file that defines column names (but tragically, not their data types or units).</p>
</dd>
<dt><span id="g:heterogeneous">heterogeneous</span></dt>
<dd><p>Having mixed type. For example, an <a href="#g:array"><strong>array</strong></a> is said to be heterogeneous if it contains a mix of numbers, character strings, and values of other types. See also <a href="#g:homogeneous"><strong>homogeneous</strong></a>.</p>
</dd>
<dt><span id="g:higher-order-function">higher-order function</span></dt>
<dd><p>A function that operates on other functions. For example, the higher-order function <code>forEach</code> executes a given function once on each value in an <a href="#g:array"><strong>array</strong></a>. Higher-order functions are heavily used in <a href="#g:functional-programming"><strong>functional programming</strong></a>.</p>
</dd>
<dt><span id="g:homogeneous">homogeneous</span></dt>
<dd><p>Having a single type. For example, an <a href="#g:array"><strong>array</strong></a> is said to be homogeneous if it contains only numbers or only character strings, but not a mix of the two.</p>
</dd>
<dt><span id="g:hostname">hostname</span></dt>
<dd><p>The part of a URL that specifies the computer to talk to. In the URL <code>http://example.com/something/</code>, the hostname is <code>example.com</code>; in the URL <code>http://localhost:1234/</code>, it is <code>localhost</code>.</p>
</dd>
<dt><span id="g:http">HyperText Transfer Protocol (HTTP)</span></dt>
<dd><p>The HyperText Transfer Protocol used to exchange information between browsers and websites, and more generally between other <a href="#g:client"><strong>clients</strong></a> and <a href="#g:server"><strong>servers</strong></a>. HTTP is a <a href="#g:stateless"><strong>stateless</strong></a> protocol in which communication consists of <a href="#g:http-request"><strong>requests</strong></a> and <a href="#g:http-response"><strong>responses</strong></a>.</p>
</dd>
<dt><span id="g:http-header">HTTP header</span></dt>
<dd><p>A name-value pair at the start of an HTTP <a href="#g:http-request"><strong>request</strong></a> or <a href="#g:http-response"><strong>response</strong></a>. Headers are used to specify what data formats the sender can handle, the date and time the message was sent, and so on.</p>
</dd>
<dt><span id="g:http-method">HTTP method</span></dt>
<dd><p>The verb in an <a href="#g:http-request"><strong>HTTP request</strong></a> that defines what the client wants to do. Common methods are <code>GET</code> (to get data) and <code>POST</code> (to submit data).</p>
</dd>
<dt><span id="g:http-request">HTTP request</span></dt>
<dd><p>A precisely-formatted block of text sent from a <a href="#g:client"><strong>client</strong></a> (such as a browser) to a <a href="#g:server"><strong>server</strong></a> that specifies what resource is being requested, what data formats the client will accept, and so on.</p>
</dd>
<dt><span id="g:http-response">HTTP response</span></dt>
<dd><p>A precisely-formatted block of text sent from a <a href="#g:server"><strong>server</strong></a> back to a <a href="#g:client"><strong>client</strong></a> in reply to a <a href="#g:http-request"><strong>request</strong></a>.</p>
</dd>
<dt><span id="g:http-status-code">HTTP status code</span></dt>
<dd><p>A numerical code that indicates what happened when an <a href="#g:http-request"><strong>HTTP request</strong></a> was processed, such as 200 (OK), 404 (not found), or 500 (internal server error).</p>
</dd>
<dt><span id="g:immutable">immutable</span></dt>
<dd><p>Data that cannot be changed after being created.</p>
</dd>
<dt><span id="g:in-memory-database">in-memory database</span></dt>
<dd><p>A database that is stored in memory rather than in permanent storage. In-memory databases are often used for testing.</p>
</dd>
<dt><span id="g:inherit">inherit</span></dt>
<dd><p>To acquire properties and methods from a parent class. See also <a href="#g:extend"><strong>extend</strong></a>.</p>
</dd>
<dt><span id="g:inner-loop">inner loop</span></dt>
<dd><p>A loop contained in the <a href="#g:body-statement"><strong>body</strong></a> of another loop. See also <a href="#g:nested-loop"><strong>nested loop</strong></a>.</p>
</dd>
<dt><span id="g:instance">instance</span></dt>
<dd><p>If an object <code>obj</code> is of a particular class <code>cls</code>, we say that <code>obj</code> is an instance of <code>cls</code>.</p>
</dd>
<dt><span id="g:instance-method">instance method</span></dt>
<dd><p>A method that is called using, and operates on, a particular object. See also <a href="#g:static-method"><strong>static method</strong></a>.</p>
</dd>
<dt><span id="g:internal-style-sheet">internal style sheet</span></dt>
<dd><p>A set of <a href="#g:css"><strong>CSS</strong></a> definitions placed inside a web page rather than in an external file. See also <a href="#g:external-style-sheet"><strong>external style sheet</strong></a>.</p>
</dd>
<dt><span id="g:json">JavaScript Object Notation (JSON)</span></dt>
<dd><p>A way to represent data by combining basic values like numbers and character strings in <a href="#g:array"><strong>arrays</strong></a> and name/value structures. The acronym stands for “JavaScript Object Notation”; unlike better-defined standards like <a href="#g:xml"><strong>XML</strong></a>, it is unencumbered by a syntax for comments or ways to define <a href="#g:schema"><strong>schemas</strong></a>.</p>
</dd>
<dt><span id="g:library">library</span></dt>
<dd><p>see <a href="#g:module"><strong>module</strong></a>.</p>
</dd>
<dt><span id="g:list">list</span></dt>
<dd><p>see <a href="#g:array"><strong>array</strong></a>.</p>
</dd>
<dt><span id="g:local-installation">local installation</span></dt>
<dd><p>A JavaScript library placed inside a particular project, and only accessible within that project. See also <a href="#g:global-installation"><strong>global installation</strong></a>.</p>
</dd>
<dt><span id="g:local-server">local server</span></dt>
<dd><p>A <a href="#g:server"><strong>server</strong></a> run on the user’s own computer, usually for testing purposes during development.</p>
</dd>
<dt><span id="g:local-variable">local variable</span></dt>
<dd><p>A variable defined inside a function which is only visible within that function. See also <a href="#g:global-variable"><strong>global variable</strong></a> and <a href="#g:closure"><strong>closure</strong></a>.</p>
</dd>
<dt><span id="g:logging">logging</span></dt>
<dd><p>To record information about a program’s execution in a structured way.</p>
</dd>
<dt><span id="g:logging-transport">logging transport</span></dt>
<dd><p>A channel through which <a href="#g:logging"><strong>logging</strong></a> messages are sent, such as standard output (for the user’s screen) or a database connection.</p>
</dd>
<dt><span id="g:member-variable">member variable</span></dt>
<dd><p>see <a href="#g:property"><strong>property</strong></a>.</p>
</dd>
<dt><span id="g:memory-diagram">memory diagram</span></dt>
<dd><p>A picture showing the variables a program contains and the data they refer to.</p>
</dd>
<dt><span id="g:method">method</span></dt>
<dd><p>A function attached to an <a href="#g:object"><strong>object</strong></a>, typically called using <a href="#g:dotted-notation"><strong>dotted notation</strong></a>. In JavaScript and many other languages, a special variable called <code>this</code> is provided to methods to refer to the particular object for which the method is being called.</p>
</dd>
<dt><span id="g:method-chaining">method chaining</span></dt>
<dd><p>A style of programming in which each method call returns either the original object or a newly-constructed object so that other method calls can be appended to create long chains of calculations. Method chaining produces code that looks like <code>obj.a().b().c()</code>.</p>
</dd>
<dt><span id="g:minimization">minimization</span></dt>
<dd><p>To remove spaces and other extraneous characters from source files (and possibly even rename variables). This makes those files smaller and faster to deploy at the expense of readability.</p>
</dd>
<dt><span id="g:mit-license">MIT License</span></dt>
<dd><p>A license that allows people to re-use software with no restrictions.</p>
</dd>
<dt><span id="g:model">model (of data)</span></dt>
<dd><p>How data is stored. See also <a href="#g:view"><strong>view</strong></a>.</p>
</dd>
<dt><span id="g:module">module</span></dt>
<dd><p>A set of variables, functions, and/or classes grouped together for easier management (typically but not always in a single file). Modules are sometimes also called <a href="#g:library"><strong>libraries</strong></a>.</p>
</dd>
<dt><span id="g:module-variable">module variable</span></dt>
<dd><p>A variable that is visible within a module but not outside it. See also <a href="#g:scope"><strong>scope</strong></a>.</p>
</dd>
<dt><span id="g:mutation">mutation</span></dt>
<dd><p>Changing data in place, such as modifying an element of an array or adding a record to a database.</p>
</dd>
<dt><span id="g:name-collision">name collision</span></dt>
<dd><p>The ambiguity that arises when two or more things in a program that have the same name are active at the same time. The <a href="#g:call-stack"><strong>call stack</strong></a> was invented in part to address this problem.</p>
</dd>
<dt><span id="g:nested-loop">nested loop</span></dt>
<dd><p>A loop that is contained in another loop. The <a href="#g:inner-loop"><strong>inner loop</strong></a> can run many times for each iteration of the <a href="#g:outer-loop"><strong>outer loop</strong></a>.</p>
</dd>
<dt><span id="g:node-js">Node</span></dt>
<dd><p>An open source implementation of JavaScript for use outside the browser.</p>
</dd>
<dt><span id="g:node">node</span></dt>
<dd><p>An in-memory representation of an element in an HTML page (not to be confused with <a href="#g:node-js"><strong>Node.js</strong></a>). See also <a href="#g:dom"><strong>DOM</strong></a>.</p>
</dd>
<dt><span id="g:nosql-database">NoSQL database</span></dt>
<dd><p>Any database that doesn’t use the <a href="#g:relational-database"><strong>relational</strong></a> model. The awkward name comes from the fact that such databases don’t use <a href="#g:sql"><strong>SQL</strong></a> as a query language.</p>
</dd>
<dt><span id="g:nan">Not a Number (NaN)</span></dt>
<dd><p>A special value used to represent an invalid number, such as the result of dividing zero by zero.</p>
</dd>
<dt><span id="g:object">object</span></dt>
<dd><p>A clump of variables and/or <a href="#g:method"><strong>methods</strong></a> grouped together in a program. In most languages, objects can only be created as instances of <a href="#g:class"><strong>classes</strong></a>, but JavaScript calls anything created using <code>{...}</code> an object. Do not seek to walk in the footsteps of the sages; seek rather what they sought.</p>
</dd>
<dt><span id="g:oop">object-oriented programming (OOP)</span></dt>
<dd><p>A style of programming centered around constructing self-contained objects that communicate through well-defined (or at least “defined”) interfaces.</p>
</dd>
<dt><span id="g:observer-observable">observer-observable</span></dt>
<dd><p>A widely-used programming pattern in which some <a href="#g:object"><strong>objects</strong></a> are notified and take action when other objects change state or take action.</p>
</dd>
<dt><span id="g:outer-loop">outer loop</span></dt>
<dd><p>A loop that contains another loop. See also <a href="#g:nested-loop"><strong>nested loop</strong></a>.</p>
</dd>
<dt><span id="g:override-method">override</span></dt>
<dd><p>to replace a definition of a <a href="#g:method"><strong>method</strong></a> in a <a href="#g:parent-class"><strong>parent-class</strong></a> with a new definition in a <a href="#g:child-class"><strong>child class</strong></a>.</p>
</dd>
<dt><span id="g:query-parameter">query parameter</span></dt>
<dd><p>A placeholder in an <a href="#g:sql"><strong>SQL</strong></a> query that must be filled in with an actual value in order for the query to run.</p>
</dd>
<dt><span id="g:package-manager">package manager</span></dt>
<dd><p>A program that does its best to keep track of the bits and bobs of software installed on a computer. The most widely used package manager for JavaScript is called NPM; it does its best, but really, without proper discipline on the part of programmers, it’s like Boromir trying to hold back the orcs or a kindergarten teacher trying to keep everyone’s shirt clean during finger-painting.</p>
</dd>
<dt><span id="g:parameter">parameter</span></dt>
<dd><p>A variable whose value is passed into a function when the function is called. Some writers distinguish parameters (the variables) from <a href="#g:argument"><strong>arguments</strong></a> (the values passed in), but others use the terms in the opposite sense. It’s all very confusing.</p>
</dd>
<dt><span id="g:parent-class">parent class</span></dt>
<dd><p>An existing <a href="#g:class"><strong>class</strong></a> that has been <a href="#g:extend"><strong>extended</strong></a> to create a new class. (The new class is called the <a href="#g:child-class"><strong>child class</strong></a>.)</p>
</dd>
<dt><span id="g:parent-node">parent node</span></dt>
<dd><p>The <a href="#g:node"><strong>node</strong></a> in a <a href="#g:tree"><strong>tree</strong></a> that is above some other node. Every node has a parent except the <a href="#g:root-node"><strong>root node</strong></a>.</p>
</dd>
<dt><span id="g:parse">parsing</span></dt>
<dd><p>To translate the text of a program or web page into a data structure in memory that the program can then manipulate.</p>
</dd>
<dt><span id="g:polymorphism">polymorphism</span></dt>
<dd><p>Literally, “having many forms”. The term refers to the way in which <a href="#g:object"><strong>objects</strong></a> whose <a href="#g:method"><strong>methods</strong></a> have the same names and <a href="#g:parameter"><strong>parameters</strong></a> can be used interchangeably.</p>
</dd>
<dt><span id="g:port">port</span></dt>
<dd><p>A logical endpoint for communication, like a phone number in an office building. In the URL <code>http://example.com:8081/something</code>, the port is <code>8081</code>. Only one program may use a port at any time.</p>
</dd>
<dt><span id="g:production-code">production code</span></dt>
<dd><p>Software that is delivered to an end user. The term is used to distinguish such code from test code, deployment infrastructure, and everything else that programmers write along the way.</p>
</dd>
<dt><span id="g:promise">promise</span></dt>
<dd><p>A way to handle delayed computations in JavaScript. Promises were supposed to make programmers’ lives simpler.</p>
</dd>
<dt><span id="g:prototype">prototype</span></dt>
<dd><p>An idiosyncratic mechanism used in the original definition of JavaScript for sharing properties between objects that we unfortunately still have to cope with.</p>
</dd>
<dt><span id="g:property">property</span></dt>
<dd><p>A variable associated with an <a href="#g:object"><strong>object</strong></a>. The term is used to distinguish an object’s passive data from its executable <a href="#g:method"><strong>methods</strong></a>. Properties are sometimes called <a href="#g:member-variable"><strong>member variables</strong></a>.</p>
</dd>
<dt><span id="g:pseudo-random-number">pseudo-random number</span></dt>
<dd><p>A value generated in a repeatable way that has the properties of being truly random.</p>
</dd>
<dt><span id="g:prng">pseudo-random number generator</span></dt>
<dd><p>A function that can generate a series of <a href="#g:pseudo-random-number"><strong>pseudo-random numbers</strong></a> after being initialized with a <a href="#g:seed"><strong>seed</strong></a>.</p>
</dd>
<dt><span id="g:cc-0">public domain license (CC-0)</span></dt>
<dd><p>A license that allows people to re-use material however they want with no restrictions and no requirement of attribution.</p>
</dd>
<dt><span id="g:race-condition">race condition</span></dt>
<dd><p>A situation in which the result of a computation can vary due to operations being performed in different orders.</p>
</dd>
<dt><span id="g:raise">raise</span></dt>
<dd><p>see <a href="#g:throw"><strong>throw</strong></a>.</p>
</dd>
<dt><span id="g:refactor">refactor</span></dt>
<dd><p>To reorganize or clean up code in a way that doesn’t change its behavior.</p>
</dd>
<dt><span id="g:repl">read-evaluate-print loop (REPL)</span></dt>
<dd><p>An interactive program that reads a command typed in by a user, executes it, prints the result, and then waits patiently for the next command. REPLs are often used to explore new ideas or for debugging.</p>
</dd>
<dt><span id="g:record">record</span></dt>
<dd><p>A set of related values. In a <a href="#g:relational-database"><strong>relational database</strong></a>, a record is typically shown as a single row in a <a href="#g:table"><strong>table</strong></a>. See also <a href="#g:field"><strong>field</strong></a>.</p>
</dd>
<dt><span id="g:regular-expression">regular expression</span></dt>
<dd><p>A pattern for matching text, written as text itself. Regular expressions are sometimes called “regexp”, “regex”, or “RE”, and are as powerful as they are cryptic.</p>
</dd>
<dt><span id="g:relational-database">relational database</span></dt>
<dd><p>A database that organizes information into <a href="#g:table"><strong>tables</strong></a>, each of which has a fixed set of named <a href="#g:field"><strong>fields</strong></a> (shown as columns) and a variable number of <a href="#g:record"><strong>records</strong></a> (shown as rows). See also <a href="#g:sql"><strong>SQL</strong></a>.</p>
</dd>
<dt><span id="g:relative-path">relative path</span></dt>
<dd><p>A path whose destination is interpreted relative to some other location, such as the current directory. A relative path is the equivalent of giving directions using terms like “straight” and “left”. See also <a href="#g:absolute-path"><strong>absolute path</strong></a>.</p>
</dd>
<dt><span id="g:responsive-design">responsive design</span></dt>
<dd><p>An approach to building web pages and other applications that resizes and reorganizes things smoothly for different sizes of screens.</p>
</dd>
<dt><span id="g:rgb">RGB</span></dt>
<dd><p>A way to represent colors as triples of red, green, and blue intensities, each of which ranges from 0 to 255. RGB is often augmented in modern systems to create RGBA, where the fourth component is the pixel’s transparency.</p>
</dd>
<dt><span id="g:root-node">root</span></dt>
<dd><p>The only node in a <a href="#g:tree"><strong>tree</strong></a> that <em>doesn’t</em> have a <a href="#g:parent-node"><strong>parent</strong></a>.</p>
</dd>
<dt><span id="g:root-directory">root directory</span></dt>
<dd><p>The directory that contains everything else, directly or indirectly. The root directory is written <code>/</code> (a bare forward slash).</p>
</dd>
<dt><span id="g:root-element">root element</span></dt>
<dd><p>The <a href="#g:element"><strong>element</strong></a> in a document that contains every other element. The root element of a web page is the <code>html</code> element.</p>
</dd>
<dt><span id="g:schema">schema</span></dt>
<dd><p>A specification of the “shape” of data, such as the <a href="#g:field"><strong>fields</strong></a> making up a database table or the ways in which structures can be nested in <a href="#g:json"><strong>JSON</strong></a>.</p>
</dd>
<dt><span id="g:scope">scope</span></dt>
<dd><p>The portion of a program within which a definition can be seen and used. See also <a href="#g:global-variable"><strong>global-variable</strong></a>, <a href="#g:local-variable"><strong>local-variable</strong></a>, <a href="#g:module-variable"><strong>module-variable</strong></a>, and (if you are brave) <a href="#g:closure"><strong>closure</strong></a>.</p>
</dd>
<dt><span id="g:seed">seed</span></dt>
<dd><p>A value used to initialize a <a href="#g:prng"><strong>pseudo-random number generator</strong></a>.</p>
</dd>
<dt><span id="g:selector">selector</span></dt>
<dd><p>A way to identify elements within an HTML document. The selector <code>h2#contents</code>, for example, means “the <code>h2</code> element with the ID <code>contents</code>”.</p>
</dd>
<dt><span id="g:server">server</span></dt>
<dd><p>A program that waits for requests from <a href="#g:client"><strong>clients</strong></a> and sends them data in response. It is sometimes helpful to think of servers as harassed parents trying to babysit a room full of unruly children.</p>
</dd>
<dt><span id="g:server-page-gen">server-side page generation</span></dt>
<dd><p>To create an HTML page on a server. That HTML is then delivered as-is to a browser for display. See also <a href="#g:client-page-gen"><strong>client-side page generation</strong></a>.</p>
</dd>
<dt><span id="g:spread-syntax">spread syntax</span></dt>
<dd><p>The <code>...</code> in <code>...some_array</code>, which means “interpolate the values of the array in place”.</p>
</dd>
<dt><span id="g:sql">SQL</span></dt>
<dd><p>The language used for writing queries for <a href="#g:relational-database"><strong>relational databases</strong></a>. The term was originally an acronym for Structured Query Language.</p>
</dd>
<dt><span id="g:signature">signature</span></dt>
<dd><p>The ordered list of argument data types required by a function or <a href="#g:method"><strong>method</strong></a>. If two functions or methods have the same signature, they can be called in the same way.</p>
</dd>
<dt><span id="g:stateful">stateful</span></dt>
<dd><p>To retain information from one operation to the next.</p>
</dd>
<dt><span id="g:stateless">stateless</span></dt>
<dd><p>To <em>not</em> retain information from one operation to the next.</p>
</dd>
<dt><span id="g:static-method">static method</span></dt>
<dd><p>one that belongs to the class as a whole rather than to objects of that class. Static methods are often used to implement helper methods for classes. See also <a href="#g:instance-method"><strong>instance method</strong></a>.</p>
</dd>
<dt><span id="g:string">string</span></dt>
<dd><p>A block of text in a program. The term is short for “character string”.</p>
</dd>
<dt><span id="g:string-interpolation">string interpolation</span></dt>
<dd><p>The process of inserting text corresponding to specified values into a string, usually to make output human-readable.</p>
</dd>
<dt><span id="g:table">table</span></dt>
<dd><p>A set of uniformly-formatted <a href="#g:record"><strong>records</strong></a> in a <a href="#g:relational-database"><strong>relational database</strong></a>. Tables are usually drawn with rows (each of which represents one record) and columns (each of which represents a <a href="#g:field"><strong>field</strong></a>).</p>
</dd>
<dt><span id="g:tag">tag</span></dt>
<dd><p>A short textual label identifying a kind of element in an HTML page. Commonly-used tags include <code>p</code> (for a paragraph) and <code>h1</code> (for a level-1 heading).</p>
</dd>
<dt><span id="g:template">template</span></dt>
<dd><p>A document with some placeholders that can be filled in with specific values. Templates are often used to create personalized email messages and web pages, though their efficacy is predicated upon relentless commercialization and devaluation of modern society’s sense of what constitutes “personal”.</p>
</dd>
<dt><span id="g:test-runner">test runner</span></dt>
<dd><p>A program that finds and runs <a href="#g:unit-test"><strong>unit tests</strong></a> and reports their results.</p>
</dd>
<dt><span id="g:test-suite">test suite</span></dt>
<dd><p>A set of <a href="#g:unit-test"><strong>unit tests</strong></a>, usually stored in files that follow a prescribed naming convention.</p>
</dd>
<dt><span id="g:throw">throw</span></dt>
<dd><p>To signal that something unexpected or unusual has happened in a program by creating an <a href="#g:exception"><strong>exception</strong></a> and handing it to the error-handling system, which then tries to find a point in the program that will <a href="#g:catch"><strong>catch</strong></a> it. (Some languages call this <em><a href="#g:raise"><strong>raising</strong></a></em> an exception.)</p>
</dd>
<dt><span id="g:tidy-data">tidy data</span></dt>
<dd><p>Tabular data that satisfies four conditions:</p>
<ul>
<li><p>Each column contains one statistical variable (i.e., one property that was measured or observed).</p></li>
<li><p>Each different observation is in a different row.</p></li>
<li><p>There is one table for each set of observations.</p></li>
<li><p>If there are multiple tables, each table has a column containing a unique key so that related data can be linked.</p></li>
</ul>
</dd>
<dt><span id="g:tree">tree</span></dt>
<dd><p>A data structure containing strictly-nested <a href="#g:node"><strong>nodes</strong></a>. Every node except the <a href="#g:root-node"><strong>root node</strong></a> must have exactly one <a href="#g:parent-node"><strong>parent node</strong></a>, but each node may have zero or more <a href="#g:child-node"><strong>children</strong></a>.</p>
</dd>
<dt><span id="g:truthy">truthy</span></dt>
<dd><p>A truly Orwellian neologism meaning “not equivalent to false”. See also <a href="#g:falsy"><strong>falsy</strong></a>, but only if you are able to set aside your respect for the English language.</p>
</dd>
<dt><span id="g:unicode">Unicode</span></dt>
<dd><p>A standard that defines numeric codes for many thousands of characters and symbols. Unicode does <em>not</em> define how those numbers are stored; that is done by standards like <a href="#g:utf-8"><strong>UTF-8</strong></a>.</p>
</dd>
<dt><span id="g:unit-test">unit test</span></dt>
<dd><p>A test that exercises one property or expected behavior of a system.</p>
</dd>
<dt><span id="g:url">URL</span></dt>
<dd><p>A multi-part identifier that specifies something on a computer network. A URL may contain a protocol (such as <code>http</code>), a hostname (such as <code>example.com</code>), a port (such as <code>80</code>), a path (such as <code>/homepage.html</code>), and <a href="#g:query-parameter"><strong>query parameters</strong></a>.</p>
</dd>
<dt><span id="g:utf-8">UTF-8</span></dt>
<dd><p>A way to store the numeric codes representing Unicode characters in memory that is <a href="#g:backward-compatible"><strong>backward-compatible</strong></a> with the older <a href="#g:ascii"><strong>ASCII</strong></a> standard.</p>
</dd>
<dt><span id="g:variable">variable</span></dt>
<dd><p>A name in a program that has some data associated with it. A variable’s value can be changed after definition. See also <a href="#g:constant"><strong>constant</strong></a>.</p>
</dd>
<dt><span id="g:view">view (of data)</span></dt>
<dd><p>How data is presented. See also <a href="#g:model"><strong>model</strong></a>.</p>
</dd>
<dt><span id="g:whitespace">whitespace</span></dt>
<dd><p>The space, newline, carriage return, and horizontal and vertical tab characters that take up space but don’t create a visible mark. The name comes from their appearance on a printed page in the era of typewriters.</p>
</dd>
<dt><span id="g:xml">XML</span></dt>
<dd><p>A set of rules for defining HTML-like tags and using them to format documents (typically data). XML achieved license plate popularity in the early 2000s, but its complexity led many programmers to adopt <a href="#g:json"><strong>JSON</strong></a> instead.</p>
</dd>
</dl>
<h1 id="s:keypoints">Key Points</h1>
<h2 class="unnumbered" id="introduction">Introduction</h2>
<ul>
<li><p>Modern JavaScript is a good tool for building desktop and web-based applications.</p></li>
<li><p>This course is for people who know what loops and functions are, but have never used JavaScript or built web applications.</p></li>
<li><p>Node is a command-line interpreter for JavaScript, which can be used interactively or to run scripts in files.</p></li>
<li><p>NPM is the Node Package Manager, which can be used to find, install, update, build, and execute JavaScript libraries.</p></li>
</ul>
<h2 class="unnumbered" id="basic-features">Basic Features</h2>
<ul>
<li><p>Use <code>console.log</code> to print messages.</p></li>
<li><p>Use dotted notation <code>X.Y</code> to get part <code>Y</code> of object <code>X</code>.</p></li>
<li><p>Basic data types are Booleans, numbers, and character strings.</p></li>
<li><p>Arrays store multiple values in order.</p></li>
<li><p>The special values <code>null</code> and <code>undefined</code> mean ‘no value’ and ‘does not exist’.</p></li>
<li><p>Define constants with <code>const</code> and variables with <code>let</code>.</p></li>
<li><p><code>typeof</code> returns the type of a value.</p></li>
<li><p><code>for (let variable of collection) {...}</code> iterates through the values in an array.</p></li>
<li><p><code>if (condition) {...} else {...}</code> conditionally executes some code.</p></li>
<li><p><code>false</code>, 0, the empty string, <code>null</code>, and <code>undefined</code> are false; everything else is true.</p></li>
<li><p>Use back quotes and <code>${...}</code> to interpolate values into strings.</p></li>
<li><p>An object is a collection of name/value pairs written in <code>{...}</code>.</p></li>
<li><p><code>object[key]</code> or <code>object.key</code> gets a value from an object.</p></li>
<li><p>Functions are objects that can be assigned to variables, stored in lists, etc.</p></li>
<li><p><code>function name(...parameters...) {...body...}</code> is the old way to define a function.</p></li>
<li><p><code>name = (...parameters...) =&gt; {...body...}</code> is the new way to define a function.</p></li>
<li><p>Use <code>return</code> inside a function body to return a value at any point.</p></li>
<li><p>Use modules to divide code between multiple files for re-use.</p></li>
<li><p>Assign to <code>module.exports</code> to specify what a module exports.</p></li>
<li><p><code>require(...path...)</code> imports a module.</p></li>
<li><p>Paths beginning with ‘.’ or ‘/’ are imported locally, but paths without ‘.’ or ‘/’ look in the library.</p></li>
</ul>
<h2 class="unnumbered" id="callbacks">Callbacks</h2>
<ul>
<li><p>JavaScript stores the instructions making up a function in memory like any other object.</p></li>
<li><p>Function objects can be assigned to variables, put in lists, passed as arguments to other functions, etc.</p></li>
<li><p>Functions can be defined in place without ever being given a name.</p></li>
<li><p>A callback function is one that is passed in to another function for it to execute at a particular moment.</p></li>
<li><p>Functional programming uses higher-order functions on immutable data.</p></li>
<li><p><code>Array.some</code> is true if any element in an array passes a test, while <code>Array.every</code> is true if they all do.</p></li>
<li><p><code>Array.filter</code> selects elements of an array that pass a test.</p></li>
<li><p><code>Array.map</code> creates a new array by transforming values in an existing one.</p></li>
<li><p><code>Array.reduce</code> reduces an array to a single value.</p></li>
<li><p>A closure is a set of variables captured during the definition of a function.</p></li>
</ul>
<h2 class="unnumbered" id="objects-and-classes">Objects and Classes</h2>
<ul>
<li><p>Create classes to define combinations of data and behavior.</p></li>
<li><p>Use the class’s constructor to initialize objects.</p></li>
<li><p><code>this</code> refers to the current object.</p></li>
<li><p>Use polymorphism to express common behavior patterns.</p></li>
<li><p>Extend existing classes to create new ones-sometimes.</p></li>
<li><p>Override methods to change or extend their behavior.</p></li>
</ul>
<h2 class="unnumbered" id="html-and-css">HTML and CSS</h2>
<ul>
<li><p>HTML is the latest in a long line of markup languages.</p></li>
<li><p>HTML documents contain elements (represented by tags in angle brackets) and text.</p></li>
<li><p>Elements must be strictly nested.</p></li>
<li><p>Elements can contain attributes.</p></li>
<li><p>Use escape sequences beginning with ampersand to represent special characters.</p></li>
<li><p>Every page should have one <code>html</code> element containing a <code>head</code> and a <code>body</code>.</p></li>
<li><p>Use <code>&lt;!--...--&gt;</code> to include comments in HTML.</p></li>
<li><p>Use <code>ul</code> and <code>ol</code> for unordered and ordered lists, and <code>li</code> for list elements.</p></li>
<li><p>Use <code>table</code> for tables, <code>tr</code> for rows, <code>th</code> for headings, and <code>td</code> for regular data.</p></li>
<li><p>Use <code>&lt;a href="..."&gt;...&lt;/a&gt;</code> to create links.</p></li>
<li><p>Use <code>&lt;img src="..." title="..." alt="..." /&gt;</code> to include images.</p></li>
<li><p>Use CSS to define appearance of elements.</p></li>
<li><p>Use <code>class</code> and <code>id</code> to identify elements.</p></li>
<li><p>Use selectors to specify the elements that CSS applies to.</p></li>
</ul>
<h2 class="unnumbered" id="manipulating-pages">Manipulating Pages</h2>
<ul>
<li><p>Use a <code>meta</code> tag in a page’s header to specify the page’s character encoding.</p></li>
<li><p>Pages are represented in memory using a Document Object Model (DOM).</p></li>
<li><p>The <code>document</code> object represents the page a script is in.</p></li>
<li><p>Use the <code>querySelectorAll</code> method to find DOM nodes that match a condition.</p></li>
<li><p>Assign HTML text to a node’s <code>innerHTML</code> property to change the node’s content.</p></li>
<li><p>Use <code>((params) =&gt; {...})(arguments)</code> to create and call a function in a single step.</p></li>
<li><p>An event listener is a function run by the browser when some specific event occurs.</p></li>
<li><p>Create an event listener for <code>’DOMContentLoaded’</code> to trigger execution of scripts <em>after</em> the DOM has been constructed.</p></li>
<li><p>Check the <code>nodeType</code> or <code>nodeName</code> property of a DOM node to find out what kind of node it is.</p></li>
<li><p>Destructuring assignment allows us to assign to multiple variables by name in a single statement.</p></li>
<li><p>Use <code>setTimeout</code> to trigger execution of a function after a delay.</p></li>
<li><p>To make something run forever, have the function called by <code>setTimeout</code> set another timeout of the same function.</p></li>
</ul>
<h2 class="unnumbered" id="dynamic-pages">Dynamic Pages</h2>
<ul>
<li><p>Older dynamic web sites generated pages on the server.</p></li>
<li><p>Newer dynamic web sites generate pages in the client.</p></li>
<li><p>React is a JavaScript library for client-side page generation that represents HTML elements as function calls.</p></li>
<li><p>React replaces page elements with dynamically-generated content in memory (not on disk).</p></li>
<li><p>React functions can be customized with elements.</p></li>
<li><p>JSX translates HTML into React function calls so that HTML and JavaScript can be mixed freely.</p></li>
<li><p>Use Babel to translate JSX into JavaScript in the browser.</p></li>
<li><p>Define new React components with a pseudo-HTML element and a corresponding function.</p></li>
<li><p>Attributes to pseudo-HTML are passed to the JavaScript function as a <code>props</code> object.</p></li>
</ul>
<h2 class="unnumbered" id="visualizing-data">Visualizing Data</h2>
<ul>
<li><p>Vega-Lite is a simple way to build common visualizations.</p></li>
<li><p>Vega-Lite is declarative: the user creates a data structure describing what they want, and the library creates the visualization.</p></li>
<li><p>A Vega-Lite specification contains a schema identifier, a description, data, marks, and encodings.</p></li>
<li><p>The overall layout of a Vega-Lite visualization can be controlled by setting options.</p></li>
<li><p>Some applications will use <code>require</code> for server-side code and <code>import</code> for client-side code.</p></li>
</ul>
<h2 class="unnumbered" id="promises">Promises</h2>
<ul>
<li><p>JavaScript keeps an execution queue for delayed computations.</p></li>
<li><p>Use promises to manage delayed computation instead of raw callbacks.</p></li>
<li><p>Use a callback with two arguments to handle successful completion (resolve) and unsuccessful completion (reject) of a promise.</p></li>
<li><p>Use <code>then</code> to express the next step after successful completion and <code>catch</code> to handle errors.</p></li>
<li><p>Use <code>Promise.all</code> to wait for all promises in a list to complete and <code>Promise.race</code> to wait for the first promise in a set to complete.</p></li>
<li><p>Use <code>await</code> to wait for the result of a computation.</p></li>
<li><p>Mark functions that can be waited on with <code>async</code>.</p></li>
</ul>
<h2 class="unnumbered" id="interactive-sites">Interactive Sites</h2>
<ul>
<li><p>Define event handlers to specify what actions the browser should take when the user interacts with an application.</p></li>
<li><p>The browser passes event objects containing details of events to event handlers.</p></li>
<li><p>Use classes to keep state and event handlers together.</p></li>
<li><p>React calls a class’s <code>render</code> to display it.</p></li>
<li><p>Separate models (which store data) from views (which display it).</p></li>
<li><p>Use <code>fetch</code> to get data from servers.</p></li>
<li><p>Use destructuring to get individual members from an object in a single step.</p></li>
<li><p>Modern JavaScript uses promises to manage asynchronous activities.</p></li>
</ul>
<h2 class="unnumbered" id="managing-data">Managing Data</h2>
<ul>
<li><p>Small tabular datasets are commonly stored as Comma-Separated Values (CSV).</p></li>
<li><p>CSV can only represent regular data, and CSV files usually don’t include units.</p></li>
<li><p>Nested data is commonly stored using JavaScript Object Notation (JSON).</p></li>
<li><p>JSON representations of tabular data often include redundant (and therefore possibly inconsistent) specifications of column names.</p></li>
<li><p>PapaParse is a robust CSV parsing library that produces JSON output.</p></li>
</ul>
<h2 class="unnumbered" id="creating-a-server">Creating a Server</h2>
<ul>
<li><p>An HTTP request or response consists of a plain-text header and an optional body.</p></li>
<li><p>HTTP is a stateless protocol.</p></li>
<li><p>Express provides a simple path-based JavaScript server.</p></li>
<li><p>Write callback functions to handle requests matching specified paths.</p></li>
<li><p>Provide a default handler for unrecognized requests.</p></li>
<li><p>Use <code>Content-Type</code> to specify the type of data being returned.</p></li>
<li><p>Use dynamic loading to support plugin extensions.</p></li>
</ul>
<h2 class="unnumbered" id="testing">Testing</h2>
<ul>
<li><p>A unit test checks the behavior of one software component in isolation.</p></li>
<li><p>The result of a unit test can be pass, fail, or error.</p></li>
<li><p>Use Mocha to write and run unit tests in JavaScript.</p></li>
<li><p>Put assertions in unit tests to check results.</p></li>
<li><p>Combine tests in suites for easier management.</p></li>
<li><p>Divide modules into interactive and non-interactive parts for easier testing.</p></li>
<li><p>Use <code>supertest</code> to simulate interaction with a server for testing.</p></li>
<li><p>HTML is represented in memory using the Document Object Model (DOM).</p></li>
<li><p>Check the structure of the DOM rather than the textual representation of the HTML when testing.</p></li>
</ul>
<h2 class="unnumbered" id="using-data-forge">Using Data-Forge</h2>
<ul>
<li><p>Create a <code>DataFrame</code> from an array of objects with identical keys, from a spec with <code>columnNames</code> and <code>rows</code> fields, or by parsing text that contains CSV or JSON.</p></li>
<li><p>If you’re using a loop on a dataframe, you’re doing the wrong thing.</p></li>
<li><p>Use method chaining to create pipelines that filter data and create new values from old.</p></li>
<li><p>Use grouping and aggregation to summarize data.</p></li>
</ul>
<h2 class="unnumbered" id="capstone-project">Capstone Project</h2>
<ul>
<li><p>Use slices of actual data to test applications.</p></li>
<li><p>Test summaries and small cases so that results can be checked by hand.</p></li>
<li><p>Store state in a class, use pure functions to display it.</p></li>
</ul>
<h2 class="unnumbered" id="finale">Finale</h2>
<ul>
<li><p>We have learned a lot.</p></li>
<li><p>Contributions are very welcome.</p></li>
</ul>
<h1 id="s:collab">Collaborating</h1>
<p>A project can survive badly-organized code; none will survive for long if people are confused, pulling in different directions, or hostile. This appendix therefore talks about what projects can do to make newcomers feel welcome and to make things run smoothly after that.</p>
<p>It may seem strange to include this material in a tutorial on JavaScript, but as Freeman pointed out in [<a class="cite" href="#ref-Free1972">Free1972</a>].</p>
<h2 id="s:collab-software">Licensing Software</h2>
<p>If the law or a publication agreement prevents people from reading your work or using your software, you’re probably hurting your own career. You may need to do this in order to respect personal or commercial confidentiality, but the first and most important rule of inclusivity is to be open by default.</p>
<p>That is easier said than done, not least because the law hasn’t kept up with everyday practice. [<a class="cite" href="#ref-Mori2012">Mori2012</a>] is a deeper dive for those who want details. In brief, creative works are automatically eligible for intellectual property (and thus copyright) protection. This means that every creative work has some sort of license: the only question is whether authors and users know what it is.</p>
<p>Every project should therefore include an explicit license. This license should be chosen early: if you don’t set it up right at the start, then each collaborator will hold copyright on their work and will need to be asked for approval when a license <em>is</em> chosen. By convention, the license is usually put in a file called <code>LICENSE</code> or <code>LICENSE.txt</code> in the project’s root directory. This file should clearly state the license(s) under which the content is being made available; the plural is used because code, data, and text may be covered by different licenses.</p>
<blockquote>
<h4 id="dont-write-your-own-license" class="unnumbered">Don’t Write Your Own License</h4>
<p>Not even if you are a lawyer: legalese is a highly technical language, and words don’t mean what you think they do.</p>
</blockquote>
<p>To make license selection as easy as possible, GitHub allows you to select one of the most common licenses when creating a repository. The Open Source Initiative maintains <a href="http://opensource.org/licenses">a list of licenses</a>, and <a href="http://choosealicense.com/">choosealicense.com</a> will help you find a license that suits your needs. Some of the things you will need to think about are:</p>
<ol>
<li><p>Do you want to license the code at all?</p></li>
<li><p>Is the content you are licensing source code?</p></li>
<li><p>Do you require people distributing derivative works to also distribute their code?</p></li>
<li><p>Do you want to address patent rights?</p></li>
<li><p>Is your license compatible with the licenses of the software you depend on? For example, as we will discuss below, you can use MIT-licensed code in a GPL-licensed project but not vice versa.</p></li>
</ol>
<p>The two most popular licenses for software are the <a href="#g:mit-license"><strong>MIT license</strong></a> and the <a href="#g:gpl"><strong>GNU Public License</strong></a> (GPL). The MIT license (and its close sibling the BSD license) say that people can do whatever they want to with the software as long as they cite the original source, and that the authors accept no responsibility if things go wrong. The GPL gives people similar rights, but requires them to share their own work on the same terms:</p>
<blockquote>
<p>You may copy, distribute and modify the software as long as you track changes/dates in source files. Any modifications to or software including (via compiler) GPL-licensed code must also be made available under the GPL along with build &amp; install instructions.</p>
<p>— <a href="https://tldrlegal.com/license/gnu-general-public-license-v3-(gpl-3)">tl;dr</a></p>
</blockquote>
<p>We recommend the MIT license: it places the fewest restrictions on future action, it can be made stricter later on, and the last thirty years show that it’s good enough to keep work open.</p>
<h2 id="s:collab-datadocs">Licensing Data and Documentation</h2>
<p>The MIT license and the GPL apply to software. When it comes to data and reports, the most widely used family of licenses are those produced by <a href="https://creativecommons.org/">Creative Commons</a>, which have been written and checked by lawyers and are well understood by the community.</p>
<p>The most liberal license is referred to as <a href="#g:cc-0"><strong>CC-0</strong></a>, where the “0” stands for “zero restrictions”. CC-0 puts work in the public domain, i.e., allows anyone who wants to use it to do so however they want with no restrictions. This is usually the best choice for data, since it simplifies aggregate analysis. For example, if you choose a license for data that requires people to cite their source, then anyone who uses that data in an analysis must cite you; so must anyone who cites <em>their</em> results, and so on, which quickly becomes unwieldy.</p>
<p>The next most common license is the Creative Commons–Attribution license, usually referred to as <a href="#g:cc-by"><strong>CC-BY</strong></a>. This allows people to do whatever they want to with the work as long as they cite the original source. This is the best license to use for manuscripts, since you <em>want</em> people to share them widely but also want to get credit for your work.</p>
<p>Other Creative Commons licenses incorporate various restrictions on specific use cases:</p>
<ul>
<li><p>ND (no derivative works) prevents people from creating modified versions of your work. Unfortunately, this also inhibits translation and reformatting.</p></li>
<li><p>NC (no commercial use) does <em>not</em> mean that people cannot charge money for something that includes your work, though some publishers still try to imply that in order to scare people away from open licensing. Instead, the NC clause means that people cannot charge for something that uses your work without your explicit permission, which you can give under whatever terms you want.</p></li>
<li><p>Finally, SA (share-alike) requires people to share work that incorporates yours on the same terms that you used. Again, this is fine in principle, but in practice makes aggregation a headache.</p></li>
</ul>
<h2 id="s:collab-conduct">Code of Conduct</h2>
<p>You don’t expect to have a fire, but every large building or event should have a fire safety plan. Similarly, having a Code of Conduct like Appendix <a href="#s:conduct" data-reference-type="ref" data-reference="s:conduct">18</a> for your project reduces the uncertainty that participants face about what is acceptable and unacceptable behavior. You might think this is obvious, but long experience shows that articulating it clearly and concisely reduces problems caused by having different expectations, particularly when people from very different cultural backgrounds are trying to collaborate. An explicit Code of Conduct is particularly helpful for newcomers, so having one can help your project grow and encourage people to give you feedback.</p>
<p>Having a Code of Conduct is particularly important for people from marginalized or under-represented groups, who have probably experienced harassment or unwelcoming behavior before. By adopting one, you signal that your project is trying to be a better place than YouTube, Twitter, and other online cesspools. Some people may push back claiming that it’s unnecessary, or that it infringes freedom of speech, but in our experience, what they often mean is that thinking about how they might have benefited from past inequity makes them feel uncomfortable, or that they like to argue for the sake of arguing. If having a Code of Conduct leads to them going elsewhere, that will probably make your project run more smoothly.</p>
<p>Just as you shouldn’t write your own license for a project, you probably shouldn’t write your own Code of Conduct. We recommend using the <a href="https://www.contributor-covenant.org">Contributor Covenant</a> for development projects and the <a href="http://geekfeminism.wikia.com/wiki/Conference_anti-harassment/Policy">model code of conduct</a> from the <a href="http://geekfeminism.wikia.com/">Geek Feminism Wiki</a> for in-person events. Both have been thought through carefully and revised in the light of experience, and both are now used widely enough that many potential participants in your project will not need to have them explained.</p>
<p>Rules are meaningless if they aren’t enforced. If you adopt a Code of Conduct, it is therefore important to be clear about how to report issues and who will handle them. <span class="citation" data-cites="Auro2018"></span> is a short, practical guide to handling incidents; like the Contributor Covenant and the model code of conduct, it’s better to start with something that other people have thought through and refined than to try to create something from scratch.</p>
<h2 id="s:collab-governance">Governance</h2>
<p>If your project involves more than half a dozen people, you should be explicit about the way decisions are made. We recommend Martha’s Rules <span class="citation" data-cites="Mina1986"></span>:</p>
<ol>
<li><p>Before each meeting, anyone who wishes may sponsor a proposal. Proposals must be circulated at least 24 hours before a meeting in order to be considered at that meeting, and must include:</p>
<ul>
<li><p>a one-line summary (the subject line of the issue);</p></li>
<li><p>the full text of the proposal;</p></li>
<li><p>any required background information;</p></li>
<li><p>pros and cons; and</p></li>
<li><p>possible alternatives.</p></li>
</ul></li>
<li><p>A quorum is established in a meeting if half or more of voting members are present.</p></li>
<li><p>Once a person has sponsored a proposal, they are responsible for it. The group may not discuss or vote on the issue unless the sponsor or their delegate is present. The sponsor is also responsible for presenting the item to the group.</p></li>
<li><p>After the sponsor presents the proposal, a <em>sense vote</em> is cast for the proposal prior to any discussion:</p>
<ul>
<li><p>Who likes the proposal?</p></li>
<li><p>Who can live with the proposal?</p></li>
<li><p>Who is uncomfortable with the proposal?</p></li>
</ul></li>
<li><p>If all or most of the group likes or can live with the proposal, it is immediately moved to a formal vote with no further discussion.</p></li>
<li><p>If most of the group is uncomfortable with the proposal, it is postponed for further rework by the sponsor.</p></li>
<li><p>If some members are uncomfortable they can briefly state their objections. A timer is then set for a brief discussion moderated by the facilitator. After 10 minutes or when no one has anything further to add (whichever comes first), the facilitator calls for a yes-or-no vote on the question: “Should we implement this decision over the stated objections?” If a majority votes "yes" the proposal is implemented. Otherwise, the proposal is returned to the sponsor for further work.</p></li>
</ol>
<h1 id="s:legacy">Legacy JavaScript Issues</h1>
<p>JavaScript is now twenty-five years old, and like many twenty-somethings, it is still struggling with issues from its childhood. This appendix explores three of them.</p>
<h2 id="s:legacy-equality">Equality</h2>
<p>Gary Bernhardt’s <a href="https://www.destroyallsoftware.com/talks/wat">lightning talk from 2012</a> may be the most-watched presentation on JavaScript ever. In it, he rattles through some truths about the language that may surprise you (Table <a href="#t:legacy-surprises" data-reference-type="ref" data-reference="t:legacy-surprises">23.1</a>).</p>
<div id="t:legacy-surprises">
<table class="table table-striped">
<caption><span>Surprising Results</span><span id="t:legacy-surprises" label="t:legacy-surprises">[t:legacy-surprises]</span></caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Operation</td>
<td style="text-align: left;">Code</td>
<td style="text-align: left;">Result</td>
</tr>
<tr class="even">
<td style="text-align: left;">empty array plus empty array</td>
<td style="text-align: left;"><code>[] + []</code></td>
<td style="text-align: left;"><code>""</code> (empty string)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">empty array plus empty object</td>
<td style="text-align: left;"><code>[] + {}</code></td>
<td style="text-align: left;"><code>{}</code> (empty object)</td>
</tr>
<tr class="even">
<td style="text-align: left;">empty object plus empty array</td>
<td style="text-align: left;"><code>{} + []</code></td>
<td style="text-align: left;"><code>0</code> (number zero)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">empty object plus empty object</td>
<td style="text-align: left;"><code>{} + {}</code></td>
<td style="text-align: left;"><code>NaN</code> (not a number)</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
</div>
<p>In order to understand this, we need to know several things (which are laid out in more detail in <a href="https://medium.com/dailyjs/the-why-behind-the-wat-an-explanation-of-javascripts-weird-type-system-83b92879a8db">this article</a> by Abhinav Suri):</p>
<ol>
<li><p>Arrays are objects whose keys happen to be sequential integers.</p></li>
<li><p>When JavaScript tries to add things that aren’t numbers, it tries to convert them to numbers, and if that doesn’t work, to strings (because it can always concatenate strings).</p></li>
<li><p>To convert an array to a string, JavaScript converts the elements to strings and concatenates them. If the array is empty, the result is an empty string.</p></li>
<li><p>When converting an object to a string, JavaScript produces <code>[object CLASS]</code>, where <code>CLASS</code> is the name of the object’s class.</p></li>
<li><p><code>{}</code> can be interpreted as either an empty object <em>or</em> an empty block of code.</p></li>
</ol>
<p>So:</p>
<ul>
<li><p>Empty array plus empty array becomes empty string plus empty string.</p></li>
<li><p>Empty array plus empty object becomes empty string plus <code>[object Object]</code> (because the class of an empty object is just <code>Object</code>).</p></li>
<li><p><code>{} + []</code> is “an empty block of code producing nothing, followed by <code>+[]</code>”, which becomes “+ of the numeric value of the string value of an empty array”, which becomes “+ of 0”.</p></li>
<li><p>Empty object plus empty object is interpreted as an empty object plus an empty block of code, and since an empty block of code doesn’t produce a result, its “value” is <code>NaN</code> (not a number).</p></li>
</ul>
<p>This is one of many cases in programming (and real life) where doing something that’s convenient in a simple case produces confusion in less common cases. Every language except Canadian English has warts like these.</p>
<h2 id="s:legacy-iteration">Iteration</h2>
<p>We wrote above that arrays are objects. This led to some undesirable behavior with JavaScript’s original <code>for</code> loop, which used the word <code>in</code> rather than <code>of</code>, and which looped over all of an object’s enumerable keys:</p>
<div class="sourceCode" id="cb404"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb404-1"><a href="#cb404-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> things <span class="op">=</span> [<span class="st">&#39;x&#39;</span><span class="op">,</span> <span class="st">&#39;y&#39;</span><span class="op">,</span> <span class="st">&#39;z&#39;</span>]</span>
<span id="cb404-2"><a href="#cb404-2" aria-hidden="true" tabindex="-1"></a>things<span class="op">.</span><span class="at">someProperty</span> <span class="op">=</span> <span class="st">&#39;someValue&#39;</span></span>
<span id="cb404-3"><a href="#cb404-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-4"><a href="#cb404-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> key <span class="kw">in</span> things) {</span>
<span id="cb404-5"><a href="#cb404-5" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(key)</span>
<span id="cb404-6"><a href="#cb404-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre class="text"><code>0
1
2
someProperty</code></pre>
<p>That phrase “enumerable keys” conceals some strangeness of its own, but in brief, a <code>for-in</code> loop will loop over keys inherited from the object’s parents as well as those defined in the object itself. Since this is usually not what programmers want (especially for arrays), older code often used a C-style loop:</p>
<div class="sourceCode" id="cb406"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb406-1"><a href="#cb406-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> things<span class="op">.</span><span class="at">length</span><span class="op">;</span> i <span class="op">+=</span> <span class="dv">1</span>) {</span>
<span id="cb406-2"><a href="#cb406-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(i)</span>
<span id="cb406-3"><a href="#cb406-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre class="text"><code>0
1
2</code></pre>
<p>Today’s solution is to use <code>for-of</code> to get the <em>values</em> from an array, which is usually what we want:</p>
<div class="sourceCode" id="cb408"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb408-1"><a href="#cb408-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> key <span class="kw">of</span> things) {</span>
<span id="cb408-2"><a href="#cb408-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(key)</span>
<span id="cb408-3"><a href="#cb408-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre class="text"><code>x
y
z</code></pre>
<p>Better yet, use <code>forEach</code> and take advantage of its optional second and third arguments:</p>
<div class="sourceCode" id="cb410"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb410-1"><a href="#cb410-1" aria-hidden="true" tabindex="-1"></a>things<span class="op">.</span><span class="fu">forEach</span>((val<span class="op">,</span> loc<span class="op">,</span> array) <span class="kw">=&gt;</span> {</span>
<span id="cb410-2"><a href="#cb410-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`element </span><span class="sc">${</span>loc<span class="sc">}</span><span class="vs"> of </span><span class="sc">${</span>array<span class="sc">}</span><span class="vs"> is </span><span class="sc">${</span>val<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb410-3"><a href="#cb410-3" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<pre class="text"><code>element 0 of x,y,z is x
element 1 of x,y,z is y
element 2 of x,y,z is z</code></pre>
<h2 id="s:legacy-prototypes">Prototypes</h2>
<p>We come finally to an aspect of JavaScript that has been the cause of a great deal of confusion: prototypes. Every JavaScript object has an internal property called its <a href="#g:prototype"><strong>prototype</strong></a>. If you try to access some property of an object and it’s not found, JavaScript automatically looks in the object that the first object’s prototype refers to. If the desired property isn’t there, JavaScript looks in the prototype object’s prototype, and so on.</p>
<p>So where do prototypes come from? If an object is created with <code>new Something()</code>, and the function <code>Something</code> has a property called <code>prototype</code>, then the new object’s prototype is set to the object to which that <code>prototype</code> property points.</p>
<p>This will all make sense with an example and a diagram. Let’s create an object to store the default properties of ice cream cones, then create a function <code>Cone</code> that creates an actual cone:</p>
<div class="sourceCode" id="cb412"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb412-1"><a href="#cb412-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> iceCream <span class="op">=</span> {</span>
<span id="cb412-2"><a href="#cb412-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">size</span><span class="op">:</span> <span class="st">&#39;large&#39;</span></span>
<span id="cb412-3"><a href="#cb412-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb412-4"><a href="#cb412-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb412-5"><a href="#cb412-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> Cone <span class="op">=</span> <span class="kw">function</span>(f) {</span>
<span id="cb412-6"><a href="#cb412-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">flavor</span> <span class="op">=</span> f</span>
<span id="cb412-7"><a href="#cb412-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb412-8"><a href="#cb412-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb412-9"><a href="#cb412-9" aria-hidden="true" tabindex="-1"></a>Cone<span class="op">.</span><span class="at">prototype</span> <span class="op">=</span> iceCream</span></code></pre></div>
<p>We can now create a cone and look at its properties (Figure <a href="#f:legacy-prototype" data-reference-type="ref" data-reference="f:legacy-prototype">23.1</a>):</p>
<div class="sourceCode" id="cb413"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb413-1"><a href="#cb413-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> dessert <span class="op">=</span> <span class="kw">new</span> <span class="fu">Cone</span>(<span class="st">&#39;mustard&#39;</span>)</span>
<span id="cb413-2"><a href="#cb413-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`flavor &quot;</span><span class="sc">${</span>dessert<span class="op">.</span><span class="at">flavor</span><span class="sc">}</span><span class="vs">&quot; size &quot;</span><span class="sc">${</span>dessert<span class="op">.</span><span class="at">size</span><span class="sc">}</span><span class="vs">&quot;`</span>)</span></code></pre></div>
<pre class="text"><code>flavor &quot;mustard&quot; size &quot;large&quot;</code></pre>
<figure>
<img src="figures/legacy-prototype.svg" id="f:legacy-prototype" /><figcaption aria-hidden="true"><span>Prototypes</span><span id="f:legacy-prototype" label="f:legacy-prototype">[f:legacy-prototype]</span></figcaption>
</figure>
<p>If we change the <code>size</code> of our dessert, lookup finds the object’s property before looking up the chain to find the parent object’s:</p>
<div class="sourceCode" id="cb415"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb415-1"><a href="#cb415-1" aria-hidden="true" tabindex="-1"></a>dessert<span class="op">.</span><span class="at">size</span> <span class="op">=</span> <span class="st">&#39;extra-large&#39;</span></span>
<span id="cb415-2"><a href="#cb415-2" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`new flavor &quot;</span><span class="sc">${</span>dessert<span class="op">.</span><span class="at">flavor</span><span class="sc">}</span><span class="vs">&quot; size &quot;</span><span class="sc">${</span>dessert<span class="op">.</span><span class="at">size</span><span class="sc">}</span><span class="vs">&quot;`</span>)</span></code></pre></div>
<pre class="text"><code>new flavor &quot;mustard&quot; size &quot;extra-large&quot;</code></pre>
<p>Prototypes are a way to implement inheritance for object-oriented programming; the problem is that the mechanics are rather clumsy, and very different from what most programmers are used to, so people built a variety of layers on top of prototypes. To make things even more confusing, <code>this</code> can behave in some rather odd ways, and again, people built layers to try to insulate themselves from those oddities. Prototypes still have their fans, but most people find modern JavaScript’s classes easier to use.</p>
<h1 id="s:regexp">Regular Expressions</h1>
<p>A <a href="#g:regular-expression"><strong>regular expression</strong></a> is a pattern for matching text. Most languages implement them in libraries, but they are built into JavaScript, and are written using <code>/</code> before and after a string rather than single or double quotes.</p>
<ul>
<li><p>Letters and digits match themselves, so the regular expression <code>/enjoy/</code> matches the word “enjoy” wherever it appears in a string.</p></li>
<li><p>A dot matches any character, so <code>/../</code> matches any two consecutive characters and <code>/en..y/</code> matches “enjoy”, “gently”, and “brightens your day”.</p></li>
<li><p>The asterisk <code>*</code> means “match zero or more occurrences of what comes immediately before”, so <code>en*</code> matches “ten” and “penny”. It also matches “feet” (which has an “e” followed by zero occurrences of “n”).</p></li>
<li><p>The plus sign <code>+</code> means “match <em>one</em> or more occurrences of what comes immediately before”, so <code>en+</code> still matches “ten” and “penny” but doesn’t match “feet” (because there isn’t an “n”).</p></li>
<li><p>Parentheses create groups just as they do in mathematics, so <code>(an)+</code> matches “banana” but not “annual”.</p></li>
<li><p>The pipe character <code>|</code> means “either/or”, so <code>b|c</code> matches either a single “b” or a single “c”, and <code>(either)|(or)</code> matches either “either” or “or”. (The parentheses are necessary because <code>either|or</code> matches “eitherr” or “eitheor”.)</p></li>
<li><p>The shorthand notation <code>[a-z]</code> means “all the characters in a range”, and is easier to write and read than <code>a|b|c|…|y|z</code>.</p></li>
<li><p>The characters <code>^</code> and <code>$</code> are called anchors: they match the beginning and end of the line without matching any actual characters.</p></li>
<li><p>If we want to put a special character like <code>.</code>, <code>*</code>, <code>+</code>, or <code>|</code> in a regular expression, we have to <a href="#g:escape-sequence"><strong>escape</strong></a> it with a backslash <code>\</code>. This means that <code>/stop\./</code> only matches “stop.”, while <code>stop.</code> matches “stops” as well.</p></li>
</ul>
<div id="t:regexp-examples">
<table class="table table-striped">
<caption><span>Regular Expression Matches</span><span id="t:regexp-examples" label="t:regexp-examples">[t:regexp-examples]</span></caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Text</td>
<td style="text-align: left;">Pattern</td>
<td style="text-align: left;">Match</td>
<td style="text-align: left;">Explanation</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>abc</code></td>
<td style="text-align: left;">/b/</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">character matches itself</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">/b*/</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">matches zero or more b’s</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;">/z*/</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">text contains zero z’s, so pattern matches</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">/z+/</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">text does not contain one or more z’s</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;">/a.c/</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">’.’ matches the ’b’</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">/<span>^</span>b/</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">text does not start with ’b’</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>abc123</code></td>
<td style="text-align: left;">/[a-z]+/</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">contains one or more consecutive lower-case letters</td>
</tr>
<tr class="odd">
<td style="text-align: left;"></td>
<td style="text-align: left;">/<span>^</span>[a-z]+$/</td>
<td style="text-align: left;">no</td>
<td style="text-align: left;">digits in string prevent a match</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;">/<span>^</span>[a-z0-9]+$/</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">whole string is lower-letters or digits</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>Dr. Toby</code></td>
<td style="text-align: left;">/(Dr|Prof)<span>\</span>./</td>
<td style="text-align: left;">yes</td>
<td style="text-align: left;">contains either “Dr” or “Prof” followed by literal ’.’</td>
</tr>
<tr class="even">
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
</div>
<p>This is a lot to digest, so Table <a href="#t:regexp-examples" data-reference-type="ref" data-reference="t:regexp-examples">24.1</a> shows a few examples. Regular expressions can match an intimidating number of other patterns, but are fairly easy to use in programs. Like strings and arrays, they are objects with methods: if <code>pattern</code> is a regular expression, then <code>string.test(pattern)</code> returns <code>true</code> if the pattern matches the string and <code>false</code> if it does not, while <code>string.match(pattern)</code> returns an array of matching substrings. If we add the modifier “g” after the closing slash of the regular expression to make it “global”, then <code>string.match(pattern)</code> returns <em>all</em> of the matching substrings:</p>
<div class="sourceCode" id="cb417"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb417-1"><a href="#cb417-1" aria-hidden="true" tabindex="-1"></a>Tests <span class="op">=</span> [</span>
<span id="cb417-2"><a href="#cb417-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;Jamie: james@geneinfo.org&#39;</span><span class="op">,</span></span>
<span id="cb417-3"><a href="#cb417-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;Zara: zetsure@bio123.edu&#39;</span><span class="op">,</span></span>
<span id="cb417-4"><a href="#cb417-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;Hong and Andrzej: hchui@euphoric.edu and aszego@euphoric.edu&#39;</span></span>
<span id="cb417-5"><a href="#cb417-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb417-6"><a href="#cb417-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb417-7"><a href="#cb417-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> pattern <span class="op">=</span> <span class="ss">/</span><span class="sc">[a-z]+</span><span class="ss">@</span><span class="sc">[a-z]+\.[a-z]+</span><span class="ss">/g</span></span>
<span id="cb417-8"><a href="#cb417-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb417-9"><a href="#cb417-9" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`pattern is </span><span class="sc">${</span>pattern<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb417-10"><a href="#cb417-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> test <span class="kw">of</span> Tests) {</span>
<span id="cb417-11"><a href="#cb417-11" aria-hidden="true" tabindex="-1"></a>  <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`tested against </span><span class="sc">${</span>test<span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb417-12"><a href="#cb417-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> matches <span class="op">=</span> test<span class="op">.</span><span class="fu">match</span>(pattern)</span>
<span id="cb417-13"><a href="#cb417-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (matches <span class="op">===</span> <span class="kw">null</span>) {</span>
<span id="cb417-14"><a href="#cb417-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;-no matches-&#39;</span>)</span>
<span id="cb417-15"><a href="#cb417-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb417-16"><a href="#cb417-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> {</span>
<span id="cb417-17"><a href="#cb417-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> m <span class="kw">of</span> matches) {</span>
<span id="cb417-18"><a href="#cb417-18" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(m)</span>
<span id="cb417-19"><a href="#cb417-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb417-20"><a href="#cb417-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb417-21"><a href="#cb417-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<pre class="text"><code>pattern is /[a-z]+@[a-z]+\.[a-z]+/g

tested against Jamie: james@geneinfo.org
james@geneinfo.org

tested against Zara: zetsure@bio123.edu
-no matches-

tested against Hong and Andrzej: hchui@euphoric.edu and aszego@euphoric.edu
hchui@euphoric.edu
aszego@euphoric.edu</code></pre>
<p>As powerful as they are, there are things that <a href="https://stackoverflow.com/questions/1732348/regex-match-open-tags-except-xhtml-self-contained-tags/1732454#1732454">regular expressions can’t do</a>. When it comes to pulling information out of text, though, they are easier to use and more efficient than long chains of substring tests. They can also be used to replace substrings and to split strings into pieces: please see <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions">the documentation</a> for more information.</p>
<h1 id="s:logging">Logging</h1>
<p>The <code>console.log</code> function we have been using is a simple form of <a href="#g:logging"><strong>logging</strong></a>. We can use a library called <a href="https://github.com/winstonjs/winston">Winston</a> to get more control and structure. By control, we mean that we can define levels for messages and a threshold for the logger, and only log things that are at least that important. This is much better than commenting and uncommenting messages, both because it involves less typing and because we can leave the logging code in place when we put our application into production to debug the problems that inevitably arise after we thought we were done. The standard error levels provided by Winston (and similar logging libraries) are <code>’error’</code>, <code>’warn’</code>, <code>’info’</code>, <code>’verbose’</code>, and <code>’debug’</code>, so if we set the threshold to <code>’info’</code>, then <code>’verbose’</code> and <code>’debug’</code> messages won’t be displayed.</p>
<p>As for structure, Winston produces log messages as JSON objects by default so that other programs can easily read them. We can also configure it to produce CSV, or even define some custom format, though doing that will make everyone’s life more difficult.</p>
<p>Whatever format we choose, we have to create and add a <a href="#g:logging-transport"><strong>transport</strong></a> to tell Winston where messages should go. We will use one called <code>Console</code> that sends messages to the screen; we can also send messages to files, to remote logging servers, and so on. Note that we do <em>not</em> create a variable called <code>console</code> for the transport, because that will overwrite the <code>console</code> we have been using up until now, and yes, that took a couple of minutes to figure out<span>…</span></p>
<div class="sourceCode" id="cb419"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb419-1"><a href="#cb419-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> express <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;express&#39;</span>)</span>
<span id="cb419-2"><a href="#cb419-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> path <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;path&#39;</span>)</span>
<span id="cb419-3"><a href="#cb419-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> fs <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;fs&#39;</span>)</span>
<span id="cb419-4"><a href="#cb419-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> winston <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;winston&#39;</span>)</span>
<span id="cb419-5"><a href="#cb419-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb419-6"><a href="#cb419-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> PORT <span class="op">=</span> <span class="dv">3418</span></span>
<span id="cb419-7"><a href="#cb419-7" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> <span class="bu">root</span> <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">argv</span>[<span class="dv">2</span>]</span>
<span id="cb419-8"><a href="#cb419-8" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> level <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">argv</span>[<span class="dv">3</span>]</span>
<span id="cb419-9"><a href="#cb419-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb419-10"><a href="#cb419-10" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> transport <span class="op">=</span> <span class="kw">new</span> winston<span class="op">.</span><span class="at">transports</span><span class="op">.</span><span class="fu">Console</span>()</span>
<span id="cb419-11"><a href="#cb419-11" aria-hidden="true" tabindex="-1"></a>winston<span class="op">.</span><span class="fu">add</span>(transport)</span>
<span id="cb419-12"><a href="#cb419-12" aria-hidden="true" tabindex="-1"></a>winston<span class="op">.</span><span class="at">level</span> <span class="op">=</span> level</span>
<span id="cb419-13"><a href="#cb419-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb419-14"><a href="#cb419-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Main server object.</span></span>
<span id="cb419-15"><a href="#cb419-15" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> app <span class="op">=</span> <span class="fu">express</span>()</span>
<span id="cb419-16"><a href="#cb419-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb419-17"><a href="#cb419-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Handle all requests.</span></span>
<span id="cb419-18"><a href="#cb419-18" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>((req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb419-19"><a href="#cb419-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> actual <span class="op">=</span> path<span class="op">.</span><span class="fu">join</span>(<span class="bu">root</span><span class="op">,</span> req<span class="op">.</span><span class="at">url</span>)</span>
<span id="cb419-20"><a href="#cb419-20" aria-hidden="true" tabindex="-1"></a>  fs<span class="op">.</span><span class="fu">stat</span>(actual<span class="op">,</span> (err<span class="op">,</span> stats) <span class="kw">=&gt;</span> {</span>
<span id="cb419-21"><a href="#cb419-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (err) {</span>
<span id="cb419-22"><a href="#cb419-22" aria-hidden="true" tabindex="-1"></a>      winston<span class="op">.</span><span class="fu">error</span>(<span class="vs">`Unable to find &quot;</span><span class="sc">${</span>actual<span class="sc">}</span><span class="vs">&quot;`</span>)</span>
<span id="cb419-23"><a href="#cb419-23" aria-hidden="true" tabindex="-1"></a>      res<span class="op">.</span><span class="fu">status</span>(<span class="dv">404</span>)<span class="op">.</span><span class="fu">send</span>(</span>
<span id="cb419-24"><a href="#cb419-24" aria-hidden="true" tabindex="-1"></a>        <span class="vs">`&lt;html&gt;&lt;body&gt;&lt;p&gt;cannot read </span><span class="sc">${</span>actual<span class="sc">}</span><span class="vs">&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;`</span>)</span>
<span id="cb419-25"><a href="#cb419-25" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (<span class="op">!</span>stats<span class="op">.</span><span class="fu">isFile</span>()) {</span>
<span id="cb419-26"><a href="#cb419-26" aria-hidden="true" tabindex="-1"></a>      winston<span class="op">.</span><span class="fu">error</span>(<span class="vs">`&quot;</span><span class="sc">${</span>actual<span class="sc">}</span><span class="vs">&quot; is not a file`</span>)</span>
<span id="cb419-27"><a href="#cb419-27" aria-hidden="true" tabindex="-1"></a>      res<span class="op">.</span><span class="fu">status</span>(<span class="dv">404</span>)<span class="op">.</span><span class="fu">send</span>(</span>
<span id="cb419-28"><a href="#cb419-28" aria-hidden="true" tabindex="-1"></a>        <span class="vs">`&lt;html&gt;&lt;body&gt;&lt;p&gt;cannot read </span><span class="sc">${</span>actual<span class="sc">}</span><span class="vs">&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;`</span>)</span>
<span id="cb419-29"><a href="#cb419-29" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb419-30"><a href="#cb419-30" aria-hidden="true" tabindex="-1"></a>      winston<span class="op">.</span><span class="fu">debug</span>(<span class="vs">`Serving &quot;</span><span class="sc">${</span>actual<span class="sc">}</span><span class="vs">&quot;`</span>)</span>
<span id="cb419-31"><a href="#cb419-31" aria-hidden="true" tabindex="-1"></a>      fs<span class="op">.</span><span class="fu">readFile</span>(actual<span class="op">,</span> <span class="st">&#39;utf-8&#39;</span><span class="op">,</span> (err<span class="op">,</span> data) <span class="kw">=&gt;</span> {</span>
<span id="cb419-32"><a href="#cb419-32" aria-hidden="true" tabindex="-1"></a>        res<span class="op">.</span><span class="fu">status</span>(<span class="dv">200</span>)<span class="op">.</span><span class="fu">send</span>(data)</span>
<span id="cb419-33"><a href="#cb419-33" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb419-34"><a href="#cb419-34" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb419-35"><a href="#cb419-35" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb419-36"><a href="#cb419-36" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb419-37"><a href="#cb419-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb419-38"><a href="#cb419-38" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">listen</span>(PORT<span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb419-39"><a href="#cb419-39" aria-hidden="true" tabindex="-1"></a>  winston<span class="op">.</span><span class="fu">info</span>(<span class="vs">`Running on port </span><span class="sc">${</span>PORT<span class="sc">}</span><span class="vs"> with root </span><span class="sc">${</span><span class="bu">root</span><span class="sc">}</span><span class="vs">`</span>)</span>
<span id="cb419-40"><a href="#cb419-40" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>In the script above, we set the logging level with an extra command-line parameter. If we run the script with the <code>’debug’</code> level, all messages appear. If we run it with the <code>’info’</code> level, the startup message and the 404 error messages appear, and if we run it with the level <code>’error’</code> only the latter appear.</p>
<pre class="shell"><code>$ node src/logging/logging-server.js src/logging/web-dir/ info</code></pre>
<pre class="text"><code>{&quot;message&quot;:&quot;Running on port 3418 with root src/logging/web-dir/&quot;,
 &quot;level&quot;:&quot;info&quot;}
{&quot;message&quot;:&quot;Unable to find \&quot;src/logging/web-dir/missing.html\&quot;&quot;,
 &quot;level&quot;:&quot;error&quot;}</code></pre>
<h1 id="s:extensible">Extensible Servers</h1>
<p>Suppose we want to extend the server from Chapter <a href="#s:server" data-reference-type="ref" data-reference="s:server">12</a> in some way. We could edit the source file and add some more URL handlers, or we could have it load JavaScript dynamically and run that.</p>
<div class="sourceCode" id="cb422"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb422-1"><a href="#cb422-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> express <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;express&#39;</span>)</span>
<span id="cb422-2"><a href="#cb422-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb422-3"><a href="#cb422-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> PORT <span class="op">=</span> <span class="dv">3418</span></span>
<span id="cb422-4"><a href="#cb422-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb422-5"><a href="#cb422-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Main server object.</span></span>
<span id="cb422-6"><a href="#cb422-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> app <span class="op">=</span> <span class="fu">express</span>()</span>
<span id="cb422-7"><a href="#cb422-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb422-8"><a href="#cb422-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Handle all requests.</span></span>
<span id="cb422-9"><a href="#cb422-9" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">use</span>((req<span class="op">,</span> res<span class="op">,</span> next) <span class="kw">=&gt;</span> {</span>
<span id="cb422-10"><a href="#cb422-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (req<span class="op">.</span><span class="at">url</span><span class="op">.</span><span class="fu">endsWith</span>(<span class="st">&#39;.js&#39;</span>)) {</span>
<span id="cb422-11"><a href="#cb422-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> libName <span class="op">=</span> <span class="st">&#39;./&#39;</span><span class="op">.</span><span class="fu">concat</span>(req<span class="op">.</span><span class="at">url</span><span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> <span class="op">-</span><span class="dv">3</span>))</span>
<span id="cb422-12"><a href="#cb422-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> dynamic <span class="op">=</span> <span class="pp">require</span>(libName)</span>
<span id="cb422-13"><a href="#cb422-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> data <span class="op">=</span> dynamic<span class="op">.</span><span class="fu">page</span>()</span>
<span id="cb422-14"><a href="#cb422-14" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">status</span>(<span class="dv">200</span>)<span class="op">.</span><span class="fu">send</span>(data)</span>
<span id="cb422-15"><a href="#cb422-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb422-16"><a href="#cb422-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb422-17"><a href="#cb422-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span> {</span>
<span id="cb422-18"><a href="#cb422-18" aria-hidden="true" tabindex="-1"></a>    res<span class="op">.</span><span class="fu">status</span>(<span class="dv">404</span>)<span class="op">.</span><span class="fu">send</span>(</span>
<span id="cb422-19"><a href="#cb422-19" aria-hidden="true" tabindex="-1"></a>      <span class="vs">`&lt;html&gt;&lt;body&gt;&lt;p&gt;&quot;</span><span class="sc">${</span>req<span class="op">.</span><span class="at">url</span><span class="sc">}</span><span class="vs">&quot; not found&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;`</span>)</span>
<span id="cb422-20"><a href="#cb422-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb422-21"><a href="#cb422-21" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb422-22"><a href="#cb422-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb422-23"><a href="#cb422-23" aria-hidden="true" tabindex="-1"></a>app<span class="op">.</span><span class="fu">listen</span>(PORT<span class="op">,</span> () <span class="kw">=&gt;</span> { <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="vs">`listening on port </span><span class="sc">${</span>PORT<span class="sc">}</span><span class="vs">...`</span>) })</span></code></pre></div>
<p>This simple server checks whether the path specified in the URL ends with <code>.js</code>. If so, it constructs something that looks like the name of a library by stripping off the <code>.js</code> and prefixing the stem with <code>./</code>, then uses <code>require</code> to load that file. Assuming the load is successful, it then calls the <code>page</code> function defined in that file. We can create a very simple plugin like this:</p>
<div class="sourceCode" id="cb423"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb423-1"><a href="#cb423-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">page</span>() {</span>
<span id="cb423-2"><a href="#cb423-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (<span class="st">&#39;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Plugin Content&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&#39;</span>)<span class="op">;</span></span>
<span id="cb423-3"><a href="#cb423-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb423-4"><a href="#cb423-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb423-5"><a href="#cb423-5" aria-hidden="true" tabindex="-1"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> {</span>
<span id="cb423-6"><a href="#cb423-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">page</span><span class="op">:</span> page</span>
<span id="cb423-7"><a href="#cb423-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>If we run the server:</p>
<pre class="shell"><code>$ node src/extensible/dynamic.js</code></pre>
<p>and then go to <code>http://localhost:4000/plugin.js</code>, we get back a page containing the title “Plugin Content”.</p>
<p>This is an example of a very powerful technique. Rather than building everything into one program, we can provide a set of rules that plugins must follow so that people can add new functionality without rewriting what’s already there. Each plugin must have an <a href="#g:entry-point"><strong>entry point</strong></a> like the function <code>page</code> so that the framework knows where to start.</p>
<h1 id="s:db">Using a Database</h1>
<p>Our data manager (Chapter <a href="#s:dataman" data-reference-type="ref" data-reference="s:dataman">11</a>) got information from a single CSV file. That’s fine for testing purposes, but real applications almost always use a database of some kind. There are many options these days for what kind, but <a href="#g:relational-database"><strong>relational databases</strong></a> continue to be the workhorses of the web.</p>
<p>Relational databases are manipulated using a language called <a href="#g:sql"><strong>SQL</strong></a>, which originally stood for “Structured Query Language” and is pronounced “sequel” or “ess cue ell” depending on whether the speaker is left or right handed. (Alternatives are collectively known as <a href="#g:nosql-database"><strong>NoSQL databases</strong></a>, and use many different storage models.) We will use a SQL database because it’s still the most common choice, but we won’t try to introduce SQL itself: for that, see <a href="https://swcarpentry.github.io/sql-novice-survey/">this short tutorial</a>.</p>
<p>As an example problem, we will store information about workshops. Our database begins with a single <a href="#g:table"><strong>table</strong></a> with three <a href="#g:field"><strong>fields</strong></a> and two <a href="#g:record"><strong>records</strong></a>:</p>
<div class="sourceCode" id="cb425"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb425-1"><a href="#cb425-1" aria-hidden="true" tabindex="-1"></a><span class="kw">drop</span> <span class="kw">table</span> <span class="cf">if</span> <span class="kw">exists</span> Workshop;</span>
<span id="cb425-2"><a href="#cb425-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb425-3"><a href="#cb425-3" aria-hidden="true" tabindex="-1"></a><span class="kw">create</span> <span class="kw">table</span> Workshop(</span>
<span id="cb425-4"><a href="#cb425-4" aria-hidden="true" tabindex="-1"></a>  ident         <span class="dt">integer</span> <span class="kw">unique</span> <span class="kw">not</span> <span class="kw">null</span> <span class="kw">primary</span> <span class="kw">key</span>,</span>
<span id="cb425-5"><a href="#cb425-5" aria-hidden="true" tabindex="-1"></a>  name          text <span class="kw">unique</span> <span class="kw">not</span> <span class="kw">null</span>,</span>
<span id="cb425-6"><a href="#cb425-6" aria-hidden="true" tabindex="-1"></a>  duration      <span class="dt">integer</span> <span class="kw">not</span> <span class="kw">null</span> <span class="co">-- duration in minutes</span></span>
<span id="cb425-7"><a href="#cb425-7" aria-hidden="true" tabindex="-1"></a>);</span>
<span id="cb425-8"><a href="#cb425-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb425-9"><a href="#cb425-9" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> <span class="kw">into</span> Workshop <span class="kw">values</span>(<span class="dv">1</span>, <span class="ot">&quot;Building Community&quot;</span>, <span class="dv">60</span>);</span>
<span id="cb425-10"><a href="#cb425-10" aria-hidden="true" tabindex="-1"></a><span class="kw">insert</span> <span class="kw">into</span> Workshop <span class="kw">values</span>(<span class="dv">2</span>, <span class="ot">&quot;ENIAC Programming&quot;</span>, <span class="dv">150</span>);</span></code></pre></div>
<p>In the rest of this tutorial, we will build a class to handle our interactions with a SQLite database, test it, and then put a web service on top of it.</p>
<h2 id="s:db-start">Starting Point</h2>
<p>Our class, imaginatively named <code>Database</code>, takes the path to the SQLite database file as a constructor parameter and creates a <a href="#g:connection-manager"><strong>connection manager</strong></a> through which we can send queries and get results. We will create one method for each query we want to run, and one helper method to display query results. We will give all of the query methods the same <a href="#g:signature"><strong>signature</strong></a> so that can be handled interchangeably. The whole thing looks like this:</p>
<div class="sourceCode" id="cb426"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb426-1"><a href="#cb426-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> sqlite3 <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;sqlite3&#39;</span>)</span>
<span id="cb426-2"><a href="#cb426-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb426-3"><a href="#cb426-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Database {</span>
<span id="cb426-4"><a href="#cb426-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb426-5"><a href="#cb426-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span> (path) {</span>
<span id="cb426-6"><a href="#cb426-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">db</span> <span class="op">=</span> <span class="kw">new</span> sqlite3<span class="op">.</span><span class="fu">Database</span>(path<span class="op">,</span> sqlite3<span class="op">.</span><span class="at">OPEN_READWRITE</span><span class="op">,</span> (err) <span class="kw">=&gt;</span> {</span>
<span id="cb426-7"><a href="#cb426-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (err) <span class="kw">this</span><span class="op">.</span><span class="fu">fail</span>(<span class="vs">`Database open error </span><span class="sc">${</span>err<span class="sc">}</span><span class="vs"> for &quot;</span><span class="sc">${</span>path<span class="sc">}</span><span class="vs">&quot;`</span>)</span>
<span id="cb426-8"><a href="#cb426-8" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb426-9"><a href="#cb426-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb426-10"><a href="#cb426-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb426-11"><a href="#cb426-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getAll</span> (args) {</span>
<span id="cb426-12"><a href="#cb426-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">all</span>(Q_WORKSHOP_GET_ALL<span class="op">,</span> []<span class="op">,</span> (err<span class="op">,</span> rows) <span class="kw">=&gt;</span> {</span>
<span id="cb426-13"><a href="#cb426-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (err) <span class="kw">this</span><span class="op">.</span><span class="fu">fail</span>(err)</span>
<span id="cb426-14"><a href="#cb426-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">display</span>(rows)</span>
<span id="cb426-15"><a href="#cb426-15" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb426-16"><a href="#cb426-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb426-17"><a href="#cb426-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb426-18"><a href="#cb426-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getOne</span> (args) {</span>
<span id="cb426-19"><a href="#cb426-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">all</span>(Q_WORKSHOP_GET_ONE<span class="op">,</span> args<span class="op">,</span> (err<span class="op">,</span> rows) <span class="kw">=&gt;</span> {</span>
<span id="cb426-20"><a href="#cb426-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (err) <span class="kw">this</span><span class="op">.</span><span class="fu">fail</span>(err)</span>
<span id="cb426-21"><a href="#cb426-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">display</span>(rows)</span>
<span id="cb426-22"><a href="#cb426-22" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb426-23"><a href="#cb426-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb426-24"><a href="#cb426-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb426-25"><a href="#cb426-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">display</span> (rows) {</span>
<span id="cb426-26"><a href="#cb426-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> r <span class="kw">of</span> rows) {</span>
<span id="cb426-27"><a href="#cb426-27" aria-hidden="true" tabindex="-1"></a>      <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(r)</span>
<span id="cb426-28"><a href="#cb426-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb426-29"><a href="#cb426-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb426-30"><a href="#cb426-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb426-31"><a href="#cb426-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fail</span> (msg) {</span>
<span id="cb426-32"><a href="#cb426-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(msg)</span>
<span id="cb426-33"><a href="#cb426-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">process</span><span class="op">.</span><span class="fu">exit</span>(<span class="dv">1</span>)</span>
<span id="cb426-34"><a href="#cb426-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb426-35"><a href="#cb426-35" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This makes a lot more sense once we see what the queries look like:</p>
<div class="sourceCode" id="cb427"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb427-1"><a href="#cb427-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> Q_WORKSHOP_GET_ALL <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb427-2"><a href="#cb427-2" aria-hidden="true" tabindex="-1"></a><span class="vs">select</span></span>
<span id="cb427-3"><a href="#cb427-3" aria-hidden="true" tabindex="-1"></a><span class="vs">  Workshop.ident        as workshopId,</span></span>
<span id="cb427-4"><a href="#cb427-4" aria-hidden="true" tabindex="-1"></a><span class="vs">  Workshop.name         as workshopName,</span></span>
<span id="cb427-5"><a href="#cb427-5" aria-hidden="true" tabindex="-1"></a><span class="vs">  Workshop.duration     as workshopDuration</span></span>
<span id="cb427-6"><a href="#cb427-6" aria-hidden="true" tabindex="-1"></a><span class="vs">from</span></span>
<span id="cb427-7"><a href="#cb427-7" aria-hidden="true" tabindex="-1"></a><span class="vs">  Workshop</span></span>
<span id="cb427-8"><a href="#cb427-8" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span></span>
<span id="cb427-9"><a href="#cb427-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb427-10"><a href="#cb427-10" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> Q_WORKSHOP_GET_ONE <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb427-11"><a href="#cb427-11" aria-hidden="true" tabindex="-1"></a><span class="vs">select</span></span>
<span id="cb427-12"><a href="#cb427-12" aria-hidden="true" tabindex="-1"></a><span class="vs">  Workshop.ident        as workshopId,</span></span>
<span id="cb427-13"><a href="#cb427-13" aria-hidden="true" tabindex="-1"></a><span class="vs">  Workshop.name         as workshopName,</span></span>
<span id="cb427-14"><a href="#cb427-14" aria-hidden="true" tabindex="-1"></a><span class="vs">  Workshop.duration     as workshopDuration</span></span>
<span id="cb427-15"><a href="#cb427-15" aria-hidden="true" tabindex="-1"></a><span class="vs">from</span></span>
<span id="cb427-16"><a href="#cb427-16" aria-hidden="true" tabindex="-1"></a><span class="vs">  Workshop</span></span>
<span id="cb427-17"><a href="#cb427-17" aria-hidden="true" tabindex="-1"></a><span class="vs">where</span></span>
<span id="cb427-18"><a href="#cb427-18" aria-hidden="true" tabindex="-1"></a><span class="vs">  Workshop.ident = ?</span></span>
<span id="cb427-19"><a href="#cb427-19" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span></span></code></pre></div>
<p>It’s easy to overlook, but the query to get details of one workshop has a question mark <code>?</code> as the value of <code>Workshop.ident</code>. This means that the query expects us to provide a parameter when we call it that will be substituted in for the question mark to specify which workshop we’re interested in. This is why the arguments passed to <code>getOne</code> as <code>args</code> are then passed through to <code>db.all</code>; it’s also why <code>getAll</code> takes an <code>args</code> parameter, but ignores it and always passed <code>[]</code> (no extra values) to <code>db.all</code> when running the query.</p>
<p>All right: what does the <a href="#g:driver"><strong>driver</strong></a> look like?</p>
<div class="sourceCode" id="cb428"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb428-1"><a href="#cb428-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">main</span> () {</span>
<span id="cb428-2"><a href="#cb428-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> path <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">argv</span>[<span class="dv">2</span>]</span>
<span id="cb428-3"><a href="#cb428-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> action <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">argv</span>[<span class="dv">3</span>]</span>
<span id="cb428-4"><a href="#cb428-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> args <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">argv</span><span class="op">.</span><span class="fu">splice</span>(<span class="dv">4</span>)</span>
<span id="cb428-5"><a href="#cb428-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> database <span class="op">=</span> <span class="kw">new</span> <span class="fu">Database</span>(path)</span>
<span id="cb428-6"><a href="#cb428-6" aria-hidden="true" tabindex="-1"></a>  database[action](args)</span>
<span id="cb428-7"><a href="#cb428-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb428-8"><a href="#cb428-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb428-9"><a href="#cb428-9" aria-hidden="true" tabindex="-1"></a><span class="fu">main</span>()</span></code></pre></div>
<p>This is simple enough: it gets the path to the database file, the desired action, and any extra arguments from <code>process.argv</code>, then creates an instance of the <code>Database</code> class and—um. And then it calls <code>database[action](args)</code>, which takes a moment to figure out. What’s going on here is that an instance of a class is just a special kind of object, and we can always look up an object’s fields by name using <code>object[name]</code>, so if the string <code>action</code> (taken from the command-line argument) is <code>getAll</code> or <code>getOne</code>, then <code>database[action](args)</code> is either <code>database.getAll(args)</code> or <code>database.getOne(args)</code>. This is clever, but if we ask for an action like <code>show</code> or <code>help</code> or <code>GetOne</code> (with an upper-case ’G’) then <code>database[action]</code> doesn’t exist and we get a very confusing error message. We really should try to do better<span>…</span></p>
<p>But before then, let’s try running this:</p>
<pre class="shell"><code>$ node database-initial.js fixture.db getAll</code></pre>
<pre class="text"><code>{ workshopId: 1,
  workshopName: &#39;Building Community&#39;,
  workshopDuration: 60 }
{ workshopId: 2,
  workshopName: &#39;ENIAC Programming&#39;,
  workshopDuration: 150 }</code></pre>
<p>That seems to have worked: <code>getAll</code> was called, and the result is an array of objects, one per record, whose names are derived in an obvious way from the names of the columns.</p>
<h2 id="s:db-in-memory">In-Memory Database</h2>
<p>The previous example always manipulates database on disk. For testing purposes, it’s faster and safer to use an <a href="#g:in-memory-database"><strong>in-memory database</strong></a>. Let’s modify the constructor of <code>Database</code> to set this up:</p>
<div class="sourceCode" id="cb431"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb431-1"><a href="#cb431-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span> (mode<span class="op">,</span> path) {</span>
<span id="cb431-2"><a href="#cb431-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">path</span> <span class="op">=</span> path</span>
<span id="cb431-3"><a href="#cb431-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (mode) {</span>
<span id="cb431-4"><a href="#cb431-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;memory&#39;</span> <span class="op">:</span></span>
<span id="cb431-5"><a href="#cb431-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> setup <span class="op">=</span> fs<span class="op">.</span><span class="fu">readFileSync</span>(<span class="kw">this</span><span class="op">.</span><span class="at">path</span><span class="op">,</span> <span class="st">&#39;utf-8&#39;</span>)</span>
<span id="cb431-6"><a href="#cb431-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">db</span> <span class="op">=</span> <span class="kw">new</span> sqlite3<span class="op">.</span><span class="fu">Database</span>(<span class="st">&#39;:memory:&#39;</span><span class="op">,</span> sqlite3<span class="op">.</span><span class="at">OPEN_READWRITE</span><span class="op">,</span></span>
<span id="cb431-7"><a href="#cb431-7" aria-hidden="true" tabindex="-1"></a>        (err) <span class="kw">=&gt;</span> {</span>
<span id="cb431-8"><a href="#cb431-8" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (err) {</span>
<span id="cb431-9"><a href="#cb431-9" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="fu">fail</span>(<span class="vs">`In-memory database open error &quot;</span><span class="sc">${</span>err<span class="sc">}</span><span class="vs">&quot;`</span>)</span>
<span id="cb431-10"><a href="#cb431-10" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb431-11"><a href="#cb431-11" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb431-12"><a href="#cb431-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">exec</span>(setup<span class="op">,</span>(err) <span class="kw">=&gt;</span> {</span>
<span id="cb431-13"><a href="#cb431-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (err) {</span>
<span id="cb431-14"><a href="#cb431-14" aria-hidden="true" tabindex="-1"></a>          <span class="kw">this</span><span class="op">.</span><span class="fu">fail</span>(<span class="vs">`Cannot initialize in-memory database from &quot;</span><span class="sc">${</span><span class="kw">this</span><span class="op">.</span><span class="at">path</span><span class="sc">}</span><span class="vs">&quot;`</span>)</span>
<span id="cb431-15"><a href="#cb431-15" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb431-16"><a href="#cb431-16" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb431-17"><a href="#cb431-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span></span>
<span id="cb431-18"><a href="#cb431-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb431-19"><a href="#cb431-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="st">&#39;file&#39;</span> <span class="op">:</span></span>
<span id="cb431-20"><a href="#cb431-20" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">db</span> <span class="op">=</span> <span class="kw">new</span> sqlite3<span class="op">.</span><span class="fu">Database</span>(<span class="kw">this</span><span class="op">.</span><span class="at">path</span><span class="op">,</span> sqlite3<span class="op">.</span><span class="at">OPEN_READWRITE</span><span class="op">,</span></span>
<span id="cb431-21"><a href="#cb431-21" aria-hidden="true" tabindex="-1"></a>        (err) <span class="kw">=&gt;</span> {</span>
<span id="cb431-22"><a href="#cb431-22" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (err) {</span>
<span id="cb431-23"><a href="#cb431-23" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="fu">fail</span>(<span class="vs">`Database open error </span><span class="sc">${</span>err<span class="sc">}</span><span class="vs"> for &quot;</span><span class="sc">${</span>path<span class="sc">}</span><span class="vs">&quot;`</span>)</span>
<span id="cb431-24"><a href="#cb431-24" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb431-25"><a href="#cb431-25" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb431-26"><a href="#cb431-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span></span>
<span id="cb431-27"><a href="#cb431-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb431-28"><a href="#cb431-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">default</span> <span class="op">:</span></span>
<span id="cb431-29"><a href="#cb431-29" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="fu">fail</span>(<span class="vs">`Unknown mode &quot;</span><span class="sc">${</span>mode<span class="sc">}</span><span class="vs">&quot;`</span>)</span>
<span id="cb431-30"><a href="#cb431-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span></span>
<span id="cb431-31"><a href="#cb431-31" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb431-32"><a href="#cb431-32" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>If the <code>mode</code> parameter is the string <code>"memory"</code>, we create an in-memory database and initialize it by executing a file full of setup commands specified by the user—in our case, exactly the commands we showed at the start of the lesson. If the <code>mode</code> is <code>"file"</code>, we interpret the file argument as the name of an on-disk database and proceed as before.</p>
<p>We put our error messages in ALL CAPS because that’s the most annoying option easily available to us. Less annoyingly, we can use destructuring to handle command-line arguments in the driver:</p>
<div class="sourceCode" id="cb432"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb432-1"><a href="#cb432-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">main</span> () {</span>
<span id="cb432-2"><a href="#cb432-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> [mode<span class="op">,</span> path<span class="op">,</span> action<span class="op">,</span> <span class="op">...</span>args] <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">argv</span><span class="op">.</span><span class="fu">splice</span>(<span class="dv">2</span>)</span>
<span id="cb432-3"><a href="#cb432-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> database <span class="op">=</span> <span class="kw">new</span> <span class="fu">Database</span>(mode<span class="op">,</span> path)</span>
<span id="cb432-4"><a href="#cb432-4" aria-hidden="true" tabindex="-1"></a>  database[action](args)</span>
<span id="cb432-5"><a href="#cb432-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Here, the expression <code>...args</code> means “take anything left over after the fixed names have been matched and put it in an array called <code>args</code>”. With these changes in place, we can run a query to get details of the second workshop like this:</p>
<pre class="shell"><code>$ node database-mode.js memory fixture.sql getOne 2</code></pre>
<pre class="text"><code>{ workshopId: 2,
  workshopName: &#39;ENIAC Programming&#39;,
  workshopDuration: 150 }</code></pre>
<p>After a bit of experimentation, we decide to take this even further to make testing easier. We will allow the driver to read the SQL script itself and pass that into <code>Database</code> so that we can do the file I/O once and then repeatedly build a database in memory for testing. That way, each of our tests will start with the database in a known, predictable state, regardless of what other tests may have run before and what changes they might have made to the database. Here are the changes to the constructor:</p>
<div class="sourceCode" id="cb435"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb435-1"><a href="#cb435-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span> (mode<span class="op">,</span> arg) {</span>
<span id="cb435-2"><a href="#cb435-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> (mode) {</span>
<span id="cb435-3"><a href="#cb435-3" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;direct&#39;</span> <span class="op">:</span></span>
<span id="cb435-4"><a href="#cb435-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">_inMemory</span>(arg)</span>
<span id="cb435-5"><a href="#cb435-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb435-6"><a href="#cb435-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-7"><a href="#cb435-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;memory&#39;</span> <span class="op">:</span></span>
<span id="cb435-8"><a href="#cb435-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> setup <span class="op">=</span> fs<span class="op">.</span><span class="fu">readFileSync</span>(arg<span class="op">,</span> <span class="st">&#39;utf-8&#39;</span>)</span>
<span id="cb435-9"><a href="#cb435-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">_inMemory</span>(setup)</span>
<span id="cb435-10"><a href="#cb435-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb435-11"><a href="#cb435-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-12"><a href="#cb435-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> <span class="st">&#39;file&#39;</span> <span class="op">:</span></span>
<span id="cb435-13"><a href="#cb435-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">_inFile</span>(arg)</span>
<span id="cb435-14"><a href="#cb435-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb435-15"><a href="#cb435-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb435-16"><a href="#cb435-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">default</span> <span class="op">:</span></span>
<span id="cb435-17"><a href="#cb435-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">this</span><span class="op">.</span><span class="fu">fail</span>(<span class="vs">`Unknown mode &quot;</span><span class="sc">${</span>mode<span class="sc">}</span><span class="vs">&quot;`</span>)</span>
<span id="cb435-18"><a href="#cb435-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb435-19"><a href="#cb435-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb435-20"><a href="#cb435-20" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>And here are the supporting methods:</p>
<div class="sourceCode" id="cb436"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb436-1"><a href="#cb436-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">_inMemory</span> (script) {</span>
<span id="cb436-2"><a href="#cb436-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">db</span> <span class="op">=</span> <span class="kw">new</span> sqlite3<span class="op">.</span><span class="fu">Database</span>(<span class="st">&#39;:memory:&#39;</span><span class="op">,</span> sqlite3<span class="op">.</span><span class="at">OPEN_READWRITE</span><span class="op">,</span></span>
<span id="cb436-3"><a href="#cb436-3" aria-hidden="true" tabindex="-1"></a>      (err) <span class="kw">=&gt;</span> {</span>
<span id="cb436-4"><a href="#cb436-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (err) {</span>
<span id="cb436-5"><a href="#cb436-5" aria-hidden="true" tabindex="-1"></a>          <span class="kw">this</span><span class="op">.</span><span class="fu">fail</span>(<span class="vs">`In-memory database open error &quot;</span><span class="sc">${</span>err<span class="sc">}</span><span class="vs">&quot;`</span>)</span>
<span id="cb436-6"><a href="#cb436-6" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb436-7"><a href="#cb436-7" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb436-8"><a href="#cb436-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">exec</span>(script<span class="op">,</span></span>
<span id="cb436-9"><a href="#cb436-9" aria-hidden="true" tabindex="-1"></a>      (err) <span class="kw">=&gt;</span> {</span>
<span id="cb436-10"><a href="#cb436-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (err) {</span>
<span id="cb436-11"><a href="#cb436-11" aria-hidden="true" tabindex="-1"></a>          <span class="kw">this</span><span class="op">.</span><span class="fu">fail</span>(<span class="vs">`Unable to initialize in-memory database from &quot;</span><span class="sc">${</span>script<span class="sc">}</span><span class="vs">&quot;`</span>)</span>
<span id="cb436-12"><a href="#cb436-12" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb436-13"><a href="#cb436-13" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb436-14"><a href="#cb436-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb436-15"><a href="#cb436-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb436-16"><a href="#cb436-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">_inFile</span> (path) {</span>
<span id="cb436-17"><a href="#cb436-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">db</span> <span class="op">=</span> <span class="kw">new</span> sqlite3<span class="op">.</span><span class="fu">Database</span>(path<span class="op">,</span> sqlite3<span class="op">.</span><span class="at">OPEN_READWRITE</span><span class="op">,</span> (err) <span class="kw">=&gt;</span> {</span>
<span id="cb436-18"><a href="#cb436-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (err) <span class="kw">this</span><span class="op">.</span><span class="fu">fail</span>(<span class="vs">`Database open error &quot;</span><span class="sc">${</span>err<span class="sc">}</span><span class="vs">&quot; for &quot;</span><span class="sc">${</span>path<span class="sc">}</span><span class="vs">&quot;`</span>)</span>
<span id="cb436-19"><a href="#cb436-19" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb436-20"><a href="#cb436-20" aria-hidden="true" tabindex="-1"></a>  }</span></code></pre></div>
<p>We also need to change the driver (and check, finally, that the requested action is actually supported):</p>
<div class="sourceCode" id="cb437"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb437-1"><a href="#cb437-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">main</span> () {</span>
<span id="cb437-2"><a href="#cb437-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> [mode<span class="op">,</span> setup<span class="op">,</span> action<span class="op">,</span> <span class="op">...</span>args] <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">argv</span><span class="op">.</span><span class="fu">splice</span>(<span class="dv">2</span>)</span>
<span id="cb437-3"><a href="#cb437-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (mode <span class="op">===</span> <span class="st">&#39;direct&#39;</span>) {</span>
<span id="cb437-4"><a href="#cb437-4" aria-hidden="true" tabindex="-1"></a>    setup <span class="op">=</span> fs<span class="op">.</span><span class="fu">readFileSync</span>(setup<span class="op">,</span> <span class="st">&#39;utf-8&#39;</span>)</span>
<span id="cb437-5"><a href="#cb437-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb437-6"><a href="#cb437-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> database <span class="op">=</span> <span class="kw">new</span> <span class="fu">Database</span>(mode<span class="op">,</span> setup)</span>
<span id="cb437-7"><a href="#cb437-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>(action <span class="kw">in</span> database)) {</span>
<span id="cb437-8"><a href="#cb437-8" aria-hidden="true" tabindex="-1"></a>    database<span class="op">.</span><span class="fu">fail</span>(<span class="vs">`No such operation &quot;</span><span class="sc">${</span>action<span class="sc">}</span><span class="vs">&quot;`</span>)</span>
<span id="cb437-9"><a href="#cb437-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb437-10"><a href="#cb437-10" aria-hidden="true" tabindex="-1"></a>  database[action](args)</span>
<span id="cb437-11"><a href="#cb437-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 id="s:db-testable">Making It Testable</h2>
<p>We put the database class and its driver in separate files so that applications can load just the former. We will now change the database query methods to return results for display rather than displaying them directly, since we will eventually want to compare them or return them to a server rather than printing them:</p>
<div class="sourceCode" id="cb438"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb438-1"><a href="#cb438-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Database {</span>
<span id="cb438-2"><a href="#cb438-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb438-3"><a href="#cb438-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...as before...</span></span>
<span id="cb438-4"><a href="#cb438-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb438-5"><a href="#cb438-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getAll</span> (args) {</span>
<span id="cb438-6"><a href="#cb438-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">all</span>(Q_WORKSHOP_GET_ALL<span class="op">,</span> []<span class="op">,</span> (err<span class="op">,</span> rows) <span class="kw">=&gt;</span> {</span>
<span id="cb438-7"><a href="#cb438-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (err) <span class="kw">this</span><span class="op">.</span><span class="fu">fail</span>(err)</span>
<span id="cb438-8"><a href="#cb438-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> rows</span>
<span id="cb438-9"><a href="#cb438-9" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb438-10"><a href="#cb438-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb438-11"><a href="#cb438-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb438-12"><a href="#cb438-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...as before...</span></span>
<span id="cb438-13"><a href="#cb438-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The driver then looks like this:</p>
<div class="sourceCode" id="cb439"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb439-1"><a href="#cb439-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> Database <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;./separate-database&#39;</span>)</span>
<span id="cb439-2"><a href="#cb439-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb439-3"><a href="#cb439-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> display <span class="op">=</span> (rows) <span class="kw">=&gt;</span> {</span>
<span id="cb439-4"><a href="#cb439-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> r <span class="kw">of</span> rows) {</span>
<span id="cb439-5"><a href="#cb439-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(r)</span>
<span id="cb439-6"><a href="#cb439-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb439-7"><a href="#cb439-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb439-8"><a href="#cb439-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb439-9"><a href="#cb439-9" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> main <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb439-10"><a href="#cb439-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> [mode<span class="op">,</span> path<span class="op">,</span> action<span class="op">,</span> <span class="op">...</span>args] <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">argv</span><span class="op">.</span><span class="fu">splice</span>(<span class="dv">2</span>)</span>
<span id="cb439-11"><a href="#cb439-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> db <span class="op">=</span> <span class="kw">new</span> <span class="fu">Database</span>(mode<span class="op">,</span> path)</span>
<span id="cb439-12"><a href="#cb439-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>(action <span class="kw">in</span> db)) {</span>
<span id="cb439-13"><a href="#cb439-13" aria-hidden="true" tabindex="-1"></a>    db<span class="op">.</span><span class="fu">fail</span>(<span class="vs">`No such operation &quot;</span><span class="sc">${</span>action<span class="sc">}</span><span class="vs">&quot;`</span>)</span>
<span id="cb439-14"><a href="#cb439-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb439-15"><a href="#cb439-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> result <span class="op">=</span> db[action](args)</span>
<span id="cb439-16"><a href="#cb439-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">display</span>(result)</span>
<span id="cb439-17"><a href="#cb439-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb439-18"><a href="#cb439-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb439-19"><a href="#cb439-19" aria-hidden="true" tabindex="-1"></a><span class="fu">main</span>()</span></code></pre></div>
<p>Let’s try running it:</p>
<pre class="shell"><code>$ node separate-driver.js file fixture.db getAll</code></pre>
<pre class="text"><code>  for (let r of rows) {
              ^

TypeError: Cannot read property &#39;Symbol(Symbol.iterator)&#39; of undefined
    at display (/project/src/db/separate-driver.js:4:15)
    at main (/project/src/db/separate-driver.js:16:3)</code></pre>
<p>Whoops: the <code>run</code> method of the database delivers results to a callback; its own result is therefore <code>undefined</code>, so there’s nothing in the caller to print. The solution is to give the <code>get</code> methods a callback of their own:</p>
<div class="sourceCode" id="cb442"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb442-1"><a href="#cb442-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Database {</span>
<span id="cb442-2"><a href="#cb442-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb442-3"><a href="#cb442-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...as before...</span></span>
<span id="cb442-4"><a href="#cb442-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb442-5"><a href="#cb442-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getAll</span> (args<span class="op">,</span> callback) {</span>
<span id="cb442-6"><a href="#cb442-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">all</span>(Q_WORKSHOP_GET_ALL<span class="op">,</span> []<span class="op">,</span> (err<span class="op">,</span> rows) <span class="kw">=&gt;</span> {</span>
<span id="cb442-7"><a href="#cb442-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (err) <span class="kw">this</span><span class="op">.</span><span class="fu">fail</span>(err)</span>
<span id="cb442-8"><a href="#cb442-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">callback</span>(rows)</span>
<span id="cb442-9"><a href="#cb442-9" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb442-10"><a href="#cb442-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb442-11"><a href="#cb442-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb442-12"><a href="#cb442-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...as before...</span></span>
<span id="cb442-13"><a href="#cb442-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We then change the driver to pass <code>display</code> to the database method it’s calling:</p>
<div class="sourceCode" id="cb443"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb443-1"><a href="#cb443-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> Database <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;./callback-database&#39;</span>)</span>
<span id="cb443-2"><a href="#cb443-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb443-3"><a href="#cb443-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> display <span class="op">=</span> (rows) <span class="kw">=&gt;</span> {</span>
<span id="cb443-4"><a href="#cb443-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> r <span class="kw">of</span> rows) {</span>
<span id="cb443-5"><a href="#cb443-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(r)</span>
<span id="cb443-6"><a href="#cb443-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb443-7"><a href="#cb443-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb443-8"><a href="#cb443-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb443-9"><a href="#cb443-9" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> main <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb443-10"><a href="#cb443-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> [mode<span class="op">,</span> path<span class="op">,</span> action<span class="op">,</span> <span class="op">...</span>args] <span class="op">=</span> <span class="bu">process</span><span class="op">.</span><span class="at">argv</span><span class="op">.</span><span class="fu">splice</span>(<span class="dv">2</span>)</span>
<span id="cb443-11"><a href="#cb443-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> db <span class="op">=</span> <span class="kw">new</span> <span class="fu">Database</span>(mode<span class="op">,</span> path)</span>
<span id="cb443-12"><a href="#cb443-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="op">!</span>(action <span class="kw">in</span> db)) {</span>
<span id="cb443-13"><a href="#cb443-13" aria-hidden="true" tabindex="-1"></a>    db<span class="op">.</span><span class="fu">fail</span>(<span class="vs">`No such operation &quot;</span><span class="sc">${</span>action<span class="sc">}</span><span class="vs">&quot;`</span>)</span>
<span id="cb443-14"><a href="#cb443-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb443-15"><a href="#cb443-15" aria-hidden="true" tabindex="-1"></a>  db[action](args<span class="op">,</span> display)</span>
<span id="cb443-16"><a href="#cb443-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb443-17"><a href="#cb443-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb443-18"><a href="#cb443-18" aria-hidden="true" tabindex="-1"></a><span class="fu">main</span>()</span></code></pre></div>
<p>This looks strange the first few (dozen) times, but it’s the way JavaScript works: instead of asking for something and then operating on it, we say, “Here’s what we want to do once results are available.”</p>
<h2 id="s:db-testing">Testing</h2>
<p>We can finally write some tests:</p>
<div class="sourceCode" id="cb444"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb444-1"><a href="#cb444-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> assert <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;assert&#39;</span>)</span>
<span id="cb444-2"><a href="#cb444-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> Database <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;./callback-database&#39;</span>)</span>
<span id="cb444-3"><a href="#cb444-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb444-4"><a href="#cb444-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> FIXTURE <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb444-5"><a href="#cb444-5" aria-hidden="true" tabindex="-1"></a><span class="vs">drop table if exists Workshop;</span></span>
<span id="cb444-6"><a href="#cb444-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb444-7"><a href="#cb444-7" aria-hidden="true" tabindex="-1"></a><span class="vs">create table Workshop(</span></span>
<span id="cb444-8"><a href="#cb444-8" aria-hidden="true" tabindex="-1"></a><span class="vs">  ident           integer unique not null primary key,</span></span>
<span id="cb444-9"><a href="#cb444-9" aria-hidden="true" tabindex="-1"></a><span class="vs">  name            text unique not null,</span></span>
<span id="cb444-10"><a href="#cb444-10" aria-hidden="true" tabindex="-1"></a><span class="vs">  duration        integer not null -- duration in minutes</span></span>
<span id="cb444-11"><a href="#cb444-11" aria-hidden="true" tabindex="-1"></a><span class="vs">);</span></span>
<span id="cb444-12"><a href="#cb444-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb444-13"><a href="#cb444-13" aria-hidden="true" tabindex="-1"></a><span class="vs">insert into Workshop values(1, &quot;Building Community&quot;, 60);</span></span>
<span id="cb444-14"><a href="#cb444-14" aria-hidden="true" tabindex="-1"></a><span class="vs">insert into Workshop values(2, &quot;ENIAC Programming&quot;, 150);</span></span>
<span id="cb444-15"><a href="#cb444-15" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span></span>
<span id="cb444-16"><a href="#cb444-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb444-17"><a href="#cb444-17" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;database&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb444-18"><a href="#cb444-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb444-19"><a href="#cb444-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should return all workshops&#39;</span><span class="op">,</span> (done) <span class="kw">=&gt;</span> {</span>
<span id="cb444-20"><a href="#cb444-20" aria-hidden="true" tabindex="-1"></a>    expected <span class="op">=</span> [</span>
<span id="cb444-21"><a href="#cb444-21" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">workshopName</span><span class="op">:</span> <span class="st">&#39;Building Community&#39;</span><span class="op">,</span></span>
<span id="cb444-22"><a href="#cb444-22" aria-hidden="true" tabindex="-1"></a>        <span class="dt">workshopDuration</span><span class="op">:</span> <span class="dv">60</span><span class="op">,</span> <span class="dt">workshopId</span><span class="op">:</span> <span class="dv">1</span> }<span class="op">,</span></span>
<span id="cb444-23"><a href="#cb444-23" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">workshopName</span><span class="op">:</span> <span class="st">&#39;ENIAC Programming&#39;</span><span class="op">,</span></span>
<span id="cb444-24"><a href="#cb444-24" aria-hidden="true" tabindex="-1"></a>        <span class="dt">workshopDuration</span><span class="op">:</span> <span class="dv">150</span><span class="op">,</span> <span class="dt">workshopId</span><span class="op">:</span> <span class="dv">2</span> }</span>
<span id="cb444-25"><a href="#cb444-25" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb444-26"><a href="#cb444-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="fu">Database</span>(<span class="st">&#39;direct&#39;</span><span class="op">,</span> FIXTURE)<span class="op">.</span><span class="fu">getAll</span>([]<span class="op">,</span> (results) <span class="kw">=&gt;</span> {</span>
<span id="cb444-27"><a href="#cb444-27" aria-hidden="true" tabindex="-1"></a>      assert<span class="op">.</span><span class="fu">deepEqual</span>(results<span class="op">,</span> expected<span class="op">,</span></span>
<span id="cb444-28"><a href="#cb444-28" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;Got expected workshops&#39;</span>)</span>
<span id="cb444-29"><a href="#cb444-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">done</span>()</span>
<span id="cb444-30"><a href="#cb444-30" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb444-31"><a href="#cb444-31" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb444-32"><a href="#cb444-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb444-33"><a href="#cb444-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should return one workshop&#39;</span><span class="op">,</span> (done) <span class="kw">=&gt;</span> {</span>
<span id="cb444-34"><a href="#cb444-34" aria-hidden="true" tabindex="-1"></a>    expected <span class="op">=</span> [</span>
<span id="cb444-35"><a href="#cb444-35" aria-hidden="true" tabindex="-1"></a>      { <span class="dt">workshopName</span><span class="op">:</span> <span class="st">&#39;Building Community&#39;</span><span class="op">,</span></span>
<span id="cb444-36"><a href="#cb444-36" aria-hidden="true" tabindex="-1"></a>        <span class="dt">workshopDuration</span><span class="op">:</span> <span class="dv">60</span><span class="op">,</span> <span class="dt">workshopId</span><span class="op">:</span> <span class="dv">1</span> }</span>
<span id="cb444-37"><a href="#cb444-37" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb444-38"><a href="#cb444-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="fu">Database</span>(<span class="st">&#39;direct&#39;</span><span class="op">,</span> FIXTURE)<span class="op">.</span><span class="fu">getOne</span>(<span class="dv">1</span><span class="op">,</span> (results) <span class="kw">=&gt;</span> {</span>
<span id="cb444-39"><a href="#cb444-39" aria-hidden="true" tabindex="-1"></a>      assert<span class="op">.</span><span class="fu">deepEqual</span>(results<span class="op">,</span> expected<span class="op">,</span></span>
<span id="cb444-40"><a href="#cb444-40" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;Got single expected workshop&#39;</span>)</span>
<span id="cb444-41"><a href="#cb444-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">done</span>()</span>
<span id="cb444-42"><a href="#cb444-42" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb444-43"><a href="#cb444-43" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb444-44"><a href="#cb444-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb444-45"><a href="#cb444-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;can only get workshops that exist&#39;</span><span class="op">,</span> (done) <span class="kw">=&gt;</span> {</span>
<span id="cb444-46"><a href="#cb444-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">new</span> <span class="fu">Database</span>(<span class="st">&#39;direct&#39;</span><span class="op">,</span> FIXTURE)<span class="op">.</span><span class="fu">getOne</span>(<span class="dv">99</span><span class="op">,</span> (results) <span class="kw">=&gt;</span> {</span>
<span id="cb444-47"><a href="#cb444-47" aria-hidden="true" tabindex="-1"></a>      assert<span class="op">.</span><span class="fu">deepEqual</span>(results<span class="op">,</span> []<span class="op">,</span></span>
<span id="cb444-48"><a href="#cb444-48" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&#39;Got no workshops matching nonexistent key&#39;</span>)</span>
<span id="cb444-49"><a href="#cb444-49" aria-hidden="true" tabindex="-1"></a>      <span class="fu">done</span>()</span>
<span id="cb444-50"><a href="#cb444-50" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb444-51"><a href="#cb444-51" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb444-52"><a href="#cb444-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb444-53"><a href="#cb444-53" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p>Each test has the same structure: we define the expected result, create an entirely new database in memory, and then call the method being tested, passing it the fixture and the callback that will receive results. That callback uses <code>assert</code> to check results and <code>done</code> to signal that the test has completed.</p>
<h2 id="s:db-mutate">Updating the Database</h2>
<p>The data manager we built in Chapter <a href="#s:dataman" data-reference-type="ref" data-reference="s:dataman">11</a> only let us read data; we couldn’t modify it. Let’s add a bit more to our database class to support <a href="#g:mutation"><strong>mutation</strong></a>:</p>
<div class="sourceCode" id="cb445"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb445-1"><a href="#cb445-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ...imports as before...</span></span>
<span id="cb445-2"><a href="#cb445-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb445-3"><a href="#cb445-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> Q_WORKSHOP_GET_ALL <span class="op">=</span> <span class="co">// ...as before...</span></span>
<span id="cb445-4"><a href="#cb445-4" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> Q_WORKSHOP_GET_ONE <span class="op">=</span> <span class="co">// ...as before...</span></span>
<span id="cb445-5"><a href="#cb445-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb445-6"><a href="#cb445-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> Q_WORKSHOP_ADD <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb445-7"><a href="#cb445-7" aria-hidden="true" tabindex="-1"></a><span class="vs">insert into Workshop(name, duration) values(?, ?);</span></span>
<span id="cb445-8"><a href="#cb445-8" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span></span>
<span id="cb445-9"><a href="#cb445-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb445-10"><a href="#cb445-10" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> Q_WORKSHOP_DELETE <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb445-11"><a href="#cb445-11" aria-hidden="true" tabindex="-1"></a><span class="vs">delete from Workshop where ident = ?;</span></span>
<span id="cb445-12"><a href="#cb445-12" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span></span>
<span id="cb445-13"><a href="#cb445-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb445-14"><a href="#cb445-14" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Database {</span>
<span id="cb445-15"><a href="#cb445-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb445-16"><a href="#cb445-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">constructor</span> (mode<span class="op">,</span> arg) {</span>
<span id="cb445-17"><a href="#cb445-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...as before...</span></span>
<span id="cb445-18"><a href="#cb445-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb445-19"><a href="#cb445-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getAll</span> (args<span class="op">,</span> callback) {</span>
<span id="cb445-20"><a href="#cb445-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...as before...</span></span>
<span id="cb445-21"><a href="#cb445-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb445-22"><a href="#cb445-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getOne</span> (args<span class="op">,</span> callback) {</span>
<span id="cb445-23"><a href="#cb445-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...as before...</span></span>
<span id="cb445-24"><a href="#cb445-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb445-25"><a href="#cb445-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb445-26"><a href="#cb445-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addOne</span> (args<span class="op">,</span> callback) {</span>
<span id="cb445-27"><a href="#cb445-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">run</span>(Q_WORKSHOP_ADD<span class="op">,</span> args<span class="op">,</span> <span class="kw">function</span> (err<span class="op">,</span> rows) {</span>
<span id="cb445-28"><a href="#cb445-28" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (err) <span class="kw">this</span><span class="op">.</span><span class="fu">fail</span>(err)</span>
<span id="cb445-29"><a href="#cb445-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">callback</span>([]<span class="op">,</span> <span class="kw">this</span><span class="op">.</span><span class="at">lastID</span>)</span>
<span id="cb445-30"><a href="#cb445-30" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb445-31"><a href="#cb445-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb445-32"><a href="#cb445-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb445-33"><a href="#cb445-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">deleteOne</span> (args<span class="op">,</span> callback) {</span>
<span id="cb445-34"><a href="#cb445-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">db</span><span class="op">.</span><span class="fu">run</span>(Q_WORKSHOP_DELETE<span class="op">,</span> args<span class="op">,</span> (err<span class="op">,</span> rows) <span class="kw">=&gt;</span> {</span>
<span id="cb445-35"><a href="#cb445-35" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (err) <span class="kw">this</span><span class="op">.</span><span class="fu">fail</span>(err)</span>
<span id="cb445-36"><a href="#cb445-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">callback</span>([]<span class="op">,</span> <span class="kw">undefined</span>)</span>
<span id="cb445-37"><a href="#cb445-37" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb445-38"><a href="#cb445-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb445-39"><a href="#cb445-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb445-40"><a href="#cb445-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fail</span> (msg) {</span>
<span id="cb445-41"><a href="#cb445-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...as before...</span></span>
<span id="cb445-42"><a href="#cb445-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb445-43"><a href="#cb445-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">_inMemory</span> (script) {</span>
<span id="cb445-44"><a href="#cb445-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...as before...</span></span>
<span id="cb445-45"><a href="#cb445-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb445-46"><a href="#cb445-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">_inFile</span> (path) {</span>
<span id="cb445-47"><a href="#cb445-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...as before...</span></span>
<span id="cb445-48"><a href="#cb445-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb445-49"><a href="#cb445-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb445-50"><a href="#cb445-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb445-51"><a href="#cb445-51" aria-hidden="true" tabindex="-1"></a>module<span class="op">.</span><span class="at">exports</span> <span class="op">=</span> Database</span></code></pre></div>
<p>The additions are straightforward: the query that does the work is passed to <code>this.db.run</code> along with the incoming arguments that specify what is to be added or deleted, and an empty list of rows is passed to the action callback (since adding and deleting don’t return anything). Testing involves a little more typing, since we want to check that the database is in the right state after the operation:</p>
<div class="sourceCode" id="cb446"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb446-1"><a href="#cb446-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ...imports as before...</span></span>
<span id="cb446-2"><a href="#cb446-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb446-3"><a href="#cb446-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> FIXTURE <span class="op">=</span> <span class="co">// ...as before...</span></span>
<span id="cb446-4"><a href="#cb446-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb446-5"><a href="#cb446-5" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;mutating database&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb446-6"><a href="#cb446-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb446-7"><a href="#cb446-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;can add a workshop&#39;</span><span class="op">,</span> (done) <span class="kw">=&gt;</span> {</span>
<span id="cb446-8"><a href="#cb446-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> duration <span class="op">=</span> <span class="dv">35</span><span class="op">,</span> name <span class="op">=</span> <span class="st">&#39;Creating Bugs&#39;</span></span>
<span id="cb446-9"><a href="#cb446-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> db <span class="op">=</span> <span class="kw">new</span> <span class="fu">Database</span>(<span class="st">&#39;direct&#39;</span><span class="op">,</span> FIXTURE)</span>
<span id="cb446-10"><a href="#cb446-10" aria-hidden="true" tabindex="-1"></a>    db<span class="op">.</span><span class="fu">addOne</span>([name<span class="op">,</span> duration]<span class="op">,</span> <span class="kw">function</span> (results<span class="op">,</span> lastID) {</span>
<span id="cb446-11"><a href="#cb446-11" aria-hidden="true" tabindex="-1"></a>      assert<span class="op">.</span><span class="fu">deepEqual</span>(results<span class="op">,</span> []<span class="op">,</span> <span class="st">&#39;Got empty list as result when adding&#39;</span>)</span>
<span id="cb446-12"><a href="#cb446-12" aria-hidden="true" tabindex="-1"></a>      assert<span class="op">.</span><span class="fu">equal</span>(lastID<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="st">&#39;Got the correct last ID after adding&#39;</span>)</span>
<span id="cb446-13"><a href="#cb446-13" aria-hidden="true" tabindex="-1"></a>      db<span class="op">.</span><span class="fu">getAll</span>([]<span class="op">,</span> (results) <span class="kw">=&gt;</span> {</span>
<span id="cb446-14"><a href="#cb446-14" aria-hidden="true" tabindex="-1"></a>        expected <span class="op">=</span> [</span>
<span id="cb446-15"><a href="#cb446-15" aria-hidden="true" tabindex="-1"></a>          { <span class="dt">workshopName</span><span class="op">:</span> <span class="st">&#39;Building Community&#39;</span><span class="op">,</span></span>
<span id="cb446-16"><a href="#cb446-16" aria-hidden="true" tabindex="-1"></a>            <span class="dt">workshopDuration</span><span class="op">:</span> <span class="dv">60</span><span class="op">,</span> <span class="dt">workshopId</span><span class="op">:</span> <span class="dv">1</span> }<span class="op">,</span></span>
<span id="cb446-17"><a href="#cb446-17" aria-hidden="true" tabindex="-1"></a>          { <span class="dt">workshopName</span><span class="op">:</span> <span class="st">&#39;ENIAC Programming&#39;</span><span class="op">,</span></span>
<span id="cb446-18"><a href="#cb446-18" aria-hidden="true" tabindex="-1"></a>            <span class="dt">workshopDuration</span><span class="op">:</span> <span class="dv">150</span><span class="op">,</span> <span class="dt">workshopId</span><span class="op">:</span> <span class="dv">2</span> }<span class="op">,</span></span>
<span id="cb446-19"><a href="#cb446-19" aria-hidden="true" tabindex="-1"></a>          { <span class="dt">workshopName</span><span class="op">:</span> name<span class="op">,</span></span>
<span id="cb446-20"><a href="#cb446-20" aria-hidden="true" tabindex="-1"></a>            <span class="dt">workshopDuration</span><span class="op">:</span> duration<span class="op">,</span> <span class="dt">workshopId</span><span class="op">:</span> <span class="dv">3</span> }</span>
<span id="cb446-21"><a href="#cb446-21" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb446-22"><a href="#cb446-22" aria-hidden="true" tabindex="-1"></a>        assert<span class="op">.</span><span class="fu">deepEqual</span>(results<span class="op">,</span> expected<span class="op">,</span></span>
<span id="cb446-23"><a href="#cb446-23" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&#39;Got expected workshops after add&#39;</span>)</span>
<span id="cb446-24"><a href="#cb446-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">done</span>()</span>
<span id="cb446-25"><a href="#cb446-25" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb446-26"><a href="#cb446-26" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb446-27"><a href="#cb446-27" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb446-28"><a href="#cb446-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb446-29"><a href="#cb446-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;can delete a workshop&#39;</span><span class="op">,</span> (done) <span class="kw">=&gt;</span> {</span>
<span id="cb446-30"><a href="#cb446-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> db <span class="op">=</span> <span class="kw">new</span> <span class="fu">Database</span>(<span class="st">&#39;direct&#39;</span><span class="op">,</span> FIXTURE)</span>
<span id="cb446-31"><a href="#cb446-31" aria-hidden="true" tabindex="-1"></a>    db<span class="op">.</span><span class="fu">deleteOne</span>([<span class="dv">1</span>]<span class="op">,</span> (results<span class="op">,</span> lastID) <span class="kw">=&gt;</span> {</span>
<span id="cb446-32"><a href="#cb446-32" aria-hidden="true" tabindex="-1"></a>      assert<span class="op">.</span><span class="fu">equal</span>(lastID<span class="op">,</span> <span class="kw">undefined</span><span class="op">,</span> <span class="st">&#39;Expected last ID to be undefined&#39;</span>)</span>
<span id="cb446-33"><a href="#cb446-33" aria-hidden="true" tabindex="-1"></a>      assert<span class="op">.</span><span class="fu">deepEqual</span>(results<span class="op">,</span> []<span class="op">,</span> <span class="st">&#39;Got empty list as result when deleting&#39;</span>)</span>
<span id="cb446-34"><a href="#cb446-34" aria-hidden="true" tabindex="-1"></a>      db<span class="op">.</span><span class="fu">getAll</span>([]<span class="op">,</span> (results) <span class="kw">=&gt;</span> {</span>
<span id="cb446-35"><a href="#cb446-35" aria-hidden="true" tabindex="-1"></a>        expected <span class="op">=</span> [</span>
<span id="cb446-36"><a href="#cb446-36" aria-hidden="true" tabindex="-1"></a>          { <span class="dt">workshopName</span><span class="op">:</span> <span class="st">&#39;ENIAC Programming&#39;</span><span class="op">,</span></span>
<span id="cb446-37"><a href="#cb446-37" aria-hidden="true" tabindex="-1"></a>            <span class="dt">workshopDuration</span><span class="op">:</span> <span class="dv">150</span><span class="op">,</span> <span class="dt">workshopId</span><span class="op">:</span> <span class="dv">2</span> }</span>
<span id="cb446-38"><a href="#cb446-38" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb446-39"><a href="#cb446-39" aria-hidden="true" tabindex="-1"></a>        assert<span class="op">.</span><span class="fu">deepEqual</span>(results<span class="op">,</span> expected<span class="op">,</span></span>
<span id="cb446-40"><a href="#cb446-40" aria-hidden="true" tabindex="-1"></a>                         <span class="st">&#39;Got expected workshops after delete&#39;</span>)</span>
<span id="cb446-41"><a href="#cb446-41" aria-hidden="true" tabindex="-1"></a>        <span class="fu">done</span>()</span>
<span id="cb446-42"><a href="#cb446-42" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb446-43"><a href="#cb446-43" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb446-44"><a href="#cb446-44" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb446-45"><a href="#cb446-45" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<h2 id="s:db-exercises">Exercises</h2>
<h3 class="unnumbered" id="copying-records">Copying Records</h3>
<p>Write a program that copies all the rows from the table <code>Workshop</code> in a database <code>source.db</code> to a table with the same name in a new database <code>backup.db</code>.</p>
<h3 class="unnumbered" id="filtering-records">Filtering Records</h3>
<p>Add a new method to the <code>Database</code> class to get all workshops that are longer than a specified time:</p>
<div class="sourceCode" id="cb447"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb447-1"><a href="#cb447-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> db <span class="op">=</span> <span class="kw">new</span> <span class="fu">Database</span>(path)</span>
<span id="cb447-2"><a href="#cb447-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> rows <span class="op">=</span> db<span class="op">.</span><span class="fu">getLongerThan</span>(<span class="dv">100</span>)</span>
<span id="cb447-3"><a href="#cb447-3" aria-hidden="true" tabindex="-1"></a>assert<span class="op">.</span><span class="fu">deepEqual</span>(rows<span class="op">,</span> [</span>
<span id="cb447-4"><a href="#cb447-4" aria-hidden="true" tabindex="-1"></a>  {<span class="dt">workshopName</span><span class="op">:</span> <span class="st">&#39;ENIAC Programming&#39;</span><span class="op">,</span> <span class="dt">workshopDuration</span><span class="op">:</span> <span class="dv">150</span><span class="op">,</span> <span class="dt">workshopId</span><span class="op">:</span> <span class="dv">2</span>}</span>
<span id="cb447-5"><a href="#cb447-5" aria-hidden="true" tabindex="-1"></a>])</span></code></pre></div>
<p>Your <code>Database.getLongerThan</code> method’s SQL query will need to use a <code>where</code> clause that selects specific records.</p>
<h3 class="unnumbered" id="more-filtering">More Filtering</h3>
<p>The SQL query encapsulated in the variable below can be used to find all workshops whose duration falls within a range.</p>
<div class="sourceCode" id="cb448"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb448-1"><a href="#cb448-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> Q_WORKSHOP_DURATION_RANGE <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb448-2"><a href="#cb448-2" aria-hidden="true" tabindex="-1"></a><span class="vs">select</span></span>
<span id="cb448-3"><a href="#cb448-3" aria-hidden="true" tabindex="-1"></a><span class="vs">  Workshop.ident        as workshopId,</span></span>
<span id="cb448-4"><a href="#cb448-4" aria-hidden="true" tabindex="-1"></a><span class="vs">  Workshop.name         as workshopName,</span></span>
<span id="cb448-5"><a href="#cb448-5" aria-hidden="true" tabindex="-1"></a><span class="vs">  Workshop.duration     as workshopDuration</span></span>
<span id="cb448-6"><a href="#cb448-6" aria-hidden="true" tabindex="-1"></a><span class="vs">from</span></span>
<span id="cb448-7"><a href="#cb448-7" aria-hidden="true" tabindex="-1"></a><span class="vs">  Workshop</span></span>
<span id="cb448-8"><a href="#cb448-8" aria-hidden="true" tabindex="-1"></a><span class="vs">where</span></span>
<span id="cb448-9"><a href="#cb448-9" aria-hidden="true" tabindex="-1"></a><span class="vs">  (Workshop.duration &lt;= ?) and (Workshop.duration &gt;= ?)</span></span>
<span id="cb448-10"><a href="#cb448-10" aria-hidden="true" tabindex="-1"></a><span class="vs">`</span></span></code></pre></div>
<p>What do the <code>?</code>s mean in this query? Write another method for the <code>Database</code> class called <code>getWithinLengthRange([args])</code> that uses this query, taking arguments from the commandline as before. What happens when you provide the wrong number of arguments to this function? Or if you provide them in the wrong order? Can you write a test that provides more useful feedback than this?</p>
<h3 class="unnumbered" id="handling-errors">Handling Errors</h3>
<p>The <code>Database</code> class prints a message and exits when it detects an error. This is bad practice, and I should be ashamed of having done it. The right thing to do is to <a href="#g:throw"><strong>throw</strong></a> an <a href="#g:exception"><strong>exception</strong></a> that the main program can <a href="#g:catch"><strong>catch</strong></a> and handle however it wants.</p>
<ol>
<li><p>Modify the code to do this.</p></li>
<li><p>Modify the tests to check that the right exceptions are thrown when they should be.</p></li>
</ol>
<h3 class="unnumbered" id="using-a-database-with-a-server">Using a Database with a Server</h3>
<p>Rewrite the capstone project in Chapter <a href="#s:capstone" data-reference-type="ref" data-reference="s:capstone">15</a> to use a database instead of a file for data storage.</p>
<h1 id="s:deploy">Deploying</h1>
<p>Running applications on our laptop is fine for testing, but sooner or later we will want to put them on the web for others to use. A general discussion of <a href="#g:deployment"><strong>deployment</strong></a> is outside the scope of these lessons, particularly because it shouldn’t be done without thinking carefully about security, but there are now a few entry-level platforms you can try out.</p>
<p>One of the simplest of these platforms is <a href="https://glitch.com/">Glitch</a>, which is designed to help students build their first interactive websites. It isn’t designed to host large, high-traffic applications, but is great for prototyping and classroom use. To try it out, go to <a href="https://glitch.com">https://glitch.com</a> and create a free account. You can then click on the “New Project” button in the upper right and select <code>hello-express</code>, which will create a basic Express application. This project contains a handful of files that you should find familiar:</p>
<ul>
<li><p><code>README.md</code>: a description of the project formatted in Markdown.</p></li>
<li><p><code>package.json</code>: the NPM package listing for the project.</p></li>
<li><p><code>server.js</code>: the server. This is initially set up to route requests for <code>/</code> to <code>/views/index.html</code>, but can be made as complicated as we want. Note that it uses a variable called <code>__dirname</code> (with two leading underscores) to get the name of the directory that the server is running in; this is needed because Glitch controls where our application runs.</p></li>
<li><p><code>views/index.html</code>: the application’s home page. We can add as many other pages as we want, but they have to go in the <code>views</code> folder.</p></li>
<li><p><code>public/client.js</code>: the user interface code that is run in the browser. The <code>public</code> folder acts as the root directory for the server, so inside <code>views/index.html</code> and other web pages, we refer to <code>public/client.js</code> simply as <code>/client.js</code>.</p></li>
<li><p><code>public/style.css</code>: the CSS that styles the application. Again, inside <code>views/index.html</code> we refer to this file as <code>/style.css</code> without naming the <code>public</code> folder.</p></li>
<li><p><code>.env</code>: a shell script that defines any secret configuration variables the application needs, such as passwords for databases. Unlike the files above, this one <em>isn’t</em> automatically copied when someone clones our application. If we define a variable called <code>PASSWORD</code> in this file, then our server can get its value (as a string) using <code>process.env.PASSWORD</code>. Life might have been a little simpler if Glitch’s creators had used a JSON file instead of a shell script, but as long as we stick to simple <code>NAME=VALUE</code> pairs, we’ll be OK.</p></li>
</ul>
<p>Two things that <em>aren’t</em> automatically present are a license and a Code of Conduct, but both can easily be added by clicking on the “New File” button. Several widely-used open source licenses are available, and the Code of Conduct is based on one that is also widely used in open source projects. Adding both makes it clear what we are allowing and expecting people to do with our project.</p>
<p>The “Rewind” button in the bottom of the file explorer lets us view the project’s history. Glitch uses Git to store changes, but presents those changes as a timeline so that we can scroll backward and forward to see what was altered when. The “Tools” button (also in the bottom of the file explorer) gives us access to run logs and performance information, and lets us connect our project to a repository on GitHub.</p>
<p>Behind the scenes, every Glitch application runs in a virtual machine. Any data that it creates or modifies (such as files on disk or SQLite databases Appendix <a href="#s:db" data-reference-type="ref" data-reference="s:db">27</a>) are automatically saved, up to a limit of 128 MByte. An application is allowed to handle several thousand requests per hour; if it doesn’t receive any requests for 5 minutes, the virtual machine is put to sleep. It is automatically restarted the next time a request comes in, but there will be a lag as it wakes up.</p>
<h1 class="unnumbered" id="references">References</h1>
      </div>
    </div>
  </div>
</div>
</body>
</html>

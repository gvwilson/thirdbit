<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/theme.js"></script>
<link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/css/theme.css" rel="stylesheet" type="text/css">
<link href="/css/syntax.css" rel="stylesheet" type="text/css">



    <title>Third Bit: DrProject Internals: Parting Notes on the Wiki</title>
  </head>
  <body>
    <div class="container-fluid">
  <div class="row-fluid">
    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">Third Bit</a>
      </div>
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
          <li class="active visible-xs-block"><a href="/links/">Links</a></li>
          <li class="active"><a href="/about/">About</a></li>
          <li class="active"><a href="/talks/">Talks</a></li>
          <li class="active"><a href="/ideas/">Ideas</a></li>
          <li class="active"><a href="/reading/">Reading</a></li>
          <li class="active"><a href="/archive/">Archive</a></li>
          <li class="active"><a href="/teaching/"><em>How to Teach</em></a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <li class="active"><a href="http://appear.in/gvwilson"><img src="/files/appear.in.svg" class="navbar-icon" /></a></li>
          <li class="active"><a href="https://github.com/gvwilson"><img src="/files/github.svg" class="navbar-icon" /></a></li>
          <li class="active"><a href="http://twitter.com/gvwilson"><img src="/files/twitter.svg" class="navbar-icon" /></a></li>
          <li class="active"><a href="/feed.xml"><img src="/files/rss.svg" class="navbar-icon" /></a></li>
        </ul>
      </div>
    </div>
  </div>
</div>

    <div class="container container-left">
      <div class="row">
        <div class="col-md-3 hidden-xs">
          <div class="sidebar well">
  <h2>Links</h2>
<p><em><a href="http://software-carpentry.org">Software Carpentry</a></em></p>
<p><em><a href="http://aosabook.org">Architecture of Open Source Applications</a></em></p>
<p><em><a href="http://neverworkintheory.org">Never Work in Theory</a></em></p>
<p><em><a href="http://sensibleadventures.com">Sensible Adventures</a></em></p>
<p><a href="/cv/">CV</a></p>
<p><a href="/bib/">Bibliography</a></p>

  <h2>Favorites</h2>
  
  
  <p><a href="/2018/03/20/goodbye-jeff.html">Goodbye, Jeff</a></p>
  
  <p><a href="/2018/03/16/seven-ways.html">Seven Ways to Think Like a Programmer</a></p>
  
  <p><a href="/2018/03/13/base-case-for-empirical-software-engineering.html">A Base Case for Empirical Software Engineering Research</a></p>
  
  <p><a href="/2018/01/07/book-club.html">Book Club</a></p>
  
  <p><a href="/2017/12/21/talking-people-into-things.html">Ten Simple Rules for Talking People Into Things</a></p>
  
  <p><a href="/2017/11/05/for-everyone.html">Carpentry For Everyone</a></p>
  
  <p><a href="/2017/10/16/exercise-types.html">What Kinds of Exercises Do You Use to Teach Programming?</a></p>
  
  <p><a href="/2017/09/30/git-graphs-and-engineering.html">Git, Graphs, and Software Engineering</a></p>
  
  <p><a href="/2017/06/19/ten-rules-research-partner.html">Ten Simple Rules for Being a Good Research Partner</a></p>
  
  <p><a href="/2017/05/22/numerical-javascript.html">Numerical JavaScript</a></p>
  
  <p><a href="/2017/01/06/them-thats-got.html">Them That's Got</a></p>
  
  <p><a href="/2016/10/30/rules-for-teaching.html">Rules for Teaching</a></p>
  
  <p><a href="/2016/04/29/why-teachers-dont-collaborate.html">Why Teachers Don't Collaborate on Lesson Development</a></p>
  
  <p><a href="/2016/04/01/zen-and-the-art-of-assignment-operators.html">Zen and the Art of Assignment Operators</a></p>
  
  <p><a href="/2016/03/13/in-my-better-world.html">In My Better World</a></p>
  
  <p><a href="/2015/12/19/why-i-teach.html">Why I Teach (Revisited)</a></p>
  
  <p><a href="/2015/12/06/just-keep-swimming.html">Just Keep Swimming</a></p>
  
  <p><a href="/2015/11/29/exaptation.html">Exaptation and the Future of Software Engineering</a></p>
  
  <p><a href="/2015/11/09/daddy-why-dont-you-ever-laugh.html">Daddy, Why Don't You Ever Laugh?</a></p>
  
  <p><a href="/2015/09/22/dad.html">Goodbye, Dad</a></p>
  
  <p><a href="/2014/10/08/announcing-the-creation-of-the-software-carpentry-foundational.html">Announcing the Creation of the Software Carpentry Foundation</a></p>
  
  <p><a href="/2014/03/14/learning-at-scale.html">Is Learning at Scale Just Another Name for Ubiquitous Surveillance in the Classroom?</a></p>
  
  <p><a href="/2013/10/17/you-keep-using-that-word.html">You Keep Using That Word</a></p>
  
  <p><a href="/2013/02/11/correctness-isnt-compelling.html">Correctness Isn't Compelling</a></p>
  
  <p><a href="/2012/10/23/twenty-percent.html">Twenty Percent</a></p>
  
  <p><a href="/2012/06/29/those-who-ignore-history.html">That Seems Simple to Me</a></p>
  
  <p><a href="/2012/01/21/the-life-i-did-live-the-breath-i-breathed.html">We Have Nothing To Give Them</a></p>
  
</div>

        </div>
        <div class="col-md-9">
          <div class="article">
            <div class="well">
              <h1><a href="/2006/10/30/drproject-internals-parting-notes-on-the-wiki.html">Oct 30, 2006 - DrProject Internals: Parting Notes on the Wiki</a></h1>
              <div class="post-content">
                I promised in the <a href="http://pyre.third-bit.com/blog/FIXME">last article</a> to move on to <a href="http://www.drproject.org">DrProject</a>'s ticketing system, but there are still a couple of issues around its wiki that need further description.  The first is how wiki text is transformed into HTML; the second is why this is harder to do in batch mode than you'd think.

Ward Cunningham created the first wiki in 1994-95 so that people could easily edit hypertext over the web.  The only input widget he trust browsers to support was the text input box.  Since editing HTML tags by hand is tedious and error-prone, he adopted and modified the notational conventions that people were using for email and other plain-text documents:
<table cellpadding="1" border="1">
<tr>
<td valign="middle"><code>== Level 2 ==</code></td>
<td valign="middle">
<h2>Level 2</h2>
</td>
</tr>
<tr>
<td valign="middle"><code>''emphasis''</code></td>
<td valign="middle"><em>emphasis</em></td>
</tr>
<tr>
<td valign="middle"><code>ThirdBit</code></td>
<td valign="middle"><a href="http://www.third-bit.com">ThirdBit</a></td>
</tr>
<tr>
<td valign="middle"><code>[http://www.third-bit.com home]</code></td>
<td valign="middle"><a href="http://www.third-bit.com">home</a></td>
</tr>
</table>
If wikis had been invented later, these text notations might not have been adopted, since it's now straightforward to nest a WYSIWYG HTML editor written in Javascript in a web page.  On the other hand, there are a lot of out-of-browser cases where systems like <a href="http://www.drproject.org">DrProject</a> want users to be able to create hyperlinked text, such as comments on check-ins to version control and the bodies of email messages, so perhaps ASCII styling would have arisen after all.

Wiki markup simplifies input, but creates a new problem: somehow, pages have to be parsed, then transformed into HTML for display.  The parser that <a href="http://www.drproject.org">DrProject</a> inherited from <a href="http://trac.edgewall.com">Trac</a> used a pile of regular expressions to match and extract bits of text.  This worked well enough, but was difficult to extend---every time we tried to add a new feature, we found our new regexp conflicted with some of the existing ones, or made some piece of formatting ambiguous.

A graduate student named <a href="http://www.cs.toronto.edu/~liam/">Liam Stewart</a> (now with <a href="http://www.ideeinc.com">Id&eacute;e</a>) therefore wrote an entirely new parser using <a href="http://www.cosc.canterbury.ac.nz/greg.ewing/">Greg Ewing</a>'s <a href="http://www.cosc.canterbury.ac.nz/greg.ewing/python/Plex/">Plex</a> toolkit.  Like <a href="http://dinosaur.compilertools.net/">yacc</a> and (many) other parser generators, <a href="http://www.cosc.canterbury.ac.nz/greg.ewing/python/Plex/">Plex</a> takes a grammar specification as input, and compiles it into executable code that will parse the language that grammar specifies. Developers can embed instructions in the grammar to create a parse tree as a side effect of analyzing input.  Here's a bit of our grammar (<code>Bol</code> means "beginning of line", <code>Eol</code> means "end of line", and---well, the details aren't important):
<pre>newline = Str("\n", "\r\n")
h1 = Alt(Bol + Rep(Any(" \t")) + Str("="),
Str("=") + Rep(Any(" \t")) + Alt(Eol,newline))
h2 = Alt(Bol + Rep(Any(" \t")) + Str("=="),
Str("==") + Rep(Any(" \t")) + Alt(Eol,newline))
hr = Bol + Str("----") + Rep(Str("-"))
br = re('\[\[BR\]\]')
ital = re("''")
bold = re("'''")
boldital = re("'''''")
under = re("__")
...
rules = [
(h1, (HEADING, H1)),
(h2, (HEADING, H2)),
(hr, (HR, None)),
(ital, (STYLE, ITALIC)),
(bold, (STYLE, BOLD)),
(boldital, (STYLE, BOLDITALIC)),
(under, (STYLE, UNDERLINE)),
...
]</pre>
The entire parser came in at 459 lines of Python, including blank lines and comments.  We were pretty pleased---until we noticed that <a href="http://www.drproject.org">DrProject</a> had slowed down a <em>lot</em> after we introduced it.  An undergraduate student named Billy Chun looked into the problem over the summer, and <a href="http://pyre.third-bit.com/blog/archives/527.html">discovered</a> that <a href="http://www.cosc.canterbury.ac.nz/greg.ewing/python/Plex/">Plex</a> was re-generating the parser every time it was called.  More specifically, <a href="http://www.cosc.canterbury.ac.nz/greg.ewing/python/Plex/">Plex</a> was spending 1.9 seconds translating a nondeterministic finite state automaton (NFA) into its deterministic equivalent (a DFA) each time <a href="http://www.drproject.org">DrProject</a> rendered a wiki page.

This isn't a bug in <a href="http://www.cosc.canterbury.ac.nz/greg.ewing/python/Plex/">Plex</a>, but rather a misconception on our part.  <a href="http://dinosaur.compilertools.net/">Yacc</a> and similar tools produce C code that can be compiled into an application; we therefore assumed that <a href="http://www.cosc.canterbury.ac.nz/greg.ewing/python/Plex/">Plex</a> was doing the same, i.e., that the parser was being produced once and stored somewhere for re-use.  When that turned out not to be the case, we were stymied: we went as far as trying to serialize the byte codes that <a href="http://www.cosc.canterbury.ac.nz/greg.ewing/python/Plex/">Plex</a> generated before deciding that we were creating more complexity than we had eliminated by switching to a parser generator in the first place.

Our eventual "solution" to this problem was to let another change to the system---the switch from pure CGI to <a href="http://www.mems-exchange.org/software/scgi/">SCGI</a>---take care of it for us.  While pure CGI forks a fresh Python interpreter to handle each HTTP request, <a href="http://www.mems-exchange.org/software/scgi/">SCGI</a> relies on a single interpreter running in parallel with the web server.  That long-lived interpreter only needs to generate the parser once; the second and subsequent times it has to render a wiki page, it can re-use the parser it generated the first time.

As Billy was starting his investigation of <a href="http://www.drproject.org">DrProject</a>'s performance problems, two other students named Apple Viriyakattiyaporn and David Scannell were ramping up as well.  We'd hired them to spend the summer doing development on the system; as a warm-up exercise, I asked them to write a standalone wiki formatter.  The idea was to have a command-line tool that would transform the text of a wiki page into HTML, so that people could check their formatting when editing offline, batch process pages for printing, and so on.

It turned out to be a harder job than I'd expected.  Some of the difficulty was simply tangled code: for example, the wiki processor expected an HTTP request object as input, but we obviously wouldn't have one when running from the command line in batch mode.  No problem---Python's <a href="http://en.wikipedia.org/wiki/Duck_typing">duck typing</a> makes it easy to create objects that implement just enough of an interface to get a particular job done.

The real problem---what Fred Brooks Jr. would call the "intrinsic complexity", as opposed to the "accidental complexity"---was how to format links.  In order to decide whether to format a particular CamelCaseWord as a link or not, the wiki processor needed to know what other pages the system contained.  That information was stored in <a href="http://www.drproject.org">DrProject</a>'s database.  Should the standalone wiki processor depend on access to a database?  That would be inconvenient; it would also require us to give users read privileges for the database, which would be a big security risk.

What about decoupling the wiki processor from the database?  If the wiki processor only ever called a function <code>get_page_names</code>, we could import a database-specific version in <a href="http://www.drproject.org">DrProject</a>, and something else in the standalone wiki processor.  That "something else" could read from a file, take a bunch of page names as command-line arguments, or anything else.

That sounded sensible---until we started thinking about wiki macros.  A macro is a piece of Python code that generates HTML.  If <code>copyright.py</code> is saved in the right directory, for example, and contains a function called <code>copyright()</code> that returns the string <code>"Copyright Â© 2006 University of Toronto"</code> then putting <code>[[copyright()]]</code> in a wiki page will insert the copyright notice.  <a href="http://trac.edgewall.com">Trac</a>'s <a href="http://trac.edgewall.org/wiki/MacroBazaar">Macro Bazaar</a> lists dozens of macros for navigation, inclusion, charts, and much else.

How is the standalone wiki processor supposed to handle macros? Loading the Python code that implements a particular macro isn't (much of) a problem; the problem is that there's no way of knowing what data a particular macro is going to want.  Something that displays the last time a wiki page was edited, for example, is going to need access to an actualy <a href="http://www.drproject.org">DrProject</a> database. (Either that, or we create a mock object that has all the features of such a database, which seems a little silly...)

In the end, we punted: after working on the standalone wiki processor for more than a week, Apple and David had learned enough about <a href="http://www.drproject.org">DrProject</a>'s internals to start fixing bugs and implementing <a href="https://stanley.cs.utoronto.ca/csc49x/drproject/DrProject/tagcloud?perproject=">new features</a>, so we put set the standalone wiki processor aside.  I'd like to return to it some day, though; being able to batch process wiki pages and tickets (particularly for printing) is still an attractive idea.

                


              </div>
            </div>
            <div class="pagination">
              
              <a class="btn btn-default" href="/2006/10/30/build-a-better-voting-machine.html" class="next">Newer</a>
              
              
              <a class="btn btn-default" href="/2006/10/28/drproject-internals-security-part-2.html" class="previous">Older</a>
              
            </div>
            
            
            <div class="well">
              
              <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
              </div>
              
            </div>
            
            
          </div>
        </div>
      </div>
    </div>
    
  <script type="text/javascript">
    var disqus_shortname = 'thirdbit';

    var disqus_config = function () {
        this.page.identifier = '2006-10-30-drproject-internals-parting-notes-on-the-wiki-html';
    };

   (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>


    <div class="container-fluid">
  <div class="row-fluid">
    <div class="span12 footer navbar-inverse navbar-fixed-bottom">
      <br/>
      <p class="copyright">
        &copy; 2018 Greg Wilson.
        All content made available under the <a href="/license/">Creative Commons - Attribution License</a>.
      </p>
    </div>
  </div>
</div>


  <script type="text/javascript">
    var disqus_shortname = 'thirdbit';

    var disqus_config = function () {
        this.page.identifier = '2006-10-30-drproject-internals-parting-notes-on-the-wiki-html';
    };

   (function () {
     var s = document.createElement('script'); s.async = true;
     s.type = 'text/javascript';
     s.src = '//' + disqus_shortname + '.disqus.com/count.js';
     (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
   }());
 </script>



  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-1301159-1', 'auto');
    ga('send', 'pageview');
  </script>



</body>
</html>

  </body>
</html>
